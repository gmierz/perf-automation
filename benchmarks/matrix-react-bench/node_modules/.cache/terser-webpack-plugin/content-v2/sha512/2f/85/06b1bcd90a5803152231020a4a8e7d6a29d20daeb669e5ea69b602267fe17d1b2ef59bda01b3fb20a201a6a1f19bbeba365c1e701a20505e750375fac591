{"code":"(globalThis.webpackJsonp=globalThis.webpackJsonp||[]).push([[15],{1546:function(e,a,t){\"use strict\";t.r(a),t.d(a,\"default\",(function(){return _}));var s,r=t(0),o=t.n(r),n=t(3),i=t(780),c=t.n(i),l=t(1),h=t(9),u=t(136),p=t(99),d=t(87),y=t(286),m=t(118),g=t(8),S=t(51),P=t(91),C=t(285),b=t(265),k=t(148),f=t(2),w=t(26),K=t(28),E=t(18),v=t(191);function O(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}!function(e){e.Loading=\"loading\",e.LoadError=\"load_error\",e.ChooseKeyPassphrase=\"choose_key_passphrase\",e.Migrate=\"migrate\",e.Passphrase=\"passphrase\",e.PassphraseConfirm=\"passphrase_confirm\",e.ShowKey=\"show_key\",e.Storing=\"storing\",e.ConfirmSkip=\"confirm_skip\"}(s||(s={}));class _ extends o.a.PureComponent{constructor(e){let a;super(e),O(this,\"recoveryKey\",void 0),O(this,\"backupKey\",void 0),O(this,\"recoveryKeyNode\",Object(r.createRef)()),O(this,\"passphraseField\",Object(r.createRef)()),O(this,\"onKeyBackupStatusChange\",()=>{this.state.phase===s.Migrate&&this.fetchBackupInfo()}),O(this,\"onKeyPassphraseChange\",e=>{this.setState({passPhraseKeySelected:e.target.value})}),O(this,\"onChooseKeyPassphraseFormSubmit\",async()=>{this.state.passPhraseKeySelected===b.a.Key?(this.recoveryKey=await n.a.get().createRecoveryKeyFromPassphrase(),this.setState({copied:!1,downloaded:!1,setPassphrase:!1,phase:s.ShowKey})):this.setState({copied:!1,downloaded:!1,phase:s.Passphrase})}),O(this,\"onMigrateFormSubmit\",e=>{e.preventDefault(),this.state.backupSigStatus.usable?this.bootstrapSecretStorage():this.restoreBackup()}),O(this,\"onCopyClick\",()=>{Object(p.b)(this.recoveryKeyNode.current)&&this.setState({copied:!0})}),O(this,\"onDownloadClick\",()=>{const e=new Blob([this.recoveryKey.encodedPrivateKey],{type:\"text/plain;charset=us-ascii\"});c.a.saveAs(e,\"security-key.txt\"),this.setState({downloaded:!0})}),O(this,\"doBootstrapUIAuth\",async e=>{if(this.state.canUploadKeysWithPasswordOnly&&this.state.accountPassword)await e({type:\"m.login.password\",identifier:{type:\"m.id.user\",user:n.a.get().getUserId()},user:n.a.get().getUserId(),password:this.state.accountPassword});else{const a={[d.c.PHASE_PREAUTH]:{title:Object(l.a)(\"Use Single Sign On to continue\"),body:Object(l.a)(\"To continue, use Single Sign On to prove your identity.\"),continueText:Object(l.a)(\"Single Sign On\"),continueKind:\"primary\"},[d.c.PHASE_POSTAUTH]:{title:Object(l.a)(\"Confirm encryption setup\"),body:Object(l.a)(\"Click the button below to confirm setting up encryption.\"),continueText:Object(l.a)(\"Confirm\"),continueKind:\"primary\"}},{finished:t}=h.a.createTrackedDialog(\"Cross-signing keys dialog\",\"\",v.a,{title:Object(l.a)(\"Setting up keys\"),matrixClient:n.a.get(),makeRequest:e,aestheticsForStagePhases:{[d.c.LOGIN_TYPE]:a,[d.c.UNSTABLE_LOGIN_TYPE]:a}}),[s]=await t;if(!s)throw new Error(\"Cross-signing key upload auth canceled\")}}),O(this,\"bootstrapSecretStorage\",async()=>{this.setState({phase:s.Storing,error:null});const e=n.a.get(),{forceReset:a}=this.props;try{a?(f.a.log(\"Forcing secret storage reset\"),await e.bootstrapSecretStorage({createSecretStorageKey:async()=>this.recoveryKey,setupNewKeyBackup:!0,setupNewSecretStorage:!0})):(await e.bootstrapCrossSigning({authUploadDeviceSigningKeys:this.doBootstrapUIAuth}),await e.bootstrapSecretStorage({createSecretStorageKey:async()=>this.recoveryKey,keyBackupInfo:this.state.backupInfo,setupNewKeyBackup:!this.state.backupInfo,getKeyBackupPassphrase:async()=>this.backupKey?this.backupKey:Object(u.e)()})),this.props.onFinished(!0)}catch(e){this.state.canUploadKeysWithPasswordOnly&&401===e.httpStatus&&e.data.flows?this.setState({accountPassword:\"\",accountPasswordCorrect:!1,phase:s.Migrate}):this.setState({error:e}),f.a.error(\"Error bootstrapping secret storage\",e)}}),O(this,\"onCancel\",()=>{this.props.onFinished(!1)}),O(this,\"restoreBackup\",async()=>{const{finished:e}=h.a.createTrackedDialog(\"Restore Backup\",\"\",C.a,{showSummary:!1,keyCallback:e=>this.backupKey=e},null,!1,!1);await e;const{backupSigStatus:a}=await this.fetchBackupInfo();a.usable&&this.state.canUploadKeysWithPasswordOnly&&this.state.accountPassword&&this.bootstrapSecretStorage()}),O(this,\"onLoadRetryClick\",()=>{this.setState({phase:s.Loading}),this.fetchBackupInfo()}),O(this,\"onShowKeyContinueClick\",()=>{this.bootstrapSecretStorage()}),O(this,\"onCancelClick\",()=>{this.setState({phase:s.ConfirmSkip})}),O(this,\"onGoBackClick\",()=>{this.setState({phase:s.ChooseKeyPassphrase})}),O(this,\"onPassPhraseNextClick\",async e=>{if(e.preventDefault(),this.passphraseField.current){if(await this.passphraseField.current.validate({allowEmpty:!1}),!this.passphraseField.current.state.valid)return this.passphraseField.current.focus(),void this.passphraseField.current.validate({allowEmpty:!1,focused:!0});this.setState({phase:s.PassphraseConfirm})}}),O(this,\"onPassPhraseConfirmNextClick\",async e=>{e.preventDefault(),this.state.passPhrase===this.state.passPhraseConfirm&&(this.recoveryKey=await n.a.get().createRecoveryKeyFromPassphrase(this.state.passPhrase),this.setState({copied:!1,downloaded:!1,setPassphrase:!0,phase:s.ShowKey}))}),O(this,\"onSetAgainClick\",()=>{this.setState({passPhrase:\"\",passPhraseValid:!1,passPhraseConfirm:\"\",phase:s.Passphrase})}),O(this,\"onPassPhraseValidate\",e=>{this.setState({passPhraseValid:e.valid})}),O(this,\"onPassPhraseChange\",e=>{this.setState({passPhrase:e.target.value})}),O(this,\"onPassPhraseConfirmChange\",e=>{this.setState({passPhraseConfirm:e.target.value})}),O(this,\"onAccountPasswordChange\",e=>{this.setState({accountPassword:e.target.value})});a=Object(b.d)().includes(b.a.Key)?b.a.Key:b.a.Passphrase;const t=e.accountPassword||\"\";let o=null;t?o=!0:this.queryKeyUploadAuth(),this.state={phase:s.Loading,passPhrase:\"\",passPhraseValid:!1,passPhraseConfirm:\"\",copied:!1,downloaded:!1,setPassphrase:!1,backupInfo:null,backupSigStatus:null,accountPasswordCorrect:null,canSkip:!Object(b.e)(),canUploadKeysWithPasswordOnly:o,passPhraseKeySelected:a,accountPassword:t},n.a.get().on(\"crypto.keyBackupStatus\",this.onKeyBackupStatusChange),this.getInitialPhase()}componentWillUnmount(){n.a.get().removeListener(\"crypto.keyBackupStatus\",this.onKeyBackupStatusChange)}getInitialPhase(){var e;const a=null===(e=k.a.createSecretStorageKey)||void 0===e?void 0:e.call(k.a);if(a)return f.a.log(\"Created key via customisations, jumping to bootstrap step\"),this.recoveryKey={privateKey:a},void this.bootstrapSecretStorage();this.fetchBackupInfo()}async fetchBackupInfo(){try{const e=await n.a.get().getKeyBackupVersion(),a=n.a.get().isCryptoEnabled()&&await n.a.get().isKeyBackupTrusted(e),{forceReset:t}=this.props,r=e&&!t?s.Migrate:s.ChooseKeyPassphrase;return this.setState({phase:r,backupInfo:e,backupSigStatus:a}),{backupInfo:e,backupSigStatus:a}}catch(e){this.setState({phase:s.LoadError})}}async queryKeyUploadAuth(){try{await n.a.get().uploadDeviceSigningKeys(null,{}),f.a.log(\"uploadDeviceSigningKeys unexpectedly succeeded without UI auth!\")}catch(e){if(!e.data||!e.data.flows)return void f.a.log(\"uploadDeviceSigningKeys advertised no flows!\");const a=e.data.flows.some(e=>1===e.stages.length&&\"m.login.password\"===e.stages[0]);this.setState({canUploadKeysWithPasswordOnly:a})}}renderOptionKey(){return o.a.createElement(m.a,{key:b.a.Key,value:b.a.Key,name:\"keyPassphrase\",checked:this.state.passPhraseKeySelected===b.a.Key,onChange:this.onKeyPassphraseChange,outlined:!0},o.a.createElement(\"div\",{className:\"mx_CreateSecretStorageDialog_optionTitle\"},o.a.createElement(\"span\",{className:\"mx_CreateSecretStorageDialog_optionIcon mx_CreateSecretStorageDialog_optionIcon_secureBackup\"}),Object(l.a)(\"Generate a Security Key\")),o.a.createElement(\"div\",null,Object(l.a)(\"We'll generate a Security Key for you to store somewhere safe, like a password manager or a safe.\")))}renderOptionPassphrase(){return o.a.createElement(m.a,{key:b.a.Passphrase,value:b.a.Passphrase,name:\"keyPassphrase\",checked:this.state.passPhraseKeySelected===b.a.Passphrase,onChange:this.onKeyPassphraseChange,outlined:!0},o.a.createElement(\"div\",{className:\"mx_CreateSecretStorageDialog_optionTitle\"},o.a.createElement(\"span\",{className:\"mx_CreateSecretStorageDialog_optionIcon mx_CreateSecretStorageDialog_optionIcon_securePhrase\"}),Object(l.a)(\"Enter a Security Phrase\")),o.a.createElement(\"div\",null,Object(l.a)(\"Use a secret phrase only you know, and optionally save a Security Key to use for backup.\")))}renderPhaseChooseKeyPassphrase(){const e=Object(b.d)(),a=e.includes(b.a.Key)?this.renderOptionKey():null,t=e.includes(b.a.Passphrase)?this.renderOptionPassphrase():null;return o.a.createElement(\"form\",{onSubmit:this.onChooseKeyPassphraseFormSubmit},o.a.createElement(\"p\",{className:\"mx_CreateSecretStorageDialog_centeredBody\"},Object(l.a)(\"Safeguard against losing access to encrypted messages & data by backing up encryption keys on your server.\")),o.a.createElement(\"div\",{className:\"mx_CreateSecretStorageDialog_primaryContainer\",role:\"radiogroup\"},a,t),o.a.createElement(S.a,{primaryButton:Object(l.a)(\"Continue\"),onPrimaryButtonClick:this.onChooseKeyPassphraseFormSubmit,onCancel:this.onCancelClick,hasCancel:this.state.canSkip}))}renderPhaseMigrate(){let e,a=Object(l.a)(\"Next\");return this.state.canUploadKeysWithPasswordOnly?e=o.a.createElement(\"div\",null,o.a.createElement(\"div\",null,Object(l.a)(\"Enter your account password to confirm the upgrade:\")),o.a.createElement(\"div\",null,o.a.createElement(w.a,{type:\"password\",label:Object(l.a)(\"Password\"),value:this.state.accountPassword,onChange:this.onAccountPasswordChange,forceValidity:!1!==this.state.accountPasswordCorrect&&null,autoFocus:!0}))):this.state.backupSigStatus.usable?e=o.a.createElement(\"p\",null,Object(l.a)(\"You'll need to authenticate with the server to confirm the upgrade.\")):(e=o.a.createElement(\"div\",null,o.a.createElement(\"div\",null,Object(l.a)(\"Restore your key backup to upgrade your encryption\"))),a=Object(l.a)(\"Restore\")),o.a.createElement(\"form\",{onSubmit:this.onMigrateFormSubmit},o.a.createElement(\"p\",null,Object(l.a)(\"Upgrade this session to allow it to verify other sessions, granting them access to encrypted messages and marking them as trusted for other users.\")),o.a.createElement(\"div\",null,e),o.a.createElement(S.a,{primaryButton:a,onPrimaryButtonClick:this.onMigrateFormSubmit,hasCancel:!1,primaryDisabled:this.state.canUploadKeysWithPasswordOnly&&!this.state.accountPassword},o.a.createElement(\"button\",{type:\"button\",className:\"danger\",onClick:this.onCancelClick},Object(l.a)(\"Skip\"))))}renderPhasePassPhrase(){return o.a.createElement(\"form\",{onSubmit:this.onPassPhraseNextClick},o.a.createElement(\"p\",null,Object(l.a)(\"Enter a security phrase only you know, as it's used to safeguard your data. To be secure, you shouldn't re-use your account password.\")),o.a.createElement(\"div\",{className:\"mx_CreateSecretStorageDialog_passPhraseContainer\"},o.a.createElement(y.a,{className:\"mx_CreateSecretStorageDialog_passPhraseField\",onChange:this.onPassPhraseChange,minScore:4,value:this.state.passPhrase,onValidate:this.onPassPhraseValidate,fieldRef:this.passphraseField,autoFocus:!0,label:Object(l.b)(\"Enter a Security Phrase\"),labelEnterPassword:Object(l.b)(\"Enter a Security Phrase\"),labelStrongPassword:Object(l.b)(\"Great! This Security Phrase looks strong enough.\"),labelAllowedButUnsafe:Object(l.b)(\"Great! This Security Phrase looks strong enough.\")})),o.a.createElement(S.a,{primaryButton:Object(l.a)(\"Continue\"),onPrimaryButtonClick:this.onPassPhraseNextClick,hasCancel:!1,disabled:!this.state.passPhraseValid},o.a.createElement(\"button\",{type:\"button\",onClick:this.onCancelClick,className:\"danger\"},Object(l.a)(\"Cancel\"))))}renderPhasePassPhraseConfirm(){let e,a;this.state.passPhraseConfirm===this.state.passPhrase?(e=Object(l.a)(\"That matches!\"),a=Object(l.a)(\"Use a different passphrase?\")):this.state.passPhrase.startsWith(this.state.passPhraseConfirm)||(e=Object(l.a)(\"That doesn't match.\"),a=Object(l.a)(\"Go back to set it again.\"));let t=null;return e&&(t=o.a.createElement(\"div\",null,o.a.createElement(\"div\",null,e),o.a.createElement(\"div\",null,o.a.createElement(g.a,{element:\"span\",className:\"mx_linkButton\",onClick:this.onSetAgainClick},a)))),o.a.createElement(\"form\",{onSubmit:this.onPassPhraseConfirmNextClick},o.a.createElement(\"p\",null,Object(l.a)(\"Enter your Security Phrase a second time to confirm it.\")),o.a.createElement(\"div\",{className:\"mx_CreateSecretStorageDialog_passPhraseContainer\"},o.a.createElement(w.a,{type:\"password\",onChange:this.onPassPhraseConfirmChange,value:this.state.passPhraseConfirm,className:\"mx_CreateSecretStorageDialog_passPhraseField\",label:Object(l.a)(\"Confirm your Security Phrase\"),autoFocus:!0,autoComplete:\"new-password\"}),o.a.createElement(\"div\",{className:\"mx_CreateSecretStorageDialog_passPhraseMatch\"},t)),o.a.createElement(S.a,{primaryButton:Object(l.a)(\"Continue\"),onPrimaryButtonClick:this.onPassPhraseConfirmNextClick,hasCancel:!1,disabled:this.state.passPhrase!==this.state.passPhraseConfirm},o.a.createElement(\"button\",{type:\"button\",onClick:this.onCancelClick,className:\"danger\"},Object(l.a)(\"Skip\"))))}renderPhaseShowKey(){let e;return e=this.state.phase===s.ShowKey?o.a.createElement(S.a,{primaryButton:Object(l.a)(\"Continue\"),disabled:!this.state.downloaded&&!this.state.copied&&!this.state.setPassphrase,onPrimaryButtonClick:this.onShowKeyContinueClick,hasCancel:!1}):o.a.createElement(\"div\",{className:\"mx_CreateSecretStorageDialog_continueSpinner\"},o.a.createElement(P.a,null)),o.a.createElement(\"div\",null,o.a.createElement(\"p\",null,Object(l.a)(\"Store your Security Key somewhere safe, like a password manager or a safe, as it's used to safeguard your encrypted data.\")),o.a.createElement(\"div\",{className:\"mx_CreateSecretStorageDialog_primaryContainer mx_CreateSecretStorageDialog_recoveryKeyPrimarycontainer\"},o.a.createElement(\"div\",{className:\"mx_CreateSecretStorageDialog_recoveryKeyContainer\"},o.a.createElement(\"div\",{className:\"mx_CreateSecretStorageDialog_recoveryKey\"},o.a.createElement(\"code\",{ref:this.recoveryKeyNode},this.recoveryKey.encodedPrivateKey)),o.a.createElement(\"div\",{className:\"mx_CreateSecretStorageDialog_recoveryKeyButtons\"},o.a.createElement(g.a,{kind:\"primary\",className:\"mx_Dialog_primary\",onClick:this.onDownloadClick,disabled:this.state.phase===s.Storing},Object(l.a)(\"Download\")),o.a.createElement(\"span\",null,Object(l.a)(\"or\")),o.a.createElement(g.a,{kind:\"primary\",className:\"mx_Dialog_primary mx_CreateSecretStorageDialog_recoveryKeyButtons_copyBtn\",onClick:this.onCopyClick,disabled:this.state.phase===s.Storing},o.a.createElement(\"span\",{className:\"mx_CreateSecretStorageDialog_recoveryKeyCopyButtonText\",style:{height:this.state.copied?\"0\":\"auto\"},\"aria-hidden\":this.state.copied},Object(l.a)(\"Copy\")),o.a.createElement(\"span\",{className:\"mx_CreateSecretStorageDialog_recoveryKeyCopyButtonText\",style:{height:this.state.copied?\"auto\":\"0\"},\"aria-hidden\":!this.state.copied},Object(l.a)(\"Copied!\")))))),e)}renderBusyPhase(){return o.a.createElement(\"div\",null,o.a.createElement(E.a,null))}renderPhaseLoadError(){return o.a.createElement(\"div\",null,o.a.createElement(\"p\",null,Object(l.a)(\"Unable to query secret storage status\")),o.a.createElement(\"div\",{className:\"mx_Dialog_buttons\"},o.a.createElement(S.a,{primaryButton:Object(l.a)(\"Retry\"),onPrimaryButtonClick:this.onLoadRetryClick,hasCancel:this.state.canSkip,onCancel:this.onCancel})))}renderPhaseSkipConfirm(){return o.a.createElement(\"div\",null,o.a.createElement(\"p\",null,Object(l.a)(\"If you cancel now, you may lose encrypted messages & data if you lose access to your logins.\")),o.a.createElement(\"p\",null,Object(l.a)(\"You can also set up Secure Backup & manage your keys in Settings.\")),o.a.createElement(S.a,{primaryButton:Object(l.a)(\"Go back\"),onPrimaryButtonClick:this.onGoBackClick,hasCancel:!1},o.a.createElement(\"button\",{type:\"button\",className:\"danger\",onClick:this.onCancel},Object(l.a)(\"Cancel\"))))}titleForPhase(e){switch(e){case s.ChooseKeyPassphrase:return Object(l.a)(\"Set up Secure Backup\");case s.Migrate:return Object(l.a)(\"Upgrade your encryption\");case s.Passphrase:return Object(l.a)(\"Set a Security Phrase\");case s.PassphraseConfirm:return Object(l.a)(\"Confirm Security Phrase\");case s.ConfirmSkip:return Object(l.a)(\"Are you sure?\");case s.ShowKey:return Object(l.a)(\"Save your Security Key\");case s.Storing:return Object(l.a)(\"Setting up keys\");default:return\"\"}}render(){let e;if(this.state.error)e=o.a.createElement(\"div\",null,o.a.createElement(\"p\",null,Object(l.a)(\"Unable to set up secret storage\")),o.a.createElement(\"div\",{className:\"mx_Dialog_buttons\"},o.a.createElement(S.a,{primaryButton:Object(l.a)(\"Retry\"),onPrimaryButtonClick:this.bootstrapSecretStorage,hasCancel:this.state.canSkip,onCancel:this.onCancel})));else switch(this.state.phase){case s.Loading:e=this.renderBusyPhase();break;case s.LoadError:e=this.renderPhaseLoadError();break;case s.ChooseKeyPassphrase:e=this.renderPhaseChooseKeyPassphrase();break;case s.Migrate:e=this.renderPhaseMigrate();break;case s.Passphrase:e=this.renderPhasePassPhrase();break;case s.PassphraseConfirm:e=this.renderPhasePassPhraseConfirm();break;case s.ShowKey:e=this.renderPhaseShowKey();break;case s.Storing:e=this.renderBusyPhase();break;case s.ConfirmSkip:e=this.renderPhaseSkipConfirm()}let a=null;switch(this.state.phase){case s.Passphrase:case s.PassphraseConfirm:a=[\"mx_CreateSecretStorageDialog_titleWithIcon\",\"mx_CreateSecretStorageDialog_securePhraseTitle\"];break;case s.ShowKey:a=[\"mx_CreateSecretStorageDialog_titleWithIcon\",\"mx_CreateSecretStorageDialog_secureBackupTitle\"];break;case s.ChooseKeyPassphrase:a=\"mx_CreateSecretStorageDialog_centeredTitle\"}return o.a.createElement(K.a,{className:\"mx_CreateSecretStorageDialog\",onFinished:this.props.onFinished,title:this.titleForPhase(this.state.phase),titleClass:a,hasCancel:this.props.hasCancel&&[s.Passphrase].includes(this.state.phase),fixedWidth:!1},o.a.createElement(\"div\",null,e))}}O(_,\"defaultProps\",{hasCancel:!0,forceReset:!1})}}]);","extractedComments":[]}