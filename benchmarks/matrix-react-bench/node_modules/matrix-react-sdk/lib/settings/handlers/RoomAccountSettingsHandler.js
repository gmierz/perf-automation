"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _MatrixClientPeg = require("../../MatrixClientPeg");

var _MatrixClientBackedSettingsHandler = _interopRequireDefault(require("./MatrixClientBackedSettingsHandler"));

var _objects = require("../../utils/objects");

var _SettingLevel = require("../SettingLevel");

/*
Copyright 2017 Travis Ralston
Copyright 2019, 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const ALLOWED_WIDGETS_EVENT_TYPE = "im.vector.setting.allowed_widgets";
/**
 * Gets and sets settings at the "room-account" level for the current user.
 */

class RoomAccountSettingsHandler extends _MatrixClientBackedSettingsHandler.default {
  constructor(watchers) {
    super();
    this.watchers = watchers;
    (0, _defineProperty2.default)(this, "onAccountData", (event, room, prevEvent) => {
      const roomId = room.roomId;

      if (event.getType() === "org.matrix.room.preview_urls") {
        let val = event.getContent()['disable'];

        if (typeof val !== "boolean") {
          val = null;
        } else {
          val = !val;
        }

        this.watchers.notifyUpdate("urlPreviewsEnabled", roomId, _SettingLevel.SettingLevel.ROOM_ACCOUNT, val);
      } else if (event.getType() === "im.vector.web.settings") {
        // Figure out what changed and fire those updates
        const prevContent = prevEvent ? prevEvent.getContent() : {};
        const changedSettings = (0, _objects.objectKeyChanges)(prevContent, event.getContent());

        for (const settingName of changedSettings) {
          const val = event.getContent()[settingName];
          this.watchers.notifyUpdate(settingName, roomId, _SettingLevel.SettingLevel.ROOM_ACCOUNT, val);
        }
      } else if (event.getType() === ALLOWED_WIDGETS_EVENT_TYPE) {
        this.watchers.notifyUpdate("allowedWidgets", roomId, _SettingLevel.SettingLevel.ROOM_ACCOUNT, event.getContent());
      }
    });
  }

  initMatrixClient(oldClient, newClient) {
    if (oldClient) {
      oldClient.removeListener("Room.accountData", this.onAccountData);
    }

    newClient.on("Room.accountData", this.onAccountData);
  }

  getValue(settingName, roomId) {
    // Special case URL previews
    if (settingName === "urlPreviewsEnabled") {
      const content = this.getSettings(roomId, "org.matrix.room.preview_urls") || {}; // Check to make sure that we actually got a boolean

      if (typeof content['disable'] !== "boolean") return null;
      return !content['disable'];
    } // Special case allowed widgets


    if (settingName === "allowedWidgets") {
      return this.getSettings(roomId, ALLOWED_WIDGETS_EVENT_TYPE);
    }

    const settings = this.getSettings(roomId) || {};
    return settings[settingName];
  }

  async setValue(settingName, roomId, newValue) {
    // Special case URL previews
    if (settingName === "urlPreviewsEnabled") {
      const content = this.getSettings(roomId, "org.matrix.room.preview_urls") || {};
      content['disable'] = !newValue;
      await _MatrixClientPeg.MatrixClientPeg.get().setRoomAccountData(roomId, "org.matrix.room.preview_urls", content);
      return;
    } // Special case allowed widgets


    if (settingName === "allowedWidgets") {
      await _MatrixClientPeg.MatrixClientPeg.get().setRoomAccountData(roomId, ALLOWED_WIDGETS_EVENT_TYPE, newValue);
      return;
    }

    const content = this.getSettings(roomId) || {};
    content[settingName] = newValue;
    await _MatrixClientPeg.MatrixClientPeg.get().setRoomAccountData(roomId, "im.vector.web.settings", content);
  }

  canSetValue(settingName, roomId) {
    const room = _MatrixClientPeg.MatrixClientPeg.get().getRoom(roomId); // If they have the room, they can set their own account data


    return room !== undefined && room !== null;
  }

  isSupported() {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    return cli !== undefined && cli !== null && !cli.isGuest();
  }

  getSettings(roomId, eventType = "im.vector.web.settings") {
    // TODO: [TS] Type return
    const room = _MatrixClientPeg.MatrixClientPeg.get().getRoom(roomId);

    if (!room) return null;
    const event = room.getAccountData(eventType);
    if (!event || !event.getContent()) return null;
    return (0, _objects.objectClone)(event.getContent()); // clone to prevent mutation
  }

}

exports.default = RoomAccountSettingsHandler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXR0aW5ncy9oYW5kbGVycy9Sb29tQWNjb3VudFNldHRpbmdzSGFuZGxlci50cyJdLCJuYW1lcyI6WyJBTExPV0VEX1dJREdFVFNfRVZFTlRfVFlQRSIsIlJvb21BY2NvdW50U2V0dGluZ3NIYW5kbGVyIiwiTWF0cml4Q2xpZW50QmFja2VkU2V0dGluZ3NIYW5kbGVyIiwiY29uc3RydWN0b3IiLCJ3YXRjaGVycyIsImV2ZW50Iiwicm9vbSIsInByZXZFdmVudCIsInJvb21JZCIsImdldFR5cGUiLCJ2YWwiLCJnZXRDb250ZW50Iiwibm90aWZ5VXBkYXRlIiwiU2V0dGluZ0xldmVsIiwiUk9PTV9BQ0NPVU5UIiwicHJldkNvbnRlbnQiLCJjaGFuZ2VkU2V0dGluZ3MiLCJzZXR0aW5nTmFtZSIsImluaXRNYXRyaXhDbGllbnQiLCJvbGRDbGllbnQiLCJuZXdDbGllbnQiLCJyZW1vdmVMaXN0ZW5lciIsIm9uQWNjb3VudERhdGEiLCJvbiIsImdldFZhbHVlIiwiY29udGVudCIsImdldFNldHRpbmdzIiwic2V0dGluZ3MiLCJzZXRWYWx1ZSIsIm5ld1ZhbHVlIiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0Iiwic2V0Um9vbUFjY291bnREYXRhIiwiY2FuU2V0VmFsdWUiLCJnZXRSb29tIiwidW5kZWZpbmVkIiwiaXNTdXBwb3J0ZWQiLCJjbGkiLCJpc0d1ZXN0IiwiZXZlbnRUeXBlIiwiZ2V0QWNjb3VudERhdGEiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBaUJBOztBQUNBOztBQUNBOztBQUNBOztBQXBCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQVdBLE1BQU1BLDBCQUEwQixHQUFHLG1DQUFuQztBQUVBO0FBQ0E7QUFDQTs7QUFDZSxNQUFNQywwQkFBTixTQUF5Q0MsMENBQXpDLENBQTJFO0FBQ3RGQyxFQUFBQSxXQUFXLENBQVNDLFFB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LE9BQUosRUFBN0M7QUFDSDs7QUFFT1osRUFBQUEsV0FBVyxDQUFDbEIsTUFBRCxFQUFpQitCLFNBQVMsR0FBRyx3QkFBN0IsRUFBNEQ7QUFBRTtBQUM3RSxVQUFNakMsSUFBSSxHQUFHd0IsaUNBQWdCQyxHQUFoQixHQUFzQkcsT0FBdEIsQ0FBOEIxQixNQUE5QixDQUFiOztBQUNBLFFBQUksQ0FBQ0YsSUFBTCxFQUFXLE9BQU8sSUFBUDtBQUVYLFVBQU1ELEtBQUssR0FBR0MsSUFBSSxDQUFDa0MsY0FBTCxDQUFvQkQsU0FBcEIsQ0FBZDtBQUNBLFFBQUksQ0FBQ2xDLEtBQUQsSUFBVSxDQUFDQSxLQUFLLENBQUNNLFVBQU4sRUFBZixFQUFtQyxPQUFPLElBQVA7QUFDbkMsV0FBTywwQkFBWU4sS0FBSyxDQUFDTSxVQUFOLEVBQVosQ0FBUCxDQU4yRSxDQU1uQztBQUMzQzs7QUFoR3FGIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE3IFRyYXZpcyBSYWxzdG9uXG5Db3B5cmlnaHQgMjAxOSwgMjAyMCBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gJy4uLy4uL01hdHJpeENsaWVudFBlZyc7XG5pbXBvcnQgTWF0cml4Q2xpZW50QmFja2VkU2V0dGluZ3NIYW5kbGVyIGZyb20gXCIuL01hdHJpeENsaWVudEJhY2tlZFNldHRpbmdzSGFuZGxlclwiO1xuaW1wb3J0IHsgb2JqZWN0Q2xvbmUsIG9iamVjdEtleUNoYW5nZXMgfSBmcm9tIFwiLi4vLi4vdXRpbHMvb2JqZWN0c1wiO1xuaW1wb3J0IHsgU2V0dGluZ0xldmVsIH0gZnJvbSBcIi4uL1NldHRpbmdMZXZlbFwiO1xuaW1wb3J0IHsgV2F0Y2hNYW5hZ2VyIH0gZnJvbSBcIi4uL1dhdGNoTWFuYWdlclwiO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2NsaWVudFwiO1xuaW1wb3J0IHsgTWF0cml4RXZlbnQgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL2V2ZW50XCI7XG5pbXBvcnQgeyBSb29tIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yb29tXCI7XG5cbmNvbnN0IEFMTE9XRURfV0lER0VUU19FVkVOVF9UWVBFID0gXCJpbS52ZWN0b3Iuc2V0dGluZy5hbGxvd2VkX3dpZGdldHNcIjtcblxuLyoqXG4gKiBHZXRzIGFuZCBzZXRzIHNldHRpbmdzIGF0IHRoZSBcInJvb20tYWNjb3VudFwiIGxldmVsIGZvciB0aGUgY3VycmVudCB1c2VyLlxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSb29tQWNjb3VudFNldHRpbmdzSGFuZGxlciBleHRlbmRzIE1hdHJpeENsaWVudEJhY2tlZFNldHRpbmdzSGFuZGxlciB7XG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSB3YXRjaGVyczogV2F0Y2hNYW5hZ2VyKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGluaXRNYXRyaXhDbGllbnQob2xkQ2xpZW50OiBNYXRyaXhDbGllbnQsIG5ld0NsaWVudDogTWF0cml4Q2xpZW50KSB7XG4gICAgICAgIGlmIChvbGRDbGllbnQpIHtcbiAgICAgICAgICAgIG9sZENsaWVudC5yZW1vdmVMaXN0ZW5lcihcIlJvb20uYWNjb3VudERhdGFcIiwgdGhpcy5vbkFjY291bnREYXRhKTtcbiAgICAgICAgfVxuXG4gICAgICAgIG5ld0NsaWVudC5vbihcIlJvb20uYWNjb3VudERhdGFcIiwgdGhpcy5vbkFjY291bnREYXRhKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uQWNjb3VudERhdGEgPSAoZXZlbnQ6IE1hdHJpeEV2ZW50LCByb29tOiBSb29tLCBwcmV2RXZlbnQ6IE1hdHJpeEV2ZW50KSA9PiB7XG4gICAgICAgIGNvbnN0IHJvb21JZCA9IHJvb20ucm9vbUlkO1xuXG4gICAgICAgIGlmIChldmVudC5nZXRUeXBlKCkgPT09IFwib3JnLm1hdHJpeC5yb29tLnByZXZpZXdfdXJsc1wiKSB7XG4gICAgICAgICAgICBsZXQgdmFsID0gZXZlbnQuZ2V0Q29udGVudCgpWydkaXNhYmxlJ107XG4gICAgICAgICAgICBpZiAodHlwZW9mICh2YWwpICE9PSBcImJvb2xlYW5cIikge1xuICAgICAgICAgICAgICAgIHZhbCA9IG51bGw7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhbCA9ICF2YWw7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMud2F0Y2hlcnMubm90aWZ5VXBkYXRlKFwidXJsUHJldmlld3NFbmFibGVkXCIsIHJvb21JZCwgU2V0dGluZ0xldmVsLlJPT01fQUNDT1VOVCwgdmFsKTtcbiAgICAgICAgfSBlbHNlIGlmIChldmVudC5nZXRUeXBlKCkgPT09IFwiaW0udmVjdG9yLndlYi5zZXR0aW5nc1wiKSB7XG4gICAgICAgICAgICAvLyBGaWd1cmUgb3V0IHdoYXQgY2hhbmdlZCBhbmQgZmlyZSB0aG9zZSB1cGRhdGVzXG4gICAgICAgICAgICBjb25zdCBwcmV2Q29udGVudCA9IHByZXZFdmVudCA/IHByZXZFdmVudC5nZXRDb250ZW50KCkgOiB7fTtcbiAgICAgICAgICAgIGNvbnN0IGNoYW5nZWRTZXR0aW5ncyA9IG9iamVjdEtleUNoYW5nZXM8UmVjb3JkPHN0cmluZywgYW55Pj4ocHJldkNvbnRlbnQsIGV2ZW50LmdldENvbnRlbnQoKSk7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IHNldHRpbmdOYW1lIG9mIGNoYW5nZWRTZXR0aW5ncykge1xuICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IGV2ZW50LmdldENvbnRlbnQoKVtzZXR0aW5nTmFtZV07XG4gICAgICAgICAgICAgICAgdGhpcy53YXRjaGVycy5ub3RpZnlVcGRhdGUoc2V0dGluZ05hbWUsIHJvb21JZCwgU2V0dGluZ0xldmVsLlJPT01fQUNDT1VOVCwgdmFsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChldmVudC5nZXRUeXBlKCkgPT09IEFMTE9XRURfV0lER0VUU19FVkVOVF9UWVBFKSB7XG4gICAgICAgICAgICB0aGlzLndhdGNoZXJzLm5vdGlmeVVwZGF0ZShcImFsbG93ZWRXaWRnZXRzXCIsIHJvb21JZCwgU2V0dGluZ0xldmVsLlJPT01fQUNDT1VOVCwgZXZlbnQuZ2V0Q29udGVudCgpKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwdWJsaWMgZ2V0VmFsdWUoc2V0dGluZ05hbWU6IHN0cmluZywgcm9vbUlkOiBzdHJpbmcpOiBhbnkge1xuICAgICAgICAvLyBTcGVjaWFsIGNhc2UgVVJMIHByZXZpZXdzXG4gICAgICAgIGlmIChzZXR0aW5nTmFtZSA9PT0gXCJ1cmxQcmV2aWV3c0VuYWJsZWRcIikge1xuICAgICAgICAgICAgY29uc3QgY29udGVudCA9IHRoaXMuZ2V0U2V0dGluZ3Mocm9vbUlkLCBcIm9yZy5tYXRyaXgucm9vbS5wcmV2aWV3X3VybHNcIikgfHwge307XG5cbiAgICAgICAgICAgIC8vIENoZWNrIHRvIG1ha2Ugc3VyZSB0aGF0IHdlIGFjdHVhbGx5IGdvdCBhIGJvb2xlYW5cbiAgICAgICAgICAgIGlmICh0eXBlb2YgKGNvbnRlbnRbJ2Rpc2FibGUnXSkgIT09IFwiYm9vbGVhblwiKSByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIHJldHVybiAhY29udGVudFsnZGlzYWJsZSddO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gU3BlY2lhbCBjYXNlIGFsbG93ZWQgd2lkZ2V0c1xuICAgICAgICBpZiAoc2V0dGluZ05hbWUgPT09IFwiYWxsb3dlZFdpZGdldHNcIikge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U2V0dGluZ3Mocm9vbUlkLCBBTExPV0VEX1dJREdFVFNfRVZFTlRfVFlQRSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzZXR0aW5ncyA9IHRoaXMuZ2V0U2V0dGluZ3Mocm9vbUlkKSB8fCB7fTtcbiAgICAgICAgcmV0dXJuIHNldHRpbmdzW3NldHRpbmdOYW1lXTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgc2V0VmFsdWUoc2V0dGluZ05hbWU6IHN0cmluZywgcm9vbUlkOiBzdHJpbmcsIG5ld1ZhbHVlOiBhbnkpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgLy8gU3BlY2lhbCBjYXNlIFVSTCBwcmV2aWV3c1xuICAgICAgICBpZiAoc2V0dGluZ05hbWUgPT09IFwidXJsUHJldmlld3NFbmFibGVkXCIpIHtcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSB0aGlzLmdldFNldHRpbmdzKHJvb21JZCwgXCJvcmcubWF0cml4LnJvb20ucHJldmlld191cmxzXCIpIHx8IHt9O1xuICAgICAgICAgICAgY29udGVudFsnZGlzYWJsZSddID0gIW5ld1ZhbHVlO1xuICAgICAgICAgICAgYXdhaXQgTWF0cml4Q2xpZW50UGVnLmdldCgpLnNldFJvb21BY2NvdW50RGF0YShyb29tSWQsIFwib3JnLm1hdHJpeC5yb29tLnByZXZpZXdfdXJsc1wiLCBjb250ZW50KTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFNwZWNpYWwgY2FzZSBhbGxvd2VkIHdpZGdldHNcbiAgICAgICAgaWYgKHNldHRpbmdOYW1lID09PSBcImFsbG93ZWRXaWRnZXRzXCIpIHtcbiAgICAgICAgICAgIGF3YWl0IE1hdHJpeENsaWVudFBlZy5nZXQoKS5zZXRSb29tQWNjb3VudERhdGEocm9vbUlkLCBBTExPV0VEX1dJREdFVFNfRVZFTlRfVFlQRSwgbmV3VmFsdWUpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY29udGVudCA9IHRoaXMuZ2V0U2V0dGluZ3Mocm9vbUlkKSB8fCB7fTtcbiAgICAgICAgY29udGVudFtzZXR0aW5nTmFtZV0gPSBuZXdWYWx1ZTtcbiAgICAgICAgYXdhaXQgTWF0cml4Q2xpZW50UGVnLmdldCgpLnNldFJvb21BY2NvdW50RGF0YShyb29tSWQsIFwiaW0udmVjdG9yLndlYi5zZXR0aW5nc1wiLCBjb250ZW50KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY2FuU2V0VmFsdWUoc2V0dGluZ05hbWU6IHN0cmluZywgcm9vbUlkOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3Qgcm9vbSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRSb29tKHJvb21JZCk7XG5cbiAgICAgICAgLy8gSWYgdGhleSBoYXZlIHRoZSByb29tLCB0aGV5IGNhbiBzZXQgdGhlaXIgb3duIGFjY291bnQgZGF0YVxuICAgICAgICByZXR1cm4gcm9vbSAhPT0gdW5kZWZpbmVkICYmIHJvb20gIT09IG51bGw7XG4gICAgfVxuXG4gICAgcHVibGljIGlzU3VwcG9ydGVkKCk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCBjbGkgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIHJldHVybiBjbGkgIT09IHVuZGVmaW5lZCAmJiBjbGkgIT09IG51bGwgJiYgIWNsaS5pc0d1ZXN0KCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRTZXR0aW5ncyhyb29tSWQ6IHN0cmluZywgZXZlbnRUeXBlID0gXCJpbS52ZWN0b3Iud2ViLnNldHRpbmdzXCIpOiBhbnkgeyAvLyBUT0RPOiBbVFNdIFR5cGUgcmV0dXJuXG4gICAgICAgIGNvbnN0IHJvb20gPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZ2V0Um9vbShyb29tSWQpO1xuICAgICAgICBpZiAoIXJvb20pIHJldHVybiBudWxsO1xuXG4gICAgICAgIGNvbnN0IGV2ZW50ID0gcm9vbS5nZXRBY2NvdW50RGF0YShldmVudFR5cGUpO1xuICAgICAgICBpZiAoIWV2ZW50IHx8ICFldmVudC5nZXRDb250ZW50KCkpIHJldHVybiBudWxsO1xuICAgICAgICByZXR1cm4gb2JqZWN0Q2xvbmUoZXZlbnQuZ2V0Q29udGVudCgpKTsgLy8gY2xvbmUgdG8gcHJldmVudCBtdXRhdGlvblxuICAgIH1cbn1cbiJdfQ==