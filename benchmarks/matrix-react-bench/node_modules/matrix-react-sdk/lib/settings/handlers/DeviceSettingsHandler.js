"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _SettingsHandler = _interopRequireDefault(require("./SettingsHandler"));

var _MatrixClientPeg = require("../../MatrixClientPeg");

var _SettingLevel = require("../SettingLevel");

var _Layout = require("../enums/Layout");

/*
Copyright 2017 Travis Ralston
Copyright 2019 New Vector Ltd.
Copyright 2019 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

/**
 * Gets and sets settings at the "device" level for the current device.
 * This handler does not make use of the roomId parameter. This handler
 * will special-case features to support legacy settings.
 */
class DeviceSettingsHandler extends _SettingsHandler.default {
  /**
   * Creates a new device settings handler
   * @param {string[]} featureNames The names of known features.
   * @param {WatchManager} watchers The watch manager to notify updates to
   */
  constructor(featureNames, watchers) {
    super();
    this.featureNames = featureNames;
    this.watchers = watchers;
  }

  getValue(settingName, roomId) {
    if (this.featureNames.includes(settingName)) {
      return this.readFeature(settingName);
    } // Special case notifications


    if (settingName === "notificationsEnabled") {
      const value = localStorage.getItem("notifications_enabled");
      if (typeof value === "string") return value === "true";
      return null; // wrong type or otherwise not set
    } else if (settingName === "notificationBodyEnabled") {
      const value = localStorage.getItem("notifications_body_enabled");
      if (typeof value === "string") return value === "true";
      return null; // wrong type or otherwise not set
    } else if (settingName === "audioNotificationsEnabled") {
      const value = localStorage.getItem("audio_notifications_enabled");
      if (typeof value === "string") return value === "true";
      return null; // wrong type or otherwise not set
    } // Special case the right panel - see `setValue` for rationale.


    if (["showRightPanelInRoom", "showRightPanelInGroup", "lastRightPanelPhaseForRoom", "lastRightPanelPhaseForGroup"].includes(settingName)) {
      const val = JSON.parse(localStorage.getItem(`mx_${settingName}`) || "{}");
      return val['value'];
    } // Special case for old useIRCLayout setting


    if (settingName === "layout") {
      const settings = this.getSettings() || {};

      if (settings["useIRCLayout"]) {
        // Set the new layout setting and delete the old one so that we
        // can delete this block of code after some time
        settings["layout"] = _Layout.Layout.IRC;
        delete settings["useIRCLayout"];
        localStorage.setItem("mx_local_settings", JSON.stringify(settings));
      }

      return settings[settingName];
    }

    const settings = this.getSettings() || {};
    return settings[settingName];
  }

  setValue(settingName, roomId, newValue) {
    if (this.featureNames.includes(settingName)) {
      this.writeFeature(settingName, newValue);
      return Promise.resolve();
    } // Special case notifications


    if (settingName === "notificationsEnabled") {
      localStorage.setItem("notifications_enabled", newValue);
      this.watchers.notifyUpdate(settingName, null, _SettingLevel.SettingLevel.DEVICE, newValue);
      return Promise.resolve();
    } else if (settingName === "notificationBodyEnabled") {
      localStorage.setItem("notifications_body_enabled", newValue);
      this.watchers.notifyUpdate(settingName, null, _SettingLevel.SettingLevel.DEVICE, newValue);
      return Promise.resolve();
    } else if (settingName === "audioNotificationsEnabled") {
      localStorage.setItem("audio_notifications_enabled", newValue);
      this.watchers.notifyUpdate(settingName, null, _SettingLevel.SettingLevel.DEVICE, newValue);
      return Promise.resolve();
    } // Special case the right panel because we want to be able to update these all
    // concurrently without stomping on one another. We could use async/await, though
    // that introduces just enough latency to be annoying.


    if (["showRightPanelInRoom", "showRightPanelInGroup", "lastRightPanelPhaseForRoom", "lastRightPanelPhaseForGroup"].includes(settingName)) {
      localStorage.setItem(`mx_${settingName}`, JSON.stringify({
        value: newValue
      }));
      this.watchers.notifyUpdate(settingName, null, _SettingLevel.SettingLevel.DEVICE, newValue);
      return Promise.resolve();
    } // Special case for old useIRCLayout setting


    if (settingName === "layout") {
      const settings = this.getSettings() || {};
      delete settings["useIRCLayout"];
      settings["layout"] = newValue;
      localStorage.setItem("mx_local_settings", JSON.stringify(settings));
      this.watchers.notifyUpdate(settingName, null, _SettingLevel.SettingLevel.DEVICE, newValue);
      return Promise.resolve();
    }

    const settings = this.getSettings() || {};
    settings[settingName] = newValue;
    localStorage.setItem("mx_local_settings", JSON.stringify(settings));
    this.watchers.notifyUpdate(settingName, null, _SettingLevel.SettingLevel.DEVICE, newValue);
    return Promise.resolve();
  }

  canSetValue(settingName, roomId) {
    return true; // It's their device, so they should be able to
  }

  isSupported() {
    return localStorage !== undefined && localStorage !== null;
  }

  watchSetting(settingName, roomId, cb) {
    this.watchers.watchSetting(settingName, roomId, cb);
  }

  unwatchSetting(cb) {
    this.watchers.unwatchSetting(cb);
  }

  getSettings() {
    // TODO: [TS] Type return
    const value = localStorage.getItem("mx_local_settings");
    if (!value) return null;
    return JSON.parse(value);
  } // Note: features intentionally don't use the same key as settings to avoid conflicts
  // and to be backwards compatible.


  readFeature(featureName) {
    if (_MatrixClientPeg.MatrixClientPeg.get() && _MatrixClientPeg.MatrixClientPeg.get().isGuest()) {
      // Guests should not have any labs features enabled.
      return false;
    }

    const value = localStorage.getItem("mx_labs_feature_" + featureName);
    if (value === "true") return true;
    if (value === "false") return false; // Try to read the next config level for the feature.

    return null;
  }

  writeFeature(featureName, enabled) {
    localStorage.setItem("mx_labs_feature_" + featureName, `${enabled}`);
    this.watchers.notifyUpdate(featureName, null, _SettingLevel.SettingLevel.DEVICE, enabled);
  }

}

exports.default = DeviceSettingsHandler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXR0aW5ncy9oYW5kbGVycy9EZXZpY2VTZXR0aW5nc0hhbmRsZXIudHMiXSwibmFtZXMiOlsiRGV2aWNlU2V0dGluZ3NIYW5kbGVyIiwiU2V0dGluZ3NIYW5kbGVyIiwiY29uc3RydWN0b3IiLCJmZWF0dXJlTmFtZXMiLCJ3YXRjaGVycyIsImdldFZhbHVlIiwic2V0dGluZ05hbWUiLCJyb29tSWQiLCJpbmNsdWRlcyIsInJlYWRGZWF0dXJlIiwidmFsdWUiLCJsb2NhbFN0b3JhZ2UiLCJnZXRJdGVtIiwidmFsIiwiSlNPTiIsInBhcnNlIiwic2V0dGluZ3MiLCJnZXRTZXR0aW5ncyIsIkxheW91dCIsIklSQyIsInNldEl0ZW0iLCJzdHJpbmdpZnkiLCJzZXRWYWx1ZSIsIm5ld1ZhbHVlIiwid3JpdGVGZWF0dXJlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJub3RpZnlVcGRhdGUiLCJTZXR0aW5nTGV2ZWwiLCJERVZJQ0UiLCJjYW5TZXRWYWx1ZSIsImlzU3VwcG9ydGVkIiwidW5kZWZpbmVkIiwid2F0Y2hTZXR0aW5nIiwiY2IiLCJ1bndhdGNoU2V0dGluZyIsImZlYXR1cmVOYW1lIiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0IiwiaXNHdWVzdCIsImVuYWJsZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQWtCQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUF0QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFRQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ2UsTUFBTUEscUJBQU4sU0FBb0NDLHdCQUFwQyxDQUFvRDtBQUMvRDtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLFdBQVcsQ0FBU0MsWUFBVCxFQUF5Q0MsUUFBekMsRUFBaUU7QUFDeEU7QUFEd0UsU0FBeERELFlBQXdELEdBQXhEQSxZQUF3RDtBQUFBLFNBQXhCQyxR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NyBUcmF2aXMgUmFsc3RvblxuQ29weXJpZ2h0IDIwMTkgTmV3IFZlY3RvciBMdGQuXG5Db3B5cmlnaHQgMjAxOSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBTZXR0aW5nc0hhbmRsZXIgZnJvbSBcIi4vU2V0dGluZ3NIYW5kbGVyXCI7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tIFwiLi4vLi4vTWF0cml4Q2xpZW50UGVnXCI7XG5pbXBvcnQgeyBTZXR0aW5nTGV2ZWwgfSBmcm9tIFwiLi4vU2V0dGluZ0xldmVsXCI7XG5pbXBvcnQgeyBDYWxsYmFja0ZuLCBXYXRjaE1hbmFnZXIgfSBmcm9tIFwiLi4vV2F0Y2hNYW5hZ2VyXCI7XG5pbXBvcnQgeyBMYXlvdXQgfSBmcm9tIFwiLi4vZW51bXMvTGF5b3V0XCI7XG5cbi8qKlxuICogR2V0cyBhbmQgc2V0cyBzZXR0aW5ncyBhdCB0aGUgXCJkZXZpY2VcIiBsZXZlbCBmb3IgdGhlIGN1cnJlbnQgZGV2aWNlLlxuICogVGhpcyBoYW5kbGVyIGRvZXMgbm90IG1ha2UgdXNlIG9mIHRoZSByb29tSWQgcGFyYW1ldGVyLiBUaGlzIGhhbmRsZXJcbiAqIHdpbGwgc3BlY2lhbC1jYXNlIGZlYXR1cmVzIHRvIHN1cHBvcnQgbGVnYWN5IHNldHRpbmdzLlxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBEZXZpY2VTZXR0aW5nc0hhbmRsZXIgZXh0ZW5kcyBTZXR0aW5nc0hhbmRsZXIge1xuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgYSBuZXcgZGV2aWNlIHNldHRpbmdzIGhhbmRsZXJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ1tdfSBmZWF0dXJlTmFtZXMgVGhlIG5hbWVzIG9mIGtub3duIGZlYXR1cmVzLlxuICAgICAqIEBwYXJhbSB7V2F0Y2hNYW5hZ2VyfSB3YXRjaGVycyBUaGUgd2F0Y2ggbWFuYWdlciB0byBub3RpZnkgdXBkYXRlcyB0b1xuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgZmVhdHVyZU5hbWVzOiBzdHJpbmdbXSwgcHJpdmF0ZSB3YXRjaGVyczogV2F0Y2hNYW5hZ2VyKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldFZhbHVlKHNldHRpbmdOYW1lOiBzdHJpbmcsIHJvb21JZDogc3RyaW5nKTogYW55IHtcbiAgICAgICAgaWYgKHRoaXMuZmVhdHVyZU5hbWVzLmluY2x1ZGVzKHNldHRpbmdOYW1lKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVhZEZlYXR1cmUoc2V0dGluZ05hbWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gU3BlY2lhbCBjYXNlIG5vdGlmaWNhdGlvbnNcbiAgICAgICAgaWYgKHNldHRpbmdOYW1lID09PSBcIm5vdGlmaWNhdGlvbnNFbmFibGVkXCIpIHtcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oXCJub3RpZmljYXRpb25zX2VuYWJsZWRcIik7XG4gICAgICAgICAgICBpZiAodHlwZW9mKHZhbHVlKSA9PT0gXCJzdHJpbmdcIikgcmV0dXJuIHZhbHVlID09PSBcInRydWVcIjtcbiAgICAgICAgICAgIHJldHVybiBudWxsOyAvLyB3cm9uZyB0eXBlIG9yIG90aGVyd2lzZSBub3Qgc2V0XG4gICAgICAgIH0gZWxzZSBpZiAoc2V0dGluZ05hbWUgPT09IFwibm90aWZpY2F0aW9uQm9keUVuYWJsZWRcIikge1xuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShcIm5vdGlmaWNhdGlvbnNfYm9keV9lbmFibGVkXCIpO1xuICAgICAgICAgICAgaWYgKHR5cGVvZih2YWx1ZSkgPT09IFwic3RyaW5nXCIpIHJldHVybiB2YWx1ZSA9PT0gXCJ0cnVlXCI7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDsgLy8gd3JvbmcgdHlwZSBvciBvdGhlcndpc2Ugbm90IHNldFxuICAgICAgICB9IGVsc2UgaWYgKHNldHRpbmdOYW1lID09PSBcImF1ZGlvTm90aWZpY2F0aW9uc0VuYWJsZWRcIikge1xuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShcImF1ZGlvX25vdGlmaWNhdGlvbnNfZW5hYmxlZFwiKTtcbiAgICAgICAgICAgIGlmICh0eXBlb2YodmFsdWUpID09PSBcInN0cmluZ1wiKSByZXR1cm4gdmFsdWUgPT09IFwidHJ1ZVwiO1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7IC8vIHdyb25nIHR5cGUgb3Igb3RoZXJ3aXNlIG5vdCBzZXRcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFNwZWNpYWwgY2FzZSB0aGUgcmlnaHQgcGFuZWwgLSBzZWUgYHNldFZhbHVlYCBmb3IgcmF0aW9uYWxlLlxuICAgICAgICBpZiAoW1xuICAgICAgICAgICAgXCJzaG93UmlnaHRQYW5lbEluUm9vbVwiLFxuICAgICAgICAgICAgXCJzaG93UmlnaHRQYW5lbEluR3JvdXBcIixcbiAgICAgICAgICAgIFwibGFzdFJpZ2h0UGFuZWxQaGFzZUZvclJvb21cIixcbiAgICAgICAgICAgIFwibGFzdFJpZ2h0UGFuZWxQaGFzZUZvckdyb3VwXCIsXG4gICAgICAgIF0uaW5jbHVkZXMoc2V0dGluZ05hbWUpKSB7XG4gICAgICAgICAgICBjb25zdCB2YWwgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKGBteF8ke3NldHRpbmdOYW1lfWApIHx8IFwie31cIik7XG4gICAgICAgICAgICByZXR1cm4gdmFsWyd2YWx1ZSddO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gU3BlY2lhbCBjYXNlIGZvciBvbGQgdXNlSVJDTGF5b3V0IHNldHRpbmdcbiAgICAgICAgaWYgKHNldHRpbmdOYW1lID09PSBcImxheW91dFwiKSB7XG4gICAgICAgICAgICBjb25zdCBzZXR0aW5ncyA9IHRoaXMuZ2V0U2V0dGluZ3MoKSB8fCB7fTtcbiAgICAgICAgICAgIGlmIChzZXR0aW5nc1tcInVzZUlSQ0xheW91dFwiXSkge1xuICAgICAgICAgICAgICAgIC8vIFNldCB0aGUgbmV3IGxheW91dCBzZXR0aW5nIGFuZCBkZWxldGUgdGhlIG9sZCBvbmUgc28gdGhhdCB3ZVxuICAgICAgICAgICAgICAgIC8vIGNhbiBkZWxldGUgdGhpcyBibG9jayBvZiBjb2RlIGFmdGVyIHNvbWUgdGltZVxuICAgICAgICAgICAgICAgIHNldHRpbmdzW1wibGF5b3V0XCJdID0gTGF5b3V0LklSQztcbiAgICAgICAgICAgICAgICBkZWxldGUgc2V0dGluZ3NbXCJ1c2VJUkNMYXlvdXRcIl07XG4gICAgICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oXCJteF9sb2NhbF9zZXR0aW5nc1wiLCBKU09OLnN0cmluZ2lmeShzZXR0aW5ncykpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHNldHRpbmdzW3NldHRpbmdOYW1lXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHNldHRpbmdzID0gdGhpcy5nZXRTZXR0aW5ncygpIHx8IHt9O1xuICAgICAgICByZXR1cm4gc2V0dGluZ3Nbc2V0dGluZ05hbWVdO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXRWYWx1ZShzZXR0aW5nTmFtZTogc3RyaW5nLCByb29tSWQ6IHN0cmluZywgbmV3VmFsdWU6IGFueSk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBpZiAodGhpcy5mZWF0dXJlTmFtZXMuaW5jbHVkZXMoc2V0dGluZ05hbWUpKSB7XG4gICAgICAgICAgICB0aGlzLndyaXRlRmVhdHVyZShzZXR0aW5nTmFtZSwgbmV3VmFsdWUpO1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gU3BlY2lhbCBjYXNlIG5vdGlmaWNhdGlvbnNcbiAgICAgICAgaWYgKHNldHRpbmdOYW1lID09PSBcIm5vdGlmaWNhdGlvbnNFbmFibGVkXCIpIHtcbiAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFwibm90aWZpY2F0aW9uc19lbmFibGVkXCIsIG5ld1ZhbHVlKTtcbiAgICAgICAgICAgIHRoaXMud2F0Y2hlcnMubm90aWZ5VXBkYXRlKHNldHRpbmdOYW1lLCBudWxsLCBTZXR0aW5nTGV2ZWwuREVWSUNFLCBuZXdWYWx1ZSk7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICAgIH0gZWxzZSBpZiAoc2V0dGluZ05hbWUgPT09IFwibm90aWZpY2F0aW9uQm9keUVuYWJsZWRcIikge1xuICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oXCJub3RpZmljYXRpb25zX2JvZHlfZW5hYmxlZFwiLCBuZXdWYWx1ZSk7XG4gICAgICAgICAgICB0aGlzLndhdGNoZXJzLm5vdGlmeVVwZGF0ZShzZXR0aW5nTmFtZSwgbnVsbCwgU2V0dGluZ0xldmVsLkRFVklDRSwgbmV3VmFsdWUpO1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgICAgICB9IGVsc2UgaWYgKHNldHRpbmdOYW1lID09PSBcImF1ZGlvTm90aWZpY2F0aW9uc0VuYWJsZWRcIikge1xuICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oXCJhdWRpb19ub3RpZmljYXRpb25zX2VuYWJsZWRcIiwgbmV3VmFsdWUpO1xuICAgICAgICAgICAgdGhpcy53YXRjaGVycy5ub3RpZnlVcGRhdGUoc2V0dGluZ05hbWUsIG51bGwsIFNldHRpbmdMZXZlbC5ERVZJQ0UsIG5ld1ZhbHVlKTtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFNwZWNpYWwgY2FzZSB0aGUgcmlnaHQgcGFuZWwgYmVjYXVzZSB3ZSB3YW50IHRvIGJlIGFibGUgdG8gdXBkYXRlIHRoZXNlIGFsbFxuICAgICAgICAvLyBjb25jdXJyZW50bHkgd2l0aG91dCBzdG9tcGluZyBvbiBvbmUgYW5vdGhlci4gV2UgY291bGQgdXNlIGFzeW5jL2F3YWl0LCB0aG91Z2hcbiAgICAgICAgLy8gdGhhdCBpbnRyb2R1Y2VzIGp1c3QgZW5vdWdoIGxhdGVuY3kgdG8gYmUgYW5ub3lpbmcuXG4gICAgICAgIGlmIChbXG4gICAgICAgICAgICBcInNob3dSaWdodFBhbmVsSW5Sb29tXCIsXG4gICAgICAgICAgICBcInNob3dSaWdodFBhbmVsSW5Hcm91cFwiLFxuICAgICAgICAgICAgXCJsYXN0UmlnaHRQYW5lbFBoYXNlRm9yUm9vbVwiLFxuICAgICAgICAgICAgXCJsYXN0UmlnaHRQYW5lbFBoYXNlRm9yR3JvdXBcIixcbiAgICAgICAgXS5pbmNsdWRlcyhzZXR0aW5nTmFtZSkpIHtcbiAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGBteF8ke3NldHRpbmdOYW1lfWAsIEpTT04uc3RyaW5naWZ5KHsgdmFsdWU6IG5ld1ZhbHVlIH0pKTtcbiAgICAgICAgICAgIHRoaXMud2F0Y2hlcnMubm90aWZ5VXBkYXRlKHNldHRpbmdOYW1lLCBudWxsLCBTZXR0aW5nTGV2ZWwuREVWSUNFLCBuZXdWYWx1ZSk7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBTcGVjaWFsIGNhc2UgZm9yIG9sZCB1c2VJUkNMYXlvdXQgc2V0dGluZ1xuICAgICAgICBpZiAoc2V0dGluZ05hbWUgPT09IFwibGF5b3V0XCIpIHtcbiAgICAgICAgICAgIGNvbnN0IHNldHRpbmdzID0gdGhpcy5nZXRTZXR0aW5ncygpIHx8IHt9O1xuXG4gICAgICAgICAgICBkZWxldGUgc2V0dGluZ3NbXCJ1c2VJUkNMYXlvdXRcIl07XG4gICAgICAgICAgICBzZXR0aW5nc1tcImxheW91dFwiXSA9IG5ld1ZhbHVlO1xuICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oXCJteF9sb2NhbF9zZXR0aW5nc1wiLCBKU09OLnN0cmluZ2lmeShzZXR0aW5ncykpO1xuXG4gICAgICAgICAgICB0aGlzLndhdGNoZXJzLm5vdGlmeVVwZGF0ZShzZXR0aW5nTmFtZSwgbnVsbCwgU2V0dGluZ0xldmVsLkRFVklDRSwgbmV3VmFsdWUpO1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSB0aGlzLmdldFNldHRpbmdzKCkgfHwge307XG4gICAgICAgIHNldHRpbmdzW3NldHRpbmdOYW1lXSA9IG5ld1ZhbHVlO1xuICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShcIm14X2xvY2FsX3NldHRpbmdzXCIsIEpTT04uc3RyaW5naWZ5KHNldHRpbmdzKSk7XG4gICAgICAgIHRoaXMud2F0Y2hlcnMubm90aWZ5VXBkYXRlKHNldHRpbmdOYW1lLCBudWxsLCBTZXR0aW5nTGV2ZWwuREVWSUNFLCBuZXdWYWx1ZSk7XG5cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBjYW5TZXRWYWx1ZShzZXR0aW5nTmFtZTogc3RyaW5nLCByb29tSWQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdHJ1ZTsgLy8gSXQncyB0aGVpciBkZXZpY2UsIHNvIHRoZXkgc2hvdWxkIGJlIGFibGUgdG9cbiAgICB9XG5cbiAgICBwdWJsaWMgaXNTdXBwb3J0ZWQoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBsb2NhbFN0b3JhZ2UgIT09IHVuZGVmaW5lZCAmJiBsb2NhbFN0b3JhZ2UgIT09IG51bGw7XG4gICAgfVxuXG4gICAgcHVibGljIHdhdGNoU2V0dGluZyhzZXR0aW5nTmFtZTogc3RyaW5nLCByb29tSWQ6IHN0cmluZywgY2I6IENhbGxiYWNrRm4pIHtcbiAgICAgICAgdGhpcy53YXRjaGVycy53YXRjaFNldHRpbmcoc2V0dGluZ05hbWUsIHJvb21JZCwgY2IpO1xuICAgIH1cblxuICAgIHB1YmxpYyB1bndhdGNoU2V0dGluZyhjYjogQ2FsbGJhY2tGbikge1xuICAgICAgICB0aGlzLndhdGNoZXJzLnVud2F0Y2hTZXR0aW5nKGNiKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFNldHRpbmdzKCk6IGFueSB7IC8vIFRPRE86IFtUU10gVHlwZSByZXR1cm5cbiAgICAgICAgY29uc3QgdmFsdWUgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShcIm14X2xvY2FsX3NldHRpbmdzXCIpO1xuICAgICAgICBpZiAoIXZhbHVlKSByZXR1cm4gbnVsbDtcbiAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UodmFsdWUpO1xuICAgIH1cblxuICAgIC8vIE5vdGU6IGZlYXR1cmVzIGludGVudGlvbmFsbHkgZG9uJ3QgdXNlIHRoZSBzYW1lIGtleSBhcyBzZXR0aW5ncyB0byBhdm9pZCBjb25mbGljdHNcbiAgICAvLyBhbmQgdG8gYmUgYmFja3dhcmRzIGNvbXBhdGlibGUuXG5cbiAgICBwcml2YXRlIHJlYWRGZWF0dXJlKGZlYXR1cmVOYW1lOiBzdHJpbmcpOiBib29sZWFuIHwgbnVsbCB7XG4gICAgICAgIGlmIChNYXRyaXhDbGllbnRQZWcuZ2V0KCkgJiYgTWF0cml4Q2xpZW50UGVnLmdldCgpLmlzR3Vlc3QoKSkge1xuICAgICAgICAgICAgLy8gR3Vlc3RzIHNob3VsZCBub3QgaGF2ZSBhbnkgbGFicyBmZWF0dXJlcyBlbmFibGVkLlxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdmFsdWUgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShcIm14X2xhYnNfZmVhdHVyZV9cIiArIGZlYXR1cmVOYW1lKTtcbiAgICAgICAgaWYgKHZhbHVlID09PSBcInRydWVcIikgcmV0dXJuIHRydWU7XG4gICAgICAgIGlmICh2YWx1ZSA9PT0gXCJmYWxzZVwiKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIC8vIFRyeSB0byByZWFkIHRoZSBuZXh0IGNvbmZpZyBsZXZlbCBmb3IgdGhlIGZlYXR1cmUuXG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHByaXZhdGUgd3JpdGVGZWF0dXJlKGZlYXR1cmVOYW1lOiBzdHJpbmcsIGVuYWJsZWQ6IGJvb2xlYW4gfCBudWxsKSB7XG4gICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFwibXhfbGFic19mZWF0dXJlX1wiICsgZmVhdHVyZU5hbWUsIGAke2VuYWJsZWR9YCk7XG4gICAgICAgIHRoaXMud2F0Y2hlcnMubm90aWZ5VXBkYXRlKGZlYXR1cmVOYW1lLCBudWxsLCBTZXR0aW5nTGV2ZWwuREVWSUNFLCBlbmFibGVkKTtcbiAgICB9XG59XG4iXX0=