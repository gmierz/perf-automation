"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _MatrixClientPeg = require("../../MatrixClientPeg");

var _MatrixClientBackedSettingsHandler = _interopRequireDefault(require("./MatrixClientBackedSettingsHandler"));

var _objects = require("../../utils/objects");

var _SettingLevel = require("../SettingLevel");

/*
Copyright 2017 Travis Ralston
Copyright 2019, 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

/**
 * Gets and sets settings at the "room" level.
 */
class RoomSettingsHandler extends _MatrixClientBackedSettingsHandler.default {
  constructor(watchers) {
    super();
    this.watchers = watchers;
    (0, _defineProperty2.default)(this, "onEvent", (event, state, prevEvent) => {
      const roomId = event.getRoomId();
      const room = this.client.getRoom(roomId); // Note: in tests and during the encryption setup on initial load we might not have
      // rooms in the store, so we just quietly ignore the problem. If we log it then we'll
      // just end up spamming the logs a few thousand times. It is perfectly fine for us
      // to ignore the problem as the app will not have loaded enough to care yet.

      if (!room) return; // ignore state updates which are not current

      if (room && state !== room.currentState) return;

      if (event.getType() === "org.matrix.room.preview_urls") {
        let val = event.getContent()['disable'];

        if (typeof val !== "boolean") {
          val = null;
        } else {
          val = !val;
        }

        this.watchers.notifyUpdate("urlPreviewsEnabled", roomId, _SettingLevel.SettingLevel.ROOM, val);
      } else if (event.getType() === "im.vector.web.settings") {
        // Figure out what changed and fire those updates
        const prevContent = prevEvent ? prevEvent.getContent() : {};
        const changedSettings = (0, _objects.objectKeyChanges)(prevContent, event.getContent());

        for (const settingName of changedSettings) {
          this.watchers.notifyUpdate(settingName, roomId, _SettingLevel.SettingLevel.ROOM, event.getContent()[settingName]);
        }
      }
    });
  }

  initMatrixClient(oldClient, newClient) {
    if (oldClient) {
      oldClient.removeListener("RoomState.events", this.onEvent);
    }

    newClient.on("RoomState.events", this.onEvent);
  }

  getValue(settingName, roomId) {
    // Special case URL previews
    if (settingName === "urlPreviewsEnabled") {
      const content = this.getSettings(roomId, "org.matrix.room.preview_urls") || {}; // Check to make sure that we actually got a boolean

      if (typeof content['disable'] !== "boolean") return null;
      return !content['disable'];
    }

    const settings = this.getSettings(roomId) || {};
    return settings[settingName];
  }

  async setValue(settingName, roomId, newValue) {
    // Special case URL previews
    if (settingName === "urlPreviewsEnabled") {
      const content = this.getSettings(roomId, "org.matrix.room.preview_urls") || {};
      content['disable'] = !newValue;
      await _MatrixClientPeg.MatrixClientPeg.get().sendStateEvent(roomId, "org.matrix.room.preview_urls", content);
      return;
    }

    const content = this.getSettings(roomId) || {};
    content[settingName] = newValue;
    await _MatrixClientPeg.MatrixClientPeg.get().sendStateEvent(roomId, "im.vector.web.settings", content, "");
  }

  canSetValue(settingName, roomId) {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    const room = cli.getRoom(roomId);
    let eventType = "im.vector.web.settings";
    if (settingName === "urlPreviewsEnabled") eventType = "org.matrix.room.preview_urls";
    if (!room) return false;
    return room.currentState.maySendStateEvent(eventType, cli.getUserId());
  }

  isSupported() {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    return cli !== undefined && cli !== null;
  }

  getSettings(roomId, eventType = "im.vector.web.settings") {
    const room = _MatrixClientPeg.MatrixClientPeg.get().getRoom(roomId);

    if (!room) return null;
    const event = room.currentState.getStateEvents(eventType, "");
    if (!event || !event.getContent()) return null;
    return (0, _objects.objectClone)(event.getContent()); // clone to prevent mutation
  }

}

exports.default = RoomSettingsHandler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXR0aW5ncy9oYW5kbGVycy9Sb29tU2V0dGluZ3NIYW5kbGVyLnRzIl0sIm5hbWVzIjpbIlJvb21TZXR0aW5nc0hhbmRsZXIiLCJNYXRyaXhDbGllbnRCYWNrZWRTZXR0aW5nc0hhbmRsZXIiLCJjb25zdHJ1Y3RvciIsIndhdGNoZXJzIiwiZXZlbnQiLCJzdGF0ZSIsInByZXZFdmVudCIsInJvb21JZCIsImdldFJvb21JZCIsInJvb20iLCJjbGllbnQiLCJnZXRSb29tIiwiY3VycmVudFN0YXRlIiwiZ2V0VHlwZSIsInZhbCIsImdldENvbnRlbnQiLCJub3RpZnlVcGRhdGUiLCJTZXR0aW5nTGV2ZWwiLCJST09NIiwicHJldkNvbnRlbnQiLCJjaGFuZ2VkU2V0dGluZ3MiLCJzZXR0aW5nTmFtZSIsImluaXRNYXRyaXhDbGllbnQiLCJvbGRDbGllbnQiLCJuZXdDbGllbnQiLCJyZW1vdmVMaXN0ZW5lciIsIm9uRXZlbnQiLCJvbiIsImdldFZhbHVlIiwiY29udGVudCIsImdldFNldHRpbmdzIiwic2V0dGluZ3MiLCJzZXRWYWx1ZSIsIm5ld1ZhbHVlIiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0Iiwic2VuZFN0YXRlRXZlbnQiLCJjYW5TZXRWYWx1ZSIsImNsaSIsImV2ZW50VHlwZSIsIm1heVNlbmRTdGF0ZUV2ZW50IiwiZ2V0VXNlcklkIiwiaXNTdXBwb3J0ZWQiLCJ1bmRlZmluZWQiLCJnZXRTdGF0ZUV2ZW50cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFpQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBcEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQVdBO0FBQ0E7QUFDQTtBQUNlLE1BQU1BLG1CQUFOLFNBQWtDQywwQ0FBbEMsQ0FBb0U7QUFDL0VDLEVBQUFBLFdBQVcsQ0FBU0MsUUFBVCxFQUFpQztBQUN4QztBQUR3QyxTQUF4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LENBQThCSixNQUE5QixDQUFiOztBQUNBLFFBQUksQ0FBQ0UsSUFBTCxFQUFXLE9BQU8sSUFBUDtBQUVYLFVBQU1MLEtBQUssR0FBR0ssSUFBSSxDQUFDRyxZQUFMLENBQWtCZ0MsY0FBbEIsQ0FBaUNMLFNBQWpDLEVBQTRDLEVBQTVDLENBQWQ7QUFDQSxRQUFJLENBQUNuQyxLQUFELElBQVUsQ0FBQ0EsS0FBSyxDQUFDVyxVQUFOLEVBQWYsRUFBbUMsT0FBTyxJQUFQO0FBQ25DLFdBQU8sMEJBQVlYLEtBQUssQ0FBQ1csVUFBTixFQUFaLENBQVAsQ0FOMkUsQ0FNbkM7QUFDM0M7O0FBakc4RSIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNyBUcmF2aXMgUmFsc3RvblxuQ29weXJpZ2h0IDIwMTksIDIwMjAgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tICcuLi8uLi9NYXRyaXhDbGllbnRQZWcnO1xuaW1wb3J0IE1hdHJpeENsaWVudEJhY2tlZFNldHRpbmdzSGFuZGxlciBmcm9tIFwiLi9NYXRyaXhDbGllbnRCYWNrZWRTZXR0aW5nc0hhbmRsZXJcIjtcbmltcG9ydCB7IG9iamVjdENsb25lLCBvYmplY3RLZXlDaGFuZ2VzIH0gZnJvbSBcIi4uLy4uL3V0aWxzL29iamVjdHNcIjtcbmltcG9ydCB7IFNldHRpbmdMZXZlbCB9IGZyb20gXCIuLi9TZXR0aW5nTGV2ZWxcIjtcbmltcG9ydCB7IFdhdGNoTWFuYWdlciB9IGZyb20gXCIuLi9XYXRjaE1hbmFnZXJcIjtcbmltcG9ydCB7IE1hdHJpeENsaWVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9jbGllbnRcIjtcbmltcG9ydCB7IE1hdHJpeEV2ZW50IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9ldmVudFwiO1xuaW1wb3J0IHsgUm9vbVN0YXRlIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yb29tLXN0YXRlXCI7XG5cbi8qKlxuICogR2V0cyBhbmQgc2V0cyBzZXR0aW5ncyBhdCB0aGUgXCJyb29tXCIgbGV2ZWwuXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJvb21TZXR0aW5nc0hhbmRsZXIgZXh0ZW5kcyBNYXRyaXhDbGllbnRCYWNrZWRTZXR0aW5nc0hhbmRsZXIge1xuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgd2F0Y2hlcnM6IFdhdGNoTWFuYWdlcikge1xuICAgICAgICBzdXBlcigpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBpbml0TWF0cml4Q2xpZW50KG9sZENsaWVudDogTWF0cml4Q2xpZW50LCBuZXdDbGllbnQ6IE1hdHJpeENsaWVudCkge1xuICAgICAgICBpZiAob2xkQ2xpZW50KSB7XG4gICAgICAgICAgICBvbGRDbGllbnQucmVtb3ZlTGlzdGVuZXIoXCJSb29tU3RhdGUuZXZlbnRzXCIsIHRoaXMub25FdmVudCk7XG4gICAgICAgIH1cblxuICAgICAgICBuZXdDbGllbnQub24oXCJSb29tU3RhdGUuZXZlbnRzXCIsIHRoaXMub25FdmVudCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkV2ZW50ID0gKGV2ZW50OiBNYXRyaXhFdmVudCwgc3RhdGU6IFJvb21TdGF0ZSwgcHJldkV2ZW50OiBNYXRyaXhFdmVudCkgPT4ge1xuICAgICAgICBjb25zdCByb29tSWQgPSBldmVudC5nZXRSb29tSWQoKTtcbiAgICAgICAgY29uc3Qgcm9vbSA9IHRoaXMuY2xpZW50LmdldFJvb20ocm9vbUlkKTtcblxuICAgICAgICAvLyBOb3RlOiBpbiB0ZXN0cyBhbmQgZHVyaW5nIHRoZSBlbmNyeXB0aW9uIHNldHVwIG9uIGluaXRpYWwgbG9hZCB3ZSBtaWdodCBub3QgaGF2ZVxuICAgICAgICAvLyByb29tcyBpbiB0aGUgc3RvcmUsIHNvIHdlIGp1c3QgcXVpZXRseSBpZ25vcmUgdGhlIHByb2JsZW0uIElmIHdlIGxvZyBpdCB0aGVuIHdlJ2xsXG4gICAgICAgIC8vIGp1c3QgZW5kIHVwIHNwYW1taW5nIHRoZSBsb2dzIGEgZmV3IHRob3VzYW5kIHRpbWVzLiBJdCBpcyBwZXJmZWN0bHkgZmluZSBmb3IgdXNcbiAgICAgICAgLy8gdG8gaWdub3JlIHRoZSBwcm9ibGVtIGFzIHRoZSBhcHAgd2lsbCBub3QgaGF2ZSBsb2FkZWQgZW5vdWdoIHRvIGNhcmUgeWV0LlxuICAgICAgICBpZiAoIXJvb20pIHJldHVybjtcblxuICAgICAgICAvLyBpZ25vcmUgc3RhdGUgdXBkYXRlcyB3aGljaCBhcmUgbm90IGN1cnJlbnRcbiAgICAgICAgaWYgKHJvb20gJiYgc3RhdGUgIT09IHJvb20uY3VycmVudFN0YXRlKSByZXR1cm47XG5cbiAgICAgICAgaWYgKGV2ZW50LmdldFR5cGUoKSA9PT0gXCJvcmcubWF0cml4LnJvb20ucHJldmlld191cmxzXCIpIHtcbiAgICAgICAgICAgIGxldCB2YWwgPSBldmVudC5nZXRDb250ZW50KClbJ2Rpc2FibGUnXTtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgKHZhbCkgIT09IFwiYm9vbGVhblwiKSB7XG4gICAgICAgICAgICAgICAgdmFsID0gbnVsbDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFsID0gIXZhbDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy53YXRjaGVycy5ub3RpZnlVcGRhdGUoXCJ1cmxQcmV2aWV3c0VuYWJsZWRcIiwgcm9vbUlkLCBTZXR0aW5nTGV2ZWwuUk9PTSwgdmFsKTtcbiAgICAgICAgfSBlbHNlIGlmIChldmVudC5nZXRUeXBlKCkgPT09IFwiaW0udmVjdG9yLndlYi5zZXR0aW5nc1wiKSB7XG4gICAgICAgICAgICAvLyBGaWd1cmUgb3V0IHdoYXQgY2hhbmdlZCBhbmQgZmlyZSB0aG9zZSB1cGRhdGVzXG4gICAgICAgICAgICBjb25zdCBwcmV2Q29udGVudCA9IHByZXZFdmVudCA/IHByZXZFdmVudC5nZXRDb250ZW50KCkgOiB7fTtcbiAgICAgICAgICAgIGNvbnN0IGNoYW5nZWRTZXR0aW5ncyA9IG9iamVjdEtleUNoYW5nZXM8UmVjb3JkPHN0cmluZywgYW55Pj4ocHJldkNvbnRlbnQsIGV2ZW50LmdldENvbnRlbnQoKSk7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IHNldHRpbmdOYW1lIG9mIGNoYW5nZWRTZXR0aW5ncykge1xuICAgICAgICAgICAgICAgIHRoaXMud2F0Y2hlcnMubm90aWZ5VXBkYXRlKHNldHRpbmdOYW1lLCByb29tSWQsIFNldHRpbmdMZXZlbC5ST09NLFxuICAgICAgICAgICAgICAgICAgICBldmVudC5nZXRDb250ZW50KClbc2V0dGluZ05hbWVdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwdWJsaWMgZ2V0VmFsdWUoc2V0dGluZ05hbWU6IHN0cmluZywgcm9vbUlkOiBzdHJpbmcpOiBhbnkge1xuICAgICAgICAvLyBTcGVjaWFsIGNhc2UgVVJMIHByZXZpZXdzXG4gICAgICAgIGlmIChzZXR0aW5nTmFtZSA9PT0gXCJ1cmxQcmV2aWV3c0VuYWJsZWRcIikge1xuICAgICAgICAgICAgY29uc3QgY29udGVudCA9IHRoaXMuZ2V0U2V0dGluZ3Mocm9vbUlkLCBcIm9yZy5tYXRyaXgucm9vbS5wcmV2aWV3X3VybHNcIikgfHwge307XG5cbiAgICAgICAgICAgIC8vIENoZWNrIHRvIG1ha2Ugc3VyZSB0aGF0IHdlIGFjdHVhbGx5IGdvdCBhIGJvb2xlYW5cbiAgICAgICAgICAgIGlmICh0eXBlb2YgKGNvbnRlbnRbJ2Rpc2FibGUnXSkgIT09IFwiYm9vbGVhblwiKSByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIHJldHVybiAhY29udGVudFsnZGlzYWJsZSddO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSB0aGlzLmdldFNldHRpbmdzKHJvb21JZCkgfHwge307XG4gICAgICAgIHJldHVybiBzZXR0aW5nc1tzZXR0aW5nTmFtZV07XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIHNldFZhbHVlKHNldHRpbmdOYW1lOiBzdHJpbmcsIHJvb21JZDogc3RyaW5nLCBuZXdWYWx1ZTogYW55KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIC8vIFNwZWNpYWwgY2FzZSBVUkwgcHJldmlld3NcbiAgICAgICAgaWYgKHNldHRpbmdOYW1lID09PSBcInVybFByZXZpZXdzRW5hYmxlZFwiKSB7XG4gICAgICAgICAgICBjb25zdCBjb250ZW50ID0gdGhpcy5nZXRTZXR0aW5ncyhyb29tSWQsIFwib3JnLm1hdHJpeC5yb29tLnByZXZpZXdfdXJsc1wiKSB8fCB7fTtcbiAgICAgICAgICAgIGNvbnRlbnRbJ2Rpc2FibGUnXSA9ICFuZXdWYWx1ZTtcbiAgICAgICAgICAgIGF3YWl0IE1hdHJpeENsaWVudFBlZy5nZXQoKS5zZW5kU3RhdGVFdmVudChyb29tSWQsIFwib3JnLm1hdHJpeC5yb29tLnByZXZpZXdfdXJsc1wiLCBjb250ZW50KTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGNvbnRlbnQgPSB0aGlzLmdldFNldHRpbmdzKHJvb21JZCkgfHwge307XG4gICAgICAgIGNvbnRlbnRbc2V0dGluZ05hbWVdID0gbmV3VmFsdWU7XG4gICAgICAgIGF3YWl0IE1hdHJpeENsaWVudFBlZy5nZXQoKS5zZW5kU3RhdGVFdmVudChyb29tSWQsIFwiaW0udmVjdG9yLndlYi5zZXR0aW5nc1wiLCBjb250ZW50LCBcIlwiKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY2FuU2V0VmFsdWUoc2V0dGluZ05hbWU6IHN0cmluZywgcm9vbUlkOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgY2xpID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuICAgICAgICBjb25zdCByb29tID0gY2xpLmdldFJvb20ocm9vbUlkKTtcblxuICAgICAgICBsZXQgZXZlbnRUeXBlID0gXCJpbS52ZWN0b3Iud2ViLnNldHRpbmdzXCI7XG4gICAgICAgIGlmIChzZXR0aW5nTmFtZSA9PT0gXCJ1cmxQcmV2aWV3c0VuYWJsZWRcIikgZXZlbnRUeXBlID0gXCJvcmcubWF0cml4LnJvb20ucHJldmlld191cmxzXCI7XG5cbiAgICAgICAgaWYgKCFyb29tKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIHJldHVybiByb29tLmN1cnJlbnRTdGF0ZS5tYXlTZW5kU3RhdGVFdmVudChldmVudFR5cGUsIGNsaS5nZXRVc2VySWQoKSk7XG4gICAgfVxuXG4gICAgcHVibGljIGlzU3VwcG9ydGVkKCk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCBjbGkgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIHJldHVybiBjbGkgIT09IHVuZGVmaW5lZCAmJiBjbGkgIT09IG51bGw7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRTZXR0aW5ncyhyb29tSWQ6IHN0cmluZywgZXZlbnRUeXBlID0gXCJpbS52ZWN0b3Iud2ViLnNldHRpbmdzXCIpOiBhbnkge1xuICAgICAgICBjb25zdCByb29tID0gTWF0cml4Q2xpZW50UGVnLmdldCgpLmdldFJvb20ocm9vbUlkKTtcbiAgICAgICAgaWYgKCFyb29tKSByZXR1cm4gbnVsbDtcblxuICAgICAgICBjb25zdCBldmVudCA9IHJvb20uY3VycmVudFN0YXRlLmdldFN0YXRlRXZlbnRzKGV2ZW50VHlwZSwgXCJcIik7XG4gICAgICAgIGlmICghZXZlbnQgfHwgIWV2ZW50LmdldENvbnRlbnQoKSkgcmV0dXJuIG51bGw7XG4gICAgICAgIHJldHVybiBvYmplY3RDbG9uZShldmVudC5nZXRDb250ZW50KCkpOyAvLyBjbG9uZSB0byBwcmV2ZW50IG11dGF0aW9uXG4gICAgfVxufVxuIl19