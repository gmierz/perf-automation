"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.showGroupAddRoomDialog = showGroupAddRoomDialog;
exports.showGroupInviteDialog = showGroupInviteDialog;

var _react = _interopRequireDefault(require("react"));

var _Modal = _interopRequireDefault(require("./Modal"));

var sdk = _interopRequireWildcard(require("./"));

var _MultiInviter = _interopRequireDefault(require("./utils/MultiInviter"));

var _languageHandler = require("./languageHandler");

var _MatrixClientPeg = require("./MatrixClientPeg");

var _GroupStore = _interopRequireDefault(require("./stores/GroupStore"));

var _StyledCheckbox = _interopRequireDefault(require("./components/views/elements/StyledCheckbox"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/*
Copyright 2017 New Vector Ltd

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
function showGroupInviteDialog(groupId) {
  return new Promise((resolve, reject) => {
    const description = /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("div", null, (0, _languageHandler._t)("Who would you like to add to this community?")), /*#__PURE__*/_react.default.createElement("div", {
      className: "warning"
    }, (0, _languageHandler._t)("Warning: any person you add to a community will be publicly " + "visible to anyone who knows the community ID")));

    const AddressPickerDialog = sdk.getComponent("dialogs.AddressPickerDialog");

    _Modal.default.createTrackedDialog('Group Invite', '', AddressPickerDialog, {
      title: (0, _languageHandler._t)("Invite new community members"),
      description: description,
      placeholder: (0, _languageHandler._t)("Name or Matrix ID"),
      button: (0, _languageHandler._t)("Invite to Community"),
      validAddressTypes: ['mx-user-id'],
      onFinished: (success, addrs) => {
        if (!success) return;

        _onGroupInviteFinished(groupId, addrs).then(resolve, reject);
      }
    },
    /*className=*/
    null,
    /*isPriority=*/
    false,
    /*isStatic=*/
    true);
  });
}

function showGroupAddRoomDialog(groupId) {
  return new Promise((resolve, reject) => {
    let addRoomsPublicly = false;

    const onCheckboxClicked = e => {
      addRoomsPublicly = e.target.checked;
    };

    const description = /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("div", null, (0, _languageHandler._t)("Which rooms would you like to add to this community?")));

    const checkboxContainer = /*#__PURE__*/_react.default.createElement(_StyledCheckbox.default, {
      className: "mx_GroupAddressPicker_checkboxContainer",
      onChange: onCheckboxClicked
    }, (0, _languageHandler._t)("Show these rooms to non-members on the community page and room list?"));

    const AddressPickerDialog = sdk.getComponent("dialogs.AddressPickerDialog");

    _Modal.default.createTrackedDialog('Add Rooms to Group', '', AddressPickerDialog, {
      title: (0, _languageHandler._t)("Add rooms to the community"),
      description: description,
      extraNode: checkboxContainer,
      placeholder: (0, _languageHandler._t)("Room name or address"),
      button: (0, _languageHandler._t)("Add to community"),
      pickerType: 'room',
      validAddressTypes: ['mx-room-id'],
      onFinished: (success, addrs) => {
        if (!success) return;

        _onGroupAddRoomFinished(groupId, addrs, addRoomsPublicly).then(resolve, reject);
      }
    },
    /*className=*/
    null,
    /*isPriority=*/
    false,
    /*isStatic=*/
    true);
  });
}

function _onGroupInviteFinished(groupId, addrs) {
  const multiInviter = new _MultiInviter.default(groupId);
  const addrTexts = addrs.map(addr => addr.address);
  return multiInviter.invite(addrTexts).then(completionStates => {
    // Show user any errors
    const errorList = [];

    for (const addr of Object.keys(completionStates)) {
      if (addrs[addr] === "error") {
        errorList.push(addr);
      }
    }

    if (errorList.length > 0) {
      const ErrorDialog = sdk.getComponent("dialogs.ErrorDialog");

      _Modal.default.createTrackedDialog('Failed to invite the following users to the group', '', ErrorDialog, {
        title: (0, _languageHandler._t)("Failed to invite the following users to %(groupId)s:", {
          groupId: groupId
        }),
        description: errorList.join(", ")
      });
    }
  }).catch(err => {
    const ErrorDialog = sdk.getComponent("dialogs.ErrorDialog");

    _Modal.default.createTrackedDialog('Failed to invite users to group', '', ErrorDialog, {
      title: (0, _languageHandler._t)("Failed to invite users to community"),
      description: (0, _languageHandler._t)("Failed to invite users to %(groupId)s", {
        groupId: groupId
      })
    });
  });
}

function _onGroupAddRoomFinished(groupId, addrs, addRoomsPublicly) {
  const matrixClient = _MatrixClientPeg.MatrixClientPeg.get();

  const errorList = [];
  return Promise.allSettled(addrs.map(addr => {
    return _GroupStore.default.addRoomToGroup(groupId, addr.address, addRoomsPublicly).catch(() => {
      errorList.push(addr.address);
    }).then(() => {
      const roomId = addr.address;
      const room = matrixClient.getRoom(roomId); // Can the user change related groups?

      if (!room || !room.currentState.mayClientSendStateEvent("m.room.related_groups", matrixClient)) {
        return;
      } // Get the related groups


      const relatedGroupsEvent = room.currentState.getStateEvents('m.room.related_groups', '');
      const groups = relatedGroupsEvent ? relatedGroupsEvent.getContent().groups || [] : []; // Add this group as related

      if (!groups.includes(groupId)) {
        groups.push(groupId);
        return _MatrixClientPeg.MatrixClientPeg.get().sendStateEvent(roomId, 'm.room.related_groups', {
          groups
        }, '');
      }
    });
  })).then(() => {
    if (errorList.length === 0) {
      return;
    }

    const ErrorDialog = sdk.getComponent("dialogs.ErrorDialog");

    _Modal.default.createTrackedDialog('Failed to add the following room to the group', '', ErrorDialog, {
      title: (0, _languageHandler._t)("Failed to add the following rooms to %(groupId)s:", {
        groupId
      }),
      description: errorList.join(", ")
    });
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Hcm91cEFkZHJlc3NQaWNrZXIuanMiXSwibmFtZXMiOlsic2hvd0dyb3VwSW52aXRlRGlhbG9nIiwiZ3JvdXBJZCIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZGVzY3JpcHRpb24iLCJBZGRyZXNzUGlja2VyRGlhbG9nIiwic2RrIiwiZ2V0Q29tcG9uZW50IiwiTW9kYWwiLCJjcmVhdGVUcmFja2VkRGlhbG9nIiwidGl0bGUiLCJwbGFjZWhvbGRlciIsImJ1dHRvbiIsInZhbGlkQWRkcmVzc1R5cGVzIiwib25GaW5pc2hlZCIsInN1Y2Nlc3MiLCJhZGRycyIsIl9vbkdyb3VwSW52aXRlRmluaXNoZWQiLCJ0aGVuIiwic2hvd0dyb3VwQWRkUm9vbURpYWxvZyIsImFkZFJvb21zUHVibGljbHkiLCJvbkNoZWNrYm94Q2xpY2tlZCIsImUiLCJ0YXJnZXQiLCJjaGVja2VkIiwiY2hlY2tib3hDb250YWluZXIiLCJleHRyYU5vZGUiLCJwaWNrZXJUeXBlIiwiX29uR3JvdXBBZGRSb29tRmluaXNoZWQiLCJtdWx0aUludml0ZXIiLCJNdWx0aUludml0ZXIiLCJhZGRyVGV4dHMiLCJtYXAiLCJhZGRyIiwiYWRkcmVzcyIsImludml0ZSIsImNvbXBsZXRpb25TdGF0ZXMiLCJlcnJvckxpc3QiLCJPYmplY3QiLCJrZXlzIiwicHVzaCIsImxlbmd0aCIsIkVycm9yRGlhbG9nIiwiam9pbiIsImNhdGNoIiwiZXJyIiwibWF0cml4Q2xpZW50IiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0IiwiYWxsU2V0dGxlZCIsIkdyb3VwU3RvcmUiLCJhZGRSb29tVG9Hcm91cCIsInJvb21JZCIsInJvb20iLCJnZXRSb29tIiwiY3VycmVudFN0YXRlIiwibWF5Q2xpZW50U2VuZFN0YXRlRXZlbnQiLCJyZWxhdGVkR3JvdXBzRXZlbnQiLCJnZXRTdGF0ZUV2ZW50cyIsImdyb3VwcyIsImdldENvbnRlbnQiLCJpbmNsdWRlcyIsInNlbmRTdGF0ZUV2ZW50Il0sIm1h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QXRDTSxDQUFQO0FBdUNIIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE3IE5ldyBWZWN0b3IgTHRkXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCBNb2RhbCBmcm9tICcuL01vZGFsJztcbmltcG9ydCAqIGFzIHNkayBmcm9tICcuLyc7XG5pbXBvcnQgTXVsdGlJbnZpdGVyIGZyb20gJy4vdXRpbHMvTXVsdGlJbnZpdGVyJztcbmltcG9ydCB7IF90IH0gZnJvbSAnLi9sYW5ndWFnZUhhbmRsZXInO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSAnLi9NYXRyaXhDbGllbnRQZWcnO1xuaW1wb3J0IEdyb3VwU3RvcmUgZnJvbSAnLi9zdG9yZXMvR3JvdXBTdG9yZSc7XG5pbXBvcnQgU3R5bGVkQ2hlY2tib3ggZnJvbSAnLi9jb21wb25lbnRzL3ZpZXdzL2VsZW1lbnRzL1N0eWxlZENoZWNrYm94JztcblxuZXhwb3J0IGZ1bmN0aW9uIHNob3dHcm91cEludml0ZURpYWxvZyhncm91cElkKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgY29uc3QgZGVzY3JpcHRpb24gPSA8ZGl2PlxuICAgICAgICAgICAgPGRpdj57IF90KFwiV2hvIHdvdWxkIHlvdSBsaWtlIHRvIGFkZCB0byB0aGlzIGNvbW11bml0eT9cIikgfTwvZGl2PlxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJ3YXJuaW5nXCI+XG4gICAgICAgICAgICAgICAgeyBfdChcbiAgICAgICAgICAgICAgICAgICAgXCJXYXJuaW5nOiBhbnkgcGVyc29uIHlvdSBhZGQgdG8gYSBjb21tdW5pdHkgd2lsbCBiZSBwdWJsaWNseSBcIitcbiAgICAgICAgICAgICAgICAgICAgXCJ2aXNpYmxlIHRvIGFueW9uZSB3aG8ga25vd3MgdGhlIGNvbW11bml0eSBJRFwiLFxuICAgICAgICAgICAgICAgICkgfVxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgIDwvZGl2PjtcblxuICAgICAgICBjb25zdCBBZGRyZXNzUGlja2VyRGlhbG9nID0gc2RrLmdldENvbXBvbmVudChcImRpYWxvZ3MuQWRkcmVzc1BpY2tlckRpYWxvZ1wiKTtcbiAgICAgICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZygnR3JvdXAgSW52aXRlJywgJycsIEFkZHJlc3NQaWNrZXJEaWFsb2csIHtcbiAgICAgICAgICAgIHRpdGxlOiBfdChcIkludml0ZSBuZXcgY29tbXVuaXR5IG1lbWJlcnNcIiksXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogZGVzY3JpcHRpb24sXG4gICAgICAgICAgICBwbGFjZWhvbGRlcjogX3QoXCJOYW1lIG9yIE1hdHJpeCBJRFwiKSxcbiAgICAgICAgICAgIGJ1dHRvbjogX3QoXCJJbnZpdGUgdG8gQ29tbXVuaXR5XCIpLFxuICAgICAgICAgICAgdmFsaWRBZGRyZXNzVHlwZXM6IFsnbXgtdXNlci1pZCddLFxuICAgICAgICAgICAgb25GaW5pc2hlZDogKHN1Y2Nlc3MsIGFkZHJzKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFzdWNjZXNzKSByZXR1cm47XG5cbiAgICAgICAgICAgICAgICBfb25Hcm91cEludml0ZUZpbmlzaGVkKGdyb3VwSWQsIGFkZHJzKS50aGVuKHJlc29sdmUsIHJlamVjdCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9LCAvKmNsYXNzTmFtZT0qL251bGwsIC8qaXNQcmlvcml0eT0qL2ZhbHNlLCAvKmlzU3RhdGljPSovdHJ1ZSk7XG4gICAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzaG93R3JvdXBBZGRSb29tRGlhbG9nKGdyb3VwSWQpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBsZXQgYWRkUm9vbXNQdWJsaWNseSA9IGZhbHNlO1xuICAgICAgICBjb25zdCBvbkNoZWNrYm94Q2xpY2tlZCA9IChlKSA9PiB7XG4gICAgICAgICAgICBhZGRSb29tc1B1YmxpY2x5ID0gZS50YXJnZXQuY2hlY2tlZDtcbiAgICAgICAgfTtcbiAgICAgICAgY29uc3QgZGVzY3JpcHRpb24gPSA8ZGl2PlxuICAgICAgICAgICAgPGRpdj57IF90KFwiV2hpY2ggcm9vbXMgd291bGQgeW91IGxpa2UgdG8gYWRkIHRvIHRoaXMgY29tbXVuaXR5P1wiKSB9PC9kaXY+XG4gICAgICAgIDwvZGl2PjtcblxuICAgICAgICBjb25zdCBjaGVja2JveENvbnRhaW5lciA9IDxTdHlsZWRDaGVja2JveFxuICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfR3JvdXBBZGRyZXNzUGlja2VyX2NoZWNrYm94Q29udGFpbmVyXCJcbiAgICAgICAgICAgIG9uQ2hhbmdlPXtvbkNoZWNrYm94Q2xpY2tlZH1cbiAgICAgICAgPlxuICAgICAgICAgICAgeyBfdChcIlNob3cgdGhlc2Ugcm9vbXMgdG8gbm9uLW1lbWJlcnMgb24gdGhlIGNvbW11bml0eSBwYWdlIGFuZCByb29tIGxpc3Q/XCIpIH1cbiAgICAgICAgPC9TdHlsZWRDaGVja2JveD47XG5cbiAgICAgICAgY29uc3QgQWRkcmVzc1BpY2tlckRpYWxvZyA9IHNkay5nZXRDb21wb25lbnQoXCJkaWFsb2dzLkFkZHJlc3NQaWNrZXJEaWFsb2dcIik7XG4gICAgICAgIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coJ0FkZCBSb29tcyB0byBHcm91cCcsICcnLCBBZGRyZXNzUGlja2VyRGlhbG9nLCB7XG4gICAgICAgICAgICB0aXRsZTogX3QoXCJBZGQgcm9vbXMgdG8gdGhlIGNvbW11bml0eVwiKSxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBkZXNjcmlwdGlvbixcbiAgICAgICAgICAgIGV4dHJhTm9kZTogY2hlY2tib3hDb250YWluZXIsXG4gICAgICAgICAgICBwbGFjZWhvbGRlcjogX3QoXCJSb29tIG5hbWUgb3IgYWRkcmVzc1wiKSxcbiAgICAgICAgICAgIGJ1dHRvbjogX3QoXCJBZGQgdG8gY29tbXVuaXR5XCIpLFxuICAgICAgICAgICAgcGlja2VyVHlwZTogJ3Jvb20nLFxuICAgICAgICAgICAgdmFsaWRBZGRyZXNzVHlwZXM6IFsnbXgtcm9vbS1pZCddLFxuICAgICAgICAgICAgb25GaW5pc2hlZDogKHN1Y2Nlc3MsIGFkZHJzKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFzdWNjZXNzKSByZXR1cm47XG5cbiAgICAgICAgICAgICAgICBfb25Hcm91cEFkZFJvb21GaW5pc2hlZChncm91cElkLCBhZGRycywgYWRkUm9vbXNQdWJsaWNseSkudGhlbihyZXNvbHZlLCByZWplY3QpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgfSwgLypjbGFzc05hbWU9Ki9udWxsLCAvKmlzUHJpb3JpdHk9Ki9mYWxzZSwgLyppc1N0YXRpYz0qL3RydWUpO1xuICAgIH0pO1xufVxuXG5mdW5jdGlvbiBfb25Hcm91cEludml0ZUZpbmlzaGVkKGdyb3VwSWQsIGFkZHJzKSB7XG4gICAgY29uc3QgbXVsdGlJbnZpdGVyID0gbmV3IE11bHRpSW52aXRlcihncm91cElkKTtcblxuICAgIGNvbnN0IGFkZHJUZXh0cyA9IGFkZHJzLm1hcCgoYWRkcikgPT4gYWRkci5hZGRyZXNzKTtcblxuICAgIHJldHVybiBtdWx0aUludml0ZXIuaW52aXRlKGFkZHJUZXh0cykudGhlbigoY29tcGxldGlvblN0YXRlcykgPT4ge1xuICAgICAgICAvLyBTaG93IHVzZXIgYW55IGVycm9yc1xuICAgICAgICBjb25zdCBlcnJvckxpc3QgPSBbXTtcbiAgICAgICAgZm9yIChjb25zdCBhZGRyIG9mIE9iamVjdC5rZXlzKGNvbXBsZXRpb25TdGF0ZXMpKSB7XG4gICAgICAgICAgICBpZiAoYWRkcnNbYWRkcl0gPT09IFwiZXJyb3JcIikge1xuICAgICAgICAgICAgICAgIGVycm9yTGlzdC5wdXNoKGFkZHIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGVycm9yTGlzdC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjb25zdCBFcnJvckRpYWxvZyA9IHNkay5nZXRDb21wb25lbnQoXCJkaWFsb2dzLkVycm9yRGlhbG9nXCIpO1xuICAgICAgICAgICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZygnRmFpbGVkIHRvIGludml0ZSB0aGUgZm9sbG93aW5nIHVzZXJzIHRvIHRoZSBncm91cCcsICcnLCBFcnJvckRpYWxvZywge1xuICAgICAgICAgICAgICAgIHRpdGxlOiBfdChcIkZhaWxlZCB0byBpbnZpdGUgdGhlIGZvbGxvd2luZyB1c2VycyB0byAlKGdyb3VwSWQpczpcIiwgeyBncm91cElkOiBncm91cElkIH0pLFxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBlcnJvckxpc3Quam9pbihcIiwgXCIpLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgIGNvbnN0IEVycm9yRGlhbG9nID0gc2RrLmdldENvbXBvbmVudChcImRpYWxvZ3MuRXJyb3JEaWFsb2dcIik7XG4gICAgICAgIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coJ0ZhaWxlZCB0byBpbnZpdGUgdXNlcnMgdG8gZ3JvdXAnLCAnJywgRXJyb3JEaWFsb2csIHtcbiAgICAgICAgICAgIHRpdGxlOiBfdChcIkZhaWxlZCB0byBpbnZpdGUgdXNlcnMgdG8gY29tbXVuaXR5XCIpLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246IF90KFwiRmFpbGVkIHRvIGludml0ZSB1c2VycyB0byAlKGdyb3VwSWQpc1wiLCB7IGdyb3VwSWQ6IGdyb3VwSWQgfSksXG4gICAgICAgIH0pO1xuICAgIH0pO1xufVxuXG5mdW5jdGlvbiBfb25Hcm91cEFkZFJvb21GaW5pc2hlZChncm91cElkLCBhZGRycywgYWRkUm9vbXNQdWJsaWNseSkge1xuICAgIGNvbnN0IG1hdHJpeENsaWVudCA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICBjb25zdCBlcnJvckxpc3QgPSBbXTtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGxTZXR0bGVkKGFkZHJzLm1hcCgoYWRkcikgPT4ge1xuICAgICAgICByZXR1cm4gR3JvdXBTdG9yZVxuICAgICAgICAgICAgLmFkZFJvb21Ub0dyb3VwKGdyb3VwSWQsIGFkZHIuYWRkcmVzcywgYWRkUm9vbXNQdWJsaWNseSlcbiAgICAgICAgICAgIC5jYXRjaCgoKSA9PiB7IGVycm9yTGlzdC5wdXNoKGFkZHIuYWRkcmVzcyk7IH0pXG4gICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3Qgcm9vbUlkID0gYWRkci5hZGRyZXNzO1xuICAgICAgICAgICAgICAgIGNvbnN0IHJvb20gPSBtYXRyaXhDbGllbnQuZ2V0Um9vbShyb29tSWQpO1xuICAgICAgICAgICAgICAgIC8vIENhbiB0aGUgdXNlciBjaGFuZ2UgcmVsYXRlZCBncm91cHM/XG4gICAgICAgICAgICAgICAgaWYgKCFyb29tIHx8ICFyb29tLmN1cnJlbnRTdGF0ZS5tYXlDbGllbnRTZW5kU3RhdGVFdmVudChcIm0ucm9vbS5yZWxhdGVkX2dyb3Vwc1wiLCBtYXRyaXhDbGllbnQpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gR2V0IHRoZSByZWxhdGVkIGdyb3Vwc1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlbGF0ZWRHcm91cHNFdmVudCA9IHJvb20uY3VycmVudFN0YXRlLmdldFN0YXRlRXZlbnRzKCdtLnJvb20ucmVsYXRlZF9ncm91cHMnLCAnJyk7XG4gICAgICAgICAgICAgICAgY29uc3QgZ3JvdXBzID0gcmVsYXRlZEdyb3Vwc0V2ZW50ID8gcmVsYXRlZEdyb3Vwc0V2ZW50LmdldENvbnRlbnQoKS5ncm91cHMgfHwgW10gOiBbXTtcblxuICAgICAgICAgICAgICAgIC8vIEFkZCB0aGlzIGdyb3VwIGFzIHJlbGF0ZWRcbiAgICAgICAgICAgICAgICBpZiAoIWdyb3Vwcy5pbmNsdWRlcyhncm91cElkKSkge1xuICAgICAgICAgICAgICAgICAgICBncm91cHMucHVzaChncm91cElkKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE1hdHJpeENsaWVudFBlZy5nZXQoKS5zZW5kU3RhdGVFdmVudChyb29tSWQsICdtLnJvb20ucmVsYXRlZF9ncm91cHMnLCB7IGdyb3VwcyB9LCAnJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgfSkpLnRoZW4oKCkgPT4ge1xuICAgICAgICBpZiAoZXJyb3JMaXN0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IEVycm9yRGlhbG9nID0gc2RrLmdldENvbXBvbmVudChcImRpYWxvZ3MuRXJyb3JEaWFsb2dcIik7XG4gICAgICAgIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coXG4gICAgICAgICAgICAnRmFpbGVkIHRvIGFkZCB0aGUgZm9sbG93aW5nIHJvb20gdG8gdGhlIGdyb3VwJyxcbiAgICAgICAgICAgICcnLFxuICAgICAgICAgICAgRXJyb3JEaWFsb2csXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgdGl0bGU6IF90KFxuICAgICAgICAgICAgICAgICAgICBcIkZhaWxlZCB0byBhZGQgdGhlIGZvbGxvd2luZyByb29tcyB0byAlKGdyb3VwSWQpczpcIixcbiAgICAgICAgICAgICAgICAgICAgeyBncm91cElkIH0sXG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogZXJyb3JMaXN0LmpvaW4oXCIsIFwiKSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICk7XG4gICAgfSk7XG59XG4iXX0=