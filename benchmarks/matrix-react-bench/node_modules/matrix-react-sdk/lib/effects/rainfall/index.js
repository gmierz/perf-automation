"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.DefaultOptions = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _arrays = require("../../utils/arrays");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

const DefaultOptions = {
  maxCount: 600,
  speed: 12
};
exports.DefaultOptions = DefaultOptions;
const KEY_FRAME_INTERVAL = 15;

class Rainfall {
  constructor(options) {
    (0, _defineProperty2.default)(this, "options", void 0);
    (0, _defineProperty2.default)(this, "context", null);
    (0, _defineProperty2.default)(this, "particles", []);
    (0, _defineProperty2.default)(this, "lastAnimationTime", void 0);
    (0, _defineProperty2.default)(this, "isRunning", void 0);
    (0, _defineProperty2.default)(this, "start", async (canvas, timeout = 3000) => {
      if (!canvas) {
        return;
      }

      this.context = canvas.getContext('2d');
      this.particles = [];
      const count = this.options.maxCount;

      while (this.particles.length < count) {
        this.particles.push(this.resetParticle({}, canvas.width, canvas.height));
      }

      this.isRunning = true;
      requestAnimationFrame(this.renderLoop);

      if (timeout) {
        window.setTimeout(this.stop, timeout);
      }
    });
    (0, _defineProperty2.default)(this, "stop", async () => {
      this.isRunning = false;
    });
    (0, _defineProperty2.default)(this, "resetParticle", (particle, width, height) => {
      particle.x = Math.random() * width;
      particle.y = Math.random() * -height;
      particle.width = Math.random() * 1.5;
      particle.height = particle.width * 15 + 4;
      particle.speed = Math.random() * this.options.speed * 4 / 5 + this.options.speed;
      return particle;
    });
    (0, _defineProperty2.default)(this, "renderLoop", () => {
      if (!this.context || !this.context.canvas) {
        return;
      }

      if (this.particles.length === 0) {
        this.context.clearRect(0, 0, this.context.canvas.width, this.context.canvas.height);
      } else {
        const timeDelta = Date.now() - this.lastAnimationTime;

        if (timeDelta >= KEY_FRAME_INTERVAL || !this.lastAnimationTime) {
          // Clear the screen first
          this.context.clearRect(0, 0, this.context.canvas.width, this.context.canvas.height);
          this.lastAnimationTime = Date.now();
          this.animateAndRenderRaindrops();
        }

        requestAnimationFrame(this.renderLoop);
      }
    });
    (0, _defineProperty2.default)(this, "animateAndRenderRaindrops", () => {
      if (!this.context || !this.context.canvas) {
        return;
      }

      const height = this.context.canvas.height;

      for (const particle of (0, _arrays.arrayFastClone)(this.particles)) {
        particle.y += particle.speed;
        this.context.save();
        this.context.beginPath();
        this.context.rect(particle.x, particle.y, particle.width, particle.height);
        this.context.fillStyle = '#5dadec'; // light blue

        this.context.fill();
        this.context.closePath();
        this.context.restore(); // Remove dead raindrops

        const maxBounds = height * 2;

        if (particle.y > height + maxBounds) {
          const idx = this.particles.indexOf(particle);
          this.particles.splice(idx, 1);
        }
      }
    });
    this.options = _objectSpread(_objectSpread({}, DefaultOptions), options);
  }

}

exports.default = Rainfall;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9lZmZlY3RzL3JhaW5mYWxsL2luZGV4LnRzIl0sIm5hbWVzIjpbIkRlZmF1bHRPcHRpb25zIiwibWF4Q291bnQiLCJzcGVlZCIsIktFWV9GUkFNRV9JTlRFUlZBTCIsIlJhaW5mYWxsIiwiY29uc3RydWN0b3IiLCJvcHRpb25zIiwiY2FudmFzIiwidGltZW91dCIsImNvbnRleHQiLCJnZXRDb250ZXh0IiwicGFydGljbGVzIiwiY291bnQiLCJsZW5ndGgiLCJwdXNoIiwicmVzZXRQYXJ0aWNsZSIsIndpZHRoIiwiaGVpZ2h0IiwiaXNSdW5uaW5nIiwicmVxdWVzdEFuaW1hdGlvbkZyYW1lIiwicmVuZGVyTG9vcCIsIndpbmRvdyIsInNldFRpbWVvdXQiLCJzdG9wIiwicGFydGljbGUiLCJ4IiwiTWF0aCIsInJhbmRvbSIsInkiLCJjbGVhclJlY3QiLCJ0aW1lRGVsdGEiLCJEYXRlIiwibm93IiwibGFzdEFuaW1hdGlvblRpbWUiLCJhbmltYXRlQW5kUmVuZGVyUmFpbmRyb3BzIiwic2F2ZSIsImJlZ2luUGF0aCIsInJlY3QiLCJmaWxsU3R5bGUiLCJmaWxsIiwiY2xvc2VQYXRoIiwicmVzdG9yZSIsIm1heEJvdW5kcyIsImlkeCIsImluZGV4T2YiLCJzcGxpY2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBaUJBOzs7Ozs7QUFxQk8sTUFBTUEsY0FBK0IsR0FBRztBQUMzQ0MsRUFBQUEsUUFBUSxFQUFFLEdBRGlDO0FBRTNDQyxFQUFBQSxLQUFLLEVBQUU7QUFGb0MsQ0FBeEM7O0FBS1AsTUFBTUMsa0JBQWtCLEdBQUcsRUFBM0I7O0FBRWUsTUFBTUMsUUFBTixDQUF3QztBQUduREMsRUFBQUEsV0FBVyxDQUFDQyxPQUFELEVBQWtDO0FBQUE7QUFBQSxtREFJTSxJQUpOO0FBQUEscURBS1IsRUFMUTtBQUFBO0FBQUE7QUFBQSxpREFVOUIsT0FBT0MsTUFBUCxFQUFrQ0MsT0FBTyxHQUFHLElBQTVDLEtBQXFEO0FBQ2hFLFVBQUks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bkMsRUFBMkM7QUFDdkM7QUFDSDs7QUFDRCxZQUFNVSxNQUFNLEdBQUcsS0FBS1IsT0FBTCxDQUFhRixNQUFiLENBQW9CVSxNQUFuQzs7QUFDQSxXQUFLLE1BQU1PLFFBQVgsSUFBdUIsNEJBQWUsS0FBS2IsU0FBcEIsQ0FBdkIsRUFBdUQ7QUFDbkRhLFFBQUFBLFFBQVEsQ0FBQ0ksQ0FBVCxJQUFjSixRQUFRLENBQUN0QixLQUF2QjtBQUVBLGFBQUtPLE9BQUwsQ0FBYTBCLElBQWI7QUFDQSxhQUFLMUIsT0FBTCxDQUFhMkIsU0FBYjtBQUNBLGFBQUszQixPQUFMLENBQWE0QixJQUFiLENBQWtCYixRQUFRLENBQUNDLENBQTNCLEVBQThCRCxRQUFRLENBQUNJLENBQXZDLEVBQTBDSixRQUFRLENBQUNSLEtBQW5ELEVBQTBEUSxRQUFRLENBQUNQLE1BQW5FO0FBQ0EsYUFBS1IsT0FBTCxDQUFhNkIsU0FBYixHQUF5QixTQUF6QixDQU5tRCxDQU1mOztBQUNwQyxhQUFLN0IsT0FBTCxDQUFhOEIsSUFBYjtBQUNBLGFBQUs5QixPQUFMLENBQWErQixTQUFiO0FBQ0EsYUFBSy9CLE9BQUwsQ0FBYWdDLE9BQWIsR0FUbUQsQ0FXbkQ7O0FBQ0EsY0FBTUMsU0FBUyxHQUFHekIsTUFBTSxHQUFHLENBQTNCOztBQUNBLFlBQUlPLFFBQVEsQ0FBQ0ksQ0FBVCxHQUFjWCxNQUFNLEdBQUd5QixTQUEzQixFQUF1QztBQUNuQyxnQkFBTUMsR0FBRyxHQUFHLEtBQUtoQyxTQUFMLENBQWVpQyxPQUFmLENBQXVCcEIsUUFBdkIsQ0FBWjtBQUNBLGVBQUtiLFNBQUwsQ0FBZWtDLE1BQWYsQ0FBc0JGLEdBQXRCLEVBQTJCLENBQTNCO0FBQ0g7QUFDSjtBQUNKLEtBakY0QztBQUN6QyxTQUFLckMsT0FBTCxtQ0FBb0JOLGNBQXBCLEdBQXVDTSxPQUF2QztBQUNIOztBQUxrRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gQ29weXJpZ2h0IDIwMjAgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cbiBDb3B5cmlnaHQgMjAyMSBKb3NpYXMgQWxsZXN0YWRcblxuIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4geW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cbiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuaW1wb3J0IElDYW52YXNFZmZlY3QgZnJvbSAnLi4vSUNhbnZhc0VmZmVjdCc7XG5pbXBvcnQgeyBhcnJheUZhc3RDbG9uZSB9IGZyb20gXCIuLi8uLi91dGlscy9hcnJheXNcIjtcblxuZXhwb3J0IHR5cGUgUmFpbmZhbGxPcHRpb25zID0ge1xuICAgIC8qKlxuICAgICAqIFRoZSBtYXhpbXVtIG51bWJlciBvZiByYWluZHJvcHMgdG8gcmVuZGVyIGF0IGEgZ2l2ZW4gdGltZVxuICAgICAqL1xuICAgIG1heENvdW50OiBudW1iZXI7XG4gICAgLyoqXG4gICAgICogVGhlIHNwZWVkIG9mIHRoZSByYWluZHJvcHNcbiAgICAgKi9cbiAgICBzcGVlZDogbnVtYmVyO1xufTtcblxudHlwZSBSYWluZHJvcCA9IHtcbiAgICB4OiBudW1iZXI7XG4gICAgeTogbnVtYmVyO1xuICAgIGhlaWdodDogbnVtYmVyO1xuICAgIHdpZHRoOiBudW1iZXI7XG4gICAgc3BlZWQ6IG51bWJlcjtcbn07XG5cbmV4cG9ydCBjb25zdCBEZWZhdWx0T3B0aW9uczogUmFpbmZhbGxPcHRpb25zID0ge1xuICAgIG1heENvdW50OiA2MDAsXG4gICAgc3BlZWQ6IDEyLFxufTtcblxuY29uc3QgS0VZX0ZSQU1FX0lOVEVSVkFMID0gMTU7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJhaW5mYWxsIGltcGxlbWVudHMgSUNhbnZhc0VmZmVjdCB7XG4gICAgcHJpdmF0ZSByZWFkb25seSBvcHRpb25zOiBSYWluZmFsbE9wdGlvbnM7XG5cbiAgICBjb25zdHJ1Y3RvcihvcHRpb25zOiB7IFtrZXk6IHN0cmluZ106IGFueSB9KSB7XG4gICAgICAgIHRoaXMub3B0aW9ucyA9IHsgLi4uRGVmYXVsdE9wdGlvbnMsIC4uLm9wdGlvbnMgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNvbnRleHQ6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCB8IG51bGwgPSBudWxsO1xuICAgIHByaXZhdGUgcGFydGljbGVzOiBBcnJheTxSYWluZHJvcD4gPSBbXTtcbiAgICBwcml2YXRlIGxhc3RBbmltYXRpb25UaW1lOiBudW1iZXI7XG5cbiAgICBwdWJsaWMgaXNSdW5uaW5nOiBib29sZWFuO1xuXG4gICAgcHVibGljIHN0YXJ0ID0gYXN5bmMgKGNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQsIHRpbWVvdXQgPSAzMDAwKSA9PiB7XG4gICAgICAgIGlmICghY2FudmFzKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jb250ZXh0ID0gY2FudmFzLmdldENvbnRleHQoJzJkJyk7XG4gICAgICAgIHRoaXMucGFydGljbGVzID0gW107XG4gICAgICAgIGNvbnN0IGNvdW50ID0gdGhpcy5vcHRpb25zLm1heENvdW50O1xuICAgICAgICB3aGlsZSAodGhpcy5wYXJ0aWNsZXMubGVuZ3RoIDwgY291bnQpIHtcbiAgICAgICAgICAgIHRoaXMucGFydGljbGVzLnB1c2godGhpcy5yZXNldFBhcnRpY2xlKHt9IGFzIFJhaW5kcm9wLCBjYW52YXMud2lkdGgsIGNhbnZhcy5oZWlnaHQpKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmlzUnVubmluZyA9IHRydWU7XG4gICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSh0aGlzLnJlbmRlckxvb3ApO1xuICAgICAgICBpZiAodGltZW91dCkge1xuICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQodGhpcy5zdG9wLCB0aW1lb3V0KTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwdWJsaWMgc3RvcCA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgdGhpcy5pc1J1bm5pbmcgPSBmYWxzZTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSByZXNldFBhcnRpY2xlID0gKHBhcnRpY2xlOiBSYWluZHJvcCwgd2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIpOiBSYWluZHJvcCA9PiB7XG4gICAgICAgIHBhcnRpY2xlLnggPSBNYXRoLnJhbmRvbSgpICogd2lkdGg7XG4gICAgICAgIHBhcnRpY2xlLnkgPSBNYXRoLnJhbmRvbSgpICogLWhlaWdodDtcbiAgICAgICAgcGFydGljbGUud2lkdGggPSBNYXRoLnJhbmRvbSgpICogMS41O1xuICAgICAgICBwYXJ0aWNsZS5oZWlnaHQgPSAocGFydGljbGUud2lkdGggKiAxNSkgKyA0O1xuICAgICAgICBwYXJ0aWNsZS5zcGVlZCA9IChNYXRoLnJhbmRvbSgpICogdGhpcy5vcHRpb25zLnNwZWVkICogNC81KSArIHRoaXMub3B0aW9ucy5zcGVlZDtcbiAgICAgICAgcmV0dXJuIHBhcnRpY2xlO1xuICAgIH07XG5cbiAgICBwcml2YXRlIHJlbmRlckxvb3AgPSAoKTogdm9pZCA9PiB7XG4gICAgICAgIGlmICghdGhpcy5jb250ZXh0IHx8ICF0aGlzLmNvbnRleHQuY2FudmFzKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMucGFydGljbGVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgdGhpcy5jb250ZXh0LmNsZWFyUmVjdCgwLCAwLCB0aGlzLmNvbnRleHQuY2FudmFzLndpZHRoLCB0aGlzLmNvbnRleHQuY2FudmFzLmhlaWdodCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCB0aW1lRGVsdGEgPSBEYXRlLm5vdygpIC0gdGhpcy5sYXN0QW5pbWF0aW9uVGltZTtcbiAgICAgICAgICAgIGlmICh0aW1lRGVsdGEgPj0gS0VZX0ZSQU1FX0lOVEVSVkFMIHx8ICF0aGlzLmxhc3RBbmltYXRpb25UaW1lKSB7XG4gICAgICAgICAgICAgICAgLy8gQ2xlYXIgdGhlIHNjcmVlbiBmaXJzdFxuICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5jbGVhclJlY3QoMCwgMCwgdGhpcy5jb250ZXh0LmNhbnZhcy53aWR0aCwgdGhpcy5jb250ZXh0LmNhbnZhcy5oZWlnaHQpO1xuICAgICAgICAgICAgICAgIHRoaXMubGFzdEFuaW1hdGlvblRpbWUgPSBEYXRlLm5vdygpO1xuICAgICAgICAgICAgICAgIHRoaXMuYW5pbWF0ZUFuZFJlbmRlclJhaW5kcm9wcygpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRoaXMucmVuZGVyTG9vcCk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBhbmltYXRlQW5kUmVuZGVyUmFpbmRyb3BzID0gKCk6IHZvaWQgPT4ge1xuICAgICAgICBpZiAoIXRoaXMuY29udGV4dCB8fCAhdGhpcy5jb250ZXh0LmNhbnZhcykge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGhlaWdodCA9IHRoaXMuY29udGV4dC5jYW52YXMuaGVpZ2h0O1xuICAgICAgICBmb3IgKGNvbnN0IHBhcnRpY2xlIG9mIGFycmF5RmFzdENsb25lKHRoaXMucGFydGljbGVzKSkge1xuICAgICAgICAgICAgcGFydGljbGUueSArPSBwYXJ0aWNsZS5zcGVlZDtcblxuICAgICAgICAgICAgdGhpcy5jb250ZXh0LnNhdmUoKTtcbiAgICAgICAgICAgIHRoaXMuY29udGV4dC5iZWdpblBhdGgoKTtcbiAgICAgICAgICAgIHRoaXMuY29udGV4dC5yZWN0KHBhcnRpY2xlLngsIHBhcnRpY2xlLnksIHBhcnRpY2xlLndpZHRoLCBwYXJ0aWNsZS5oZWlnaHQpO1xuICAgICAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxTdHlsZSA9ICcjNWRhZGVjJzsgLy8gbGlnaHQgYmx1ZVxuICAgICAgICAgICAgdGhpcy5jb250ZXh0LmZpbGwoKTtcbiAgICAgICAgICAgIHRoaXMuY29udGV4dC5jbG9zZVBhdGgoKTtcbiAgICAgICAgICAgIHRoaXMuY29udGV4dC5yZXN0b3JlKCk7XG5cbiAgICAgICAgICAgIC8vIFJlbW92ZSBkZWFkIHJhaW5kcm9wc1xuICAgICAgICAgICAgY29uc3QgbWF4Qm91bmRzID0gaGVpZ2h0ICogMjtcbiAgICAgICAgICAgIGlmIChwYXJ0aWNsZS55ID4gKGhlaWdodCArIG1heEJvdW5kcykpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBpZHggPSB0aGlzLnBhcnRpY2xlcy5pbmRleE9mKHBhcnRpY2xlKTtcbiAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlcy5zcGxpY2UoaWR4LCAxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG59XG4iXX0=