"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.initSentry = initSentry;
exports.sendSentryReport = sendSentryReport;
exports.setSentryUser = setSentryUser;

var Sentry = _interopRequireWildcard(require("@sentry/browser"));

var _SdkConfig = _interopRequireDefault(require("./SdkConfig"));

var _MatrixClientPeg = require("./MatrixClientPeg");

var _SettingsStore = _interopRequireDefault(require("./settings/SettingsStore"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/*
Copyright 2021 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

/* eslint-enable camelcase */
async function getStorageContext() {
  const result = {}; // add storage persistence/quota information

  if (navigator.storage && navigator.storage.persisted) {
    try {
      result["storageManager_persisted"] = String(await navigator.storage.persisted());
    } catch (e) {}
  } else if (document.hasStorageAccess) {
    // Safari
    try {
      result["storageManager_persisted"] = String(await document.hasStorageAccess());
    } catch (e) {}
  }

  if (navigator.storage && navigator.storage.estimate) {
    try {
      const estimate = await navigator.storage.estimate();
      result["storageManager_quota"] = String(estimate.quota);
      result["storageManager_usage"] = String(estimate.usage);

      if (estimate.usageDetails) {
        const usageDetails = [];
        Object.keys(estimate.usageDetails).forEach(k => {
          usageDetails.push(`${k}: ${String(estimate.usageDetails[k])}`);
        });
        result[`storageManager_usage`] = usageDetails.join(", ");
      }
    } catch (e) {}
  }

  return result;
}

function getUserContext(client) {
  return {
    "username": client.credentials.userId,
    "enabled_labs": getEnabledLabs(),
    "low_bandwidth": _SettingsStore.default.getValue("lowBandwidth") ? "enabled" : "disabled"
  };
}

function getEnabledLabs() {
  const enabledLabs = _SettingsStore.default.getFeatureSettingNames().filter(f => _SettingsStore.default.getValue(f));

  if (enabledLabs.length) {
    return enabledLabs.join(", ");
  }

  return "";
}

async function getCryptoContext(client) {
  if (!client.isCryptoEnabled()) {
    return {};
  }

  const keys = [`ed25519:${client.getDeviceEd25519Key()}`];

  if (client.getDeviceCurve25519Key) {
    keys.push(`curve25519:${client.getDeviceCurve25519Key()}`);
  }

  const crossSigning = client.crypto.crossSigningInfo;
  const secretStorage = client.crypto.secretStorage;
  const pkCache = client.getCrossSigningCacheCallbacks();
  const sessionBackupKeyFromCache = await client.crypto.getSessionBackupPrivateKey();
  return {
    "device_keys": keys.join(', '),
    "cross_signing_ready": String(await client.isCrossSigningReady()),
    "cross_signing_supported_by_hs": String(await client.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing")),
    "cross_signing_key": crossSigning.getId(),
    "cross_signing_privkey_in_secret_storage": String(!!(await crossSigning.isStoredInSecretStorage(secretStorage))),
    "cross_signing_master_privkey_cached": String(!!(pkCache && (await pkCache.getCrossSigningKeyCache("master")))),
    "cross_signing_user_signing_privkey_cached": String(!!(pkCache && (await pkCache.getCrossSigningKeyCache("user_signing")))),
    "secret_storage_ready": String(await client.isSecretStorageReady()),
    "secret_storage_key_in_account": String(!!(await secretStorage.hasKey())),
    "session_backup_key_in_secret_storage": String(!!(await client.isKeyBackupKeyStored())),
    "session_backup_key_cached": String(!!sessionBackupKeyFromCache),
    "session_backup_key_well_formed": String(sessionBackupKeyFromCache instanceof Uint8Array)
  };
}

function getDeviceContext(client) {
  const result = {
    "device_id": client === null || client === void 0 ? void 0 : client.deviceId,
    "mx_local_settings": localStorage.getItem('mx_local_settings')
  };

  if (window.Modernizr) {
    const missingFeatures = Object.keys(window.Modernizr).filter(key => window.Modernizr[key] === false);

    if (missingFeatures.length > 0) {
      result["modernizr_missing_features"] = missingFeatures.join(", ");
    }
  }

  return result;
}

async function getContexts() {
  const client = _MatrixClientPeg.MatrixClientPeg.get();

  return {
    "user": getUserContext(client),
    "crypto": await getCryptoContext(client),
    "device": getDeviceContext(client),
    "storage": await getStorageContext()
  };
}

async function sendSentryReport(userText, issueUrl, error) {
  const sentryConfig = _SdkConfig.default.get()["sentry"];

  if (!sentryConfig) return;
  const captureContext = {
    "contexts": await getContexts(),
    "extra": {
      "user_text": userText,
      "issue_url": issueUrl
    }
  }; // If there's no error and no issueUrl, the report will just produce non-grouped noise in Sentry, so don't
  // upload it

  if (error) {
    Sentry.captureException(error, captureContext);
  } else if (issueUrl) {
    Sentry.captureMessage(`Issue: ${issueUrl}`, captureContext);
  }
}

function setSentryUser(mxid) {
  if (!_SdkConfig.default.get().sentry || !_SettingsStore.default.getValue("automaticErrorReporting")) return;
  Sentry.setUser({
    username: mxid
  });
}

async function initSentry(sentryConfig) {
  if (!sentryConfig) return; // Only enable Integrations.GlobalHandlers, which hooks uncaught exceptions, if automaticErrorReporting is true

  const integrations = [new Sentry.Integrations.InboundFilters(), new Sentry.Integrations.FunctionToString(), new Sentry.Integrations.Breadcrumbs(), new Sentry.Integrations.UserAgent(), new Sentry.Integrations.Dedupe()];

  if (_SettingsStore.default.getValue("automaticErrorReporting")) {
    integrations.push(new Sentry.Integrations.GlobalHandlers({
      onerror: false,
      onunhandledrejection: true
    }));
    integrations.push(new Sentry.Integrations.TryCatch());
  }

  Sentry.init({
    dsn: sentryConfig.dsn,
    release: process.env.VERSION,
    environment: sentryConfig.environment,
    defaultIntegrations: false,
    autoSessionTracking: false,
    integrations,
    // Set to 1.0 which is reasonable if we're only submitting Rageshakes; will need to be set < 1.0
    // if we collect more frequently.
    tracesSampleRate: 1.0
  });
}

window.mxSendSentryReport = sendSentryReport;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZW50cnkudHMiXSwibmFtZXMiOlsiZ2V0U3RvcmFnZUNvbnRleHQiLCJyZXN1bHQiLCJuYXZpZ2F0b3IiLCJzdG9yYWdlIiwicGVyc2lzdGVkIiwiU3RyaW5nIiwiZSIsImRvY3VtZW50IiwiaGFzU3RvcmFnZUFjY2VzcyIsImVzdGltYXRlIiwicXVvdGEiLCJ1c2FnZSIsInVzYWdlRGV0YWlscyIsIk9iamVjdCIsImtleXMiLCJmb3JFYWNoIiwiayIsInB1c2giLCJqb2luIiwiZ2V0VXNlckNvbnRleHQiLCJjbGllbnQiLCJjcmVkZW50aWFscyIsInVzZXJJZCIsImdldEVuYWJsZWRMYWJzIiwiU2V0dGluZ3NTdG9yZSIsImdldFZhbHVlIiwiZW5hYmxlZExhYnMiLCJnZXRGZWF0dXJlU2V0dGluZ05hbWVzIiwiZmlsdGVyIiwiZiIsImxlbmd0aCIsImdldENyeXB0b0NvbnRleHQiLCJpc0NyeXB0b0VuYWJsZWQiLCJnZXREZXZpY2VFZDI1NTE5S2V5IiwiZ2V0RGV2aWNlQ3VydmUyNTUxOUtleSIsImNyb3NzU2lnbmluZyIsImNyeXB0byIsImNyb3NzU2lnbmluZ0luZm8iLCJzZWNyZXRTdG9yYWdlIiwicGtDYWNoZSIsImdldENyb3NzU2lnbmluZ0NhY2hlQ2FsbGJhY2tzIiwic2Vzc2lvbkJhY2t1cEtleUZyb21DYWNoZSIsImdldFNlc3Npb25CYWNrdXBQcml2YXRlS2V5IiwiaXNDcm9zc1NpZ25pbmdSZWFkeSIsImRvZXNTZXJ2ZXJTdXBwb3J0VW5zdGFibGVGZWF0dXJlIiwiZ2V0SWQiLCJpc1N0b3JlZEluU2VjcmV0U3RvcmFnZSIsImdldENyb3NzU2lnbmluZ0tleUNhY2hlIiwiaXNTZWNyZXRTdG9yYWdlUmVhZHkiLCJoYXNLZXkiLCJpc0tleUJhY2t1cEtleVN0b3JlZCIsIlVpbnQ4QXJyYXkiLCJnZXREZXZpY2VDb250ZXh0IiwiZGV2aWNlSWQiLCJsb2NhbFN0b3JhZ2UiLCJnZXRJdGVtIiwid2luZG93IiwiTW9kZXJuaXpyIiwibWlzc2luZ0ZlYXR1cmVzIiwia2V5IiwiZ2V0Q29udGV4dHMiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJzZW5kU2VudHJ5UmVwb3J0IiwidXNlclRleHQiLCJpc3N1ZVVybCIsImVycm9yIiwic2VudHJ5Q29uZmlnIiwiU2RrQ29uZmlnIiwiY2FwdHVyZUNvbnRleHQiLCJTZW50cnkiLCJjYXB0dXJlRXhjZXB0aW9uIiwiY2FwdHVyZU1lc3NhZ2UiLCJzZXRTZW50cnlVc2VyIiwibXhpZCIsInNlbnRyeSIsInNldFVzZXIiLCJ1c2VybmFtZSIsImluaXRTZW50cnkiLCJpbnRlZ3JhdGlvbnMiLCJJbnRlZ3JhdGlvbnMiLCJJbmJvdW5kRmlsdGVycyIsIkZ1bmN0aW9uVG9TdHJpbmciLCJCcmVhZGNydW1icyIsIlVzZXJBZ2VudCIsIkRlZHVwZSIsIkdsb2JhbEhhbmRsZXJzIiwib25lcnJvciIsIm9udW5oYW5kbGVkcmVqZWN0aW9uIiwiVHJ5Q2F0Y2giLCJpbml0IiwiZHNuIiwicmVsZWFzZSIsInByb2Nlc3MiLCJlbnYiLCJWRVJTSU9OIiwiZW52aXJvbm1lbnQiLCJkZWZhdWx0SW50ZWdyYXRpb25zIiwiYXV0b1Nlc3Npb25UcmFja2luZyIsInRyYWNlc1NhbXBsZVJhdGUiLCJteFNlbmRTZW50cnlSZXBvcnQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7QUFuQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQW1EQTtBQUVBLGVBQWVBLGlCQUFmLEdBQTREO0FBQ3hELFFBQU1DLE1BQU0sR0FBRyxFQUFmLENBRHdELENBR3hEOztBQUNBLE1BQUlDLFNBQVMsQ0FBQ0MsT0FBVixJQUFxQkQsU0FBUyxDQUFDQyxPQUFWLENBQWtCQyxTQUEzQyxFQUFzRDtBQUNsRCxRQUFJO0FBQ0FILE1BQUFBLE1BQU0sQ0FBQywwQkFBRCxDQUFOLEdBQXFDSSxNQUFN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QUFBLFlBQVksQ0FBQzlELElBQWIsQ0FBa0IsSUFBSXFELE1BQU0sQ0FBQ1UsWUFBUCxDQUFvQk0sY0FBeEIsQ0FDZDtBQUFFQyxNQUFBQSxPQUFPLEVBQUUsS0FBWDtBQUFrQkMsTUFBQUEsb0JBQW9CLEVBQUU7QUFBeEMsS0FEYyxDQUFsQjtBQUVBVCxJQUFBQSxZQUFZLENBQUM5RCxJQUFiLENBQWtCLElBQUlxRCxNQUFNLENBQUNVLFlBQVAsQ0FBb0JTLFFBQXhCLEVBQWxCO0FBQ0g7O0FBRURuQixFQUFBQSxNQUFNLENBQUNvQixJQUFQLENBQVk7QUFDUkMsSUFBQUEsR0FBRyxFQUFFeEIsWUFBWSxDQUFDd0IsR0FEVjtBQUVSQyxJQUFBQSxPQUFPLEVBQUVDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxPQUZiO0FBR1JDLElBQUFBLFdBQVcsRUFBRTdCLFlBQVksQ0FBQzZCLFdBSGxCO0FBSVJDLElBQUFBLG1CQUFtQixFQUFFLEtBSmI7QUFLUkMsSUFBQUEsbUJBQW1CLEVBQUUsS0FMYjtBQU1SbkIsSUFBQUEsWUFOUTtBQU9SO0FBQ0E7QUFDQW9CLElBQUFBLGdCQUFnQixFQUFFO0FBVFYsR0FBWjtBQVdIOztBQUVEM0MsTUFBTSxDQUFDNEMsa0JBQVAsR0FBNEJyQyxnQkFBNUIiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMjEgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgKiBhcyBTZW50cnkgZnJvbSBcIkBzZW50cnkvYnJvd3NlclwiO1xuaW1wb3J0IFNka0NvbmZpZyBmcm9tIFwiLi9TZGtDb25maWdcIjtcbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gXCIuL01hdHJpeENsaWVudFBlZ1wiO1xuaW1wb3J0IFNldHRpbmdzU3RvcmUgZnJvbSBcIi4vc2V0dGluZ3MvU2V0dGluZ3NTdG9yZVwiO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2NsaWVudFwiO1xuXG4vKiBlc2xpbnQtZGlzYWJsZSBjYW1lbGNhc2UgKi9cblxudHlwZSBTdG9yYWdlQ29udGV4dCA9IHtcbiAgICBzdG9yYWdlTWFuYWdlcl9wZXJzaXN0ZWQ/OiBzdHJpbmc7XG4gICAgc3RvcmFnZU1hbmFnZXJfcXVvdGE/OiBzdHJpbmc7XG4gICAgc3RvcmFnZU1hbmFnZXJfdXNhZ2U/OiBzdHJpbmc7XG4gICAgc3RvcmFnZU1hbmFnZXJfdXNhZ2VEZXRhaWxzPzogc3RyaW5nO1xufTtcblxudHlwZSBVc2VyQ29udGV4dCA9IHtcbiAgICB1c2VybmFtZTogc3RyaW5nO1xuICAgIGVuYWJsZWRfbGFiczogc3RyaW5nO1xuICAgIGxvd19iYW5kd2lkdGg6IHN0cmluZztcbn07XG5cbnR5cGUgQ3J5cHRvQ29udGV4dCA9IHtcbiAgICBkZXZpY2Vfa2V5cz86IHN0cmluZztcbiAgICBjcm9zc19zaWduaW5nX3JlYWR5Pzogc3RyaW5nO1xuICAgIGNyb3NzX3NpZ25pbmdfc3VwcG9ydGVkX2J5X2hzPzogc3RyaW5nO1xuICAgIGNyb3NzX3NpZ25pbmdfa2V5Pzogc3RyaW5nO1xuICAgIGNyb3NzX3NpZ25pbmdfcHJpdmtleV9pbl9zZWNyZXRfc3RvcmFnZT86IHN0cmluZztcbiAgICBjcm9zc19zaWduaW5nX21hc3Rlcl9wcml2a2V5X2NhY2hlZD86IHN0cmluZztcbiAgICBjcm9zc19zaWduaW5nX3VzZXJfc2lnbmluZ19wcml2a2V5X2NhY2hlZD86IHN0cmluZztcbiAgICBzZWNyZXRfc3RvcmFnZV9yZWFkeT86IHN0cmluZztcbiAgICBzZWNyZXRfc3RvcmFnZV9rZXlfaW5fYWNjb3VudD86IHN0cmluZztcbiAgICBzZXNzaW9uX2JhY2t1cF9rZXlfaW5fc2VjcmV0X3N0b3JhZ2U/OiBzdHJpbmc7XG4gICAgc2Vzc2lvbl9iYWNrdXBfa2V5X2NhY2hlZD86IHN0cmluZztcbiAgICBzZXNzaW9uX2JhY2t1cF9rZXlfd2VsbF9mb3JtZWQ/OiBzdHJpbmc7XG59O1xuXG50eXBlIERldmljZUNvbnRleHQgPSB7XG4gICAgZGV2aWNlX2lkOiBzdHJpbmc7XG4gICAgbXhfbG9jYWxfc2V0dGluZ3M6IHN0cmluZztcbiAgICBtb2Rlcm5penJfbWlzc2luZ19mZWF0dXJlcz86IHN0cmluZztcbn07XG5cbnR5cGUgQ29udGV4dHMgPSB7XG4gICAgdXNlcjogVXNlckNvbnRleHQ7XG4gICAgY3J5cHRvOiBDcnlwdG9Db250ZXh0O1xuICAgIGRldmljZTogRGV2aWNlQ29udGV4dDtcbiAgICBzdG9yYWdlOiBTdG9yYWdlQ29udGV4dDtcbn07XG5cbi8qIGVzbGludC1lbmFibGUgY2FtZWxjYXNlICovXG5cbmFzeW5jIGZ1bmN0aW9uIGdldFN0b3JhZ2VDb250ZXh0KCk6IFByb21pc2U8U3RvcmFnZUNvbnRleHQ+IHtcbiAgICBjb25zdCByZXN1bHQgPSB7fTtcblxuICAgIC8vIGFkZCBzdG9yYWdlIHBlcnNpc3RlbmNlL3F1b3RhIGluZm9ybWF0aW9uXG4gICAgaWYgKG5hdmlnYXRvci5zdG9yYWdlICYmIG5hdmlnYXRvci5zdG9yYWdlLnBlcnNpc3RlZCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgcmVzdWx0W1wic3RvcmFnZU1hbmFnZXJfcGVyc2lzdGVkXCJdID0gU3RyaW5nKGF3YWl0IG5hdmlnYXRvci5zdG9yYWdlLnBlcnNpc3RlZCgpKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge31cbiAgICB9IGVsc2UgaWYgKGRvY3VtZW50Lmhhc1N0b3JhZ2VBY2Nlc3MpIHsgLy8gU2FmYXJpXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICByZXN1bHRbXCJzdG9yYWdlTWFuYWdlcl9wZXJzaXN0ZWRcIl0gPSBTdHJpbmcoYXdhaXQgZG9jdW1lbnQuaGFzU3RvcmFnZUFjY2VzcygpKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge31cbiAgICB9XG4gICAgaWYgKG5hdmlnYXRvci5zdG9yYWdlICYmIG5hdmlnYXRvci5zdG9yYWdlLmVzdGltYXRlKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBlc3RpbWF0ZSA9IGF3YWl0IG5hdmlnYXRvci5zdG9yYWdlLmVzdGltYXRlKCk7XG4gICAgICAgICAgICByZXN1bHRbXCJzdG9yYWdlTWFuYWdlcl9xdW90YVwiXSA9IFN0cmluZyhlc3RpbWF0ZS5xdW90YSk7XG4gICAgICAgICAgICByZXN1bHRbXCJzdG9yYWdlTWFuYWdlcl91c2FnZVwiXSA9IFN0cmluZyhlc3RpbWF0ZS51c2FnZSk7XG4gICAgICAgICAgICBpZiAoZXN0aW1hdGUudXNhZ2VEZXRhaWxzKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdXNhZ2VEZXRhaWxzID0gW107XG4gICAgICAgICAgICAgICAgT2JqZWN0LmtleXMoZXN0aW1hdGUudXNhZ2VEZXRhaWxzKS5mb3JFYWNoKGsgPT4ge1xuICAgICAgICAgICAgICAgICAgICB1c2FnZURldGFpbHMucHVzaChgJHtrfTogJHtTdHJpbmcoZXN0aW1hdGUudXNhZ2VEZXRhaWxzW2tdKX1gKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICByZXN1bHRbYHN0b3JhZ2VNYW5hZ2VyX3VzYWdlYF0gPSB1c2FnZURldGFpbHMuam9pbihcIiwgXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlKSB7fVxuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG59XG5cbmZ1bmN0aW9uIGdldFVzZXJDb250ZXh0KGNsaWVudDogTWF0cml4Q2xpZW50KTogVXNlckNvbnRleHQge1xuICAgIHJldHVybiB7XG4gICAgICAgIFwidXNlcm5hbWVcIjogY2xpZW50LmNyZWRlbnRpYWxzLnVzZXJJZCxcbiAgICAgICAgXCJlbmFibGVkX2xhYnNcIjogZ2V0RW5hYmxlZExhYnMoKSxcbiAgICAgICAgXCJsb3dfYmFuZHdpZHRoXCI6IFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJsb3dCYW5kd2lkdGhcIikgPyBcImVuYWJsZWRcIiA6IFwiZGlzYWJsZWRcIixcbiAgICB9O1xufVxuXG5mdW5jdGlvbiBnZXRFbmFibGVkTGFicygpOiBzdHJpbmcge1xuICAgIGNvbnN0IGVuYWJsZWRMYWJzID0gU2V0dGluZ3NTdG9yZS5nZXRGZWF0dXJlU2V0dGluZ05hbWVzKCkuZmlsdGVyKGYgPT4gU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShmKSk7XG4gICAgaWYgKGVuYWJsZWRMYWJzLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gZW5hYmxlZExhYnMuam9pbihcIiwgXCIpO1xuICAgIH1cbiAgICByZXR1cm4gXCJcIjtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0Q3J5cHRvQ29udGV4dChjbGllbnQ6IE1hdHJpeENsaWVudCk6IFByb21pc2U8Q3J5cHRvQ29udGV4dD4ge1xuICAgIGlmICghY2xpZW50LmlzQ3J5cHRvRW5hYmxlZCgpKSB7XG4gICAgICAgIHJldHVybiB7fTtcbiAgICB9XG4gICAgY29uc3Qga2V5cyA9IFtgZWQyNTUxOToke2NsaWVudC5nZXREZXZpY2VFZDI1NTE5S2V5KCl9YF07XG4gICAgaWYgKGNsaWVudC5nZXREZXZpY2VDdXJ2ZTI1NTE5S2V5KSB7XG4gICAgICAgIGtleXMucHVzaChgY3VydmUyNTUxOToke2NsaWVudC5nZXREZXZpY2VDdXJ2ZTI1NTE5S2V5KCl9YCk7XG4gICAgfVxuICAgIGNvbnN0IGNyb3NzU2lnbmluZyA9IGNsaWVudC5jcnlwdG8uY3Jvc3NTaWduaW5nSW5mbztcbiAgICBjb25zdCBzZWNyZXRTdG9yYWdlID0gY2xpZW50LmNyeXB0by5zZWNyZXRTdG9yYWdlO1xuICAgIGNvbnN0IHBrQ2FjaGUgPSBjbGllbnQuZ2V0Q3Jvc3NTaWduaW5nQ2FjaGVDYWxsYmFja3MoKTtcbiAgICBjb25zdCBzZXNzaW9uQmFja3VwS2V5RnJvbUNhY2hlID0gYXdhaXQgY2xpZW50LmNyeXB0by5nZXRTZXNzaW9uQmFja3VwUHJpdmF0ZUtleSgpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgXCJkZXZpY2Vfa2V5c1wiOiBrZXlzLmpvaW4oJywgJyksXG4gICAgICAgIFwiY3Jvc3Nfc2lnbmluZ19yZWFkeVwiOiBTdHJpbmcoYXdhaXQgY2xpZW50LmlzQ3Jvc3NTaWduaW5nUmVhZHkoKSksXG4gICAgICAgIFwiY3Jvc3Nfc2lnbmluZ19zdXBwb3J0ZWRfYnlfaHNcIjpcbiAgICAgICAgICAgIFN0cmluZyhhd2FpdCBjbGllbnQuZG9lc1NlcnZlclN1cHBvcnRVbnN0YWJsZUZlYXR1cmUoXCJvcmcubWF0cml4LmUyZV9jcm9zc19zaWduaW5nXCIpKSxcbiAgICAgICAgXCJjcm9zc19zaWduaW5nX2tleVwiOiBjcm9zc1NpZ25pbmcuZ2V0SWQoKSxcbiAgICAgICAgXCJjcm9zc19zaWduaW5nX3ByaXZrZXlfaW5fc2VjcmV0X3N0b3JhZ2VcIjogU3RyaW5nKFxuICAgICAgICAgICAgISEoYXdhaXQgY3Jvc3NTaWduaW5nLmlzU3RvcmVkSW5TZWNyZXRTdG9yYWdlKHNlY3JldFN0b3JhZ2UpKSksXG4gICAgICAgIFwiY3Jvc3Nfc2lnbmluZ19tYXN0ZXJfcHJpdmtleV9jYWNoZWRcIjogU3RyaW5nKFxuICAgICAgICAgICAgISEocGtDYWNoZSAmJiAoYXdhaXQgcGtDYWNoZS5nZXRDcm9zc1NpZ25pbmdLZXlDYWNoZShcIm1hc3RlclwiKSkpKSxcbiAgICAgICAgXCJjcm9zc19zaWduaW5nX3VzZXJfc2lnbmluZ19wcml2a2V5X2NhY2hlZFwiOiBTdHJpbmcoXG4gICAgICAgICAgICAhIShwa0NhY2hlICYmIChhd2FpdCBwa0NhY2hlLmdldENyb3NzU2lnbmluZ0tleUNhY2hlKFwidXNlcl9zaWduaW5nXCIpKSkpLFxuICAgICAgICBcInNlY3JldF9zdG9yYWdlX3JlYWR5XCI6IFN0cmluZyhhd2FpdCBjbGllbnQuaXNTZWNyZXRTdG9yYWdlUmVhZHkoKSksXG4gICAgICAgIFwic2VjcmV0X3N0b3JhZ2Vfa2V5X2luX2FjY291bnRcIjogU3RyaW5nKCEhKGF3YWl0IHNlY3JldFN0b3JhZ2UuaGFzS2V5KCkpKSxcbiAgICAgICAgXCJzZXNzaW9uX2JhY2t1cF9rZXlfaW5fc2VjcmV0X3N0b3JhZ2VcIjogU3RyaW5nKCEhKGF3YWl0IGNsaWVudC5pc0tleUJhY2t1cEtleVN0b3JlZCgpKSksXG4gICAgICAgIFwic2Vzc2lvbl9iYWNrdXBfa2V5X2NhY2hlZFwiOiBTdHJpbmcoISFzZXNzaW9uQmFja3VwS2V5RnJvbUNhY2hlKSxcbiAgICAgICAgXCJzZXNzaW9uX2JhY2t1cF9rZXlfd2VsbF9mb3JtZWRcIjogU3RyaW5nKHNlc3Npb25CYWNrdXBLZXlGcm9tQ2FjaGUgaW5zdGFuY2VvZiBVaW50OEFycmF5KSxcbiAgICB9O1xufVxuXG5mdW5jdGlvbiBnZXREZXZpY2VDb250ZXh0KGNsaWVudDogTWF0cml4Q2xpZW50KTogRGV2aWNlQ29udGV4dCB7XG4gICAgY29uc3QgcmVzdWx0ID0ge1xuICAgICAgICBcImRldmljZV9pZFwiOiBjbGllbnQ/LmRldmljZUlkLFxuICAgICAgICBcIm14X2xvY2FsX3NldHRpbmdzXCI6IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdteF9sb2NhbF9zZXR0aW5ncycpLFxuICAgIH07XG5cbiAgICBpZiAod2luZG93Lk1vZGVybml6cikge1xuICAgICAgICBjb25zdCBtaXNzaW5nRmVhdHVyZXMgPSBPYmplY3Qua2V5cyh3aW5kb3cuTW9kZXJuaXpyKS5maWx0ZXIoa2V5ID0+IHdpbmRvdy5Nb2Rlcm5penJba2V5XSA9PT0gZmFsc2UpO1xuICAgICAgICBpZiAobWlzc2luZ0ZlYXR1cmVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHJlc3VsdFtcIm1vZGVybml6cl9taXNzaW5nX2ZlYXR1cmVzXCJdID0gbWlzc2luZ0ZlYXR1cmVzLmpvaW4oXCIsIFwiKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldENvbnRleHRzKCk6IFByb21pc2U8Q29udGV4dHM+IHtcbiAgICBjb25zdCBjbGllbnQgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgXCJ1c2VyXCI6IGdldFVzZXJDb250ZXh0KGNsaWVudCksXG4gICAgICAgIFwiY3J5cHRvXCI6IGF3YWl0IGdldENyeXB0b0NvbnRleHQoY2xpZW50KSxcbiAgICAgICAgXCJkZXZpY2VcIjogZ2V0RGV2aWNlQ29udGV4dChjbGllbnQpLFxuICAgICAgICBcInN0b3JhZ2VcIjogYXdhaXQgZ2V0U3RvcmFnZUNvbnRleHQoKSxcbiAgICB9O1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gc2VuZFNlbnRyeVJlcG9ydCh1c2VyVGV4dDogc3RyaW5nLCBpc3N1ZVVybDogc3RyaW5nLCBlcnJvcjogRXJyb3IpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBzZW50cnlDb25maWcgPSBTZGtDb25maWcuZ2V0KClbXCJzZW50cnlcIl07XG4gICAgaWYgKCFzZW50cnlDb25maWcpIHJldHVybjtcblxuICAgIGNvbnN0IGNhcHR1cmVDb250ZXh0ID0ge1xuICAgICAgICBcImNvbnRleHRzXCI6IGF3YWl0IGdldENvbnRleHRzKCksXG4gICAgICAgIFwiZXh0cmFcIjoge1xuICAgICAgICAgICAgXCJ1c2VyX3RleHRcIjogdXNlclRleHQsXG4gICAgICAgICAgICBcImlzc3VlX3VybFwiOiBpc3N1ZVVybCxcbiAgICAgICAgfSxcbiAgICB9O1xuXG4gICAgLy8gSWYgdGhlcmUncyBubyBlcnJvciBhbmQgbm8gaXNzdWVVcmwsIHRoZSByZXBvcnQgd2lsbCBqdXN0IHByb2R1Y2Ugbm9uLWdyb3VwZWQgbm9pc2UgaW4gU2VudHJ5LCBzbyBkb24ndFxuICAgIC8vIHVwbG9hZCBpdFxuICAgIGlmIChlcnJvcikge1xuICAgICAgICBTZW50cnkuY2FwdHVyZUV4Y2VwdGlvbihlcnJvciwgY2FwdHVyZUNvbnRleHQpO1xuICAgIH0gZWxzZSBpZiAoaXNzdWVVcmwpIHtcbiAgICAgICAgU2VudHJ5LmNhcHR1cmVNZXNzYWdlKGBJc3N1ZTogJHtpc3N1ZVVybH1gLCBjYXB0dXJlQ29udGV4dCk7XG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gc2V0U2VudHJ5VXNlcihteGlkOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAoIVNka0NvbmZpZy5nZXQoKS5zZW50cnkgfHwgIVNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJhdXRvbWF0aWNFcnJvclJlcG9ydGluZ1wiKSkgcmV0dXJuO1xuICAgIFNlbnRyeS5zZXRVc2VyKHsgdXNlcm5hbWU6IG14aWQgfSk7XG59XG5cbmludGVyZmFjZSBJU2VudHJ5Q29uZmlnIHtcbiAgICBkc246IHN0cmluZztcbiAgICBlbnZpcm9ubWVudD86IHN0cmluZztcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGluaXRTZW50cnkoc2VudHJ5Q29uZmlnOiBJU2VudHJ5Q29uZmlnKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCFzZW50cnlDb25maWcpIHJldHVybjtcbiAgICAvLyBPbmx5IGVuYWJsZSBJbnRlZ3JhdGlvbnMuR2xvYmFsSGFuZGxlcnMsIHdoaWNoIGhvb2tzIHVuY2F1Z2h0IGV4Y2VwdGlvbnMsIGlmIGF1dG9tYXRpY0Vycm9yUmVwb3J0aW5nIGlzIHRydWVcbiAgICBjb25zdCBpbnRlZ3JhdGlvbnMgPSBbXG4gICAgICAgIG5ldyBTZW50cnkuSW50ZWdyYXRpb25zLkluYm91bmRGaWx0ZXJzKCksXG4gICAgICAgIG5ldyBTZW50cnkuSW50ZWdyYXRpb25zLkZ1bmN0aW9uVG9TdHJpbmcoKSxcbiAgICAgICAgbmV3IFNlbnRyeS5JbnRlZ3JhdGlvbnMuQnJlYWRjcnVtYnMoKSxcbiAgICAgICAgbmV3IFNlbnRyeS5JbnRlZ3JhdGlvbnMuVXNlckFnZW50KCksXG4gICAgICAgIG5ldyBTZW50cnkuSW50ZWdyYXRpb25zLkRlZHVwZSgpLFxuICAgIF07XG5cbiAgICBpZiAoU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcImF1dG9tYXRpY0Vycm9yUmVwb3J0aW5nXCIpKSB7XG4gICAgICAgIGludGVncmF0aW9ucy5wdXNoKG5ldyBTZW50cnkuSW50ZWdyYXRpb25zLkdsb2JhbEhhbmRsZXJzKFxuICAgICAgICAgICAgeyBvbmVycm9yOiBmYWxzZSwgb251bmhhbmRsZWRyZWplY3Rpb246IHRydWUgfSkpO1xuICAgICAgICBpbnRlZ3JhdGlvbnMucHVzaChuZXcgU2VudHJ5LkludGVncmF0aW9ucy5UcnlDYXRjaCgpKTtcbiAgICB9XG5cbiAgICBTZW50cnkuaW5pdCh7XG4gICAgICAgIGRzbjogc2VudHJ5Q29uZmlnLmRzbixcbiAgICAgICAgcmVsZWFzZTogcHJvY2Vzcy5lbnYuVkVSU0lPTixcbiAgICAgICAgZW52aXJvbm1lbnQ6IHNlbnRyeUNvbmZpZy5lbnZpcm9ubWVudCxcbiAgICAgICAgZGVmYXVsdEludGVncmF0aW9uczogZmFsc2UsXG4gICAgICAgIGF1dG9TZXNzaW9uVHJhY2tpbmc6IGZhbHNlLFxuICAgICAgICBpbnRlZ3JhdGlvbnMsXG4gICAgICAgIC8vIFNldCB0byAxLjAgd2hpY2ggaXMgcmVhc29uYWJsZSBpZiB3ZSdyZSBvbmx5IHN1Ym1pdHRpbmcgUmFnZXNoYWtlczsgd2lsbCBuZWVkIHRvIGJlIHNldCA8IDEuMFxuICAgICAgICAvLyBpZiB3ZSBjb2xsZWN0IG1vcmUgZnJlcXVlbnRseS5cbiAgICAgICAgdHJhY2VzU2FtcGxlUmF0ZTogMS4wLFxuICAgIH0pO1xufVxuXG53aW5kb3cubXhTZW5kU2VudHJ5UmVwb3J0ID0gc2VuZFNlbnRyeVJlcG9ydDtcbiJdfQ==