"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _languageHandler = require("../../../../languageHandler");

var _SdkConfig = _interopRequireDefault(require("../../../../SdkConfig"));

var _SettingsStore = _interopRequireDefault(require("../../../../settings/SettingsStore"));

var _Modal = _interopRequireDefault(require("../../../../Modal"));

var _FormattingUtils = require("../../../../utils/FormattingUtils");

var _EventIndexPeg = _interopRequireDefault(require("../../../../indexing/EventIndexPeg"));

var _SettingLevel = require("../../../../settings/SettingLevel");

var _Field = _interopRequireDefault(require("../../../../components/views/elements/Field"));

var _BaseDialog = _interopRequireDefault(require("../../../../components/views/dialogs/BaseDialog"));

var _DialogButtons = _interopRequireDefault(require("../../../../components/views/elements/DialogButtons"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/*
 * Allows the user to introspect the event index state and disable it.
 */
class ManageEventIndexDialog extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "updateCurrentRoom", async room => {
      const eventIndex = _EventIndexPeg.default.get();

      let stats;

      try {
        stats = await eventIndex.getStats();
      } catch {
        // This call may fail if sporadically, not a huge issue as we will
        // try later again and probably succeed.
        return;
      }

      let currentRoom = null;
      if (room) currentRoom = room.name;
      const roomStats = eventIndex.crawlingRooms();
      const crawlingRoomsCount = roomStats.crawlingRooms.size;
      const roomCount = roomStats.totalRooms.size;
      this.setState({
        eventIndexSize: stats.size,
        eventCount: stats.eventCount,
        crawlingRoomsCount: crawlingRoomsCount,
        roomCount: roomCount,
        currentRoom: currentRoom
      });
    });
    (0, _defineProperty2.default)(this, "onDisable", async () => {
      const DisableEventIndexDialog = (await Promise.resolve().then(() => _interopRequireWildcard(require("./DisableEventIndexDialog")))).default;

      _Modal.default.createTrackedDialog("Disable message search", "Disable message search", DisableEventIndexDialog, null, null,
      /* priority = */
      false,
      /* static = */
      true);
    });
    (0, _defineProperty2.default)(this, "onCrawlerSleepTimeChange", e => {
      this.setState({
        crawlerSleepTime: e.target.value
      });

      _SettingsStore.default.setValue("crawlerSleepTime", null, _SettingLevel.SettingLevel.DEVICE, e.target.value);
    });
    this.state = {
      eventIndexSize: 0,
      eventCount: 0,
      crawlingRoomsCount: 0,
      roomCount: 0,
      currentRoom: null,
      crawlerSleepTime: _SettingsStore.default.getValueAt(_SettingLevel.SettingLevel.DEVICE, 'crawlerSleepTime')
    };
  }

  componentWillUnmount() {
    const eventIndex = _EventIndexPeg.default.get();

    if (eventIndex !== null) {
      eventIndex.removeListener("changedCheckpoint", this.updateCurrentRoom);
    }
  }

  async componentDidMount() {
    let eventIndexSize = 0;
    let crawlingRoomsCount = 0;
    let roomCount = 0;
    let eventCount = 0;
    let currentRoom = null;

    const eventIndex = _EventIndexPeg.default.get();

    if (eventIndex !== null) {
      eventIndex.on("changedCheckpoint", this.updateCurrentRoom);

      try {
        const stats = await eventIndex.getStats();
        eventIndexSize = stats.size;
        eventCount = stats.eventCount;
      } catch {// This call may fail if sporadically, not a huge issue as we
        // will try later again in the updateCurrentRoom call and
        // probably succeed.
      }

      const roomStats = eventIndex.crawlingRooms();
      crawlingRoomsCount = roomStats.crawlingRooms.size;
      roomCount = roomStats.totalRooms.size;
      const room = eventIndex.currentRoom();
      if (room) currentRoom = room.name;
    }

    this.setState({
      eventIndexSize,
      eventCount,
      crawlingRoomsCount,
      roomCount,
      currentRoom
    });
  }

  render() {
    const brand = _SdkConfig.default.get().brand;

    let crawlerState;

    if (this.state.currentRoom === null) {
      crawlerState = (0, _languageHandler._t)("Not currently indexing messages for any room.");
    } else {
      crawlerState = (0, _languageHandler._t)("Currently indexing: %(currentRoom)s", {
        currentRoom: this.state.currentRoom
      });
    }

    const doneRooms = Math.max(0, this.state.roomCount - this.state.crawlingRoomsCount);

    const eventIndexingSettings = /*#__PURE__*/_react.default.createElement("div", null, (0, _languageHandler._t)("%(brand)s is securely caching encrypted messages locally for them " + "to appear in search results:", {
      brand
    }), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_SettingsTab_subsectionText"
    }, crawlerState, /*#__PURE__*/_react.default.createElement("br", null), (0, _languageHandler._t)("Space used:"), " ", (0, _FormattingUtils.formatBytes)(this.state.eventIndexSize, 0), /*#__PURE__*/_react.default.createElement("br", null), (0, _languageHandler._t)("Indexed messages:"), " ", (0, _FormattingUtils.formatCountLong)(this.state.eventCount), /*#__PURE__*/_react.default.createElement("br", null), (0, _languageHandler._t)("Indexed rooms:"), " ", (0, _languageHandler._t)("%(doneRooms)s out of %(totalRooms)s", {
      doneRooms: (0, _FormattingUtils.formatCountLong)(doneRooms),
      totalRooms: (0, _FormattingUtils.formatCountLong)(this.state.roomCount)
    }), " ", /*#__PURE__*/_react.default.createElement("br", null), /*#__PURE__*/_react.default.createElement(_Field.default, {
      label: (0, _languageHandler._t)('Message downloading sleep time(ms)'),
      type: "number",
      value: this.state.crawlerSleepTime.toString(),
      onChange: this.onCrawlerSleepTimeChange
    })));

    return /*#__PURE__*/_react.default.createElement(_BaseDialog.default, {
      className: "mx_ManageEventIndexDialog",
      onFinished: this.props.onFinished,
      title: (0, _languageHandler._t)("Message search")
    }, eventIndexingSettings, /*#__PURE__*/_react.default.createElement(_DialogButtons.default, {
      primaryButton: (0, _languageHandler._t)("Done"),
      onPrimaryButtonClick: this.props.onFinished,
      primaryButtonClass: "primary",
      cancelButton: (0, _languageHandler._t)("Disable"),
      onCancel: this.onDisable,
      cancelButtonClass: "danger"
    }));
  }

}

exports.default = ManageEventIndexDialog;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9hc3luYy1jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvZXZlbnRpbmRleC9NYW5hZ2VFdmVudEluZGV4RGlhbG9nLnRzeCJdLCJuYW1lcyI6WyJNYW5hZ2VFdmVudEluZGV4RGlhbG9nIiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwicm9vbSIsImV2ZW50SW5kZXgiLCJFdmVudEluZGV4UGVnIiwiZ2V0Iiwic3RhdHMiLCJnZXRTdGF0cyIsImN1cnJlbnRSb29tIiwibmFtZSIsInJvb21TdGF0cyIsImNyYXdsaW5nUm9vbXMiLCJjcmF3bGluZ1Jvb21zQ291bnQiLCJzaXplIiwicm9vbUNvdW50IiwidG90YWxSb29tcyIsInNldFN0YXRlIiwiZXZlbnRJbmRleFNpemUiLCJldmVudENvdW50IiwiRGlzYWJsZUV2ZW50SW5kZXhEaWFsb2ciLCJkZWZhdWx0IiwiTW9kYWwiLCJjcmVhdGVUcmFja2VkRGlhbG9nIiwiZSIsImNyYXdsZXJTbGVlcFRpbWUiLCJ0YXJnZXQiLCJ2YWx1ZSIsIlNldHRpbmdzU3RvcmUiLCJzZXRWYWx1ZSIsIlNldHRpbmdMZXZlbCIsIkRFVklDRSIsInN0YXRlIiwiZ2V0VmFsdWVBdCIsImNvbXBvbmVudFdpbGxVbm1vdW50IiwicmVtb3ZlTGlzdGVuZXIiLCJ1cGRhdGVDdXJyZW50Um9vbSIsImNvbXBvbmVudERpZE1vdW50Iiwib24iLCJyZW5kZXIiLCJicmFuZCIsIlNka0NvbmZpZyIsImNyYXdsZXJTdGF0ZSIsImRvbmVSb29tcyIsIk1hdGgiLCJtYXgiLCJldmVudEluZGV4aW5nU2V0dGluZ3MiLCJ0b1N0cmluZyIsIm9uQ3Jhd2xlclNsZWVwVGltZUNoYW5nZSIsIm9uRmluaXNoZWQiLCJvbkRpc2FibGUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztB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QUFBLEtBQUssRUFBRSx5QkFBRyxnQkFBSDtBQUZYLE9BSU1ILHFCQUpOLGVBS0ksNkJBQUMsc0JBQUQ7QUFDSSxNQUFBLGFBQWEsRUFBRSx5QkFBRyxNQUFILENBRG5CO0FBRUksTUFBQSxvQkFBb0IsRUFBRSxLQUFLNUMsS0FBTCxDQUFXK0MsVUFGckM7QUFHSSxNQUFBLGtCQUFrQixFQUFDLFNBSHZCO0FBSUksTUFBQSxZQUFZLEVBQUUseUJBQUcsU0FBSCxDQUpsQjtBQUtJLE1BQUEsUUFBUSxFQUFFLEtBQUtDLFNBTG5CO0FBTUksTUFBQSxpQkFBaUIsRUFBQztBQU50QixNQUxKLENBREo7QUFnQkg7O0FBN0orRSIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAyMC0yMDIxIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IF90IH0gZnJvbSAnLi4vLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyJztcbmltcG9ydCBTZGtDb25maWcgZnJvbSAnLi4vLi4vLi4vLi4vU2RrQ29uZmlnJztcbmltcG9ydCBTZXR0aW5nc1N0b3JlIGZyb20gXCIuLi8uLi8uLi8uLi9zZXR0aW5ncy9TZXR0aW5nc1N0b3JlXCI7XG5cbmltcG9ydCBNb2RhbCBmcm9tICcuLi8uLi8uLi8uLi9Nb2RhbCc7XG5pbXBvcnQgeyBmb3JtYXRCeXRlcywgZm9ybWF0Q291bnRMb25nIH0gZnJvbSBcIi4uLy4uLy4uLy4uL3V0aWxzL0Zvcm1hdHRpbmdVdGlsc1wiO1xuaW1wb3J0IEV2ZW50SW5kZXhQZWcgZnJvbSBcIi4uLy4uLy4uLy4uL2luZGV4aW5nL0V2ZW50SW5kZXhQZWdcIjtcbmltcG9ydCB7IFNldHRpbmdMZXZlbCB9IGZyb20gXCIuLi8uLi8uLi8uLi9zZXR0aW5ncy9TZXR0aW5nTGV2ZWxcIjtcbmltcG9ydCBGaWVsZCBmcm9tICcuLi8uLi8uLi8uLi9jb21wb25lbnRzL3ZpZXdzL2VsZW1lbnRzL0ZpZWxkJztcbmltcG9ydCBCYXNlRGlhbG9nIGZyb20gXCIuLi8uLi8uLi8uLi9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvQmFzZURpYWxvZ1wiO1xuaW1wb3J0IERpYWxvZ0J1dHRvbnMgZnJvbSBcIi4uLy4uLy4uLy4uL2NvbXBvbmVudHMvdmlld3MvZWxlbWVudHMvRGlhbG9nQnV0dG9uc1wiO1xuaW1wb3J0IHsgSURpYWxvZ1Byb3BzIH0gZnJvbSBcIi4uLy4uLy4uLy4uL2NvbXBvbmVudHMvdmlld3MvZGlhbG9ncy9JRGlhbG9nUHJvcHNcIjtcblxuaW50ZXJmYWNlIElQcm9wcyBleHRlbmRzIElEaWFsb2dQcm9wcyB7fVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBldmVudEluZGV4U2l6ZTogbnVtYmVyO1xuICAgIGV2ZW50Q291bnQ6IG51bWJlcjtcbiAgICBjcmF3bGluZ1Jvb21zQ291bnQ6IG51bWJlcjtcbiAgICByb29tQ291bnQ6IG51bWJlcjtcbiAgICBjdXJyZW50Um9vbTogc3RyaW5nO1xuICAgIGNyYXdsZXJTbGVlcFRpbWU6IG51bWJlcjtcbn1cblxuLypcbiAqIEFsbG93cyB0aGUgdXNlciB0byBpbnRyb3NwZWN0IHRoZSBldmVudCBpbmRleCBzdGF0ZSBhbmQgZGlzYWJsZSBpdC5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTWFuYWdlRXZlbnRJbmRleERpYWxvZyBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxJUHJvcHMsIElTdGF0ZT4ge1xuICAgIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgZXZlbnRJbmRleFNpemU6IDAsXG4gICAgICAgICAgICBldmVudENvdW50OiAwLFxuICAgICAgICAgICAgY3Jhd2xpbmdSb29tc0NvdW50OiAwLFxuICAgICAgICAgICAgcm9vbUNvdW50OiAwLFxuICAgICAgICAgICAgY3VycmVudFJvb206IG51bGwsXG4gICAgICAgICAgICBjcmF3bGVyU2xlZXBUaW1lOlxuICAgICAgICAgICAgICAgIFNldHRpbmdzU3RvcmUuZ2V0VmFsdWVBdChTZXR0aW5nTGV2ZWwuREVWSUNFLCAnY3Jhd2xlclNsZWVwVGltZScpLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHVwZGF0ZUN1cnJlbnRSb29tID0gYXN5bmMgKHJvb20pID0+IHtcbiAgICAgICAgY29uc3QgZXZlbnRJbmRleCA9IEV2ZW50SW5kZXhQZWcuZ2V0KCk7XG4gICAgICAgIGxldCBzdGF0cztcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgc3RhdHMgPSBhd2FpdCBldmVudEluZGV4LmdldFN0YXRzKCk7XG4gICAgICAgIH0gY2F0Y2gge1xuICAgICAgICAgICAgLy8gVGhpcyBjYWxsIG1heSBmYWlsIGlmIHNwb3JhZGljYWxseSwgbm90IGEgaHVnZSBpc3N1ZSBhcyB3ZSB3aWxsXG4gICAgICAgICAgICAvLyB0cnkgbGF0ZXIgYWdhaW4gYW5kIHByb2JhYmx5IHN1Y2NlZWQuXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgY3VycmVudFJvb20gPSBudWxsO1xuXG4gICAgICAgIGlmIChyb29tKSBjdXJyZW50Um9vbSA9IHJvb20ubmFtZTtcbiAgICAgICAgY29uc3Qgcm9vbVN0YXRzID0gZXZlbnRJbmRleC5jcmF3bGluZ1Jvb21zKCk7XG4gICAgICAgIGNvbnN0IGNyYXdsaW5nUm9vbXNDb3VudCA9IHJvb21TdGF0cy5jcmF3bGluZ1Jvb21zLnNpemU7XG4gICAgICAgIGNvbnN0IHJvb21Db3VudCA9IHJvb21TdGF0cy50b3RhbFJvb21zLnNpemU7XG5cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBldmVudEluZGV4U2l6ZTogc3RhdHMuc2l6ZSxcbiAgICAgICAgICAgIGV2ZW50Q291bnQ6IHN0YXRzLmV2ZW50Q291bnQsXG4gICAgICAgICAgICBjcmF3bGluZ1Jvb21zQ291bnQ6IGNyYXdsaW5nUm9vbXNDb3VudCxcbiAgICAgICAgICAgIHJvb21Db3VudDogcm9vbUNvdW50LFxuICAgICAgICAgICAgY3VycmVudFJvb206IGN1cnJlbnRSb29tLFxuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgY29tcG9uZW50V2lsbFVubW91bnQoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGV2ZW50SW5kZXggPSBFdmVudEluZGV4UGVnLmdldCgpO1xuXG4gICAgICAgIGlmIChldmVudEluZGV4ICE9PSBudWxsKSB7XG4gICAgICAgICAgICBldmVudEluZGV4LnJlbW92ZUxpc3RlbmVyKFwiY2hhbmdlZENoZWNrcG9pbnRcIiwgdGhpcy51cGRhdGVDdXJyZW50Um9vbSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBjb21wb25lbnREaWRNb3VudCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgbGV0IGV2ZW50SW5kZXhTaXplID0gMDtcbiAgICAgICAgbGV0IGNyYXdsaW5nUm9vbXNDb3VudCA9IDA7XG4gICAgICAgIGxldCByb29tQ291bnQgPSAwO1xuICAgICAgICBsZXQgZXZlbnRDb3VudCA9IDA7XG4gICAgICAgIGxldCBjdXJyZW50Um9vbSA9IG51bGw7XG5cbiAgICAgICAgY29uc3QgZXZlbnRJbmRleCA9IEV2ZW50SW5kZXhQZWcuZ2V0KCk7XG5cbiAgICAgICAgaWYgKGV2ZW50SW5kZXggIT09IG51bGwpIHtcbiAgICAgICAgICAgIGV2ZW50SW5kZXgub24oXCJjaGFuZ2VkQ2hlY2twb2ludFwiLCB0aGlzLnVwZGF0ZUN1cnJlbnRSb29tKTtcblxuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb25zdCBzdGF0cyA9IGF3YWl0IGV2ZW50SW5kZXguZ2V0U3RhdHMoKTtcbiAgICAgICAgICAgICAgICBldmVudEluZGV4U2l6ZSA9IHN0YXRzLnNpemU7XG4gICAgICAgICAgICAgICAgZXZlbnRDb3VudCA9IHN0YXRzLmV2ZW50Q291bnQ7XG4gICAgICAgICAgICB9IGNhdGNoIHtcbiAgICAgICAgICAgICAgICAvLyBUaGlzIGNhbGwgbWF5IGZhaWwgaWYgc3BvcmFkaWNhbGx5LCBub3QgYSBodWdlIGlzc3VlIGFzIHdlXG4gICAgICAgICAgICAgICAgLy8gd2lsbCB0cnkgbGF0ZXIgYWdhaW4gaW4gdGhlIHVwZGF0ZUN1cnJlbnRSb29tIGNhbGwgYW5kXG4gICAgICAgICAgICAgICAgLy8gcHJvYmFibHkgc3VjY2VlZC5cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3Qgcm9vbVN0YXRzID0gZXZlbnRJbmRleC5jcmF3bGluZ1Jvb21zKCk7XG4gICAgICAgICAgICBjcmF3bGluZ1Jvb21zQ291bnQgPSByb29tU3RhdHMuY3Jhd2xpbmdSb29tcy5zaXplO1xuICAgICAgICAgICAgcm9vbUNvdW50ID0gcm9vbVN0YXRzLnRvdGFsUm9vbXMuc2l6ZTtcblxuICAgICAgICAgICAgY29uc3Qgcm9vbSA9IGV2ZW50SW5kZXguY3VycmVudFJvb20oKTtcbiAgICAgICAgICAgIGlmIChyb29tKSBjdXJyZW50Um9vbSA9IHJvb20ubmFtZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgZXZlbnRJbmRleFNpemUsXG4gICAgICAgICAgICBldmVudENvdW50LFxuICAgICAgICAgICAgY3Jhd2xpbmdSb29tc0NvdW50LFxuICAgICAgICAgICAgcm9vbUNvdW50LFxuICAgICAgICAgICAgY3VycmVudFJvb20sXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25EaXNhYmxlID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBEaXNhYmxlRXZlbnRJbmRleERpYWxvZyA9IChhd2FpdCBpbXBvcnQoXCIuL0Rpc2FibGVFdmVudEluZGV4RGlhbG9nXCIpKS5kZWZhdWx0O1xuICAgICAgICBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nKFwiRGlzYWJsZSBtZXNzYWdlIHNlYXJjaFwiLCBcIkRpc2FibGUgbWVzc2FnZSBzZWFyY2hcIixcbiAgICAgICAgICAgIERpc2FibGVFdmVudEluZGV4RGlhbG9nLFxuICAgICAgICAgICAgbnVsbCwgbnVsbCwgLyogcHJpb3JpdHkgPSAqLyBmYWxzZSwgLyogc3RhdGljID0gKi8gdHJ1ZSxcbiAgICAgICAgKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkNyYXdsZXJTbGVlcFRpbWVDaGFuZ2UgPSAoZSkgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgY3Jhd2xlclNsZWVwVGltZTogZS50YXJnZXQudmFsdWUgfSk7XG4gICAgICAgIFNldHRpbmdzU3RvcmUuc2V0VmFsdWUoXCJjcmF3bGVyU2xlZXBUaW1lXCIsIG51bGwsIFNldHRpbmdMZXZlbC5ERVZJQ0UsIGUudGFyZ2V0LnZhbHVlKTtcbiAgICB9O1xuXG4gICAgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCBicmFuZCA9IFNka0NvbmZpZy5nZXQoKS5icmFuZDtcblxuICAgICAgICBsZXQgY3Jhd2xlclN0YXRlO1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5jdXJyZW50Um9vbSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgY3Jhd2xlclN0YXRlID0gX3QoXCJOb3QgY3VycmVudGx5IGluZGV4aW5nIG1lc3NhZ2VzIGZvciBhbnkgcm9vbS5cIik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjcmF3bGVyU3RhdGUgPSAoXG4gICAgICAgICAgICAgICAgX3QoXCJDdXJyZW50bHkgaW5kZXhpbmc6ICUoY3VycmVudFJvb20pc1wiLCB7IGN1cnJlbnRSb29tOiB0aGlzLnN0YXRlLmN1cnJlbnRSb29tIH0pXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZG9uZVJvb21zID0gTWF0aC5tYXgoMCwgKHRoaXMuc3RhdGUucm9vbUNvdW50IC0gdGhpcy5zdGF0ZS5jcmF3bGluZ1Jvb21zQ291bnQpKTtcblxuICAgICAgICBjb25zdCBldmVudEluZGV4aW5nU2V0dGluZ3MgPSAoXG4gICAgICAgICAgICA8ZGl2PlxuICAgICAgICAgICAgICAgIHsgX3QoXG4gICAgICAgICAgICAgICAgICAgIFwiJShicmFuZClzIGlzIHNlY3VyZWx5IGNhY2hpbmcgZW5jcnlwdGVkIG1lc3NhZ2VzIGxvY2FsbHkgZm9yIHRoZW0gXCIgK1xuICAgICAgICAgICAgICAgICAgICBcInRvIGFwcGVhciBpbiBzZWFyY2ggcmVzdWx0czpcIixcbiAgICAgICAgICAgICAgICAgICAgeyBicmFuZCB9LFxuICAgICAgICAgICAgICAgICkgfVxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdteF9TZXR0aW5nc1RhYl9zdWJzZWN0aW9uVGV4dCc+XG4gICAgICAgICAgICAgICAgICAgIHsgY3Jhd2xlclN0YXRlIH08YnIgLz5cbiAgICAgICAgICAgICAgICAgICAgeyBfdChcIlNwYWNlIHVzZWQ6XCIpIH0geyBmb3JtYXRCeXRlcyh0aGlzLnN0YXRlLmV2ZW50SW5kZXhTaXplLCAwKSB9PGJyIC8+XG4gICAgICAgICAgICAgICAgICAgIHsgX3QoXCJJbmRleGVkIG1lc3NhZ2VzOlwiKSB9IHsgZm9ybWF0Q291bnRMb25nKHRoaXMuc3RhdGUuZXZlbnRDb3VudCkgfTxiciAvPlxuICAgICAgICAgICAgICAgICAgICB7IF90KFwiSW5kZXhlZCByb29tczpcIikgfSB7IF90KFwiJShkb25lUm9vbXMpcyBvdXQgb2YgJSh0b3RhbFJvb21zKXNcIiwge1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9uZVJvb21zOiBmb3JtYXRDb3VudExvbmcoZG9uZVJvb21zKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsUm9vbXM6IGZvcm1hdENvdW50TG9uZyh0aGlzLnN0YXRlLnJvb21Db3VudCksXG4gICAgICAgICAgICAgICAgICAgIH0pIH0gPGJyIC8+XG4gICAgICAgICAgICAgICAgICAgIDxGaWVsZFxuICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw9e190KCdNZXNzYWdlIGRvd25sb2FkaW5nIHNsZWVwIHRpbWUobXMpJyl9XG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlPSdudW1iZXInXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZT17dGhpcy5zdGF0ZS5jcmF3bGVyU2xlZXBUaW1lLnRvU3RyaW5nKCl9XG4gICAgICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZT17dGhpcy5vbkNyYXdsZXJTbGVlcFRpbWVDaGFuZ2V9IC8+XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKTtcblxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPEJhc2VEaWFsb2cgY2xhc3NOYW1lPSdteF9NYW5hZ2VFdmVudEluZGV4RGlhbG9nJ1xuICAgICAgICAgICAgICAgIG9uRmluaXNoZWQ9e3RoaXMucHJvcHMub25GaW5pc2hlZH1cbiAgICAgICAgICAgICAgICB0aXRsZT17X3QoXCJNZXNzYWdlIHNlYXJjaFwiKX1cbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICB7IGV2ZW50SW5kZXhpbmdTZXR0aW5ncyB9XG4gICAgICAgICAgICAgICAgPERpYWxvZ0J1dHRvbnNcbiAgICAgICAgICAgICAgICAgICAgcHJpbWFyeUJ1dHRvbj17X3QoXCJEb25lXCIpfVxuICAgICAgICAgICAgICAgICAgICBvblByaW1hcnlCdXR0b25DbGljaz17dGhpcy5wcm9wcy5vbkZpbmlzaGVkfVxuICAgICAgICAgICAgICAgICAgICBwcmltYXJ5QnV0dG9uQ2xhc3M9XCJwcmltYXJ5XCJcbiAgICAgICAgICAgICAgICAgICAgY2FuY2VsQnV0dG9uPXtfdChcIkRpc2FibGVcIil9XG4gICAgICAgICAgICAgICAgICAgIG9uQ2FuY2VsPXt0aGlzLm9uRGlzYWJsZX1cbiAgICAgICAgICAgICAgICAgICAgY2FuY2VsQnV0dG9uQ2xhc3M9XCJkYW5nZXJcIlxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICA8L0Jhc2VEaWFsb2c+XG4gICAgICAgICk7XG4gICAgfVxufVxuIl19