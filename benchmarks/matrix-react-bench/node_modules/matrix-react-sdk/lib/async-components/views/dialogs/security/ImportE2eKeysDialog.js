"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var MegolmExportEncryption = _interopRequireWildcard(require("../../../../utils/MegolmExportEncryption"));

var _languageHandler = require("../../../../languageHandler");

var _BaseDialog = _interopRequireDefault(require("../../../../components/views/dialogs/BaseDialog"));

var _logger = require("matrix-js-sdk/src/logger");

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/*
Copyright 2017 Vector Creations Ltd

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
function readFileAsArrayBuffer(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = e => {
      resolve(e.target.result);
    };

    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
}

var Phase;

(function (Phase) {
  Phase["Edit"] = "edit";
  Phase["Importing"] = "importing";
})(Phase || (Phase = {}));

class ImportE2eKeysDialog extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "unmounted", false);
    (0, _defineProperty2.default)(this, "file", /*#__PURE__*/(0, _react.createRef)());
    (0, _defineProperty2.default)(this, "passphrase", /*#__PURE__*/(0, _react.createRef)());
    (0, _defineProperty2.default)(this, "onFormChange", ev => {
      const files = this.file.current.files || [];
      this.setState({
        enableSubmit: this.passphrase.current.value !== "" && files.length > 0
      });
    });
    (0, _defineProperty2.default)(this, "onFormSubmit", ev => {
      ev.preventDefault();
      this.startImport(this.file.current.files[0], this.passphrase.current.value);
      return false;
    });
    (0, _defineProperty2.default)(this, "onCancelClick", ev => {
      ev.preventDefault();
      this.props.onFinished(false);
      return false;
    });
    this.state = {
      enableSubmit: false,
      phase: Phase.Edit,
      errStr: null
    };
  }

  componentWillUnmount() {
    this.unmounted = true;
  }

  startImport(file, passphrase) {
    this.setState({
      errStr: null,
      phase: Phase.Importing
    });
    return readFileAsArrayBuffer(file).then(arrayBuffer => {
      return MegolmExportEncryption.decryptMegolmKeyFile(arrayBuffer, passphrase);
    }).then(keys => {
      return this.props.matrixClient.importRoomKeys(JSON.parse(keys));
    }).then(() => {
      // TODO: it would probably be nice to give some feedback about what we've imported here.
      this.props.onFinished(true);
    }).catch(e => {
      _logger.logger.error("Error importing e2e keys:", e);

      if (this.unmounted) {
        return;
      }

      const msg = e.friendlyText || (0, _languageHandler._t)('Unknown error');
      this.setState({
        errStr: msg,
        phase: Phase.Edit
      });
    });
  }

  render() {
    const disableForm = this.state.phase !== Phase.Edit;
    return /*#__PURE__*/_react.default.createElement(_BaseDialog.default, {
      className: "mx_importE2eKeysDialog",
      onFinished: this.props.onFinished,
      title: (0, _languageHandler._t)("Import room keys")
    }, /*#__PURE__*/_react.default.createElement("form", {
      onSubmit: this.onFormSubmit
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_Dialog_content"
    }, /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)('This process allows you to import encryption keys ' + 'that you had previously exported from another Matrix ' + 'client. You will then be able to decrypt any ' + 'messages that the other client could decrypt.')), /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)('The export file will be protected with a passphrase. ' + 'You should enter the passphrase here, to decrypt the file.')), /*#__PURE__*/_react.default.createElement("div", {
      className: "error"
    }, this.state.errStr), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_E2eKeysDialog_inputTable"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_E2eKeysDialog_inputRow"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_E2eKeysDialog_inputLabel"
    }, /*#__PURE__*/_react.default.createElement("label", {
      htmlFor: "importFile"
    }, (0, _languageHandler._t)("File to import"))), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_E2eKeysDialog_inputCell"
    }, /*#__PURE__*/_react.default.createElement("input", {
      ref: this.file,
      id: "importFile",
      type: "file",
      autoFocus: true,
      onChange: this.onFormChange,
      disabled: disableForm
    }))), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_E2eKeysDialog_inputRow"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_E2eKeysDialog_inputLabel"
    }, /*#__PURE__*/_react.default.createElement("label", {
      htmlFor: "passphrase"
    }, (0, _languageHandler._t)("Enter passphrase"))), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_E2eKeysDialog_inputCell"
    }, /*#__PURE__*/_react.default.createElement("input", {
      ref: this.passphrase,
      id: "passphrase",
      size: 64,
      type: "password",
      onChange: this.onFormChange,
      disabled: disableForm
    }))))), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_Dialog_buttons"
    }, /*#__PURE__*/_react.default.createElement("input", {
      className: "mx_Dialog_primary",
      type: "submit",
      value: (0, _languageHandler._t)('Import'),
      disabled: !this.state.enableSubmit || disableForm
    }), /*#__PURE__*/_react.default.createElement("button", {
      onClick: this.onCancelClick,
      disabled: disableForm
    }, (0, _languageHandler._t)("Cancel")))));
  }

}

exports.default = ImportE2eKeysDialog;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9hc3luYy1jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3Mvc2VjdXJpdHkvSW1wb3J0RTJlS2V5c0RpYWxvZy50c3giXSwibmFtZXMiOlsicmVhZEZpbGVBc0FycmF5QnVmZmVyIiwiZmlsZSIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwicmVhZGVyIiwiRmlsZVJlYWRlciIsIm9ubG9hZCIsImUiLCJ0YXJnZXQiLCJyZXN1bHQiLCJvbmVycm9yIiwicmVhZEFzQXJyYXlCdWZmZXIiLCJQaGFzZSIsIkltcG9ydEUyZUtleXNEaWFsb2ciLCJSZWFjdCIsIkNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJldiIsImZpbGVzIiwiY3VycmVudCIsInNldFN0YXRlIiwiZW5hYmxlU3VibWl0IiwicGFzc3BocmFzZSIsInZhbHVlIiwibGVuZ3RoIiwicHJldmVudERlZmF1bHQiLCJzdGFydEltcG9ydCIsIm9uRmluaXNoZWQiLCJzdGF0ZSIsInBoYXNlIiwiRWRpdCIsImVyclN0ciIsImNvbXBvbmVudFdpbGxVbm1vdW50IiwidW5tb3VudGVkIiwiSW1wb3J0aW5nIiwidGhlbiIsImFycmF5QnVmZmVyIiwiTWVnb2xtRXhwb3J0RW5jcnlwdGlvbiIsImRlY3J5cHRNZWdvbG1LZXlGaWxlIiwia2V5cyIsIm1hdHJpeENsaWVudCIsImltcG9ydFJvb21LZXlzIiwiSlNPTiIsInBhcnNlIiwiY2F0Y2giLCJsb2dnZXIiLCJlcnJvciIsIm1zZyIsImZyaWVuZGx5VGV4dCIsInJlbmRlciIsImRpc2FibGVGb3JtIiwib25Gb3JtU3VibWl0Iiwib25Gb3JtQ2hhbmdlIiwib25DYW5jZWxDbGljayJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFnQkE7O0FBR0E7O0FBQ0E7O0FBRUE7O0FBQ0E7Ozs7OztBQXZCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtB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bnQiOlsiLypcbkNvcHlyaWdodCAyMDE3IFZlY3RvciBDcmVhdGlvbnMgTHRkXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0LCB7IGNyZWF0ZVJlZiB9IGZyb20gJ3JlYWN0JztcblxuaW1wb3J0IHsgTWF0cml4Q2xpZW50IH0gZnJvbSAnbWF0cml4LWpzLXNkay9zcmMvY2xpZW50JztcbmltcG9ydCAqIGFzIE1lZ29sbUV4cG9ydEVuY3J5cHRpb24gZnJvbSAnLi4vLi4vLi4vLi4vdXRpbHMvTWVnb2xtRXhwb3J0RW5jcnlwdGlvbic7XG5pbXBvcnQgeyBfdCB9IGZyb20gJy4uLy4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlcic7XG5pbXBvcnQgeyBJRGlhbG9nUHJvcHMgfSBmcm9tIFwiLi4vLi4vLi4vLi4vY29tcG9uZW50cy92aWV3cy9kaWFsb2dzL0lEaWFsb2dQcm9wc1wiO1xuaW1wb3J0IEJhc2VEaWFsb2cgZnJvbSBcIi4uLy4uLy4uLy4uL2NvbXBvbmVudHMvdmlld3MvZGlhbG9ncy9CYXNlRGlhbG9nXCI7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbG9nZ2VyXCI7XG5cbmZ1bmN0aW9uIHJlYWRGaWxlQXNBcnJheUJ1ZmZlcihmaWxlOiBGaWxlKTogUHJvbWlzZTxBcnJheUJ1ZmZlcj4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGNvbnN0IHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XG4gICAgICAgIHJlYWRlci5vbmxvYWQgPSAoZSkgPT4ge1xuICAgICAgICAgICAgcmVzb2x2ZShlLnRhcmdldC5yZXN1bHQgYXMgQXJyYXlCdWZmZXIpO1xuICAgICAgICB9O1xuICAgICAgICByZWFkZXIub25lcnJvciA9IHJlamVjdDtcblxuICAgICAgICByZWFkZXIucmVhZEFzQXJyYXlCdWZmZXIoZmlsZSk7XG4gICAgfSk7XG59XG5cbmVudW0gUGhhc2Uge1xuICAgIEVkaXQgPSBcImVkaXRcIixcbiAgICBJbXBvcnRpbmcgPSBcImltcG9ydGluZ1wiLFxufVxuXG5pbnRlcmZhY2UgSVByb3BzIGV4dGVuZHMgSURpYWxvZ1Byb3BzIHtcbiAgICBtYXRyaXhDbGllbnQ6IE1hdHJpeENsaWVudDtcbn1cblxuaW50ZXJmYWNlIElTdGF0ZSB7XG4gICAgZW5hYmxlU3VibWl0OiBib29sZWFuO1xuICAgIHBoYXNlOiBQaGFzZTtcbiAgICBlcnJTdHI6IHN0cmluZztcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSW1wb3J0RTJlS2V5c0RpYWxvZyBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxJUHJvcHMsIElTdGF0ZT4ge1xuICAgIHByaXZhdGUgdW5tb3VudGVkID0gZmFsc2U7XG4gICAgcHJpdmF0ZSBmaWxlID0gY3JlYXRlUmVmPEhUTUxJbnB1dEVsZW1lbnQ+KCk7XG4gICAgcHJpdmF0ZSBwYXNzcGhyYXNlID0gY3JlYXRlUmVmPEhUTUxJbnB1dEVsZW1lbnQ+KCk7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wczogSVByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgZW5hYmxlU3VibWl0OiBmYWxzZSxcbiAgICAgICAgICAgIHBoYXNlOiBQaGFzZS5FZGl0LFxuICAgICAgICAgICAgZXJyU3RyOiBudWxsLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHB1YmxpYyBjb21wb25lbnRXaWxsVW5tb3VudCgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy51bm1vdW50ZWQgPSB0cnVlO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25Gb3JtQ2hhbmdlID0gKGV2OiBSZWFjdC5Gb3JtRXZlbnQpOiB2b2lkID0+IHtcbiAgICAgICAgY29uc3QgZmlsZXMgPSB0aGlzLmZpbGUuY3VycmVudC5maWxlcyB8fCBbXTtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBlbmFibGVTdWJtaXQ6ICh0aGlzLnBhc3NwaHJhc2UuY3VycmVudC52YWx1ZSAhPT0gXCJcIiAmJiBmaWxlcy5sZW5ndGggPiAwKSxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25Gb3JtU3VibWl0ID0gKGV2OiBSZWFjdC5Gb3JtRXZlbnQpOiBib29sZWFuID0+IHtcbiAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgdGhpcy5zdGFydEltcG9ydCh0aGlzLmZpbGUuY3VycmVudC5maWxlc1swXSwgdGhpcy5wYXNzcGhyYXNlLmN1cnJlbnQudmFsdWUpO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfTtcblxuICAgIHByaXZhdGUgc3RhcnRJbXBvcnQoZmlsZTogRmlsZSwgcGFzc3BocmFzZTogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgZXJyU3RyOiBudWxsLFxuICAgICAgICAgICAgcGhhc2U6IFBoYXNlLkltcG9ydGluZyxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHJlYWRGaWxlQXNBcnJheUJ1ZmZlcihmaWxlKS50aGVuKChhcnJheUJ1ZmZlcikgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIE1lZ29sbUV4cG9ydEVuY3J5cHRpb24uZGVjcnlwdE1lZ29sbUtleUZpbGUoXG4gICAgICAgICAgICAgICAgYXJyYXlCdWZmZXIsIHBhc3NwaHJhc2UsXG4gICAgICAgICAgICApO1xuICAgICAgICB9KS50aGVuKChrZXlzKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5wcm9wcy5tYXRyaXhDbGllbnQuaW1wb3J0Um9vbUtleXMoSlNPTi5wYXJzZShrZXlzKSk7XG4gICAgICAgIH0pLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgLy8gVE9ETzogaXQgd291bGQgcHJvYmFibHkgYmUgbmljZSB0byBnaXZlIHNvbWUgZmVlZGJhY2sgYWJvdXQgd2hhdCB3ZSd2ZSBpbXBvcnRlZCBoZXJlLlxuICAgICAgICAgICAgdGhpcy5wcm9wcy5vbkZpbmlzaGVkKHRydWUpO1xuICAgICAgICB9KS5jYXRjaCgoZSkgPT4ge1xuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKFwiRXJyb3IgaW1wb3J0aW5nIGUyZSBrZXlzOlwiLCBlKTtcbiAgICAgICAgICAgIGlmICh0aGlzLnVubW91bnRlZCkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IG1zZyA9IGUuZnJpZW5kbHlUZXh0IHx8IF90KCdVbmtub3duIGVycm9yJyk7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICBlcnJTdHI6IG1zZyxcbiAgICAgICAgICAgICAgICBwaGFzZTogUGhhc2UuRWRpdCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uQ2FuY2VsQ2xpY2sgPSAoZXY6IFJlYWN0Lk1vdXNlRXZlbnQpOiBib29sZWFuID0+IHtcbiAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgdGhpcy5wcm9wcy5vbkZpbmlzaGVkKGZhbHNlKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH07XG5cbiAgICBwdWJsaWMgcmVuZGVyKCk6IEpTWC5FbGVtZW50IHtcbiAgICAgICAgY29uc3QgZGlzYWJsZUZvcm0gPSAodGhpcy5zdGF0ZS5waGFzZSAhPT0gUGhhc2UuRWRpdCk7XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxCYXNlRGlhbG9nIGNsYXNzTmFtZT0nbXhfaW1wb3J0RTJlS2V5c0RpYWxvZydcbiAgICAgICAgICAgICAgICBvbkZpbmlzaGVkPXt0aGlzLnByb3BzLm9uRmluaXNoZWR9XG4gICAgICAgICAgICAgICAgdGl0bGU9e190KFwiSW1wb3J0IHJvb20ga2V5c1wiKX1cbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICA8Zm9ybSBvblN1Ym1pdD17dGhpcy5vbkZvcm1TdWJtaXR9PlxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0RpYWxvZ19jb250ZW50XCI+XG4gICAgICAgICAgICAgICAgICAgICAgICA8cD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IF90KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnVGhpcyBwcm9jZXNzIGFsbG93cyB5b3UgdG8gaW1wb3J0IGVuY3J5cHRpb24ga2V5cyAnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3RoYXQgeW91IGhhZCBwcmV2aW91c2x5IGV4cG9ydGVkIGZyb20gYW5vdGhlciBNYXRyaXggJyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdjbGllbnQuIFlvdSB3aWxsIHRoZW4gYmUgYWJsZSB0byBkZWNyeXB0IGFueSAnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2VzIHRoYXQgdGhlIG90aGVyIGNsaWVudCBjb3VsZCBkZWNyeXB0LicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKSB9XG4gICAgICAgICAgICAgICAgICAgICAgICA8L3A+XG4gICAgICAgICAgICAgICAgICAgICAgICA8cD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IF90KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnVGhlIGV4cG9ydCBmaWxlIHdpbGwgYmUgcHJvdGVjdGVkIHdpdGggYSBwYXNzcGhyYXNlLiAnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ1lvdSBzaG91bGQgZW50ZXIgdGhlIHBhc3NwaHJhc2UgaGVyZSwgdG8gZGVjcnlwdCB0aGUgZmlsZS4nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgfVxuICAgICAgICAgICAgICAgICAgICAgICAgPC9wPlxuICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J2Vycm9yJz5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IHRoaXMuc3RhdGUuZXJyU3RyIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J214X0UyZUtleXNEaWFsb2dfaW5wdXRUYWJsZSc+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J214X0UyZUtleXNEaWFsb2dfaW5wdXRSb3cnPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nbXhfRTJlS2V5c0RpYWxvZ19pbnB1dExhYmVsJz5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxsYWJlbCBodG1sRm9yPSdpbXBvcnRGaWxlJz5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IF90KFwiRmlsZSB0byBpbXBvcnRcIikgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9sYWJlbD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdteF9FMmVLZXlzRGlhbG9nX2lucHV0Q2VsbCc+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8aW5wdXRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWY9e3RoaXMuZmlsZX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZD0naW1wb3J0RmlsZSdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlPSdmaWxlJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1dG9Gb2N1cz17dHJ1ZX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZT17dGhpcy5vbkZvcm1DaGFuZ2V9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWQ9e2Rpc2FibGVGb3JtfSAvPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nbXhfRTJlS2V5c0RpYWxvZ19pbnB1dFJvdyc+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdteF9FMmVLZXlzRGlhbG9nX2lucHV0TGFiZWwnPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGxhYmVsIGh0bWxGb3I9J3Bhc3NwaHJhc2UnPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCJFbnRlciBwYXNzcGhyYXNlXCIpIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvbGFiZWw+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nbXhfRTJlS2V5c0RpYWxvZ19pbnB1dENlbGwnPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmPXt0aGlzLnBhc3NwaHJhc2V9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ9J3Bhc3NwaHJhc2UnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZT17NjR9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZT0ncGFzc3dvcmQnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2U9e3RoaXMub25Gb3JtQ2hhbmdlfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVkPXtkaXNhYmxlRm9ybX0gLz5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdteF9EaWFsb2dfYnV0dG9ucyc+XG4gICAgICAgICAgICAgICAgICAgICAgICA8aW5wdXRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9J214X0RpYWxvZ19wcmltYXJ5J1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU9J3N1Ym1pdCdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZT17X3QoJ0ltcG9ydCcpfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVkPXshdGhpcy5zdGF0ZS5lbmFibGVTdWJtaXQgfHwgZGlzYWJsZUZvcm19XG4gICAgICAgICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBvbkNsaWNrPXt0aGlzLm9uQ2FuY2VsQ2xpY2t9IGRpc2FibGVkPXtkaXNhYmxlRm9ybX0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIkNhbmNlbFwiKSB9XG4gICAgICAgICAgICAgICAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgPC9mb3JtPlxuICAgICAgICAgICAgPC9CYXNlRGlhbG9nPlxuICAgICAgICApO1xuICAgIH1cbn1cbiJdfQ==