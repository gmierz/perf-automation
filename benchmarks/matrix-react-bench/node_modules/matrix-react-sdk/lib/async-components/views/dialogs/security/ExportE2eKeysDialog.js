"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _fileSaver = _interopRequireDefault(require("file-saver"));

var _react = _interopRequireWildcard(require("react"));

var _languageHandler = require("../../../../languageHandler");

var MegolmExportEncryption = _interopRequireWildcard(require("../../../../utils/MegolmExportEncryption"));

var _BaseDialog = _interopRequireDefault(require("../../../../components/views/dialogs/BaseDialog"));

var _logger = require("matrix-js-sdk/src/logger");

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/*
Copyright 2017 Vector Creations Ltd

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
var Phase;

(function (Phase) {
  Phase["Edit"] = "edit";
  Phase["Exporting"] = "exporting";
})(Phase || (Phase = {}));

class ExportE2eKeysDialog extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "unmounted", false);
    (0, _defineProperty2.default)(this, "passphrase1", /*#__PURE__*/(0, _react.createRef)());
    (0, _defineProperty2.default)(this, "passphrase2", /*#__PURE__*/(0, _react.createRef)());
    (0, _defineProperty2.default)(this, "onPassphraseFormSubmit", ev => {
      ev.preventDefault();
      const passphrase = this.passphrase1.current.value;

      if (passphrase !== this.passphrase2.current.value) {
        this.setState({
          errStr: (0, _languageHandler._t)('Passphrases must match')
        });
        return false;
      }

      if (!passphrase) {
        this.setState({
          errStr: (0, _languageHandler._t)('Passphrase must not be empty')
        });
        return false;
      }

      this.startExport(passphrase);
      return false;
    });
    (0, _defineProperty2.default)(this, "onCancelClick", ev => {
      ev.preventDefault();
      this.props.onFinished(false);
      return false;
    });
    this.state = {
      phase: Phase.Edit,
      errStr: null
    };
  }

  componentWillUnmount() {
    this.unmounted = true;
  }

  startExport(passphrase) {
    // extra Promise.resolve() to turn synchronous exceptions into
    // asynchronous ones.
    Promise.resolve().then(() => {
      return this.props.matrixClient.exportRoomKeys();
    }).then(k => {
      return MegolmExportEncryption.encryptMegolmKeyFile(JSON.stringify(k), passphrase);
    }).then(f => {
      const blob = new Blob([f], {
        type: 'text/plain;charset=us-ascii'
      });

      _fileSaver.default.saveAs(blob, 'element-keys.txt');

      this.props.onFinished(true);
    }).catch(e => {
      _logger.logger.error("Error exporting e2e keys:", e);

      if (this.unmounted) {
        return;
      }

      const msg = e.friendlyText || (0, _languageHandler._t)('Unknown error');
      this.setState({
        errStr: msg,
        phase: Phase.Edit
      });
    });
    this.setState({
      errStr: null,
      phase: Phase.Exporting
    });
  }

  render() {
    const disableForm = this.state.phase === Phase.Exporting;
    return /*#__PURE__*/_react.default.createElement(_BaseDialog.default, {
      className: "mx_exportE2eKeysDialog",
      onFinished: this.props.onFinished,
      title: (0, _languageHandler._t)("Export room keys")
    }, /*#__PURE__*/_react.default.createElement("form", {
      onSubmit: this.onPassphraseFormSubmit
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_Dialog_content"
    }, /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)('This process allows you to export the keys for messages ' + 'you have received in encrypted rooms to a local file. You ' + 'will then be able to import the file into another Matrix ' + 'client in the future, so that client will also be able to ' + 'decrypt these messages.')), /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)('The exported file will allow anyone who can read it to decrypt ' + 'any encrypted messages that you can see, so you should be ' + 'careful to keep it secure. To help with this, you should enter ' + 'a passphrase below, which will be used to encrypt the exported ' + 'data. It will only be possible to import the data by using the ' + 'same passphrase.')), /*#__PURE__*/_react.default.createElement("div", {
      className: "error"
    }, this.state.errStr), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_E2eKeysDialog_inputTable"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_E2eKeysDialog_inputRow"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_E2eKeysDialog_inputLabel"
    }, /*#__PURE__*/_react.default.createElement("label", {
      htmlFor: "passphrase1"
    }, (0, _languageHandler._t)("Enter passphrase"))), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_E2eKeysDialog_inputCell"
    }, /*#__PURE__*/_react.default.createElement("input", {
      ref: this.passphrase1,
      id: "passphrase1",
      autoFocus: true,
      size: 64,
      type: "password",
      disabled: disableForm
    }))), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_E2eKeysDialog_inputRow"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_E2eKeysDialog_inputLabel"
    }, /*#__PURE__*/_react.default.createElement("label", {
      htmlFor: "passphrase2"
    }, (0, _languageHandler._t)("Confirm passphrase"))), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_E2eKeysDialog_inputCell"
    }, /*#__PURE__*/_react.default.createElement("input", {
      ref: this.passphrase2,
      id: "passphrase2",
      size: 64,
      type: "password",
      disabled: disableForm
    }))))), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_Dialog_buttons"
    }, /*#__PURE__*/_react.default.createElement("input", {
      className: "mx_Dialog_primary",
      type: "submit",
      value: (0, _languageHandler._t)('Export'),
      disabled: disableForm
    }), /*#__PURE__*/_react.default.createElement("button", {
      onClick: this.onCancelClick,
      disabled: disableForm
    }, (0, _languageHandler._t)("Cancel")))));
  }

}

exports.default = ExportE2eKeysDialog;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9hc3luYy1jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3Mvc2VjdXJpdHkvRXhwb3J0RTJlS2V5c0RpYWxvZy50c3giXSwibmFtZXMiOlsiUGhhc2UiLCJFeHBvcnRFMmVLZXlzRGlhbG9nIiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwiZXYiLCJwcmV2ZW50RGVmYXVsdCIsInBhc3NwaHJhc2UiLCJwYXNzcGhyYXNlMSIsImN1cnJlbnQiLCJ2YWx1ZSIsInBhc3NwaHJhc2UyIiwic2V0U3RhdGUiLCJlcnJTdHIiLCJzdGFydEV4cG9ydCIsIm9uRmluaXNoZWQiLCJzdGF0ZSIsInBoYXNlIiwiRWRpdCIsImNvbXBvbmVudFdpbGxVbm1vdW50IiwidW5tb3VudGVkIiwiUHJvbWlzZSIsInJlc29sdmUiLCJ0aGVuIiwibWF0cml4Q2xpZW50IiwiZXhwb3J0Um9vbUtleXMiLCJrIiwiTWVnb2xtRXhwb3J0RW5jcnlwdGlvbiIsImVuY3J5cHRNZWdvbG1LZXlGaWxlIiwiSlNPTiIsInN0cmluZ2lmeSIsImYiLCJibG9iIiwiQmxvYiIsInR5cGUiLCJGaWxlU2F2ZXIiLCJzYXZlQXMiLCJjYXRjaCIsImUiLCJsb2dnZXIiLCJlcnJvciIsIm1zZyIsImZyaWVuZGx5VGV4dCIsIkV4cG9ydGluZyIsInJlbmRlciIsImRpc2FibGVGb3JtIiwib25QYXNzcGhyYXNlRm9ybVN1Ym1pdCIsIm9uQ2FuY2VsQ2xpY2siXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUNBOztBQUNBOztBQUdBOztBQUVBOztBQUNBOzs7Ozs7QUF4QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0lBWUtBLEs7O1dBQUFBLEs7QUFBQUEsRUFBQUEsSztBQUFBQSxFQUFBQSxLO0dBQUFBLEssS0FBQUEsSzs7QUFjVSxNQUFNQyxtQkFBTixT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ZixPQUNNLHlCQUFHLG9CQUFILENBRE4sQ0FESixDQURKLGVBTUk7QUFBSyxNQUFBLFNBQVMsRUFBQztBQUFmLG9CQUNJO0FBQU8sTUFBQSxHQUFHLEVBQUUsS0FBS2xDLFdBQWpCO0FBQ0ksTUFBQSxFQUFFLEVBQUMsYUFEUDtBQUVJLE1BQUEsSUFBSSxFQUFFLEVBRlY7QUFHSSxNQUFBLElBQUksRUFBQyxVQUhUO0FBSUksTUFBQSxRQUFRLEVBQUVrQztBQUpkLE1BREosQ0FOSixDQWxCSixDQXZCSixDQURKLGVBMkRJO0FBQUssTUFBQSxTQUFTLEVBQUM7QUFBZixvQkFDSTtBQUNJLE1BQUEsU0FBUyxFQUFDLG1CQURkO0FBRUksTUFBQSxJQUFJLEVBQUMsUUFGVDtBQUdJLE1BQUEsS0FBSyxFQUFFLHlCQUFHLFFBQUgsQ0FIWDtBQUlJLE1BQUEsUUFBUSxFQUFFQTtBQUpkLE1BREosZUFPSTtBQUFRLE1BQUEsT0FBTyxFQUFFLEtBQUtFLGFBQXRCO0FBQXFDLE1BQUEsUUFBUSxFQUFFRjtBQUEvQyxPQUNNLHlCQUFHLFFBQUgsQ0FETixDQVBKLENBM0RKLENBSkosQ0FESjtBQThFSDs7QUEzSjRFIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE3IFZlY3RvciBDcmVhdGlvbnMgTHRkXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IEZpbGVTYXZlciBmcm9tICdmaWxlLXNhdmVyJztcbmltcG9ydCBSZWFjdCwgeyBjcmVhdGVSZWYgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBfdCB9IGZyb20gJy4uLy4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlcic7XG5cbmltcG9ydCB7IE1hdHJpeENsaWVudCB9IGZyb20gJ21hdHJpeC1qcy1zZGsvc3JjL2NsaWVudCc7XG5pbXBvcnQgKiBhcyBNZWdvbG1FeHBvcnRFbmNyeXB0aW9uIGZyb20gJy4uLy4uLy4uLy4uL3V0aWxzL01lZ29sbUV4cG9ydEVuY3J5cHRpb24nO1xuaW1wb3J0IHsgSURpYWxvZ1Byb3BzIH0gZnJvbSBcIi4uLy4uLy4uLy4uL2NvbXBvbmVudHMvdmlld3MvZGlhbG9ncy9JRGlhbG9nUHJvcHNcIjtcbmltcG9ydCBCYXNlRGlhbG9nIGZyb20gXCIuLi8uLi8uLi8uLi9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvQmFzZURpYWxvZ1wiO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2xvZ2dlclwiO1xuXG5lbnVtIFBoYXNlIHtcbiAgICBFZGl0ID0gXCJlZGl0XCIsXG4gICAgRXhwb3J0aW5nID0gXCJleHBvcnRpbmdcIixcbn1cblxuaW50ZXJmYWNlIElQcm9wcyBleHRlbmRzIElEaWFsb2dQcm9wcyB7XG4gICAgbWF0cml4Q2xpZW50OiBNYXRyaXhDbGllbnQ7XG59XG5cbmludGVyZmFjZSBJU3RhdGUge1xuICAgIHBoYXNlOiBQaGFzZTtcbiAgICBlcnJTdHI6IHN0cmluZztcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRXhwb3J0RTJlS2V5c0RpYWxvZyBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxJUHJvcHMsIElTdGF0ZT4ge1xuICAgIHByaXZhdGUgdW5tb3VudGVkID0gZmFsc2U7XG4gICAgcHJpdmF0ZSBwYXNzcGhyYXNlMSA9IGNyZWF0ZVJlZjxIVE1MSW5wdXRFbGVtZW50PigpO1xuICAgIHByaXZhdGUgcGFzc3BocmFzZTIgPSBjcmVhdGVSZWY8SFRNTElucHV0RWxlbWVudD4oKTtcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBJUHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuXG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICBwaGFzZTogUGhhc2UuRWRpdCxcbiAgICAgICAgICAgIGVyclN0cjogbnVsbCxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY29tcG9uZW50V2lsbFVubW91bnQoKTogdm9pZCB7XG4gICAgICAgIHRoaXMudW5tb3VudGVkID0gdHJ1ZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uUGFzc3BocmFzZUZvcm1TdWJtaXQgPSAoZXY6IFJlYWN0LkZvcm1FdmVudCk6IGJvb2xlYW4gPT4ge1xuICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAgIGNvbnN0IHBhc3NwaHJhc2UgPSB0aGlzLnBhc3NwaHJhc2UxLmN1cnJlbnQudmFsdWU7XG4gICAgICAgIGlmIChwYXNzcGhyYXNlICE9PSB0aGlzLnBhc3NwaHJhc2UyLmN1cnJlbnQudmFsdWUpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBlcnJTdHI6IF90KCdQYXNzcGhyYXNlcyBtdXN0IG1hdGNoJykgfSk7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFwYXNzcGhyYXNlKSB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgZXJyU3RyOiBfdCgnUGFzc3BocmFzZSBtdXN0IG5vdCBiZSBlbXB0eScpIH0pO1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zdGFydEV4cG9ydChwYXNzcGhyYXNlKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH07XG5cbiAgICBwcml2YXRlIHN0YXJ0RXhwb3J0KHBhc3NwaHJhc2U6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICAvLyBleHRyYSBQcm9taXNlLnJlc29sdmUoKSB0byB0dXJuIHN5bmNocm9ub3VzIGV4Y2VwdGlvbnMgaW50b1xuICAgICAgICAvLyBhc3luY2hyb25vdXMgb25lcy5cbiAgICAgICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5wcm9wcy5tYXRyaXhDbGllbnQuZXhwb3J0Um9vbUtleXMoKTtcbiAgICAgICAgfSkudGhlbigoaykgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIE1lZ29sbUV4cG9ydEVuY3J5cHRpb24uZW5jcnlwdE1lZ29sbUtleUZpbGUoXG4gICAgICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkoayksIHBhc3NwaHJhc2UsXG4gICAgICAgICAgICApO1xuICAgICAgICB9KS50aGVuKChmKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBibG9iID0gbmV3IEJsb2IoW2ZdLCB7XG4gICAgICAgICAgICAgICAgdHlwZTogJ3RleHQvcGxhaW47Y2hhcnNldD11cy1hc2NpaScsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIEZpbGVTYXZlci5zYXZlQXMoYmxvYiwgJ2VsZW1lbnQta2V5cy50eHQnKTtcbiAgICAgICAgICAgIHRoaXMucHJvcHMub25GaW5pc2hlZCh0cnVlKTtcbiAgICAgICAgfSkuY2F0Y2goKGUpID0+IHtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihcIkVycm9yIGV4cG9ydGluZyBlMmUga2V5czpcIiwgZSk7XG4gICAgICAgICAgICBpZiAodGhpcy51bm1vdW50ZWQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBtc2cgPSBlLmZyaWVuZGx5VGV4dCB8fCBfdCgnVW5rbm93biBlcnJvcicpO1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgZXJyU3RyOiBtc2csXG4gICAgICAgICAgICAgICAgcGhhc2U6IFBoYXNlLkVkaXQsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBlcnJTdHI6IG51bGwsXG4gICAgICAgICAgICBwaGFzZTogUGhhc2UuRXhwb3J0aW5nLFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uQ2FuY2VsQ2xpY2sgPSAoZXY6IFJlYWN0Lk1vdXNlRXZlbnQpOiBib29sZWFuID0+IHtcbiAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgdGhpcy5wcm9wcy5vbkZpbmlzaGVkKGZhbHNlKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH07XG5cbiAgICBwdWJsaWMgcmVuZGVyKCk6IEpTWC5FbGVtZW50IHtcbiAgICAgICAgY29uc3QgZGlzYWJsZUZvcm0gPSAodGhpcy5zdGF0ZS5waGFzZSA9PT0gUGhhc2UuRXhwb3J0aW5nKTtcblxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPEJhc2VEaWFsb2cgY2xhc3NOYW1lPSdteF9leHBvcnRFMmVLZXlzRGlhbG9nJ1xuICAgICAgICAgICAgICAgIG9uRmluaXNoZWQ9e3RoaXMucHJvcHMub25GaW5pc2hlZH1cbiAgICAgICAgICAgICAgICB0aXRsZT17X3QoXCJFeHBvcnQgcm9vbSBrZXlzXCIpfVxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgIDxmb3JtIG9uU3VibWl0PXt0aGlzLm9uUGFzc3BocmFzZUZvcm1TdWJtaXR9PlxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0RpYWxvZ19jb250ZW50XCI+XG4gICAgICAgICAgICAgICAgICAgICAgICA8cD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IF90KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnVGhpcyBwcm9jZXNzIGFsbG93cyB5b3UgdG8gZXhwb3J0IHRoZSBrZXlzIGZvciBtZXNzYWdlcyAnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3lvdSBoYXZlIHJlY2VpdmVkIGluIGVuY3J5cHRlZCByb29tcyB0byBhIGxvY2FsIGZpbGUuIFlvdSAnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3dpbGwgdGhlbiBiZSBhYmxlIHRvIGltcG9ydCB0aGUgZmlsZSBpbnRvIGFub3RoZXIgTWF0cml4ICcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnY2xpZW50IGluIHRoZSBmdXR1cmUsIHNvIHRoYXQgY2xpZW50IHdpbGwgYWxzbyBiZSBhYmxlIHRvICcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZGVjcnlwdCB0aGVzZSBtZXNzYWdlcy4nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgfVxuICAgICAgICAgICAgICAgICAgICAgICAgPC9wPlxuICAgICAgICAgICAgICAgICAgICAgICAgPHA+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ1RoZSBleHBvcnRlZCBmaWxlIHdpbGwgYWxsb3cgYW55b25lIHdobyBjYW4gcmVhZCBpdCB0byBkZWNyeXB0ICcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYW55IGVuY3J5cHRlZCBtZXNzYWdlcyB0aGF0IHlvdSBjYW4gc2VlLCBzbyB5b3Ugc2hvdWxkIGJlICcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnY2FyZWZ1bCB0byBrZWVwIGl0IHNlY3VyZS4gVG8gaGVscCB3aXRoIHRoaXMsIHlvdSBzaG91bGQgZW50ZXIgJyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdhIHBhc3NwaHJhc2UgYmVsb3csIHdoaWNoIHdpbGwgYmUgdXNlZCB0byBlbmNyeXB0IHRoZSBleHBvcnRlZCAnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2RhdGEuIEl0IHdpbGwgb25seSBiZSBwb3NzaWJsZSB0byBpbXBvcnQgdGhlIGRhdGEgYnkgdXNpbmcgdGhlICcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc2FtZSBwYXNzcGhyYXNlLicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKSB9XG4gICAgICAgICAgICAgICAgICAgICAgICA8L3A+XG4gICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nZXJyb3InPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgdGhpcy5zdGF0ZS5lcnJTdHIgfVxuICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nbXhfRTJlS2V5c0RpYWxvZ19pbnB1dFRhYmxlJz5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nbXhfRTJlS2V5c0RpYWxvZ19pbnB1dFJvdyc+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdteF9FMmVLZXlzRGlhbG9nX2lucHV0TGFiZWwnPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGxhYmVsIGh0bWxGb3I9J3Bhc3NwaHJhc2UxJz5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IF90KFwiRW50ZXIgcGFzc3BocmFzZVwiKSB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2xhYmVsPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J214X0UyZUtleXNEaWFsb2dfaW5wdXRDZWxsJz5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZj17dGhpcy5wYXNzcGhyYXNlMX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZD0ncGFzc3BocmFzZTEnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXV0b0ZvY3VzPXt0cnVlfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpemU9ezY0fVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU9J3Bhc3N3b3JkJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVkPXtkaXNhYmxlRm9ybX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdteF9FMmVLZXlzRGlhbG9nX2lucHV0Um93Jz5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J214X0UyZUtleXNEaWFsb2dfaW5wdXRMYWJlbCc+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8bGFiZWwgaHRtbEZvcj0ncGFzc3BocmFzZTInPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCJDb25maXJtIHBhc3NwaHJhc2VcIikgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9sYWJlbD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdteF9FMmVLZXlzRGlhbG9nX2lucHV0Q2VsbCc+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8aW5wdXQgcmVmPXt0aGlzLnBhc3NwaHJhc2UyfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkPSdwYXNzcGhyYXNlMidcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaXplPXs2NH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlPSdwYXNzd29yZCdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZD17ZGlzYWJsZUZvcm19XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J214X0RpYWxvZ19idXR0b25zJz5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0nbXhfRGlhbG9nX3ByaW1hcnknXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZT0nc3VibWl0J1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlPXtfdCgnRXhwb3J0Jyl9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWQ9e2Rpc2FibGVGb3JtfVxuICAgICAgICAgICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxidXR0b24gb25DbGljaz17dGhpcy5vbkNhbmNlbENsaWNrfSBkaXNhYmxlZD17ZGlzYWJsZUZvcm19PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCJDYW5jZWxcIikgfVxuICAgICAgICAgICAgICAgICAgICAgICAgPC9idXR0b24+XG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgIDwvZm9ybT5cbiAgICAgICAgICAgIDwvQmFzZURpYWxvZz5cbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=