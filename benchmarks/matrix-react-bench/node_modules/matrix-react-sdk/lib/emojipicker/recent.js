"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.add = add;
exports.get = get;

var _SettingsStore = _interopRequireDefault(require("../settings/SettingsStore"));

var _lodash = require("lodash");

var _SettingLevel = require("../settings/SettingLevel");

/*
Copyright 2019 Tulir Asokan <tulir@maunium.net>
Copyright 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
// [emoji, count]
const SETTING_NAME = "recent_emoji"; // we store more recents than we typically query but this lets us sort by weighted usage
// even if you haven't used your typically favourite emoji for a little while.

const STORAGE_LIMIT = 100; // TODO remove this after some time

function migrate() {
  const data = JSON.parse(window.localStorage.mx_reaction_count || '{}');
  const sorted = Object.entries(data).sort(([, [count1, date1]], [, [count2, date2]]) => date2 - date1);
  const newFormat = sorted.map(([emoji, [count, date]]) => [emoji, count]);

  _SettingsStore.default.setValue(SETTING_NAME, null, _SettingLevel.SettingLevel.ACCOUNT, newFormat.slice(0, STORAGE_LIMIT));
}

function getRecentEmoji() {
  return _SettingsStore.default.getValue(SETTING_NAME) || [];
}

function add(emoji) {
  const recents = getRecentEmoji();
  const i = recents.findIndex(([e]) => e === emoji);
  let newEntry;

  if (i >= 0) {
    // first remove the existing tuple so that we can increment it and push it to the front
    [newEntry] = recents.splice(i, 1);
    newEntry[1]++; // increment the usage count
  } else {
    newEntry = [emoji, 1];
  }

  _SettingsStore.default.setValue(SETTING_NAME, null, _SettingLevel.SettingLevel.ACCOUNT, [newEntry, ...recents].slice(0, STORAGE_LIMIT));
}

function get(limit = 24) {
  let recents = getRecentEmoji();

  if (recents.length < 1) {
    migrate();
    recents = getRecentEmoji();
  } // perform a stable sort on `count` to keep the recent (date) order as a secondary sort factor


  const sorted = (0, _lodash.orderBy)(recents, "1", "desc");
  return sorted.slice(0, limit).map(([emoji]) => emoji);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lbW9qaXBpY2tlci9yZWNlbnQudHMiXSwibmFtZXMiOlsiU0VUVElOR19OQU1FIiwiU1RPUkFHRV9MSU1JVCIsIm1pZ3JhdGUiLCJkYXRhIiwiSlNPTiIsInBhcnNlIiwid2luZG93IiwibG9jYWxTdG9yYWdlIiwibXhfcmVhY3Rpb25fY291bnQiLCJzb3J0ZWQiLCJPYmplY3QiLCJlbnRyaWVzIiwic29ydCIsImNvdW50MSIsImRhdGUxIiwiY291bnQyIiwiZGF0ZTIiLCJuZXdGb3JtYXQiLCJtYXAiLCJlbW9qaSIsImNvdW50IiwiZGF0ZSIsIlNldHRpbmdzU3RvcmUiLCJzZXRWYWx1ZSIsIlNldHRpbmdMZXZlbCIsIkFDQ09VTlQiLCJzbGljZSIsImdldFJlY2VudEVtb2ppIiwiZ2V0VmFsdWUiLCJhZGQiLCJyZWNlbnRzIiwiaSIsImZpbmRJbmRleCIsImUiLCJuZXdFbnRyeSIsInNwbGljZSIsImdldCIsImxpbWl0IiwibGVuZ3RoIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBaUJBOztBQUNBOztBQUNBOztBQW5CQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQVdrQztBQUVsQyxNQUFNQSxZQUFZLEdBQUcsY0FBckIsQyxDQUVBO0FBQ0E7O0FBQ0EsTUFBTUMsYUFBYSxHQUFHLEdBQXRCLEMsQ0FFQTs7QUFDQSxTQUFTQyxPQUFULEdBQW1CO0FBQ2YsUUFBTUMsSUFBbUIsR0FBR0MsSUFBSSxDQUFDQyxLQUFMLENBQVdDLE1BQU0sQ0FBQ0MsWUFBUCxDQUFvQkMsaUJBQXBCLElBQXlDLElBQXBELENBQTVCO0FBQ0EsUUFBTUMsTUFBTSxHQUFHQyxNQUFNLENBQUNDLE9BQVAsQ0FBZVIsSUFBZixFQUFxQlMsSUFBckIsQ0FBMEIsQ0FBQyxHQUFHLENBQUNDLE1BQUQsRUFBU0MsS0FBVCxDQUFILENBQUQsRUFBc0IsR0FBRyxDQUFDQyxNQUFELEVBQVNDLEtBQVQsQ0FBSCxDQUF0QixLQUE4Q0EsS0FBSyxHQUFHRixLQUFoRixDQUFmO0FBQ0EsUUFBTUcsU0FBUyxHQUFHUixNQUFNLENBQUNTLEdBQVAsQ0FBVyxDQUFDLENBQUNDLEtBQUQsRUFBUSxDQUFDQyxLQUFELEVBQVFDLElBQVIsQ0FBUixDQUFELEtBQTRCLENBQUNGLEtBQUQsRUFBUUMsS0FBUixDQUF2QyxDQUFsQjs7QUFDQUUseUJBQWNDLFFBQWQsQ0FBdUJ2QixZQUF2QixFQUFxQyxJQUFyQyxFQUEyQ3dCLDJCQUFhQyxPQUF4RCxFQUFpRVIsU0FBUyxDQUFDUyxLQUFWLENBQWdCLENBQWhCLEVBQW1CekIsYUFBbkIsQ0FBakU7QUFDSDs7QUFFRCxTQUFTMEIsY0FBVCxHQUFrQztBQUM5QixTQUFPTCx1QkFBY00sUUFBZCxDQUF1QjVCLFlBQXZCLEtBQXdDLEVBQS9DO0FBQ0g7O0FBRU0sU0FBUzZCLEdBQVQsQ0FBYVYsS0FBYixFQUE0QjtBQUMvQixRQUFNVyxPQUFPLEdBQUdILGNBQWMsRUFBOUI7QUFDQSxRQUFNSSxDQUFDLEdBQUdELE9BQU8sQ0FBQ0UsU0FBUixDQUFrQixDQUFDLENBQUNDLENBQUQsQ0FBRCxLQUFTQSxDQUFDLEtBQUtkLEtBQWpDLENBQVY7QUFFQSxNQUFJZSxRQUFKOztBQUNBLE1BQUlILENBQUMsSUFBSSxDQUFULEVBQVk7QUFDUjtBQUNBLEtBQUNHLFFBQUQsSUFBYUosT0FBTyxDQUFDSyxNQUFSLENBQWVKLENBQWYsRUFBa0IsQ0FBbEIsQ0FBYjtBQUNBRyxJQUFBQSxRQUFRLENBQUMsQ0FBRCxDQUFSLEdBSFEsQ0FHTztBQUNsQixHQUpELE1BSU87QUFDSEEsSUFBQUEsUUFBUSxHQUFHLENBQUNmLEtBQUQsRUFBUSxDQUFSLENBQVg7QUFDSDs7QUFFREcseUJBQWNDLFFBQWQsQ0FBdUJ2QixZQUF2QixFQUFxQyxJQUFyQyxFQUEyQ3dCLDJCQUFhQyxPQUF4RCxFQUFpRSxDQUFDUyxRQUFELEVBQVcsR0FBR0osT0FBZCxFQUF1QkosS0FBdkIsQ0FBNkIsQ0FBN0IsRUFBZ0N6QixhQUFoQyxDQUFqRTtBQUNIOztBQUVNLFNBQVNtQyxHQUFULENBQWFDLEtBQUssR0FBRyxFQUFyQixFQUF5QjtBQUM1QixNQUFJUCxPQUFPLEdBQUdILGNBQWMsRUFBNUI7O0FBRUEsTUFBSUcsT0FBTyxDQUFDUSxNQUFSLEdBQWlCLENBQXJCLEVBQXdCO0FBQ3BCcEMsSUFBQUEsT0FBTztBQUNQNEIsSUFBQUEsT0FBTyxHQUFHSCxjQUFjLEVBQXhCO0FBQ0gsR0FOMkIsQ0FRNUI7OztBQUNBLFFBQU1sQixNQUFNLEdBQUcscUJBQVFxQixPQUFSLEVBQWlCLEdBQWpCLEVBQXNCLE1BQXRCLENBQWY7QUFDQSxTQUFPckIsTUFBTSxDQUFDaUIsS0FBUCxDQUFhLENBQWIsRUFBZ0JXLEtBQWhCLEVBQXVCbkIsR0FBdkIsQ0FBMkIsQ0FBQyxDQUFDQyxLQUFELENBQUQsS0FBYUEsS0FBeEMsQ0FBUDtBQUNIIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE5IFR1bGlyIEFzb2thbiA8dHVsaXJAbWF1bml1bS5uZXQ+XG5Db3B5cmlnaHQgMjAyMCBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBTZXR0aW5nc1N0b3JlIGZyb20gXCIuLi9zZXR0aW5ncy9TZXR0aW5nc1N0b3JlXCI7XG5pbXBvcnQgeyBvcmRlckJ5IH0gZnJvbSBcImxvZGFzaFwiO1xuaW1wb3J0IHsgU2V0dGluZ0xldmVsIH0gZnJvbSBcIi4uL3NldHRpbmdzL1NldHRpbmdMZXZlbFwiO1xuXG5pbnRlcmZhY2UgSUxlZ2FjeUZvcm1hdCB7XG4gICAgW2Vtb2ppOiBzdHJpbmddOiBbbnVtYmVyLCBudW1iZXJdOyAvLyBbY291bnQsIGRhdGVdXG59XG5cbi8vIE5ldyBmb3JtYXQgdHJpZXMgdG8gYmUgbW9yZSBzcGFjZSBlZmZpY2llbnQgZm9yIHN5bmNocm9uaXphdGlvbi4gT3JkZXJlZCBieSBEYXRlIGRlc2NlbmRpbmcuXG50eXBlIEZvcm1hdCA9IFtzdHJpbmcsIG51bWJlcl1bXTsgLy8gW2Vtb2ppLCBjb3VudF1cblxuY29uc3QgU0VUVElOR19OQU1FID0gXCJyZWNlbnRfZW1vamlcIjtcblxuLy8gd2Ugc3RvcmUgbW9yZSByZWNlbnRzIHRoYW4gd2UgdHlwaWNhbGx5IHF1ZXJ5IGJ1dCB0aGlzIGxldHMgdXMgc29ydCBieSB3ZWlnaHRlZCB1c2FnZVxuLy8gZXZlbiBpZiB5b3UgaGF2ZW4ndCB1c2VkIHlvdXIgdHlwaWNhbGx5IGZhdm91cml0ZSBlbW9qaSBmb3IgYSBsaXR0bGUgd2hpbGUuXG5jb25zdCBTVE9SQUdFX0xJTUlUID0gMTAwO1xuXG4vLyBUT0RPIHJlbW92ZSB0aGlzIGFmdGVyIHNvbWUgdGltZVxuZnVuY3Rpb24gbWlncmF0ZSgpIHtcbiAgICBjb25zdCBkYXRhOiBJTGVnYWN5Rm9ybWF0ID0gSlNPTi5wYXJzZSh3aW5kb3cubG9jYWxTdG9yYWdlLm14X3JlYWN0aW9uX2NvdW50IHx8ICd7fScpO1xuICAgIGNvbnN0IHNvcnRlZCA9IE9iamVjdC5lbnRyaWVzKGRhdGEpLnNvcnQoKFssIFtjb3VudDEsIGRhdGUxXV0sIFssIFtjb3VudDIsIGRhdGUyXV0pID0+IGRhdGUyIC0gZGF0ZTEpO1xuICAgIGNvbnN0IG5ld0Zvcm1hdCA9IHNvcnRlZC5tYXAoKFtlbW9qaSwgW2NvdW50LCBkYXRlXV0pID0+IFtlbW9qaSwgY291bnRdKTtcbiAgICBTZXR0aW5nc1N0b3JlLnNldFZhbHVlKFNFVFRJTkdfTkFNRSwgbnVsbCwgU2V0dGluZ0xldmVsLkFDQ09VTlQsIG5ld0Zvcm1hdC5zbGljZSgwLCBTVE9SQUdFX0xJTUlUKSk7XG59XG5cbmZ1bmN0aW9uIGdldFJlY2VudEVtb2ppKCk6IEZvcm1hdCB7XG4gICAgcmV0dXJuIFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoU0VUVElOR19OQU1FKSB8fCBbXTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFkZChlbW9qaTogc3RyaW5nKSB7XG4gICAgY29uc3QgcmVjZW50cyA9IGdldFJlY2VudEVtb2ppKCk7XG4gICAgY29uc3QgaSA9IHJlY2VudHMuZmluZEluZGV4KChbZV0pID0+IGUgPT09IGVtb2ppKTtcblxuICAgIGxldCBuZXdFbnRyeTtcbiAgICBpZiAoaSA+PSAwKSB7XG4gICAgICAgIC8vIGZpcnN0IHJlbW92ZSB0aGUgZXhpc3RpbmcgdHVwbGUgc28gdGhhdCB3ZSBjYW4gaW5jcmVtZW50IGl0IGFuZCBwdXNoIGl0IHRvIHRoZSBmcm9udFxuICAgICAgICBbbmV3RW50cnldID0gcmVjZW50cy5zcGxpY2UoaSwgMSk7XG4gICAgICAgIG5ld0VudHJ5WzFdKys7IC8vIGluY3JlbWVudCB0aGUgdXNhZ2UgY291bnRcbiAgICB9IGVsc2Uge1xuICAgICAgICBuZXdFbnRyeSA9IFtlbW9qaSwgMV07XG4gICAgfVxuXG4gICAgU2V0dGluZ3NTdG9yZS5zZXRWYWx1ZShTRVRUSU5HX05BTUUsIG51bGwsIFNldHRpbmdMZXZlbC5BQ0NPVU5ULCBbbmV3RW50cnksIC4uLnJlY2VudHNdLnNsaWNlKDAsIFNUT1JBR0VfTElNSVQpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldChsaW1pdCA9IDI0KSB7XG4gICAgbGV0IHJlY2VudHMgPSBnZXRSZWNlbnRFbW9qaSgpO1xuXG4gICAgaWYgKHJlY2VudHMubGVuZ3RoIDwgMSkge1xuICAgICAgICBtaWdyYXRlKCk7XG4gICAgICAgIHJlY2VudHMgPSBnZXRSZWNlbnRFbW9qaSgpO1xuICAgIH1cblxuICAgIC8vIHBlcmZvcm0gYSBzdGFibGUgc29ydCBvbiBgY291bnRgIHRvIGtlZXAgdGhlIHJlY2VudCAoZGF0ZSkgb3JkZXIgYXMgYSBzZWNvbmRhcnkgc29ydCBmYWN0b3JcbiAgICBjb25zdCBzb3J0ZWQgPSBvcmRlckJ5KHJlY2VudHMsIFwiMVwiLCBcImRlc2NcIik7XG4gICAgcmV0dXJuIHNvcnRlZC5zbGljZSgwLCBsaW1pdCkubWFwKChbZW1vamldKSA9PiBlbW9qaSk7XG59XG4iXX0=