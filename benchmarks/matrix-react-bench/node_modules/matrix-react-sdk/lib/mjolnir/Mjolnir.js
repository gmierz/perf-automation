"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Mjolnir = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _MatrixClientPeg = require("../MatrixClientPeg");

var _BanList = require("./BanList");

var _SettingsStore = _interopRequireDefault(require("../settings/SettingsStore"));

var _languageHandler = require("../languageHandler");

var _dispatcher = _interopRequireDefault(require("../dispatcher/dispatcher"));

var _SettingLevel = require("../settings/SettingLevel");

var _partials = require("matrix-js-sdk/src/@types/partials");

var _logger = require("matrix-js-sdk/src/logger");

/*
Copyright 2019 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
// TODO: Move this and related files to the js-sdk or something once finalized.
class Mjolnir {
  constructor() {
    (0, _defineProperty2.default)(this, "_lists", []);
    (0, _defineProperty2.default)(this, "_roomIds", []);
    (0, _defineProperty2.default)(this, "mjolnirWatchRef", null);
    (0, _defineProperty2.default)(this, "dispatcherRef", null);
    (0, _defineProperty2.default)(this, "onAction", payload => {
      if (payload['action'] === 'setup_mjolnir') {
        _logger.logger.log("Setting up Mjolnir: after sync");

        this.setup();
      }
    });
    (0, _defineProperty2.default)(this, "onEvent", event => {
      if (!_MatrixClientPeg.MatrixClientPeg.get()) return;
      if (!this._roomIds.includes(event.getRoomId())) return;
      if (!_BanList.ALL_RULE_TYPES.includes(event.getType())) return;
      this.updateLists(this._roomIds);
    });
  }

  get roomIds() {
    return this._roomIds;
  }

  get lists() {
    return this._lists;
  }

  start() {
    this.mjolnirWatchRef = _SettingsStore.default.watchSetting("mjolnirRooms", null, this.onListsChanged.bind(this));
    this.dispatcherRef = _dispatcher.default.register(this.onAction);

    _dispatcher.default.dispatch({
      action: 'do_after_sync_prepared',
      deferred_action: {
        action: 'setup_mjolnir'
      }
    });
  }

  setup() {
    if (!_MatrixClientPeg.MatrixClientPeg.get()) return;
    this.updateLists(_SettingsStore.default.getValue("mjolnirRooms"));

    _MatrixClientPeg.MatrixClientPeg.get().on("RoomState.events", this.onEvent);
  }

  stop() {
    if (this.mjolnirWatchRef) {
      _SettingsStore.default.unwatchSetting(this.mjolnirWatchRef);

      this.mjolnirWatchRef = null;
    }

    if (this.dispatcherRef) {
      _dispatcher.default.unregister(this.dispatcherRef);

      this.dispatcherRef = null;
    }

    if (!_MatrixClientPeg.MatrixClientPeg.get()) return;

    _MatrixClientPeg.MatrixClientPeg.get().removeListener("RoomState.events", this.onEvent);
  }

  async getOrCreatePersonalList() {
    let personalRoomId = _SettingsStore.default.getValue("mjolnirPersonalRoom");

    if (!personalRoomId) {
      const resp = await _MatrixClientPeg.MatrixClientPeg.get().createRoom({
        name: (0, _languageHandler._t)("My Ban List"),
        topic: (0, _languageHandler._t)("This is your list of users/servers you have blocked - don't leave the room!"),
        preset: _partials.Preset.PrivateChat
      });
      personalRoomId = resp['room_id'];
      await _SettingsStore.default.setValue("mjolnirPersonalRoom", null, _SettingLevel.SettingLevel.ACCOUNT, personalRoomId);
      await _SettingsStore.default.setValue("mjolnirRooms", null, _SettingLevel.SettingLevel.ACCOUNT, [personalRoomId, ...this._roomIds]);
    }

    if (!personalRoomId) {
      throw new Error("Error finding a room ID to use");
    }

    let list = this._lists.find(b => b.roomId === personalRoomId);

    if (!list) list = new _BanList.BanList(personalRoomId); // we don't append the list to the tracked rooms because it should already be there.
    // we're just trying to get the caller some utility access to the list

    return list;
  } // get without creating the list


  getPersonalList() {
    const personalRoomId = _SettingsStore.default.getValue("mjolnirPersonalRoom");

    if (!personalRoomId) return null;

    let list = this._lists.find(b => b.roomId === personalRoomId);

    if (!list) list = new _BanList.BanList(personalRoomId); // we don't append the list to the tracked rooms because it should already be there.
    // we're just trying to get the caller some utility access to the list

    return list;
  }

  async subscribeToList(roomId) {
    const roomIds = [...this._roomIds, roomId];
    await _SettingsStore.default.setValue("mjolnirRooms", null, _SettingLevel.SettingLevel.ACCOUNT, roomIds);

    this._lists.push(new _BanList.BanList(roomId));
  }

  async unsubscribeFromList(roomId) {
    const roomIds = this._roomIds.filter(r => r !== roomId);

    await _SettingsStore.default.setValue("mjolnirRooms", null, _SettingLevel.SettingLevel.ACCOUNT, roomIds);
    this._lists = this._lists.filter(b => b.roomId !== roomId);
  }

  onListsChanged(settingName, roomId, atLevel, newValue) {
    // We know that ban lists are only recorded at one level so we don't need to re-eval them
    this.updateLists(newValue);
  }

  updateLists(listRoomIds) {
    if (!_MatrixClientPeg.MatrixClientPeg.get()) return;

    _logger.logger.log("Updating Mjolnir ban lists to: " + listRoomIds);

    this._lists = [];
    this._roomIds = listRoomIds || [];
    if (!listRoomIds) return;

    for (const roomId of listRoomIds) {
      // Creating the list updates it
      this._lists.push(new _BanList.BanList(roomId));
    }
  }

  isServerBanned(serverName) {
    for (const list of this._lists) {
      for (const rule of list.serverRules) {
        if (rule.isMatch(serverName)) {
          return true;
        }
      }
    }

    return false;
  }

  isUserBanned(userId) {
    for (const list of this._lists) {
      for (const rule of list.userRules) {
        if (rule.isMatch(userId)) {
          return true;
        }
      }
    }

    return false;
  }

  static sharedInstance() {
    if (!Mjolnir.instance) {
      Mjolnir.instance = new Mjolnir();
    }

    return Mjolnir.instance;
  }

}

exports.Mjolnir = Mjolnir;
(0, _defineProperty2.default)(Mjolnir, "instance", null);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tam9sbmlyL01qb2xuaXIudHMiXSwibmFtZXMiOlsiTWpvbG5pciIsInBheWxvYWQiLCJsb2dnZXIiLCJsb2ciLCJzZXR1cCIsImV2ZW50IiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0IiwiX3Jvb21JZHMiLCJpbmNsdWRlcyIsImdldFJvb21JZCIsIkFMTF9SVUxFX1RZUEVTIiwiZ2V0VHlwZSIsInVwZGF0ZUxpc3RzIiwicm9vbUlkcyIsImxpc3RzIiwiX2xpc3RzIiwic3RhcnQiLCJtam9sbmlyV2F0Y2hSZWYiLCJTZXR0aW5nc1N0b3JlIiwid2F0Y2hTZXR0aW5nIiwib25MaXN0c0NoYW5nZWQiLCJiaW5kIiwiZGlzcGF0Y2hlclJlZiIsImRpcyIsInJlZ2lzdGVyIiwib25BY3Rpb24iLCJkaXNwYXRjaCIsImFjdGlvbiIsImRlZmVycmVkX2FjdGlvbiIsImdldFZhbHVlIiwib24iLCJvbkV2ZW50Iiwic3RvcCIsInVud2F0Y2hTZXR0aW5nIiwidW5yZWdpc3RlciIsInJlbW92ZUxpc3RlbmVyIiwiZ2V0T3JDcmVhdGVQZXJzb25hbExpc3QiLCJwZXJzb25hbFJvb21JZCIsInJlc3AiLCJjcmVhdGVSb29tIiwibmFtZSIsInRvcGljIiwicHJlc2V0IiwiUHJlc2V0IiwiUHJpdmF0ZUNoYXQiLCJzZXRWYWx1ZSIsIlNldHRpbmdMZXZlbCIsIkFDQ09VTlQiLCJFcnJvciIsImxpc3QiLCJmaW5kIiwiYiIsInJvb21JZCIsIkJhbkxpc3QiLCJnZXRQZXJzb25hbExpc3QiLCJzdWJzY3JpYmVUb0xpc3QiLCJwdXNoIiwidW5zdWJzY3JpYmVGcm9tTGlzdCIsImZpbHRlciIsInIiLCJzZXR0aW5nTmFtZSIsImF0TGV2ZWwiLCJuZXdWYWx1ZSIsImxpc3RSb29tSWRzIiwiaXNTZXJ2ZXJCYW5uZWQiLCJzZXJ2ZXJOYW1lIiwicnVsZSIsInNlcnZlclJ1bGVzIiwiaXNNYXRjaCIsImlzVXNlckJhbm5lZCIsInVzZXJJZCIsInVzZXJSdWxlcyIs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aWdodCAyMDE5IFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IHsgTWF0cml4RXZlbnQgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL2V2ZW50XCI7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tIFwiLi4vTWF0cml4Q2xpZW50UGVnXCI7XG5pbXBvcnQgeyBBTExfUlVMRV9UWVBFUywgQmFuTGlzdCB9IGZyb20gXCIuL0Jhbkxpc3RcIjtcbmltcG9ydCBTZXR0aW5nc1N0b3JlIGZyb20gXCIuLi9zZXR0aW5ncy9TZXR0aW5nc1N0b3JlXCI7XG5pbXBvcnQgeyBfdCB9IGZyb20gXCIuLi9sYW5ndWFnZUhhbmRsZXJcIjtcbmltcG9ydCBkaXMgZnJvbSBcIi4uL2Rpc3BhdGNoZXIvZGlzcGF0Y2hlclwiO1xuaW1wb3J0IHsgU2V0dGluZ0xldmVsIH0gZnJvbSBcIi4uL3NldHRpbmdzL1NldHRpbmdMZXZlbFwiO1xuaW1wb3J0IHsgUHJlc2V0IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL0B0eXBlcy9wYXJ0aWFsc1wiO1xuaW1wb3J0IHsgQWN0aW9uUGF5bG9hZCB9IGZyb20gXCIuLi9kaXNwYXRjaGVyL3BheWxvYWRzXCI7XG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcblxuLy8gVE9ETzogTW92ZSB0aGlzIGFuZCByZWxhdGVkIGZpbGVzIHRvIHRoZSBqcy1zZGsgb3Igc29tZXRoaW5nIG9uY2UgZmluYWxpemVkLlxuXG5leHBvcnQgY2xhc3MgTWpvbG5pciB7XG4gICAgcHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IE1qb2xuaXIgPSBudWxsO1xuXG4gICAgcHJpdmF0ZSBfbGlzdHM6IEJhbkxpc3RbXSA9IFtdOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uYW1pbmctY29udmVudGlvblxuICAgIHByaXZhdGUgX3Jvb21JZHM6IHN0cmluZ1tdID0gW107IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25hbWluZy1jb252ZW50aW9uXG4gICAgcHJpdmF0ZSBtam9sbmlyV2F0Y2hSZWY6IHN0cmluZyA9IG51bGw7XG4gICAgcHJpdmF0ZSBkaXNwYXRjaGVyUmVmOiBzdHJpbmcgPSBudWxsO1xuXG4gICAgZ2V0IHJvb21JZHMoKTogc3RyaW5nW10ge1xuICAgICAgICByZXR1cm4gdGhpcy5fcm9vbUlkcztcbiAgICB9XG5cbiAgICBnZXQgbGlzdHMoKTogQmFuTGlzdFtdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2xpc3RzO1xuICAgIH1cblxuICAgIHN0YXJ0KCkge1xuICAgICAgICB0aGlzLm1qb2xuaXJXYXRjaFJlZiA9IFNldHRpbmdzU3RvcmUud2F0Y2hTZXR0aW5nKFwibWpvbG5pclJvb21zXCIsIG51bGwsIHRoaXMub25MaXN0c0NoYW5nZWQuYmluZCh0aGlzKSk7XG5cbiAgICAgICAgdGhpcy5kaXNwYXRjaGVyUmVmID0gZGlzLnJlZ2lzdGVyKHRoaXMub25BY3Rpb24pO1xuICAgICAgICBkaXMuZGlzcGF0Y2goe1xuICAgICAgICAgICAgYWN0aW9uOiAnZG9fYWZ0ZXJfc3luY19wcmVwYXJlZCcsXG4gICAgICAgICAgICBkZWZlcnJlZF9hY3Rpb246IHsgYWN0aW9uOiAnc2V0dXBfbWpvbG5pcicgfSxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkFjdGlvbiA9IChwYXlsb2FkOiBBY3Rpb25QYXlsb2FkKSA9PiB7XG4gICAgICAgIGlmIChwYXlsb2FkWydhY3Rpb24nXSA9PT0gJ3NldHVwX21qb2xuaXInKSB7XG4gICAgICAgICAgICBsb2dnZXIubG9nKFwiU2V0dGluZyB1cCBNam9sbmlyOiBhZnRlciBzeW5jXCIpO1xuICAgICAgICAgICAgdGhpcy5zZXR1cCgpO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIHNldHVwKCkge1xuICAgICAgICBpZiAoIU1hdHJpeENsaWVudFBlZy5nZXQoKSkgcmV0dXJuO1xuICAgICAgICB0aGlzLnVwZGF0ZUxpc3RzKFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJtam9sbmlyUm9vbXNcIikpO1xuICAgICAgICBNYXRyaXhDbGllbnRQZWcuZ2V0KCkub24oXCJSb29tU3RhdGUuZXZlbnRzXCIsIHRoaXMub25FdmVudCk7XG4gICAgfVxuXG4gICAgc3RvcCgpIHtcbiAgICAgICAgaWYgKHRoaXMubWpvbG5pcldhdGNoUmVmKSB7XG4gICAgICAgICAgICBTZXR0aW5nc1N0b3JlLnVud2F0Y2hTZXR0aW5nKHRoaXMubWpvbG5pcldhdGNoUmVmKTtcbiAgICAgICAgICAgIHRoaXMubWpvbG5pcldhdGNoUmVmID0gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmRpc3BhdGNoZXJSZWYpIHtcbiAgICAgICAgICAgIGRpcy51bnJlZ2lzdGVyKHRoaXMuZGlzcGF0Y2hlclJlZik7XG4gICAgICAgICAgICB0aGlzLmRpc3BhdGNoZXJSZWYgPSBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFNYXRyaXhDbGllbnRQZWcuZ2V0KCkpIHJldHVybjtcbiAgICAgICAgTWF0cml4Q2xpZW50UGVnLmdldCgpLnJlbW92ZUxpc3RlbmVyKFwiUm9vbVN0YXRlLmV2ZW50c1wiLCB0aGlzLm9uRXZlbnQpO1xuICAgIH1cblxuICAgIGFzeW5jIGdldE9yQ3JlYXRlUGVyc29uYWxMaXN0KCk6IFByb21pc2U8QmFuTGlzdD4ge1xuICAgICAgICBsZXQgcGVyc29uYWxSb29tSWQgPSBTZXR0aW5nc1N0b3JlLmdldFZhbHVlKFwibWpvbG5pclBlcnNvbmFsUm9vbVwiKTtcbiAgICAgICAgaWYgKCFwZXJzb25hbFJvb21JZCkge1xuICAgICAgICAgICAgY29uc3QgcmVzcCA9IGF3YWl0IE1hdHJpeENsaWVudFBlZy5nZXQoKS5jcmVhdGVSb29tKHtcbiAgICAgICAgICAgICAgICBuYW1lOiBfdChcIk15IEJhbiBMaXN0XCIpLFxuICAgICAgICAgICAgICAgIHRvcGljOiBfdChcIlRoaXMgaXMgeW91ciBsaXN0IG9mIHVzZXJzL3NlcnZlcnMgeW91IGhhdmUgYmxvY2tlZCAtIGRvbid0IGxlYXZlIHRoZSByb29tIVwiKSxcbiAgICAgICAgICAgICAgICBwcmVzZXQ6IFByZXNldC5Qcml2YXRlQ2hhdCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcGVyc29uYWxSb29tSWQgPSByZXNwWydyb29tX2lkJ107XG4gICAgICAgICAgICBhd2FpdCBTZXR0aW5nc1N0b3JlLnNldFZhbHVlKFxuICAgICAgICAgICAgICAgIFwibWpvbG5pclBlcnNvbmFsUm9vbVwiLCBudWxsLCBTZXR0aW5nTGV2ZWwuQUNDT1VOVCwgcGVyc29uYWxSb29tSWQpO1xuICAgICAgICAgICAgYXdhaXQgU2V0dGluZ3NTdG9yZS5zZXRWYWx1ZShcbiAgICAgICAgICAgICAgICBcIm1qb2xuaXJSb29tc1wiLCBudWxsLCBTZXR0aW5nTGV2ZWwuQUNDT1VOVCwgW3BlcnNvbmFsUm9vbUlkLCAuLi50aGlzLl9yb29tSWRzXSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFwZXJzb25hbFJvb21JZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRXJyb3IgZmluZGluZyBhIHJvb20gSUQgdG8gdXNlXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGxpc3QgPSB0aGlzLl9saXN0cy5maW5kKGIgPT4gYi5yb29tSWQgPT09IHBlcnNvbmFsUm9vbUlkKTtcbiAgICAgICAgaWYgKCFsaXN0KSBsaXN0ID0gbmV3IEJhbkxpc3QocGVyc29uYWxSb29tSWQpO1xuICAgICAgICAvLyB3ZSBkb24ndCBhcHBlbmQgdGhlIGxpc3QgdG8gdGhlIHRyYWNrZWQgcm9vbXMgYmVjYXVzZSBpdCBzaG91bGQgYWxyZWFkeSBiZSB0aGVyZS5cbiAgICAgICAgLy8gd2UncmUganVzdCB0cnlpbmcgdG8gZ2V0IHRoZSBjYWxsZXIgc29tZSB1dGlsaXR5IGFjY2VzcyB0byB0aGUgbGlzdFxuXG4gICAgICAgIHJldHVybiBsaXN0O1xuICAgIH1cblxuICAgIC8vIGdldCB3aXRob3V0IGNyZWF0aW5nIHRoZSBsaXN0XG4gICAgZ2V0UGVyc29uYWxMaXN0KCk6IEJhbkxpc3Qge1xuICAgICAgICBjb25zdCBwZXJzb25hbFJvb21JZCA9IFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJtam9sbmlyUGVyc29uYWxSb29tXCIpO1xuICAgICAgICBpZiAoIXBlcnNvbmFsUm9vbUlkKSByZXR1cm4gbnVsbDtcblxuICAgICAgICBsZXQgbGlzdCA9IHRoaXMuX2xpc3RzLmZpbmQoYiA9PiBiLnJvb21JZCA9PT0gcGVyc29uYWxSb29tSWQpO1xuICAgICAgICBpZiAoIWxpc3QpIGxpc3QgPSBuZXcgQmFuTGlzdChwZXJzb25hbFJvb21JZCk7XG4gICAgICAgIC8vIHdlIGRvbid0IGFwcGVuZCB0aGUgbGlzdCB0byB0aGUgdHJhY2tlZCByb29tcyBiZWNhdXNlIGl0IHNob3VsZCBhbHJlYWR5IGJlIHRoZXJlLlxuICAgICAgICAvLyB3ZSdyZSBqdXN0IHRyeWluZyB0byBnZXQgdGhlIGNhbGxlciBzb21lIHV0aWxpdHkgYWNjZXNzIHRvIHRoZSBsaXN0XG5cbiAgICAgICAgcmV0dXJuIGxpc3Q7XG4gICAgfVxuXG4gICAgYXN5bmMgc3Vic2NyaWJlVG9MaXN0KHJvb21JZDogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IHJvb21JZHMgPSBbLi4udGhpcy5fcm9vbUlkcywgcm9vbUlkXTtcbiAgICAgICAgYXdhaXQgU2V0dGluZ3NTdG9yZS5zZXRWYWx1ZShcIm1qb2xuaXJSb29tc1wiLCBudWxsLCBTZXR0aW5nTGV2ZWwuQUNDT1VOVCwgcm9vbUlkcyk7XG4gICAgICAgIHRoaXMuX2xpc3RzLnB1c2gobmV3IEJhbkxpc3Qocm9vbUlkKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgdW5zdWJzY3JpYmVGcm9tTGlzdChyb29tSWQ6IHN0cmluZykge1xuICAgICAgICBjb25zdCByb29tSWRzID0gdGhpcy5fcm9vbUlkcy5maWx0ZXIociA9PiByICE9PSByb29tSWQpO1xuICAgICAgICBhd2FpdCBTZXR0aW5nc1N0b3JlLnNldFZhbHVlKFwibWpvbG5pclJvb21zXCIsIG51bGwsIFNldHRpbmdMZXZlbC5BQ0NPVU5ULCByb29tSWRzKTtcbiAgICAgICAgdGhpcy5fbGlzdHMgPSB0aGlzLl9saXN0cy5maWx0ZXIoYiA9PiBiLnJvb21JZCAhPT0gcm9vbUlkKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uRXZlbnQgPSAoZXZlbnQ6IE1hdHJpeEV2ZW50KSA9PiB7XG4gICAgICAgIGlmICghTWF0cml4Q2xpZW50UGVnLmdldCgpKSByZXR1cm47XG4gICAgICAgIGlmICghdGhpcy5fcm9vbUlkcy5pbmNsdWRlcyhldmVudC5nZXRSb29tSWQoKSkpIHJldHVybjtcbiAgICAgICAgaWYgKCFBTExfUlVMRV9UWVBFUy5pbmNsdWRlcyhldmVudC5nZXRUeXBlKCkpKSByZXR1cm47XG5cbiAgICAgICAgdGhpcy51cGRhdGVMaXN0cyh0aGlzLl9yb29tSWRzKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkxpc3RzQ2hhbmdlZChzZXR0aW5nTmFtZTogc3RyaW5nLCByb29tSWQ6IHN0cmluZywgYXRMZXZlbDogU2V0dGluZ0xldmVsLCBuZXdWYWx1ZTogc3RyaW5nW10pIHtcbiAgICAgICAgLy8gV2Uga25vdyB0aGF0IGJhbiBsaXN0cyBhcmUgb25seSByZWNvcmRlZCBhdCBvbmUgbGV2ZWwgc28gd2UgZG9uJ3QgbmVlZCB0byByZS1ldmFsIHRoZW1cbiAgICAgICAgdGhpcy51cGRhdGVMaXN0cyhuZXdWYWx1ZSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB1cGRhdGVMaXN0cyhsaXN0Um9vbUlkczogc3RyaW5nW10pIHtcbiAgICAgICAgaWYgKCFNYXRyaXhDbGllbnRQZWcuZ2V0KCkpIHJldHVybjtcblxuICAgICAgICBsb2dnZXIubG9nKFwiVXBkYXRpbmcgTWpvbG5pciBiYW4gbGlzdHMgdG86IFwiICsgbGlzdFJvb21JZHMpO1xuICAgICAgICB0aGlzLl9saXN0cyA9IFtdO1xuICAgICAgICB0aGlzLl9yb29tSWRzID0gbGlzdFJvb21JZHMgfHwgW107XG4gICAgICAgIGlmICghbGlzdFJvb21JZHMpIHJldHVybjtcblxuICAgICAgICBmb3IgKGNvbnN0IHJvb21JZCBvZiBsaXN0Um9vbUlkcykge1xuICAgICAgICAgICAgLy8gQ3JlYXRpbmcgdGhlIGxpc3QgdXBkYXRlcyBpdFxuICAgICAgICAgICAgdGhpcy5fbGlzdHMucHVzaChuZXcgQmFuTGlzdChyb29tSWQpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGlzU2VydmVyQmFubmVkKHNlcnZlck5hbWU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICBmb3IgKGNvbnN0IGxpc3Qgb2YgdGhpcy5fbGlzdHMpIHtcbiAgICAgICAgICAgIGZvciAoY29uc3QgcnVsZSBvZiBsaXN0LnNlcnZlclJ1bGVzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHJ1bGUuaXNNYXRjaChzZXJ2ZXJOYW1lKSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGlzVXNlckJhbm5lZCh1c2VySWQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICBmb3IgKGNvbnN0IGxpc3Qgb2YgdGhpcy5fbGlzdHMpIHtcbiAgICAgICAgICAgIGZvciAoY29uc3QgcnVsZSBvZiBsaXN0LnVzZXJSdWxlcykge1xuICAgICAgICAgICAgICAgIGlmIChydWxlLmlzTWF0Y2godXNlcklkKSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHN0YXRpYyBzaGFyZWRJbnN0YW5jZSgpOiBNam9sbmlyIHtcbiAgICAgICAgaWYgKCFNam9sbmlyLmluc3RhbmNlKSB7XG4gICAgICAgICAgICBNam9sbmlyLmluc3RhbmNlID0gbmV3IE1qb2xuaXIoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gTWpvbG5pci5pbnN0YW5jZTtcbiAgICB9XG59XG5cbiJdfQ==