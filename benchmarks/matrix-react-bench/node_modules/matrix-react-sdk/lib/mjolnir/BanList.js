"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.USER_RULE_TYPES = exports.SERVER_RULE_TYPES = exports.RULE_USER = exports.RULE_SERVER = exports.RULE_ROOM = exports.ROOM_RULE_TYPES = exports.BanList = exports.ALL_RULE_TYPES = void 0;
exports.ruleTypeToStable = ruleTypeToStable;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _ListRule = require("./ListRule");

var _MatrixClientPeg = require("../MatrixClientPeg");

/*
Copyright 2019 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
// Inspiration largely taken from Mjolnir itself
const RULE_USER = "m.room.rule.user";
exports.RULE_USER = RULE_USER;
const RULE_ROOM = "m.room.rule.room";
exports.RULE_ROOM = RULE_ROOM;
const RULE_SERVER = "m.room.rule.server";
exports.RULE_SERVER = RULE_SERVER;
const USER_RULE_TYPES = [RULE_USER, "org.matrix.mjolnir.rule.user"];
exports.USER_RULE_TYPES = USER_RULE_TYPES;
const ROOM_RULE_TYPES = [RULE_ROOM, "org.matrix.mjolnir.rule.room"];
exports.ROOM_RULE_TYPES = ROOM_RULE_TYPES;
const SERVER_RULE_TYPES = [RULE_SERVER, "org.matrix.mjolnir.rule.server"];
exports.SERVER_RULE_TYPES = SERVER_RULE_TYPES;
const ALL_RULE_TYPES = [...USER_RULE_TYPES, ...ROOM_RULE_TYPES, ...SERVER_RULE_TYPES];
exports.ALL_RULE_TYPES = ALL_RULE_TYPES;

function ruleTypeToStable(rule, unstable = true) {
  if (USER_RULE_TYPES.includes(rule)) {
    return unstable ? USER_RULE_TYPES[USER_RULE_TYPES.length - 1] : RULE_USER;
  }

  if (ROOM_RULE_TYPES.includes(rule)) {
    return unstable ? ROOM_RULE_TYPES[ROOM_RULE_TYPES.length - 1] : RULE_ROOM;
  }

  if (SERVER_RULE_TYPES.includes(rule)) {
    return unstable ? SERVER_RULE_TYPES[SERVER_RULE_TYPES.length - 1] : RULE_SERVER;
  }

  return null;
}

class BanList {
  constructor(roomId) {
    (0, _defineProperty2.default)(this, "_rules", []);
    (0, _defineProperty2.default)(this, "_roomId", void 0);
    this._roomId = roomId;
    this.updateList();
  }

  get roomId() {
    return this._roomId;
  }

  get serverRules() {
    return this._rules.filter(r => r.kind === RULE_SERVER);
  }

  get userRules() {
    return this._rules.filter(r => r.kind === RULE_USER);
  }

  get roomRules() {
    return this._rules.filter(r => r.kind === RULE_ROOM);
  }

  async banEntity(kind, entity, reason) {
    await _MatrixClientPeg.MatrixClientPeg.get().sendStateEvent(this._roomId, ruleTypeToStable(kind, true), {
      entity: entity,
      reason: reason,
      recommendation: (0, _ListRule.recommendationToStable)(_ListRule.RECOMMENDATION_BAN, true)
    }, "rule:" + entity);

    this._rules.push(new _ListRule.ListRule(entity, _ListRule.RECOMMENDATION_BAN, reason, ruleTypeToStable(kind, false)));
  }

  async unbanEntity(kind, entity) {
    // Empty state event is effectively deleting it.
    await _MatrixClientPeg.MatrixClientPeg.get().sendStateEvent(this._roomId, ruleTypeToStable(kind, true), {}, "rule:" + entity);
    this._rules = this._rules.filter(r => {
      if (r.kind !== ruleTypeToStable(kind, false)) return true;
      if (r.entity !== entity) return true;
      return false; // we just deleted this rule
    });
  }

  updateList() {
    this._rules = [];

    const room = _MatrixClientPeg.MatrixClientPeg.get().getRoom(this._roomId);

    if (!room) return;

    for (const eventType of ALL_RULE_TYPES) {
      const events = room.currentState.getStateEvents(eventType);

      for (const ev of events) {
        if (!ev.getStateKey()) continue;
        const kind = ruleTypeToStable(eventType, false);
        const entity = ev.getContent()['entity'];
        const recommendation = ev.getContent()['recommendation'];
        const reason = ev.getContent()['reason'];
        if (!entity || !recommendation || !reason) continue;

        this._rules.push(new _ListRule.ListRule(entity, recommendation, reason, kind));
      }
    }
  }

}

exports.BanList = BanList;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tam9sbmlyL0Jhbkxpc3QudHMiXSwibmFtZXMiOlsiUlVMRV9VU0VSIiwiUlVMRV9ST09NIiwiUlVMRV9TRVJWRVIiLCJVU0VSX1JVTEVfVFlQRVMiLCJST09NX1JVTEVfVFlQRVMiLCJTRVJWRVJfUlVMRV9UWVBFUyIsIkFMTF9SVUxFX1RZUEVTIiwicnVsZVR5cGVUb1N0YWJsZSIsInJ1bGUiLCJ1bnN0YWJsZSIsImluY2x1ZGVzIiwibGVuZ3RoIiwiQmFuTGlzdCIsImNvbnN0cnVjdG9yIiwicm9vbUlkIiwiX3Jvb21JZCIsInVwZGF0ZUxpc3QiLCJzZXJ2ZXJSdWxlcyIsIl9ydWxlcyIsImZpbHRlciIsInIiLCJraW5kIiwidXNlclJ1bGVzIiwicm9vbVJ1bGVzIiwiYmFuRW50aXR5IiwiZW50aXR5IiwicmVhc29uIiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0Iiwic2VuZFN0YXRlRXZlbnQiLCJyZWNvbW1lbmRhdGlvbiIsIlJFQ09NTUVOREFUSU9OX0JBTiIsInB1c2giLCJMaXN0UnVsZSIsInVuYmFuRW50aXR5Iiwicm9vbSIsImdldFJvb20iLCJldmVudFR5cGUiLCJldmVudHMiLCJjdXJyZW50U3RhdGUiLCJnZXRTdGF0ZUV2ZW50cyIsImV2IiwiZ2V0U3RhdGVLZXkiLCJnZXRDb250ZW50Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFrQkE7O0FBQ0E7O0FBbkJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUVBO0FBS08sTUFBTUEsU0FBUyxHQUFHLGtCQUFsQjs7QUFDQSxNQUFNQyxTQUFTLEdBQUcsa0JBQWxCOztBQUNBLE1BQU1DLFdBQVcsR0FBRyxvQkFBcEI7O0FBRUEsTUFBTUMsZUFBZSxHQUFHLENBQUNILFNBQUQsRUFBWSw4QkFBWixDQUF4Qjs7QUFDQSxNQUFNSSxlQUFlLEdBQUcsQ0FBQ0gsU0FBRCxFQUFZLDhCQUFaLENB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QUFaLENBQWlCLElBQUlDLGtCQUFKLENBQWFSLE1BQWIsRUFBcUJLLGNBQXJCLEVBQXFDSixNQUFyQyxFQUE2Q0wsSUFBN0MsQ0FBakI7QUFDSDtBQUNKO0FBQ0o7O0FBakVnQiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxOSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbi8vIEluc3BpcmF0aW9uIGxhcmdlbHkgdGFrZW4gZnJvbSBNam9sbmlyIGl0c2VsZlxuXG5pbXBvcnQgeyBMaXN0UnVsZSwgUkVDT01NRU5EQVRJT05fQkFOLCByZWNvbW1lbmRhdGlvblRvU3RhYmxlIH0gZnJvbSBcIi4vTGlzdFJ1bGVcIjtcbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gXCIuLi9NYXRyaXhDbGllbnRQZWdcIjtcblxuZXhwb3J0IGNvbnN0IFJVTEVfVVNFUiA9IFwibS5yb29tLnJ1bGUudXNlclwiO1xuZXhwb3J0IGNvbnN0IFJVTEVfUk9PTSA9IFwibS5yb29tLnJ1bGUucm9vbVwiO1xuZXhwb3J0IGNvbnN0IFJVTEVfU0VSVkVSID0gXCJtLnJvb20ucnVsZS5zZXJ2ZXJcIjtcblxuZXhwb3J0IGNvbnN0IFVTRVJfUlVMRV9UWVBFUyA9IFtSVUxFX1VTRVIsIFwib3JnLm1hdHJpeC5tam9sbmlyLnJ1bGUudXNlclwiXTtcbmV4cG9ydCBjb25zdCBST09NX1JVTEVfVFlQRVMgPSBbUlVMRV9ST09NLCBcIm9yZy5tYXRyaXgubWpvbG5pci5ydWxlLnJvb21cIl07XG5leHBvcnQgY29uc3QgU0VSVkVSX1JVTEVfVFlQRVMgPSBbUlVMRV9TRVJWRVIsIFwib3JnLm1hdHJpeC5tam9sbmlyLnJ1bGUuc2VydmVyXCJdO1xuZXhwb3J0IGNvbnN0IEFMTF9SVUxFX1RZUEVTID0gWy4uLlVTRVJfUlVMRV9UWVBFUywgLi4uUk9PTV9SVUxFX1RZUEVTLCAuLi5TRVJWRVJfUlVMRV9UWVBFU107XG5cbmV4cG9ydCBmdW5jdGlvbiBydWxlVHlwZVRvU3RhYmxlKHJ1bGU6IHN0cmluZywgdW5zdGFibGUgPSB0cnVlKTogc3RyaW5nIHtcbiAgICBpZiAoVVNFUl9SVUxFX1RZUEVTLmluY2x1ZGVzKHJ1bGUpKSB7XG4gICAgICAgIHJldHVybiB1bnN0YWJsZSA/IFVTRVJfUlVMRV9UWVBFU1tVU0VSX1JVTEVfVFlQRVMubGVuZ3RoIC0gMV0gOiBSVUxFX1VTRVI7XG4gICAgfVxuICAgIGlmIChST09NX1JVTEVfVFlQRVMuaW5jbHVkZXMocnVsZSkpIHtcbiAgICAgICAgcmV0dXJuIHVuc3RhYmxlID8gUk9PTV9SVUxFX1RZUEVTW1JPT01fUlVMRV9UWVBFUy5sZW5ndGggLSAxXSA6IFJVTEVfUk9PTTtcbiAgICB9XG4gICAgaWYgKFNFUlZFUl9SVUxFX1RZUEVTLmluY2x1ZGVzKHJ1bGUpKSB7XG4gICAgICAgIHJldHVybiB1bnN0YWJsZSA/IFNFUlZFUl9SVUxFX1RZUEVTW1NFUlZFUl9SVUxFX1RZUEVTLmxlbmd0aCAtIDFdIDogUlVMRV9TRVJWRVI7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xufVxuXG5leHBvcnQgY2xhc3MgQmFuTGlzdCB7XG4gICAgX3J1bGVzOiBMaXN0UnVsZVtdID0gW107XG4gICAgX3Jvb21JZDogc3RyaW5nO1xuXG4gICAgY29uc3RydWN0b3Iocm9vbUlkOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5fcm9vbUlkID0gcm9vbUlkO1xuICAgICAgICB0aGlzLnVwZGF0ZUxpc3QoKTtcbiAgICB9XG5cbiAgICBnZXQgcm9vbUlkKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl9yb29tSWQ7XG4gICAgfVxuXG4gICAgZ2V0IHNlcnZlclJ1bGVzKCk6IExpc3RSdWxlW10ge1xuICAgICAgICByZXR1cm4gdGhpcy5fcnVsZXMuZmlsdGVyKHIgPT4gci5raW5kID09PSBSVUxFX1NFUlZFUik7XG4gICAgfVxuXG4gICAgZ2V0IHVzZXJSdWxlcygpOiBMaXN0UnVsZVtdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3J1bGVzLmZpbHRlcihyID0+IHIua2luZCA9PT0gUlVMRV9VU0VSKTtcbiAgICB9XG5cbiAgICBnZXQgcm9vbVJ1bGVzKCk6IExpc3RSdWxlW10ge1xuICAgICAgICByZXR1cm4gdGhpcy5fcnVsZXMuZmlsdGVyKHIgPT4gci5raW5kID09PSBSVUxFX1JPT00pO1xuICAgIH1cblxuICAgIGFzeW5jIGJhbkVudGl0eShraW5kOiBzdHJpbmcsIGVudGl0eTogc3RyaW5nLCByZWFzb246IHN0cmluZyk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGF3YWl0IE1hdHJpeENsaWVudFBlZy5nZXQoKS5zZW5kU3RhdGVFdmVudCh0aGlzLl9yb29tSWQsIHJ1bGVUeXBlVG9TdGFibGUoa2luZCwgdHJ1ZSksIHtcbiAgICAgICAgICAgIGVudGl0eTogZW50aXR5LFxuICAgICAgICAgICAgcmVhc29uOiByZWFzb24sXG4gICAgICAgICAgICByZWNvbW1lbmRhdGlvbjogcmVjb21tZW5kYXRpb25Ub1N0YWJsZShSRUNPTU1FTkRBVElPTl9CQU4sIHRydWUpLFxuICAgICAgICB9LCBcInJ1bGU6XCIgKyBlbnRpdHkpO1xuICAgICAgICB0aGlzLl9ydWxlcy5wdXNoKG5ldyBMaXN0UnVsZShlbnRpdHksIFJFQ09NTUVOREFUSU9OX0JBTiwgcmVhc29uLCBydWxlVHlwZVRvU3RhYmxlKGtpbmQsIGZhbHNlKSkpO1xuICAgIH1cblxuICAgIGFzeW5jIHVuYmFuRW50aXR5KGtpbmQ6IHN0cmluZywgZW50aXR5OiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICAvLyBFbXB0eSBzdGF0ZSBldmVudCBpcyBlZmZlY3RpdmVseSBkZWxldGluZyBpdC5cbiAgICAgICAgYXdhaXQgTWF0cml4Q2xpZW50UGVnLmdldCgpLnNlbmRTdGF0ZUV2ZW50KHRoaXMuX3Jvb21JZCwgcnVsZVR5cGVUb1N0YWJsZShraW5kLCB0cnVlKSwge30sIFwicnVsZTpcIiArIGVudGl0eSk7XG4gICAgICAgIHRoaXMuX3J1bGVzID0gdGhpcy5fcnVsZXMuZmlsdGVyKHIgPT4ge1xuICAgICAgICAgICAgaWYgKHIua2luZCAhPT0gcnVsZVR5cGVUb1N0YWJsZShraW5kLCBmYWxzZSkpIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgaWYgKHIuZW50aXR5ICE9PSBlbnRpdHkpIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlOyAvLyB3ZSBqdXN0IGRlbGV0ZWQgdGhpcyBydWxlXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHVwZGF0ZUxpc3QoKSB7XG4gICAgICAgIHRoaXMuX3J1bGVzID0gW107XG5cbiAgICAgICAgY29uc3Qgcm9vbSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRSb29tKHRoaXMuX3Jvb21JZCk7XG4gICAgICAgIGlmICghcm9vbSkgcmV0dXJuO1xuXG4gICAgICAgIGZvciAoY29uc3QgZXZlbnRUeXBlIG9mIEFMTF9SVUxFX1RZUEVTKSB7XG4gICAgICAgICAgICBjb25zdCBldmVudHMgPSByb29tLmN1cnJlbnRTdGF0ZS5nZXRTdGF0ZUV2ZW50cyhldmVudFR5cGUpO1xuICAgICAgICAgICAgZm9yIChjb25zdCBldiBvZiBldmVudHMpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWV2LmdldFN0YXRlS2V5KCkpIGNvbnRpbnVlO1xuXG4gICAgICAgICAgICAgICAgY29uc3Qga2luZCA9IHJ1bGVUeXBlVG9TdGFibGUoZXZlbnRUeXBlLCBmYWxzZSk7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBlbnRpdHkgPSBldi5nZXRDb250ZW50KClbJ2VudGl0eSddO1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlY29tbWVuZGF0aW9uID0gZXYuZ2V0Q29udGVudCgpWydyZWNvbW1lbmRhdGlvbiddO1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlYXNvbiA9IGV2LmdldENvbnRlbnQoKVsncmVhc29uJ107XG4gICAgICAgICAgICAgICAgaWYgKCFlbnRpdHkgfHwgIXJlY29tbWVuZGF0aW9uIHx8ICFyZWFzb24pIGNvbnRpbnVlO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5fcnVsZXMucHVzaChuZXcgTGlzdFJ1bGUoZW50aXR5LCByZWNvbW1lbmRhdGlvbiwgcmVhc29uLCBraW5kKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=