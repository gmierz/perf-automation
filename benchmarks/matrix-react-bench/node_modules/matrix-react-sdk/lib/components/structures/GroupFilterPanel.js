"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _GroupFilterOrderStore = _interopRequireDefault(require("../../stores/GroupFilterOrderStore"));

var _GroupActions = _interopRequireDefault(require("../../actions/GroupActions"));

var _dispatcher = _interopRequireDefault(require("../../dispatcher/dispatcher"));

var _languageHandler = require("../../languageHandler");

var _classnames = _interopRequireDefault(require("classnames"));

var _MatrixClientContext = _interopRequireDefault(require("../../contexts/MatrixClientContext"));

var _AutoHideScrollbar = _interopRequireDefault(require("./AutoHideScrollbar"));

var _SettingsStore = _interopRequireDefault(require("../../settings/SettingsStore"));

var _UserTagTile = _interopRequireDefault(require("../views/elements/UserTagTile"));

var _replaceableComponent = require("../../utils/replaceableComponent");

var _UIStore = _interopRequireDefault(require("../../stores/UIStore"));

var _DNDTagTile = _interopRequireDefault(require("../views/elements/DNDTagTile"));

var _ActionButton = _interopRequireDefault(require("../views/elements/ActionButton"));

var _dec, _class, _class2, _temp;

let GroupFilterPanel = (_dec = (0, _replaceableComponent.replaceableComponent)("structures.GroupFilterPanel"), _dec(_class = (_temp = _class2 = class GroupFilterPanel extends _react.default.Component {
  constructor(...args) {
    super(...args);
    (0, _defineProperty2.default)(this, "state", {
      orderedTags: [],
      selectedTags: []
    });
    (0, _defineProperty2.default)(this, "ref", /*#__PURE__*/_react.default.createRef());
    (0, _defineProperty2.default)(this, "unmounted", false);
    (0, _defineProperty2.default)(this, "groupFilterOrderStoreToken", void 0);
    (0, _defineProperty2.default)(this, "onGroupMyMembership", () => {
      if (this.unmounted) return;

      _dispatcher.default.dispatch(_GroupActions.default.fetchJoinedGroups(this.context));
    });
    (0, _defineProperty2.default)(this, "onClientSync", (syncState, prevState) => {
      // Consider the client reconnected if there is no error with syncing.
      // This means the state could be RECONNECTING, SYNCING, PREPARED or CATCHUP.
      const reconnected = syncState !== "ERROR" && prevState !== syncState;

      if (reconnected) {
        // Load joined groups
        _dispatcher.default.dispatch(_GroupActions.default.fetchJoinedGroups(this.context));
      }
    });
    (0, _defineProperty2.default)(this, "onClick", e => {
      // only dispatch if its not a no-op
      if (this.state.selectedTags.length > 0) {
        _dispatcher.default.dispatch({
          action: 'deselect_tags'
        });
      }
    });
    (0, _defineProperty2.default)(this, "onClearFilterClick", ev => {
      _dispatcher.default.dispatch({
        action: 'deselect_tags'
      });
    });
  }

  componentDidMount() {
    this.unmounted = false;
    this.context.on("Group.myMembership", this.onGroupMyMembership);
    this.context.on("sync", this.onClientSync);
    this.groupFilterOrderStoreToken = _GroupFilterOrderStore.default.addListener(() => {
      if (this.unmounted) {
        return;
      }

      this.setState({
        orderedTags: _GroupFilterOrderStore.default.getOrderedTags() || [],
        selectedTags: _GroupFilterOrderStore.default.getSelectedTags()
      });
    }); // This could be done by anything with a matrix client

    _dispatcher.default.dispatch(_GroupActions.default.fetchJoinedGroups(this.context));

    _UIStore.default.instance.trackElementDimensions("GroupPanel", this.ref.current);
  }

  componentWillUnmount() {
    this.unmounted = true;
    this.context.removeListener("Group.myMembership", this.onGroupMyMembership);
    this.context.removeListener("sync", this.onClientSync);

    if (this.groupFilterOrderStoreToken) {
      this.groupFilterOrderStoreToken.remove();
    }

    _UIStore.default.instance.stopTrackingElementDimensions("GroupPanel");
  }

  renderGlobalIcon() {
    if (!_SettingsStore.default.getValue("feature_communities_v2_prototypes")) return null;
    return /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement(_UserTagTile.default, null), /*#__PURE__*/_react.default.createElement("hr", {
      className: "mx_GroupFilterPanel_divider"
    }));
  }

  render() {
    const tags = this.state.orderedTags.map((tag, index) => {
      return /*#__PURE__*/_react.default.createElement(_DNDTagTile.default, {
        key: tag,
        tag: tag,
        index: index,
        selected: this.state.selectedTags.includes(tag)
      });
    });
    const itemsSelected = this.state.selectedTags.length > 0;
    const classes = (0, _classnames.default)('mx_GroupFilterPanel', {
      mx_GroupFilterPanel_items_selected: itemsSelected
    });

    let createButton = /*#__PURE__*/_react.default.createElement(_ActionButton.default, {
      tooltip: true,
      label: (0, _languageHandler._t)("Communities"),
      action: "toggle_my_groups",
      className: "mx_TagTile mx_TagTile_plus"
    });

    if (_SettingsStore.default.getValue("feature_communities_v2_prototypes")) {
      createButton = /*#__PURE__*/_react.default.createElement(_ActionButton.default, {
        tooltip: true,
        label: (0, _languageHandler._t)("Create community"),
        action: "view_create_group",
        className: "mx_TagTile mx_TagTile_plus"
      });
    }

    return /*#__PURE__*/_react.default.createElement("div", {
      className: classes,
      onClick: this.onClearFilterClick,
      ref: this.ref
    }, /*#__PURE__*/_react.default.createElement(_AutoHideScrollbar.default, {
      className: "mx_GroupFilterPanel_scroller",
      onClick: this.onClick
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_GroupFilterPanel_tagTileContainer"
    }, this.renderGlobalIcon(), tags, /*#__PURE__*/_react.default.createElement("div", null, createButton))));
  }

}, (0, _defineProperty2.default)(_class2, "contextType", _MatrixClientContext.default), _temp)) || _class);
var _default = GroupFilterPanel;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3N0cnVjdHVyZXMvR3JvdXBGaWx0ZXJQYW5lbC50c3giXSwibmFtZXMiOlsiR3JvdXBGaWx0ZXJQYW5lbCIsIlJlYWN0IiwiQ29tcG9uZW50Iiwib3JkZXJlZFRhZ3MiLCJzZWxlY3RlZFRhZ3MiLCJjcmVhdGVSZWYiLCJ1bm1vdW50ZWQiLCJkaXMiLCJkaXNwYXRjaCIsIkdyb3VwQWN0aW9ucyIsImZldGNoSm9pbmVkR3JvdXBzIiwiY29udGV4dCIsInN5bmNTdGF0ZSIsInByZXZTdGF0ZSIsInJlY29ubmVjdGVkIiwiZSIsInN0YXRlIiwibGVuZ3RoIiwiYWN0aW9uIiwiZXYiLCJjb21wb25lbnREaWRNb3VudCIsIm9uIiwib25Hcm91cE15TWVtYmVyc2hpcCIsIm9uQ2xpZW50U3luYyIsImdyb3VwRmlsdGVyT3JkZXJTdG9yZVRva2VuIiwiR3JvdXBGaWx0ZXJPcmRlclN0b3JlIiwiYWRkTGlzdGVuZXIiLCJzZXRTdGF0ZSIsImdldE9yZGVyZWRUYWdzIiwiZ2V0U2VsZWN0ZWRUYWdzIiwiVUlTdG9yZSIsImluc3RhbmNlIiwidHJhY2tFbGVtZW50RGltZW5zaW9ucyIsInJlZiIsImN1cnJlbnQiLCJjb21wb25lbnRXaWxsVW5tb3VudCIsInJlbW92ZUxpc3RlbmVyIiwicmVtb3ZlIiwic3RvcFRyYWNraW5nRWxlbWVudERpbWVuc2lvbnMiLCJyZW5kZXJHbG9iYWxJY29uIiwiU2V0dGluZ3NTdG9yZSIsImdldFZhbHVlIiwicmVuZGVyIiwidGFncyIsIm1hcCIsInRhZyIsImluZGV4IiwiaW5jbHVkZXMiLCJpdGVtc1NlbGVjdGVkIiwiY2xhc3NlcyIsIm14X0dyb3VwRmlsdGVyUGFuZWxfaXRlbXNfc2VsZWN0ZWQiLCJjcmVhdGVCdXR0b24iLCJvbkNsZWFyRmlsdGVyQ2xpY2siLCJvbkNsaWNrIiwiTWF0cml4Q2xpZW50Q29udGV4dCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFrQkE7O0FBQ0E7O0FB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O0FBT0g7O0FBRUQsd0JBQU87QUFBSyxNQUFBLFNBQVMsRUFBRUYsT0FBaEI7QUFBeUIsTUFBQSxPQUFPLEVBQUUsS0FBS0csa0JBQXZDO0FBQTJELE1BQUEsR0FBRyxFQUFFLEtBQUtuQjtBQUFyRSxvQkFDSCw2QkFBQywwQkFBRDtBQUNJLE1BQUEsU0FBUyxFQUFDLDhCQURkO0FBRUksTUFBQSxPQUFPLEVBQUUsS0FBS29CO0FBRmxCLG9CQUlJO0FBQUssTUFBQSxTQUFTLEVBQUM7QUFBZixPQUNNLEtBQUtkLGdCQUFMLEVBRE4sRUFFTUksSUFGTixlQUdJLDBDQUNNUSxZQUROLENBSEosQ0FKSixDQURHLENBQVA7QUFjSDs7QUE5SDBGLEMsd0RBQy9ERyw0QjtlQStIakJ0RCxnQiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNywgMjAxOCBOZXcgVmVjdG9yIEx0ZC5cbkNvcHlyaWdodCAyMDIwIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IHR5cGUgeyBFdmVudFN1YnNjcmlwdGlvbiB9IGZyb20gXCJmYmVtaXR0ZXJcIjtcbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgR3JvdXBGaWx0ZXJPcmRlclN0b3JlIGZyb20gJy4uLy4uL3N0b3Jlcy9Hcm91cEZpbHRlck9yZGVyU3RvcmUnO1xuXG5pbXBvcnQgR3JvdXBBY3Rpb25zIGZyb20gJy4uLy4uL2FjdGlvbnMvR3JvdXBBY3Rpb25zJztcblxuaW1wb3J0IGRpcyBmcm9tICcuLi8uLi9kaXNwYXRjaGVyL2Rpc3BhdGNoZXInO1xuaW1wb3J0IHsgX3QgfSBmcm9tICcuLi8uLi9sYW5ndWFnZUhhbmRsZXInO1xuXG5pbXBvcnQgY2xhc3NOYW1lcyBmcm9tICdjbGFzc25hbWVzJztcbmltcG9ydCBNYXRyaXhDbGllbnRDb250ZXh0IGZyb20gXCIuLi8uLi9jb250ZXh0cy9NYXRyaXhDbGllbnRDb250ZXh0XCI7XG5pbXBvcnQgQXV0b0hpZGVTY3JvbGxiYXIgZnJvbSBcIi4vQXV0b0hpZGVTY3JvbGxiYXJcIjtcbmltcG9ydCBTZXR0aW5nc1N0b3JlIGZyb20gXCIuLi8uLi9zZXR0aW5ncy9TZXR0aW5nc1N0b3JlXCI7XG5pbXBvcnQgVXNlclRhZ1RpbGUgZnJvbSBcIi4uL3ZpZXdzL2VsZW1lbnRzL1VzZXJUYWdUaWxlXCI7XG5pbXBvcnQgeyByZXBsYWNlYWJsZUNvbXBvbmVudCB9IGZyb20gXCIuLi8uLi91dGlscy9yZXBsYWNlYWJsZUNvbXBvbmVudFwiO1xuaW1wb3J0IFVJU3RvcmUgZnJvbSBcIi4uLy4uL3N0b3Jlcy9VSVN0b3JlXCI7XG5pbXBvcnQgRE5EVGFnVGlsZSBmcm9tIFwiLi4vdmlld3MvZWxlbWVudHMvRE5EVGFnVGlsZVwiO1xuaW1wb3J0IEFjdGlvbkJ1dHRvbiBmcm9tIFwiLi4vdmlld3MvZWxlbWVudHMvQWN0aW9uQnV0dG9uXCI7XG5cbmludGVyZmFjZSBJR3JvdXBGaWx0ZXJQYW5lbFByb3BzIHtcblxufVxuXG4vLyBGSVhNRTogUHJvcGVybHkgdHlwZSB0aGlzIGFmdGVyIG1pZ3JhdGluZyBHcm91cEZpbHRlck9yZGVyU3RvcmUuanMgdG8gVHlwZXNjcmlwdFxudHlwZSBPcmRlcmVkVGFnc1RlbXBvcmFyeVR5cGUgPSBBcnJheTx7fT47XG4vLyBGSVhNRTogUHJvcGVybHkgdHlwZSB0aGlzIGFmdGVyIG1pZ3JhdGluZyBHcm91cEZpbHRlck9yZGVyU3RvcmUuanMgdG8gVHlwZXNjcmlwdFxudHlwZSBTZWxlY3RlZFRhZ3NUZW1wb3JhcnlUeXBlID0gQXJyYXk8e30+O1xuXG5pbnRlcmZhY2UgSUdyb3VwRmlsdGVyUGFuZWxTdGF0ZSB7XG4gICAgLy8gRklYTUU6IFByb3Blcmx5IHR5cGUgdGhpcyBhZnRlciBtaWdyYXRpbmcgR3JvdXBGaWx0ZXJPcmRlclN0b3JlLmpzIHRvIFR5cGVzY3JpcHRcbiAgICBvcmRlcmVkVGFnczogT3JkZXJlZFRhZ3NUZW1wb3JhcnlUeXBlO1xuICAgIC8vIEZJWE1FOiBQcm9wZXJseSB0eXBlIHRoaXMgYWZ0ZXIgbWlncmF0aW5nIEdyb3VwRmlsdGVyT3JkZXJTdG9yZS5qcyB0byBUeXBlc2NyaXB0XG4gICAgc2VsZWN0ZWRUYWdzOiBTZWxlY3RlZFRhZ3NUZW1wb3JhcnlUeXBlO1xufVxuXG5AcmVwbGFjZWFibGVDb21wb25lbnQoXCJzdHJ1Y3R1cmVzLkdyb3VwRmlsdGVyUGFuZWxcIilcbmNsYXNzIEdyb3VwRmlsdGVyUGFuZWwgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8SUdyb3VwRmlsdGVyUGFuZWxQcm9wcywgSUdyb3VwRmlsdGVyUGFuZWxTdGF0ZT4ge1xuICAgIHB1YmxpYyBzdGF0aWMgY29udGV4dFR5cGUgPSBNYXRyaXhDbGllbnRDb250ZXh0O1xuXG4gICAgcHVibGljIHN0YXRlID0ge1xuICAgICAgICBvcmRlcmVkVGFnczogW10sXG4gICAgICAgIHNlbGVjdGVkVGFnczogW10sXG4gICAgfTtcblxuICAgIHByaXZhdGUgcmVmID0gUmVhY3QuY3JlYXRlUmVmPEhUTUxEaXZFbGVtZW50PigpO1xuICAgIHByaXZhdGUgdW5tb3VudGVkID0gZmFsc2U7XG4gICAgcHJpdmF0ZSBncm91cEZpbHRlck9yZGVyU3RvcmVUb2tlbj86IEV2ZW50U3Vic2NyaXB0aW9uO1xuXG4gICAgcHVibGljIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgICAgICB0aGlzLnVubW91bnRlZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLmNvbnRleHQub24oXCJHcm91cC5teU1lbWJlcnNoaXBcIiwgdGhpcy5vbkdyb3VwTXlNZW1iZXJzaGlwKTtcbiAgICAgICAgdGhpcy5jb250ZXh0Lm9uKFwic3luY1wiLCB0aGlzLm9uQ2xpZW50U3luYyk7XG5cbiAgICAgICAgdGhpcy5ncm91cEZpbHRlck9yZGVyU3RvcmVUb2tlbiA9IEdyb3VwRmlsdGVyT3JkZXJTdG9yZS5hZGRMaXN0ZW5lcigoKSA9PiB7XG4gICAgICAgICAgICBpZiAodGhpcy51bm1vdW50ZWQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICBvcmRlcmVkVGFnczogR3JvdXBGaWx0ZXJPcmRlclN0b3JlLmdldE9yZGVyZWRUYWdzKCkgfHwgW10sXG4gICAgICAgICAgICAgICAgc2VsZWN0ZWRUYWdzOiBHcm91cEZpbHRlck9yZGVyU3RvcmUuZ2V0U2VsZWN0ZWRUYWdzKCksXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIC8vIFRoaXMgY291bGQgYmUgZG9uZSBieSBhbnl0aGluZyB3aXRoIGEgbWF0cml4IGNsaWVudFxuICAgICAgICBkaXMuZGlzcGF0Y2goR3JvdXBBY3Rpb25zLmZldGNoSm9pbmVkR3JvdXBzKHRoaXMuY29udGV4dCkpO1xuICAgICAgICBVSVN0b3JlLmluc3RhbmNlLnRyYWNrRWxlbWVudERpbWVuc2lvbnMoXCJHcm91cFBhbmVsXCIsIHRoaXMucmVmLmN1cnJlbnQpO1xuICAgIH1cblxuICAgIHB1YmxpYyBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICAgICAgdGhpcy51bm1vdW50ZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLmNvbnRleHQucmVtb3ZlTGlzdGVuZXIoXCJHcm91cC5teU1lbWJlcnNoaXBcIiwgdGhpcy5vbkdyb3VwTXlNZW1iZXJzaGlwKTtcbiAgICAgICAgdGhpcy5jb250ZXh0LnJlbW92ZUxpc3RlbmVyKFwic3luY1wiLCB0aGlzLm9uQ2xpZW50U3luYyk7XG4gICAgICAgIGlmICh0aGlzLmdyb3VwRmlsdGVyT3JkZXJTdG9yZVRva2VuKSB7XG4gICAgICAgICAgICB0aGlzLmdyb3VwRmlsdGVyT3JkZXJTdG9yZVRva2VuLnJlbW92ZSgpO1xuICAgICAgICB9XG4gICAgICAgIFVJU3RvcmUuaW5zdGFuY2Uuc3RvcFRyYWNraW5nRWxlbWVudERpbWVuc2lvbnMoXCJHcm91cFBhbmVsXCIpO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25Hcm91cE15TWVtYmVyc2hpcCA9ICgpID0+IHtcbiAgICAgICAgaWYgKHRoaXMudW5tb3VudGVkKSByZXR1cm47XG4gICAgICAgIGRpcy5kaXNwYXRjaChHcm91cEFjdGlvbnMuZmV0Y2hKb2luZWRHcm91cHModGhpcy5jb250ZXh0KSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25DbGllbnRTeW5jID0gKHN5bmNTdGF0ZSwgcHJldlN0YXRlKSA9PiB7XG4gICAgICAgIC8vIENvbnNpZGVyIHRoZSBjbGllbnQgcmVjb25uZWN0ZWQgaWYgdGhlcmUgaXMgbm8gZXJyb3Igd2l0aCBzeW5jaW5nLlxuICAgICAgICAvLyBUaGlzIG1lYW5zIHRoZSBzdGF0ZSBjb3VsZCBiZSBSRUNPTk5FQ1RJTkcsIFNZTkNJTkcsIFBSRVBBUkVEIG9yIENBVENIVVAuXG4gICAgICAgIGNvbnN0IHJlY29ubmVjdGVkID0gc3luY1N0YXRlICE9PSBcIkVSUk9SXCIgJiYgcHJldlN0YXRlICE9PSBzeW5jU3RhdGU7XG4gICAgICAgIGlmIChyZWNvbm5lY3RlZCkge1xuICAgICAgICAgICAgLy8gTG9hZCBqb2luZWQgZ3JvdXBzXG4gICAgICAgICAgICBkaXMuZGlzcGF0Y2goR3JvdXBBY3Rpb25zLmZldGNoSm9pbmVkR3JvdXBzKHRoaXMuY29udGV4dCkpO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25DbGljayA9IGUgPT4ge1xuICAgICAgICAvLyBvbmx5IGRpc3BhdGNoIGlmIGl0cyBub3QgYSBuby1vcFxuICAgICAgICBpZiAodGhpcy5zdGF0ZS5zZWxlY3RlZFRhZ3MubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgZGlzLmRpc3BhdGNoKHsgYWN0aW9uOiAnZGVzZWxlY3RfdGFncycgfSk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkNsZWFyRmlsdGVyQ2xpY2sgPSBldiA9PiB7XG4gICAgICAgIGRpcy5kaXNwYXRjaCh7IGFjdGlvbjogJ2Rlc2VsZWN0X3RhZ3MnIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIHJlbmRlckdsb2JhbEljb24oKSB7XG4gICAgICAgIGlmICghU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcImZlYXR1cmVfY29tbXVuaXRpZXNfdjJfcHJvdG90eXBlc1wiKSkgcmV0dXJuIG51bGw7XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXY+XG4gICAgICAgICAgICAgICAgPFVzZXJUYWdUaWxlIC8+XG4gICAgICAgICAgICAgICAgPGhyIGNsYXNzTmFtZT1cIm14X0dyb3VwRmlsdGVyUGFuZWxfZGl2aWRlclwiIC8+XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCB0YWdzID0gdGhpcy5zdGF0ZS5vcmRlcmVkVGFncy5tYXAoKHRhZywgaW5kZXgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiA8RE5EVGFnVGlsZVxuICAgICAgICAgICAgICAgIGtleT17dGFnfVxuICAgICAgICAgICAgICAgIHRhZz17dGFnfVxuICAgICAgICAgICAgICAgIGluZGV4PXtpbmRleH1cbiAgICAgICAgICAgICAgICBzZWxlY3RlZD17dGhpcy5zdGF0ZS5zZWxlY3RlZFRhZ3MuaW5jbHVkZXModGFnKX1cbiAgICAgICAgICAgIC8+O1xuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBpdGVtc1NlbGVjdGVkID0gdGhpcy5zdGF0ZS5zZWxlY3RlZFRhZ3MubGVuZ3RoID4gMDtcbiAgICAgICAgY29uc3QgY2xhc3NlcyA9IGNsYXNzTmFtZXMoJ214X0dyb3VwRmlsdGVyUGFuZWwnLCB7XG4gICAgICAgICAgICBteF9Hcm91cEZpbHRlclBhbmVsX2l0ZW1zX3NlbGVjdGVkOiBpdGVtc1NlbGVjdGVkLFxuICAgICAgICB9KTtcblxuICAgICAgICBsZXQgY3JlYXRlQnV0dG9uID0gKFxuICAgICAgICAgICAgPEFjdGlvbkJ1dHRvblxuICAgICAgICAgICAgICAgIHRvb2x0aXBcbiAgICAgICAgICAgICAgICBsYWJlbD17X3QoXCJDb21tdW5pdGllc1wiKX1cbiAgICAgICAgICAgICAgICBhY3Rpb249XCJ0b2dnbGVfbXlfZ3JvdXBzXCJcbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9UYWdUaWxlIG14X1RhZ1RpbGVfcGx1c1wiXG4gICAgICAgICAgICAvPlxuICAgICAgICApO1xuXG4gICAgICAgIGlmIChTZXR0aW5nc1N0b3JlLmdldFZhbHVlKFwiZmVhdHVyZV9jb21tdW5pdGllc192Ml9wcm90b3R5cGVzXCIpKSB7XG4gICAgICAgICAgICBjcmVhdGVCdXR0b24gPSAoXG4gICAgICAgICAgICAgICAgPEFjdGlvbkJ1dHRvblxuICAgICAgICAgICAgICAgICAgICB0b29sdGlwXG4gICAgICAgICAgICAgICAgICAgIGxhYmVsPXtfdChcIkNyZWF0ZSBjb21tdW5pdHlcIil9XG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbj1cInZpZXdfY3JlYXRlX2dyb3VwXCJcbiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfVGFnVGlsZSBteF9UYWdUaWxlX3BsdXNcIiAvPlxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiA8ZGl2IGNsYXNzTmFtZT17Y2xhc3Nlc30gb25DbGljaz17dGhpcy5vbkNsZWFyRmlsdGVyQ2xpY2t9IHJlZj17dGhpcy5yZWZ9PlxuICAgICAgICAgICAgPEF1dG9IaWRlU2Nyb2xsYmFyXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfR3JvdXBGaWx0ZXJQYW5lbF9zY3JvbGxlclwiXG4gICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5vbkNsaWNrfVxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfR3JvdXBGaWx0ZXJQYW5lbF90YWdUaWxlQ29udGFpbmVyXCI+XG4gICAgICAgICAgICAgICAgICAgIHsgdGhpcy5yZW5kZXJHbG9iYWxJY29uKCkgfVxuICAgICAgICAgICAgICAgICAgICB7IHRhZ3MgfVxuICAgICAgICAgICAgICAgICAgICA8ZGl2PlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBjcmVhdGVCdXR0b24gfVxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgIDwvQXV0b0hpZGVTY3JvbGxiYXI+XG4gICAgICAgIDwvZGl2PjtcbiAgICB9XG59XG5leHBvcnQgZGVmYXVsdCBHcm91cEZpbHRlclBhbmVsO1xuIl19