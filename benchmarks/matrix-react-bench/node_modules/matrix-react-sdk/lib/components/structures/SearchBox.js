"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var _Keyboard = require("../../Keyboard");

var _dispatcher = _interopRequireDefault(require("../../dispatcher/dispatcher"));

var _lodash = require("lodash");

var _AccessibleButton = _interopRequireDefault(require("../../components/views/elements/AccessibleButton"));

var _classnames = _interopRequireDefault(require("classnames"));

var _replaceableComponent = require("../../utils/replaceableComponent");

var _actions = require("../../dispatcher/actions");

var _dec, _class, _class2, _temp;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

let SearchBox = (_dec = (0, _replaceableComponent.replaceableComponent)("structures.SearchBox"), _dec(_class = (_temp = _class2 = class SearchBox extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "dispatcherRef", void 0);
    (0, _defineProperty2.default)(this, "search", /*#__PURE__*/(0, _react.createRef)());
    (0, _defineProperty2.default)(this, "onAction", payload => {
      if (!this.props.enableRoomSearchFocus) return;

      switch (payload.action) {
        case _actions.Action.ViewRoom:
          if (this.search.current && payload.clear_search) {
            this.clearSearch();
          }

          break;

        case 'focus_room_filter':
          if (this.search.current) {
            this.search.current.focus();
          }

          break;
      }
    });
    (0, _defineProperty2.default)(this, "onChange", () => {
      if (!this.search.current) return;
      this.setState({
        searchTerm: this.search.current.value
      });
      this.onSearch();
    });
    (0, _defineProperty2.default)(this, "onSearch", (0, _lodash.throttle)(() => {
      this.props.onSearch(this.search.current.value);
    }, 200, {
      trailing: true,
      leading: true
    }));
    (0, _defineProperty2.default)(this, "onKeyDown", ev => {
      switch (ev.key) {
        case _Keyboard.Key.ESCAPE:
          this.clearSearch("keyboard");
          break;
      }

      if (this.props.onKeyDown) this.props.onKeyDown(ev);
    });
    (0, _defineProperty2.default)(this, "onFocus", ev => {
      this.setState({
        blurred: false
      });
      ev.target.select();

      if (this.props.onFocus) {
        this.props.onFocus(ev);
      }
    });
    (0, _defineProperty2.default)(this, "onBlur", ev => {
      this.setState({
        blurred: true
      });

      if (this.props.onBlur) {
        this.props.onBlur(ev);
      }
    });
    this.state = {
      searchTerm: props.initialValue || "",
      blurred: true
    };
  }

  componentDidMount() {
    this.dispatcherRef = _dispatcher.default.register(this.onAction);
  }

  componentWillUnmount() {
    _dispatcher.default.unregister(this.dispatcherRef);
  }

  clearSearch(source) {
    this.search.current.value = "";
    this.onChange();

    if (this.props.onCleared) {
      this.props.onCleared(source);
    }
  }

  render() {
    // check for collapsed here and
    // not at parent so we keep
    // searchTerm in our state
    // when collapsing and expanding
    if (this.props.collapsed) {
      return null;
    }

    const clearButton = !this.state.blurred || this.state.searchTerm ? /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      key: "button",
      tabIndex: -1,
      className: "mx_SearchBox_closeButton",
      onClick: () => {
        this.clearSearch("button");
      }
    }) : undefined; // show a shorter placeholder when blurred, if requested
    // this is used for the room filter field that has
    // the explore button next to it when blurred

    const placeholder = this.state.blurred ? this.props.blurredPlaceholder || this.props.placeholder : this.props.placeholder;
    const className = this.props.className || "";
    return /*#__PURE__*/_react.default.createElement("div", {
      className: (0, _classnames.default)("mx_SearchBox", "mx_textinput", {
        "mx_SearchBox_blurred": this.state.blurred
      })
    }, /*#__PURE__*/_react.default.createElement("input", {
      key: "searchfield",
      type: "text",
      ref: this.search,
      className: "mx_textinput_icon mx_textinput_search " + className,
      value: this.state.searchTerm,
      onFocus: this.onFocus,
      onChange: this.onChange,
      onKeyDown: this.onKeyDown,
      onBlur: this.onBlur,
      placeholder: placeholder,
      autoComplete: "off",
      autoFocus: this.props.autoFocus
    }), clearButton);
  }

}, (0, _defineProperty2.default)(_class2, "defaultProps", {
  enableRoomSearchFocus: false
}), _temp)) || _class);
exports.default = SearchBox;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3N0cnVjdHVyZXMvU2VhcmNoQm94LnRzeCJdLCJuYW1lcyI6WyJTZWFyY2hCb3giLCJSZWFjdCIsIkNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJwYXlsb2FkIiwiZW5hYmxlUm9vbVNlYXJjaEZvY3VzIiwiYWN0aW9uIiwiQWN0aW9uIiwiVmlld1Jvb20iLCJzZWFyY2giLCJjdXJyZW50IiwiY2xlYXJfc2VhcmNoIiwiY2xlYXJTZWFyY2giLCJmb2N1cyIsInNldFN0YXRlIiwic2VhcmNoVGVybSIsInZhbHVlIiwib25TZWFyY2giLCJ0cmFpbGluZyIsImxlYWRpbmciLCJldiIsImtleSIsIktleSIsIkVTQ0FQRSIsIm9uS2V5RG93biIsImJsdXJyZWQiLCJ0YXJnZXQiLCJzZWxlY3QiLCJvbkZvY3VzIiwib25CbHVyIiwic3RhdGUiLCJpbml0aWFsVmFsdWUiLCJjb21wb25lbnREaWRNb3VudCIsImRpc3BhdGNoZXJSZWYiLCJkaXMiLCJyZWdpc3RlciIsIm9uQWN0aW9uIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJ1bnJlZ2lzdGVyIiwic291cmNlIiwib25DaGFuZ2UiLCJvbkNsZWFyZWQiLCJyZW5kZXIiLCJjb2xsYXBzZWQiLCJjbGVhckJ1dHRvbiIsInVuZGVmaW5lZCIsInBsYWNlaG9sZGVyIiwiYmx1cnJlZFBsYWNlaG9sZGVyIiwiY2xhc3NOYW1lIiwiYXV0b0ZvY3VzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWlCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7SUEyQnFCQSxTLFdBRHBCLGdEQUFxQixzQkFBckIsQyxtQ0FBRCxNQUNxQkEsU0FEckIsU0FDdUNDLGVBQU1DLFNBRDdDLENBQ3VFO0FBUW5FQyxFQUFBQSxXQUFXLENBQUNDLEtBQUQsRUFBZ0I7QUFDdkIsVUFBTUEsS0FBTjtBQUR1QjtBQUFBLCtEQU5WLHVCQU1VO0FB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QUFTLEVBQUUsS0FBS2hCLFNBUnBCO0FBU0ksTUFBQSxNQUFNLEVBQUUsS0FBS0ssTUFUakI7QUFVSSxNQUFBLFdBQVcsRUFBRWlCLFdBVmpCO0FBV0ksTUFBQSxZQUFZLEVBQUMsS0FYakI7QUFZSSxNQUFBLFNBQVMsRUFBRSxLQUFLM0MsS0FBTCxDQUFXOEM7QUFaMUIsTUFESixFQWVNTCxXQWZOLENBREo7QUFtQkg7O0FBOUhrRSxDLHlEQUk1QjtBQUNuQ3ZDLEVBQUFBLHFCQUFxQixFQUFFO0FBRFksQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNSwgMjAxNiBPcGVuTWFya2V0IEx0ZFxuQ29weXJpZ2h0IDIwMTkgTWljaGFlbCBUZWxhdHluc2tpIDw3dDNjaGd1eUBnbWFpbC5jb20+XG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0LCB7IGNyZWF0ZVJlZiB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IEtleSB9IGZyb20gJy4uLy4uL0tleWJvYXJkJztcbmltcG9ydCBkaXMgZnJvbSAnLi4vLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyJztcbmltcG9ydCB7IHRocm90dGxlIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBBY2Nlc3NpYmxlQnV0dG9uIGZyb20gJy4uLy4uL2NvbXBvbmVudHMvdmlld3MvZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvbic7XG5pbXBvcnQgY2xhc3NOYW1lcyBmcm9tICdjbGFzc25hbWVzJztcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5pbXBvcnQgeyBBY3Rpb24gfSBmcm9tICcuLi8uLi9kaXNwYXRjaGVyL2FjdGlvbnMnO1xuXG5pbnRlcmZhY2UgSVByb3BzIHtcbiAgICBvblNlYXJjaD86IChxdWVyeTogc3RyaW5nKSA9PiB2b2lkO1xuICAgIG9uQ2xlYXJlZD86IChzb3VyY2U/OiBzdHJpbmcpID0+IHZvaWQ7XG4gICAgb25LZXlEb3duPzogKGV2OiBSZWFjdC5LZXlib2FyZEV2ZW50KSA9PiB2b2lkO1xuICAgIG9uRm9jdXM/OiAoZXY6IFJlYWN0LkZvY3VzRXZlbnQpID0+IHZvaWQ7XG4gICAgb25CbHVyPzogKGV2OiBSZWFjdC5Gb2N1c0V2ZW50KSA9PiB2b2lkO1xuICAgIGNsYXNzTmFtZT86IHN0cmluZztcbiAgICBwbGFjZWhvbGRlcjogc3RyaW5nO1xuICAgIGJsdXJyZWRQbGFjZWhvbGRlcj86IHN0cmluZztcbiAgICBhdXRvRm9jdXM/OiBib29sZWFuO1xuICAgIGluaXRpYWxWYWx1ZT86IHN0cmluZztcbiAgICBjb2xsYXBzZWQ/OiBib29sZWFuO1xuXG4gICAgLy8gSWYgdHJ1ZSwgdGhlIHNlYXJjaCBib3ggd2lsbCBmb2N1cyBhbmQgY2xlYXIgaXRzZWxmXG4gICAgLy8gb24gcm9vbSBzZWFyY2ggZm9jdXMgYWN0aW9uIChpdCB3b3VsZCBiZSBuaWNlciB0byB0YWtlXG4gICAgLy8gdGhpcyBmdW5jdGlvbmFsaXR5IG91dCwgYnV0IG5vdCBvYnZpb3VzIGhvdyB0aGF0IHdvdWxkIHdvcmspXG4gICAgZW5hYmxlUm9vbVNlYXJjaEZvY3VzPzogYm9vbGVhbjtcbn1cblxuaW50ZXJmYWNlIElTdGF0ZSB7XG4gICAgc2VhcmNoVGVybTogc3RyaW5nO1xuICAgIGJsdXJyZWQ6IGJvb2xlYW47XG59XG5cbkByZXBsYWNlYWJsZUNvbXBvbmVudChcInN0cnVjdHVyZXMuU2VhcmNoQm94XCIpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTZWFyY2hCb3ggZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8SVByb3BzLCBJU3RhdGU+IHtcbiAgICBwcml2YXRlIGRpc3BhdGNoZXJSZWY6IHN0cmluZztcbiAgICBwcml2YXRlIHNlYXJjaCA9IGNyZWF0ZVJlZjxIVE1MSW5wdXRFbGVtZW50PigpO1xuXG4gICAgc3RhdGljIGRlZmF1bHRQcm9wczogUGFydGlhbDxJUHJvcHM+ID0ge1xuICAgICAgICBlbmFibGVSb29tU2VhcmNoRm9jdXM6IGZhbHNlLFxuICAgIH07XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wczogSVByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgc2VhcmNoVGVybTogcHJvcHMuaW5pdGlhbFZhbHVlIHx8IFwiXCIsXG4gICAgICAgICAgICBibHVycmVkOiB0cnVlLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHB1YmxpYyBjb21wb25lbnREaWRNb3VudCgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5kaXNwYXRjaGVyUmVmID0gZGlzLnJlZ2lzdGVyKHRoaXMub25BY3Rpb24pO1xuICAgIH1cblxuICAgIHB1YmxpYyBjb21wb25lbnRXaWxsVW5tb3VudCgpOiB2b2lkIHtcbiAgICAgICAgZGlzLnVucmVnaXN0ZXIodGhpcy5kaXNwYXRjaGVyUmVmKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uQWN0aW9uID0gKHBheWxvYWQpOiB2b2lkID0+IHtcbiAgICAgICAgaWYgKCF0aGlzLnByb3BzLmVuYWJsZVJvb21TZWFyY2hGb2N1cykgcmV0dXJuO1xuXG4gICAgICAgIHN3aXRjaCAocGF5bG9hZC5hY3Rpb24pIHtcbiAgICAgICAgICAgIGNhc2UgQWN0aW9uLlZpZXdSb29tOlxuICAgICAgICAgICAgICAgIGlmICh0aGlzLnNlYXJjaC5jdXJyZW50ICYmIHBheWxvYWQuY2xlYXJfc2VhcmNoKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2xlYXJTZWFyY2goKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdmb2N1c19yb29tX2ZpbHRlcic6XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuc2VhcmNoLmN1cnJlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWFyY2guY3VycmVudC5mb2N1cygpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwcml2YXRlIG9uQ2hhbmdlID0gKCk6IHZvaWQgPT4ge1xuICAgICAgICBpZiAoIXRoaXMuc2VhcmNoLmN1cnJlbnQpIHJldHVybjtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IHNlYXJjaFRlcm06IHRoaXMuc2VhcmNoLmN1cnJlbnQudmFsdWUgfSk7XG4gICAgICAgIHRoaXMub25TZWFyY2goKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvblNlYXJjaCA9IHRocm90dGxlKCgpOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5wcm9wcy5vblNlYXJjaCh0aGlzLnNlYXJjaC5jdXJyZW50LnZhbHVlKTtcbiAgICB9LCAyMDAsIHsgdHJhaWxpbmc6IHRydWUsIGxlYWRpbmc6IHRydWUgfSk7XG5cbiAgICBwcml2YXRlIG9uS2V5RG93biA9IChldjogUmVhY3QuS2V5Ym9hcmRFdmVudCk6IHZvaWQgPT4ge1xuICAgICAgICBzd2l0Y2ggKGV2LmtleSkge1xuICAgICAgICAgICAgY2FzZSBLZXkuRVNDQVBFOlxuICAgICAgICAgICAgICAgIHRoaXMuY2xlYXJTZWFyY2goXCJrZXlib2FyZFwiKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5wcm9wcy5vbktleURvd24pIHRoaXMucHJvcHMub25LZXlEb3duKGV2KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkZvY3VzID0gKGV2OiBSZWFjdC5Gb2N1c0V2ZW50KTogdm9pZCA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBibHVycmVkOiBmYWxzZSB9KTtcbiAgICAgICAgKGV2LnRhcmdldCBhcyBIVE1MSW5wdXRFbGVtZW50KS5zZWxlY3QoKTtcbiAgICAgICAgaWYgKHRoaXMucHJvcHMub25Gb2N1cykge1xuICAgICAgICAgICAgdGhpcy5wcm9wcy5vbkZvY3VzKGV2KTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwcml2YXRlIG9uQmx1ciA9IChldjogUmVhY3QuRm9jdXNFdmVudCk6IHZvaWQgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgYmx1cnJlZDogdHJ1ZSB9KTtcbiAgICAgICAgaWYgKHRoaXMucHJvcHMub25CbHVyKSB7XG4gICAgICAgICAgICB0aGlzLnByb3BzLm9uQmx1cihldik7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBjbGVhclNlYXJjaChzb3VyY2U/OiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5zZWFyY2guY3VycmVudC52YWx1ZSA9IFwiXCI7XG4gICAgICAgIHRoaXMub25DaGFuZ2UoKTtcbiAgICAgICAgaWYgKHRoaXMucHJvcHMub25DbGVhcmVkKSB7XG4gICAgICAgICAgICB0aGlzLnByb3BzLm9uQ2xlYXJlZChzb3VyY2UpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHJlbmRlcigpOiBKU1guRWxlbWVudCB7XG4gICAgICAgIC8vIGNoZWNrIGZvciBjb2xsYXBzZWQgaGVyZSBhbmRcbiAgICAgICAgLy8gbm90IGF0IHBhcmVudCBzbyB3ZSBrZWVwXG4gICAgICAgIC8vIHNlYXJjaFRlcm0gaW4gb3VyIHN0YXRlXG4gICAgICAgIC8vIHdoZW4gY29sbGFwc2luZyBhbmQgZXhwYW5kaW5nXG4gICAgICAgIGlmICh0aGlzLnByb3BzLmNvbGxhcHNlZCkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY2xlYXJCdXR0b24gPSAoIXRoaXMuc3RhdGUuYmx1cnJlZCB8fCB0aGlzLnN0YXRlLnNlYXJjaFRlcm0pID9cbiAgICAgICAgICAgICg8QWNjZXNzaWJsZUJ1dHRvblxuICAgICAgICAgICAgICAgIGtleT1cImJ1dHRvblwiXG4gICAgICAgICAgICAgICAgdGFiSW5kZXg9ey0xfVxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X1NlYXJjaEJveF9jbG9zZUJ1dHRvblwiXG4gICAgICAgICAgICAgICAgb25DbGljaz17KCkgPT4ge3RoaXMuY2xlYXJTZWFyY2goXCJidXR0b25cIik7IH19XG4gICAgICAgICAgICAvPikgOiB1bmRlZmluZWQ7XG5cbiAgICAgICAgLy8gc2hvdyBhIHNob3J0ZXIgcGxhY2Vob2xkZXIgd2hlbiBibHVycmVkLCBpZiByZXF1ZXN0ZWRcbiAgICAgICAgLy8gdGhpcyBpcyB1c2VkIGZvciB0aGUgcm9vbSBmaWx0ZXIgZmllbGQgdGhhdCBoYXNcbiAgICAgICAgLy8gdGhlIGV4cGxvcmUgYnV0dG9uIG5leHQgdG8gaXQgd2hlbiBibHVycmVkXG4gICAgICAgIGNvbnN0IHBsYWNlaG9sZGVyID0gdGhpcy5zdGF0ZS5ibHVycmVkID9cbiAgICAgICAgICAgICh0aGlzLnByb3BzLmJsdXJyZWRQbGFjZWhvbGRlciB8fCB0aGlzLnByb3BzLnBsYWNlaG9sZGVyKSA6XG4gICAgICAgICAgICB0aGlzLnByb3BzLnBsYWNlaG9sZGVyO1xuICAgICAgICBjb25zdCBjbGFzc05hbWUgPSB0aGlzLnByb3BzLmNsYXNzTmFtZSB8fCBcIlwiO1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9e2NsYXNzTmFtZXMoXCJteF9TZWFyY2hCb3hcIiwgXCJteF90ZXh0aW5wdXRcIiwgeyBcIm14X1NlYXJjaEJveF9ibHVycmVkXCI6IHRoaXMuc3RhdGUuYmx1cnJlZCB9KX0+XG4gICAgICAgICAgICAgICAgPGlucHV0XG4gICAgICAgICAgICAgICAgICAgIGtleT1cInNlYXJjaGZpZWxkXCJcbiAgICAgICAgICAgICAgICAgICAgdHlwZT1cInRleHRcIlxuICAgICAgICAgICAgICAgICAgICByZWY9e3RoaXMuc2VhcmNofVxuICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9e1wibXhfdGV4dGlucHV0X2ljb24gbXhfdGV4dGlucHV0X3NlYXJjaCBcIiArIGNsYXNzTmFtZX1cbiAgICAgICAgICAgICAgICAgICAgdmFsdWU9e3RoaXMuc3RhdGUuc2VhcmNoVGVybX1cbiAgICAgICAgICAgICAgICAgICAgb25Gb2N1cz17dGhpcy5vbkZvY3VzfVxuICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZT17dGhpcy5vbkNoYW5nZX1cbiAgICAgICAgICAgICAgICAgICAgb25LZXlEb3duPXt0aGlzLm9uS2V5RG93bn1cbiAgICAgICAgICAgICAgICAgICAgb25CbHVyPXt0aGlzLm9uQmx1cn1cbiAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI9e3BsYWNlaG9sZGVyfVxuICAgICAgICAgICAgICAgICAgICBhdXRvQ29tcGxldGU9XCJvZmZcIlxuICAgICAgICAgICAgICAgICAgICBhdXRvRm9jdXM9e3RoaXMucHJvcHMuYXV0b0ZvY3VzfVxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgeyBjbGVhckJ1dHRvbiB9XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=