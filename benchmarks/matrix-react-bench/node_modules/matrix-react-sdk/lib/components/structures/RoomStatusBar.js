"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
exports.getUnsentMessages = getUnsentMessages;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _languageHandler = require("../../languageHandler");

var _Resend = _interopRequireDefault(require("../../Resend"));

var _dispatcher = _interopRequireDefault(require("../../dispatcher/dispatcher"));

var _ErrorUtils = require("../../utils/ErrorUtils");

var _actions = require("../../dispatcher/actions");

var _replaceableComponent = require("../../utils/replaceableComponent");

var _event = require("matrix-js-sdk/src/models/event");

var _NotificationBadge = _interopRequireDefault(require("../views/rooms/NotificationBadge"));

var _StaticNotificationState = require("../../stores/notifications/StaticNotificationState");

var _AccessibleButton = _interopRequireDefault(require("../views/elements/AccessibleButton"));

var _InlineSpinner = _interopRequireDefault(require("../views/elements/InlineSpinner"));

var _MatrixClientContext = _interopRequireDefault(require("../../contexts/MatrixClientContext"));

var _dec, _class, _class2, _temp;

const STATUS_BAR_HIDDEN = 0;
const STATUS_BAR_EXPANDED = 1;
const STATUS_BAR_EXPANDED_LARGE = 2;

function getUnsentMessages(room) {
  if (!room) {
    return [];
  }

  return room.getPendingEvents().filter(function (ev) {
    return ev.status === _event.EventStatus.NOT_SENT;
  });
}

let RoomStatusBar = (_dec = (0, _replaceableComponent.replaceableComponent)("structures.RoomStatusBar"), _dec(_class = (_temp = _class2 = class RoomStatusBar extends _react.default.PureComponent {
  constructor(props, context) {
    super(props, context);
    (0, _defineProperty2.default)(this, "onSyncStateChange", (state, prevState, data) => {
      if (state === "SYNCING" && prevState === "SYNCING") {
        return;
      }

      this.setState({
        syncState: state,
        syncStateData: data
      });
    });
    (0, _defineProperty2.default)(this, "onResendAllClick", () => {
      _Resend.default.resendUnsentEvents(this.props.room).then(() => {
        this.setState({
          isResending: false
        });
      });

      this.setState({
        isResending: true
      });

      _dispatcher.default.fire(_actions.Action.FocusSendMessageComposer);
    });
    (0, _defineProperty2.default)(this, "onCancelAllClick", () => {
      _Resend.default.cancelUnsentEvents(this.props.room);

      _dispatcher.default.fire(_actions.Action.FocusSendMessageComposer);
    });
    (0, _defineProperty2.default)(this, "onRoomLocalEchoUpdated", (ev, room) => {
      if (room.roomId !== this.props.room.roomId) return;
      const messages = getUnsentMessages(this.props.room);
      this.setState({
        unsentMessages: messages,
        isResending: messages.length > 0 && this.state.isResending
      });
    });
    this.state = {
      syncState: this.context.getSyncState(),
      syncStateData: this.context.getSyncStateData(),
      unsentMessages: getUnsentMessages(this.props.room),
      isResending: false
    };
  }

  componentDidMount() {
    const client = this.context;
    client.on("sync", this.onSyncStateChange);
    client.on("Room.localEchoUpdated", this.onRoomLocalEchoUpdated);
    this.checkSize();
  }

  componentDidUpdate() {
    this.checkSize();
  }

  componentWillUnmount() {
    // we may have entirely lost our client as we're logging out before clicking login on the guest bar...
    const client = this.context;

    if (client) {
      client.removeListener("sync", this.onSyncStateChange);
      client.removeListener("Room.localEchoUpdated", this.onRoomLocalEchoUpdated);
    }
  }

  // Check whether current size is greater than 0, if yes call props.onVisible
  checkSize() {
    if (this.getSize()) {
      if (this.props.onVisible) this.props.onVisible();
    } else {
      if (this.props.onHidden) this.props.onHidden();
    }
  } // We don't need the actual height - just whether it is likely to have
  // changed - so we use '0' to indicate normal size, and other values to
  // indicate other sizes.


  getSize() {
    if (this.shouldShowConnectionError()) {
      return STATUS_BAR_EXPANDED;
    } else if (this.state.unsentMessages.length > 0 || this.state.isResending) {
      return STATUS_BAR_EXPANDED_LARGE;
    }

    return STATUS_BAR_HIDDEN;
  }

  shouldShowConnectionError() {
    // no conn bar trumps the "some not sent" msg since you can't resend without
    // a connection!
    // There's one situation in which we don't show this 'no connection' bar, and that's
    // if it's a resource limit exceeded error: those are shown in the top bar.
    const errorIsMauError = Boolean(this.state.syncStateData && this.state.syncStateData.error && this.state.syncStateData.error.name === 'M_RESOURCE_LIMIT_EXCEEDED');
    return this.state.syncState === "ERROR" && !errorIsMauError;
  }

  getUnsentMessageContent() {
    const unsentMessages = this.state.unsentMessages;
    let title;
    let consentError = null;
    let resourceLimitError = null;

    for (const m of unsentMessages) {
      if (m.error && m.error.errcode === 'M_CONSENT_NOT_GIVEN') {
        consentError = m.error;
        break;
      } else if (m.error && m.error.errcode === 'M_RESOURCE_LIMIT_EXCEEDED') {
        resourceLimitError = m.error;
        break;
      }
    }

    if (consentError) {
      title = (0, _languageHandler._t)("You can't send any messages until you review and agree to " + "<consentLink>our terms and conditions</consentLink>.", {}, {
        'consentLink': sub => /*#__PURE__*/_react.default.createElement("a", {
          href: consentError.data && consentError.data.consent_uri,
          target: "_blank"
        }, sub)
      });
    } else if (resourceLimitError) {
      title = (0, _ErrorUtils.messageForResourceLimitError)(resourceLimitError.data.limit_type, resourceLimitError.data.admin_contact, {
        'monthly_active_user': (0, _languageHandler._td)("Your message wasn't sent because this homeserver has hit its Monthly Active User Limit. " + "Please <a>contact your service administrator</a> to continue using the service."),
        'hs_disabled': (0, _languageHandler._td)("Your message wasn't sent because this homeserver has been blocked by it's administrator. " + "Please <a>contact your service administrator</a> to continue using the service."),
        '': (0, _languageHandler._td)("Your message wasn't sent because this homeserver has exceeded a resource limit. " + "Please <a>contact your service administrator</a> to continue using the service.")
      });
    } else {
      title = (0, _languageHandler._t)('Some of your messages have not been sent');
    }

    let buttonRow = /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      onClick: this.onCancelAllClick,
      className: "mx_RoomStatusBar_unsentCancelAllBtn"
    }, (0, _languageHandler._t)("Delete all")), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      onClick: this.onResendAllClick,
      className: "mx_RoomStatusBar_unsentResendAllBtn"
    }, (0, _languageHandler._t)("Retry all")));

    if (this.state.isResending) {
      buttonRow = /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement(_InlineSpinner.default, {
        w: 20,
        h: 20
      }), /*#__PURE__*/_react.default.createElement("span", null, (0, _languageHandler._t)("Sending")));
    }

    return /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_RoomStatusBar mx_RoomStatusBar_unsentMessages"
    }, /*#__PURE__*/_react.default.createElement("div", {
      role: "alert"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_RoomStatusBar_unsentBadge"
    }, /*#__PURE__*/_react.default.createElement(_NotificationBadge.default, {
      notification: _StaticNotificationState.StaticNotificationState.RED_EXCLAMATION
    })), /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_RoomStatusBar_unsentTitle"
    }, title), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_RoomStatusBar_unsentDescription"
    }, (0, _languageHandler._t)("You can select all or individual messages to retry or delete"))), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_RoomStatusBar_unsentButtonBar"
    }, buttonRow))));
  }

  render() {
    if (this.shouldShowConnectionError()) {
      return /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_RoomStatusBar"
      }, /*#__PURE__*/_react.default.createElement("div", {
        role: "alert"
      }, /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_RoomStatusBar_connectionLostBar"
      }, /*#__PURE__*/_react.default.createElement("img", {
        src: require("../../../res/img/feather-customised/warning-triangle.svg"),
        width: "24",
        height: "24",
        title: "/!\\ ",
        alt: "/!\\ "
      }), /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_RoomStatusBar_connectionLostBar_title"
      }, (0, _languageHandler._t)('Connectivity to the server has been lost.')), /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_RoomStatusBar_connectionLostBar_desc"
      }, (0, _languageHandler._t)('Sent messages will be stored until your connection has returned.'))))));
    }

    if (this.state.unsentMessages.length > 0 || this.state.isResending) {
      return this.getUnsentMessageContent();
    }

    return null;
  }

}, (0, _defineProperty2.default)(_class2, "contextType", _MatrixClientContext.default), _temp)) || _class);
exports.default = RoomStatusBar;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3N0cnVjdHVyZXMvUm9vbVN0YXR1c0Jhci50c3giXSwibmFtZXMiOlsiU1RBVFVTX0JBUl9ISURERU4iLCJTVEFUVVNfQkFSX0VYUEFOREVEIiwiU1RBVFVTX0JBUl9FWFBBTkRFRF9MQVJHRSIsImdldFVuc2VudE1lc3NhZ2VzIiwicm9vbSIsImdldFBlbmRpbmdFdmVudHMiLCJmaWx0ZXIiLCJldiIsInN0YXR1cyIsIkV2ZW50U3RhdHVzIiwiTk9UX1NFTlQiLCJSb29tU3RhdHVzQmFyIiwiUmVhY3QiLCJQdXJlQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsImNvbnRleHQiLCJzdGF0ZSIsInByZXZTdGF0ZSIsImRhdGEiLCJzZXRTdGF0ZSIsInN5bmNTdGF0ZSIsInN5bmNTdGF0ZURhdGEiLCJSZXNlbmQiLCJyZXNlbmRVbnNlbnRFdmVudHMiLCJ0aGVuIiwiaXNSZXNlbmRpbmciLCJkaXMiLCJmaXJlIiwiQWN0aW9uIiwiRm9jdXNTZW5kTWVzc2FnZUNvbXBvc2VyIiwiY2FuY2VsVW5zZW50RXZlbnRzIiwicm9vbUlkIiwibWVzc2FnZXMiLCJ1bnNlbnRNZXNzYWdlcyIsImxlbmd0aCIsImdldFN5bmNTdGF0ZSIsImdldFN5bmNTdGF0ZURhdGEiLCJjb21wb25lbnREaWRNb3VudCIsImNsaWVudCIsIm9uIiwib25TeW5jU3RhdGVDaGFuZ2UiLCJvblJvb21Mb2NhbEVjaG9VcGRhdGVkIiwiY2hlY2tTaXplIiwiY29tcG9uZW50RGlkVXBkYXRlIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJyZW1vdmVMaXN0ZW5lciIsImdldFNpemUiLCJvblZpc2libGUiLCJvbkhpZGRlbiIsInNob3VsZFNob3dDb25uZWN0aW9uRXJyb3IiLCJlcnJvcklzTWF1RXJyb3IiLCJCb29sZWFuIiwiZXJyb3IiLCJuYW1lIiwiZ2V0VW5zZW50TWVzc2FnZUNvbnRlbnQiLCJ0aXRsZSIsImNvbnNlbnRFcnJvciIsInJlc291cmNlTGltaXRFcnJvciIsIm0iLCJlcnJjb2RlIiwic3ViIiwiY29uc2VudF91cmkiLCJsaW1pdF90eXBlIiwiYWRtaW5fY29udGFjdCIsImJ1dHRvblJvdyIsIm9uQ2FuY2VsQWxsQ2xpY2siLCJvblJlc2VuZEFsbENsaWNrIiwiU3RhdGljTm90aWZpY2F0aW9uU3RhdGUiLCJSRURfRVhDTEFNQVRJT04iLCJyZW5kZXIiLCJyZXF1aXJlIiwiTWF0cml4Q2xpZW50Q29udGV4dCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUlBOzs7O0FBRUEsTUFBTUEsaUJBQWlCLEdBQUcsQ0FBMUI7QUFDQSxNQUFNQyxtQkFBbUIsR0FBRyxDQUE1QjtBQUNBLE1BQU1DLHlCQUF5QixHQUFHLENBQWxDOztBQUVPLFNBQVNDLGlCQUFULENBQTJCQyxJQUEzQixFQUFzRDtBQUN6RCxNQUFJLENBQUNBLElBQUwsRUFBVztBQUFFLFdBQU8sRUFBUDtBQUFZOztBQUN6QixTQUFPQSxJQUFJLENBQUNDLGdCQUFMLEdBQXdCQyxNQUF4QixDQUErQixVQUFTQyxFQUFULEVBQWE7QUFDL0MsV0FBT0EsRUFBRSxDQUFDQyxNQUFILEtBQWNDLG1CQUFZQyxRQUFqQztBQUNILEdBRk0sQ0FBUDtBQUdIOztJQTJDb0JDLGEsV0FEcEIsZ0RBQXFCLDBCQUFyQixDLG1DQUFELE1BQ3FCQSxhQURyQixTQUMyQ0MsZUFBTUMsYUFEakQsQ0FDK0U7QUFHM0VDLEVBQUFBLFdBQVcsQ0FBQ0MsS0FBRCxFQUFnQkMsT0FBaEIsRUFBcUQ7QUFDNUQsVUFBTUQsS0FBTixFQUFhQyxPQUFiO0FBRDRELDZEQWdDcEMsQ0FBQ0MsS0FBRCxFQUFtQkMsU0FBbkIsRUFBeUNDLElBQXpDLEtBQXdFO0FBQ2hHLFVBQUlGLEtBQUssS0FBSyxTQUFWLElBQXVCQyxTQUFTLEtBQUssU0FBekMsRUFBb0Q7QUFDaEQ7QUFD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QUFFRCxRQUFJLEtBQUt0RCxLQUFMLENBQVdpQixjQUFYLENBQTBCQyxNQUExQixHQUFtQyxDQUFuQyxJQUF3QyxLQUFLbEIsS0FBTCxDQUFXUyxXQUF2RCxFQUFvRTtBQUNoRSxhQUFPLEtBQUs2Qix1QkFBTCxFQUFQO0FBQ0g7O0FBRUQsV0FBTyxJQUFQO0FBQ0g7O0FBL04wRSxDLHdEQUMvQ2lCLDRCIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE1LTIwMjEgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgX3QsIF90ZCB9IGZyb20gJy4uLy4uL2xhbmd1YWdlSGFuZGxlcic7XG5pbXBvcnQgUmVzZW5kIGZyb20gJy4uLy4uL1Jlc2VuZCc7XG5pbXBvcnQgZGlzIGZyb20gJy4uLy4uL2Rpc3BhdGNoZXIvZGlzcGF0Y2hlcic7XG5pbXBvcnQgeyBtZXNzYWdlRm9yUmVzb3VyY2VMaW1pdEVycm9yIH0gZnJvbSAnLi4vLi4vdXRpbHMvRXJyb3JVdGlscyc7XG5pbXBvcnQgeyBBY3Rpb24gfSBmcm9tIFwiLi4vLi4vZGlzcGF0Y2hlci9hY3Rpb25zXCI7XG5pbXBvcnQgeyByZXBsYWNlYWJsZUNvbXBvbmVudCB9IGZyb20gXCIuLi8uLi91dGlscy9yZXBsYWNlYWJsZUNvbXBvbmVudFwiO1xuaW1wb3J0IHsgRXZlbnRTdGF0dXMsIE1hdHJpeEV2ZW50IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9ldmVudFwiO1xuaW1wb3J0IE5vdGlmaWNhdGlvbkJhZGdlIGZyb20gXCIuLi92aWV3cy9yb29tcy9Ob3RpZmljYXRpb25CYWRnZVwiO1xuaW1wb3J0IHsgU3RhdGljTm90aWZpY2F0aW9uU3RhdGUgfSBmcm9tIFwiLi4vLi4vc3RvcmVzL25vdGlmaWNhdGlvbnMvU3RhdGljTm90aWZpY2F0aW9uU3RhdGVcIjtcbmltcG9ydCBBY2Nlc3NpYmxlQnV0dG9uIGZyb20gXCIuLi92aWV3cy9lbGVtZW50cy9BY2Nlc3NpYmxlQnV0dG9uXCI7XG5pbXBvcnQgSW5saW5lU3Bpbm5lciBmcm9tIFwiLi4vdmlld3MvZWxlbWVudHMvSW5saW5lU3Bpbm5lclwiO1xuaW1wb3J0IHsgU3luY1N0YXRlIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL3N5bmMuYXBpXCI7XG5pbXBvcnQgeyBJU3luY1N0YXRlRGF0YSB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9zeW5jXCI7XG5pbXBvcnQgeyBSb29tIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yb29tXCI7XG5pbXBvcnQgTWF0cml4Q2xpZW50Q29udGV4dCBmcm9tIFwiLi4vLi4vY29udGV4dHMvTWF0cml4Q2xpZW50Q29udGV4dFwiO1xuXG5jb25zdCBTVEFUVVNfQkFSX0hJRERFTiA9IDA7XG5jb25zdCBTVEFUVVNfQkFSX0VYUEFOREVEID0gMTtcbmNvbnN0IFNUQVRVU19CQVJfRVhQQU5ERURfTEFSR0UgPSAyO1xuXG5leHBvcnQgZnVuY3Rpb24gZ2V0VW5zZW50TWVzc2FnZXMocm9vbTogUm9vbSk6IE1hdHJpeEV2ZW50W10ge1xuICAgIGlmICghcm9vbSkgeyByZXR1cm4gW107IH1cbiAgICByZXR1cm4gcm9vbS5nZXRQZW5kaW5nRXZlbnRzKCkuZmlsdGVyKGZ1bmN0aW9uKGV2KSB7XG4gICAgICAgIHJldHVybiBldi5zdGF0dXMgPT09IEV2ZW50U3RhdHVzLk5PVF9TRU5UO1xuICAgIH0pO1xufVxuXG5pbnRlcmZhY2UgSVByb3BzIHtcbiAgICAvLyB0aGUgcm9vbSB0aGlzIHN0YXR1c2JhciBpcyByZXByZXNlbnRpbmcuXG4gICAgcm9vbTogUm9vbTtcblxuICAgIC8vIHRydWUgaWYgdGhlIHJvb20gaXMgYmVpbmcgcGVla2VkIGF0LiBUaGlzIGFmZmVjdHMgY29tcG9uZW50cyB0aGF0IHNob3VsZG4ndFxuICAgIC8vIGxvZ2ljYWxseSBiZSBzaG93biB3aGVuIHBlZWtpbmcsIHN1Y2ggYXMgYSBwcm9tcHQgdG8gaW52aXRlIHBlb3BsZSB0byBhIHJvb20uXG4gICAgaXNQZWVraW5nPzogYm9vbGVhbjtcbiAgICAvLyBjYWxsYmFjayBmb3Igd2hlbiB0aGUgdXNlciBjbGlja3Mgb24gdGhlICdyZXNlbmQgYWxsJyBidXR0b24gaW4gdGhlXG4gICAgLy8gJ3Vuc2VudCBtZXNzYWdlcycgYmFyXG4gICAgb25SZXNlbmRBbGxDbGljaz86ICgpID0+IHZvaWQ7XG5cbiAgICAvLyBjYWxsYmFjayBmb3Igd2hlbiB0aGUgdXNlciBjbGlja3Mgb24gdGhlICdjYW5jZWwgYWxsJyBidXR0b24gaW4gdGhlXG4gICAgLy8gJ3Vuc2VudCBtZXNzYWdlcycgYmFyXG4gICAgb25DYW5jZWxBbGxDbGljaz86ICgpID0+IHZvaWQ7XG5cbiAgICAvLyBjYWxsYmFjayBmb3Igd2hlbiB0aGUgdXNlciBjbGlja3Mgb24gdGhlICdpbnZpdGUgb3RoZXJzJyBidXR0b24gaW4gdGhlXG4gICAgLy8gJ3lvdSBhcmUgYWxvbmUnIGJhclxuICAgIG9uSW52aXRlQ2xpY2s/OiAoKSA9PiB2b2lkO1xuXG4gICAgLy8gY2FsbGJhY2sgZm9yIHdoZW4gd2UgZG8gc29tZXRoaW5nIHRoYXQgY2hhbmdlcyB0aGUgc2l6ZSBvZiB0aGVcbiAgICAvLyBzdGF0dXMgYmFyLiBUaGlzIGlzIHVzZWQgdG8gdHJpZ2dlciBhIHJlLWxheW91dCBpbiB0aGUgcGFyZW50XG4gICAgLy8gY29tcG9uZW50LlxuICAgIG9uUmVzaXplPzogKCkgPT4gdm9pZDtcblxuICAgIC8vIGNhbGxiYWNrIGZvciB3aGVuIHRoZSBzdGF0dXMgYmFyIGNhbiBiZSBoaWRkZW4gZnJvbSB2aWV3LCBhcyBpdCBpc1xuICAgIC8vIG5vdCBkaXNwbGF5aW5nIGFueXRoaW5nXG4gICAgb25IaWRkZW4/OiAoKSA9PiB2b2lkO1xuXG4gICAgLy8gY2FsbGJhY2sgZm9yIHdoZW4gdGhlIHN0YXR1cyBiYXIgaXMgZGlzcGxheWluZyBzb21ldGhpbmcgYW5kIHNob3VsZFxuICAgIC8vIGJlIHZpc2libGVcbiAgICBvblZpc2libGU/OiAoKSA9PiB2b2lkO1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBzeW5jU3RhdGU6IFN5bmNTdGF0ZTtcbiAgICBzeW5jU3RhdGVEYXRhOiBJU3luY1N0YXRlRGF0YTtcbiAgICB1bnNlbnRNZXNzYWdlczogTWF0cml4RXZlbnRbXTtcbiAgICBpc1Jlc2VuZGluZzogYm9vbGVhbjtcbn1cblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwic3RydWN0dXJlcy5Sb29tU3RhdHVzQmFyXCIpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSb29tU3RhdHVzQmFyIGV4dGVuZHMgUmVhY3QuUHVyZUNvbXBvbmVudDxJUHJvcHMsIElTdGF0ZT4ge1xuICAgIHB1YmxpYyBzdGF0aWMgY29udGV4dFR5cGUgPSBNYXRyaXhDbGllbnRDb250ZXh0O1xuXG4gICAgY29uc3RydWN0b3IocHJvcHM6IElQcm9wcywgY29udGV4dDogdHlwZW9mIE1hdHJpeENsaWVudENvbnRleHQpIHtcbiAgICAgICAgc3VwZXIocHJvcHMsIGNvbnRleHQpO1xuXG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICBzeW5jU3RhdGU6IHRoaXMuY29udGV4dC5nZXRTeW5jU3RhdGUoKSxcbiAgICAgICAgICAgIHN5bmNTdGF0ZURhdGE6IHRoaXMuY29udGV4dC5nZXRTeW5jU3RhdGVEYXRhKCksXG4gICAgICAgICAgICB1bnNlbnRNZXNzYWdlczogZ2V0VW5zZW50TWVzc2FnZXModGhpcy5wcm9wcy5yb29tKSxcbiAgICAgICAgICAgIGlzUmVzZW5kaW5nOiBmYWxzZSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY29tcG9uZW50RGlkTW91bnQoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGNsaWVudCA9IHRoaXMuY29udGV4dDtcbiAgICAgICAgY2xpZW50Lm9uKFwic3luY1wiLCB0aGlzLm9uU3luY1N0YXRlQ2hhbmdlKTtcbiAgICAgICAgY2xpZW50Lm9uKFwiUm9vbS5sb2NhbEVjaG9VcGRhdGVkXCIsIHRoaXMub25Sb29tTG9jYWxFY2hvVXBkYXRlZCk7XG5cbiAgICAgICAgdGhpcy5jaGVja1NpemUoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY29tcG9uZW50RGlkVXBkYXRlKCk6IHZvaWQge1xuICAgICAgICB0aGlzLmNoZWNrU2l6ZSgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBjb21wb25lbnRXaWxsVW5tb3VudCgpOiB2b2lkIHtcbiAgICAgICAgLy8gd2UgbWF5IGhhdmUgZW50aXJlbHkgbG9zdCBvdXIgY2xpZW50IGFzIHdlJ3JlIGxvZ2dpbmcgb3V0IGJlZm9yZSBjbGlja2luZyBsb2dpbiBvbiB0aGUgZ3Vlc3QgYmFyLi4uXG4gICAgICAgIGNvbnN0IGNsaWVudCA9IHRoaXMuY29udGV4dDtcbiAgICAgICAgaWYgKGNsaWVudCkge1xuICAgICAgICAgICAgY2xpZW50LnJlbW92ZUxpc3RlbmVyKFwic3luY1wiLCB0aGlzLm9uU3luY1N0YXRlQ2hhbmdlKTtcbiAgICAgICAgICAgIGNsaWVudC5yZW1vdmVMaXN0ZW5lcihcIlJvb20ubG9jYWxFY2hvVXBkYXRlZFwiLCB0aGlzLm9uUm9vbUxvY2FsRWNob1VwZGF0ZWQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvblN5bmNTdGF0ZUNoYW5nZSA9IChzdGF0ZTogU3luY1N0YXRlLCBwcmV2U3RhdGU6IFN5bmNTdGF0ZSwgZGF0YTogSVN5bmNTdGF0ZURhdGEpOiB2b2lkID0+IHtcbiAgICAgICAgaWYgKHN0YXRlID09PSBcIlNZTkNJTkdcIiAmJiBwcmV2U3RhdGUgPT09IFwiU1lOQ0lOR1wiKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBzeW5jU3RhdGU6IHN0YXRlLFxuICAgICAgICAgICAgc3luY1N0YXRlRGF0YTogZGF0YSxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25SZXNlbmRBbGxDbGljayA9ICgpOiB2b2lkID0+IHtcbiAgICAgICAgUmVzZW5kLnJlc2VuZFVuc2VudEV2ZW50cyh0aGlzLnByb3BzLnJvb20pLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGlzUmVzZW5kaW5nOiBmYWxzZSB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBpc1Jlc2VuZGluZzogdHJ1ZSB9KTtcbiAgICAgICAgZGlzLmZpcmUoQWN0aW9uLkZvY3VzU2VuZE1lc3NhZ2VDb21wb3Nlcik7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25DYW5jZWxBbGxDbGljayA9ICgpOiB2b2lkID0+IHtcbiAgICAgICAgUmVzZW5kLmNhbmNlbFVuc2VudEV2ZW50cyh0aGlzLnByb3BzLnJvb20pO1xuICAgICAgICBkaXMuZmlyZShBY3Rpb24uRm9jdXNTZW5kTWVzc2FnZUNvbXBvc2VyKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvblJvb21Mb2NhbEVjaG9VcGRhdGVkID0gKGV2OiBNYXRyaXhFdmVudCwgcm9vbTogUm9vbSkgPT4ge1xuICAgICAgICBpZiAocm9vbS5yb29tSWQgIT09IHRoaXMucHJvcHMucm9vbS5yb29tSWQpIHJldHVybjtcbiAgICAgICAgY29uc3QgbWVzc2FnZXMgPSBnZXRVbnNlbnRNZXNzYWdlcyh0aGlzLnByb3BzLnJvb20pO1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIHVuc2VudE1lc3NhZ2VzOiBtZXNzYWdlcyxcbiAgICAgICAgICAgIGlzUmVzZW5kaW5nOiBtZXNzYWdlcy5sZW5ndGggPiAwICYmIHRoaXMuc3RhdGUuaXNSZXNlbmRpbmcsXG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICAvLyBDaGVjayB3aGV0aGVyIGN1cnJlbnQgc2l6ZSBpcyBncmVhdGVyIHRoYW4gMCwgaWYgeWVzIGNhbGwgcHJvcHMub25WaXNpYmxlXG4gICAgcHJpdmF0ZSBjaGVja1NpemUoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmdldFNpemUoKSkge1xuICAgICAgICAgICAgaWYgKHRoaXMucHJvcHMub25WaXNpYmxlKSB0aGlzLnByb3BzLm9uVmlzaWJsZSgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKHRoaXMucHJvcHMub25IaWRkZW4pIHRoaXMucHJvcHMub25IaWRkZW4oKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIFdlIGRvbid0IG5lZWQgdGhlIGFjdHVhbCBoZWlnaHQgLSBqdXN0IHdoZXRoZXIgaXQgaXMgbGlrZWx5IHRvIGhhdmVcbiAgICAvLyBjaGFuZ2VkIC0gc28gd2UgdXNlICcwJyB0byBpbmRpY2F0ZSBub3JtYWwgc2l6ZSwgYW5kIG90aGVyIHZhbHVlcyB0b1xuICAgIC8vIGluZGljYXRlIG90aGVyIHNpemVzLlxuICAgIHByaXZhdGUgZ2V0U2l6ZSgpOiBudW1iZXIge1xuICAgICAgICBpZiAodGhpcy5zaG91bGRTaG93Q29ubmVjdGlvbkVycm9yKCkpIHtcbiAgICAgICAgICAgIHJldHVybiBTVEFUVVNfQkFSX0VYUEFOREVEO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuc3RhdGUudW5zZW50TWVzc2FnZXMubGVuZ3RoID4gMCB8fCB0aGlzLnN0YXRlLmlzUmVzZW5kaW5nKSB7XG4gICAgICAgICAgICByZXR1cm4gU1RBVFVTX0JBUl9FWFBBTkRFRF9MQVJHRTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gU1RBVFVTX0JBUl9ISURERU47XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzaG91bGRTaG93Q29ubmVjdGlvbkVycm9yKCk6IGJvb2xlYW4ge1xuICAgICAgICAvLyBubyBjb25uIGJhciB0cnVtcHMgdGhlIFwic29tZSBub3Qgc2VudFwiIG1zZyBzaW5jZSB5b3UgY2FuJ3QgcmVzZW5kIHdpdGhvdXRcbiAgICAgICAgLy8gYSBjb25uZWN0aW9uIVxuICAgICAgICAvLyBUaGVyZSdzIG9uZSBzaXR1YXRpb24gaW4gd2hpY2ggd2UgZG9uJ3Qgc2hvdyB0aGlzICdubyBjb25uZWN0aW9uJyBiYXIsIGFuZCB0aGF0J3NcbiAgICAgICAgLy8gaWYgaXQncyBhIHJlc291cmNlIGxpbWl0IGV4Y2VlZGVkIGVycm9yOiB0aG9zZSBhcmUgc2hvd24gaW4gdGhlIHRvcCBiYXIuXG4gICAgICAgIGNvbnN0IGVycm9ySXNNYXVFcnJvciA9IEJvb2xlYW4oXG4gICAgICAgICAgICB0aGlzLnN0YXRlLnN5bmNTdGF0ZURhdGEgJiZcbiAgICAgICAgICAgIHRoaXMuc3RhdGUuc3luY1N0YXRlRGF0YS5lcnJvciAmJlxuICAgICAgICAgICAgdGhpcy5zdGF0ZS5zeW5jU3RhdGVEYXRhLmVycm9yLm5hbWUgPT09ICdNX1JFU09VUkNFX0xJTUlUX0VYQ0VFREVEJyxcbiAgICAgICAgKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGUuc3luY1N0YXRlID09PSBcIkVSUk9SXCIgJiYgIWVycm9ySXNNYXVFcnJvcjtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFVuc2VudE1lc3NhZ2VDb250ZW50KCk6IEpTWC5FbGVtZW50IHtcbiAgICAgICAgY29uc3QgdW5zZW50TWVzc2FnZXMgPSB0aGlzLnN0YXRlLnVuc2VudE1lc3NhZ2VzO1xuXG4gICAgICAgIGxldCB0aXRsZTtcblxuICAgICAgICBsZXQgY29uc2VudEVycm9yID0gbnVsbDtcbiAgICAgICAgbGV0IHJlc291cmNlTGltaXRFcnJvciA9IG51bGw7XG4gICAgICAgIGZvciAoY29uc3QgbSBvZiB1bnNlbnRNZXNzYWdlcykge1xuICAgICAgICAgICAgaWYgKG0uZXJyb3IgJiYgbS5lcnJvci5lcnJjb2RlID09PSAnTV9DT05TRU5UX05PVF9HSVZFTicpIHtcbiAgICAgICAgICAgICAgICBjb25zZW50RXJyb3IgPSBtLmVycm9yO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChtLmVycm9yICYmIG0uZXJyb3IuZXJyY29kZSA9PT0gJ01fUkVTT1VSQ0VfTElNSVRfRVhDRUVERUQnKSB7XG4gICAgICAgICAgICAgICAgcmVzb3VyY2VMaW1pdEVycm9yID0gbS5lcnJvcjtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoY29uc2VudEVycm9yKSB7XG4gICAgICAgICAgICB0aXRsZSA9IF90KFxuICAgICAgICAgICAgICAgIFwiWW91IGNhbid0IHNlbmQgYW55IG1lc3NhZ2VzIHVudGlsIHlvdSByZXZpZXcgYW5kIGFncmVlIHRvIFwiICtcbiAgICAgICAgICAgICAgICBcIjxjb25zZW50TGluaz5vdXIgdGVybXMgYW5kIGNvbmRpdGlvbnM8L2NvbnNlbnRMaW5rPi5cIixcbiAgICAgICAgICAgICAgICB7fSxcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICdjb25zZW50TGluayc6IChzdWIpID0+XG4gICAgICAgICAgICAgICAgICAgICAgICA8YSBocmVmPXtjb25zZW50RXJyb3IuZGF0YSAmJiBjb25zZW50RXJyb3IuZGF0YS5jb25zZW50X3VyaX0gdGFyZ2V0PVwiX2JsYW5rXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBzdWIgfVxuICAgICAgICAgICAgICAgICAgICAgICAgPC9hPixcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIGlmIChyZXNvdXJjZUxpbWl0RXJyb3IpIHtcbiAgICAgICAgICAgIHRpdGxlID0gbWVzc2FnZUZvclJlc291cmNlTGltaXRFcnJvcihcbiAgICAgICAgICAgICAgICByZXNvdXJjZUxpbWl0RXJyb3IuZGF0YS5saW1pdF90eXBlLFxuICAgICAgICAgICAgICAgIHJlc291cmNlTGltaXRFcnJvci5kYXRhLmFkbWluX2NvbnRhY3QsXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAnbW9udGhseV9hY3RpdmVfdXNlcic6IF90ZChcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiWW91ciBtZXNzYWdlIHdhc24ndCBzZW50IGJlY2F1c2UgdGhpcyBob21lc2VydmVyIGhhcyBoaXQgaXRzIE1vbnRobHkgQWN0aXZlIFVzZXIgTGltaXQuIFwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiUGxlYXNlIDxhPmNvbnRhY3QgeW91ciBzZXJ2aWNlIGFkbWluaXN0cmF0b3I8L2E+IHRvIGNvbnRpbnVlIHVzaW5nIHRoZSBzZXJ2aWNlLlwiLFxuICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICAnaHNfZGlzYWJsZWQnOiBfdGQoXG4gICAgICAgICAgICAgICAgICAgICAgICBcIllvdXIgbWVzc2FnZSB3YXNuJ3Qgc2VudCBiZWNhdXNlIHRoaXMgaG9tZXNlcnZlciBoYXMgYmVlbiBibG9ja2VkIGJ5IGl0J3MgYWRtaW5pc3RyYXRvci4gXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJQbGVhc2UgPGE+Y29udGFjdCB5b3VyIHNlcnZpY2UgYWRtaW5pc3RyYXRvcjwvYT4gdG8gY29udGludWUgdXNpbmcgdGhlIHNlcnZpY2UuXCIsXG4gICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgICcnOiBfdGQoXG4gICAgICAgICAgICAgICAgICAgICAgICBcIllvdXIgbWVzc2FnZSB3YXNuJ3Qgc2VudCBiZWNhdXNlIHRoaXMgaG9tZXNlcnZlciBoYXMgZXhjZWVkZWQgYSByZXNvdXJjZSBsaW1pdC4gXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJQbGVhc2UgPGE+Y29udGFjdCB5b3VyIHNlcnZpY2UgYWRtaW5pc3RyYXRvcjwvYT4gdG8gY29udGludWUgdXNpbmcgdGhlIHNlcnZpY2UuXCIsXG4gICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aXRsZSA9IF90KCdTb21lIG9mIHlvdXIgbWVzc2FnZXMgaGF2ZSBub3QgYmVlbiBzZW50Jyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgYnV0dG9uUm93ID0gPD5cbiAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uIG9uQ2xpY2s9e3RoaXMub25DYW5jZWxBbGxDbGlja30gY2xhc3NOYW1lPVwibXhfUm9vbVN0YXR1c0Jhcl91bnNlbnRDYW5jZWxBbGxCdG5cIj5cbiAgICAgICAgICAgICAgICB7IF90KFwiRGVsZXRlIGFsbFwiKSB9XG4gICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvbiBvbkNsaWNrPXt0aGlzLm9uUmVzZW5kQWxsQ2xpY2t9IGNsYXNzTmFtZT1cIm14X1Jvb21TdGF0dXNCYXJfdW5zZW50UmVzZW5kQWxsQnRuXCI+XG4gICAgICAgICAgICAgICAgeyBfdChcIlJldHJ5IGFsbFwiKSB9XG4gICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgIDwvPjtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuaXNSZXNlbmRpbmcpIHtcbiAgICAgICAgICAgIGJ1dHRvblJvdyA9IDw+XG4gICAgICAgICAgICAgICAgPElubGluZVNwaW5uZXIgdz17MjB9IGg9ezIwfSAvPlxuICAgICAgICAgICAgICAgIHsgLyogc3BhbiBmb3IgY3NzICovIH1cbiAgICAgICAgICAgICAgICA8c3Bhbj57IF90KFwiU2VuZGluZ1wiKSB9PC9zcGFuPlxuICAgICAgICAgICAgPC8+O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIDw+XG4gICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X1Jvb21TdGF0dXNCYXIgbXhfUm9vbVN0YXR1c0Jhcl91bnNlbnRNZXNzYWdlc1wiPlxuICAgICAgICAgICAgICAgIDxkaXYgcm9sZT1cImFsZXJ0XCI+XG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfUm9vbVN0YXR1c0Jhcl91bnNlbnRCYWRnZVwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgPE5vdGlmaWNhdGlvbkJhZGdlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbm90aWZpY2F0aW9uPXtTdGF0aWNOb3RpZmljYXRpb25TdGF0ZS5SRURfRVhDTEFNQVRJT059XG4gICAgICAgICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfUm9vbVN0YXR1c0Jhcl91bnNlbnRUaXRsZVwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgdGl0bGUgfVxuICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X1Jvb21TdGF0dXNCYXJfdW5zZW50RGVzY3JpcHRpb25cIj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IF90KFwiWW91IGNhbiBzZWxlY3QgYWxsIG9yIGluZGl2aWR1YWwgbWVzc2FnZXMgdG8gcmV0cnkgb3IgZGVsZXRlXCIpIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9Sb29tU3RhdHVzQmFyX3Vuc2VudEJ1dHRvbkJhclwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBidXR0b25Sb3cgfVxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICA8Lz47XG4gICAgfVxuXG4gICAgcHVibGljIHJlbmRlcigpOiBKU1guRWxlbWVudCB7XG4gICAgICAgIGlmICh0aGlzLnNob3VsZFNob3dDb25uZWN0aW9uRXJyb3IoKSkge1xuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X1Jvb21TdGF0dXNCYXJcIj5cbiAgICAgICAgICAgICAgICAgICAgPGRpdiByb2xlPVwiYWxlcnRcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfUm9vbVN0YXR1c0Jhcl9jb25uZWN0aW9uTG9zdEJhclwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxpbWdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3JjPXtyZXF1aXJlKFwiLi4vLi4vLi4vcmVzL2ltZy9mZWF0aGVyLWN1c3RvbWlzZWQvd2FybmluZy10cmlhbmdsZS5zdmdcIil9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoPVwiMjRcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ9XCIyNFwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlPVwiLyFcXCBcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbHQ9XCIvIVxcIFwiIC8+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9Sb29tU3RhdHVzQmFyX2Nvbm5lY3Rpb25Mb3N0QmFyX3RpdGxlXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IF90KCdDb25uZWN0aXZpdHkgdG8gdGhlIHNlcnZlciBoYXMgYmVlbiBsb3N0LicpIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfUm9vbVN0YXR1c0Jhcl9jb25uZWN0aW9uTG9zdEJhcl9kZXNjXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IF90KCdTZW50IG1lc3NhZ2VzIHdpbGwgYmUgc3RvcmVkIHVudGlsIHlvdXIgY29ubmVjdGlvbiBoYXMgcmV0dXJuZWQuJykgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5zdGF0ZS51bnNlbnRNZXNzYWdlcy5sZW5ndGggPiAwIHx8IHRoaXMuc3RhdGUuaXNSZXNlbmRpbmcpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFVuc2VudE1lc3NhZ2VDb250ZW50KCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG59XG4iXX0=