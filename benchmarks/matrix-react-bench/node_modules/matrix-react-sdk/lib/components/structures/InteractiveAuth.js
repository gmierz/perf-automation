"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.ERROR_USER_CANCELLED = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _interactiveAuth = require("matrix-js-sdk/src/interactive-auth");

var _react = _interopRequireWildcard(require("react"));

var _InteractiveAuthEntryComponents = _interopRequireDefault(require("../views/auth/InteractiveAuthEntryComponents"));

var _Spinner = _interopRequireDefault(require("../views/elements/Spinner"));

var _replaceableComponent = require("../../utils/replaceableComponent");

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

const ERROR_USER_CANCELLED = new Error("User cancelled auth session");
exports.ERROR_USER_CANCELLED = ERROR_USER_CANCELLED;
let InteractiveAuthComponent = (_dec = (0, _replaceableComponent.replaceableComponent)("structures.InteractiveAuthComponent"), _dec(_class = class InteractiveAuthComponent extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "authLogic", void 0);
    (0, _defineProperty2.default)(this, "intervalId", null);
    (0, _defineProperty2.default)(this, "stageComponent", /*#__PURE__*/(0, _react.createRef)());
    (0, _defineProperty2.default)(this, "unmounted", false);
    (0, _defineProperty2.default)(this, "requestEmailToken", async (email, secret, attempt, session) => {
      this.setState({
        busy: true
      });

      try {
        return await this.props.requestEmailToken(email, secret, attempt, session);
      } finally {
        this.setState({
          busy: false
        });
      }
    });
    (0, _defineProperty2.default)(this, "tryContinue", () => {
      var _this$stageComponent$, _this$stageComponent$2;

      (_this$stageComponent$ = this.stageComponent.current) === null || _this$stageComponent$ === void 0 ? void 0 : (_this$stageComponent$2 = _this$stageComponent$.tryContinue) === null || _this$stageComponent$2 === void 0 ? void 0 : _this$stageComponent$2.call(_this$stageComponent$);
    });
    (0, _defineProperty2.default)(this, "authStateUpdated", (stageType, stageState) => {
      const oldStage = this.state.authStage;
      this.setState({
        busy: false,
        authStage: stageType,
        stageState: stageState,
        errorText: stageState.error,
        errorCode: stageState.errcode
      }, () => {
        if (oldStage !== stageType) {
          this.setFocus();
        } else if (!stageState.error) {
          var _this$stageComponent$3, _this$stageComponent$4;

          (_this$stageComponent$3 = this.stageComponent.current) === null || _this$stageComponent$3 === void 0 ? void 0 : (_this$stageComponent$4 = _this$stageComponent$3.attemptFailed) === null || _this$stageComponent$4 === void 0 ? void 0 : _this$stageComponent$4.call(_this$stageComponent$3);
        }
      });
    });
    (0, _defineProperty2.default)(this, "requestCallback", (auth, background) => {
      // This wrapper just exists because the js-sdk passes a second
      // 'busy' param for backwards compat. This throws the tests off
      // so discard it here.
      return this.props.makeRequest(auth);
    });
    (0, _defineProperty2.default)(this, "onBusyChanged", busy => {
      // if we've started doing stuff, reset the error messages
      if (busy) {
        this.setState({
          busy: true,
          errorText: null,
          errorCode: null
        });
      } // The JS SDK eagerly reports itself as "not busy" right after any
      // immediate work has completed, but that's not really what we want at
      // the UI layer, so we ignore this signal and show a spinner until
      // there's a new screen to show the user. This is implemented by setting
      // `busy: false` in `authStateUpdated`.
      // See also https://github.com/vector-im/element-web/issues/12546

    });
    (0, _defineProperty2.default)(this, "submitAuthDict", authData => {
      this.authLogic.submitAuthDict(authData);
    });
    (0, _defineProperty2.default)(this, "onPhaseChange", newPhase => {
      var _this$props$onStagePh, _this$props;

      (_this$props$onStagePh = (_this$props = this.props).onStagePhaseChange) === null || _this$props$onStagePh === void 0 ? void 0 : _this$props$onStagePh.call(_this$props, this.state.authStage, newPhase || 0);
    });
    (0, _defineProperty2.default)(this, "onStageCancel", () => {
      this.props.onAuthFinished(false, ERROR_USER_CANCELLED);
    });
    (0, _defineProperty2.default)(this, "onAuthStageFailed", e => {
      this.props.onAuthFinished(false, e);
    });
    (0, _defineProperty2.default)(this, "setEmailSid", sid => {
      this.authLogic.setEmailSid(sid);
    });
    this.state = {
      authStage: null,
      busy: false,
      errorText: null,
      errorCode: null,
      submitButtonEnabled: false
    };
    this.authLogic = new _interactiveAuth.InteractiveAuth({
      authData: this.props.authData,
      doRequest: this.requestCallback,
      busyChanged: this.onBusyChanged,
      inputs: this.props.inputs,
      stateUpdated: this.authStateUpdated,
      matrixClient: this.props.matrixClient,
      sessionId: this.props.sessionId,
      clientSecret: this.props.clientSecret,
      emailSid: this.props.emailSid,
      requestEmailToken: this.requestEmailToken
    });

    if (this.props.poll) {
      this.intervalId = setInterval(() => {
        this.authLogic.poll();
      }, 2000);
    }
  } // TODO: [REACT-WARNING] Replace component with real class, use constructor for refs


  UNSAFE_componentWillMount() {
    // eslint-disable-line @typescript-eslint/naming-convention, camelcase
    this.authLogic.attemptAuth().then(result => {
      const extra = {
        emailSid: this.authLogic.getEmailSid(),
        clientSecret: this.authLogic.getClientSecret()
      };
      this.props.onAuthFinished(true, result, extra);
    }).catch(error => {
      this.props.onAuthFinished(false, error);

      _logger.logger.error("Error during user-interactive auth:", error);

      if (this.unmounted) {
        return;
      }

      const msg = error.message || error.toString();
      this.setState({
        errorText: msg,
        errorCode: error.errcode
      });
    });
  }

  componentWillUnmount() {
    this.unmounted = true;

    if (this.intervalId !== null) {
      clearInterval(this.intervalId);
    }
  }

  setFocus() {
    var _this$stageComponent$5, _this$stageComponent$6;

    (_this$stageComponent$5 = this.stageComponent.current) === null || _this$stageComponent$5 === void 0 ? void 0 : (_this$stageComponent$6 = _this$stageComponent$5.focus) === null || _this$stageComponent$6 === void 0 ? void 0 : _this$stageComponent$6.call(_this$stageComponent$5);
  }

  render() {
    const stage = this.state.authStage;

    if (!stage) {
      if (this.state.busy) {
        return /*#__PURE__*/_react.default.createElement(_Spinner.default, null);
      } else {
        return null;
      }
    }

    const StageComponent = (0, _InteractiveAuthEntryComponents.default)(stage);
    return /*#__PURE__*/_react.default.createElement(StageComponent, {
      ref: this.stageComponent,
      loginType: stage,
      matrixClient: this.props.matrixClient,
      authSessionId: this.authLogic.getSessionId(),
      clientSecret: this.authLogic.getClientSecret(),
      stageParams: this.authLogic.getStageParams(stage),
      submitAuthDict: this.submitAuthDict,
      errorText: this.state.errorText,
      errorCode: this.state.errorCode,
      busy: this.state.busy,
      inputs: this.props.inputs,
      stageState: this.state.stageState,
      fail: this.onAuthStageFailed,
      setEmailSid: this.setEmailSid,
      showContinue: !this.props.continueIsManaged,
      onPhaseChange: this.onPhaseChange,
      continueText: this.props.continueText,
      continueKind: this.props.continueKind,
      onCancel: this.onStageCancel
    });
  }

}) || _class);
exports.default = InteractiveAuthComponent;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3N0cnVjdHVyZXMvSW50ZXJhY3RpdmVBdXRoLnRzeCJdLCJuYW1lcyI6WyJFUlJPUl9VU0VSX0NBTkNFTExFRCIsIkVycm9yIiwiSW50ZXJhY3RpdmVBdXRoQ29tcG9uZW50IiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwiZW1haWwiLCJzZWNyZXQiLCJhdHRlbXB0Iiwic2Vzc2lvbiIsInNldFN0YXRlIiwiYnVzeSIsInJlcXVlc3RFbWFpbFRva2VuIiwic3RhZ2VDb21wb25lbnQiLCJjdXJyZW50IiwidHJ5Q29udGludWUiLCJzdGFnZVR5cGUiLCJzdGFnZVN0YXRlIiwib2xkU3RhZ2UiLCJzdGF0ZSIsImF1dGhTdGFnZSIsImVycm9yVGV4dCIsImVycm9yIiwiZXJyb3JDb2RlIiwiZXJyY29kZSIsInNldEZvY3VzIiwiYXR0ZW1wdEZhaWxlZCIsImF1dGgiLCJiYWNrZ3JvdW5kIiwibWFrZVJlcXVlc3QiLCJhdXRoRGF0YSIsImF1dGhMb2dpYyIsInN1Ym1pdEF1dGhEaWN0IiwibmV3UGhhc2UiLCJvblN0YWdlUGhhc2VDaGFuZ2UiLCJvbkF1dGhGaW5pc2hlZCIsImUiLCJzaWQiLCJzZXRFbWFpbFNpZCIsInN1Ym1pdEJ1dHRvbkVuYWJsZWQiLCJJbnRlcmFjdGl2ZUF1dGgiLCJkb1JlcXVlc3QiLCJyZXF1ZXN0Q2FsbGJhY2siLCJidXN5Q2hhbmdlZCIsIm9uQnVzeUNoYW5nZWQiLCJpbnB1dHMiLCJzdGF0ZVVwZGF0ZWQiLCJhdXRoU3RhdGVVcGRhdGVkIiwibWF0cml4Q2xpZW50Iiwic2Vzc2lvbklkIiwiY2xpZW50U2VjcmV0IiwiZW1haWxTaWQiLCJwb2xsIiwiaW50ZXJ2YWxJZCIsInNldEludGVydmFsIiwiVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCIsImF0dGVtcHRBdXRoIiwidGhlbiIsInJlc3VsdCIsImV4dHJhIiwiZ2V0RW1haWxTaWQiLCJnZXRDbGllbnRTZWNyZXQiLCJjYXRjaCIsImxvZ2dlciIsInVubW91bnRlZCIsIm1zZyIsIm1lc3NhZ2UiLCJ0b1N0cmluZyIsImNvbXBvbmVudFdpbGxVbm1vdW50IiwiY2xlYXJJbnRlcnZhbCIsImZvY3VzIiwicmVuZGVyIiwic3RhZ2UiLCJTdGFnZUNvbXBvbmVudCIsImdldFNlc3Npb25JZCIsImdldFN0YWdlUGFyYW1zIiwib25BdXRoU3RhZ2VGYWlsZWQiLCJjb250aW51ZUlzTWFuYWdlZCIsIm9uUGhhc2VDaGFuZ2UiLCJjb250aW51ZVRleHQiLCJjb250aW51ZUtpbmQiLCJvblN0YWdlQ2FuY2VsIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWdCQTs7QUFTQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFFQTs7Ozs7Ozs7QUFFTyxNQUFNQSxvQkFBb0IsR0FBRyxJQUFJQyxLQUFKLENBQVUsNkJBQVYsQ0FBN0I7O0lBNERjQyx3QixXQURwQixnREFBcUIscUNBQXJCLEMsZ0JBQUQsTUFDcUJBLHdCQURyQixTQUNzREMsZUFBTUMsU0FENUQsQ0FDc0Y7QUFPbEZDLEVBQUFBLFdBQVcsQ0FBQ0MsS0FBRCxFQUFRO0FBQ2YsVUFBTUEsS0FBTjtBQURlO0FBQUEsc0RBTG1CLElBS25CO0FBQUEsdUVBSmUsdUJBSWY7QUFBQSxxREFGQyxLQUVEO0FBQUEsNkRBOERTLE9BQ3hCQyxLQUR3QixFQUV4QkMsTUFGd0IsRUFHeEJDLE9BSHdCLEVBSXhCQyxPQUp3QixLQUtDO0FBQ3pCLFdBQUtDLFFBQUwsQ0FBYztBQUNWQyxRQUFBQSxJQUFJLEVBQUU7QUFESSxPQUFkOztBQUdBLFVBQUk7QUFDQSxlQUFPLE1BQU0sS0FBS04sS0FBTCxDQUFXTyxpQkFBWCxDQUE2Qk4sS0FBN0IsRUFBb0NDLE1BQXBDLEVBQTRDQyxPQUE1QyxFQUFxREMsT0FBckQsQ0FBYjtBQUNILE9BRkQsU0FFVTtBQUNOLGFBQUtDLFFBQUwsQ0FBYztBQUNWQyxVQUFBQSxJQUFJLEVBQUU7QUFESSxTQUFkO0FBR0g7QUFDSixLQTlFa0I7QUFBQSx1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RSxLQUFLYixLQUFMLENBQVdFLFNBUjFCO0FBU0ksTUFBQSxTQUFTLEVBQUUsS0FBS0YsS0FBTCxDQUFXSSxTQVQxQjtBQVVJLE1BQUEsSUFBSSxFQUFFLEtBQUtKLEtBQUwsQ0FBV1IsSUFWckI7QUFXSSxNQUFBLE1BQU0sRUFBRSxLQUFLTixLQUFMLENBQVd3QyxNQVh2QjtBQVlJLE1BQUEsVUFBVSxFQUFFLEtBQUsxQixLQUFMLENBQVdGLFVBWjNCO0FBYUksTUFBQSxJQUFJLEVBQUUsS0FBSzJELGlCQWJmO0FBY0ksTUFBQSxXQUFXLEVBQUUsS0FBS3RDLFdBZHRCO0FBZUksTUFBQSxZQUFZLEVBQUUsQ0FBQyxLQUFLakMsS0FBTCxDQUFXd0UsaUJBZjlCO0FBZ0JJLE1BQUEsYUFBYSxFQUFFLEtBQUtDLGFBaEJ4QjtBQWlCSSxNQUFBLFlBQVksRUFBRSxLQUFLekUsS0FBTCxDQUFXMEUsWUFqQjdCO0FBa0JJLE1BQUEsWUFBWSxFQUFFLEtBQUsxRSxLQUFMLENBQVcyRSxZQWxCN0I7QUFtQkksTUFBQSxRQUFRLEVBQUUsS0FBS0M7QUFuQm5CLE1BREo7QUF1Qkg7O0FBOUxpRixDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE3IC0gMjAyMSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCB7XG4gICAgQXV0aFR5cGUsXG4gICAgSUF1dGhEYXRhLFxuICAgIElBdXRoRGljdCxcbiAgICBJSW5wdXRzLFxuICAgIEludGVyYWN0aXZlQXV0aCxcbiAgICBJU3RhZ2VTdGF0dXMsXG59IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9pbnRlcmFjdGl2ZS1hdXRoXCI7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnQgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvY2xpZW50XCI7XG5pbXBvcnQgUmVhY3QsIHsgY3JlYXRlUmVmIH0gZnJvbSAncmVhY3QnO1xuXG5pbXBvcnQgZ2V0RW50cnlDb21wb25lbnRGb3JMb2dpblR5cGUsIHsgSVN0YWdlQ29tcG9uZW50IH0gZnJvbSAnLi4vdmlld3MvYXV0aC9JbnRlcmFjdGl2ZUF1dGhFbnRyeUNvbXBvbmVudHMnO1xuaW1wb3J0IFNwaW5uZXIgZnJvbSBcIi4uL3ZpZXdzL2VsZW1lbnRzL1NwaW5uZXJcIjtcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcblxuZXhwb3J0IGNvbnN0IEVSUk9SX1VTRVJfQ0FOQ0VMTEVEID0gbmV3IEVycm9yKFwiVXNlciBjYW5jZWxsZWQgYXV0aCBzZXNzaW9uXCIpO1xuXG5pbnRlcmZhY2UgSVByb3BzIHtcbiAgICAvLyBtYXRyaXggY2xpZW50IHRvIHVzZSBmb3IgVUkgYXV0aCByZXF1ZXN0c1xuICAgIG1hdHJpeENsaWVudDogTWF0cml4Q2xpZW50O1xuICAgIC8vIHJlc3BvbnNlIGZyb20gaW5pdGlhbCByZXF1ZXN0LiBJZiBub3Qgc3VwcGxpZWQsIHdpbGwgZG8gYSByZXF1ZXN0IG9uIG1vdW50LlxuICAgIGF1dGhEYXRhPzogSUF1dGhEYXRhO1xuICAgIC8vIElucHV0cyBwcm92aWRlZCBieSB0aGUgdXNlciB0byB0aGUgYXV0aCBwcm9jZXNzXG4gICAgLy8gYW5kIHVzZWQgYnkgdmFyaW91cyBzdGFnZXMuIEFzIHBhc3NlZCB0byBqcy1zZGtcbiAgICAvLyBpbnRlcmFjdGl2ZS1hdXRoXG4gICAgaW5wdXRzPzogSUlucHV0cztcbiAgICBzZXNzaW9uSWQ/OiBzdHJpbmc7XG4gICAgY2xpZW50U2VjcmV0Pzogc3RyaW5nO1xuICAgIGVtYWlsU2lkPzogc3RyaW5nO1xuICAgIC8vIElmIHRydWUsIHBvbGwgdG8gc2VlIGlmIHRoZSBhdXRoIGZsb3cgaGFzIGJlZW4gY29tcGxldGVkIG91dC1vZi1iYW5kXG4gICAgcG9sbD86IGJvb2xlYW47XG4gICAgLy8gSWYgdHJ1ZSwgY29tcG9uZW50cyB3aWxsIGJlIHRvbGQgdGhhdCB0aGUgJ0NvbnRpbnVlJyBidXR0b25cbiAgICAvLyBpcyBtYW5hZ2VkIGJ5IHNvbWUgb3RoZXIgcGFydHkgYW5kIHNob3VsZCBub3QgYmUgbWFuYWdlZCBieVxuICAgIC8vIHRoZSBjb21wb25lbnQgaXRzZWxmLlxuICAgIGNvbnRpbnVlSXNNYW5hZ2VkPzogYm9vbGVhbjtcbiAgICAvLyBjb250aW51ZVRleHQgYW5kIGNvbnRpbnVlS2luZCBhcmUgcGFzc2VkIHN0cmFpZ2h0IHRocm91Z2ggdG8gdGhlIEF1dGhFbnRyeUNvbXBvbmVudC5cbiAgICBjb250aW51ZVRleHQ/OiBzdHJpbmc7XG4gICAgY29udGludWVLaW5kPzogc3RyaW5nO1xuICAgIC8vIGNhbGxiYWNrXG4gICAgbWFrZVJlcXVlc3QoYXV0aDogSUF1dGhEYXRhKTogUHJvbWlzZTxJQXV0aERhdGE+O1xuICAgIC8vIGNhbGxiYWNrIGNhbGxlZCB3aGVuIHRoZSBhdXRoIHByb2Nlc3MgaGFzIGZpbmlzaGVkLFxuICAgIC8vIHN1Y2Nlc3NmdWxseSBvciB1bnN1Y2Nlc3NmdWxseS5cbiAgICAvLyBAcGFyYW0ge2Jvb2xlYW59IHN0YXR1cyBUcnVlIGlmIHRoZSBvcGVyYXRpb24gcmVxdWlyaW5nXG4gICAgLy8gICAgIGF1dGggd2FzIGNvbXBsZXRlZCBzdWNjZXNzZnVsbHksIGZhbHNlIGlmIGNhbmNlbGVkLlxuICAgIC8vIEBwYXJhbSB7b2JqZWN0fSByZXN1bHQgVGhlIHJlc3VsdCBvZiB0aGUgYXV0aGVudGljYXRlZCBjYWxsXG4gICAgLy8gICAgIGlmIHN1Y2Nlc3NmdWwsIG90aGVyd2lzZSB0aGUgZXJyb3Igb2JqZWN0LlxuICAgIC8vIEBwYXJhbSB7b2JqZWN0fSBleHRyYSBBZGRpdGlvbmFsIGluZm9ybWF0aW9uIGFib3V0IHRoZSBVSSBBdXRoXG4gICAgLy8gICAgIHByb2Nlc3M6XG4gICAgLy8gICAgICAqIGVtYWlsU2lkIHtzdHJpbmd9IElmIGVtYWlsIGF1dGggd2FzIHBlcmZvcm1lZCwgdGhlIHNpZCBvZlxuICAgIC8vICAgICAgICAgICAgdGhlIGF1dGggc2Vzc2lvbi5cbiAgICAvLyAgICAgICogY2xpZW50U2VjcmV0IHtzdHJpbmd9IFRoZSBjbGllbnQgc2VjcmV0IHVzZWQgaW4gYXV0aFxuICAgIC8vICAgICAgICAgICAgc2Vzc2lvbnMgd2l0aCB0aGUgSUQgc2VydmVyLlxuICAgIG9uQXV0aEZpbmlzaGVkKFxuICAgICAgICBzdGF0dXM6IGJvb2xlYW4sXG4gICAgICAgIHJlc3VsdDogSUF1dGhEYXRhIHwgRXJyb3IsXG4gICAgICAgIGV4dHJhPzogeyBlbWFpbFNpZD86IHN0cmluZywgY2xpZW50U2VjcmV0Pzogc3RyaW5nIH0sXG4gICAgKTogdm9pZDtcbiAgICAvLyBBcyBqcy1zZGsgaW50ZXJhY3RpdmUtYXV0aFxuICAgIHJlcXVlc3RFbWFpbFRva2VuPyhlbWFpbDogc3RyaW5nLCBzZWNyZXQ6IHN0cmluZywgYXR0ZW1wdDogbnVtYmVyLCBzZXNzaW9uOiBzdHJpbmcpOiBQcm9taXNlPHsgc2lkOiBzdHJpbmcgfT47XG4gICAgLy8gQ2FsbGVkIHdoZW4gdGhlIHN0YWdlIGNoYW5nZXMsIG9yIHRoZSBzdGFnZSdzIHBoYXNlIGNoYW5nZXMuIEZpcnN0XG4gICAgLy8gYXJndW1lbnQgaXMgdGhlIHN0YWdlLCBzZWNvbmQgaXMgdGhlIHBoYXNlLiBTb21lIHN0YWdlcyBkbyBub3QgaGF2ZVxuICAgIC8vIHBoYXNlcyBhbmQgd2lsbCBiZSBjb3VudGVkIGFzIDAgKG51bWVyaWMpLlxuICAgIG9uU3RhZ2VQaGFzZUNoYW5nZT8oc3RhZ2U6IHN0cmluZywgcGhhc2U6IHN0cmluZyB8IG51bWJlcik6IHZvaWQ7XG59XG5cbmludGVyZmFjZSBJU3RhdGUge1xuICAgIGF1dGhTdGFnZT86IEF1dGhUeXBlO1xuICAgIHN0YWdlU3RhdGU/OiBJU3RhZ2VTdGF0dXM7XG4gICAgYnVzeTogYm9vbGVhbjtcbiAgICBlcnJvclRleHQ/OiBzdHJpbmc7XG4gICAgZXJyb3JDb2RlPzogc3RyaW5nO1xuICAgIHN1Ym1pdEJ1dHRvbkVuYWJsZWQ6IGJvb2xlYW47XG59XG5cbkByZXBsYWNlYWJsZUNvbXBvbmVudChcInN0cnVjdHVyZXMuSW50ZXJhY3RpdmVBdXRoQ29tcG9uZW50XCIpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBJbnRlcmFjdGl2ZUF1dGhDb21wb25lbnQgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8SVByb3BzLCBJU3RhdGU+IHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGF1dGhMb2dpYzogSW50ZXJhY3RpdmVBdXRoO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgaW50ZXJ2YWxJZDogbnVtYmVyID0gbnVsbDtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHN0YWdlQ29tcG9uZW50ID0gY3JlYXRlUmVmPElTdGFnZUNvbXBvbmVudD4oKTtcblxuICAgIHByaXZhdGUgdW5tb3VudGVkID0gZmFsc2U7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG5cbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIGF1dGhTdGFnZTogbnVsbCxcbiAgICAgICAgICAgIGJ1c3k6IGZhbHNlLFxuICAgICAgICAgICAgZXJyb3JUZXh0OiBudWxsLFxuICAgICAgICAgICAgZXJyb3JDb2RlOiBudWxsLFxuICAgICAgICAgICAgc3VibWl0QnV0dG9uRW5hYmxlZDogZmFsc2UsXG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5hdXRoTG9naWMgPSBuZXcgSW50ZXJhY3RpdmVBdXRoKHtcbiAgICAgICAgICAgIGF1dGhEYXRhOiB0aGlzLnByb3BzLmF1dGhEYXRhLFxuICAgICAgICAgICAgZG9SZXF1ZXN0OiB0aGlzLnJlcXVlc3RDYWxsYmFjayxcbiAgICAgICAgICAgIGJ1c3lDaGFuZ2VkOiB0aGlzLm9uQnVzeUNoYW5nZWQsXG4gICAgICAgICAgICBpbnB1dHM6IHRoaXMucHJvcHMuaW5wdXRzLFxuICAgICAgICAgICAgc3RhdGVVcGRhdGVkOiB0aGlzLmF1dGhTdGF0ZVVwZGF0ZWQsXG4gICAgICAgICAgICBtYXRyaXhDbGllbnQ6IHRoaXMucHJvcHMubWF0cml4Q2xpZW50LFxuICAgICAgICAgICAgc2Vzc2lvbklkOiB0aGlzLnByb3BzLnNlc3Npb25JZCxcbiAgICAgICAgICAgIGNsaWVudFNlY3JldDogdGhpcy5wcm9wcy5jbGllbnRTZWNyZXQsXG4gICAgICAgICAgICBlbWFpbFNpZDogdGhpcy5wcm9wcy5lbWFpbFNpZCxcbiAgICAgICAgICAgIHJlcXVlc3RFbWFpbFRva2VuOiB0aGlzLnJlcXVlc3RFbWFpbFRva2VuLFxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAodGhpcy5wcm9wcy5wb2xsKSB7XG4gICAgICAgICAgICB0aGlzLmludGVydmFsSWQgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5hdXRoTG9naWMucG9sbCgpO1xuICAgICAgICAgICAgfSwgMjAwMCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBUT0RPOiBbUkVBQ1QtV0FSTklOR10gUmVwbGFjZSBjb21wb25lbnQgd2l0aCByZWFsIGNsYXNzLCB1c2UgY29uc3RydWN0b3IgZm9yIHJlZnNcbiAgICBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50KCkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uYW1pbmctY29udmVudGlvbiwgY2FtZWxjYXNlXG4gICAgICAgIHRoaXMuYXV0aExvZ2ljLmF0dGVtcHRBdXRoKCkudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBleHRyYSA9IHtcbiAgICAgICAgICAgICAgICBlbWFpbFNpZDogdGhpcy5hdXRoTG9naWMuZ2V0RW1haWxTaWQoKSxcbiAgICAgICAgICAgICAgICBjbGllbnRTZWNyZXQ6IHRoaXMuYXV0aExvZ2ljLmdldENsaWVudFNlY3JldCgpLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMucHJvcHMub25BdXRoRmluaXNoZWQodHJ1ZSwgcmVzdWx0LCBleHRyYSk7XG4gICAgICAgIH0pLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICAgICAgdGhpcy5wcm9wcy5vbkF1dGhGaW5pc2hlZChmYWxzZSwgZXJyb3IpO1xuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKFwiRXJyb3IgZHVyaW5nIHVzZXItaW50ZXJhY3RpdmUgYXV0aDpcIiwgZXJyb3IpO1xuICAgICAgICAgICAgaWYgKHRoaXMudW5tb3VudGVkKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBtc2cgPSBlcnJvci5tZXNzYWdlIHx8IGVycm9yLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICBlcnJvclRleHQ6IG1zZyxcbiAgICAgICAgICAgICAgICBlcnJvckNvZGU6IGVycm9yLmVycmNvZGUsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgICAgIHRoaXMudW5tb3VudGVkID0gdHJ1ZTtcblxuICAgICAgICBpZiAodGhpcy5pbnRlcnZhbElkICE9PSBudWxsKSB7XG4gICAgICAgICAgICBjbGVhckludGVydmFsKHRoaXMuaW50ZXJ2YWxJZCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHJlcXVlc3RFbWFpbFRva2VuID0gYXN5bmMgKFxuICAgICAgICBlbWFpbDogc3RyaW5nLFxuICAgICAgICBzZWNyZXQ6IHN0cmluZyxcbiAgICAgICAgYXR0ZW1wdDogbnVtYmVyLFxuICAgICAgICBzZXNzaW9uOiBzdHJpbmcsXG4gICAgKTogUHJvbWlzZTx7c2lkOiBzdHJpbmd9PiA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgYnVzeTogdHJ1ZSxcbiAgICAgICAgfSk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm9wcy5yZXF1ZXN0RW1haWxUb2tlbihlbWFpbCwgc2VjcmV0LCBhdHRlbXB0LCBzZXNzaW9uKTtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgIGJ1c3k6IGZhbHNlLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSB0cnlDb250aW51ZSA9ICgpOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5zdGFnZUNvbXBvbmVudC5jdXJyZW50Py50cnlDb250aW51ZT8uKCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgYXV0aFN0YXRlVXBkYXRlZCA9IChzdGFnZVR5cGU6IEF1dGhUeXBlLCBzdGFnZVN0YXRlOiBJU3RhZ2VTdGF0dXMpOiB2b2lkID0+IHtcbiAgICAgICAgY29uc3Qgb2xkU3RhZ2UgPSB0aGlzLnN0YXRlLmF1dGhTdGFnZTtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBidXN5OiBmYWxzZSxcbiAgICAgICAgICAgIGF1dGhTdGFnZTogc3RhZ2VUeXBlLFxuICAgICAgICAgICAgc3RhZ2VTdGF0ZTogc3RhZ2VTdGF0ZSxcbiAgICAgICAgICAgIGVycm9yVGV4dDogc3RhZ2VTdGF0ZS5lcnJvcixcbiAgICAgICAgICAgIGVycm9yQ29kZTogc3RhZ2VTdGF0ZS5lcnJjb2RlLFxuICAgICAgICB9LCAoKSA9PiB7XG4gICAgICAgICAgICBpZiAob2xkU3RhZ2UgIT09IHN0YWdlVHlwZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0Rm9jdXMoKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIXN0YWdlU3RhdGUuZXJyb3IpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YWdlQ29tcG9uZW50LmN1cnJlbnQ/LmF0dGVtcHRGYWlsZWQ/LigpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSByZXF1ZXN0Q2FsbGJhY2sgPSAoYXV0aDogSUF1dGhEYXRhLCBiYWNrZ3JvdW5kOiBib29sZWFuKTogUHJvbWlzZTxJQXV0aERhdGE+ID0+IHtcbiAgICAgICAgLy8gVGhpcyB3cmFwcGVyIGp1c3QgZXhpc3RzIGJlY2F1c2UgdGhlIGpzLXNkayBwYXNzZXMgYSBzZWNvbmRcbiAgICAgICAgLy8gJ2J1c3knIHBhcmFtIGZvciBiYWNrd2FyZHMgY29tcGF0LiBUaGlzIHRocm93cyB0aGUgdGVzdHMgb2ZmXG4gICAgICAgIC8vIHNvIGRpc2NhcmQgaXQgaGVyZS5cbiAgICAgICAgcmV0dXJuIHRoaXMucHJvcHMubWFrZVJlcXVlc3QoYXV0aCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25CdXN5Q2hhbmdlZCA9IChidXN5OiBib29sZWFuKTogdm9pZCA9PiB7XG4gICAgICAgIC8vIGlmIHdlJ3ZlIHN0YXJ0ZWQgZG9pbmcgc3R1ZmYsIHJlc2V0IHRoZSBlcnJvciBtZXNzYWdlc1xuICAgICAgICBpZiAoYnVzeSkge1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgYnVzeTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBlcnJvclRleHQ6IG51bGwsXG4gICAgICAgICAgICAgICAgZXJyb3JDb2RlOiBudWxsLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gVGhlIEpTIFNESyBlYWdlcmx5IHJlcG9ydHMgaXRzZWxmIGFzIFwibm90IGJ1c3lcIiByaWdodCBhZnRlciBhbnlcbiAgICAgICAgLy8gaW1tZWRpYXRlIHdvcmsgaGFzIGNvbXBsZXRlZCwgYnV0IHRoYXQncyBub3QgcmVhbGx5IHdoYXQgd2Ugd2FudCBhdFxuICAgICAgICAvLyB0aGUgVUkgbGF5ZXIsIHNvIHdlIGlnbm9yZSB0aGlzIHNpZ25hbCBhbmQgc2hvdyBhIHNwaW5uZXIgdW50aWxcbiAgICAgICAgLy8gdGhlcmUncyBhIG5ldyBzY3JlZW4gdG8gc2hvdyB0aGUgdXNlci4gVGhpcyBpcyBpbXBsZW1lbnRlZCBieSBzZXR0aW5nXG4gICAgICAgIC8vIGBidXN5OiBmYWxzZWAgaW4gYGF1dGhTdGF0ZVVwZGF0ZWRgLlxuICAgICAgICAvLyBTZWUgYWxzbyBodHRwczovL2dpdGh1Yi5jb20vdmVjdG9yLWltL2VsZW1lbnQtd2ViL2lzc3Vlcy8xMjU0NlxuICAgIH07XG5cbiAgICBwcml2YXRlIHNldEZvY3VzKCk6IHZvaWQge1xuICAgICAgICB0aGlzLnN0YWdlQ29tcG9uZW50LmN1cnJlbnQ/LmZvY3VzPy4oKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN1Ym1pdEF1dGhEaWN0ID0gKGF1dGhEYXRhOiBJQXV0aERpY3QpOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5hdXRoTG9naWMuc3VibWl0QXV0aERpY3QoYXV0aERhdGEpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uUGhhc2VDaGFuZ2UgPSAobmV3UGhhc2U6IG51bWJlcik6IHZvaWQgPT4ge1xuICAgICAgICB0aGlzLnByb3BzLm9uU3RhZ2VQaGFzZUNoYW5nZT8uKHRoaXMuc3RhdGUuYXV0aFN0YWdlLCBuZXdQaGFzZSB8fCAwKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvblN0YWdlQ2FuY2VsID0gKCk6IHZvaWQgPT4ge1xuICAgICAgICB0aGlzLnByb3BzLm9uQXV0aEZpbmlzaGVkKGZhbHNlLCBFUlJPUl9VU0VSX0NBTkNFTExFRCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25BdXRoU3RhZ2VGYWlsZWQgPSAoZTogRXJyb3IpOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5wcm9wcy5vbkF1dGhGaW5pc2hlZChmYWxzZSwgZSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgc2V0RW1haWxTaWQgPSAoc2lkOiBzdHJpbmcpOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5hdXRoTG9naWMuc2V0RW1haWxTaWQoc2lkKTtcbiAgICB9O1xuXG4gICAgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCBzdGFnZSA9IHRoaXMuc3RhdGUuYXV0aFN0YWdlO1xuICAgICAgICBpZiAoIXN0YWdlKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5zdGF0ZS5idXN5KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDxTcGlubmVyIC8+O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IFN0YWdlQ29tcG9uZW50ID0gZ2V0RW50cnlDb21wb25lbnRGb3JMb2dpblR5cGUoc3RhZ2UpO1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPFN0YWdlQ29tcG9uZW50XG4gICAgICAgICAgICAgICAgcmVmPXt0aGlzLnN0YWdlQ29tcG9uZW50IGFzIGFueX1cbiAgICAgICAgICAgICAgICBsb2dpblR5cGU9e3N0YWdlfVxuICAgICAgICAgICAgICAgIG1hdHJpeENsaWVudD17dGhpcy5wcm9wcy5tYXRyaXhDbGllbnR9XG4gICAgICAgICAgICAgICAgYXV0aFNlc3Npb25JZD17dGhpcy5hdXRoTG9naWMuZ2V0U2Vzc2lvbklkKCl9XG4gICAgICAgICAgICAgICAgY2xpZW50U2VjcmV0PXt0aGlzLmF1dGhMb2dpYy5nZXRDbGllbnRTZWNyZXQoKX1cbiAgICAgICAgICAgICAgICBzdGFnZVBhcmFtcz17dGhpcy5hdXRoTG9naWMuZ2V0U3RhZ2VQYXJhbXMoc3RhZ2UpfVxuICAgICAgICAgICAgICAgIHN1Ym1pdEF1dGhEaWN0PXt0aGlzLnN1Ym1pdEF1dGhEaWN0fVxuICAgICAgICAgICAgICAgIGVycm9yVGV4dD17dGhpcy5zdGF0ZS5lcnJvclRleHR9XG4gICAgICAgICAgICAgICAgZXJyb3JDb2RlPXt0aGlzLnN0YXRlLmVycm9yQ29kZX1cbiAgICAgICAgICAgICAgICBidXN5PXt0aGlzLnN0YXRlLmJ1c3l9XG4gICAgICAgICAgICAgICAgaW5wdXRzPXt0aGlzLnByb3BzLmlucHV0c31cbiAgICAgICAgICAgICAgICBzdGFnZVN0YXRlPXt0aGlzLnN0YXRlLnN0YWdlU3RhdGV9XG4gICAgICAgICAgICAgICAgZmFpbD17dGhpcy5vbkF1dGhTdGFnZUZhaWxlZH1cbiAgICAgICAgICAgICAgICBzZXRFbWFpbFNpZD17dGhpcy5zZXRFbWFpbFNpZH1cbiAgICAgICAgICAgICAgICBzaG93Q29udGludWU9eyF0aGlzLnByb3BzLmNvbnRpbnVlSXNNYW5hZ2VkfVxuICAgICAgICAgICAgICAgIG9uUGhhc2VDaGFuZ2U9e3RoaXMub25QaGFzZUNoYW5nZX1cbiAgICAgICAgICAgICAgICBjb250aW51ZVRleHQ9e3RoaXMucHJvcHMuY29udGludWVUZXh0fVxuICAgICAgICAgICAgICAgIGNvbnRpbnVlS2luZD17dGhpcy5wcm9wcy5jb250aW51ZUtpbmR9XG4gICAgICAgICAgICAgICAgb25DYW5jZWw9e3RoaXMub25TdGFnZUNhbmNlbH1cbiAgICAgICAgICAgIC8+XG4gICAgICAgICk7XG4gICAgfVxufVxuIl19