"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _languageHandler = require("../../../languageHandler");

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _VerificationRequestDialog = _interopRequireDefault(require("../../views/dialogs/VerificationRequestDialog"));

var _SetupEncryptionStore = require("../../../stores/SetupEncryptionStore");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _EncryptionPanel = _interopRequireDefault(require("../../views/right_panel/EncryptionPanel"));

var _AccessibleButton = _interopRequireDefault(require("../../views/elements/AccessibleButton"));

var _Spinner = _interopRequireDefault(require("../../views/elements/Spinner"));

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class;

function keyHasPassphrase(keyInfo) {
  return Boolean(keyInfo.passphrase && keyInfo.passphrase.salt && keyInfo.passphrase.iterations);
}

let SetupEncryptionBody = (_dec = (0, _replaceableComponent.replaceableComponent)("structures.auth.SetupEncryptionBody"), _dec(_class = class SetupEncryptionBody extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onStoreUpdate", () => {
      const store = _SetupEncryptionStore.SetupEncryptionStore.sharedInstance();

      if (store.phase === _SetupEncryptionStore.Phase.Finished) {
        this.props.onFinished();
        return;
      }

      this.setState({
        phase: store.phase,
        verificationRequest: store.verificationRequest,
        backupInfo: store.backupInfo,
        lostKeys: store.lostKeys()
      });
    });
    (0, _defineProperty2.default)(this, "onUsePassphraseClick", async () => {
      const store = _SetupEncryptionStore.SetupEncryptionStore.sharedInstance();

      store.usePassPhrase();
    });
    (0, _defineProperty2.default)(this, "onVerifyClick", () => {
      const cli = _MatrixClientPeg.MatrixClientPeg.get();

      const userId = cli.getUserId();
      const requestPromise = cli.requestVerification(userId); // We need to call onFinished now to close this dialog, and
      // again later to signal that the verification is complete.

      this.props.onFinished();

      _Modal.default.createTrackedDialog('New Session Verification', 'Starting dialog', _VerificationRequestDialog.default, {
        verificationRequestPromise: requestPromise,
        member: cli.getUser(userId),
        onFinished: async () => {
          const request = await requestPromise;
          request.cancel();
          this.props.onFinished();
        }
      });
    });
    (0, _defineProperty2.default)(this, "onSkipConfirmClick", () => {
      const store = _SetupEncryptionStore.SetupEncryptionStore.sharedInstance();

      store.skipConfirm();
    });
    (0, _defineProperty2.default)(this, "onSkipBackClick", () => {
      const store = _SetupEncryptionStore.SetupEncryptionStore.sharedInstance();

      store.returnAfterSkip();
    });
    (0, _defineProperty2.default)(this, "onResetClick", ev => {
      ev.preventDefault();

      const store = _SetupEncryptionStore.SetupEncryptionStore.sharedInstance();

      store.reset();
    });
    (0, _defineProperty2.default)(this, "onResetConfirmClick", () => {
      this.props.onFinished();

      const store = _SetupEncryptionStore.SetupEncryptionStore.sharedInstance();

      store.resetConfirm();
    });
    (0, _defineProperty2.default)(this, "onResetBackClick", () => {
      const store = _SetupEncryptionStore.SetupEncryptionStore.sharedInstance();

      store.returnAfterReset();
    });
    (0, _defineProperty2.default)(this, "onDoneClick", () => {
      const store = _SetupEncryptionStore.SetupEncryptionStore.sharedInstance();

      store.done();
    });
    (0, _defineProperty2.default)(this, "onEncryptionPanelClose", () => {
      this.props.onFinished();
    });

    const _store = _SetupEncryptionStore.SetupEncryptionStore.sharedInstance();

    _store.on("update", this.onStoreUpdate);

    _store.start();

    this.state = {
      phase: _store.phase,
      // this serves dual purpose as the object for the request logic and
      // the presence of it indicating that we're in 'verify mode'.
      // Because of the latter, it lives in the state.
      verificationRequest: _store.verificationRequest,
      backupInfo: _store.backupInfo,
      lostKeys: _store.lostKeys()
    };
  }

  componentWillUnmount() {
    const store = _SetupEncryptionStore.SetupEncryptionStore.sharedInstance();

    store.off("update", this.onStoreUpdate);
    store.stop();
  }

  render() {
    const {
      phase,
      lostKeys
    } = this.state;

    if (this.state.verificationRequest) {
      return /*#__PURE__*/_react.default.createElement(_EncryptionPanel.default, {
        layout: "dialog",
        verificationRequest: this.state.verificationRequest,
        onClose: this.onEncryptionPanelClose,
        member: _MatrixClientPeg.MatrixClientPeg.get().getUser(this.state.verificationRequest.otherUserId),
        isRoomEncrypted: false
      });
    } else if (phase === _SetupEncryptionStore.Phase.Intro) {
      if (lostKeys) {
        return /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("It looks like you don't have a Security Key or any other devices you can " + "verify against.  This device will not be able to access old encrypted messages. " + "In order to verify your identity on this device, you'll need to reset " + "your verification keys.")), /*#__PURE__*/_react.default.createElement("div", {
          className: "mx_CompleteSecurity_actionRow"
        }, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
          kind: "primary",
          onClick: this.onResetConfirmClick
        }, (0, _languageHandler._t)("Proceed with reset"))));
      } else {
        const store = _SetupEncryptionStore.SetupEncryptionStore.sharedInstance();

        let recoveryKeyPrompt;

        if (store.keyInfo && keyHasPassphrase(store.keyInfo)) {
          recoveryKeyPrompt = (0, _languageHandler._t)("Verify with Security Key or Phrase");
        } else if (store.keyInfo) {
          recoveryKeyPrompt = (0, _languageHandler._t)("Verify with Security Key");
        }

        let useRecoveryKeyButton;

        if (recoveryKeyPrompt) {
          useRecoveryKeyButton = /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
            kind: "primary",
            onClick: this.onUsePassphraseClick
          }, recoveryKeyPrompt);
        }

        let verifyButton;

        if (store.hasDevicesToVerifyAgainst) {
          verifyButton = /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
            kind: "primary",
            onClick: this.onVerifyClick
          }, (0, _languageHandler._t)("Verify with another login"));
        }

        return /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Verify your identity to access encrypted messages and prove your identity to others.")), /*#__PURE__*/_react.default.createElement("div", {
          className: "mx_CompleteSecurity_actionRow"
        }, verifyButton, useRecoveryKeyButton), /*#__PURE__*/_react.default.createElement("div", {
          className: "mx_SetupEncryptionBody_reset"
        }, (0, _languageHandler._t)("Forgotten or lost all recovery methods? <a>Reset all</a>", null, {
          a: sub => /*#__PURE__*/_react.default.createElement("a", {
            href: "",
            onClick: this.onResetClick,
            className: "mx_SetupEncryptionBody_reset_link"
          }, sub)
        })));
      }
    } else if (phase === _SetupEncryptionStore.Phase.Done) {
      let message;

      if (this.state.backupInfo) {
        message = /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Your new session is now verified. It has access to your " + "encrypted messages, and other users will see it as trusted."));
      } else {
        message = /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Your new session is now verified. Other users will see it as trusted."));
      }

      return /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_CompleteSecurity_heroIcon mx_E2EIcon_verified"
      }), message, /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_CompleteSecurity_actionRow"
      }, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        kind: "primary",
        onClick: this.onDoneClick
      }, (0, _languageHandler._t)("Done"))));
    } else if (phase === _SetupEncryptionStore.Phase.ConfirmSkip) {
      return /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Without verifying, you won't have access to all your messages " + "and may appear as untrusted to others.")), /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_CompleteSecurity_actionRow"
      }, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        kind: "danger_outline",
        onClick: this.onSkipConfirmClick
      }, (0, _languageHandler._t)("I'll verify later")), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        kind: "primary",
        onClick: this.onSkipBackClick
      }, (0, _languageHandler._t)("Go Back"))));
    } else if (phase === _SetupEncryptionStore.Phase.ConfirmReset) {
      return /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Resetting your verification keys cannot be undone. After resetting, " + "you won't have access to old encrypted messages, and any friends who " + "have previously verified you will see security warnings until you " + "re-verify with them.")), /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Please only proceed if you're sure you've lost all of your other " + "devices and your security key.")), /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_CompleteSecurity_actionRow"
      }, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        kind: "danger_outline",
        onClick: this.onResetConfirmClick
      }, (0, _languageHandler._t)("Proceed with reset")), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        kind: "primary",
        onClick: this.onResetBackClick
      }, (0, _languageHandler._t)("Go Back"))));
    } else if (phase === _SetupEncryptionStore.Phase.Busy || phase === _SetupEncryptionStore.Phase.Loading) {
      return /*#__PURE__*/_react.default.createElement(_Spinner.default, null);
    } else {
      _logger.logger.log(`SetupEncryptionBody: Unknown phase ${phase}`);
    }
  }

}) || _class);
exports.default = SetupEncryptionBody;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3N0cnVjdHVyZXMvYXV0aC9TZXR1cEVuY3J5cHRpb25Cb2R5LnRzeCJdLCJuYW1lcyI6WyJrZXlIYXNQYXNzcGhyYXNlIiwia2V5SW5mbyIsIkJvb2xlYW4iLCJwYXNzcGhyYXNlIiwic2FsdCIsIml0ZXJhdGlvbnMiLCJTZXR1cEVuY3J5cHRpb25Cb2R5IiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwic3RvcmUiLCJTZXR1cEVuY3J5cHRpb25TdG9yZSIsInNoYXJlZEluc3RhbmNlIiwicGhhc2UiLCJQaGFzZSIsIkZpbmlzaGVkIiwib25GaW5pc2hlZCIsInNldFN0YXRlIiwidmVyaWZpY2F0aW9uUmVxdWVzdCIsImJhY2t1cEluZm8iLCJsb3N0S2V5cyIsInVzZVBhc3NQaHJhc2UiLCJjbGkiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJ1c2VySWQiLCJnZXRVc2VySWQiLCJyZXF1ZXN0UHJvbWlzZSIsInJlcXVlc3RWZXJpZmljYXRpb24iLCJNb2RhbCIsImNyZWF0ZVRyYWNrZWREaWFsb2ciLCJWZXJpZmljYXRpb25SZXF1ZXN0RGlhbG9nIiwidmVyaWZpY2F0aW9uUmVxdWVzdFByb21pc2UiLCJtZW1iZXIiLCJnZXRVc2VyIiwicmVxdWVzdCIsImNhbmNlbCIsInNraXBDb25maXJtIiwicmV0dXJuQWZ0ZXJTa2lwIiwiZXYiLCJwcmV2ZW50RGVmYXVsdCIsInJlc2V0IiwicmVzZXRDb25maXJtIiwicmV0dXJuQWZ0ZXJSZXNldCIsImRvbmUiLCJvbiIsIm9uU3RvcmVVcGRhdGUiLCJzdGFydCIsInN0YXRlIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJvZmYiLCJzdG9wIiwicmVuZGVyIiwib25FbmNyeXB0aW9uUGFuZWxDbG9zZSIsIm90aGVyVXNlcklkIiwiSW50cm8iLCJvblJlc2V0Q29uZmlybUNsaWNrIiwicmVjb3ZlcnlLZXlQcm9tcHQiLCJ1c2VSZWNvdmVyeUtleUJ1dHRvbiIsIm9uVXNlUGFzc3BocmFzZUNsaWNrIiwidmVyaWZ5QnV0dG9uIiwiaGFzRGV2aWNlc1RvVmVyaWZ5QWdhaW5zdCIsIm9uVmVyaWZ5Q2xpY2siLCJhIiwic3ViIiwib25SZXNldENsaWNrIiwiRG9uZSIsIm1lc3NhZ2UiLCJvbkRvbmVDbGljayIsIkNvbmZpcm1Ta2lwIiwib25Ta2lwQ29uZmlybUNsaWNrIiwib25Ta2lwQmFja0NsaWNrIiwiQ29uZmlybVJlc2V0Iiwib25SZXNldEJhY2tDbGljayIsIkJ1c3kiLCJMb2FkaW5nIiwibG9nZ2VyIiwibG9nIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWdCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFJQTs7OztBQUVBLFNBQVNBLGdCQUFULENBQTBCQyxPQUExQixFQUFtRTtBQUMvRCxTQUFPQyxPQUFPLENBQ1ZELE9BQU8sQ0FBQ0UsVUFBUixJQUNBRixPQUFPLENBQUNFLFVBQVIsQ0FBbUJDLElBRG5CLElBRUFILE9BQU8sQ0FBQ0UsVUFBUixDQUFtQkUsVUFIVCxDQUFkO0FBS0g7O0lBY29CQyxtQixXQURwQixnREFBcUIscUNBQXJCLEMsZ0JBQUQsTUFDcUJBLG1CQURyQixTQUNpREMsZUFBTUMsU0FEdkQsQ0FDaUY7QUFDN0VDLEVBQUFBLFdBQVcsQ0FBQ0MsS0FBRCxFQUFRO0FBQ2YsVUFBTUEsS0FBTjtBQURlLHlEQWdCSyxNQUFNO0FBQzFCLFlBQU1DLEtBQUssR0FBR0MsMkNBQXFCQyxjQUFyQixFQUFkOztBQUNBLFVBQUlGLEtBQUssQ0FBQ0csS0FBTixLQUFnQkMsNEJBQU1DLFFBQTFCLEVBQW9DO0FBQ2hDLGFBQUtOLEtBQUwsQ0FBV08sVUFBWDtBQUNBO0FBQ0g7O0FBQ0QsV0FBS0MsUUFBTCxDQUFjO0FBQ1ZKLFFBQUFBLEtBQUssRUFBRUgsS0FBSyxDQUFDRyxLQURIO0FBRVZLLFFBQUFBLG1CQUFtQixFQUFFUixLQUFLLENBQUNRLG1CQUZqQjtB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QUZBLEdBR0Esc0JBSkMsQ0FBTCxDQURKLGVBT0ksd0NBQUsseUJBQ0Qsc0VBQ0EsZ0NBRkMsQ0FBTCxDQVBKLGVBWUk7QUFBSyxRQUFBLFNBQVMsRUFBQztBQUFmLHNCQUNJLDZCQUFDLHlCQUFEO0FBQWtCLFFBQUEsSUFBSSxFQUFDLGdCQUF2QjtBQUF3QyxRQUFBLE9BQU8sRUFBRSxLQUFLaEI7QUFBdEQsU0FDTSx5QkFBRyxvQkFBSCxDQUROLENBREosZUFJSSw2QkFBQyx5QkFBRDtBQUFrQixRQUFBLElBQUksRUFBQyxTQUF2QjtBQUFpQyxRQUFBLE9BQU8sRUFBRSxLQUFLaUI7QUFBL0MsU0FDTSx5QkFBRyxTQUFILENBRE4sQ0FKSixDQVpKLENBREo7QUF1QkgsS0F4Qk0sTUF3QkEsSUFBSTVELEtBQUssS0FBS0MsNEJBQU00RCxJQUFoQixJQUF3QjdELEtBQUssS0FBS0MsNEJBQU02RCxPQUE1QyxFQUFxRDtBQUN4RCwwQkFBTyw2QkFBQyxnQkFBRCxPQUFQO0FBQ0gsS0FGTSxNQUVBO0FBQ0hDLHFCQUFPQyxHQUFQLENBQVksc0NBQXFDaEUsS0FBTSxFQUF2RDtBQUNIO0FBQ0o7O0FBM1A0RSxDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDIwLTIwMjEgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgX3QgfSBmcm9tICcuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXInO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSAnLi4vLi4vLi4vTWF0cml4Q2xpZW50UGVnJztcbmltcG9ydCBNb2RhbCBmcm9tICcuLi8uLi8uLi9Nb2RhbCc7XG5pbXBvcnQgVmVyaWZpY2F0aW9uUmVxdWVzdERpYWxvZyBmcm9tICcuLi8uLi92aWV3cy9kaWFsb2dzL1ZlcmlmaWNhdGlvblJlcXVlc3REaWFsb2cnO1xuaW1wb3J0IHsgU2V0dXBFbmNyeXB0aW9uU3RvcmUsIFBoYXNlIH0gZnJvbSAnLi4vLi4vLi4vc3RvcmVzL1NldHVwRW5jcnlwdGlvblN0b3JlJztcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5pbXBvcnQgeyBJU2VjcmV0U3RvcmFnZUtleUluZm8gfSBmcm9tICdtYXRyaXgtanMtc2RrL3NyYy9jcnlwdG8vYXBpJztcbmltcG9ydCBFbmNyeXB0aW9uUGFuZWwgZnJvbSBcIi4uLy4uL3ZpZXdzL3JpZ2h0X3BhbmVsL0VuY3J5cHRpb25QYW5lbFwiO1xuaW1wb3J0IEFjY2Vzc2libGVCdXR0b24gZnJvbSAnLi4vLi4vdmlld3MvZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvbic7XG5pbXBvcnQgU3Bpbm5lciBmcm9tICcuLi8uLi92aWV3cy9lbGVtZW50cy9TcGlubmVyJztcbmltcG9ydCB7IElLZXlCYWNrdXBJbmZvIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2NyeXB0by9rZXliYWNrdXBcIjtcbmltcG9ydCB7IFZlcmlmaWNhdGlvblJlcXVlc3QgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvY3J5cHRvL3ZlcmlmaWNhdGlvbi9yZXF1ZXN0L1ZlcmlmaWNhdGlvblJlcXVlc3RcIjtcblxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2xvZ2dlclwiO1xuXG5mdW5jdGlvbiBrZXlIYXNQYXNzcGhyYXNlKGtleUluZm86IElTZWNyZXRTdG9yYWdlS2V5SW5mbyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBCb29sZWFuKFxuICAgICAgICBrZXlJbmZvLnBhc3NwaHJhc2UgJiZcbiAgICAgICAga2V5SW5mby5wYXNzcGhyYXNlLnNhbHQgJiZcbiAgICAgICAga2V5SW5mby5wYXNzcGhyYXNlLml0ZXJhdGlvbnMsXG4gICAgKTtcbn1cblxuaW50ZXJmYWNlIElQcm9wcyB7XG4gICAgb25GaW5pc2hlZDogKCkgPT4gdm9pZDtcbn1cblxuaW50ZXJmYWNlIElTdGF0ZSB7XG4gICAgcGhhc2U6IFBoYXNlO1xuICAgIHZlcmlmaWNhdGlvblJlcXVlc3Q6IFZlcmlmaWNhdGlvblJlcXVlc3Q7XG4gICAgYmFja3VwSW5mbzogSUtleUJhY2t1cEluZm87XG4gICAgbG9zdEtleXM6IGJvb2xlYW47XG59XG5cbkByZXBsYWNlYWJsZUNvbXBvbmVudChcInN0cnVjdHVyZXMuYXV0aC5TZXR1cEVuY3J5cHRpb25Cb2R5XCIpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTZXR1cEVuY3J5cHRpb25Cb2R5IGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PElQcm9wcywgSVN0YXRlPiB7XG4gICAgY29uc3RydWN0b3IocHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuICAgICAgICBjb25zdCBzdG9yZSA9IFNldHVwRW5jcnlwdGlvblN0b3JlLnNoYXJlZEluc3RhbmNlKCk7XG4gICAgICAgIHN0b3JlLm9uKFwidXBkYXRlXCIsIHRoaXMub25TdG9yZVVwZGF0ZSk7XG4gICAgICAgIHN0b3JlLnN0YXJ0KCk7XG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICBwaGFzZTogc3RvcmUucGhhc2UsXG4gICAgICAgICAgICAvLyB0aGlzIHNlcnZlcyBkdWFsIHB1cnBvc2UgYXMgdGhlIG9iamVjdCBmb3IgdGhlIHJlcXVlc3QgbG9naWMgYW5kXG4gICAgICAgICAgICAvLyB0aGUgcHJlc2VuY2Ugb2YgaXQgaW5kaWNhdGluZyB0aGF0IHdlJ3JlIGluICd2ZXJpZnkgbW9kZScuXG4gICAgICAgICAgICAvLyBCZWNhdXNlIG9mIHRoZSBsYXR0ZXIsIGl0IGxpdmVzIGluIHRoZSBzdGF0ZS5cbiAgICAgICAgICAgIHZlcmlmaWNhdGlvblJlcXVlc3Q6IHN0b3JlLnZlcmlmaWNhdGlvblJlcXVlc3QsXG4gICAgICAgICAgICBiYWNrdXBJbmZvOiBzdG9yZS5iYWNrdXBJbmZvLFxuICAgICAgICAgICAgbG9zdEtleXM6IHN0b3JlLmxvc3RLZXlzKCksXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvblN0b3JlVXBkYXRlID0gKCkgPT4ge1xuICAgICAgICBjb25zdCBzdG9yZSA9IFNldHVwRW5jcnlwdGlvblN0b3JlLnNoYXJlZEluc3RhbmNlKCk7XG4gICAgICAgIGlmIChzdG9yZS5waGFzZSA9PT0gUGhhc2UuRmluaXNoZWQpIHtcbiAgICAgICAgICAgIHRoaXMucHJvcHMub25GaW5pc2hlZCgpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgcGhhc2U6IHN0b3JlLnBoYXNlLFxuICAgICAgICAgICAgdmVyaWZpY2F0aW9uUmVxdWVzdDogc3RvcmUudmVyaWZpY2F0aW9uUmVxdWVzdCxcbiAgICAgICAgICAgIGJhY2t1cEluZm86IHN0b3JlLmJhY2t1cEluZm8sXG4gICAgICAgICAgICBsb3N0S2V5czogc3RvcmUubG9zdEtleXMoKSxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHB1YmxpYyBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICAgICAgY29uc3Qgc3RvcmUgPSBTZXR1cEVuY3J5cHRpb25TdG9yZS5zaGFyZWRJbnN0YW5jZSgpO1xuICAgICAgICBzdG9yZS5vZmYoXCJ1cGRhdGVcIiwgdGhpcy5vblN0b3JlVXBkYXRlKTtcbiAgICAgICAgc3RvcmUuc3RvcCgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25Vc2VQYXNzcGhyYXNlQ2xpY2sgPSBhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHN0b3JlID0gU2V0dXBFbmNyeXB0aW9uU3RvcmUuc2hhcmVkSW5zdGFuY2UoKTtcbiAgICAgICAgc3RvcmUudXNlUGFzc1BocmFzZSgpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uVmVyaWZ5Q2xpY2sgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICAgICAgY29uc3QgdXNlcklkID0gY2xpLmdldFVzZXJJZCgpO1xuICAgICAgICBjb25zdCByZXF1ZXN0UHJvbWlzZSA9IGNsaS5yZXF1ZXN0VmVyaWZpY2F0aW9uKHVzZXJJZCk7XG5cbiAgICAgICAgLy8gV2UgbmVlZCB0byBjYWxsIG9uRmluaXNoZWQgbm93IHRvIGNsb3NlIHRoaXMgZGlhbG9nLCBhbmRcbiAgICAgICAgLy8gYWdhaW4gbGF0ZXIgdG8gc2lnbmFsIHRoYXQgdGhlIHZlcmlmaWNhdGlvbiBpcyBjb21wbGV0ZS5cbiAgICAgICAgdGhpcy5wcm9wcy5vbkZpbmlzaGVkKCk7XG4gICAgICAgIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coJ05ldyBTZXNzaW9uIFZlcmlmaWNhdGlvbicsICdTdGFydGluZyBkaWFsb2cnLCBWZXJpZmljYXRpb25SZXF1ZXN0RGlhbG9nLCB7XG4gICAgICAgICAgICB2ZXJpZmljYXRpb25SZXF1ZXN0UHJvbWlzZTogcmVxdWVzdFByb21pc2UsXG4gICAgICAgICAgICBtZW1iZXI6IGNsaS5nZXRVc2VyKHVzZXJJZCksXG4gICAgICAgICAgICBvbkZpbmlzaGVkOiBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVxdWVzdCA9IGF3YWl0IHJlcXVlc3RQcm9taXNlO1xuICAgICAgICAgICAgICAgIHJlcXVlc3QuY2FuY2VsKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5wcm9wcy5vbkZpbmlzaGVkKCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvblNraXBDb25maXJtQ2xpY2sgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHN0b3JlID0gU2V0dXBFbmNyeXB0aW9uU3RvcmUuc2hhcmVkSW5zdGFuY2UoKTtcbiAgICAgICAgc3RvcmUuc2tpcENvbmZpcm0oKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvblNraXBCYWNrQ2xpY2sgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHN0b3JlID0gU2V0dXBFbmNyeXB0aW9uU3RvcmUuc2hhcmVkSW5zdGFuY2UoKTtcbiAgICAgICAgc3RvcmUucmV0dXJuQWZ0ZXJTa2lwKCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25SZXNldENsaWNrID0gKGV2OiBSZWFjdC5Nb3VzZUV2ZW50PEhUTUxBbmNob3JFbGVtZW50PikgPT4ge1xuICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBjb25zdCBzdG9yZSA9IFNldHVwRW5jcnlwdGlvblN0b3JlLnNoYXJlZEluc3RhbmNlKCk7XG4gICAgICAgIHN0b3JlLnJlc2V0KCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25SZXNldENvbmZpcm1DbGljayA9ICgpID0+IHtcbiAgICAgICAgdGhpcy5wcm9wcy5vbkZpbmlzaGVkKCk7XG4gICAgICAgIGNvbnN0IHN0b3JlID0gU2V0dXBFbmNyeXB0aW9uU3RvcmUuc2hhcmVkSW5zdGFuY2UoKTtcbiAgICAgICAgc3RvcmUucmVzZXRDb25maXJtKCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25SZXNldEJhY2tDbGljayA9ICgpID0+IHtcbiAgICAgICAgY29uc3Qgc3RvcmUgPSBTZXR1cEVuY3J5cHRpb25TdG9yZS5zaGFyZWRJbnN0YW5jZSgpO1xuICAgICAgICBzdG9yZS5yZXR1cm5BZnRlclJlc2V0KCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25Eb25lQ2xpY2sgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHN0b3JlID0gU2V0dXBFbmNyeXB0aW9uU3RvcmUuc2hhcmVkSW5zdGFuY2UoKTtcbiAgICAgICAgc3RvcmUuZG9uZSgpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uRW5jcnlwdGlvblBhbmVsQ2xvc2UgPSAoKSA9PiB7XG4gICAgICAgIHRoaXMucHJvcHMub25GaW5pc2hlZCgpO1xuICAgIH07XG5cbiAgICBwdWJsaWMgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCB7XG4gICAgICAgICAgICBwaGFzZSxcbiAgICAgICAgICAgIGxvc3RLZXlzLFxuICAgICAgICB9ID0gdGhpcy5zdGF0ZTtcblxuICAgICAgICBpZiAodGhpcy5zdGF0ZS52ZXJpZmljYXRpb25SZXF1ZXN0KSB7XG4gICAgICAgICAgICByZXR1cm4gPEVuY3J5cHRpb25QYW5lbFxuICAgICAgICAgICAgICAgIGxheW91dD1cImRpYWxvZ1wiXG4gICAgICAgICAgICAgICAgdmVyaWZpY2F0aW9uUmVxdWVzdD17dGhpcy5zdGF0ZS52ZXJpZmljYXRpb25SZXF1ZXN0fVxuICAgICAgICAgICAgICAgIG9uQ2xvc2U9e3RoaXMub25FbmNyeXB0aW9uUGFuZWxDbG9zZX1cbiAgICAgICAgICAgICAgICBtZW1iZXI9e01hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRVc2VyKHRoaXMuc3RhdGUudmVyaWZpY2F0aW9uUmVxdWVzdC5vdGhlclVzZXJJZCl9XG4gICAgICAgICAgICAgICAgaXNSb29tRW5jcnlwdGVkPXtmYWxzZX1cbiAgICAgICAgICAgIC8+O1xuICAgICAgICB9IGVsc2UgaWYgKHBoYXNlID09PSBQaGFzZS5JbnRybykge1xuICAgICAgICAgICAgaWYgKGxvc3RLZXlzKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxwPnsgX3QoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJJdCBsb29rcyBsaWtlIHlvdSBkb24ndCBoYXZlIGEgU2VjdXJpdHkgS2V5IG9yIGFueSBvdGhlciBkZXZpY2VzIHlvdSBjYW4gXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwidmVyaWZ5IGFnYWluc3QuICBUaGlzIGRldmljZSB3aWxsIG5vdCBiZSBhYmxlIHRvIGFjY2VzcyBvbGQgZW5jcnlwdGVkIG1lc3NhZ2VzLiBcIiArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJJbiBvcmRlciB0byB2ZXJpZnkgeW91ciBpZGVudGl0eSBvbiB0aGlzIGRldmljZSwgeW91J2xsIG5lZWQgdG8gcmVzZXQgXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwieW91ciB2ZXJpZmljYXRpb24ga2V5cy5cIixcbiAgICAgICAgICAgICAgICAgICAgICAgICkgfTwvcD5cblxuICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9Db21wbGV0ZVNlY3VyaXR5X2FjdGlvblJvd1wiPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uIGtpbmQ9XCJwcmltYXJ5XCIgb25DbGljaz17dGhpcy5vblJlc2V0Q29uZmlybUNsaWNrfT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIlByb2NlZWQgd2l0aCByZXNldFwiKSB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IHN0b3JlID0gU2V0dXBFbmNyeXB0aW9uU3RvcmUuc2hhcmVkSW5zdGFuY2UoKTtcbiAgICAgICAgICAgICAgICBsZXQgcmVjb3ZlcnlLZXlQcm9tcHQ7XG4gICAgICAgICAgICAgICAgaWYgKHN0b3JlLmtleUluZm8gJiYga2V5SGFzUGFzc3BocmFzZShzdG9yZS5rZXlJbmZvKSkge1xuICAgICAgICAgICAgICAgICAgICByZWNvdmVyeUtleVByb21wdCA9IF90KFwiVmVyaWZ5IHdpdGggU2VjdXJpdHkgS2V5IG9yIFBocmFzZVwiKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0b3JlLmtleUluZm8pIHtcbiAgICAgICAgICAgICAgICAgICAgcmVjb3ZlcnlLZXlQcm9tcHQgPSBfdChcIlZlcmlmeSB3aXRoIFNlY3VyaXR5IEtleVwiKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBsZXQgdXNlUmVjb3ZlcnlLZXlCdXR0b247XG4gICAgICAgICAgICAgICAgaWYgKHJlY292ZXJ5S2V5UHJvbXB0KSB7XG4gICAgICAgICAgICAgICAgICAgIHVzZVJlY292ZXJ5S2V5QnV0dG9uID0gPEFjY2Vzc2libGVCdXR0b24ga2luZD1cInByaW1hcnlcIiBvbkNsaWNrPXt0aGlzLm9uVXNlUGFzc3BocmFzZUNsaWNrfT5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgcmVjb3ZlcnlLZXlQcm9tcHQgfVxuICAgICAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+O1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGxldCB2ZXJpZnlCdXR0b247XG4gICAgICAgICAgICAgICAgaWYgKHN0b3JlLmhhc0RldmljZXNUb1ZlcmlmeUFnYWluc3QpIHtcbiAgICAgICAgICAgICAgICAgICAgdmVyaWZ5QnV0dG9uID0gPEFjY2Vzc2libGVCdXR0b24ga2luZD1cInByaW1hcnlcIiBvbkNsaWNrPXt0aGlzLm9uVmVyaWZ5Q2xpY2t9PlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIlZlcmlmeSB3aXRoIGFub3RoZXIgbG9naW5cIikgfVxuICAgICAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+O1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgICAgIDxkaXY+XG4gICAgICAgICAgICAgICAgICAgICAgICA8cD57IF90KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiVmVyaWZ5IHlvdXIgaWRlbnRpdHkgdG8gYWNjZXNzIGVuY3J5cHRlZCBtZXNzYWdlcyBhbmQgcHJvdmUgeW91ciBpZGVudGl0eSB0byBvdGhlcnMuXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICApIH08L3A+XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfQ29tcGxldGVTZWN1cml0eV9hY3Rpb25Sb3dcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IHZlcmlmeUJ1dHRvbiB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeyB1c2VSZWNvdmVyeUtleUJ1dHRvbiB9XG4gICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfU2V0dXBFbmNyeXB0aW9uQm9keV9yZXNldFwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCJGb3Jnb3R0ZW4gb3IgbG9zdCBhbGwgcmVjb3ZlcnkgbWV0aG9kcz8gPGE+UmVzZXQgYWxsPC9hPlwiLCBudWxsLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGE6IChzdWIpID0+IDxhXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBocmVmPVwiXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s9e3RoaXMub25SZXNldENsaWNrfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfU2V0dXBFbmNyeXB0aW9uQm9keV9yZXNldF9saW5rXCI+eyBzdWIgfTwvYT4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkgfVxuICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAocGhhc2UgPT09IFBoYXNlLkRvbmUpIHtcbiAgICAgICAgICAgIGxldCBtZXNzYWdlO1xuICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUuYmFja3VwSW5mbykge1xuICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSA8cD57IF90KFxuICAgICAgICAgICAgICAgICAgICBcIllvdXIgbmV3IHNlc3Npb24gaXMgbm93IHZlcmlmaWVkLiBJdCBoYXMgYWNjZXNzIHRvIHlvdXIgXCIgK1xuICAgICAgICAgICAgICAgICAgICBcImVuY3J5cHRlZCBtZXNzYWdlcywgYW5kIG90aGVyIHVzZXJzIHdpbGwgc2VlIGl0IGFzIHRydXN0ZWQuXCIsXG4gICAgICAgICAgICAgICAgKSB9PC9wPjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZSA9IDxwPnsgX3QoXG4gICAgICAgICAgICAgICAgICAgIFwiWW91ciBuZXcgc2Vzc2lvbiBpcyBub3cgdmVyaWZpZWQuIE90aGVyIHVzZXJzIHdpbGwgc2VlIGl0IGFzIHRydXN0ZWQuXCIsXG4gICAgICAgICAgICAgICAgKSB9PC9wPjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9Db21wbGV0ZVNlY3VyaXR5X2hlcm9JY29uIG14X0UyRUljb25fdmVyaWZpZWRcIiAvPlxuICAgICAgICAgICAgICAgICAgICB7IG1lc3NhZ2UgfVxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0NvbXBsZXRlU2VjdXJpdHlfYWN0aW9uUm93XCI+XG4gICAgICAgICAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtpbmQ9XCJwcmltYXJ5XCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLm9uRG9uZUNsaWNrfVxuICAgICAgICAgICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCJEb25lXCIpIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj5cbiAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2UgaWYgKHBoYXNlID09PSBQaGFzZS5Db25maXJtU2tpcCkge1xuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICA8ZGl2PlxuICAgICAgICAgICAgICAgICAgICA8cD57IF90KFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJXaXRob3V0IHZlcmlmeWluZywgeW91IHdvbid0IGhhdmUgYWNjZXNzIHRvIGFsbCB5b3VyIG1lc3NhZ2VzIFwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiYW5kIG1heSBhcHBlYXIgYXMgdW50cnVzdGVkIHRvIG90aGVycy5cIixcbiAgICAgICAgICAgICAgICAgICAgKSB9PC9wPlxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0NvbXBsZXRlU2VjdXJpdHlfYWN0aW9uUm93XCI+XG4gICAgICAgICAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtpbmQ9XCJkYW5nZXJfb3V0bGluZVwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5vblNraXBDb25maXJtQ2xpY2t9XG4gICAgICAgICAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIkknbGwgdmVyaWZ5IGxhdGVyXCIpIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAga2luZD1cInByaW1hcnlcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s9e3RoaXMub25Ta2lwQmFja0NsaWNrfVxuICAgICAgICAgICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCJHbyBCYWNrXCIpIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj5cbiAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2UgaWYgKHBoYXNlID09PSBQaGFzZS5Db25maXJtUmVzZXQpIHtcbiAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgICAgICAgICAgPHA+eyBfdChcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiUmVzZXR0aW5nIHlvdXIgdmVyaWZpY2F0aW9uIGtleXMgY2Fubm90IGJlIHVuZG9uZS4gQWZ0ZXIgcmVzZXR0aW5nLCBcIiArXG4gICAgICAgICAgICAgICAgICAgICAgICBcInlvdSB3b24ndCBoYXZlIGFjY2VzcyB0byBvbGQgZW5jcnlwdGVkIG1lc3NhZ2VzLCBhbmQgYW55IGZyaWVuZHMgd2hvIFwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiaGF2ZSBwcmV2aW91c2x5IHZlcmlmaWVkIHlvdSB3aWxsIHNlZSBzZWN1cml0eSB3YXJuaW5ncyB1bnRpbCB5b3UgXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJyZS12ZXJpZnkgd2l0aCB0aGVtLlwiLFxuICAgICAgICAgICAgICAgICAgICApIH08L3A+XG4gICAgICAgICAgICAgICAgICAgIDxwPnsgX3QoXG4gICAgICAgICAgICAgICAgICAgICAgICBcIlBsZWFzZSBvbmx5IHByb2NlZWQgaWYgeW91J3JlIHN1cmUgeW91J3ZlIGxvc3QgYWxsIG9mIHlvdXIgb3RoZXIgXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJkZXZpY2VzIGFuZCB5b3VyIHNlY3VyaXR5IGtleS5cIixcbiAgICAgICAgICAgICAgICAgICAgKSB9PC9wPlxuXG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfQ29tcGxldGVTZWN1cml0eV9hY3Rpb25Sb3dcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uIGtpbmQ9XCJkYW5nZXJfb3V0bGluZVwiIG9uQ2xpY2s9e3RoaXMub25SZXNldENvbmZpcm1DbGlja30+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIlByb2NlZWQgd2l0aCByZXNldFwiKSB9XG4gICAgICAgICAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvbiBraW5kPVwicHJpbWFyeVwiIG9uQ2xpY2s9e3RoaXMub25SZXNldEJhY2tDbGlja30+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIkdvIEJhY2tcIikgfVxuICAgICAgICAgICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSBpZiAocGhhc2UgPT09IFBoYXNlLkJ1c3kgfHwgcGhhc2UgPT09IFBoYXNlLkxvYWRpbmcpIHtcbiAgICAgICAgICAgIHJldHVybiA8U3Bpbm5lciAvPjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxvZ2dlci5sb2coYFNldHVwRW5jcnlwdGlvbkJvZHk6IFVua25vd24gcGhhc2UgJHtwaGFzZX1gKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==