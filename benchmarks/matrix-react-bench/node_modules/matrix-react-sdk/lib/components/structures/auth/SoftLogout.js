"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _languageHandler = require("../../../languageHandler");

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var Lifecycle = _interopRequireWildcard(require("../../../Lifecycle"));

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _Login = require("../../../Login");

var _AuthPage = _interopRequireDefault(require("../../views/auth/AuthPage"));

var _BasePlatform = require("../../../BasePlatform");

var _SSOButtons = _interopRequireDefault(require("../../views/elements/SSOButtons"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _ConfirmWipeDeviceDialog = _interopRequireDefault(require("../../views/dialogs/ConfirmWipeDeviceDialog"));

var _Field = _interopRequireDefault(require("../../views/elements/Field"));

var _AccessibleButton = _interopRequireDefault(require("../../views/elements/AccessibleButton"));

var _Spinner = _interopRequireDefault(require("../../views/elements/Spinner"));

var _AuthHeader = _interopRequireDefault(require("../../views/auth/AuthHeader"));

var _AuthBody = _interopRequireDefault(require("../../views/auth/AuthBody"));

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

const LOGIN_VIEW = {
  LOADING: 1,
  PASSWORD: 2,
  CAS: 3,
  // SSO, but old
  SSO: 4,
  UNSUPPORTED: 5
};
const FLOWS_TO_VIEWS = {
  "m.login.password": LOGIN_VIEW.PASSWORD,
  "m.login.cas": LOGIN_VIEW.CAS,
  "m.login.sso": LOGIN_VIEW.SSO
};
let SoftLogout = (_dec = (0, _replaceableComponent.replaceableComponent)("structures.auth.SoftLogout"), _dec(_class = class SoftLogout extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onClearAll", () => {
      _Modal.default.createTrackedDialog('Clear Data', 'Soft Logout', _ConfirmWipeDeviceDialog.default, {
        onFinished: wipeData => {
          if (!wipeData) return;

          _logger.logger.log("Clearing data from soft-logged-out session");

          Lifecycle.logout();
        }
      });
    });
    (0, _defineProperty2.default)(this, "onPasswordChange", ev => {
      this.setState({
        password: ev.target.value
      });
    });
    (0, _defineProperty2.default)(this, "onForgotPassword", () => {
      _dispatcher.default.dispatch({
        action: 'start_password_recovery'
      });
    });
    (0, _defineProperty2.default)(this, "onPasswordLogin", async ev => {
      ev.preventDefault();
      ev.stopPropagation();
      this.setState({
        busy: true
      });

      const hsUrl = _MatrixClientPeg.MatrixClientPeg.get().getHomeserverUrl();

      const isUrl = _MatrixClientPeg.MatrixClientPeg.get().getIdentityServerUrl();

      const loginType = "m.login.password";
      const loginParams = {
        identifier: {
          type: "m.id.user",
          user: _MatrixClientPeg.MatrixClientPeg.get().getUserId()
        },
        password: this.state.password,
        device_id: _MatrixClientPeg.MatrixClientPeg.get().getDeviceId()
      };
      let credentials = null;

      try {
        credentials = await (0, _Login.sendLoginRequest)(hsUrl, isUrl, loginType, loginParams);
      } catch (e) {
        let errorText = (0, _languageHandler._t)("Failed to re-authenticate due to a homeserver problem");

        if (e.errcode === "M_FORBIDDEN" && (e.httpStatus === 401 || e.httpStatus === 403)) {
          errorText = (0, _languageHandler._t)("Incorrect password");
        }

        this.setState({
          busy: false,
          errorText: errorText
        });
        return;
      }

      Lifecycle.hydrateSession(credentials).catch(e => {
        _logger.logger.error(e);

        this.setState({
          busy: false,
          errorText: (0, _languageHandler._t)("Failed to re-authenticate")
        });
      });
    });
    this.state = {
      loginView: LOGIN_VIEW.LOADING,
      keyBackupNeeded: true,
      // assume we do while we figure it out (see componentDidMount)
      busy: false,
      password: "",
      errorText: "",
      flows: []
    };
  }

  componentDidMount() {
    // We've ended up here when we don't need to - navigate to login
    if (!Lifecycle.isSoftLogout()) {
      _dispatcher.default.dispatch({
        action: "start_login"
      });

      return;
    }

    this.initLogin();

    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    if (cli.isCryptoEnabled()) {
      cli.countSessionsNeedingBackup().then(remaining => {
        this.setState({
          keyBackupNeeded: remaining > 0
        });
      });
    }
  }

  async initLogin() {
    const queryParams = this.props.realQueryParams;
    const hasAllParams = queryParams && queryParams['loginToken'];

    if (hasAllParams) {
      this.setState({
        loginView: LOGIN_VIEW.LOADING
      });
      this.trySsoLogin();
      return;
    } // Note: we don't use the existing Login class because it is heavily flow-based. We don't
    // care about login flows here, unless it is the single flow we support.


    const client = _MatrixClientPeg.MatrixClientPeg.get();

    const flows = (await client.loginFlows()).flows;
    const loginViews = flows.map(f => FLOWS_TO_VIEWS[f.type]);
    const chosenView = loginViews.filter(f => !!f)[0] || LOGIN_VIEW.UNSUPPORTED;
    this.setState({
      flows,
      loginView: chosenView
    });
  }

  async trySsoLogin() {
    this.setState({
      busy: true
    });
    const hsUrl = localStorage.getItem(_BasePlatform.SSO_HOMESERVER_URL_KEY);

    const isUrl = localStorage.getItem(_BasePlatform.SSO_ID_SERVER_URL_KEY) || _MatrixClientPeg.MatrixClientPeg.get().getIdentityServerUrl();

    const loginType = "m.login.token";
    const loginParams = {
      token: this.props.realQueryParams['loginToken'],
      device_id: _MatrixClientPeg.MatrixClientPeg.get().getDeviceId()
    };
    let credentials = null;

    try {
      credentials = await (0, _Login.sendLoginRequest)(hsUrl, isUrl, loginType, loginParams);
    } catch (e) {
      _logger.logger.error(e);

      this.setState({
        busy: false,
        loginView: LOGIN_VIEW.UNSUPPORTED
      });
      return;
    }

    Lifecycle.hydrateSession(credentials).then(() => {
      if (this.props.onTokenLoginCompleted) this.props.onTokenLoginCompleted();
    }).catch(e => {
      _logger.logger.error(e);

      this.setState({
        busy: false,
        loginView: LOGIN_VIEW.UNSUPPORTED
      });
    });
  }

  renderSignInSection() {
    if (this.state.loginView === LOGIN_VIEW.LOADING) {
      return /*#__PURE__*/_react.default.createElement(_Spinner.default, null);
    }

    let introText = null; // null is translated to something area specific in this function

    if (this.state.keyBackupNeeded) {
      introText = (0, _languageHandler._t)("Regain access to your account and recover encryption keys stored in this session. " + "Without them, you won't be able to read all of your secure messages in any session.");
    }

    if (this.state.loginView === LOGIN_VIEW.PASSWORD) {
      let error = null;

      if (this.state.errorText) {
        error = /*#__PURE__*/_react.default.createElement("span", {
          className: "mx_Login_error"
        }, this.state.errorText);
      }

      if (!introText) {
        introText = (0, _languageHandler._t)("Enter your password to sign in and regain access to your account.");
      } // else we already have a message and should use it (key backup warning)


      return /*#__PURE__*/_react.default.createElement("form", {
        onSubmit: this.onPasswordLogin
      }, /*#__PURE__*/_react.default.createElement("p", null, introText), error, /*#__PURE__*/_react.default.createElement(_Field.default, {
        type: "password",
        label: (0, _languageHandler._t)("Password"),
        onChange: this.onPasswordChange,
        value: this.state.password,
        disabled: this.state.busy
      }), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        onClick: this.onPasswordLogin,
        kind: "primary",
        type: "submit",
        disabled: this.state.busy
      }, (0, _languageHandler._t)("Sign In")), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        onClick: this.onForgotPassword,
        kind: "link"
      }, (0, _languageHandler._t)("Forgotten your password?")));
    }

    if (this.state.loginView === LOGIN_VIEW.SSO || this.state.loginView === LOGIN_VIEW.CAS) {
      if (!introText) {
        introText = (0, _languageHandler._t)("Sign in and regain access to your account.");
      } // else we already have a message and should use it (key backup warning)


      const loginType = this.state.loginView === LOGIN_VIEW.CAS ? "cas" : "sso";
      const flow = this.state.flows.find(flow => flow.type === "m.login." + loginType);
      return /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("p", null, introText), /*#__PURE__*/_react.default.createElement(_SSOButtons.default, {
        matrixClient: _MatrixClientPeg.MatrixClientPeg.get(),
        flow: flow,
        loginType: loginType,
        fragmentAfterLogin: this.props.fragmentAfterLogin,
        primary: !this.state.flows.find(flow => flow.type === "m.login.password")
      }));
    } // Default: assume unsupported/error


    return /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("You cannot sign in to your account. Please contact your " + "homeserver admin for more information."));
  }

  render() {
    return /*#__PURE__*/_react.default.createElement(_AuthPage.default, null, /*#__PURE__*/_react.default.createElement(_AuthHeader.default, null), /*#__PURE__*/_react.default.createElement(_AuthBody.default, null, /*#__PURE__*/_react.default.createElement("h2", null, (0, _languageHandler._t)("You're signed out")), /*#__PURE__*/_react.default.createElement("h3", null, (0, _languageHandler._t)("Sign in")), /*#__PURE__*/_react.default.createElement("div", null, this.renderSignInSection()), /*#__PURE__*/_react.default.createElement("h3", null, (0, _languageHandler._t)("Clear personal data")), /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Warning: Your personal data (including encryption keys) is still stored " + "in this session. Clear it if you're finished using this session, or want to sign " + "in to another account.")), /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      onClick: this.onClearAll,
      kind: "danger"
    }, (0, _languageHandler._t)("Clear all data")))));
  }

}) || _class);
exports.default = SoftLogout;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3N0cnVjdHVyZXMvYXV0aC9Tb2Z0TG9nb3V0LnRzeCJdLCJuYW1lcyI6WyJMT0dJTl9WSUVXIiwiTE9BRElORyIsIlBBU1NXT1JEIiwiQ0FTIiwiU1NPIiwiVU5TVVBQT1JURUQiLCJGTE9XU19UT19WSUVXUyIsIlNvZnRMb2dvdXQiLCJSZWFjdCIsIkNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJNb2RhbCIsImNyZWF0ZVRyYWNrZWREaWFsb2ciLCJDb25maXJtV2lwZURldmljZURpYWxvZyIsIm9uRmluaXNoZWQiLCJ3aXBlRGF0YSIsImxvZ2dlciIsImxvZyIsIkxpZmVjeWNsZSIsImxvZ291dCIsImV2Iiwic2V0U3RhdGUiLCJwYXNzd29yZCIsInRhcmdldCIsInZhbHVlIiwiZGlzIiwiZGlzcGF0Y2giLCJhY3Rpb24iLCJwcmV2ZW50RGVmYXVsdCIsInN0b3BQcm9wYWdhdGlvbiIsImJ1c3kiLCJoc1VybCIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsImdldEhvbWVzZXJ2ZXJVcmwiLCJpc1VybCIsImdldElkZW50aXR5U2VydmVyVXJsIiwibG9naW5UeXBlIiwibG9naW5QYXJhbXMiLCJpZGVudGlmaWVyIiwidHlwZSIsInVzZXIiLCJnZXRVc2VySWQiLCJzdGF0ZSIsImRldmljZV9pZCIsImdldERldmljZUlkIiwiY3JlZGVudGlhbHMiLCJlIiwiZXJyb3JUZXh0IiwiZXJyY29kZSIsImh0dHBTdGF0dXMiLCJoeWRyYXRlU2Vzc2lvbiIsImNhdGNoIiwiZXJyb3IiLCJsb2dpblZpZXciLCJrZXlCYWNrdXBOZWVkZWQiLCJmbG93cyIsImNvbXBvbmVudERpZE1vdW50IiwiaXNTb2Z0TG9nb3V0IiwiaW5pdExvZ2luIiwiY2xpIiwiaXNDcnlwdG9FbmFibGVkIiwiY291bnRTZXNzaW9uc05lZWRpbmdCYWNrdXAiLCJ0aGVuIiwicmVtYWluaW5nIiwicXVlcnlQYXJhbXMiLCJyZWFsUXVlcnlQYXJhbXMiLCJoYXNBbGxQYXJhbXMiLCJ0cnlTc29Mb2dpbiIsImNsaWVudCIsImxvZ2luRmxvd3MiLCJsb2dpblZpZXdzIiwibWFwIiwiZiIsImNob3NlblZpZXciLCJmaWx0ZXIiLCJsb2NhbFN0b3JhZ2UiLCJnZXRJdGVtIiwiU1NPX0hPTUVTRVJWRVJfVVJMX0tFWSIsIlNTT19JRF9TRVJWRVJfVVJMX0tFWSIsInRva2VuIiwib25Ub2tlbkxvZ2luQ29tcGxldGVkIiwicmVuZGVyU2lnbkluU2VjdGlvbiIsImludHJvVGV4dCIsIm9uUGFzc3dvcmRMb2dpbiIsIm9uUGFzc3dvcmRDaGFuZ2UiLCJvbkZvcmdvdFBhc3N3b3JkIiwiZmxvdyIsImZpbmQiLCJmcmFnbWVudEFmdGVyTG9naW4iLCJyZW5kZXIiLCJvbkNsZWFyQWxsIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWdCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7Ozs7Ozs7QUFFQSxNQUFNQSxVQUFVLEdBQUc7QUFDZkMsRUFBQUEsT0FBTyxFQUFFLENBRE07QUFFZkMsRUFBQUEsUUFBUSxFQUFFLENBRks7QUFHZkMsRUFBQUEsR0FBRyxFQUFFLENBSFU7QUFHUDtBQUNSQyxFQUFBQSxHQUFHLEVBQUUsQ0FKVTtBQUtmQyxFQUFBQSxXQUFXLEVBQUU7QUFMRSxDQUFuQjtBQVFBLE1BQU1DLGNBQWMsR0FBRztBQUNuQixzQkFBb0JOLFVBQVUsQ0FBQ0UsUUFEWjtBQUVuQixpQkFBZUYsVUFBVSxDQUFDRyxHQUZQO0FBR25CLGlCQUFlSCxVQUFVLENBQUNJO0FBSFAsQ0FBdkI7SUEyQnFCRyxVLFdBRHBCLGdEQUFxQiw0QkFBckIsQyxnQkFBRCxNQUNxQkEsVUFEckIsU0FDd0NDLGVBQU1DLFNBRDlDLENBQ3dFO0FBQ3BFQyxFQUFBQSxXQUFXLENBQUNDLEtBQUQsRUFBUTtBQUNmLFVBQU1B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b3B5cmlnaHQgMjAxOS0yMDIxIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IF90IH0gZnJvbSAnLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyJztcbmltcG9ydCBkaXMgZnJvbSAnLi4vLi4vLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyJztcbmltcG9ydCAqIGFzIExpZmVjeWNsZSBmcm9tICcuLi8uLi8uLi9MaWZlY3ljbGUnO1xuaW1wb3J0IE1vZGFsIGZyb20gJy4uLy4uLy4uL01vZGFsJztcbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gXCIuLi8uLi8uLi9NYXRyaXhDbGllbnRQZWdcIjtcbmltcG9ydCB7IElTU09GbG93LCBMb2dpbkZsb3csIHNlbmRMb2dpblJlcXVlc3QgfSBmcm9tIFwiLi4vLi4vLi4vTG9naW5cIjtcbmltcG9ydCBBdXRoUGFnZSBmcm9tIFwiLi4vLi4vdmlld3MvYXV0aC9BdXRoUGFnZVwiO1xuaW1wb3J0IHsgU1NPX0hPTUVTRVJWRVJfVVJMX0tFWSwgU1NPX0lEX1NFUlZFUl9VUkxfS0VZIH0gZnJvbSBcIi4uLy4uLy4uL0Jhc2VQbGF0Zm9ybVwiO1xuaW1wb3J0IFNTT0J1dHRvbnMgZnJvbSBcIi4uLy4uL3ZpZXdzL2VsZW1lbnRzL1NTT0J1dHRvbnNcIjtcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5pbXBvcnQgQ29uZmlybVdpcGVEZXZpY2VEaWFsb2cgZnJvbSAnLi4vLi4vdmlld3MvZGlhbG9ncy9Db25maXJtV2lwZURldmljZURpYWxvZyc7XG5pbXBvcnQgRmllbGQgZnJvbSAnLi4vLi4vdmlld3MvZWxlbWVudHMvRmllbGQnO1xuaW1wb3J0IEFjY2Vzc2libGVCdXR0b24gZnJvbSAnLi4vLi4vdmlld3MvZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvbic7XG5pbXBvcnQgU3Bpbm5lciBmcm9tIFwiLi4vLi4vdmlld3MvZWxlbWVudHMvU3Bpbm5lclwiO1xuaW1wb3J0IEF1dGhIZWFkZXIgZnJvbSBcIi4uLy4uL3ZpZXdzL2F1dGgvQXV0aEhlYWRlclwiO1xuaW1wb3J0IEF1dGhCb2R5IGZyb20gXCIuLi8uLi92aWV3cy9hdXRoL0F1dGhCb2R5XCI7XG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcblxuY29uc3QgTE9HSU5fVklFVyA9IHtcbiAgICBMT0FESU5HOiAxLFxuICAgIFBBU1NXT1JEOiAyLFxuICAgIENBUzogMywgLy8gU1NPLCBidXQgb2xkXG4gICAgU1NPOiA0LFxuICAgIFVOU1VQUE9SVEVEOiA1LFxufTtcblxuY29uc3QgRkxPV1NfVE9fVklFV1MgPSB7XG4gICAgXCJtLmxvZ2luLnBhc3N3b3JkXCI6IExPR0lOX1ZJRVcuUEFTU1dPUkQsXG4gICAgXCJtLmxvZ2luLmNhc1wiOiBMT0dJTl9WSUVXLkNBUyxcbiAgICBcIm0ubG9naW4uc3NvXCI6IExPR0lOX1ZJRVcuU1NPLFxufTtcblxuaW50ZXJmYWNlIElQcm9wcyB7XG4gICAgLy8gUXVlcnkgcGFyYW1ldGVycyBmcm9tIE1hdHJpeENoYXRcbiAgICByZWFsUXVlcnlQYXJhbXM6IHtcbiAgICAgICAgbG9naW5Ub2tlbj86IHN0cmluZztcbiAgICB9O1xuICAgIGZyYWdtZW50QWZ0ZXJMb2dpbj86IHN0cmluZztcblxuICAgIC8vIENhbGxlZCB3aGVuIHRoZSBTU08gbG9naW4gY29tcGxldGVzXG4gICAgb25Ub2tlbkxvZ2luQ29tcGxldGVkOiAoKSA9PiB2b2lkO1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBsb2dpblZpZXc6IG51bWJlcjtcbiAgICBrZXlCYWNrdXBOZWVkZWQ6IGJvb2xlYW47XG4gICAgYnVzeTogYm9vbGVhbjtcbiAgICBwYXNzd29yZDogc3RyaW5nO1xuICAgIGVycm9yVGV4dDogc3RyaW5nO1xuICAgIGZsb3dzOiBMb2dpbkZsb3dbXTtcbn1cblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwic3RydWN0dXJlcy5hdXRoLlNvZnRMb2dvdXRcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFNvZnRMb2dvdXQgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8SVByb3BzLCBJU3RhdGU+IHtcbiAgICBjb25zdHJ1Y3Rvcihwcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG5cbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIGxvZ2luVmlldzogTE9HSU5fVklFVy5MT0FESU5HLFxuICAgICAgICAgICAga2V5QmFja3VwTmVlZGVkOiB0cnVlLCAvLyBhc3N1bWUgd2UgZG8gd2hpbGUgd2UgZmlndXJlIGl0IG91dCAoc2VlIGNvbXBvbmVudERpZE1vdW50KVxuICAgICAgICAgICAgYnVzeTogZmFsc2UsXG4gICAgICAgICAgICBwYXNzd29yZDogXCJcIixcbiAgICAgICAgICAgIGVycm9yVGV4dDogXCJcIixcbiAgICAgICAgICAgIGZsb3dzOiBbXSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBjb21wb25lbnREaWRNb3VudCgpOiB2b2lkIHtcbiAgICAgICAgLy8gV2UndmUgZW5kZWQgdXAgaGVyZSB3aGVuIHdlIGRvbid0IG5lZWQgdG8gLSBuYXZpZ2F0ZSB0byBsb2dpblxuICAgICAgICBpZiAoIUxpZmVjeWNsZS5pc1NvZnRMb2dvdXQoKSkge1xuICAgICAgICAgICAgZGlzLmRpc3BhdGNoKHsgYWN0aW9uOiBcInN0YXJ0X2xvZ2luXCIgfSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmluaXRMb2dpbigpO1xuXG4gICAgICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICAgICAgaWYgKGNsaS5pc0NyeXB0b0VuYWJsZWQoKSkge1xuICAgICAgICAgICAgY2xpLmNvdW50U2Vzc2lvbnNOZWVkaW5nQmFja3VwKCkudGhlbihyZW1haW5pbmcgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBrZXlCYWNrdXBOZWVkZWQ6IHJlbWFpbmluZyA+IDAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG9uQ2xlYXJBbGwgPSAoKSA9PiB7XG4gICAgICAgIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coJ0NsZWFyIERhdGEnLCAnU29mdCBMb2dvdXQnLCBDb25maXJtV2lwZURldmljZURpYWxvZywge1xuICAgICAgICAgICAgb25GaW5pc2hlZDogKHdpcGVEYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCF3aXBlRGF0YSkgcmV0dXJuO1xuXG4gICAgICAgICAgICAgICAgbG9nZ2VyLmxvZyhcIkNsZWFyaW5nIGRhdGEgZnJvbSBzb2Z0LWxvZ2dlZC1vdXQgc2Vzc2lvblwiKTtcbiAgICAgICAgICAgICAgICBMaWZlY3ljbGUubG9nb3V0KCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBhc3luYyBpbml0TG9naW4oKSB7XG4gICAgICAgIGNvbnN0IHF1ZXJ5UGFyYW1zID0gdGhpcy5wcm9wcy5yZWFsUXVlcnlQYXJhbXM7XG4gICAgICAgIGNvbnN0IGhhc0FsbFBhcmFtcyA9IHF1ZXJ5UGFyYW1zICYmIHF1ZXJ5UGFyYW1zWydsb2dpblRva2VuJ107XG4gICAgICAgIGlmIChoYXNBbGxQYXJhbXMpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBsb2dpblZpZXc6IExPR0lOX1ZJRVcuTE9BRElORyB9KTtcbiAgICAgICAgICAgIHRoaXMudHJ5U3NvTG9naW4oKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIE5vdGU6IHdlIGRvbid0IHVzZSB0aGUgZXhpc3RpbmcgTG9naW4gY2xhc3MgYmVjYXVzZSBpdCBpcyBoZWF2aWx5IGZsb3ctYmFzZWQuIFdlIGRvbid0XG4gICAgICAgIC8vIGNhcmUgYWJvdXQgbG9naW4gZmxvd3MgaGVyZSwgdW5sZXNzIGl0IGlzIHRoZSBzaW5nbGUgZmxvdyB3ZSBzdXBwb3J0LlxuICAgICAgICBjb25zdCBjbGllbnQgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIGNvbnN0IGZsb3dzID0gKGF3YWl0IGNsaWVudC5sb2dpbkZsb3dzKCkpLmZsb3dzO1xuICAgICAgICBjb25zdCBsb2dpblZpZXdzID0gZmxvd3MubWFwKGYgPT4gRkxPV1NfVE9fVklFV1NbZi50eXBlXSk7XG5cbiAgICAgICAgY29uc3QgY2hvc2VuVmlldyA9IGxvZ2luVmlld3MuZmlsdGVyKGYgPT4gISFmKVswXSB8fCBMT0dJTl9WSUVXLlVOU1VQUE9SVEVEO1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgZmxvd3MsIGxvZ2luVmlldzogY2hvc2VuVmlldyB9KTtcbiAgICB9XG5cbiAgICBvblBhc3N3b3JkQ2hhbmdlID0gKGV2KSA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBwYXNzd29yZDogZXYudGFyZ2V0LnZhbHVlIH0pO1xuICAgIH07XG5cbiAgICBvbkZvcmdvdFBhc3N3b3JkID0gKCkgPT4ge1xuICAgICAgICBkaXMuZGlzcGF0Y2goeyBhY3Rpb246ICdzdGFydF9wYXNzd29yZF9yZWNvdmVyeScgfSk7XG4gICAgfTtcblxuICAgIG9uUGFzc3dvcmRMb2dpbiA9IGFzeW5jIChldikgPT4ge1xuICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBldi5zdG9wUHJvcGFnYXRpb24oKTtcblxuICAgICAgICB0aGlzLnNldFN0YXRlKHsgYnVzeTogdHJ1ZSB9KTtcblxuICAgICAgICBjb25zdCBoc1VybCA9IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRIb21lc2VydmVyVXJsKCk7XG4gICAgICAgIGNvbnN0IGlzVXJsID0gTWF0cml4Q2xpZW50UGVnLmdldCgpLmdldElkZW50aXR5U2VydmVyVXJsKCk7XG4gICAgICAgIGNvbnN0IGxvZ2luVHlwZSA9IFwibS5sb2dpbi5wYXNzd29yZFwiO1xuICAgICAgICBjb25zdCBsb2dpblBhcmFtcyA9IHtcbiAgICAgICAgICAgIGlkZW50aWZpZXI6IHtcbiAgICAgICAgICAgICAgICB0eXBlOiBcIm0uaWQudXNlclwiLFxuICAgICAgICAgICAgICAgIHVzZXI6IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRVc2VySWQoKSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBwYXNzd29yZDogdGhpcy5zdGF0ZS5wYXNzd29yZCxcbiAgICAgICAgICAgIGRldmljZV9pZDogTWF0cml4Q2xpZW50UGVnLmdldCgpLmdldERldmljZUlkKCksXG4gICAgICAgIH07XG5cbiAgICAgICAgbGV0IGNyZWRlbnRpYWxzID0gbnVsbDtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNyZWRlbnRpYWxzID0gYXdhaXQgc2VuZExvZ2luUmVxdWVzdChoc1VybCwgaXNVcmwsIGxvZ2luVHlwZSwgbG9naW5QYXJhbXMpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBsZXQgZXJyb3JUZXh0ID0gX3QoXCJGYWlsZWQgdG8gcmUtYXV0aGVudGljYXRlIGR1ZSB0byBhIGhvbWVzZXJ2ZXIgcHJvYmxlbVwiKTtcbiAgICAgICAgICAgIGlmIChlLmVycmNvZGUgPT09IFwiTV9GT1JCSURERU5cIiAmJiAoZS5odHRwU3RhdHVzID09PSA0MDEgfHwgZS5odHRwU3RhdHVzID09PSA0MDMpKSB7XG4gICAgICAgICAgICAgICAgZXJyb3JUZXh0ID0gX3QoXCJJbmNvcnJlY3QgcGFzc3dvcmRcIik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgIGJ1c3k6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGVycm9yVGV4dDogZXJyb3JUZXh0LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBMaWZlY3ljbGUuaHlkcmF0ZVNlc3Npb24oY3JlZGVudGlhbHMpLmNhdGNoKChlKSA9PiB7XG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoZSk7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgYnVzeTogZmFsc2UsIGVycm9yVGV4dDogX3QoXCJGYWlsZWQgdG8gcmUtYXV0aGVudGljYXRlXCIpIH0pO1xuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgYXN5bmMgdHJ5U3NvTG9naW4oKSB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBidXN5OiB0cnVlIH0pO1xuXG4gICAgICAgIGNvbnN0IGhzVXJsID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oU1NPX0hPTUVTRVJWRVJfVVJMX0tFWSk7XG4gICAgICAgIGNvbnN0IGlzVXJsID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oU1NPX0lEX1NFUlZFUl9VUkxfS0VZKSB8fCBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZ2V0SWRlbnRpdHlTZXJ2ZXJVcmwoKTtcbiAgICAgICAgY29uc3QgbG9naW5UeXBlID0gXCJtLmxvZ2luLnRva2VuXCI7XG4gICAgICAgIGNvbnN0IGxvZ2luUGFyYW1zID0ge1xuICAgICAgICAgICAgdG9rZW46IHRoaXMucHJvcHMucmVhbFF1ZXJ5UGFyYW1zWydsb2dpblRva2VuJ10sXG4gICAgICAgICAgICBkZXZpY2VfaWQ6IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXREZXZpY2VJZCgpLFxuICAgICAgICB9O1xuXG4gICAgICAgIGxldCBjcmVkZW50aWFscyA9IG51bGw7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjcmVkZW50aWFscyA9IGF3YWl0IHNlbmRMb2dpblJlcXVlc3QoaHNVcmwsIGlzVXJsLCBsb2dpblR5cGUsIGxvZ2luUGFyYW1zKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGUpO1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGJ1c3k6IGZhbHNlLCBsb2dpblZpZXc6IExPR0lOX1ZJRVcuVU5TVVBQT1JURUQgfSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBMaWZlY3ljbGUuaHlkcmF0ZVNlc3Npb24oY3JlZGVudGlhbHMpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMucHJvcHMub25Ub2tlbkxvZ2luQ29tcGxldGVkKSB0aGlzLnByb3BzLm9uVG9rZW5Mb2dpbkNvbXBsZXRlZCgpO1xuICAgICAgICB9KS5jYXRjaCgoZSkgPT4ge1xuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGUpO1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGJ1c3k6IGZhbHNlLCBsb2dpblZpZXc6IExPR0lOX1ZJRVcuVU5TVVBQT1JURUQgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVuZGVyU2lnbkluU2VjdGlvbigpIHtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUubG9naW5WaWV3ID09PSBMT0dJTl9WSUVXLkxPQURJTkcpIHtcbiAgICAgICAgICAgIHJldHVybiA8U3Bpbm5lciAvPjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBpbnRyb1RleHQgPSBudWxsOyAvLyBudWxsIGlzIHRyYW5zbGF0ZWQgdG8gc29tZXRoaW5nIGFyZWEgc3BlY2lmaWMgaW4gdGhpcyBmdW5jdGlvblxuICAgICAgICBpZiAodGhpcy5zdGF0ZS5rZXlCYWNrdXBOZWVkZWQpIHtcbiAgICAgICAgICAgIGludHJvVGV4dCA9IF90KFxuICAgICAgICAgICAgICAgIFwiUmVnYWluIGFjY2VzcyB0byB5b3VyIGFjY291bnQgYW5kIHJlY292ZXIgZW5jcnlwdGlvbiBrZXlzIHN0b3JlZCBpbiB0aGlzIHNlc3Npb24uIFwiICtcbiAgICAgICAgICAgICAgICBcIldpdGhvdXQgdGhlbSwgeW91IHdvbid0IGJlIGFibGUgdG8gcmVhZCBhbGwgb2YgeW91ciBzZWN1cmUgbWVzc2FnZXMgaW4gYW55IHNlc3Npb24uXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuc3RhdGUubG9naW5WaWV3ID09PSBMT0dJTl9WSUVXLlBBU1NXT1JEKSB7XG4gICAgICAgICAgICBsZXQgZXJyb3IgPSBudWxsO1xuICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUuZXJyb3JUZXh0KSB7XG4gICAgICAgICAgICAgICAgZXJyb3IgPSA8c3BhbiBjbGFzc05hbWU9J214X0xvZ2luX2Vycm9yJz57IHRoaXMuc3RhdGUuZXJyb3JUZXh0IH08L3NwYW4+O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIWludHJvVGV4dCkge1xuICAgICAgICAgICAgICAgIGludHJvVGV4dCA9IF90KFwiRW50ZXIgeW91ciBwYXNzd29yZCB0byBzaWduIGluIGFuZCByZWdhaW4gYWNjZXNzIHRvIHlvdXIgYWNjb3VudC5cIik7XG4gICAgICAgICAgICB9IC8vIGVsc2Ugd2UgYWxyZWFkeSBoYXZlIGEgbWVzc2FnZSBhbmQgc2hvdWxkIHVzZSBpdCAoa2V5IGJhY2t1cCB3YXJuaW5nKVxuXG4gICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgIDxmb3JtIG9uU3VibWl0PXt0aGlzLm9uUGFzc3dvcmRMb2dpbn0+XG4gICAgICAgICAgICAgICAgICAgIDxwPnsgaW50cm9UZXh0IH08L3A+XG4gICAgICAgICAgICAgICAgICAgIHsgZXJyb3IgfVxuICAgICAgICAgICAgICAgICAgICA8RmllbGRcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU9XCJwYXNzd29yZFwiXG4gICAgICAgICAgICAgICAgICAgICAgICBsYWJlbD17X3QoXCJQYXNzd29yZFwiKX1cbiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2hhbmdlPXt0aGlzLm9uUGFzc3dvcmRDaGFuZ2V9XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZT17dGhpcy5zdGF0ZS5wYXNzd29yZH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVkPXt0aGlzLnN0YXRlLmJ1c3l9XG4gICAgICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uXG4gICAgICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLm9uUGFzc3dvcmRMb2dpbn1cbiAgICAgICAgICAgICAgICAgICAgICAgIGtpbmQ9XCJwcmltYXJ5XCJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU9XCJzdWJtaXRcIlxuICAgICAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWQ9e3RoaXMuc3RhdGUuYnVzeX1cbiAgICAgICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIlNpZ24gSW5cIikgfVxuICAgICAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uIG9uQ2xpY2s9e3RoaXMub25Gb3Jnb3RQYXNzd29yZH0ga2luZD1cImxpbmtcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCJGb3Jnb3R0ZW4geW91ciBwYXNzd29yZD9cIikgfVxuICAgICAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICAgICAgPC9mb3JtPlxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLnN0YXRlLmxvZ2luVmlldyA9PT0gTE9HSU5fVklFVy5TU08gfHwgdGhpcy5zdGF0ZS5sb2dpblZpZXcgPT09IExPR0lOX1ZJRVcuQ0FTKSB7XG4gICAgICAgICAgICBpZiAoIWludHJvVGV4dCkge1xuICAgICAgICAgICAgICAgIGludHJvVGV4dCA9IF90KFwiU2lnbiBpbiBhbmQgcmVnYWluIGFjY2VzcyB0byB5b3VyIGFjY291bnQuXCIpO1xuICAgICAgICAgICAgfSAvLyBlbHNlIHdlIGFscmVhZHkgaGF2ZSBhIG1lc3NhZ2UgYW5kIHNob3VsZCB1c2UgaXQgKGtleSBiYWNrdXAgd2FybmluZylcblxuICAgICAgICAgICAgY29uc3QgbG9naW5UeXBlID0gdGhpcy5zdGF0ZS5sb2dpblZpZXcgPT09IExPR0lOX1ZJRVcuQ0FTID8gXCJjYXNcIiA6IFwic3NvXCI7XG4gICAgICAgICAgICBjb25zdCBmbG93ID0gdGhpcy5zdGF0ZS5mbG93cy5maW5kKGZsb3cgPT4gZmxvdy50eXBlID09PSBcIm0ubG9naW4uXCIgKyBsb2dpblR5cGUpIGFzIElTU09GbG93O1xuXG4gICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgIDxkaXY+XG4gICAgICAgICAgICAgICAgICAgIDxwPnsgaW50cm9UZXh0IH08L3A+XG4gICAgICAgICAgICAgICAgICAgIDxTU09CdXR0b25zXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXRyaXhDbGllbnQ9e01hdHJpeENsaWVudFBlZy5nZXQoKX1cbiAgICAgICAgICAgICAgICAgICAgICAgIGZsb3c9e2Zsb3d9XG4gICAgICAgICAgICAgICAgICAgICAgICBsb2dpblR5cGU9e2xvZ2luVHlwZX1cbiAgICAgICAgICAgICAgICAgICAgICAgIGZyYWdtZW50QWZ0ZXJMb2dpbj17dGhpcy5wcm9wcy5mcmFnbWVudEFmdGVyTG9naW59XG4gICAgICAgICAgICAgICAgICAgICAgICBwcmltYXJ5PXshdGhpcy5zdGF0ZS5mbG93cy5maW5kKGZsb3cgPT4gZmxvdy50eXBlID09PSBcIm0ubG9naW4ucGFzc3dvcmRcIil9XG4gICAgICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gRGVmYXVsdDogYXNzdW1lIHVuc3VwcG9ydGVkL2Vycm9yXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8cD5cbiAgICAgICAgICAgICAgICB7IF90KFxuICAgICAgICAgICAgICAgICAgICBcIllvdSBjYW5ub3Qgc2lnbiBpbiB0byB5b3VyIGFjY291bnQuIFBsZWFzZSBjb250YWN0IHlvdXIgXCIgK1xuICAgICAgICAgICAgICAgICAgICBcImhvbWVzZXJ2ZXIgYWRtaW4gZm9yIG1vcmUgaW5mb3JtYXRpb24uXCIsXG4gICAgICAgICAgICAgICAgKSB9XG4gICAgICAgICAgICA8L3A+XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcmVuZGVyKCkge1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPEF1dGhQYWdlPlxuICAgICAgICAgICAgICAgIDxBdXRoSGVhZGVyIC8+XG4gICAgICAgICAgICAgICAgPEF1dGhCb2R5PlxuICAgICAgICAgICAgICAgICAgICA8aDI+XG4gICAgICAgICAgICAgICAgICAgICAgICB7IF90KFwiWW91J3JlIHNpZ25lZCBvdXRcIikgfVxuICAgICAgICAgICAgICAgICAgICA8L2gyPlxuXG4gICAgICAgICAgICAgICAgICAgIDxoMz57IF90KFwiU2lnbiBpblwiKSB9PC9oMz5cbiAgICAgICAgICAgICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgdGhpcy5yZW5kZXJTaWduSW5TZWN0aW9uKCkgfVxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cblxuICAgICAgICAgICAgICAgICAgICA8aDM+eyBfdChcIkNsZWFyIHBlcnNvbmFsIGRhdGFcIikgfTwvaDM+XG4gICAgICAgICAgICAgICAgICAgIDxwPlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIldhcm5pbmc6IFlvdXIgcGVyc29uYWwgZGF0YSAoaW5jbHVkaW5nIGVuY3J5cHRpb24ga2V5cykgaXMgc3RpbGwgc3RvcmVkIFwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcImluIHRoaXMgc2Vzc2lvbi4gQ2xlYXIgaXQgaWYgeW91J3JlIGZpbmlzaGVkIHVzaW5nIHRoaXMgc2Vzc2lvbiwgb3Igd2FudCB0byBzaWduIFwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcImluIHRvIGFub3RoZXIgYWNjb3VudC5cIixcbiAgICAgICAgICAgICAgICAgICAgICAgICkgfVxuICAgICAgICAgICAgICAgICAgICA8L3A+XG4gICAgICAgICAgICAgICAgICAgIDxkaXY+XG4gICAgICAgICAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvbiBvbkNsaWNrPXt0aGlzLm9uQ2xlYXJBbGx9IGtpbmQ9XCJkYW5nZXJcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IF90KFwiQ2xlYXIgYWxsIGRhdGFcIikgfVxuICAgICAgICAgICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICA8L0F1dGhCb2R5PlxuICAgICAgICAgICAgPC9BdXRoUGFnZT5cbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=