"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
exports.getDisplayAliasForRoom = getDisplayAliasForRoom;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _partials = require("matrix-js-sdk/src/@types/partials");

var _MatrixClientPeg = require("../../MatrixClientPeg");

var _dispatcher = _interopRequireDefault(require("../../dispatcher/dispatcher"));

var _Modal = _interopRequireDefault(require("../../Modal"));

var _HtmlUtils = require("../../HtmlUtils");

var _languageHandler = require("../../languageHandler");

var _SdkConfig = _interopRequireDefault(require("../../SdkConfig"));

var _DirectoryUtils = require("../../utils/DirectoryUtils");

var _Analytics = _interopRequireDefault(require("../../Analytics"));

var _NetworkDropdown = _interopRequireWildcard(require("../views/directory/NetworkDropdown"));

var _SettingsStore = _interopRequireDefault(require("../../settings/SettingsStore"));

var _GroupFilterOrderStore = _interopRequireDefault(require("../../stores/GroupFilterOrderStore"));

var _GroupStore = _interopRequireDefault(require("../../stores/GroupStore"));

var _FlairStore = _interopRequireDefault(require("../../stores/FlairStore"));

var _CountlyAnalytics = _interopRequireDefault(require("../../CountlyAnalytics"));

var _replaceableComponent = require("../../utils/replaceableComponent");

var _Media = require("../../customisations/Media");

var _AccessibleButton = _interopRequireDefault(require("../views/elements/AccessibleButton"));

var _BaseAvatar = _interopRequireDefault(require("../views/avatars/BaseAvatar"));

var _ErrorDialog = _interopRequireDefault(require("../views/dialogs/ErrorDialog"));

var _QuestionDialog = _interopRequireDefault(require("../views/dialogs/QuestionDialog"));

var _BaseDialog = _interopRequireDefault(require("../views/dialogs/BaseDialog"));

var _DirectorySearchBox = _interopRequireDefault(require("../views/elements/DirectorySearchBox"));

var _ScrollPanel = _interopRequireDefault(require("./ScrollPanel"));

var _Spinner = _interopRequireDefault(require("../views/elements/Spinner"));

var _Rooms = require("../../Rooms");

var _logger = require("matrix-js-sdk/src/logger");

var _actions = require("../../dispatcher/actions");

var _dec, _class;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

const MAX_NAME_LENGTH = 80;
const MAX_TOPIC_LENGTH = 800;
const LAST_SERVER_KEY = "mx_last_room_directory_server";
const LAST_INSTANCE_KEY = "mx_last_room_directory_instance";

function track(action) {
  _Analytics.default.trackEvent('RoomDirectory', action);
}

let RoomDirectory = (_dec = (0, _replaceableComponent.replaceableComponent)("structures.RoomDirectory"), _dec(_class = class RoomDirectory extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "startTime", void 0);
    (0, _defineProperty2.default)(this, "unmounted", false);
    (0, _defineProperty2.default)(this, "nextBatch", null);
    (0, _defineProperty2.default)(this, "filterTimeout", void 0);
    (0, _defineProperty2.default)(this, "protocols", void 0);
    (0, _defineProperty2.default)(this, "refreshRoomList", () => {
      if (this.state.selectedCommunityId) {
        this.setState({
          publicRooms: _GroupStore.default.getGroupRooms(this.state.selectedCommunityId).map(r => {
            return {
              // Translate all the group properties to the directory format
              room_id: r.roomId,
              name: r.name,
              topic: r.topic,
              canonical_alias: r.canonicalAlias,
              num_joined_members: r.numJoinedMembers,
              avatarUrl: r.avatarUrl,
              world_readable: r.worldReadable,
              guest_can_join: r.guestsCanJoin
            };
          }).filter(r => {
            const filterString = this.state.filterString;

            if (filterString) {
              const containedIn = s => (s || "").toLowerCase().includes(filterString.toLowerCase());

              return containedIn(r.name) || containedIn(r.topic) || containedIn(r.canonical_alias);
            }

            return true;
          }),
          loading: false
        });
        return;
      }

      this.nextBatch = null;
      this.setState({
        publicRooms: [],
        loading: true
      });
      this.getMoreRooms();
    });
    (0, _defineProperty2.default)(this, "onRoomClicked", (room, ev) => {
      // If room was shift-clicked, remove it from the room directory
      if (ev.shiftKey && !this.state.selectedCommunityId) {
        ev.preventDefault();
        this.removeFromDirectory(room);
      }
    });
    (0, _defineProperty2.default)(this, "onOptionChange", (server, instanceId) => {
      // clear next batch so we don't try to load more rooms
      this.nextBatch = null;
      this.setState({
        // Clear the public rooms out here otherwise we needlessly
        // spend time filtering lots of rooms when we're about to
        // to clear the list anyway.
        publicRooms: [],
        roomServer: server,
        instanceId: instanceId,
        error: null
      }, this.refreshRoomList); // We also refresh the room list each time even though this
      // filtering is client-side. It hopefully won't be client side
      // for very long, and we may have fetched a thousand rooms to
      // find the five gitter ones, at which point we do not want
      // to render all those rooms when switching back to 'all networks'.
      // Easiest to just blow away the state & re-fetch.
      // We have to be careful here so that we don't set instanceId = "undefined"

      localStorage.setItem(LAST_SERVER_KEY, server);

      if (instanceId) {
        localStorage.setItem(LAST_INSTANCE_KEY, instanceId);
      } else {
        localStorage.removeItem(LAST_INSTANCE_KEY);
      }
    });
    (0, _defineProperty2.default)(this, "onFillRequest", backwards => {
      if (backwards || !this.nextBatch) return Promise.resolve(false);
      return this.getMoreRooms();
    });
    (0, _defineProperty2.default)(this, "onFilterChange", alias => {
      this.setState({
        filterString: alias || ""
      }); // don't send the request for a little bit,
      // no point hammering the server with a
      // request for every keystroke, let the
      // user finish typing.

      if (this.filterTimeout) {
        clearTimeout(this.filterTimeout);
      }

      this.filterTimeout = setTimeout(() => {
        this.filterTimeout = null;
        this.refreshRoomList();
      }, 700);
    });
    (0, _defineProperty2.default)(this, "onFilterClear", () => {
      // update immediately
      this.setState({
        filterString: ""
      }, this.refreshRoomList);

      if (this.filterTimeout) {
        clearTimeout(this.filterTimeout);
      }
    });
    (0, _defineProperty2.default)(this, "onJoinFromSearchClick", alias => {
      // If we don't have a particular instance id selected, just show that rooms alias
      if (!this.state.instanceId || this.state.instanceId === _NetworkDropdown.ALL_ROOMS) {
        // If the user specified an alias without a domain, add on whichever server is selected
        // in the dropdown
        if (alias.indexOf(':') == -1) {
          alias = alias + ':' + this.state.roomServer;
        }

        this.showRoomAlias(alias, true);
      } else {
        // This is a 3rd party protocol. Let's see if we can join it
        const protocolName = (0, _DirectoryUtils.protocolNameForInstanceId)(this.protocols, this.state.instanceId);
        const instance = (0, _DirectoryUtils.instanceForInstanceId)(this.protocols, this.state.instanceId);
        const fields = protocolName ? this.getFieldsForThirdPartyLocation(alias, this.protocols[protocolName], instance) : null;

        if (!fields) {
          const brand = _SdkConfig.default.get().brand;

          _Modal.default.createTrackedDialog('Unable to join network', '', _ErrorDialog.default, {
            title: (0, _languageHandler._t)('Unable to join network'),
            description: (0, _languageHandler._t)('%(brand)s does not know how to join a room on this network', {
              brand
            })
          });

          return;
        }

        _MatrixClientPeg.MatrixClientPeg.get().getThirdpartyLocation(protocolName, fields).then(resp => {
          if (resp.length > 0 && resp[0].alias) {
            this.showRoomAlias(resp[0].alias, true);
          } else {
            _Modal.default.createTrackedDialog('Room not found', '', _ErrorDialog.default, {
              title: (0, _languageHandler._t)('Room not found'),
              description: (0, _languageHandler._t)('Couldn\'t find a matching Matrix room')
            });
          }
        }, e => {
          _Modal.default.createTrackedDialog('Fetching third party location failed', '', _ErrorDialog.default, {
            title: (0, _languageHandler._t)('Fetching third party location failed'),
            description: (0, _languageHandler._t)('Unable to look up room ID from server')
          });
        });
      }
    });
    (0, _defineProperty2.default)(this, "onPreviewClick", (ev, room) => {
      this.showRoom(room, null, false, true);
      ev.stopPropagation();
    });
    (0, _defineProperty2.default)(this, "onViewClick", (ev, room) => {
      this.showRoom(room);
      ev.stopPropagation();
    });
    (0, _defineProperty2.default)(this, "onJoinClick", (ev, room) => {
      this.showRoom(room, null, true);
      ev.stopPropagation();
    });
    (0, _defineProperty2.default)(this, "onCreateRoomClick", () => {
      this.onFinished();

      _dispatcher.default.dispatch({
        action: 'view_create_room',
        public: true,
        defaultName: this.state.filterString.trim()
      });
    });
    (0, _defineProperty2.default)(this, "onFinished", () => {
      _CountlyAnalytics.default.instance.trackRoomDirectory(this.startTime);

      this.props.onFinished(false);
    });

    _CountlyAnalytics.default.instance.trackRoomDirectoryBegin();

    this.startTime = _CountlyAnalytics.default.getTimestamp();
    const selectedCommunityId = _SettingsStore.default.getValue("feature_communities_v2_prototypes") ? _GroupFilterOrderStore.default.getSelectedTags()[0] : null;
    let protocolsLoading = true;

    if (!_MatrixClientPeg.MatrixClientPeg.get()) {
      // We may not have a client yet when invoked from welcome page
      protocolsLoading = false;
    } else if (!selectedCommunityId) {
      _MatrixClientPeg.MatrixClientPeg.get().getThirdpartyProtocols().then(response => {
        var _SdkConfig$get$roomDi, _SdkConfig$get$roomDi2, _SettingsStore$getVal;

        this.protocols = response;

        const myHomeserver = _MatrixClientPeg.MatrixClientPeg.getHomeserverName();

        const lsRoomServer = localStorage.getItem(LAST_SERVER_KEY);
        const lsInstanceId = localStorage.getItem(LAST_INSTANCE_KEY);
        let roomServer = myHomeserver;

        if ((_SdkConfig$get$roomDi = _SdkConfig.default.get().roomDirectory) !== null && _SdkConfig$get$roomDi !== void 0 && (_SdkConfig$get$roomDi2 = _SdkConfig$get$roomDi.servers) !== null && _SdkConfig$get$roomDi2 !== void 0 && _SdkConfig$get$roomDi2.includes(lsRoomServer) || (_SettingsStore$getVal = _SettingsStore.default.getValue("room_directory_servers")) !== null && _SettingsStore$getVal !== void 0 && _SettingsStore$getVal.includes(lsRoomServer)) {
          roomServer = lsRoomServer;
        }

        let instanceId = null;

        if (roomServer === myHomeserver && (lsInstanceId === _NetworkDropdown.ALL_ROOMS || Object.values(this.protocols).some(p => p.instances.some(i => i.instance_id === lsInstanceId)))) {
          instanceId = lsInstanceId;
        } // Refresh the room list only if validation failed and we had to change these


        if (this.state.instanceId !== instanceId || this.state.roomServer !== roomServer) {
          this.setState({
            protocolsLoading: false,
            instanceId,
            roomServer
          });
          this.refreshRoomList();
          return;
        }

        this.setState({
          protocolsLoading: false
        });
      }, err => {
        _logger.logger.warn(`error loading third party protocols: ${err}`);

        this.setState({
          protocolsLoading: false
        });

        if (_MatrixClientPeg.MatrixClientPeg.get().isGuest()) {
          // Guests currently aren't allowed to use this API, so
          // ignore this as otherwise this error is literally the
          // thing you see when loading the client!
          return;
        }

        track('Failed to get protocol list from homeserver');

        const brand = _SdkConfig.default.get().brand;

        this.setState({
          error: (0, _languageHandler._t)('%(brand)s failed to get the protocol list from the homeserver. ' + 'The homeserver may be too old to support third party networks.', {
            brand
          })
        });
      });
    } else {
      // We don't use the protocols in the communities v2 prototype experience
      protocolsLoading = false; // Grab the profile info async

      _FlairStore.default.getGroupProfileCached(_MatrixClientPeg.MatrixClientPeg.get(), this.state.selectedCommunityId).then(profile => {
        this.setState({
          communityName: profile.name
        });
      });
    }

    this.state = {
      publicRooms: [],
      loading: true,
      error: null,
      instanceId: localStorage.getItem(LAST_INSTANCE_KEY),
      roomServer: localStorage.getItem(LAST_SERVER_KEY),
      filterString: this.props.initialText || "",
      selectedCommunityId,
      communityName: null,
      protocolsLoading
    };
  }

  componentDidMount() {
    this.refreshRoomList();
  }

  componentWillUnmount() {
    if (this.filterTimeout) {
      clearTimeout(this.filterTimeout);
    }

    this.unmounted = true;
  }

  getMoreRooms() {
    if (this.state.selectedCommunityId) return Promise.resolve(false); // no more rooms

    if (!_MatrixClientPeg.MatrixClientPeg.get()) return Promise.resolve(false);
    this.setState({
      loading: true
    });
    const filterString = this.state.filterString;
    const roomServer = this.state.roomServer; // remember the next batch token when we sent the request
    // too. If it's changed, appending to the list will corrupt it.

    const nextBatch = this.nextBatch;
    const opts = {
      limit: 20
    };

    if (roomServer != _MatrixClientPeg.MatrixClientPeg.getHomeserverName()) {
      opts.server = roomServer;
    }

    if (this.state.instanceId === _NetworkDropdown.ALL_ROOMS) {
      opts.include_all_networks = true;
    } else if (this.state.instanceId) {
      opts.third_party_instance_id = this.state.instanceId;
    }

    if (this.nextBatch) opts.since = this.nextBatch;
    if (filterString) opts.filter = {
      generic_search_term: filterString
    };
    return _MatrixClientPeg.MatrixClientPeg.get().publicRooms(opts).then(data => {
      if (filterString != this.state.filterString || roomServer != this.state.roomServer || nextBatch != this.nextBatch) {
        // if the filter or server has changed since this request was sent,
        // throw away the result (don't even clear the busy flag
        // since we must still have a request in flight)
        return false;
      }

      if (this.unmounted) {
        // if we've been unmounted, we don't care either.
        return false;
      }

      if (this.state.filterString) {
        const count = data.total_room_count_estimate || data.chunk.length;

        _CountlyAnalytics.default.instance.trackRoomDirectorySearch(count, this.state.filterString);
      }

      this.nextBatch = data.next_batch;
      this.setState(s => _objectSpread(_objectSpread({}, s), {}, {
        publicRooms: [...s.publicRooms, ...(data.chunk || [])],
        loading: false
      }));
      return Boolean(data.next_batch);
    }, err => {
      if (filterString != this.state.filterString || roomServer != this.state.roomServer || nextBatch != this.nextBatch) {
        // as above: we don't care about errors for old requests either
        return false;
      }

      if (this.unmounted) {
        // if we've been unmounted, we don't care either.
        return false;
      }

      _logger.logger.error("Failed to get publicRooms: %s", JSON.stringify(err));

      track('Failed to get public room list');

      const brand = _SdkConfig.default.get().brand;

      this.setState({
        loading: false,
        error: (0, _languageHandler._t)('%(brand)s failed to get the public room list.', {
          brand
        }) + (err && err.message) ? err.message : (0, _languageHandler._t)('The homeserver may be unavailable or overloaded.')
      });
    });
  }
  /**
   * A limited interface for removing rooms from the directory.
   * Will set the room to not be publicly visible and delete the
   * default alias. In the long term, it would be better to allow
   * HS admins to do this through the RoomSettings interface, but
   * this needs SPEC-417.
   */


  removeFromDirectory(room) {
    const alias = getDisplayAliasForRoom(room);
    const name = room.name || alias || (0, _languageHandler._t)('Unnamed room');
    let desc;

    if (alias) {
      desc = (0, _languageHandler._t)('Delete the room address %(alias)s and remove %(name)s from the directory?', {
        alias,
        name
      });
    } else {
      desc = (0, _languageHandler._t)('Remove %(name)s from the directory?', {
        name: name
      });
    }

    _Modal.default.createTrackedDialog('Remove from Directory', '', _QuestionDialog.default, {
      title: (0, _languageHandler._t)('Remove from Directory'),
      description: desc,
      onFinished: shouldDelete => {
        if (!shouldDelete) return;

        const modal = _Modal.default.createDialog(_Spinner.default);

        let step = (0, _languageHandler._t)('remove %(name)s from the directory.', {
          name: name
        });

        _MatrixClientPeg.MatrixClientPeg.get().setRoomDirectoryVisibility(room.room_id, _partials.Visibility.Private).then(() => {
          if (!alias) return;
          step = (0, _languageHandler._t)('delete the address.');
          return _MatrixClientPeg.MatrixClientPeg.get().deleteAlias(alias);
        }).then(() => {
          modal.close();
          this.refreshRoomList();
        }, err => {
          modal.close();
          this.refreshRoomList();

          _logger.logger.error("Failed to " + step + ": " + err);

          _Modal.default.createTrackedDialog('Remove from Directory Error', '', _ErrorDialog.default, {
            title: (0, _languageHandler._t)('Error'),
            description: err && err.message ? err.message : (0, _languageHandler._t)('The server may be unavailable or overloaded')
          });
        });
      }
    });
  }

  showRoomAlias(alias, autoJoin = false) {
    this.showRoom(null, alias, autoJoin);
  }

  showRoom(room, roomAlias, autoJoin = false, shouldPeek = false) {
    this.onFinished();
    const payload = {
      action: _actions.Action.ViewRoom,
      auto_join: autoJoin,
      should_peek: shouldPeek,
      _type: "room_directory" // instrumentation

    };

    if (room) {
      // Don't let the user view a room they won't be able to either
      // peek or join: fail earlier so they don't have to click back
      // to the directory.
      if (_MatrixClientPeg.MatrixClientPeg.get().isGuest()) {
        if (!room.world_readable && !room.guest_can_join) {
          _dispatcher.default.dispatch({
            action: 'require_registration'
          });

          return;
        }
      }

      if (!roomAlias) {
        roomAlias = getDisplayAliasForRoom(room);
      }

      payload.oob_data = {
        avatarUrl: room.avatar_url,
        // XXX: This logic is duplicated from the JS SDK which
        // would normally decide what the name is.
        name: room.name || roomAlias || (0, _languageHandler._t)('Unnamed room')
      };

      if (this.state.roomServer) {
        payload.via_servers = [this.state.roomServer];
        payload.opts = {
          viaServers: [this.state.roomServer]
        };
      }
    } // It's not really possible to join Matrix rooms by ID because the HS has no way to know
    // which servers to start querying. However, there's no other way to join rooms in
    // this list without aliases at present, so if roomAlias isn't set here we have no
    // choice but to supply the ID.


    if (roomAlias) {
      payload.room_alias = roomAlias;
    } else {
      payload.room_id = room.room_id;
    }

    _dispatcher.default.dispatch(payload);
  }

  createRoomCells(room) {
    const client = _MatrixClientPeg.MatrixClientPeg.get();

    const clientRoom = client.getRoom(room.room_id);
    const hasJoinedRoom = clientRoom && clientRoom.getMyMembership() === "join";
    const isGuest = client.isGuest();
    let previewButton;
    let joinOrViewButton; // Element Web currently does not allow guests to join rooms, so we
    // instead show them preview buttons for all rooms. If the room is not
    // world readable, a modal will appear asking you to register first. If
    // it is readable, the preview appears as normal.

    if (!hasJoinedRoom && (room.world_readable || isGuest)) {
      previewButton = /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        kind: "secondary",
        onClick: ev => this.onPreviewClick(ev, room)
      }, (0, _languageHandler._t)("Preview"));
    }

    if (hasJoinedRoom) {
      joinOrViewButton = /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        kind: "secondary",
        onClick: ev => this.onViewClick(ev, room)
      }, (0, _languageHandler._t)("View"));
    } else if (!isGuest) {
      joinOrViewButton = /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        kind: "primary",
        onClick: ev => this.onJoinClick(ev, room)
      }, (0, _languageHandler._t)("Join"));
    }

    let name = room.name || getDisplayAliasForRoom(room) || (0, _languageHandler._t)('Unnamed room');

    if (name.length > MAX_NAME_LENGTH) {
      name = `${name.substring(0, MAX_NAME_LENGTH)}...`;
    }

    let topic = room.topic || ''; // Additional truncation based on line numbers is done via CSS,
    // but to ensure that the DOM is not polluted with a huge string
    // we give it a hard limit before rendering.

    if (topic.length > MAX_TOPIC_LENGTH) {
      topic = `${topic.substring(0, MAX_TOPIC_LENGTH)}...`;
    }

    topic = (0, _HtmlUtils.linkifyAndSanitizeHtml)(topic);
    let avatarUrl = null;
    if (room.avatar_url) avatarUrl = (0, _Media.mediaFromMxc)(room.avatar_url).getSquareThumbnailHttp(32); // We use onMouseDown instead of onClick, so that we can avoid text getting selected

    return /*#__PURE__*/_react.default.createElement("div", {
      key: room.room_id,
      role: "listitem",
      className: "mx_RoomDirectory_listItem"
    }, /*#__PURE__*/_react.default.createElement("div", {
      onMouseDown: ev => this.onRoomClicked(room, ev),
      className: "mx_RoomDirectory_roomAvatar"
    }, /*#__PURE__*/_react.default.createElement(_BaseAvatar.default, {
      width: 32,
      height: 32,
      resizeMethod: "crop",
      name: name,
      idName: name,
      url: avatarUrl
    })), /*#__PURE__*/_react.default.createElement("div", {
      onMouseDown: ev => this.onRoomClicked(room, ev),
      className: "mx_RoomDirectory_roomDescription"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_RoomDirectory_name",
      onMouseDown: ev => this.onRoomClicked(room, ev)
    }, name), "\xA0", /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_RoomDirectory_topic",
      onMouseDown: ev => this.onRoomClicked(room, ev),
      dangerouslySetInnerHTML: {
        __html: topic
      }
    }), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_RoomDirectory_alias",
      onMouseDown: ev => this.onRoomClicked(room, ev)
    }, getDisplayAliasForRoom(room))), /*#__PURE__*/_react.default.createElement("div", {
      onMouseDown: ev => this.onRoomClicked(room, ev),
      className: "mx_RoomDirectory_roomMemberCount"
    }, room.num_joined_members), /*#__PURE__*/_react.default.createElement("div", {
      onMouseDown: ev => this.onRoomClicked(room, ev) // cancel onMouseDown otherwise shift-clicking highlights text
      ,
      className: "mx_RoomDirectory_preview"
    }, previewButton), /*#__PURE__*/_react.default.createElement("div", {
      onMouseDown: ev => this.onRoomClicked(room, ev),
      className: "mx_RoomDirectory_join"
    }, joinOrViewButton));
  }

  stringLooksLikeId(s, fieldType) {
    let pat = /^#[^\s]+:[^\s]/;

    if (fieldType && fieldType.regexp) {
      pat = new RegExp(fieldType.regexp);
    }

    return pat.test(s);
  }

  getFieldsForThirdPartyLocation(userInput, protocol, instance) {
    // make an object with the fields specified by that protocol. We
    // require that the values of all but the last field come from the
    // instance. The last is the user input.
    const requiredFields = protocol.location_fields;
    if (!requiredFields) return null;
    const fields = {};

    for (let i = 0; i < requiredFields.length - 1; ++i) {
      const thisField = requiredFields[i];
      if (instance.fields[thisField] === undefined) return null;
      fields[thisField] = instance.fields[thisField];
    }

    fields[requiredFields[requiredFields.length - 1]] = userInput;
    return fields;
  }

  render() {
    let content;

    if (this.state.error) {
      content = this.state.error;
    } else if (this.state.protocolsLoading) {
      content = /*#__PURE__*/_react.default.createElement(_Spinner.default, null);
    } else {
      const cells = (this.state.publicRooms || []).reduce((cells, room) => cells.concat(this.createRoomCells(room)), []); // we still show the scrollpanel, at least for now, because
      // otherwise we don't fetch more because we don't get a fill
      // request from the scrollpanel because there isn't one

      let spinner;

      if (this.state.loading) {
        spinner = /*#__PURE__*/_react.default.createElement(_Spinner.default, null);
      }

      const createNewButton = /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement("hr", null), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        kind: "primary",
        onClick: this.onCreateRoomClick,
        className: "mx_RoomDirectory_newRoom"
      }, (0, _languageHandler._t)("Create new room")));

      let scrollPanelContent;
      let footer;

      if (cells.length === 0 && !this.state.loading) {
        footer = /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement("h5", null, (0, _languageHandler._t)('No results for "%(query)s"', {
          query: this.state.filterString.trim()
        })), /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Try different words or check for typos. " + "Some results may not be visible as they're private and you need an invite to join them.")), createNewButton);
      } else {
        scrollPanelContent = /*#__PURE__*/_react.default.createElement("div", {
          className: "mx_RoomDirectory_table"
        }, cells);

        if (!this.state.loading && !this.nextBatch) {
          footer = createNewButton;
        }
      }

      content = /*#__PURE__*/_react.default.createElement(_ScrollPanel.default, {
        className: "mx_RoomDirectory_tableWrapper",
        onFillRequest: this.onFillRequest,
        stickyBottom: false,
        startAtBottom: false
      }, scrollPanelContent, spinner, footer && /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_RoomDirectory_footer"
      }, footer));
    }

    let listHeader;

    if (!this.state.protocolsLoading) {
      const protocolName = (0, _DirectoryUtils.protocolNameForInstanceId)(this.protocols, this.state.instanceId);
      let instanceExpectedFieldType;

      if (protocolName && this.protocols && this.protocols[protocolName] && this.protocols[protocolName].location_fields.length > 0 && this.protocols[protocolName].field_types) {
        const lastField = this.protocols[protocolName].location_fields.slice(-1)[0];
        instanceExpectedFieldType = this.protocols[protocolName].field_types[lastField];
      }

      let placeholder = (0, _languageHandler._t)('Find a room…');

      if (!this.state.instanceId || this.state.instanceId === _NetworkDropdown.ALL_ROOMS) {
        placeholder = (0, _languageHandler._t)("Find a room… (e.g. %(exampleRoom)s)", {
          exampleRoom: "#example:" + this.state.roomServer
        });
      } else if (instanceExpectedFieldType) {
        placeholder = instanceExpectedFieldType.placeholder;
      }

      let showJoinButton = this.stringLooksLikeId(this.state.filterString, instanceExpectedFieldType);

      if (protocolName) {
        const instance = (0, _DirectoryUtils.instanceForInstanceId)(this.protocols, this.state.instanceId);

        if (this.getFieldsForThirdPartyLocation(this.state.filterString, this.protocols[protocolName], instance) === null) {
          showJoinButton = false;
        }
      }

      let dropdown = /*#__PURE__*/_react.default.createElement(_NetworkDropdown.default, {
        protocols: this.protocols,
        onOptionChange: this.onOptionChange,
        selectedServerName: this.state.roomServer,
        selectedInstanceId: this.state.instanceId
      });

      if (this.state.selectedCommunityId) {
        dropdown = null;
      }

      listHeader = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_RoomDirectory_listheader"
      }, /*#__PURE__*/_react.default.createElement(_DirectorySearchBox.default, {
        className: "mx_RoomDirectory_searchbox",
        onChange: this.onFilterChange,
        onClear: this.onFilterClear,
        onJoinClick: this.onJoinFromSearchClick,
        placeholder: placeholder,
        showJoinButton: showJoinButton,
        initialText: this.props.initialText
      }), dropdown);
    }

    const explanation = (0, _languageHandler._t)("If you can't find the room you're looking for, ask for an invite or <a>Create a new room</a>.", null, {
      a: sub => /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        kind: "secondary",
        onClick: this.onCreateRoomClick
      }, sub)
    });
    const title = this.state.selectedCommunityId ? (0, _languageHandler._t)("Explore rooms in %(communityName)s", {
      communityName: this.state.communityName || this.state.selectedCommunityId
    }) : (0, _languageHandler._t)("Explore rooms");
    return /*#__PURE__*/_react.default.createElement(_BaseDialog.default, {
      className: "mx_RoomDirectory_dialog",
      hasCancel: true,
      onFinished: this.onFinished,
      title: title
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_RoomDirectory"
    }, explanation, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_RoomDirectory_list"
    }, listHeader, content)));
  }

}) || _class);
exports.default = RoomDirectory;

// Similar to matrix-react-sdk's MatrixTools.getDisplayAliasForRoom
// but works with the objects we get from the public room list
function getDisplayAliasForRoom(room) {
  return (0, _Rooms.getDisplayAliasForAliasSet)(room.canonical_alias, room.aliases);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3N0cnVjdHVyZXMvUm9vbURpcmVjdG9yeS50c3giXSwibmFtZXMiOlsiTUFYX05BTUVfTEVOR1RIIiwiTUFYX1RPUElDX0xFTkdUSCIsIkxBU1RfU0VSVkVSX0tFWSIsIkxBU1RfSU5TVEFOQ0VfS0VZIiwidHJhY2siLCJhY3Rpb24iLCJBbmFseXRpY3MiLCJ0cmFja0V2ZW50IiwiUm9vbURpcmVjdG9yeSIsIlJlYWN0IiwiQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsInN0YXRlIiwic2VsZWN0ZWRDb21tdW5pdHlJZCIsInNldFN0YXRlIiwicHVibGljUm9vbXMiLCJHcm91cFN0b3JlIiwiZ2V0R3JvdXBSb29tcyIsIm1hcCIsInIiLCJyb29tX2lkIiwicm9vbUlkIiwibmFtZSIsInRvcGljIiwiY2Fub25pY2FsX2FsaWFzIiwiY2Fub25pY2FsQWxpYXMiLCJudW1fam9pbmVkX21lbWJlcnMiLCJudW1Kb2luZWRNZW1iZXJzIiwiYXZhdGFyVXJsIiwid29ybGRfcmVhZGFibGUiLCJ3b3JsZFJlYWRhYmxlIiwiZ3Vlc3RfY2FuX2pvaW4iLCJndWVzdHNDYW5Kb2luIiwiZmlsdGVyIiwiZmlsdGVyU3RyaW5nIiwiY29udGFpbmVkSW4iLCJzIiwidG9Mb3dlckNhc2UiLCJpbmNsdWRlcyIsImxvYWRpbmciLCJuZXh0QmF0Y2giLCJnZXRNb3JlUm9vbXMiLCJyb29tIiwiZXYiLCJzaGlmdEtleSIsInByZXZlbnREZWZhdWx0IiwicmVtb3ZlRnJvbURpcmVjdG9yeSIsInNlcnZlciIsImluc3RhbmNlSWQiLCJyb29tU2VydmVyIiwiZXJyb3IiLCJyZWZyZXNoUm9vbUxpc3QiLCJsb2NhbFN0b3JhZ2UiLCJzZXRJdGVtIiwicmVtb3ZlSXRlbSIsImJhY2t3YXJkcyIsIlByb21pc2UiLCJyZXNvbHZlIiwiYWxpYXMiLCJmaWx0ZXJUaW1lb3V0IiwiY2xlYXJUaW1lb3V0Iiwic2V0VGltZW91dCIsIkFMTF9ST09NUyIsImluZGV4T2YiLCJzaG93Um9vbUFsaWFzIiwicHJvdG9jb2xOYW1lIiwicHJvdG9jb2xzIiwiaW5zdGFuY2UiLCJmaWVsZHMiLCJnZXRGaWVsZHNGb3JUaGlyZFBhcnR5TG9jYXRpb24iLCJicmFuZCIsIlNka0NvbmZpZyIsImdldCIsIk1vZGFsIiwiY3JlYXRlVHJhY2tlZERpYWxvZyIsIkVycm9yRGlhbG9nIiwidGl0bGUiLCJkZXNjcmlwdGlvbiIsIk1hdHJpeENsaWVudFBlZyIsImdldFRoaXJkcGFydHlMb2NhdGlvbiIsInRoZW4iLCJyZXNwIiwibGVuZ3RoIiwiZSIsInNob3dSb29tIiwic3RvcFByb3BhZ2F0aW9uIiwib25GaW5pc2hlZCIsImRpcyIsImRpc3BhdGNoIiwicHVibGljIiwiZGVmYXVsdE5hbWUiLCJ0cmltIiwiQ291bnRseUFuYWx5dGljcyIsInRyYWNrUm9vbURpcmVjdG9yeSIsInN0YXJ0VGltZSIsInRyYWNrUm9vbURpcmVjdG9yeUJlZ2luIiwiZ2V0VGltZXN0YW1wIiwiU2V0dGluZ3NTdG9yZSIsImdldFZhbHVlIiwiR3JvdXBGaWx0ZXJPcmRlclN0b3JlIiwiZ2V0U2VsZWN0ZWRUYWdzIiwicHJvdG9jb2xzTG9hZGluZyIsImdldFRoaXJkcGFydHlQcm90b2NvbHMiLCJyZXNwb25zZSIsIm15SG9tZXNlcnZlciIsImdldEhvbWVzZXJ2ZXJOYW1lIiwibHNSb29tU2VydmVyIiwiZ2V0SXRlbSIsImxzSW5zdGFuY2VJZCIsInJvb21EaXJlY3RvcnkiLCJzZXJ2ZXJzIiwiT2JqZWN0IiwidmFsdWVzIiwic29tZSIsInAiLCJpbnN0YW5jZXMiLCJpIiwiaW5zdGFuY2VfaWQiLCJlcnIiLCJsb2dnZXIiLCJ3YXJuIiwiaXNHdWVzdCIsIkZsYWlyU3RvcmUiLCJnZXRHcm91cFByb2ZpbGVDYWNoZWQiLCJwcm9maWxlIiwiY29tbXVuaXR5TmFtZSIsImluaXRpYWxUZXh0IiwiY29tcG9uZW50RGlkTW91bnQiLCJjb21wb25lbnRXaWxsVW5tb3VudCIsInVubW91bnRlZCIsIm9wdHMiLCJsaW1pdCIsImluY2x1ZGVfYWxsX25ldHdvcmtzIiwidGhpcmRfcGFydHlfaW5zdGFuY2VfaWQiLCJzaW5jZSIsImdlbmVyaWNfc2VhcmNoX3Rlcm0iLCJkYXRhIiwiY291bnQiLCJ0b3RhbF9yb29tX2NvdW50X2VzdGltYXRlIiwiY2h1bmsiLCJ0cmFja1Jvb21EaXJlY3RvcnlTZWFyY2giLCJuZXh0X2JhdGNoIiwiQm9vbGVhbiIsIkpTT04iLCJzdHJpbmdpZnkiLCJtZXNzYWdlIiwiZ2V0RGlzcGxheUFsaWFzRm9yUm9vbSIsImRlc2MiLCJRdWVzdGlvbkRpYWxvZyIsInNob3VsZERlbGV0ZSIsIm1vZGFsIiwiY3JlYXRlRGlhbG9nIiwiU3Bpbm5lciIsInN0ZXAiLCJzZXRSb29tRGlyZWN0b3J5VmlzaWJpbGl0eSIsIlZpc2liaWxpdHkiLCJQcml2YXRlIiwiZGVsZXRlQWxpYXMiLCJjbG9zZSIsImF1dG9Kb2luIiwicm9vbUFsaWFzIiwic2hvdWxkUGVlayIsInBheWxvYWQiLCJBY3Rpb24iLCJWaWV3Um9vbSIsImF1dG9fam9pbiIsInNob3VsZF9wZWVrIiwiX3R5cGUiLCJvb2JfZGF0YSIsImF2YXRhcl91cmwiLCJ2aWFfc2VydmVycyIsInZpYVNlcnZlcnMiLCJyb29tX2FsaWFzIiwiY3JlYXRlUm9vbUNlbGxzIiwiY2xpZW50IiwiY2xpZW50Um9vbSIsImdldFJvb20iLCJoYXNKb2luZWRSb29tIiwiZ2V0TXlNZW1iZXJzaGlwIiwicHJldmlld0J1dHRvbiIsImpvaW5PclZpZXdCdXR0b24iLCJvblByZXZpZXdDbGljayIsIm9uVmlld0NsaWNrIiwib25Kb2luQ2xpY2siLCJzdWJzdHJpbmciLCJnZXRTcXVhcmVUaHVtYm5haWxIdHRwIiwib25Sb29tQ2xpY2tlZCIsIl9faHRtbCIsInN0cmluZ0xvb2tzTGlrZUlkIiwiZmllbGRUeXBlIiwicGF0IiwicmVnZXhwIiwiUmVnRXhwIiwidGVzdCIsInVzZXJJbnB1dCIsInByb3RvY29sIiwicmVxdWlyZWRGaWVsZHMiLCJsb2NhdGlvbl9maWVsZHMiLCJ0aGlzRmllbGQiLCJ1bmRlZmluZWQiLCJyZW5kZXIiLCJjb250ZW50IiwiY2VsbHMiLCJyZWR1Y2UiLCJjb25jYXQiLCJzcGlubmVyIiwiY3JlYXRlTmV3QnV0dG9uIiwib25DcmVhdGVSb29tQ2xpY2siLCJzY3JvbGxQYW5lbENvbnRlbnQiLCJmb290ZXIiLCJxdWVyeSIsIm9uRmlsbFJlcXVlc3QiLCJsaXN0SGVhZGVyIiwiaW5zdGFuY2VFeHBlY3RlZEZpZWxkVHlwZSIsImZpZWxkX3R5cGVzIiwibGFzdEZpZWxkIiwic2xpY2UiLCJwbGFjZWhvbGRlciIsImV4YW1wbGVSb29tIiwic2hvd0pvaW5CdXR0b24iLCJkcm9wZG93biIsIm9uT3B0aW9uQ2hhbmdlIiwib25GaWx0ZXJDaGFuZ2UiLCJvbkZpbHRlckNsZWFyIiwib25Kb2luRnJvbVNlYXJjaENsaWNrIiwiZXhwbGFuYXRpb24iLCJhIiwic3ViIiwiYWxpYXNlcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBaUJBOztBQUVBOztBQUdBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUVBOztBQUNBOzs7Ozs7Ozs7Ozs7QUFFQSxNQUFNQSxlQUFlLEdBQUcsRUFBeEI7QUFDQSxNQUFNQyxnQkFBZ0IsR0FBRyxHQUF6QjtBQUVBLE1BQU1DLGVBQWUsR0FBRywrQkFBeEI7QUFDQSxNQUFNQyxpQkFBaUIsR0FBRyxpQ0FBMUI7O0FBRUEsU0FBU0MsS0FBVCxDQUFlQyxNQUFmLEVBQStCO0FBQzNCQyxxQkFBVUMsVUFBVixDQUFxQixlQUFyQixFQUFzQ0YsTUFBdEM7QUFDSDs7SUFtQm9CRyxhLFdBRHBCLGdEQUFxQiwwQkFBckIsQyxnQkFBRCxNQUNxQkEsYUFEckIsU0FDMkNDLGVBQU1DLFNB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QUFXaUgsYUFBWCxJQUE0QixLQUFLakgsS0FBTCxDQUFXQztBQURmLEtBQXpDLENBRFEsR0FHTCx5QkFBRyxlQUFILENBSFQ7QUFJQSx3QkFDSSw2QkFBQyxtQkFBRDtBQUNJLE1BQUEsU0FBUyxFQUFDLHlCQURkO0FBRUksTUFBQSxTQUFTLEVBQUUsSUFGZjtBQUdJLE1BQUEsVUFBVSxFQUFFLEtBQUt5RSxVQUhyQjtBQUlJLE1BQUEsS0FBSyxFQUFFVjtBQUpYLG9CQU1JO0FBQUssTUFBQSxTQUFTLEVBQUM7QUFBZixPQUNNcUosV0FETixlQUVJO0FBQUssTUFBQSxTQUFTLEVBQUM7QUFBZixPQUNNYixVQUROLEVBRU1YLE9BRk4sQ0FGSixDQU5KLENBREo7QUFnQkg7O0FBaHZCc0UsQzs7O0FBbXZCM0U7QUFDQTtBQUNPLFNBQVN2RCxzQkFBVCxDQUFnQ3hHLElBQWhDLEVBQTZEO0FBQ2hFLFNBQU8sdUNBQTJCQSxJQUFJLENBQUNsQixlQUFoQyxFQUFpRGtCLElBQUksQ0FBQzBMLE9BQXRELENBQVA7QUFDSCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxOSBNaWNoYWVsIFRlbGF0eW5za2kgPDd0M2NoZ3V5QGdtYWlsLmNvbT5cbkNvcHlyaWdodCAyMDE1LCAyMDE2LCAyMDE5LCAyMDIwLCAyMDIxIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0IGZyb20gXCJyZWFjdFwiO1xuaW1wb3J0IHsgSUZpZWxkVHlwZSwgSUluc3RhbmNlLCBJUHJvdG9jb2wsIElQdWJsaWNSb29tc0NodW5rUm9vbSB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9jbGllbnRcIjtcbmltcG9ydCB7IFZpc2liaWxpdHkgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvQHR5cGVzL3BhcnRpYWxzXCI7XG5pbXBvcnQgeyBJUm9vbURpcmVjdG9yeU9wdGlvbnMgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvQHR5cGVzL3JlcXVlc3RzXCI7XG5cbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gXCIuLi8uLi9NYXRyaXhDbGllbnRQZWdcIjtcbmltcG9ydCBkaXMgZnJvbSBcIi4uLy4uL2Rpc3BhdGNoZXIvZGlzcGF0Y2hlclwiO1xuaW1wb3J0IE1vZGFsIGZyb20gXCIuLi8uLi9Nb2RhbFwiO1xuaW1wb3J0IHsgbGlua2lmeUFuZFNhbml0aXplSHRtbCB9IGZyb20gJy4uLy4uL0h0bWxVdGlscyc7XG5pbXBvcnQgeyBfdCB9IGZyb20gJy4uLy4uL2xhbmd1YWdlSGFuZGxlcic7XG5pbXBvcnQgU2RrQ29uZmlnIGZyb20gJy4uLy4uL1Nka0NvbmZpZyc7XG5pbXBvcnQgeyBpbnN0YW5jZUZvckluc3RhbmNlSWQsIHByb3RvY29sTmFtZUZvckluc3RhbmNlSWQgfSBmcm9tICcuLi8uLi91dGlscy9EaXJlY3RvcnlVdGlscyc7XG5pbXBvcnQgQW5hbHl0aWNzIGZyb20gJy4uLy4uL0FuYWx5dGljcyc7XG5pbXBvcnQgTmV0d29ya0Ryb3Bkb3duLCB7IEFMTF9ST09NUywgUHJvdG9jb2xzIH0gZnJvbSBcIi4uL3ZpZXdzL2RpcmVjdG9yeS9OZXR3b3JrRHJvcGRvd25cIjtcbmltcG9ydCBTZXR0aW5nc1N0b3JlIGZyb20gXCIuLi8uLi9zZXR0aW5ncy9TZXR0aW5nc1N0b3JlXCI7XG5pbXBvcnQgR3JvdXBGaWx0ZXJPcmRlclN0b3JlIGZyb20gXCIuLi8uLi9zdG9yZXMvR3JvdXBGaWx0ZXJPcmRlclN0b3JlXCI7XG5pbXBvcnQgR3JvdXBTdG9yZSBmcm9tIFwiLi4vLi4vc3RvcmVzL0dyb3VwU3RvcmVcIjtcbmltcG9ydCBGbGFpclN0b3JlIGZyb20gXCIuLi8uLi9zdG9yZXMvRmxhaXJTdG9yZVwiO1xuaW1wb3J0IENvdW50bHlBbmFseXRpY3MgZnJvbSBcIi4uLy4uL0NvdW50bHlBbmFseXRpY3NcIjtcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5pbXBvcnQgeyBtZWRpYUZyb21NeGMgfSBmcm9tIFwiLi4vLi4vY3VzdG9taXNhdGlvbnMvTWVkaWFcIjtcbmltcG9ydCB7IElEaWFsb2dQcm9wcyB9IGZyb20gXCIuLi92aWV3cy9kaWFsb2dzL0lEaWFsb2dQcm9wc1wiO1xuaW1wb3J0IEFjY2Vzc2libGVCdXR0b24sIHsgQnV0dG9uRXZlbnQgfSBmcm9tIFwiLi4vdmlld3MvZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvblwiO1xuaW1wb3J0IEJhc2VBdmF0YXIgZnJvbSBcIi4uL3ZpZXdzL2F2YXRhcnMvQmFzZUF2YXRhclwiO1xuaW1wb3J0IEVycm9yRGlhbG9nIGZyb20gXCIuLi92aWV3cy9kaWFsb2dzL0Vycm9yRGlhbG9nXCI7XG5pbXBvcnQgUXVlc3Rpb25EaWFsb2cgZnJvbSBcIi4uL3ZpZXdzL2RpYWxvZ3MvUXVlc3Rpb25EaWFsb2dcIjtcbmltcG9ydCBCYXNlRGlhbG9nIGZyb20gXCIuLi92aWV3cy9kaWFsb2dzL0Jhc2VEaWFsb2dcIjtcbmltcG9ydCBEaXJlY3RvcnlTZWFyY2hCb3ggZnJvbSBcIi4uL3ZpZXdzL2VsZW1lbnRzL0RpcmVjdG9yeVNlYXJjaEJveFwiO1xuaW1wb3J0IFNjcm9sbFBhbmVsIGZyb20gXCIuL1Njcm9sbFBhbmVsXCI7XG5pbXBvcnQgU3Bpbm5lciBmcm9tIFwiLi4vdmlld3MvZWxlbWVudHMvU3Bpbm5lclwiO1xuaW1wb3J0IHsgQWN0aW9uUGF5bG9hZCB9IGZyb20gXCIuLi8uLi9kaXNwYXRjaGVyL3BheWxvYWRzXCI7XG5pbXBvcnQgeyBnZXREaXNwbGF5QWxpYXNGb3JBbGlhc1NldCB9IGZyb20gXCIuLi8uLi9Sb29tc1wiO1xuXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbG9nZ2VyXCI7XG5pbXBvcnQgeyBBY3Rpb24gfSBmcm9tIFwiLi4vLi4vZGlzcGF0Y2hlci9hY3Rpb25zXCI7XG5cbmNvbnN0IE1BWF9OQU1FX0xFTkdUSCA9IDgwO1xuY29uc3QgTUFYX1RPUElDX0xFTkdUSCA9IDgwMDtcblxuY29uc3QgTEFTVF9TRVJWRVJfS0VZID0gXCJteF9sYXN0X3Jvb21fZGlyZWN0b3J5X3NlcnZlclwiO1xuY29uc3QgTEFTVF9JTlNUQU5DRV9LRVkgPSBcIm14X2xhc3Rfcm9vbV9kaXJlY3RvcnlfaW5zdGFuY2VcIjtcblxuZnVuY3Rpb24gdHJhY2soYWN0aW9uOiBzdHJpbmcpIHtcbiAgICBBbmFseXRpY3MudHJhY2tFdmVudCgnUm9vbURpcmVjdG9yeScsIGFjdGlvbik7XG59XG5cbmludGVyZmFjZSBJUHJvcHMgZXh0ZW5kcyBJRGlhbG9nUHJvcHMge1xuICAgIGluaXRpYWxUZXh0Pzogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBwdWJsaWNSb29tczogSVB1YmxpY1Jvb21zQ2h1bmtSb29tW107XG4gICAgbG9hZGluZzogYm9vbGVhbjtcbiAgICBwcm90b2NvbHNMb2FkaW5nOiBib29sZWFuO1xuICAgIGVycm9yPzogc3RyaW5nO1xuICAgIGluc3RhbmNlSWQ6IHN0cmluZztcbiAgICByb29tU2VydmVyOiBzdHJpbmc7XG4gICAgZmlsdGVyU3RyaW5nOiBzdHJpbmc7XG4gICAgc2VsZWN0ZWRDb21tdW5pdHlJZD86IHN0cmluZztcbiAgICBjb21tdW5pdHlOYW1lPzogc3RyaW5nO1xufVxuXG5AcmVwbGFjZWFibGVDb21wb25lbnQoXCJzdHJ1Y3R1cmVzLlJvb21EaXJlY3RvcnlcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJvb21EaXJlY3RvcnkgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8SVByb3BzLCBJU3RhdGU+IHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHN0YXJ0VGltZTogbnVtYmVyO1xuICAgIHByaXZhdGUgdW5tb3VudGVkID0gZmFsc2U7XG4gICAgcHJpdmF0ZSBuZXh0QmF0Y2g6IHN0cmluZyA9IG51bGw7XG4gICAgcHJpdmF0ZSBmaWx0ZXJUaW1lb3V0OiBudW1iZXI7XG4gICAgcHJpdmF0ZSBwcm90b2NvbHM6IFByb3RvY29scztcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcblxuICAgICAgICBDb3VudGx5QW5hbHl0aWNzLmluc3RhbmNlLnRyYWNrUm9vbURpcmVjdG9yeUJlZ2luKCk7XG4gICAgICAgIHRoaXMuc3RhcnRUaW1lID0gQ291bnRseUFuYWx5dGljcy5nZXRUaW1lc3RhbXAoKTtcblxuICAgICAgICBjb25zdCBzZWxlY3RlZENvbW11bml0eUlkID0gU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcImZlYXR1cmVfY29tbXVuaXRpZXNfdjJfcHJvdG90eXBlc1wiKVxuICAgICAgICAgICAgPyBHcm91cEZpbHRlck9yZGVyU3RvcmUuZ2V0U2VsZWN0ZWRUYWdzKClbMF1cbiAgICAgICAgICAgIDogbnVsbDtcblxuICAgICAgICBsZXQgcHJvdG9jb2xzTG9hZGluZyA9IHRydWU7XG4gICAgICAgIGlmICghTWF0cml4Q2xpZW50UGVnLmdldCgpKSB7XG4gICAgICAgICAgICAvLyBXZSBtYXkgbm90IGhhdmUgYSBjbGllbnQgeWV0IHdoZW4gaW52b2tlZCBmcm9tIHdlbGNvbWUgcGFnZVxuICAgICAgICAgICAgcHJvdG9jb2xzTG9hZGluZyA9IGZhbHNlO1xuICAgICAgICB9IGVsc2UgaWYgKCFzZWxlY3RlZENvbW11bml0eUlkKSB7XG4gICAgICAgICAgICBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZ2V0VGhpcmRwYXJ0eVByb3RvY29scygpLnRoZW4oKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5wcm90b2NvbHMgPSByZXNwb25zZTtcbiAgICAgICAgICAgICAgICBjb25zdCBteUhvbWVzZXJ2ZXIgPSBNYXRyaXhDbGllbnRQZWcuZ2V0SG9tZXNlcnZlck5hbWUoKTtcbiAgICAgICAgICAgICAgICBjb25zdCBsc1Jvb21TZXJ2ZXIgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShMQVNUX1NFUlZFUl9LRVkpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGxzSW5zdGFuY2VJZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKExBU1RfSU5TVEFOQ0VfS0VZKTtcblxuICAgICAgICAgICAgICAgIGxldCByb29tU2VydmVyID0gbXlIb21lc2VydmVyO1xuICAgICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAgICAgU2RrQ29uZmlnLmdldCgpLnJvb21EaXJlY3Rvcnk/LnNlcnZlcnM/LmluY2x1ZGVzKGxzUm9vbVNlcnZlcikgfHxcbiAgICAgICAgICAgICAgICAgICAgU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcInJvb21fZGlyZWN0b3J5X3NlcnZlcnNcIik/LmluY2x1ZGVzKGxzUm9vbVNlcnZlcilcbiAgICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICAgICAgcm9vbVNlcnZlciA9IGxzUm9vbVNlcnZlcjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBsZXQgaW5zdGFuY2VJZDogc3RyaW5nID0gbnVsbDtcbiAgICAgICAgICAgICAgICBpZiAocm9vbVNlcnZlciA9PT0gbXlIb21lc2VydmVyICYmIChcbiAgICAgICAgICAgICAgICAgICAgbHNJbnN0YW5jZUlkID09PSBBTExfUk9PTVMgfHxcbiAgICAgICAgICAgICAgICAgICAgT2JqZWN0LnZhbHVlcyh0aGlzLnByb3RvY29scykuc29tZShwID0+IHAuaW5zdGFuY2VzLnNvbWUoaSA9PiBpLmluc3RhbmNlX2lkID09PSBsc0luc3RhbmNlSWQpKVxuICAgICAgICAgICAgICAgICkpIHtcbiAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2VJZCA9IGxzSW5zdGFuY2VJZDtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvLyBSZWZyZXNoIHRoZSByb29tIGxpc3Qgb25seSBpZiB2YWxpZGF0aW9uIGZhaWxlZCBhbmQgd2UgaGFkIHRvIGNoYW5nZSB0aGVzZVxuICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlLmluc3RhbmNlSWQgIT09IGluc3RhbmNlSWQgfHwgdGhpcy5zdGF0ZS5yb29tU2VydmVyICE9PSByb29tU2VydmVyKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvdG9jb2xzTG9hZGluZzogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZUlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgcm9vbVNlcnZlcixcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVmcmVzaFJvb21MaXN0KCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IHByb3RvY29sc0xvYWRpbmc6IGZhbHNlIH0pO1xuICAgICAgICAgICAgfSwgKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuKGBlcnJvciBsb2FkaW5nIHRoaXJkIHBhcnR5IHByb3RvY29sczogJHtlcnJ9YCk7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IHByb3RvY29sc0xvYWRpbmc6IGZhbHNlIH0pO1xuICAgICAgICAgICAgICAgIGlmIChNYXRyaXhDbGllbnRQZWcuZ2V0KCkuaXNHdWVzdCgpKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIEd1ZXN0cyBjdXJyZW50bHkgYXJlbid0IGFsbG93ZWQgdG8gdXNlIHRoaXMgQVBJLCBzb1xuICAgICAgICAgICAgICAgICAgICAvLyBpZ25vcmUgdGhpcyBhcyBvdGhlcndpc2UgdGhpcyBlcnJvciBpcyBsaXRlcmFsbHkgdGhlXG4gICAgICAgICAgICAgICAgICAgIC8vIHRoaW5nIHlvdSBzZWUgd2hlbiBsb2FkaW5nIHRoZSBjbGllbnQhXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdHJhY2soJ0ZhaWxlZCB0byBnZXQgcHJvdG9jb2wgbGlzdCBmcm9tIGhvbWVzZXJ2ZXInKTtcbiAgICAgICAgICAgICAgICBjb25zdCBicmFuZCA9IFNka0NvbmZpZy5nZXQoKS5icmFuZDtcbiAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IF90KFxuICAgICAgICAgICAgICAgICAgICAgICAgJyUoYnJhbmQpcyBmYWlsZWQgdG8gZ2V0IHRoZSBwcm90b2NvbCBsaXN0IGZyb20gdGhlIGhvbWVzZXJ2ZXIuICcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJ1RoZSBob21lc2VydmVyIG1heSBiZSB0b28gb2xkIHRvIHN1cHBvcnQgdGhpcmQgcGFydHkgbmV0d29ya3MuJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHsgYnJhbmQgfSxcbiAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gV2UgZG9uJ3QgdXNlIHRoZSBwcm90b2NvbHMgaW4gdGhlIGNvbW11bml0aWVzIHYyIHByb3RvdHlwZSBleHBlcmllbmNlXG4gICAgICAgICAgICBwcm90b2NvbHNMb2FkaW5nID0gZmFsc2U7XG5cbiAgICAgICAgICAgIC8vIEdyYWIgdGhlIHByb2ZpbGUgaW5mbyBhc3luY1xuICAgICAgICAgICAgRmxhaXJTdG9yZS5nZXRHcm91cFByb2ZpbGVDYWNoZWQoTWF0cml4Q2xpZW50UGVnLmdldCgpLCB0aGlzLnN0YXRlLnNlbGVjdGVkQ29tbXVuaXR5SWQpLnRoZW4ocHJvZmlsZSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGNvbW11bml0eU5hbWU6IHByb2ZpbGUubmFtZSB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIHB1YmxpY1Jvb21zOiBbXSxcbiAgICAgICAgICAgIGxvYWRpbmc6IHRydWUsXG4gICAgICAgICAgICBlcnJvcjogbnVsbCxcbiAgICAgICAgICAgIGluc3RhbmNlSWQ6IGxvY2FsU3RvcmFnZS5nZXRJdGVtKExBU1RfSU5TVEFOQ0VfS0VZKSxcbiAgICAgICAgICAgIHJvb21TZXJ2ZXI6IGxvY2FsU3RvcmFnZS5nZXRJdGVtKExBU1RfU0VSVkVSX0tFWSksXG4gICAgICAgICAgICBmaWx0ZXJTdHJpbmc6IHRoaXMucHJvcHMuaW5pdGlhbFRleHQgfHwgXCJcIixcbiAgICAgICAgICAgIHNlbGVjdGVkQ29tbXVuaXR5SWQsXG4gICAgICAgICAgICBjb21tdW5pdHlOYW1lOiBudWxsLFxuICAgICAgICAgICAgcHJvdG9jb2xzTG9hZGluZyxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICAgICAgdGhpcy5yZWZyZXNoUm9vbUxpc3QoKTtcbiAgICB9XG5cbiAgICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICAgICAgaWYgKHRoaXMuZmlsdGVyVGltZW91dCkge1xuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuZmlsdGVyVGltZW91dCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy51bm1vdW50ZWQgPSB0cnVlO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVmcmVzaFJvb21MaXN0ID0gKCkgPT4ge1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5zZWxlY3RlZENvbW11bml0eUlkKSB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICBwdWJsaWNSb29tczogR3JvdXBTdG9yZS5nZXRHcm91cFJvb21zKHRoaXMuc3RhdGUuc2VsZWN0ZWRDb21tdW5pdHlJZCkubWFwKHIgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gVHJhbnNsYXRlIGFsbCB0aGUgZ3JvdXAgcHJvcGVydGllcyB0byB0aGUgZGlyZWN0b3J5IGZvcm1hdFxuICAgICAgICAgICAgICAgICAgICAgICAgcm9vbV9pZDogci5yb29tSWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiByLm5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICB0b3BpYzogci50b3BpYyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbm9uaWNhbF9hbGlhczogci5jYW5vbmljYWxBbGlhcyxcbiAgICAgICAgICAgICAgICAgICAgICAgIG51bV9qb2luZWRfbWVtYmVyczogci5udW1Kb2luZWRNZW1iZXJzLFxuICAgICAgICAgICAgICAgICAgICAgICAgYXZhdGFyVXJsOiByLmF2YXRhclVybCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmxkX3JlYWRhYmxlOiByLndvcmxkUmVhZGFibGUsXG4gICAgICAgICAgICAgICAgICAgICAgICBndWVzdF9jYW5fam9pbjogci5ndWVzdHNDYW5Kb2luLFxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIH0pLmZpbHRlcihyID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmlsdGVyU3RyaW5nID0gdGhpcy5zdGF0ZS5maWx0ZXJTdHJpbmc7XG4gICAgICAgICAgICAgICAgICAgIGlmIChmaWx0ZXJTdHJpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lZEluID0gKHM6IHN0cmluZykgPT4gKHMgfHwgXCJcIikudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhmaWx0ZXJTdHJpbmcudG9Mb3dlckNhc2UoKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29udGFpbmVkSW4oci5uYW1lKSB8fCBjb250YWluZWRJbihyLnRvcGljKSB8fCBjb250YWluZWRJbihyLmNhbm9uaWNhbF9hbGlhcyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgbG9hZGluZzogZmFsc2UsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMubmV4dEJhdGNoID0gbnVsbDtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBwdWJsaWNSb29tczogW10sXG4gICAgICAgICAgICBsb2FkaW5nOiB0cnVlLFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5nZXRNb3JlUm9vbXMoKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBnZXRNb3JlUm9vbXMoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnNlbGVjdGVkQ29tbXVuaXR5SWQpIHJldHVybiBQcm9taXNlLnJlc29sdmUoZmFsc2UpOyAvLyBubyBtb3JlIHJvb21zXG4gICAgICAgIGlmICghTWF0cml4Q2xpZW50UGVnLmdldCgpKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGZhbHNlKTtcblxuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIGxvYWRpbmc6IHRydWUsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGZpbHRlclN0cmluZyA9IHRoaXMuc3RhdGUuZmlsdGVyU3RyaW5nO1xuICAgICAgICBjb25zdCByb29tU2VydmVyID0gdGhpcy5zdGF0ZS5yb29tU2VydmVyO1xuICAgICAgICAvLyByZW1lbWJlciB0aGUgbmV4dCBiYXRjaCB0b2tlbiB3aGVuIHdlIHNlbnQgdGhlIHJlcXVlc3RcbiAgICAgICAgLy8gdG9vLiBJZiBpdCdzIGNoYW5nZWQsIGFwcGVuZGluZyB0byB0aGUgbGlzdCB3aWxsIGNvcnJ1cHQgaXQuXG4gICAgICAgIGNvbnN0IG5leHRCYXRjaCA9IHRoaXMubmV4dEJhdGNoO1xuICAgICAgICBjb25zdCBvcHRzOiBJUm9vbURpcmVjdG9yeU9wdGlvbnMgPSB7IGxpbWl0OiAyMCB9O1xuICAgICAgICBpZiAocm9vbVNlcnZlciAhPSBNYXRyaXhDbGllbnRQZWcuZ2V0SG9tZXNlcnZlck5hbWUoKSkge1xuICAgICAgICAgICAgb3B0cy5zZXJ2ZXIgPSByb29tU2VydmVyO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLmluc3RhbmNlSWQgPT09IEFMTF9ST09NUykge1xuICAgICAgICAgICAgb3B0cy5pbmNsdWRlX2FsbF9uZXR3b3JrcyA9IHRydWU7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5zdGF0ZS5pbnN0YW5jZUlkKSB7XG4gICAgICAgICAgICBvcHRzLnRoaXJkX3BhcnR5X2luc3RhbmNlX2lkID0gdGhpcy5zdGF0ZS5pbnN0YW5jZUlkIGFzIHN0cmluZztcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5uZXh0QmF0Y2gpIG9wdHMuc2luY2UgPSB0aGlzLm5leHRCYXRjaDtcbiAgICAgICAgaWYgKGZpbHRlclN0cmluZykgb3B0cy5maWx0ZXIgPSB7IGdlbmVyaWNfc2VhcmNoX3Rlcm06IGZpbHRlclN0cmluZyB9O1xuICAgICAgICByZXR1cm4gTWF0cml4Q2xpZW50UGVnLmdldCgpLnB1YmxpY1Jvb21zKG9wdHMpLnRoZW4oKGRhdGEpID0+IHtcbiAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICBmaWx0ZXJTdHJpbmcgIT0gdGhpcy5zdGF0ZS5maWx0ZXJTdHJpbmcgfHxcbiAgICAgICAgICAgICAgICByb29tU2VydmVyICE9IHRoaXMuc3RhdGUucm9vbVNlcnZlciB8fFxuICAgICAgICAgICAgICAgIG5leHRCYXRjaCAhPSB0aGlzLm5leHRCYXRjaCkge1xuICAgICAgICAgICAgICAgIC8vIGlmIHRoZSBmaWx0ZXIgb3Igc2VydmVyIGhhcyBjaGFuZ2VkIHNpbmNlIHRoaXMgcmVxdWVzdCB3YXMgc2VudCxcbiAgICAgICAgICAgICAgICAvLyB0aHJvdyBhd2F5IHRoZSByZXN1bHQgKGRvbid0IGV2ZW4gY2xlYXIgdGhlIGJ1c3kgZmxhZ1xuICAgICAgICAgICAgICAgIC8vIHNpbmNlIHdlIG11c3Qgc3RpbGwgaGF2ZSBhIHJlcXVlc3QgaW4gZmxpZ2h0KVxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHRoaXMudW5tb3VudGVkKSB7XG4gICAgICAgICAgICAgICAgLy8gaWYgd2UndmUgYmVlbiB1bm1vdW50ZWQsIHdlIGRvbid0IGNhcmUgZWl0aGVyLlxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUuZmlsdGVyU3RyaW5nKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY291bnQgPSBkYXRhLnRvdGFsX3Jvb21fY291bnRfZXN0aW1hdGUgfHwgZGF0YS5jaHVuay5sZW5ndGg7XG4gICAgICAgICAgICAgICAgQ291bnRseUFuYWx5dGljcy5pbnN0YW5jZS50cmFja1Jvb21EaXJlY3RvcnlTZWFyY2goY291bnQsIHRoaXMuc3RhdGUuZmlsdGVyU3RyaW5nKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5uZXh0QmF0Y2ggPSBkYXRhLm5leHRfYmF0Y2g7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKChzKSA9PiAoe1xuICAgICAgICAgICAgICAgIC4uLnMsXG4gICAgICAgICAgICAgICAgcHVibGljUm9vbXM6IFsuLi5zLnB1YmxpY1Jvb21zLCAuLi4oZGF0YS5jaHVuayB8fCBbXSldLFxuICAgICAgICAgICAgICAgIGxvYWRpbmc6IGZhbHNlLFxuICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgcmV0dXJuIEJvb2xlYW4oZGF0YS5uZXh0X2JhdGNoKTtcbiAgICAgICAgfSwgKGVycikgPT4ge1xuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgIGZpbHRlclN0cmluZyAhPSB0aGlzLnN0YXRlLmZpbHRlclN0cmluZyB8fFxuICAgICAgICAgICAgICAgIHJvb21TZXJ2ZXIgIT0gdGhpcy5zdGF0ZS5yb29tU2VydmVyIHx8XG4gICAgICAgICAgICAgICAgbmV4dEJhdGNoICE9IHRoaXMubmV4dEJhdGNoKSB7XG4gICAgICAgICAgICAgICAgLy8gYXMgYWJvdmU6IHdlIGRvbid0IGNhcmUgYWJvdXQgZXJyb3JzIGZvciBvbGQgcmVxdWVzdHMgZWl0aGVyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAodGhpcy51bm1vdW50ZWQpIHtcbiAgICAgICAgICAgICAgICAvLyBpZiB3ZSd2ZSBiZWVuIHVubW91bnRlZCwgd2UgZG9uJ3QgY2FyZSBlaXRoZXIuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoXCJGYWlsZWQgdG8gZ2V0IHB1YmxpY1Jvb21zOiAlc1wiLCBKU09OLnN0cmluZ2lmeShlcnIpKTtcbiAgICAgICAgICAgIHRyYWNrKCdGYWlsZWQgdG8gZ2V0IHB1YmxpYyByb29tIGxpc3QnKTtcbiAgICAgICAgICAgIGNvbnN0IGJyYW5kID0gU2RrQ29uZmlnLmdldCgpLmJyYW5kO1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgbG9hZGluZzogZmFsc2UsXG4gICAgICAgICAgICAgICAgZXJyb3I6IChcbiAgICAgICAgICAgICAgICAgICAgX3QoJyUoYnJhbmQpcyBmYWlsZWQgdG8gZ2V0IHRoZSBwdWJsaWMgcm9vbSBsaXN0LicsIHsgYnJhbmQgfSkgK1xuICAgICAgICAgICAgICAgICAgICAoZXJyICYmIGVyci5tZXNzYWdlKSA/IGVyci5tZXNzYWdlIDogX3QoJ1RoZSBob21lc2VydmVyIG1heSBiZSB1bmF2YWlsYWJsZSBvciBvdmVybG9hZGVkLicpXG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBIGxpbWl0ZWQgaW50ZXJmYWNlIGZvciByZW1vdmluZyByb29tcyBmcm9tIHRoZSBkaXJlY3RvcnkuXG4gICAgICogV2lsbCBzZXQgdGhlIHJvb20gdG8gbm90IGJlIHB1YmxpY2x5IHZpc2libGUgYW5kIGRlbGV0ZSB0aGVcbiAgICAgKiBkZWZhdWx0IGFsaWFzLiBJbiB0aGUgbG9uZyB0ZXJtLCBpdCB3b3VsZCBiZSBiZXR0ZXIgdG8gYWxsb3dcbiAgICAgKiBIUyBhZG1pbnMgdG8gZG8gdGhpcyB0aHJvdWdoIHRoZSBSb29tU2V0dGluZ3MgaW50ZXJmYWNlLCBidXRcbiAgICAgKiB0aGlzIG5lZWRzIFNQRUMtNDE3LlxuICAgICAqL1xuICAgIHByaXZhdGUgcmVtb3ZlRnJvbURpcmVjdG9yeShyb29tOiBJUHVibGljUm9vbXNDaHVua1Jvb20pIHtcbiAgICAgICAgY29uc3QgYWxpYXMgPSBnZXREaXNwbGF5QWxpYXNGb3JSb29tKHJvb20pO1xuICAgICAgICBjb25zdCBuYW1lID0gcm9vbS5uYW1lIHx8IGFsaWFzIHx8IF90KCdVbm5hbWVkIHJvb20nKTtcblxuICAgICAgICBsZXQgZGVzYztcbiAgICAgICAgaWYgKGFsaWFzKSB7XG4gICAgICAgICAgICBkZXNjID0gX3QoJ0RlbGV0ZSB0aGUgcm9vbSBhZGRyZXNzICUoYWxpYXMpcyBhbmQgcmVtb3ZlICUobmFtZSlzIGZyb20gdGhlIGRpcmVjdG9yeT8nLCB7IGFsaWFzLCBuYW1lIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZGVzYyA9IF90KCdSZW1vdmUgJShuYW1lKXMgZnJvbSB0aGUgZGlyZWN0b3J5PycsIHsgbmFtZTogbmFtZSB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coJ1JlbW92ZSBmcm9tIERpcmVjdG9yeScsICcnLCBRdWVzdGlvbkRpYWxvZywge1xuICAgICAgICAgICAgdGl0bGU6IF90KCdSZW1vdmUgZnJvbSBEaXJlY3RvcnknKSxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBkZXNjLFxuICAgICAgICAgICAgb25GaW5pc2hlZDogKHNob3VsZERlbGV0ZTogYm9vbGVhbikgPT4ge1xuICAgICAgICAgICAgICAgIGlmICghc2hvdWxkRGVsZXRlKSByZXR1cm47XG5cbiAgICAgICAgICAgICAgICBjb25zdCBtb2RhbCA9IE1vZGFsLmNyZWF0ZURpYWxvZyhTcGlubmVyKTtcbiAgICAgICAgICAgICAgICBsZXQgc3RlcCA9IF90KCdyZW1vdmUgJShuYW1lKXMgZnJvbSB0aGUgZGlyZWN0b3J5LicsIHsgbmFtZTogbmFtZSB9KTtcblxuICAgICAgICAgICAgICAgIE1hdHJpeENsaWVudFBlZy5nZXQoKS5zZXRSb29tRGlyZWN0b3J5VmlzaWJpbGl0eShyb29tLnJvb21faWQsIFZpc2liaWxpdHkuUHJpdmF0ZSkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghYWxpYXMpIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgc3RlcCA9IF90KCdkZWxldGUgdGhlIGFkZHJlc3MuJyk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZGVsZXRlQWxpYXMoYWxpYXMpO1xuICAgICAgICAgICAgICAgIH0pLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBtb2RhbC5jbG9zZSgpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlZnJlc2hSb29tTGlzdCgpO1xuICAgICAgICAgICAgICAgIH0sIChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbW9kYWwuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWZyZXNoUm9vbUxpc3QoKTtcbiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKFwiRmFpbGVkIHRvIFwiICsgc3RlcCArIFwiOiBcIiArIGVycik7XG4gICAgICAgICAgICAgICAgICAgIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coJ1JlbW92ZSBmcm9tIERpcmVjdG9yeSBFcnJvcicsICcnLCBFcnJvckRpYWxvZywge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGU6IF90KCdFcnJvcicpLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IChlcnIgJiYgZXJyLm1lc3NhZ2UpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBlcnIubWVzc2FnZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogX3QoJ1RoZSBzZXJ2ZXIgbWF5IGJlIHVuYXZhaWxhYmxlIG9yIG92ZXJsb2FkZWQnKSxcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uUm9vbUNsaWNrZWQgPSAocm9vbTogSVB1YmxpY1Jvb21zQ2h1bmtSb29tLCBldjogUmVhY3QuTW91c2VFdmVudCkgPT4ge1xuICAgICAgICAvLyBJZiByb29tIHdhcyBzaGlmdC1jbGlja2VkLCByZW1vdmUgaXQgZnJvbSB0aGUgcm9vbSBkaXJlY3RvcnlcbiAgICAgICAgaWYgKGV2LnNoaWZ0S2V5ICYmICF0aGlzLnN0YXRlLnNlbGVjdGVkQ29tbXVuaXR5SWQpIHtcbiAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICB0aGlzLnJlbW92ZUZyb21EaXJlY3Rvcnkocm9vbSk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbk9wdGlvbkNoYW5nZSA9IChzZXJ2ZXI6IHN0cmluZywgaW5zdGFuY2VJZD86IHN0cmluZykgPT4ge1xuICAgICAgICAvLyBjbGVhciBuZXh0IGJhdGNoIHNvIHdlIGRvbid0IHRyeSB0byBsb2FkIG1vcmUgcm9vbXNcbiAgICAgICAgdGhpcy5uZXh0QmF0Y2ggPSBudWxsO1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIC8vIENsZWFyIHRoZSBwdWJsaWMgcm9vbXMgb3V0IGhlcmUgb3RoZXJ3aXNlIHdlIG5lZWRsZXNzbHlcbiAgICAgICAgICAgIC8vIHNwZW5kIHRpbWUgZmlsdGVyaW5nIGxvdHMgb2Ygcm9vbXMgd2hlbiB3ZSdyZSBhYm91dCB0b1xuICAgICAgICAgICAgLy8gdG8gY2xlYXIgdGhlIGxpc3QgYW55d2F5LlxuICAgICAgICAgICAgcHVibGljUm9vbXM6IFtdLFxuICAgICAgICAgICAgcm9vbVNlcnZlcjogc2VydmVyLFxuICAgICAgICAgICAgaW5zdGFuY2VJZDogaW5zdGFuY2VJZCxcbiAgICAgICAgICAgIGVycm9yOiBudWxsLFxuICAgICAgICB9LCB0aGlzLnJlZnJlc2hSb29tTGlzdCk7XG4gICAgICAgIC8vIFdlIGFsc28gcmVmcmVzaCB0aGUgcm9vbSBsaXN0IGVhY2ggdGltZSBldmVuIHRob3VnaCB0aGlzXG4gICAgICAgIC8vIGZpbHRlcmluZyBpcyBjbGllbnQtc2lkZS4gSXQgaG9wZWZ1bGx5IHdvbid0IGJlIGNsaWVudCBzaWRlXG4gICAgICAgIC8vIGZvciB2ZXJ5IGxvbmcsIGFuZCB3ZSBtYXkgaGF2ZSBmZXRjaGVkIGEgdGhvdXNhbmQgcm9vbXMgdG9cbiAgICAgICAgLy8gZmluZCB0aGUgZml2ZSBnaXR0ZXIgb25lcywgYXQgd2hpY2ggcG9pbnQgd2UgZG8gbm90IHdhbnRcbiAgICAgICAgLy8gdG8gcmVuZGVyIGFsbCB0aG9zZSByb29tcyB3aGVuIHN3aXRjaGluZyBiYWNrIHRvICdhbGwgbmV0d29ya3MnLlxuICAgICAgICAvLyBFYXNpZXN0IHRvIGp1c3QgYmxvdyBhd2F5IHRoZSBzdGF0ZSAmIHJlLWZldGNoLlxuXG4gICAgICAgIC8vIFdlIGhhdmUgdG8gYmUgY2FyZWZ1bCBoZXJlIHNvIHRoYXQgd2UgZG9uJ3Qgc2V0IGluc3RhbmNlSWQgPSBcInVuZGVmaW5lZFwiXG4gICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKExBU1RfU0VSVkVSX0tFWSwgc2VydmVyKTtcbiAgICAgICAgaWYgKGluc3RhbmNlSWQpIHtcbiAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKExBU1RfSU5TVEFOQ0VfS0VZLCBpbnN0YW5jZUlkKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKExBU1RfSU5TVEFOQ0VfS0VZKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwcml2YXRlIG9uRmlsbFJlcXVlc3QgPSAoYmFja3dhcmRzOiBib29sZWFuKSA9PiB7XG4gICAgICAgIGlmIChiYWNrd2FyZHMgfHwgIXRoaXMubmV4dEJhdGNoKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGZhbHNlKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5nZXRNb3JlUm9vbXMoKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkZpbHRlckNoYW5nZSA9IChhbGlhczogc3RyaW5nKSA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgZmlsdGVyU3RyaW5nOiBhbGlhcyB8fCBcIlwiLFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBkb24ndCBzZW5kIHRoZSByZXF1ZXN0IGZvciBhIGxpdHRsZSBiaXQsXG4gICAgICAgIC8vIG5vIHBvaW50IGhhbW1lcmluZyB0aGUgc2VydmVyIHdpdGggYVxuICAgICAgICAvLyByZXF1ZXN0IGZvciBldmVyeSBrZXlzdHJva2UsIGxldCB0aGVcbiAgICAgICAgLy8gdXNlciBmaW5pc2ggdHlwaW5nLlxuICAgICAgICBpZiAodGhpcy5maWx0ZXJUaW1lb3V0KSB7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5maWx0ZXJUaW1lb3V0KTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmZpbHRlclRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZmlsdGVyVGltZW91dCA9IG51bGw7XG4gICAgICAgICAgICB0aGlzLnJlZnJlc2hSb29tTGlzdCgpO1xuICAgICAgICB9LCA3MDApO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uRmlsdGVyQ2xlYXIgPSAoKSA9PiB7XG4gICAgICAgIC8vIHVwZGF0ZSBpbW1lZGlhdGVseVxuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIGZpbHRlclN0cmluZzogXCJcIixcbiAgICAgICAgfSwgdGhpcy5yZWZyZXNoUm9vbUxpc3QpO1xuXG4gICAgICAgIGlmICh0aGlzLmZpbHRlclRpbWVvdXQpIHtcbiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmZpbHRlclRpbWVvdXQpO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25Kb2luRnJvbVNlYXJjaENsaWNrID0gKGFsaWFzOiBzdHJpbmcpID0+IHtcbiAgICAgICAgLy8gSWYgd2UgZG9uJ3QgaGF2ZSBhIHBhcnRpY3VsYXIgaW5zdGFuY2UgaWQgc2VsZWN0ZWQsIGp1c3Qgc2hvdyB0aGF0IHJvb21zIGFsaWFzXG4gICAgICAgIGlmICghdGhpcy5zdGF0ZS5pbnN0YW5jZUlkIHx8IHRoaXMuc3RhdGUuaW5zdGFuY2VJZCA9PT0gQUxMX1JPT01TKSB7XG4gICAgICAgICAgICAvLyBJZiB0aGUgdXNlciBzcGVjaWZpZWQgYW4gYWxpYXMgd2l0aG91dCBhIGRvbWFpbiwgYWRkIG9uIHdoaWNoZXZlciBzZXJ2ZXIgaXMgc2VsZWN0ZWRcbiAgICAgICAgICAgIC8vIGluIHRoZSBkcm9wZG93blxuICAgICAgICAgICAgaWYgKGFsaWFzLmluZGV4T2YoJzonKSA9PSAtMSkge1xuICAgICAgICAgICAgICAgIGFsaWFzID0gYWxpYXMgKyAnOicgKyB0aGlzLnN0YXRlLnJvb21TZXJ2ZXI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnNob3dSb29tQWxpYXMoYWxpYXMsIHRydWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gVGhpcyBpcyBhIDNyZCBwYXJ0eSBwcm90b2NvbC4gTGV0J3Mgc2VlIGlmIHdlIGNhbiBqb2luIGl0XG4gICAgICAgICAgICBjb25zdCBwcm90b2NvbE5hbWUgPSBwcm90b2NvbE5hbWVGb3JJbnN0YW5jZUlkKHRoaXMucHJvdG9jb2xzLCB0aGlzLnN0YXRlLmluc3RhbmNlSWQpO1xuICAgICAgICAgICAgY29uc3QgaW5zdGFuY2UgPSBpbnN0YW5jZUZvckluc3RhbmNlSWQodGhpcy5wcm90b2NvbHMsIHRoaXMuc3RhdGUuaW5zdGFuY2VJZCk7XG4gICAgICAgICAgICBjb25zdCBmaWVsZHMgPSBwcm90b2NvbE5hbWVcbiAgICAgICAgICAgICAgICA/IHRoaXMuZ2V0RmllbGRzRm9yVGhpcmRQYXJ0eUxvY2F0aW9uKGFsaWFzLCB0aGlzLnByb3RvY29sc1twcm90b2NvbE5hbWVdLCBpbnN0YW5jZSlcbiAgICAgICAgICAgICAgICA6IG51bGw7XG4gICAgICAgICAgICBpZiAoIWZpZWxkcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGJyYW5kID0gU2RrQ29uZmlnLmdldCgpLmJyYW5kO1xuICAgICAgICAgICAgICAgIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coJ1VuYWJsZSB0byBqb2luIG5ldHdvcmsnLCAnJywgRXJyb3JEaWFsb2csIHtcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6IF90KCdVbmFibGUgdG8gam9pbiBuZXR3b3JrJyksXG4gICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBfdCgnJShicmFuZClzIGRvZXMgbm90IGtub3cgaG93IHRvIGpvaW4gYSByb29tIG9uIHRoaXMgbmV0d29yaycsIHsgYnJhbmQgfSksXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgTWF0cml4Q2xpZW50UGVnLmdldCgpLmdldFRoaXJkcGFydHlMb2NhdGlvbihwcm90b2NvbE5hbWUsIGZpZWxkcykudGhlbigocmVzcCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChyZXNwLmxlbmd0aCA+IDAgJiYgcmVzcFswXS5hbGlhcykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dSb29tQWxpYXMocmVzcFswXS5hbGlhcywgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZygnUm9vbSBub3QgZm91bmQnLCAnJywgRXJyb3JEaWFsb2csIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOiBfdCgnUm9vbSBub3QgZm91bmQnKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBfdCgnQ291bGRuXFwndCBmaW5kIGEgbWF0Y2hpbmcgTWF0cml4IHJvb20nKSxcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSwgKGUpID0+IHtcbiAgICAgICAgICAgICAgICBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nKCdGZXRjaGluZyB0aGlyZCBwYXJ0eSBsb2NhdGlvbiBmYWlsZWQnLCAnJywgRXJyb3JEaWFsb2csIHtcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6IF90KCdGZXRjaGluZyB0aGlyZCBwYXJ0eSBsb2NhdGlvbiBmYWlsZWQnKSxcbiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IF90KCdVbmFibGUgdG8gbG9vayB1cCByb29tIElEIGZyb20gc2VydmVyJyksXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwcml2YXRlIG9uUHJldmlld0NsaWNrID0gKGV2OiBCdXR0b25FdmVudCwgcm9vbTogSVB1YmxpY1Jvb21zQ2h1bmtSb29tKSA9PiB7XG4gICAgICAgIHRoaXMuc2hvd1Jvb20ocm9vbSwgbnVsbCwgZmFsc2UsIHRydWUpO1xuICAgICAgICBldi5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvblZpZXdDbGljayA9IChldjogQnV0dG9uRXZlbnQsIHJvb206IElQdWJsaWNSb29tc0NodW5rUm9vbSkgPT4ge1xuICAgICAgICB0aGlzLnNob3dSb29tKHJvb20pO1xuICAgICAgICBldi5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkpvaW5DbGljayA9IChldjogQnV0dG9uRXZlbnQsIHJvb206IElQdWJsaWNSb29tc0NodW5rUm9vbSkgPT4ge1xuICAgICAgICB0aGlzLnNob3dSb29tKHJvb20sIG51bGwsIHRydWUpO1xuICAgICAgICBldi5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkNyZWF0ZVJvb21DbGljayA9ICgpID0+IHtcbiAgICAgICAgdGhpcy5vbkZpbmlzaGVkKCk7XG4gICAgICAgIGRpcy5kaXNwYXRjaCh7XG4gICAgICAgICAgICBhY3Rpb246ICd2aWV3X2NyZWF0ZV9yb29tJyxcbiAgICAgICAgICAgIHB1YmxpYzogdHJ1ZSxcbiAgICAgICAgICAgIGRlZmF1bHROYW1lOiB0aGlzLnN0YXRlLmZpbHRlclN0cmluZy50cmltKCksXG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIHNob3dSb29tQWxpYXMoYWxpYXM6IHN0cmluZywgYXV0b0pvaW4gPSBmYWxzZSkge1xuICAgICAgICB0aGlzLnNob3dSb29tKG51bGwsIGFsaWFzLCBhdXRvSm9pbik7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzaG93Um9vbShyb29tOiBJUHVibGljUm9vbXNDaHVua1Jvb20sIHJvb21BbGlhcz86IHN0cmluZywgYXV0b0pvaW4gPSBmYWxzZSwgc2hvdWxkUGVlayA9IGZhbHNlKSB7XG4gICAgICAgIHRoaXMub25GaW5pc2hlZCgpO1xuICAgICAgICBjb25zdCBwYXlsb2FkOiBBY3Rpb25QYXlsb2FkID0ge1xuICAgICAgICAgICAgYWN0aW9uOiBBY3Rpb24uVmlld1Jvb20sXG4gICAgICAgICAgICBhdXRvX2pvaW46IGF1dG9Kb2luLFxuICAgICAgICAgICAgc2hvdWxkX3BlZWs6IHNob3VsZFBlZWssXG4gICAgICAgICAgICBfdHlwZTogXCJyb29tX2RpcmVjdG9yeVwiLCAvLyBpbnN0cnVtZW50YXRpb25cbiAgICAgICAgfTtcbiAgICAgICAgaWYgKHJvb20pIHtcbiAgICAgICAgICAgIC8vIERvbid0IGxldCB0aGUgdXNlciB2aWV3IGEgcm9vbSB0aGV5IHdvbid0IGJlIGFibGUgdG8gZWl0aGVyXG4gICAgICAgICAgICAvLyBwZWVrIG9yIGpvaW46IGZhaWwgZWFybGllciBzbyB0aGV5IGRvbid0IGhhdmUgdG8gY2xpY2sgYmFja1xuICAgICAgICAgICAgLy8gdG8gdGhlIGRpcmVjdG9yeS5cbiAgICAgICAgICAgIGlmIChNYXRyaXhDbGllbnRQZWcuZ2V0KCkuaXNHdWVzdCgpKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFyb29tLndvcmxkX3JlYWRhYmxlICYmICFyb29tLmd1ZXN0X2Nhbl9qb2luKSB7XG4gICAgICAgICAgICAgICAgICAgIGRpcy5kaXNwYXRjaCh7IGFjdGlvbjogJ3JlcXVpcmVfcmVnaXN0cmF0aW9uJyB9KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFyb29tQWxpYXMpIHtcbiAgICAgICAgICAgICAgICByb29tQWxpYXMgPSBnZXREaXNwbGF5QWxpYXNGb3JSb29tKHJvb20pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBwYXlsb2FkLm9vYl9kYXRhID0ge1xuICAgICAgICAgICAgICAgIGF2YXRhclVybDogcm9vbS5hdmF0YXJfdXJsLFxuICAgICAgICAgICAgICAgIC8vIFhYWDogVGhpcyBsb2dpYyBpcyBkdXBsaWNhdGVkIGZyb20gdGhlIEpTIFNESyB3aGljaFxuICAgICAgICAgICAgICAgIC8vIHdvdWxkIG5vcm1hbGx5IGRlY2lkZSB3aGF0IHRoZSBuYW1lIGlzLlxuICAgICAgICAgICAgICAgIG5hbWU6IHJvb20ubmFtZSB8fCByb29tQWxpYXMgfHwgX3QoJ1VubmFtZWQgcm9vbScpLFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUucm9vbVNlcnZlcikge1xuICAgICAgICAgICAgICAgIHBheWxvYWQudmlhX3NlcnZlcnMgPSBbdGhpcy5zdGF0ZS5yb29tU2VydmVyXTtcbiAgICAgICAgICAgICAgICBwYXlsb2FkLm9wdHMgPSB7XG4gICAgICAgICAgICAgICAgICAgIHZpYVNlcnZlcnM6IFt0aGlzLnN0YXRlLnJvb21TZXJ2ZXJdLFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgLy8gSXQncyBub3QgcmVhbGx5IHBvc3NpYmxlIHRvIGpvaW4gTWF0cml4IHJvb21zIGJ5IElEIGJlY2F1c2UgdGhlIEhTIGhhcyBubyB3YXkgdG8ga25vd1xuICAgICAgICAvLyB3aGljaCBzZXJ2ZXJzIHRvIHN0YXJ0IHF1ZXJ5aW5nLiBIb3dldmVyLCB0aGVyZSdzIG5vIG90aGVyIHdheSB0byBqb2luIHJvb21zIGluXG4gICAgICAgIC8vIHRoaXMgbGlzdCB3aXRob3V0IGFsaWFzZXMgYXQgcHJlc2VudCwgc28gaWYgcm9vbUFsaWFzIGlzbid0IHNldCBoZXJlIHdlIGhhdmUgbm9cbiAgICAgICAgLy8gY2hvaWNlIGJ1dCB0byBzdXBwbHkgdGhlIElELlxuICAgICAgICBpZiAocm9vbUFsaWFzKSB7XG4gICAgICAgICAgICBwYXlsb2FkLnJvb21fYWxpYXMgPSByb29tQWxpYXM7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBwYXlsb2FkLnJvb21faWQgPSByb29tLnJvb21faWQ7XG4gICAgICAgIH1cbiAgICAgICAgZGlzLmRpc3BhdGNoKHBheWxvYWQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgY3JlYXRlUm9vbUNlbGxzKHJvb206IElQdWJsaWNSb29tc0NodW5rUm9vbSkge1xuICAgICAgICBjb25zdCBjbGllbnQgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIGNvbnN0IGNsaWVudFJvb20gPSBjbGllbnQuZ2V0Um9vbShyb29tLnJvb21faWQpO1xuICAgICAgICBjb25zdCBoYXNKb2luZWRSb29tID0gY2xpZW50Um9vbSAmJiBjbGllbnRSb29tLmdldE15TWVtYmVyc2hpcCgpID09PSBcImpvaW5cIjtcbiAgICAgICAgY29uc3QgaXNHdWVzdCA9IGNsaWVudC5pc0d1ZXN0KCk7XG4gICAgICAgIGxldCBwcmV2aWV3QnV0dG9uO1xuICAgICAgICBsZXQgam9pbk9yVmlld0J1dHRvbjtcblxuICAgICAgICAvLyBFbGVtZW50IFdlYiBjdXJyZW50bHkgZG9lcyBub3QgYWxsb3cgZ3Vlc3RzIHRvIGpvaW4gcm9vbXMsIHNvIHdlXG4gICAgICAgIC8vIGluc3RlYWQgc2hvdyB0aGVtIHByZXZpZXcgYnV0dG9ucyBmb3IgYWxsIHJvb21zLiBJZiB0aGUgcm9vbSBpcyBub3RcbiAgICAgICAgLy8gd29ybGQgcmVhZGFibGUsIGEgbW9kYWwgd2lsbCBhcHBlYXIgYXNraW5nIHlvdSB0byByZWdpc3RlciBmaXJzdC4gSWZcbiAgICAgICAgLy8gaXQgaXMgcmVhZGFibGUsIHRoZSBwcmV2aWV3IGFwcGVhcnMgYXMgbm9ybWFsLlxuICAgICAgICBpZiAoIWhhc0pvaW5lZFJvb20gJiYgKHJvb20ud29ybGRfcmVhZGFibGUgfHwgaXNHdWVzdCkpIHtcbiAgICAgICAgICAgIHByZXZpZXdCdXR0b24gPSAoXG4gICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b24ga2luZD1cInNlY29uZGFyeVwiIG9uQ2xpY2s9eyhldikgPT4gdGhpcy5vblByZXZpZXdDbGljayhldiwgcm9vbSl9PlxuICAgICAgICAgICAgICAgICAgICB7IF90KFwiUHJldmlld1wiKSB9XG4gICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoaGFzSm9pbmVkUm9vbSkge1xuICAgICAgICAgICAgam9pbk9yVmlld0J1dHRvbiA9IChcbiAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvbiBraW5kPVwic2Vjb25kYXJ5XCIgb25DbGljaz17KGV2KSA9PiB0aGlzLm9uVmlld0NsaWNrKGV2LCByb29tKX0+XG4gICAgICAgICAgICAgICAgICAgIHsgX3QoXCJWaWV3XCIpIH1cbiAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2UgaWYgKCFpc0d1ZXN0KSB7XG4gICAgICAgICAgICBqb2luT3JWaWV3QnV0dG9uID0gKFxuICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uIGtpbmQ9XCJwcmltYXJ5XCIgb25DbGljaz17KGV2KSA9PiB0aGlzLm9uSm9pbkNsaWNrKGV2LCByb29tKX0+XG4gICAgICAgICAgICAgICAgICAgIHsgX3QoXCJKb2luXCIpIH1cbiAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IG5hbWUgPSByb29tLm5hbWUgfHwgZ2V0RGlzcGxheUFsaWFzRm9yUm9vbShyb29tKSB8fCBfdCgnVW5uYW1lZCByb29tJyk7XG4gICAgICAgIGlmIChuYW1lLmxlbmd0aCA+IE1BWF9OQU1FX0xFTkdUSCkge1xuICAgICAgICAgICAgbmFtZSA9IGAke25hbWUuc3Vic3RyaW5nKDAsIE1BWF9OQU1FX0xFTkdUSCl9Li4uYDtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCB0b3BpYyA9IHJvb20udG9waWMgfHwgJyc7XG4gICAgICAgIC8vIEFkZGl0aW9uYWwgdHJ1bmNhdGlvbiBiYXNlZCBvbiBsaW5lIG51bWJlcnMgaXMgZG9uZSB2aWEgQ1NTLFxuICAgICAgICAvLyBidXQgdG8gZW5zdXJlIHRoYXQgdGhlIERPTSBpcyBub3QgcG9sbHV0ZWQgd2l0aCBhIGh1Z2Ugc3RyaW5nXG4gICAgICAgIC8vIHdlIGdpdmUgaXQgYSBoYXJkIGxpbWl0IGJlZm9yZSByZW5kZXJpbmcuXG4gICAgICAgIGlmICh0b3BpYy5sZW5ndGggPiBNQVhfVE9QSUNfTEVOR1RIKSB7XG4gICAgICAgICAgICB0b3BpYyA9IGAke3RvcGljLnN1YnN0cmluZygwLCBNQVhfVE9QSUNfTEVOR1RIKX0uLi5gO1xuICAgICAgICB9XG4gICAgICAgIHRvcGljID0gbGlua2lmeUFuZFNhbml0aXplSHRtbCh0b3BpYyk7XG4gICAgICAgIGxldCBhdmF0YXJVcmwgPSBudWxsO1xuICAgICAgICBpZiAocm9vbS5hdmF0YXJfdXJsKSBhdmF0YXJVcmwgPSBtZWRpYUZyb21NeGMocm9vbS5hdmF0YXJfdXJsKS5nZXRTcXVhcmVUaHVtYm5haWxIdHRwKDMyKTtcblxuICAgICAgICAvLyBXZSB1c2Ugb25Nb3VzZURvd24gaW5zdGVhZCBvZiBvbkNsaWNrLCBzbyB0aGF0IHdlIGNhbiBhdm9pZCB0ZXh0IGdldHRpbmcgc2VsZWN0ZWRcbiAgICAgICAgcmV0dXJuIDxkaXZcbiAgICAgICAgICAgIGtleT17cm9vbS5yb29tX2lkfVxuICAgICAgICAgICAgcm9sZT1cImxpc3RpdGVtXCJcbiAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X1Jvb21EaXJlY3RvcnlfbGlzdEl0ZW1cIlxuICAgICAgICA+XG4gICAgICAgICAgICA8ZGl2XG4gICAgICAgICAgICAgICAgb25Nb3VzZURvd249eyhldikgPT4gdGhpcy5vblJvb21DbGlja2VkKHJvb20sIGV2KX1cbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9Sb29tRGlyZWN0b3J5X3Jvb21BdmF0YXJcIlxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgIDxCYXNlQXZhdGFyXG4gICAgICAgICAgICAgICAgICAgIHdpZHRoPXszMn1cbiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0PXszMn1cbiAgICAgICAgICAgICAgICAgICAgcmVzaXplTWV0aG9kPSdjcm9wJ1xuICAgICAgICAgICAgICAgICAgICBuYW1lPXtuYW1lfVxuICAgICAgICAgICAgICAgICAgICBpZE5hbWU9e25hbWV9XG4gICAgICAgICAgICAgICAgICAgIHVybD17YXZhdGFyVXJsfVxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgIDxkaXZcbiAgICAgICAgICAgICAgICBvbk1vdXNlRG93bj17KGV2KSA9PiB0aGlzLm9uUm9vbUNsaWNrZWQocm9vbSwgZXYpfVxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X1Jvb21EaXJlY3Rvcnlfcm9vbURlc2NyaXB0aW9uXCJcbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICA8ZGl2XG4gICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X1Jvb21EaXJlY3RvcnlfbmFtZVwiXG4gICAgICAgICAgICAgICAgICAgIG9uTW91c2VEb3duPXsoZXYpID0+IHRoaXMub25Sb29tQ2xpY2tlZChyb29tLCBldil9XG4gICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICB7IG5hbWUgfVxuICAgICAgICAgICAgICAgIDwvZGl2PiZuYnNwO1xuICAgICAgICAgICAgICAgIDxkaXZcbiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfUm9vbURpcmVjdG9yeV90b3BpY1wiXG4gICAgICAgICAgICAgICAgICAgIG9uTW91c2VEb3duPXsoZXYpID0+IHRoaXMub25Sb29tQ2xpY2tlZChyb29tLCBldil9XG4gICAgICAgICAgICAgICAgICAgIGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MPXt7IF9faHRtbDogdG9waWMgfX1cbiAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgIDxkaXZcbiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfUm9vbURpcmVjdG9yeV9hbGlhc1wiXG4gICAgICAgICAgICAgICAgICAgIG9uTW91c2VEb3duPXsoZXYpID0+IHRoaXMub25Sb29tQ2xpY2tlZChyb29tLCBldil9XG4gICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICB7IGdldERpc3BsYXlBbGlhc0ZvclJvb20ocm9vbSkgfVxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICA8ZGl2XG4gICAgICAgICAgICAgICAgb25Nb3VzZURvd249eyhldikgPT4gdGhpcy5vblJvb21DbGlja2VkKHJvb20sIGV2KX1cbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9Sb29tRGlyZWN0b3J5X3Jvb21NZW1iZXJDb3VudFwiXG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgeyByb29tLm51bV9qb2luZWRfbWVtYmVycyB9XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgIDxkaXZcbiAgICAgICAgICAgICAgICBvbk1vdXNlRG93bj17KGV2KSA9PiB0aGlzLm9uUm9vbUNsaWNrZWQocm9vbSwgZXYpfVxuICAgICAgICAgICAgICAgIC8vIGNhbmNlbCBvbk1vdXNlRG93biBvdGhlcndpc2Ugc2hpZnQtY2xpY2tpbmcgaGlnaGxpZ2h0cyB0ZXh0XG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfUm9vbURpcmVjdG9yeV9wcmV2aWV3XCJcbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICB7IHByZXZpZXdCdXR0b24gfVxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICA8ZGl2XG4gICAgICAgICAgICAgICAgb25Nb3VzZURvd249eyhldikgPT4gdGhpcy5vblJvb21DbGlja2VkKHJvb20sIGV2KX1cbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9Sb29tRGlyZWN0b3J5X2pvaW5cIlxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgIHsgam9pbk9yVmlld0J1dHRvbiB9XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgPC9kaXY+O1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RyaW5nTG9va3NMaWtlSWQoczogc3RyaW5nLCBmaWVsZFR5cGU6IElGaWVsZFR5cGUpIHtcbiAgICAgICAgbGV0IHBhdCA9IC9eI1teXFxzXSs6W15cXHNdLztcbiAgICAgICAgaWYgKGZpZWxkVHlwZSAmJiBmaWVsZFR5cGUucmVnZXhwKSB7XG4gICAgICAgICAgICBwYXQgPSBuZXcgUmVnRXhwKGZpZWxkVHlwZS5yZWdleHApO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHBhdC50ZXN0KHMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0RmllbGRzRm9yVGhpcmRQYXJ0eUxvY2F0aW9uKHVzZXJJbnB1dDogc3RyaW5nLCBwcm90b2NvbDogSVByb3RvY29sLCBpbnN0YW5jZTogSUluc3RhbmNlKSB7XG4gICAgICAgIC8vIG1ha2UgYW4gb2JqZWN0IHdpdGggdGhlIGZpZWxkcyBzcGVjaWZpZWQgYnkgdGhhdCBwcm90b2NvbC4gV2VcbiAgICAgICAgLy8gcmVxdWlyZSB0aGF0IHRoZSB2YWx1ZXMgb2YgYWxsIGJ1dCB0aGUgbGFzdCBmaWVsZCBjb21lIGZyb20gdGhlXG4gICAgICAgIC8vIGluc3RhbmNlLiBUaGUgbGFzdCBpcyB0aGUgdXNlciBpbnB1dC5cbiAgICAgICAgY29uc3QgcmVxdWlyZWRGaWVsZHMgPSBwcm90b2NvbC5sb2NhdGlvbl9maWVsZHM7XG4gICAgICAgIGlmICghcmVxdWlyZWRGaWVsZHMpIHJldHVybiBudWxsO1xuICAgICAgICBjb25zdCBmaWVsZHMgPSB7fTtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXF1aXJlZEZpZWxkcy5sZW5ndGggLSAxOyArK2kpIHtcbiAgICAgICAgICAgIGNvbnN0IHRoaXNGaWVsZCA9IHJlcXVpcmVkRmllbGRzW2ldO1xuICAgICAgICAgICAgaWYgKGluc3RhbmNlLmZpZWxkc1t0aGlzRmllbGRdID09PSB1bmRlZmluZWQpIHJldHVybiBudWxsO1xuICAgICAgICAgICAgZmllbGRzW3RoaXNGaWVsZF0gPSBpbnN0YW5jZS5maWVsZHNbdGhpc0ZpZWxkXTtcbiAgICAgICAgfVxuICAgICAgICBmaWVsZHNbcmVxdWlyZWRGaWVsZHNbcmVxdWlyZWRGaWVsZHMubGVuZ3RoIC0gMV1dID0gdXNlcklucHV0O1xuICAgICAgICByZXR1cm4gZmllbGRzO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25GaW5pc2hlZCA9ICgpID0+IHtcbiAgICAgICAgQ291bnRseUFuYWx5dGljcy5pbnN0YW5jZS50cmFja1Jvb21EaXJlY3RvcnkodGhpcy5zdGFydFRpbWUpO1xuICAgICAgICB0aGlzLnByb3BzLm9uRmluaXNoZWQoZmFsc2UpO1xuICAgIH07XG5cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIGxldCBjb250ZW50O1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5lcnJvcikge1xuICAgICAgICAgICAgY29udGVudCA9IHRoaXMuc3RhdGUuZXJyb3I7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5zdGF0ZS5wcm90b2NvbHNMb2FkaW5nKSB7XG4gICAgICAgICAgICBjb250ZW50ID0gPFNwaW5uZXIgLz47XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBjZWxscyA9ICh0aGlzLnN0YXRlLnB1YmxpY1Jvb21zIHx8IFtdKVxuICAgICAgICAgICAgICAgIC5yZWR1Y2UoKGNlbGxzLCByb29tKSA9PiBjZWxscy5jb25jYXQodGhpcy5jcmVhdGVSb29tQ2VsbHMocm9vbSkpLCBbXSk7XG4gICAgICAgICAgICAvLyB3ZSBzdGlsbCBzaG93IHRoZSBzY3JvbGxwYW5lbCwgYXQgbGVhc3QgZm9yIG5vdywgYmVjYXVzZVxuICAgICAgICAgICAgLy8gb3RoZXJ3aXNlIHdlIGRvbid0IGZldGNoIG1vcmUgYmVjYXVzZSB3ZSBkb24ndCBnZXQgYSBmaWxsXG4gICAgICAgICAgICAvLyByZXF1ZXN0IGZyb20gdGhlIHNjcm9sbHBhbmVsIGJlY2F1c2UgdGhlcmUgaXNuJ3Qgb25lXG5cbiAgICAgICAgICAgIGxldCBzcGlubmVyO1xuICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUubG9hZGluZykge1xuICAgICAgICAgICAgICAgIHNwaW5uZXIgPSA8U3Bpbm5lciAvPjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgY3JlYXRlTmV3QnV0dG9uID0gPD5cbiAgICAgICAgICAgICAgICA8aHIgLz5cbiAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvbiBraW5kPVwicHJpbWFyeVwiIG9uQ2xpY2s9e3RoaXMub25DcmVhdGVSb29tQ2xpY2t9IGNsYXNzTmFtZT1cIm14X1Jvb21EaXJlY3RvcnlfbmV3Um9vbVwiPlxuICAgICAgICAgICAgICAgICAgICB7IF90KFwiQ3JlYXRlIG5ldyByb29tXCIpIH1cbiAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICA8Lz47XG5cbiAgICAgICAgICAgIGxldCBzY3JvbGxQYW5lbENvbnRlbnQ7XG4gICAgICAgICAgICBsZXQgZm9vdGVyO1xuICAgICAgICAgICAgaWYgKGNlbGxzLmxlbmd0aCA9PT0gMCAmJiAhdGhpcy5zdGF0ZS5sb2FkaW5nKSB7XG4gICAgICAgICAgICAgICAgZm9vdGVyID0gPD5cbiAgICAgICAgICAgICAgICAgICAgPGg1PnsgX3QoJ05vIHJlc3VsdHMgZm9yIFwiJShxdWVyeSlzXCInLCB7IHF1ZXJ5OiB0aGlzLnN0YXRlLmZpbHRlclN0cmluZy50cmltKCkgfSkgfTwvaDU+XG4gICAgICAgICAgICAgICAgICAgIDxwPlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIlRyeSBkaWZmZXJlbnQgd29yZHMgb3IgY2hlY2sgZm9yIHR5cG9zLiBcIiArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJTb21lIHJlc3VsdHMgbWF5IG5vdCBiZSB2aXNpYmxlIGFzIHRoZXkncmUgcHJpdmF0ZSBhbmQgeW91IG5lZWQgYW4gaW52aXRlIHRvIGpvaW4gdGhlbS5cIikgfVxuICAgICAgICAgICAgICAgICAgICA8L3A+XG4gICAgICAgICAgICAgICAgICAgIHsgY3JlYXRlTmV3QnV0dG9uIH1cbiAgICAgICAgICAgICAgICA8Lz47XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHNjcm9sbFBhbmVsQ29udGVudCA9IDxkaXYgY2xhc3NOYW1lPVwibXhfUm9vbURpcmVjdG9yeV90YWJsZVwiPlxuICAgICAgICAgICAgICAgICAgICB7IGNlbGxzIH1cbiAgICAgICAgICAgICAgICA8L2Rpdj47XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLnN0YXRlLmxvYWRpbmcgJiYgIXRoaXMubmV4dEJhdGNoKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvb3RlciA9IGNyZWF0ZU5ld0J1dHRvbjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb250ZW50ID0gPFNjcm9sbFBhbmVsXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfUm9vbURpcmVjdG9yeV90YWJsZVdyYXBwZXJcIlxuICAgICAgICAgICAgICAgIG9uRmlsbFJlcXVlc3Q9e3RoaXMub25GaWxsUmVxdWVzdH1cbiAgICAgICAgICAgICAgICBzdGlja3lCb3R0b209e2ZhbHNlfVxuICAgICAgICAgICAgICAgIHN0YXJ0QXRCb3R0b209e2ZhbHNlfVxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgIHsgc2Nyb2xsUGFuZWxDb250ZW50IH1cbiAgICAgICAgICAgICAgICB7IHNwaW5uZXIgfVxuICAgICAgICAgICAgICAgIHsgZm9vdGVyICYmIDxkaXYgY2xhc3NOYW1lPVwibXhfUm9vbURpcmVjdG9yeV9mb290ZXJcIj5cbiAgICAgICAgICAgICAgICAgICAgeyBmb290ZXIgfVxuICAgICAgICAgICAgICAgIDwvZGl2PiB9XG4gICAgICAgICAgICA8L1Njcm9sbFBhbmVsPjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBsaXN0SGVhZGVyO1xuICAgICAgICBpZiAoIXRoaXMuc3RhdGUucHJvdG9jb2xzTG9hZGluZykge1xuICAgICAgICAgICAgY29uc3QgcHJvdG9jb2xOYW1lID0gcHJvdG9jb2xOYW1lRm9ySW5zdGFuY2VJZCh0aGlzLnByb3RvY29scywgdGhpcy5zdGF0ZS5pbnN0YW5jZUlkKTtcbiAgICAgICAgICAgIGxldCBpbnN0YW5jZUV4cGVjdGVkRmllbGRUeXBlO1xuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgIHByb3RvY29sTmFtZSAmJlxuICAgICAgICAgICAgICAgIHRoaXMucHJvdG9jb2xzICYmXG4gICAgICAgICAgICAgICAgdGhpcy5wcm90b2NvbHNbcHJvdG9jb2xOYW1lXSAmJlxuICAgICAgICAgICAgICAgIHRoaXMucHJvdG9jb2xzW3Byb3RvY29sTmFtZV0ubG9jYXRpb25fZmllbGRzLmxlbmd0aCA+IDAgJiZcbiAgICAgICAgICAgICAgICB0aGlzLnByb3RvY29sc1twcm90b2NvbE5hbWVdLmZpZWxkX3R5cGVzXG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICBjb25zdCBsYXN0RmllbGQgPSB0aGlzLnByb3RvY29sc1twcm90b2NvbE5hbWVdLmxvY2F0aW9uX2ZpZWxkcy5zbGljZSgtMSlbMF07XG4gICAgICAgICAgICAgICAgaW5zdGFuY2VFeHBlY3RlZEZpZWxkVHlwZSA9IHRoaXMucHJvdG9jb2xzW3Byb3RvY29sTmFtZV0uZmllbGRfdHlwZXNbbGFzdEZpZWxkXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IHBsYWNlaG9sZGVyID0gX3QoJ0ZpbmQgYSByb29t4oCmJyk7XG4gICAgICAgICAgICBpZiAoIXRoaXMuc3RhdGUuaW5zdGFuY2VJZCB8fCB0aGlzLnN0YXRlLmluc3RhbmNlSWQgPT09IEFMTF9ST09NUykge1xuICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyID0gX3QoXCJGaW5kIGEgcm9vbeKApiAoZS5nLiAlKGV4YW1wbGVSb29tKXMpXCIsIHtcbiAgICAgICAgICAgICAgICAgICAgZXhhbXBsZVJvb206IFwiI2V4YW1wbGU6XCIgKyB0aGlzLnN0YXRlLnJvb21TZXJ2ZXIsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGluc3RhbmNlRXhwZWN0ZWRGaWVsZFR5cGUpIHtcbiAgICAgICAgICAgICAgICBwbGFjZWhvbGRlciA9IGluc3RhbmNlRXhwZWN0ZWRGaWVsZFR5cGUucGxhY2Vob2xkZXI7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBzaG93Sm9pbkJ1dHRvbiA9IHRoaXMuc3RyaW5nTG9va3NMaWtlSWQodGhpcy5zdGF0ZS5maWx0ZXJTdHJpbmcsIGluc3RhbmNlRXhwZWN0ZWRGaWVsZFR5cGUpO1xuICAgICAgICAgICAgaWYgKHByb3RvY29sTmFtZSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGluc3RhbmNlID0gaW5zdGFuY2VGb3JJbnN0YW5jZUlkKHRoaXMucHJvdG9jb2xzLCB0aGlzLnN0YXRlLmluc3RhbmNlSWQpO1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmdldEZpZWxkc0ZvclRoaXJkUGFydHlMb2NhdGlvbihcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS5maWx0ZXJTdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucHJvdG9jb2xzW3Byb3RvY29sTmFtZV0sXG4gICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLFxuICAgICAgICAgICAgICAgICkgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgc2hvd0pvaW5CdXR0b24gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBkcm9wZG93biA9IChcbiAgICAgICAgICAgICAgICA8TmV0d29ya0Ryb3Bkb3duXG4gICAgICAgICAgICAgICAgICAgIHByb3RvY29scz17dGhpcy5wcm90b2NvbHN9XG4gICAgICAgICAgICAgICAgICAgIG9uT3B0aW9uQ2hhbmdlPXt0aGlzLm9uT3B0aW9uQ2hhbmdlfVxuICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFNlcnZlck5hbWU9e3RoaXMuc3RhdGUucm9vbVNlcnZlcn1cbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRJbnN0YW5jZUlkPXt0aGlzLnN0YXRlLmluc3RhbmNlSWR9XG4gICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBpZiAodGhpcy5zdGF0ZS5zZWxlY3RlZENvbW11bml0eUlkKSB7XG4gICAgICAgICAgICAgICAgZHJvcGRvd24gPSBudWxsO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsaXN0SGVhZGVyID0gPGRpdiBjbGFzc05hbWU9XCJteF9Sb29tRGlyZWN0b3J5X2xpc3RoZWFkZXJcIj5cbiAgICAgICAgICAgICAgICA8RGlyZWN0b3J5U2VhcmNoQm94XG4gICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X1Jvb21EaXJlY3Rvcnlfc2VhcmNoYm94XCJcbiAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2U9e3RoaXMub25GaWx0ZXJDaGFuZ2V9XG4gICAgICAgICAgICAgICAgICAgIG9uQ2xlYXI9e3RoaXMub25GaWx0ZXJDbGVhcn1cbiAgICAgICAgICAgICAgICAgICAgb25Kb2luQ2xpY2s9e3RoaXMub25Kb2luRnJvbVNlYXJjaENsaWNrfVxuICAgICAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcj17cGxhY2Vob2xkZXJ9XG4gICAgICAgICAgICAgICAgICAgIHNob3dKb2luQnV0dG9uPXtzaG93Sm9pbkJ1dHRvbn1cbiAgICAgICAgICAgICAgICAgICAgaW5pdGlhbFRleHQ9e3RoaXMucHJvcHMuaW5pdGlhbFRleHR9XG4gICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgICB7IGRyb3Bkb3duIH1cbiAgICAgICAgICAgIDwvZGl2PjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBleHBsYW5hdGlvbiA9XG4gICAgICAgICAgICBfdChcIklmIHlvdSBjYW4ndCBmaW5kIHRoZSByb29tIHlvdSdyZSBsb29raW5nIGZvciwgYXNrIGZvciBhbiBpbnZpdGUgb3IgPGE+Q3JlYXRlIGEgbmV3IHJvb208L2E+LlwiLCBudWxsLFxuICAgICAgICAgICAgICAgIHsgYTogc3ViID0+IChcbiAgICAgICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b24ga2luZD1cInNlY29uZGFyeVwiIG9uQ2xpY2s9e3RoaXMub25DcmVhdGVSb29tQ2xpY2t9PlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBzdWIgfVxuICAgICAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICAgICAgKSB9LFxuICAgICAgICAgICAgKTtcblxuICAgICAgICBjb25zdCB0aXRsZSA9IHRoaXMuc3RhdGUuc2VsZWN0ZWRDb21tdW5pdHlJZFxuICAgICAgICAgICAgPyBfdChcIkV4cGxvcmUgcm9vbXMgaW4gJShjb21tdW5pdHlOYW1lKXNcIiwge1xuICAgICAgICAgICAgICAgIGNvbW11bml0eU5hbWU6IHRoaXMuc3RhdGUuY29tbXVuaXR5TmFtZSB8fCB0aGlzLnN0YXRlLnNlbGVjdGVkQ29tbXVuaXR5SWQsXG4gICAgICAgICAgICB9KSA6IF90KFwiRXhwbG9yZSByb29tc1wiKTtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxCYXNlRGlhbG9nXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfUm9vbURpcmVjdG9yeV9kaWFsb2dcIlxuICAgICAgICAgICAgICAgIGhhc0NhbmNlbD17dHJ1ZX1cbiAgICAgICAgICAgICAgICBvbkZpbmlzaGVkPXt0aGlzLm9uRmluaXNoZWR9XG4gICAgICAgICAgICAgICAgdGl0bGU9e3RpdGxlfVxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfUm9vbURpcmVjdG9yeVwiPlxuICAgICAgICAgICAgICAgICAgICB7IGV4cGxhbmF0aW9uIH1cbiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9Sb29tRGlyZWN0b3J5X2xpc3RcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgbGlzdEhlYWRlciB9XG4gICAgICAgICAgICAgICAgICAgICAgICB7IGNvbnRlbnQgfVxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgIDwvQmFzZURpYWxvZz5cbiAgICAgICAgKTtcbiAgICB9XG59XG5cbi8vIFNpbWlsYXIgdG8gbWF0cml4LXJlYWN0LXNkaydzIE1hdHJpeFRvb2xzLmdldERpc3BsYXlBbGlhc0ZvclJvb21cbi8vIGJ1dCB3b3JrcyB3aXRoIHRoZSBvYmplY3RzIHdlIGdldCBmcm9tIHRoZSBwdWJsaWMgcm9vbSBsaXN0XG5leHBvcnQgZnVuY3Rpb24gZ2V0RGlzcGxheUFsaWFzRm9yUm9vbShyb29tOiBJUHVibGljUm9vbXNDaHVua1Jvb20pIHtcbiAgICByZXR1cm4gZ2V0RGlzcGxheUFsaWFzRm9yQWxpYXNTZXQocm9vbS5jYW5vbmljYWxfYWxpYXMsIHJvb20uYWxpYXNlcyk7XG59XG4iXX0=