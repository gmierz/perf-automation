"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireWildcard(require("react"));

var _reResizable = require("re-resizable");

var _classnames = _interopRequireDefault(require("classnames"));

var _AccessibleButton = _interopRequireDefault(require("../views/elements/AccessibleButton"));

var _RovingTabIndex = require("../../accessibility/RovingTabIndex");

var _Keyboard = require("../../Keyboard");

var _useLocalStorageState = require("../../hooks/useLocalStorageState");

var _MatrixClientContext = _interopRequireDefault(require("../../contexts/MatrixClientContext"));

var _WidgetUtils = _interopRequireDefault(require("../../utils/WidgetUtils"));

var _useAccountData = require("../../hooks/useAccountData");

var _AppTile = _interopRequireDefault(require("../views/elements/AppTile"));

var _useSettings = require("../../hooks/useSettings");

var _UIStore = _interopRequireDefault(require("../../stores/UIStore"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/*
Copyright 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const MIN_HEIGHT = 100;
const MAX_HEIGHT = 500; // or 50% of the window height

const INITIAL_HEIGHT = 280;

const LeftPanelWidget = () => {
  const cli = (0, _react.useContext)(_MatrixClientContext.default);
  const mWidgetsEvent = (0, _useAccountData.useAccountData)(cli, "m.widgets");
  const leftPanelWidgetId = (0, _useSettings.useSettingValue)("Widgets.leftPanel");
  const app = (0, _react.useMemo)(() => {
    if (!mWidgetsEvent || !leftPanelWidgetId) return null;
    const widgetConfig = Object.values(mWidgetsEvent).find(w => w.id === leftPanelWidgetId);
    if (!widgetConfig) return null;
    return _WidgetUtils.default.makeAppConfig(widgetConfig.state_key, widgetConfig.content, widgetConfig.sender, null, widgetConfig.id);
  }, [mWidgetsEvent, leftPanelWidgetId]);
  const [height, setHeight] = (0, _useLocalStorageState.useLocalStorageState)("left-panel-widget-height", INITIAL_HEIGHT);
  const [expanded, setExpanded] = (0, _useLocalStorageState.useLocalStorageState)("left-panel-widget-expanded", true);
  const [onFocus, isActive, ref] = (0, _RovingTabIndex.useRovingTabIndex)();
  const tabIndex = isActive ? 0 : -1;
  if (!app) return null;
  let content;

  if (expanded) {
    content = /*#__PURE__*/_react.default.createElement(_reResizable.Resizable, {
      size: {
        height
      },
      minHeight: MIN_HEIGHT,
      maxHeight: Math.min(_UIStore.default.instance.windowHeight / 2, MAX_HEIGHT),
      onResizeStop: (e, dir, ref, d) => {
        setHeight(height + d.height);
      },
      handleWrapperClass: "mx_LeftPanelWidget_resizerHandles",
      handleClasses: {
        top: "mx_LeftPanelWidget_resizerHandle"
      },
      className: "mx_LeftPanelWidget_resizeBox",
      enable: {
        top: true
      }
    }, /*#__PURE__*/_react.default.createElement(_AppTile.default, {
      app: app,
      fullWidth: true,
      showMenubar: false,
      userWidget: true,
      userId: cli.getUserId(),
      creatorUserId: app.creatorUserId,
      widgetPageTitle: _WidgetUtils.default.getWidgetDataTitle(app),
      waitForIframeLoad: app.waitForIframeLoad
    }));
  }

  return /*#__PURE__*/_react.default.createElement("div", {
    className: "mx_LeftPanelWidget"
  }, /*#__PURE__*/_react.default.createElement("div", {
    onFocus: onFocus,
    className: "mx_LeftPanelWidget_headerContainer",
    onKeyDown: ev => {
      switch (ev.key) {
        case _Keyboard.Key.ARROW_LEFT:
          ev.stopPropagation();
          setExpanded(false);
          break;

        case _Keyboard.Key.ARROW_RIGHT:
          {
            ev.stopPropagation();
            setExpanded(true);
            break;
          }
      }
    }
  }, /*#__PURE__*/_react.default.createElement("div", {
    className: "mx_LeftPanelWidget_stickable"
  }, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
    onFocus: onFocus,
    inputRef: ref,
    tabIndex: tabIndex,
    className: "mx_LeftPanelWidget_headerText",
    role: "treeitem",
    "aria-expanded": expanded,
    "aria-level": 1,
    onClick: () => {
      setExpanded(!expanded);
    }
  }, /*#__PURE__*/_react.default.createElement("span", {
    className: (0, _classnames.default)({
      "mx_LeftPanelWidget_collapseBtn": true,
      "mx_LeftPanelWidget_collapseBtn_collapsed": !expanded
    })
  }), /*#__PURE__*/_react.default.createElement("span", null, _WidgetUtils.default.getWidgetName(app))))), content);
};

var _default = LeftPanelWidget;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3N0cnVjdHVyZXMvTGVmdFBhbmVsV2lkZ2V0LnRzeCJdLCJuYW1lcyI6WyJNSU5fSEVJR0hUIiwiTUFYX0hFSUdIVCIsIklOSVRJQUxfSEVJR0hUIiwiTGVmdFBhbmVsV2lkZ2V0IiwiY2xpIiwiTWF0cml4Q2xpZW50Q29udGV4dCIsIm1XaWRnZXRzRXZlbnQiLCJsZWZ0UGFuZWxXaWRnZXRJZCIsImFwcCIsIndpZGdldENvbmZpZyIsIk9iamVjdCIsInZhbHVlcyIsImZpbmQiLCJ3IiwiaWQiLCJXaWRnZXRVdGlscyIsIm1ha2VBcHBDb25maWciLCJzdGF0ZV9rZXkiLCJjb250ZW50Iiwic2VuZGVyIiwiaGVpZ2h0Iiwic2V0SGVpZ2h0IiwiZXhwYW5kZWQiLCJzZXRFeHBhbmRlZCIsIm9uRm9jdXMiLCJpc0FjdGl2ZSIsInJlZiIsInRhYkluZGV4IiwiTWF0aCIsIm1pbiIsIlVJU3RvcmUiLCJpbnN0YW5jZSIsIndpbmRvd0hlaWdodCIsImUiLCJkaXIiLCJkIiwidG9wIiwiZ2V0VXNlcklkIiwiY3JlYXRvclVzZXJJZCIsImdldFdpZGdldERhdGFUaXRsZSIsIndhaXRGb3JJZnJhbWVMb2FkIiwiZXYiLCJrZXkiLCJLZXkiLCJBUlJPV19MRUZUIiwic3RvcFByb3BhZ2F0aW9uIiwiQVJST1dfUklHSFQiLCJnZXRXaWRnZXROYW1lIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFnQkE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQTdCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFpQkEsTUFBTUEsVUFBVSxHQUFHLEdBQW5CO0FBQ0EsTUFBTUMsVUFBVSxHQUFHLEdBQW5CLEMsQ0FBd0I7O0FBQ3hCLE1BQU1DLGNBQWMsR0FBRyxH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QUFBLFNBQVMsRUFBQyxvQ0FGZDtBQUdJLElBQUEsU0FBUyxFQUFHaUIsRUFBRCxJQUE2QjtBQUNwQyxjQUFRQSxFQUFFLENBQUNDLEdBQVg7QUFDSSxhQUFLQyxjQUFJQyxVQUFUO0FBQ0lILFVBQUFBLEVBQUUsQ0FBQ0ksZUFBSDtBQUNBdEIsVUFBQUEsV0FBVyxDQUFDLEtBQUQsQ0FBWDtBQUNBOztBQUNKLGFBQUtvQixjQUFJRyxXQUFUO0FBQXNCO0FBQ2xCTCxZQUFBQSxFQUFFLENBQUNJLGVBQUg7QUFDQXRCLFlBQUFBLFdBQVcsQ0FBQyxJQUFELENBQVg7QUFDQTtBQUNIO0FBVEw7QUFXSDtBQWZMLGtCQWlCSTtBQUFLLElBQUEsU0FBUyxFQUFDO0FBQWYsa0JBQ0ksNkJBQUMseUJBQUQ7QUFDSSxJQUFBLE9BQU8sRUFBRUMsT0FEYjtBQUVJLElBQUEsUUFBUSxFQUFFRSxHQUZkO0FBR0ksSUFBQSxRQUFRLEVBQUVDLFFBSGQ7QUFJSSxJQUFBLFNBQVMsRUFBQywrQkFKZDtBQUtJLElBQUEsSUFBSSxFQUFDLFVBTFQ7QUFNSSxxQkFBZUwsUUFObkI7QUFPSSxrQkFBWSxDQVBoQjtBQVFJLElBQUEsT0FBTyxFQUFFLE1BQU07QUFDWEMsTUFBQUEsV0FBVyxDQUFDLENBQUNELFFBQUYsQ0FBWDtBQUNIO0FBVkwsa0JBWUk7QUFBTSxJQUFBLFNBQVMsRUFBRSx5QkFBVztBQUN4Qix3Q0FBa0MsSUFEVjtBQUV4QixrREFBNEMsQ0FBQ0E7QUFGckIsS0FBWDtBQUFqQixJQVpKLGVBZ0JJLDJDQUFRUCxxQkFBWWdDLGFBQVosQ0FBMEJ2QyxHQUExQixDQUFSLENBaEJKLENBREosQ0FqQkosQ0FERyxFQWtERFUsT0FsREMsQ0FBUDtBQW9ESCxDQXpHRDs7ZUEyR2VmLGUiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMjAgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QsIHsgdXNlQ29udGV4dCwgdXNlTWVtbyB9IGZyb20gXCJyZWFjdFwiO1xuaW1wb3J0IHsgUmVzaXphYmxlIH0gZnJvbSBcInJlLXJlc2l6YWJsZVwiO1xuaW1wb3J0IGNsYXNzTmFtZXMgZnJvbSBcImNsYXNzbmFtZXNcIjtcblxuaW1wb3J0IEFjY2Vzc2libGVCdXR0b24gZnJvbSBcIi4uL3ZpZXdzL2VsZW1lbnRzL0FjY2Vzc2libGVCdXR0b25cIjtcbmltcG9ydCB7IHVzZVJvdmluZ1RhYkluZGV4IH0gZnJvbSBcIi4uLy4uL2FjY2Vzc2liaWxpdHkvUm92aW5nVGFiSW5kZXhcIjtcbmltcG9ydCB7IEtleSB9IGZyb20gXCIuLi8uLi9LZXlib2FyZFwiO1xuaW1wb3J0IHsgdXNlTG9jYWxTdG9yYWdlU3RhdGUgfSBmcm9tIFwiLi4vLi4vaG9va3MvdXNlTG9jYWxTdG9yYWdlU3RhdGVcIjtcbmltcG9ydCBNYXRyaXhDbGllbnRDb250ZXh0IGZyb20gXCIuLi8uLi9jb250ZXh0cy9NYXRyaXhDbGllbnRDb250ZXh0XCI7XG5pbXBvcnQgV2lkZ2V0VXRpbHMsIHsgSVdpZGdldEV2ZW50IH0gZnJvbSBcIi4uLy4uL3V0aWxzL1dpZGdldFV0aWxzXCI7XG5pbXBvcnQgeyB1c2VBY2NvdW50RGF0YSB9IGZyb20gXCIuLi8uLi9ob29rcy91c2VBY2NvdW50RGF0YVwiO1xuaW1wb3J0IEFwcFRpbGUgZnJvbSBcIi4uL3ZpZXdzL2VsZW1lbnRzL0FwcFRpbGVcIjtcbmltcG9ydCB7IHVzZVNldHRpbmdWYWx1ZSB9IGZyb20gXCIuLi8uLi9ob29rcy91c2VTZXR0aW5nc1wiO1xuaW1wb3J0IFVJU3RvcmUgZnJvbSBcIi4uLy4uL3N0b3Jlcy9VSVN0b3JlXCI7XG5cbmNvbnN0IE1JTl9IRUlHSFQgPSAxMDA7XG5jb25zdCBNQVhfSEVJR0hUID0gNTAwOyAvLyBvciA1MCUgb2YgdGhlIHdpbmRvdyBoZWlnaHRcbmNvbnN0IElOSVRJQUxfSEVJR0hUID0gMjgwO1xuXG5jb25zdCBMZWZ0UGFuZWxXaWRnZXQ6IFJlYWN0LkZDID0gKCkgPT4ge1xuICAgIGNvbnN0IGNsaSA9IHVzZUNvbnRleHQoTWF0cml4Q2xpZW50Q29udGV4dCk7XG5cbiAgICBjb25zdCBtV2lkZ2V0c0V2ZW50ID0gdXNlQWNjb3VudERhdGE8UmVjb3JkPHN0cmluZywgSVdpZGdldEV2ZW50Pj4oY2xpLCBcIm0ud2lkZ2V0c1wiKTtcbiAgICBjb25zdCBsZWZ0UGFuZWxXaWRnZXRJZCA9IHVzZVNldHRpbmdWYWx1ZShcIldpZGdldHMubGVmdFBhbmVsXCIpO1xuICAgIGNvbnN0IGFwcCA9IHVzZU1lbW8oKCkgPT4ge1xuICAgICAgICBpZiAoIW1XaWRnZXRzRXZlbnQgfHwgIWxlZnRQYW5lbFdpZGdldElkKSByZXR1cm4gbnVsbDtcbiAgICAgICAgY29uc3Qgd2lkZ2V0Q29uZmlnID0gT2JqZWN0LnZhbHVlcyhtV2lkZ2V0c0V2ZW50KS5maW5kKHcgPT4gdy5pZCA9PT0gbGVmdFBhbmVsV2lkZ2V0SWQpO1xuICAgICAgICBpZiAoIXdpZGdldENvbmZpZykgcmV0dXJuIG51bGw7XG5cbiAgICAgICAgcmV0dXJuIFdpZGdldFV0aWxzLm1ha2VBcHBDb25maWcoXG4gICAgICAgICAgICB3aWRnZXRDb25maWcuc3RhdGVfa2V5LFxuICAgICAgICAgICAgd2lkZ2V0Q29uZmlnLmNvbnRlbnQsXG4gICAgICAgICAgICB3aWRnZXRDb25maWcuc2VuZGVyLFxuICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgIHdpZGdldENvbmZpZy5pZCk7XG4gICAgfSwgW21XaWRnZXRzRXZlbnQsIGxlZnRQYW5lbFdpZGdldElkXSk7XG5cbiAgICBjb25zdCBbaGVpZ2h0LCBzZXRIZWlnaHRdID0gdXNlTG9jYWxTdG9yYWdlU3RhdGUoXCJsZWZ0LXBhbmVsLXdpZGdldC1oZWlnaHRcIiwgSU5JVElBTF9IRUlHSFQpO1xuICAgIGNvbnN0IFtleHBhbmRlZCwgc2V0RXhwYW5kZWRdID0gdXNlTG9jYWxTdG9yYWdlU3RhdGUoXCJsZWZ0LXBhbmVsLXdpZGdldC1leHBhbmRlZFwiLCB0cnVlKTtcblxuICAgIGNvbnN0IFtvbkZvY3VzLCBpc0FjdGl2ZSwgcmVmXSA9IHVzZVJvdmluZ1RhYkluZGV4KCk7XG4gICAgY29uc3QgdGFiSW5kZXggPSBpc0FjdGl2ZSA/IDAgOiAtMTtcblxuICAgIGlmICghYXBwKSByZXR1cm4gbnVsbDtcblxuICAgIGxldCBjb250ZW50O1xuICAgIGlmIChleHBhbmRlZCkge1xuICAgICAgICBjb250ZW50ID0gPFJlc2l6YWJsZVxuICAgICAgICAgICAgc2l6ZT17eyBoZWlnaHQgfSBhcyBhbnl9XG4gICAgICAgICAgICBtaW5IZWlnaHQ9e01JTl9IRUlHSFR9XG4gICAgICAgICAgICBtYXhIZWlnaHQ9e01hdGgubWluKFVJU3RvcmUuaW5zdGFuY2Uud2luZG93SGVpZ2h0IC8gMiwgTUFYX0hFSUdIVCl9XG4gICAgICAgICAgICBvblJlc2l6ZVN0b3A9eyhlLCBkaXIsIHJlZiwgZCkgPT4ge1xuICAgICAgICAgICAgICAgIHNldEhlaWdodChoZWlnaHQgKyBkLmhlaWdodCk7XG4gICAgICAgICAgICB9fVxuICAgICAgICAgICAgaGFuZGxlV3JhcHBlckNsYXNzPVwibXhfTGVmdFBhbmVsV2lkZ2V0X3Jlc2l6ZXJIYW5kbGVzXCJcbiAgICAgICAgICAgIGhhbmRsZUNsYXNzZXM9e3sgdG9wOiBcIm14X0xlZnRQYW5lbFdpZGdldF9yZXNpemVySGFuZGxlXCIgfX1cbiAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X0xlZnRQYW5lbFdpZGdldF9yZXNpemVCb3hcIlxuICAgICAgICAgICAgZW5hYmxlPXt7IHRvcDogdHJ1ZSB9fVxuICAgICAgICA+XG4gICAgICAgICAgICA8QXBwVGlsZVxuICAgICAgICAgICAgICAgIGFwcD17YXBwfVxuICAgICAgICAgICAgICAgIGZ1bGxXaWR0aFxuICAgICAgICAgICAgICAgIHNob3dNZW51YmFyPXtmYWxzZX1cbiAgICAgICAgICAgICAgICB1c2VyV2lkZ2V0XG4gICAgICAgICAgICAgICAgdXNlcklkPXtjbGkuZ2V0VXNlcklkKCl9XG4gICAgICAgICAgICAgICAgY3JlYXRvclVzZXJJZD17YXBwLmNyZWF0b3JVc2VySWR9XG4gICAgICAgICAgICAgICAgd2lkZ2V0UGFnZVRpdGxlPXtXaWRnZXRVdGlscy5nZXRXaWRnZXREYXRhVGl0bGUoYXBwKX1cbiAgICAgICAgICAgICAgICB3YWl0Rm9ySWZyYW1lTG9hZD17YXBwLndhaXRGb3JJZnJhbWVMb2FkfVxuICAgICAgICAgICAgLz5cbiAgICAgICAgPC9SZXNpemFibGU+O1xuICAgIH1cblxuICAgIHJldHVybiA8ZGl2IGNsYXNzTmFtZT1cIm14X0xlZnRQYW5lbFdpZGdldFwiPlxuICAgICAgICA8ZGl2XG4gICAgICAgICAgICBvbkZvY3VzPXtvbkZvY3VzfVxuICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfTGVmdFBhbmVsV2lkZ2V0X2hlYWRlckNvbnRhaW5lclwiXG4gICAgICAgICAgICBvbktleURvd249eyhldjogUmVhY3QuS2V5Ym9hcmRFdmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIHN3aXRjaCAoZXYua2V5KSB7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgS2V5LkFSUk9XX0xFRlQ6XG4gICAgICAgICAgICAgICAgICAgICAgICBldi5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNldEV4cGFuZGVkKGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICBjYXNlIEtleS5BUlJPV19SSUdIVDoge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXYuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZXRFeHBhbmRlZCh0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfX1cbiAgICAgICAgPlxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9MZWZ0UGFuZWxXaWRnZXRfc3RpY2thYmxlXCI+XG4gICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b25cbiAgICAgICAgICAgICAgICAgICAgb25Gb2N1cz17b25Gb2N1c31cbiAgICAgICAgICAgICAgICAgICAgaW5wdXRSZWY9e3JlZn1cbiAgICAgICAgICAgICAgICAgICAgdGFiSW5kZXg9e3RhYkluZGV4fVxuICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9MZWZ0UGFuZWxXaWRnZXRfaGVhZGVyVGV4dFwiXG4gICAgICAgICAgICAgICAgICAgIHJvbGU9XCJ0cmVlaXRlbVwiXG4gICAgICAgICAgICAgICAgICAgIGFyaWEtZXhwYW5kZWQ9e2V4cGFuZGVkfVxuICAgICAgICAgICAgICAgICAgICBhcmlhLWxldmVsPXsxfVxuICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXsoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZXRFeHBhbmRlZCghZXhwYW5kZWQpO1xuICAgICAgICAgICAgICAgICAgICB9fVxuICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3NOYW1lPXtjbGFzc05hbWVzKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwibXhfTGVmdFBhbmVsV2lkZ2V0X2NvbGxhcHNlQnRuXCI6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBcIm14X0xlZnRQYW5lbFdpZGdldF9jb2xsYXBzZUJ0bl9jb2xsYXBzZWRcIjogIWV4cGFuZGVkLFxuICAgICAgICAgICAgICAgICAgICB9KX0gLz5cbiAgICAgICAgICAgICAgICAgICAgPHNwYW4+eyBXaWRnZXRVdGlscy5nZXRXaWRnZXROYW1lKGFwcCkgfTwvc3Bhbj5cbiAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG5cbiAgICAgICAgICAgICAgICB7IC8qIENvZGUgZm9yIHRoZSBtYXhpbWlzZSBidXR0b24gZm9yIG9uY2Ugd2UgaGF2ZSBmdWxsIHNjcmVlbiB3aWRnZXRzICovIH1cbiAgICAgICAgICAgICAgICB7IC8qPEFjY2Vzc2libGVUb29sdGlwQnV0dG9uXG4gICAgICAgICAgICAgICAgICAgIHRhYkluZGV4PXt0YWJJbmRleH1cbiAgICAgICAgICAgICAgICAgICAgb25DbGljaz17KCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB9fVxuICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9MZWZ0UGFuZWxXaWRnZXRfbWF4aW1pemVCdXR0b25cIlxuICAgICAgICAgICAgICAgICAgICB0b29sdGlwQ2xhc3NOYW1lPVwibXhfTGVmdFBhbmVsV2lkZ2V0X21heGltaXplQnV0dG9uVG9vbHRpcFwiXG4gICAgICAgICAgICAgICAgICAgIHRpdGxlPXtfdChcIk1heGltaXNlXCIpfVxuICAgICAgICAgICAgICAgIC8+Ki8gfVxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgIDwvZGl2PlxuXG4gICAgICAgIHsgY29udGVudCB9XG4gICAgPC9kaXY+O1xufTtcblxuZXhwb3J0IGRlZmF1bHQgTGVmdFBhbmVsV2lkZ2V0O1xuIl19