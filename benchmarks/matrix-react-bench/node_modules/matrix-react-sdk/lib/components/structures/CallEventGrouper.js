"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.CustomCallState = exports.CallEventGrouperEvent = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _event = require("matrix-js-sdk/src/@types/event");

var _call = require("matrix-js-sdk/src/webrtc/call");

var _CallHandler = _interopRequireWildcard(require("../../CallHandler"));

var _events = require("events");

var _MatrixClientPeg = require("../../MatrixClientPeg");

var _dispatcher = _interopRequireDefault(require("../../dispatcher/dispatcher"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/*
Copyright 2021 Å imon Brandner <simon.bra.ag@gmail.com>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
let CallEventGrouperEvent;
exports.CallEventGrouperEvent = CallEventGrouperEvent;

(function (CallEventGrouperEvent) {
  CallEventGrouperEvent["StateChanged"] = "state_changed";
  CallEventGrouperEvent["SilencedChanged"] = "silenced_changed";
  CallEventGrouperEvent["LengthChanged"] = "length_changed";
})(CallEventGrouperEvent || (exports.CallEventGrouperEvent = CallEventGrouperEvent = {}));

const CONNECTING_STATES = [_call.CallState.Connecting, _call.CallState.WaitLocalMedia, _call.CallState.CreateOffer, _call.CallState.CreateAnswer];
const SUPPORTED_STATES = [_call.CallState.Connected, _call.CallState.Ringing];
let CustomCallState;
exports.CustomCallState = CustomCallState;

(function (CustomCallState) {
  CustomCallState["Missed"] = "missed";
})(CustomCallState || (exports.CustomCallState = CustomCallState = {}));

class CallEventGrouper extends _events.EventEmitter {
  constructor() {
    super();
    (0, _defineProperty2.default)(this, "events", new Set());
    (0, _defineProperty2.default)(this, "call", void 0);
    (0, _defineProperty2.default)(this, "state", void 0);
    (0, _defineProperty2.default)(this, "onSilencedCallsChanged", () => {
      const newState = _CallHandler.default.sharedInstance().isCallSilenced(this.callId);

      this.emit(CallEventGrouperEvent.SilencedChanged, newState);
    });
    (0, _defineProperty2.default)(this, "onLengthChanged", length => {
      this.emit(CallEventGrouperEvent.LengthChanged, length);
    });
    (0, _defineProperty2.default)(this, "answerCall", () => {
      _dispatcher.default.dispatch({
        action: 'answer',
        room_id: this.roomId
      });
    });
    (0, _defineProperty2.default)(this, "rejectCall", () => {
      _dispatcher.default.dispatch({
        action: 'reject',
        room_id: this.roomId
      });
    });
    (0, _defineProperty2.default)(this, "callBack", () => {
      _dispatcher.default.dispatch({
        action: 'place_call',
        type: this.isVoice ? _call.CallType.Voice : _call.CallType.Video,
        room_id: this.roomId
      });
    });
    (0, _defineProperty2.default)(this, "toggleSilenced", () => {
      const silenced = _CallHandler.default.sharedInstance().isCallSilenced(this.callId);

      silenced ? _CallHandler.default.sharedInstance().unSilenceCall(this.callId) : _CallHandler.default.sharedInstance().silenceCall(this.callId);
    });
    (0, _defineProperty2.default)(this, "setState", () => {
      var _this$call, _this$call2;

      if (CONNECTING_STATES.includes((_this$call = this.call) === null || _this$call === void 0 ? void 0 : _this$call.state)) {
        this.state = _call.CallState.Connecting;
      } else if (SUPPORTED_STATES.includes((_this$call2 = this.call) === null || _this$call2 === void 0 ? void 0 : _this$call2.state)) {
        this.state = this.call.state;
      } else {
        if (this.callWasMissed) this.state = CustomCallState.Missed;else if (this.reject) this.state = _call.CallState.Ended;else if (this.hangup) this.state = _call.CallState.Ended;else if (this.invite && this.call) this.state = _call.CallState.Connecting;
      }

      this.emit(CallEventGrouperEvent.StateChanged, this.state);
    });
    (0, _defineProperty2.default)(this, "setCall", () => {
      if (this.call) return;
      this.call = _CallHandler.default.sharedInstance().getCallById(this.callId);
      this.setCallListeners();
      this.setState();
    });

    _CallHandler.default.sharedInstance().addListener(_CallHandler.CallHandlerEvent.CallsChanged, this.setCall);

    _CallHandler.default.sharedInstance().addListener(_CallHandler.CallHandlerEvent.SilencedCallsChanged, this.onSilencedCallsChanged);
  }

  get invite() {
    return [...this.events].find(event => event.getType() === _event.EventType.CallInvite);
  }

  get hangup() {
    return [...this.events].find(event => event.getType() === _event.EventType.CallHangup);
  }

  get reject() {
    return [...this.events].find(event => event.getType() === _event.EventType.CallReject);
  }

  get selectAnswer() {
    return [...this.events].find(event => event.getType() === _event.EventType.CallSelectAnswer);
  }

  get isVoice() {
    var _invite$getContent, _invite$getContent$of, _invite$getContent$of2;

    const invite = this.invite;
    if (!invite) return; // FIXME: Find a better way to determine this from the event?

    if (((_invite$getContent = invite.getContent()) === null || _invite$getContent === void 0 ? void 0 : (_invite$getContent$of = _invite$getContent.offer) === null || _invite$getContent$of === void 0 ? void 0 : (_invite$getContent$of2 = _invite$getContent$of.sdp) === null || _invite$getContent$of2 === void 0 ? void 0 : _invite$getContent$of2.indexOf('m=video')) !== -1) return false;
    return true;
  }

  get hangupReason() {
    var _this$hangup, _this$hangup$getConte;

    return (_this$hangup = this.hangup) === null || _this$hangup === void 0 ? void 0 : (_this$hangup$getConte = _this$hangup.getContent()) === null || _this$hangup$getConte === void 0 ? void 0 : _this$hangup$getConte.reason;
  }

  get rejectParty() {
    var _this$reject;

    return (_this$reject = this.reject) === null || _this$reject === void 0 ? void 0 : _this$reject.getSender();
  }

  get gotRejected() {
    return Boolean(this.reject);
  }

  get duration() {
    if (!this.hangup || !this.selectAnswer) return;
    return new Date(this.hangup.getDate().getTime() - this.selectAnswer.getDate().getTime());
  }
  /**
   * Returns true if there are only events from the other side - we missed the call
   */


  get callWasMissed() {
    return ![...this.events].some(event => {
      var _event$sender;

      return ((_event$sender = event.sender) === null || _event$sender === void 0 ? void 0 : _event$sender.userId) === _MatrixClientPeg.MatrixClientPeg.get().getUserId();
    });
  }

  get callId() {
    var _, _$getContent;

    return (_ = [...this.events][0]) === null || _ === void 0 ? void 0 : (_$getContent = _.getContent()) === null || _$getContent === void 0 ? void 0 : _$getContent.call_id;
  }

  get roomId() {
    var _2;

    return (_2 = [...this.events][0]) === null || _2 === void 0 ? void 0 : _2.getRoomId();
  }

  setCallListeners() {
    if (!this.call) return;
    this.call.addListener(_call.CallEvent.State, this.setState);
    this.call.addListener(_call.CallEvent.LengthChanged, this.onLengthChanged);
  }

  add(event) {
    this.events.add(event);
    this.setCall();
  }

}

exports.default = CallEventGrouper;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3N0cnVjdHVyZXMvQ2FsbEV2ZW50R3JvdXBlci50cyJdLCJuYW1lcyI6WyJDYWxsRXZlbnRHcm91cGVyRXZlbnQiLCJDT05ORUNUSU5HX1NUQVRFUyIsIkNhbGxTdGF0ZSIsIkNvbm5lY3RpbmciLCJXYWl0TG9jYWxNZWRpYSIsIkNyZWF0ZU9mZmVyIiwiQ3JlYXRlQW5zd2VyIiwiU1VQUE9SVEVEX1NUQVRFUyIsIkNvbm5lY3RlZCIsIlJpbmdpbmciLCJDdXN0b21DYWxsU3RhdGUiLCJDYWxsRXZlbnRHcm91cGVyIiwiRXZlbnRFbWl0dGVyIiwiY29uc3RydWN0b3IiLCJTZXQiLCJuZXdTdGF0ZSIsIkNhbGxIYW5kbGVyIiwic2hhcmVkSW5zdGFuY2UiLCJpc0NhbGxTaWxlbmNlZCIsImNhbGxJZCIsImVtaXQiLCJTaWxlbmNlZENoYW5nZWQiLCJsZW5ndGgiLCJMZW5ndGhDaGFuZ2VkIiwiZGVmYXVsdERpc3BhdGNoZXIiLCJkaXNwYXRjaCIsImFjdGlvbiIsInJvb21faWQiLCJyb29tSWQiLCJ0eXBlIiwiaXNWb2ljZSIsIkNhbGxUeXBlIiwiVm9pY2UiLCJWaWRlbyIsInNpbGVuY2VkIiwidW5TaWxlbmNlQ2FsbCIsInNpbGVuY2VDYWxsIiwiaW5jbHVkZXMiLCJjYWxsIiwic3RhdGUiLCJjYWxsV2FzTWlzc2VkIiwiTWlzc2VkIiwicmVqZWN0IiwiRW5kZWQiLCJoYW5ndXAiLCJpbnZpdGUiLCJTdGF0ZUNoYW5nZWQiLCJnZXRDYWxsQnlJZCIsInNldENhbGxMaXN0ZW5lcnMiLCJzZXRTdGF0ZSIsImFkZExpc3RlbmVyIiwiQ2FsbEhhbmRsZXJFdmVudCIsIkNhbGxzQ2hhbmdlZCIsInNldENhbGwiLCJTaWxlbmNlZENhbGxzQ2hhbmdlZCIsIm9uU2lsZW5jZWRDYWxsc0NoYW5nZWQiLCJldmVudHMiLCJmaW5kIiwiZXZlbnQiLCJnZXRUeXBlIiwiRXZlbnRUeXBlIiwiQ2FsbEludml0ZSIsIkNhbGxIYW5ndXAiLCJDYWxsUmVqZWN0Iiwic2VsZWN0QW5zd2VyIiwiQ2FsbFNlbGVjdEFuc3dlciIsImdldENvbnRlbnQiLCJvZmZlciIsInNkcCIsImluZGV4T2YiLCJoYW5ndXBSZWFzb24iLCJyZWFzb24iLCJyZWplY3RQYXJ0eSIsImdldFNlbmRlciIsImdvdFJlamVjdGVkIiwiQm9vbGVhbiIsImR1cmF0aW9uIiwiRGF0ZSIsImdldERhdGUiLCJnZXRUaW1lIiwic29tZSIsInNlbmRlciIsInVzZXJJZCIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsImdldFVzZXJJZCIsImNhbGxfaWQiLCJnZXRSb29tSWQiLCJDYWxsRXZlbnQiLCJTdGF0ZSIsIm9uTGVuZ3RoQ2hhbmdlZCIsImFkZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFnQkE7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQXRCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7SUFVWUEscUI7OztXQUFBQSxxQjtBQUFBQSxFQUFBQSxxQjtBQUFBQSxFQUFBQSxxQjtBQUFBQSxFQUFBQSxxQjtHQUFBQSxxQixxQ0FBQUEscUI7O0FBTVosTUFBTUMsaUJBQWlCLEdBQUcsQ0FDdEJDLGdCQUFVQyxVQURZLEVBRXRCRCxnQkFBVUUsY0FGWSxFQUd0QkYsZ0JBQVVHLFdBSFksRUFJdEJILGdCQUFVSSxZQUpZLENBQTFCO0FBT0EsTUFBTUMsZ0JBQWdCLEdBQUcsQ0FDckJMLGdCQUFVTSxTQURXLEVBRXJCTixnQkFBVU8sT0FGVyxDQUF6QjtJQUtZQyxlOzs7V0FBQUEsZTtBQUFBQSxFQUFBQSxlO0dBQUFBLGUsK0JBQUFBLGU7O0FBSUcsTUFBTUMsZ0JBQU4sU0FBK0JDLG9CQUEvQixDQUE0QztBQUt2REMsRUFBQUEsV0FBVyxHQUFHO0FBQ1Y7QUFEVSxrREFKcUIsSUFBSUMsR0FBSixFQUlyQjtBQUFBO0FBQUE7QUFBQSxrRUFnRW1CLE1BQU07QUFD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QUFLVixJQUFWLEVBQWdCO0FBQ2hCLFNBQUtBLElBQUwsQ0FBVVksV0FBVixDQUFzQnNDLGdCQUFVQyxLQUFoQyxFQUF1QyxLQUFLeEMsUUFBNUM7QUFDQSxTQUFLWCxJQUFMLENBQVVZLFdBQVYsQ0FBc0JzQyxnQkFBVWpFLGFBQWhDLEVBQStDLEtBQUttRSxlQUFwRDtBQUNIOztBQXdCTUMsRUFBQUEsR0FBRyxDQUFDakMsS0FBRCxFQUFxQjtBQUMzQixTQUFLRixNQUFMLENBQVltQyxHQUFaLENBQWdCakMsS0FBaEI7QUFDQSxTQUFLTCxPQUFMO0FBQ0g7O0FBMUlzRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAyMSDFoGltb24gQnJhbmRuZXIgPHNpbW9uLmJyYS5hZ0BnbWFpbC5jb20+XG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IHsgRXZlbnRUeXBlIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL0B0eXBlcy9ldmVudFwiO1xuaW1wb3J0IHsgTWF0cml4RXZlbnQgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL2V2ZW50XCI7XG5pbXBvcnQgeyBDYWxsRXZlbnQsIENhbGxTdGF0ZSwgQ2FsbFR5cGUsIE1hdHJpeENhbGwgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvd2VicnRjL2NhbGxcIjtcbmltcG9ydCBDYWxsSGFuZGxlciwgeyBDYWxsSGFuZGxlckV2ZW50IH0gZnJvbSAnLi4vLi4vQ2FsbEhhbmRsZXInO1xuaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gXCIuLi8uLi9NYXRyaXhDbGllbnRQZWdcIjtcbmltcG9ydCBkZWZhdWx0RGlzcGF0Y2hlciBmcm9tIFwiLi4vLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyXCI7XG5cbmV4cG9ydCBlbnVtIENhbGxFdmVudEdyb3VwZXJFdmVudCB7XG4gICAgU3RhdGVDaGFuZ2VkID0gXCJzdGF0ZV9jaGFuZ2VkXCIsXG4gICAgU2lsZW5jZWRDaGFuZ2VkID0gXCJzaWxlbmNlZF9jaGFuZ2VkXCIsXG4gICAgTGVuZ3RoQ2hhbmdlZCA9IFwibGVuZ3RoX2NoYW5nZWRcIixcbn1cblxuY29uc3QgQ09OTkVDVElOR19TVEFURVMgPSBbXG4gICAgQ2FsbFN0YXRlLkNvbm5lY3RpbmcsXG4gICAgQ2FsbFN0YXRlLldhaXRMb2NhbE1lZGlhLFxuICAgIENhbGxTdGF0ZS5DcmVhdGVPZmZlcixcbiAgICBDYWxsU3RhdGUuQ3JlYXRlQW5zd2VyLFxuXTtcblxuY29uc3QgU1VQUE9SVEVEX1NUQVRFUyA9IFtcbiAgICBDYWxsU3RhdGUuQ29ubmVjdGVkLFxuICAgIENhbGxTdGF0ZS5SaW5naW5nLFxuXTtcblxuZXhwb3J0IGVudW0gQ3VzdG9tQ2FsbFN0YXRlIHtcbiAgICBNaXNzZWQgPSBcIm1pc3NlZFwiLFxufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDYWxsRXZlbnRHcm91cGVyIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgICBwcml2YXRlIGV2ZW50czogU2V0PE1hdHJpeEV2ZW50PiA9IG5ldyBTZXQ8TWF0cml4RXZlbnQ+KCk7XG4gICAgcHJpdmF0ZSBjYWxsOiBNYXRyaXhDYWxsO1xuICAgIHB1YmxpYyBzdGF0ZTogQ2FsbFN0YXRlIHwgQ3VzdG9tQ2FsbFN0YXRlO1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgQ2FsbEhhbmRsZXIuc2hhcmVkSW5zdGFuY2UoKS5hZGRMaXN0ZW5lcihDYWxsSGFuZGxlckV2ZW50LkNhbGxzQ2hhbmdlZCwgdGhpcy5zZXRDYWxsKTtcbiAgICAgICAgQ2FsbEhhbmRsZXIuc2hhcmVkSW5zdGFuY2UoKS5hZGRMaXN0ZW5lcihDYWxsSGFuZGxlckV2ZW50LlNpbGVuY2VkQ2FsbHNDaGFuZ2VkLCB0aGlzLm9uU2lsZW5jZWRDYWxsc0NoYW5nZWQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0IGludml0ZSgpOiBNYXRyaXhFdmVudCB7XG4gICAgICAgIHJldHVybiBbLi4udGhpcy5ldmVudHNdLmZpbmQoKGV2ZW50KSA9PiBldmVudC5nZXRUeXBlKCkgPT09IEV2ZW50VHlwZS5DYWxsSW52aXRlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldCBoYW5ndXAoKTogTWF0cml4RXZlbnQge1xuICAgICAgICByZXR1cm4gWy4uLnRoaXMuZXZlbnRzXS5maW5kKChldmVudCkgPT4gZXZlbnQuZ2V0VHlwZSgpID09PSBFdmVudFR5cGUuQ2FsbEhhbmd1cCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXQgcmVqZWN0KCk6IE1hdHJpeEV2ZW50IHtcbiAgICAgICAgcmV0dXJuIFsuLi50aGlzLmV2ZW50c10uZmluZCgoZXZlbnQpID0+IGV2ZW50LmdldFR5cGUoKSA9PT0gRXZlbnRUeXBlLkNhbGxSZWplY3QpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0IHNlbGVjdEFuc3dlcigpOiBNYXRyaXhFdmVudCB7XG4gICAgICAgIHJldHVybiBbLi4udGhpcy5ldmVudHNdLmZpbmQoKGV2ZW50KSA9PiBldmVudC5nZXRUeXBlKCkgPT09IEV2ZW50VHlwZS5DYWxsU2VsZWN0QW5zd2VyKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGlzVm9pY2UoKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IGludml0ZSA9IHRoaXMuaW52aXRlO1xuICAgICAgICBpZiAoIWludml0ZSkgcmV0dXJuO1xuXG4gICAgICAgIC8vIEZJWE1FOiBGaW5kIGEgYmV0dGVyIHdheSB0byBkZXRlcm1pbmUgdGhpcyBmcm9tIHRoZSBldmVudD9cbiAgICAgICAgaWYgKGludml0ZS5nZXRDb250ZW50KCk/Lm9mZmVyPy5zZHA/LmluZGV4T2YoJ209dmlkZW8nKSAhPT0gLTEpIHJldHVybiBmYWxzZTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBoYW5ndXBSZWFzb24oKTogc3RyaW5nIHwgbnVsbCB7XG4gICAgICAgIHJldHVybiB0aGlzLmhhbmd1cD8uZ2V0Q29udGVudCgpPy5yZWFzb247XG4gICAgfVxuXG4gICAgcHVibGljIGdldCByZWplY3RQYXJ0eSgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5yZWplY3Q/LmdldFNlbmRlcigpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgZ290UmVqZWN0ZWQoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBCb29sZWFuKHRoaXMucmVqZWN0KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGR1cmF0aW9uKCk6IERhdGUge1xuICAgICAgICBpZiAoIXRoaXMuaGFuZ3VwIHx8ICF0aGlzLnNlbGVjdEFuc3dlcikgcmV0dXJuO1xuICAgICAgICByZXR1cm4gbmV3IERhdGUodGhpcy5oYW5ndXAuZ2V0RGF0ZSgpLmdldFRpbWUoKSAtIHRoaXMuc2VsZWN0QW5zd2VyLmdldERhdGUoKS5nZXRUaW1lKCkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybnMgdHJ1ZSBpZiB0aGVyZSBhcmUgb25seSBldmVudHMgZnJvbSB0aGUgb3RoZXIgc2lkZSAtIHdlIG1pc3NlZCB0aGUgY2FsbFxuICAgICAqL1xuICAgIHByaXZhdGUgZ2V0IGNhbGxXYXNNaXNzZWQoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAhWy4uLnRoaXMuZXZlbnRzXS5zb21lKChldmVudCkgPT4gZXZlbnQuc2VuZGVyPy51c2VySWQgPT09IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRVc2VySWQoKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXQgY2FsbElkKCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgICAgIHJldHVybiBbLi4udGhpcy5ldmVudHNdWzBdPy5nZXRDb250ZW50KCk/LmNhbGxfaWQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXQgcm9vbUlkKCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgICAgIHJldHVybiBbLi4udGhpcy5ldmVudHNdWzBdPy5nZXRSb29tSWQoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uU2lsZW5jZWRDYWxsc0NoYW5nZWQgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IG5ld1N0YXRlID0gQ2FsbEhhbmRsZXIuc2hhcmVkSW5zdGFuY2UoKS5pc0NhbGxTaWxlbmNlZCh0aGlzLmNhbGxJZCk7XG4gICAgICAgIHRoaXMuZW1pdChDYWxsRXZlbnRHcm91cGVyRXZlbnQuU2lsZW5jZWRDaGFuZ2VkLCBuZXdTdGF0ZSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25MZW5ndGhDaGFuZ2VkID0gKGxlbmd0aDogbnVtYmVyKTogdm9pZCA9PiB7XG4gICAgICAgIHRoaXMuZW1pdChDYWxsRXZlbnRHcm91cGVyRXZlbnQuTGVuZ3RoQ2hhbmdlZCwgbGVuZ3RoKTtcbiAgICB9O1xuXG4gICAgcHVibGljIGFuc3dlckNhbGwgPSAoKSA9PiB7XG4gICAgICAgIGRlZmF1bHREaXNwYXRjaGVyLmRpc3BhdGNoKHtcbiAgICAgICAgICAgIGFjdGlvbjogJ2Fuc3dlcicsXG4gICAgICAgICAgICByb29tX2lkOiB0aGlzLnJvb21JZCxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHB1YmxpYyByZWplY3RDYWxsID0gKCkgPT4ge1xuICAgICAgICBkZWZhdWx0RGlzcGF0Y2hlci5kaXNwYXRjaCh7XG4gICAgICAgICAgICBhY3Rpb246ICdyZWplY3QnLFxuICAgICAgICAgICAgcm9vbV9pZDogdGhpcy5yb29tSWQsXG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBwdWJsaWMgY2FsbEJhY2sgPSAoKSA9PiB7XG4gICAgICAgIGRlZmF1bHREaXNwYXRjaGVyLmRpc3BhdGNoKHtcbiAgICAgICAgICAgIGFjdGlvbjogJ3BsYWNlX2NhbGwnLFxuICAgICAgICAgICAgdHlwZTogdGhpcy5pc1ZvaWNlID8gQ2FsbFR5cGUuVm9pY2UgOiBDYWxsVHlwZS5WaWRlbyxcbiAgICAgICAgICAgIHJvb21faWQ6IHRoaXMucm9vbUlkLFxuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgcHVibGljIHRvZ2dsZVNpbGVuY2VkID0gKCkgPT4ge1xuICAgICAgICBjb25zdCBzaWxlbmNlZCA9IENhbGxIYW5kbGVyLnNoYXJlZEluc3RhbmNlKCkuaXNDYWxsU2lsZW5jZWQodGhpcy5jYWxsSWQpO1xuICAgICAgICBzaWxlbmNlZCA/XG4gICAgICAgICAgICBDYWxsSGFuZGxlci5zaGFyZWRJbnN0YW5jZSgpLnVuU2lsZW5jZUNhbGwodGhpcy5jYWxsSWQpIDpcbiAgICAgICAgICAgIENhbGxIYW5kbGVyLnNoYXJlZEluc3RhbmNlKCkuc2lsZW5jZUNhbGwodGhpcy5jYWxsSWQpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIHNldENhbGxMaXN0ZW5lcnMoKSB7XG4gICAgICAgIGlmICghdGhpcy5jYWxsKSByZXR1cm47XG4gICAgICAgIHRoaXMuY2FsbC5hZGRMaXN0ZW5lcihDYWxsRXZlbnQuU3RhdGUsIHRoaXMuc2V0U3RhdGUpO1xuICAgICAgICB0aGlzLmNhbGwuYWRkTGlzdGVuZXIoQ2FsbEV2ZW50Lkxlbmd0aENoYW5nZWQsIHRoaXMub25MZW5ndGhDaGFuZ2VkKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNldFN0YXRlID0gKCkgPT4ge1xuICAgICAgICBpZiAoQ09OTkVDVElOR19TVEFURVMuaW5jbHVkZXModGhpcy5jYWxsPy5zdGF0ZSkpIHtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSBDYWxsU3RhdGUuQ29ubmVjdGluZztcbiAgICAgICAgfSBlbHNlIGlmIChTVVBQT1JURURfU1RBVEVTLmluY2x1ZGVzKHRoaXMuY2FsbD8uc3RhdGUpKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXRlID0gdGhpcy5jYWxsLnN0YXRlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKHRoaXMuY2FsbFdhc01pc3NlZCkgdGhpcy5zdGF0ZSA9IEN1c3RvbUNhbGxTdGF0ZS5NaXNzZWQ7XG4gICAgICAgICAgICBlbHNlIGlmICh0aGlzLnJlamVjdCkgdGhpcy5zdGF0ZSA9IENhbGxTdGF0ZS5FbmRlZDtcbiAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuaGFuZ3VwKSB0aGlzLnN0YXRlID0gQ2FsbFN0YXRlLkVuZGVkO1xuICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5pbnZpdGUgJiYgdGhpcy5jYWxsKSB0aGlzLnN0YXRlID0gQ2FsbFN0YXRlLkNvbm5lY3Rpbmc7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5lbWl0KENhbGxFdmVudEdyb3VwZXJFdmVudC5TdGF0ZUNoYW5nZWQsIHRoaXMuc3RhdGUpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIHNldENhbGwgPSAoKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLmNhbGwpIHJldHVybjtcblxuICAgICAgICB0aGlzLmNhbGwgPSBDYWxsSGFuZGxlci5zaGFyZWRJbnN0YW5jZSgpLmdldENhbGxCeUlkKHRoaXMuY2FsbElkKTtcbiAgICAgICAgdGhpcy5zZXRDYWxsTGlzdGVuZXJzKCk7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoKTtcbiAgICB9O1xuXG4gICAgcHVibGljIGFkZChldmVudDogTWF0cml4RXZlbnQpIHtcbiAgICAgICAgdGhpcy5ldmVudHMuYWRkKGV2ZW50KTtcbiAgICAgICAgdGhpcy5zZXRDYWxsKCk7XG4gICAgfVxufVxuIl19