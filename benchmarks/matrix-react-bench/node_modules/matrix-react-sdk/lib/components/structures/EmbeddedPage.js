"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _browserRequest = _interopRequireDefault(require("browser-request"));

var _languageHandler = require("../../languageHandler");

var _sanitizeHtml = _interopRequireDefault(require("sanitize-html"));

var _dispatcher = _interopRequireDefault(require("../../dispatcher/dispatcher"));

var _MatrixClientPeg = require("../../MatrixClientPeg");

var _classnames = _interopRequireDefault(require("classnames"));

var _MatrixClientContext = _interopRequireDefault(require("../../contexts/MatrixClientContext"));

var _AutoHideScrollbar = _interopRequireDefault(require("./AutoHideScrollbar"));

var _logger = require("matrix-js-sdk/src/logger");

/*
Copyright 2016 OpenMarket Ltd
Copyright 2017 Vector Creations Ltd
Copyright 2019 New Vector Ltd

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
class EmbeddedPage extends _react.default.PureComponent {
  constructor(props, context) {
    super(props, context);
    (0, _defineProperty2.default)(this, "unmounted", false);
    (0, _defineProperty2.default)(this, "dispatcherRef", null);
    (0, _defineProperty2.default)(this, "onAction", payload => {
      // HACK: Workaround for the context's MatrixClient not being set up at render time.
      if (payload.action === 'client_started') {
        this.forceUpdate();
      }
    });
    this.state = {
      page: ''
    };
  }

  translate(s) {
    // default implementation - skins may wish to extend this
    return (0, _sanitizeHtml.default)((0, _languageHandler._t)(s));
  }

  componentDidMount() {
    this.unmounted = false;

    if (!this.props.url) {
      return;
    } // we use request() to inline the page into the react component
    // so that it can inherit CSS and theming easily rather than mess around
    // with iframes and trying to synchronise document.stylesheets.


    (0, _browserRequest.default)({
      method: "GET",
      url: this.props.url
    }, (err, response, body) => {
      if (this.unmounted) {
        return;
      }

      if (err || response.status < 200 || response.status >= 300) {
        _logger.logger.warn(`Error loading page: ${err}`);

        this.setState({
          page: (0, _languageHandler._t)("Couldn't load page")
        });
        return;
      }

      body = body.replace(/_t\(['"]([\s\S]*?)['"]\)/mg, (match, g1) => this.translate(g1));

      if (this.props.replaceMap) {
        Object.keys(this.props.replaceMap).forEach(key => {
          body = body.split(key).join(this.props.replaceMap[key]);
        });
      }

      this.setState({
        page: body
      });
    });
    this.dispatcherRef = _dispatcher.default.register(this.onAction);
  }

  componentWillUnmount() {
    this.unmounted = true;
    if (this.dispatcherRef !== null) _dispatcher.default.unregister(this.dispatcherRef);
  }

  render() {
    // HACK: Workaround for the context's MatrixClient not updating.
    const client = this.context || _MatrixClientPeg.MatrixClientPeg.get();

    const isGuest = client ? client.isGuest() : true;
    const className = this.props.className;
    const classes = (0, _classnames.default)({
      [className]: true,
      [`${className}_guest`]: isGuest,
      [`${className}_loggedIn`]: !!client
    });

    const content = /*#__PURE__*/_react.default.createElement("div", {
      className: `${className}_body`,
      dangerouslySetInnerHTML: {
        __html: this.state.page
      }
    });

    if (this.props.scrollbar) {
      return /*#__PURE__*/_react.default.createElement(_AutoHideScrollbar.default, {
        className: classes
      }, content);
    } else {
      return /*#__PURE__*/_react.default.createElement("div", {
        className: classes
      }, content);
    }
  }

}

exports.default = EmbeddedPage;
(0, _defineProperty2.default)(EmbeddedPage, "contextType", _MatrixClientContext.default);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3N0cnVjdHVyZXMvRW1iZWRkZWRQYWdlLnRzeCJdLCJuYW1lcyI6WyJFbWJlZGRlZFBhZ2UiLCJSZWFjdCIsIlB1cmVDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwiY29udGV4dCIsInBheWxvYWQiLCJhY3Rpb24iLCJmb3JjZVVwZGF0ZSIsInN0YXRlIiwicGFnZSIsInRyYW5zbGF0ZSIsInMiLCJjb21wb25lbnREaWRNb3VudCIsInVubW91bnRlZCIsInVybCIsIm1ldGhvZCIsImVyciIsInJlc3BvbnNlIiwiYm9keSIsInN0YXR1cyIsImxvZ2dlciIsIndhcm4iLCJzZXRTdGF0ZSIsInJlcGxhY2UiLCJtYXRjaCIsImcxIiwicmVwbGFjZU1hcCIsIk9iamVjdCIsImtleXMiLCJmb3JFYWNoIiwia2V5Iiwic3BsaXQiLCJqb2luIiwiZGlzcGF0Y2hlclJlZiIsImRpcyIsInJlZ2lzdGVyIiwib25BY3Rpb24iLCJjb21wb25lbnRXaWxsVW5tb3VudCIsInVucmVnaXN0ZXIiLCJyZW5kZXIiLCJjbGllbnQiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJpc0d1ZXN0IiwiY2xhc3NOYW1lIiwiY2xhc3NlcyIsImNvbnRlbnQiLCJfX2h0bWwiLCJzY3JvbGxiYXIiLCJNYXRyaXhDbGllbnRDb250ZXh0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWtCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQTs7QUE3QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQThCZSxNQUFNQSxZQUFOLFNBQTJCQyxlQUFNQyxhQUFqQyxDQUErRDtBQUsxRUMsRUFBQUEsV0FBVyxDQUFDQyxLQUFELEVBQWdCQyxPQUFoQixFQUFxRDtBQUM1RCxVQUFNRCxLQUFOLEVB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O0FBSE4sS0FBWCxDQUFoQjs7QUFNQSxVQUFNTSxPQUFPLGdCQUFHO0FBQUssTUFBQSxTQUFTLEVBQUcsR0FBRUYsU0FBVSxPQUE3QjtBQUNaLE1BQUEsdUJBQXVCLEVBQUU7QUFBRUcsUUFBQUEsTUFBTSxFQUFFLEtBQUt2QyxLQUFMLENBQVdDO0FBQXJCO0FBRGIsTUFBaEI7O0FBSUEsUUFBSSxLQUFLTixLQUFMLENBQVc2QyxTQUFmLEVBQTBCO0FBQ3RCLDBCQUFPLDZCQUFDLDBCQUFEO0FBQW1CLFFBQUEsU0FBUyxFQUFFSDtBQUE5QixTQUNEQyxPQURDLENBQVA7QUFHSCxLQUpELE1BSU87QUFDSCwwQkFBTztBQUFLLFFBQUEsU0FBUyxFQUFFRDtBQUFoQixTQUNEQyxPQURDLENBQVA7QUFHSDtBQUNKOztBQTdGeUU7Ozs4QkFBekQvQyxZLGlCQUNXa0QsNEIiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTYgT3Blbk1hcmtldCBMdGRcbkNvcHlyaWdodCAyMDE3IFZlY3RvciBDcmVhdGlvbnMgTHRkXG5Db3B5cmlnaHQgMjAxOSBOZXcgVmVjdG9yIEx0ZFxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgcmVxdWVzdCBmcm9tICdicm93c2VyLXJlcXVlc3QnO1xuaW1wb3J0IHsgX3QgfSBmcm9tICcuLi8uLi9sYW5ndWFnZUhhbmRsZXInO1xuaW1wb3J0IHNhbml0aXplSHRtbCBmcm9tICdzYW5pdGl6ZS1odG1sJztcbmltcG9ydCBkaXMgZnJvbSAnLi4vLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyJztcbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gJy4uLy4uL01hdHJpeENsaWVudFBlZyc7XG5pbXBvcnQgY2xhc3NuYW1lcyBmcm9tICdjbGFzc25hbWVzJztcbmltcG9ydCBNYXRyaXhDbGllbnRDb250ZXh0IGZyb20gXCIuLi8uLi9jb250ZXh0cy9NYXRyaXhDbGllbnRDb250ZXh0XCI7XG5pbXBvcnQgQXV0b0hpZGVTY3JvbGxiYXIgZnJvbSBcIi4vQXV0b0hpZGVTY3JvbGxiYXJcIjtcbmltcG9ydCB7IEFjdGlvblBheWxvYWQgfSBmcm9tIFwiLi4vLi4vZGlzcGF0Y2hlci9wYXlsb2Fkc1wiO1xuXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbG9nZ2VyXCI7XG5cbmludGVyZmFjZSBJUHJvcHMge1xuICAgIC8vIFVSTCB0byByZXF1ZXN0IGVtYmVkZGVkIHBhZ2UgY29udGVudCBmcm9tXG4gICAgdXJsPzogc3RyaW5nO1xuICAgIC8vIENsYXNzIG5hbWUgcHJlZml4IHRvIGFwcGx5IGZvciBhIGdpdmVuIGluc3RhbmNlXG4gICAgY2xhc3NOYW1lPzogc3RyaW5nO1xuICAgIC8vIFdoZXRoZXIgdG8gd3JhcCB0aGUgcGFnZSBpbiBhIHNjcm9sbGJhclxuICAgIHNjcm9sbGJhcj86IGJvb2xlYW47XG4gICAgLy8gTWFwIG9mIGtleXMgdG8gcmVwbGFjZSB3aXRoIHZhbHVlcywgZS5nIHskcGxhY2Vob2xkZXI6IFwidmFsdWVcIn1cbiAgICByZXBsYWNlTWFwPzogTWFwPHN0cmluZywgc3RyaW5nPjtcbn1cblxuaW50ZXJmYWNlIElTdGF0ZSB7XG4gICAgcGFnZTogc3RyaW5nO1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBFbWJlZGRlZFBhZ2UgZXh0ZW5kcyBSZWFjdC5QdXJlQ29tcG9uZW50PElQcm9wcywgSVN0YXRlPiB7XG4gICAgcHVibGljIHN0YXRpYyBjb250ZXh0VHlwZSA9IE1hdHJpeENsaWVudENvbnRleHQ7XG4gICAgcHJpdmF0ZSB1bm1vdW50ZWQgPSBmYWxzZTtcbiAgICBwcml2YXRlIGRpc3BhdGNoZXJSZWY6IHN0cmluZyA9IG51bGw7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wczogSVByb3BzLCBjb250ZXh0OiB0eXBlb2YgTWF0cml4Q2xpZW50Q29udGV4dCkge1xuICAgICAgICBzdXBlcihwcm9wcywgY29udGV4dCk7XG5cbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIHBhZ2U6ICcnLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByb3RlY3RlZCB0cmFuc2xhdGUoczogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgLy8gZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiAtIHNraW5zIG1heSB3aXNoIHRvIGV4dGVuZCB0aGlzXG4gICAgICAgIHJldHVybiBzYW5pdGl6ZUh0bWwoX3QocykpO1xuICAgIH1cblxuICAgIHB1YmxpYyBjb21wb25lbnREaWRNb3VudCgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy51bm1vdW50ZWQgPSBmYWxzZTtcblxuICAgICAgICBpZiAoIXRoaXMucHJvcHMudXJsKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICAvLyB3ZSB1c2UgcmVxdWVzdCgpIHRvIGlubGluZSB0aGUgcGFnZSBpbnRvIHRoZSByZWFjdCBjb21wb25lbnRcbiAgICAgICAgLy8gc28gdGhhdCBpdCBjYW4gaW5oZXJpdCBDU1MgYW5kIHRoZW1pbmcgZWFzaWx5IHJhdGhlciB0aGFuIG1lc3MgYXJvdW5kXG4gICAgICAgIC8vIHdpdGggaWZyYW1lcyBhbmQgdHJ5aW5nIHRvIHN5bmNocm9uaXNlIGRvY3VtZW50LnN0eWxlc2hlZXRzLlxuXG4gICAgICAgIHJlcXVlc3QoXG4gICAgICAgICAgICB7IG1ldGhvZDogXCJHRVRcIiwgdXJsOiB0aGlzLnByb3BzLnVybCB9LFxuICAgICAgICAgICAgKGVyciwgcmVzcG9uc2UsIGJvZHkpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy51bm1vdW50ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChlcnIgfHwgcmVzcG9uc2Uuc3RhdHVzIDwgMjAwIHx8IHJlc3BvbnNlLnN0YXR1cyA+PSAzMDApIHtcbiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm4oYEVycm9yIGxvYWRpbmcgcGFnZTogJHtlcnJ9YCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBwYWdlOiBfdChcIkNvdWxkbid0IGxvYWQgcGFnZVwiKSB9KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGJvZHkgPSBib2R5LnJlcGxhY2UoL190XFwoWydcIl0oW1xcc1xcU10qPylbJ1wiXVxcKS9tZywgKG1hdGNoLCBnMSk9PnRoaXMudHJhbnNsYXRlKGcxKSk7XG5cbiAgICAgICAgICAgICAgICBpZiAodGhpcy5wcm9wcy5yZXBsYWNlTWFwKSB7XG4gICAgICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKHRoaXMucHJvcHMucmVwbGFjZU1hcCkuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgYm9keSA9IGJvZHkuc3BsaXQoa2V5KS5qb2luKHRoaXMucHJvcHMucmVwbGFjZU1hcFtrZXldKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IHBhZ2U6IGJvZHkgfSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICApO1xuXG4gICAgICAgIHRoaXMuZGlzcGF0Y2hlclJlZiA9IGRpcy5yZWdpc3Rlcih0aGlzLm9uQWN0aW9uKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY29tcG9uZW50V2lsbFVubW91bnQoKTogdm9pZCB7XG4gICAgICAgIHRoaXMudW5tb3VudGVkID0gdHJ1ZTtcbiAgICAgICAgaWYgKHRoaXMuZGlzcGF0Y2hlclJlZiAhPT0gbnVsbCkgZGlzLnVucmVnaXN0ZXIodGhpcy5kaXNwYXRjaGVyUmVmKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uQWN0aW9uID0gKHBheWxvYWQ6IEFjdGlvblBheWxvYWQpOiB2b2lkID0+IHtcbiAgICAgICAgLy8gSEFDSzogV29ya2Fyb3VuZCBmb3IgdGhlIGNvbnRleHQncyBNYXRyaXhDbGllbnQgbm90IGJlaW5nIHNldCB1cCBhdCByZW5kZXIgdGltZS5cbiAgICAgICAgaWYgKHBheWxvYWQuYWN0aW9uID09PSAnY2xpZW50X3N0YXJ0ZWQnKSB7XG4gICAgICAgICAgICB0aGlzLmZvcmNlVXBkYXRlKCk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHVibGljIHJlbmRlcigpOiBKU1guRWxlbWVudCB7XG4gICAgICAgIC8vIEhBQ0s6IFdvcmthcm91bmQgZm9yIHRoZSBjb250ZXh0J3MgTWF0cml4Q2xpZW50IG5vdCB1cGRhdGluZy5cbiAgICAgICAgY29uc3QgY2xpZW50ID0gdGhpcy5jb250ZXh0IHx8IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICAgICAgY29uc3QgaXNHdWVzdCA9IGNsaWVudCA/IGNsaWVudC5pc0d1ZXN0KCkgOiB0cnVlO1xuICAgICAgICBjb25zdCBjbGFzc05hbWUgPSB0aGlzLnByb3BzLmNsYXNzTmFtZTtcbiAgICAgICAgY29uc3QgY2xhc3NlcyA9IGNsYXNzbmFtZXMoe1xuICAgICAgICAgICAgW2NsYXNzTmFtZV06IHRydWUsXG4gICAgICAgICAgICBbYCR7Y2xhc3NOYW1lfV9ndWVzdGBdOiBpc0d1ZXN0LFxuICAgICAgICAgICAgW2Ake2NsYXNzTmFtZX1fbG9nZ2VkSW5gXTogISFjbGllbnQsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGNvbnRlbnQgPSA8ZGl2IGNsYXNzTmFtZT17YCR7Y2xhc3NOYW1lfV9ib2R5YH1cbiAgICAgICAgICAgIGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MPXt7IF9faHRtbDogdGhpcy5zdGF0ZS5wYWdlIH19XG4gICAgICAgIC8+O1xuXG4gICAgICAgIGlmICh0aGlzLnByb3BzLnNjcm9sbGJhcikge1xuICAgICAgICAgICAgcmV0dXJuIDxBdXRvSGlkZVNjcm9sbGJhciBjbGFzc05hbWU9e2NsYXNzZXN9PlxuICAgICAgICAgICAgICAgIHsgY29udGVudCB9XG4gICAgICAgICAgICA8L0F1dG9IaWRlU2Nyb2xsYmFyPjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiA8ZGl2IGNsYXNzTmFtZT17Y2xhc3Nlc30+XG4gICAgICAgICAgICAgICAgeyBjb250ZW50IH1cbiAgICAgICAgICAgIDwvZGl2PjtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==