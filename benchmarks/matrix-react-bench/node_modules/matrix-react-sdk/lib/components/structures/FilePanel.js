"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _filter = require("matrix-js-sdk/src/filter");

var _MatrixClientPeg = require("../../MatrixClientPeg");

var _EventIndexPeg = _interopRequireDefault(require("../../indexing/EventIndexPeg"));

var _languageHandler = require("../../languageHandler");

var _BaseCard = _interopRequireDefault(require("../views/right_panel/BaseCard"));

var _RightPanelStorePhases = require("../../stores/RightPanelStorePhases");

var _DesktopBuildsNotice = _interopRequireWildcard(require("../views/elements/DesktopBuildsNotice"));

var _replaceableComponent = require("../../utils/replaceableComponent");

var _TimelinePanel = _interopRequireDefault(require("./TimelinePanel"));

var _Spinner = _interopRequireDefault(require("../views/elements/Spinner"));

var _EventTile = require("../views/rooms/EventTile");

var _Layout = require("../../settings/enums/Layout");

var _RoomContext = _interopRequireWildcard(require("../../contexts/RoomContext"));

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class, _class2, _temp;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

/*
 * Component which shows the filtered file using a TimelinePanel
 */
let FilePanel = (_dec = (0, _replaceableComponent.replaceableComponent)("structures.FilePanel"), _dec(_class = (_temp = _class2 = class FilePanel extends _react.default.Component {
  constructor(...args) {
    super(...args);
    (0, _defineProperty2.default)(this, "decryptingEvents", new Set());
    (0, _defineProperty2.default)(this, "noRoom", void 0);
    (0, _defineProperty2.default)(this, "state", {
      timelineSet: null
    });
    (0, _defineProperty2.default)(this, "onRoomTimeline", (ev, room, toStartOfTimeline, removed, data) => {
      var _this$props;

      if ((room === null || room === void 0 ? void 0 : room.roomId) !== ((_this$props = this.props) === null || _this$props === void 0 ? void 0 : _this$props.roomId)) return;
      if (toStartOfTimeline || !data || !data.liveEvent || ev.isRedacted()) return;

      const client = _MatrixClientPeg.MatrixClientPeg.get();

      client.decryptEventIfNeeded(ev);

      if (ev.isBeingDecrypted()) {
        this.decryptingEvents.add(ev.getId());
      } else {
        this.addEncryptedLiveEvent(ev);
      }
    });
    (0, _defineProperty2.default)(this, "onEventDecrypted", (ev, err) => {
      if (ev.getRoomId() !== this.props.roomId) return;
      const eventId = ev.getId();
      if (!this.decryptingEvents.delete(eventId)) return;
      if (err) return;
      this.addEncryptedLiveEvent(ev);
    });
    (0, _defineProperty2.default)(this, "onPaginationRequest", (timelineWindow, direction, limit) => {
      const client = _MatrixClientPeg.MatrixClientPeg.get();

      const eventIndex = _EventIndexPeg.default.get();

      const roomId = this.props.roomId;
      const room = client.getRoom(roomId); // We override the pagination request for encrypted rooms so that we ask
      // the event index to fulfill the pagination request. Asking the server
      // to paginate won't ever work since the server can't correctly filter
      // out events containing URLs

      if (client.isRoomEncrypted(roomId) && eventIndex !== null) {
        return eventIndex.paginateTimelineWindow(room, timelineWindow, direction, limit);
      } else {
        return timelineWindow.paginate(direction, limit);
      }
    });
  }

  addEncryptedLiveEvent(ev) {
    if (!this.state.timelineSet) return;
    const timeline = this.state.timelineSet.getLiveTimeline();
    if (ev.getType() !== "m.room.message") return;

    if (["m.file", "m.image", "m.video", "m.audio"].indexOf(ev.getContent().msgtype) == -1) {
      return;
    }

    if (!this.state.timelineSet.eventIdToTimeline(ev.getId())) {
      this.state.timelineSet.addEventToTimeline(ev, timeline, false);
    }
  }

  async componentDidMount() {
    const client = _MatrixClientPeg.MatrixClientPeg.get();

    await this.updateTimelineSet(this.props.roomId);
    if (!_MatrixClientPeg.MatrixClientPeg.get().isRoomEncrypted(this.props.roomId)) return; // The timelineSets filter makes sure that encrypted events that contain
    // URLs never get added to the timeline, even if they are live events.
    // These methods are here to manually listen for such events and add
    // them despite the filter's best efforts.
    //
    // We do this only for encrypted rooms and if an event index exists,
    // this could be made more general in the future or the filter logic
    // could be fixed.

    if (_EventIndexPeg.default.get() !== null) {
      client.on('Room.timeline', this.onRoomTimeline);
      client.on('Event.decrypted', this.onEventDecrypted);
    }
  }

  componentWillUnmount() {
    const client = _MatrixClientPeg.MatrixClientPeg.get();

    if (client === null) return;
    if (!_MatrixClientPeg.MatrixClientPeg.get().isRoomEncrypted(this.props.roomId)) return;

    if (_EventIndexPeg.default.get() !== null) {
      client.removeListener('Room.timeline', this.onRoomTimeline);
      client.removeListener('Event.decrypted', this.onEventDecrypted);
    }
  }

  async fetchFileEventsServer(room) {
    const client = _MatrixClientPeg.MatrixClientPeg.get();

    const filter = new _filter.Filter(client.credentials.userId);
    filter.setDefinition({
      "room": {
        "timeline": {
          "contains_url": true,
          "types": ["m.room.message"]
        }
      }
    });
    const filterId = await client.getOrCreateFilter("FILTER_FILES_" + client.credentials.userId, filter);
    filter.filterId = filterId;
    const timelineSet = room.getOrCreateFilteredTimelineSet(filter);
    return timelineSet;
  }

  async updateTimelineSet(roomId) {
    const client = _MatrixClientPeg.MatrixClientPeg.get();

    const room = client.getRoom(roomId);

    const eventIndex = _EventIndexPeg.default.get();

    this.noRoom = !room;

    if (room) {
      let timelineSet;

      try {
        timelineSet = await this.fetchFileEventsServer(room); // If this room is encrypted the file panel won't be populated
        // correctly since the defined filter doesn't support encrypted
        // events and the server can't check if encrypted events contain
        // URLs.
        //
        // This is where our event index comes into place, we ask the
        // event index to populate the timelineSet for us. This call
        // will add 10 events to the live timeline of the set. More can
        // be requested using pagination.

        if (client.isRoomEncrypted(roomId) && eventIndex !== null) {
          const timeline = timelineSet.getLiveTimeline();
          await eventIndex.populateFileTimeline(timelineSet, timeline, room, 10);
        }

        this.setState({
          timelineSet: timelineSet
        });
      } catch (error) {
        _logger.logger.error("Failed to get or create file panel filter", error);
      }
    } else {
      _logger.logger.error("Failed to add filtered timelineSet for FilePanel as no room!");
    }
  }

  render() {
    if (_MatrixClientPeg.MatrixClientPeg.get().isGuest()) {
      return /*#__PURE__*/_react.default.createElement(_BaseCard.default, {
        className: "mx_FilePanel mx_RoomView_messageListWrapper",
        onClose: this.props.onClose,
        previousPhase: _RightPanelStorePhases.RightPanelPhases.RoomSummary
      }, /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_RoomView_empty"
      }, (0, _languageHandler._t)("You must <a>register</a> to use this functionality", {}, {
        'a': sub => /*#__PURE__*/_react.default.createElement("a", {
          href: "#/register",
          key: "sub"
        }, sub)
      })));
    } else if (this.noRoom) {
      return /*#__PURE__*/_react.default.createElement(_BaseCard.default, {
        className: "mx_FilePanel mx_RoomView_messageListWrapper",
        onClose: this.props.onClose,
        previousPhase: _RightPanelStorePhases.RightPanelPhases.RoomSummary
      }, /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_RoomView_empty"
      }, (0, _languageHandler._t)("You must join the room to see its files")));
    } // wrap a TimelinePanel with the jump-to-event bits turned off.


    const emptyState = /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_RightPanel_empty mx_FilePanel_empty"
    }, /*#__PURE__*/_react.default.createElement("h2", null, (0, _languageHandler._t)('No files visible in this room')), /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)('Attach files from chat or just drag and drop them anywhere in a room.')));

    const isRoomEncrypted = this.noRoom ? false : _MatrixClientPeg.MatrixClientPeg.get().isRoomEncrypted(this.props.roomId);

    if (this.state.timelineSet) {
      return /*#__PURE__*/_react.default.createElement(_RoomContext.default.Provider, {
        value: _objectSpread(_objectSpread({}, this.context), {}, {
          timelineRenderingType: _RoomContext.TimelineRenderingType.File
        })
      }, /*#__PURE__*/_react.default.createElement(_BaseCard.default, {
        className: "mx_FilePanel",
        onClose: this.props.onClose,
        previousPhase: _RightPanelStorePhases.RightPanelPhases.RoomSummary,
        withoutScrollContainer: true
      }, /*#__PURE__*/_react.default.createElement(_DesktopBuildsNotice.default, {
        isRoomEncrypted: isRoomEncrypted,
        kind: _DesktopBuildsNotice.WarningKind.Files
      }), /*#__PURE__*/_react.default.createElement(_TimelinePanel.default, {
        manageReadReceipts: false,
        manageReadMarkers: false,
        timelineSet: this.state.timelineSet,
        showUrlPreview: false,
        onPaginationRequest: this.onPaginationRequest,
        tileShape: _EventTile.TileShape.FileGrid,
        resizeNotifier: this.props.resizeNotifier,
        empty: emptyState,
        layout: _Layout.Layout.Group
      })));
    } else {
      return /*#__PURE__*/_react.default.createElement(_RoomContext.default.Provider, {
        value: _objectSpread(_objectSpread({}, this.context), {}, {
          timelineRenderingType: _RoomContext.TimelineRenderingType.File
        })
      }, /*#__PURE__*/_react.default.createElement(_BaseCard.default, {
        className: "mx_FilePanel",
        onClose: this.props.onClose,
        previousPhase: _RightPanelStorePhases.RightPanelPhases.RoomSummary
      }, /*#__PURE__*/_react.default.createElement(_Spinner.default, null)));
    }
  }

}, (0, _defineProperty2.default)(_class2, "contextType", _RoomContext.default), _temp)) || _class);
var _default = FilePanel;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3N0cnVjdHVyZXMvRmlsZVBhbmVsLnRzeCJdLCJuYW1lcyI6WyJGaWxlUGFuZWwiLCJSZWFjdCIsIkNvbXBvbmVudCIsIlNldCIsInRpbWVsaW5lU2V0IiwiZXYiLCJyb29tIiwidG9TdGFydE9mVGltZWxpbmUiLCJyZW1vdmVkIiwiZGF0YSIsInJvb21JZCIsInByb3BzIiwibGl2ZUV2ZW50IiwiaXNSZWRhY3RlZCIsImNsaWVudCIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsImRlY3J5cHRFdmVudElmTmVlZGVkIiwiaXNCZWluZ0RlY3J5cHRlZCIsImRlY3J5cHRpbmdFdmVudHMiLCJhZGQiLCJnZXRJZCIsImFkZEVuY3J5cHRlZExpdmVFdmVudCIsImVyciIsImdldFJvb21JZCIsImV2ZW50SWQiLCJkZWxldGUiLCJ0aW1lbGluZVdpbmRvdyIsImRpcmVjdGlvbiIsImxpbWl0IiwiZXZlbnRJbmRleCIsIkV2ZW50SW5kZXhQZWciLCJnZXRSb29tIiwiaXNSb29tRW5jcnlwdGVkIiwicGFnaW5hdGVUaW1lbGluZVdpbmRvdyIsInBhZ2luYXRlIiwic3RhdGUiLCJ0aW1lbGluZSIsImdldExpdmVUaW1lbGluZSIsImdldFR5cGUiLCJpbmRleE9mIiwiZ2V0Q29udGVudCIsIm1zZ3R5cGUiLCJldmVudElkVG9UaW1lbGluZSIsImFkZEV2ZW50VG9UaW1lbGluZSIsImNvbXBvbmVudERpZE1vdW50IiwidXBkYXRlVGltZWxpbmVTZXQiLCJvbiIsIm9uUm9vbVRpbWVsaW5lIiwib25FdmVudERlY3J5cHRlZCIsImNvbXBvbmVudFdpbGxVbm1vdW50IiwicmVtb3ZlTGlzdGVuZXIiLCJmZXRjaEZpbGVFdmVudHNTZXJ2ZXIiLCJmaWx0ZXIiLCJGaWx0ZXIiLCJjcmVkZW50aWFscyIsInVzZXJJZCIsInNldERlZmluaXRpb24iLCJmaWx0ZXJJZCIsImdldE9yQ3JlYXRlRmlsdGVyIiwiZ2V0T3JDcmVhdGVGaWx0ZXJlZFRpbWVsaW5lU2V0Iiwibm9Sb29tIiwicG9wdWxhdGVGaWxlVGltZWxpbmUiLCJzZXRTdGF0ZSIsImVycm9yIiwibG9nZ2VyIiwicmVuZGVyIiwiaXNHdWVzdCIsIm9uQ2xvc2UiLCJSaWdodFBhbmVsUGhhc2VzIiwiUm9vbVN1bW1hcnkiLCJzdWIiLCJlbXB0eVN0YXRlIiwiY29udGV4dCIsInRpbWVsaW5lUmVuZGVyaW5nVHlwZSIsIlRpbWVsaW5lUmVuZGVyaW5nVHlwZSIsIkZpbGUiLCJXYXJuaW5nS2luZCIsIkZpbGVzIiwib25QYWdpbmF0aW9uUmVxdWVzdCIsIlRpbGVTaGFwZSIsIkZpbGVHcmlkIiwicmVzaXplTm90aWZpZXIiLCJMYXlvdXQiLCJHcm91cCIsIlJvb21Db250ZXh0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWlCQTs7QUFFQTs7QUFPQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7Ozs7Ozs7Ozs7O0FBWUE7QUFDQTtBQUNBO0lBRU1BLFMsV0FETCxnREFBcUIsc0JBQXJCLEMsbUNBQUQsTUFDTUEsU0FETixTQUN3QkMsZUFBTUMsU0FEOUIsQ0FDd0Q7QUFBQTtBQUFBO0FBQUEsNERBR3pCLElBQUlDLEdBQUosRUFIeUI7QUFBQTtBQUFBLGlEQU81QztBQUNKQyxNQUFBQSxXQUFXLEVBQUU7QUFEVCxLQVA0QztBQUFBLDBEQVczQixDQUFDQyxFQUFELEVBQWtCQyxJQUFsQixFQUE4QkMsaUJBQTlCLEVBQXVEQyxPQUF2RCxFQUFzRUMsSUFBdEUsS0FBMEY7QUFBQTs7QUFDL0csVUFBSSxDQUFBSCxJQUFJLFNBQUosSUFBQUEsSUFBSSxXQUFKLFlBQUFBLElBQUksQ0FBRUksTUFBTixzQkFBaUIsS0FBS0MsS0FBdEIsZ0RBQWlCLFlBQVlELE1BQTdCLENBQUosRUFBeUM7QUFDekMsVUFBSUgsaUJBQWlCLElBQUksQ0FBQ0UsSUFBdEIsSUFBOEIsQ0FBQ0EsSUFBSSxDQUFDRyxTQUFw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QUFBQSxxQkFBcUIsRUFBRUMsbUNBQXNCQztBQUZ0QjtBQUEzQixzQkFJSSw2QkFBQyxpQkFBRDtBQUNJLFFBQUEsU0FBUyxFQUFDLGNBRGQ7QUFFSSxRQUFBLE9BQU8sRUFBRSxLQUFLakUsS0FBTCxDQUFXeUQsT0FGeEI7QUFHSSxRQUFBLGFBQWEsRUFBRUMsd0NBQWlCQztBQUhwQyxzQkFLSSw2QkFBQyxnQkFBRCxPQUxKLENBSkosQ0FESjtBQWNIO0FBQ0o7O0FBaFBtRCxDLHdEQUsvQmUsb0I7ZUE4T1ZyRixTIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE2IE9wZW5NYXJrZXQgTHRkXG5Db3B5cmlnaHQgMjAxOSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5cbmltcG9ydCB7IEZpbHRlciB9IGZyb20gJ21hdHJpeC1qcy1zZGsvc3JjL2ZpbHRlcic7XG5pbXBvcnQgeyBFdmVudFRpbWVsaW5lU2V0IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9ldmVudC10aW1lbGluZS1zZXRcIjtcbmltcG9ydCB7IERpcmVjdGlvbiB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvZXZlbnQtdGltZWxpbmVcIjtcbmltcG9ydCB7IE1hdHJpeEV2ZW50IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9ldmVudFwiO1xuaW1wb3J0IHsgUm9vbSB9IGZyb20gJ21hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yb29tJztcbmltcG9ydCB7IFRpbWVsaW5lV2luZG93IH0gZnJvbSAnbWF0cml4LWpzLXNkay9zcmMvdGltZWxpbmUtd2luZG93JztcblxuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSAnLi4vLi4vTWF0cml4Q2xpZW50UGVnJztcbmltcG9ydCBFdmVudEluZGV4UGVnIGZyb20gXCIuLi8uLi9pbmRleGluZy9FdmVudEluZGV4UGVnXCI7XG5pbXBvcnQgeyBfdCB9IGZyb20gJy4uLy4uL2xhbmd1YWdlSGFuZGxlcic7XG5pbXBvcnQgQmFzZUNhcmQgZnJvbSBcIi4uL3ZpZXdzL3JpZ2h0X3BhbmVsL0Jhc2VDYXJkXCI7XG5pbXBvcnQgeyBSaWdodFBhbmVsUGhhc2VzIH0gZnJvbSBcIi4uLy4uL3N0b3Jlcy9SaWdodFBhbmVsU3RvcmVQaGFzZXNcIjtcbmltcG9ydCBEZXNrdG9wQnVpbGRzTm90aWNlLCB7IFdhcm5pbmdLaW5kIH0gZnJvbSBcIi4uL3ZpZXdzL2VsZW1lbnRzL0Rlc2t0b3BCdWlsZHNOb3RpY2VcIjtcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5cbmltcG9ydCBSZXNpemVOb3RpZmllciBmcm9tICcuLi8uLi91dGlscy9SZXNpemVOb3RpZmllcic7XG5pbXBvcnQgVGltZWxpbmVQYW5lbCBmcm9tIFwiLi9UaW1lbGluZVBhbmVsXCI7XG5pbXBvcnQgU3Bpbm5lciBmcm9tIFwiLi4vdmlld3MvZWxlbWVudHMvU3Bpbm5lclwiO1xuaW1wb3J0IHsgVGlsZVNoYXBlIH0gZnJvbSAnLi4vdmlld3Mvcm9vbXMvRXZlbnRUaWxlJztcbmltcG9ydCB7IExheW91dCB9IGZyb20gXCIuLi8uLi9zZXR0aW5ncy9lbnVtcy9MYXlvdXRcIjtcbmltcG9ydCBSb29tQ29udGV4dCwgeyBUaW1lbGluZVJlbmRlcmluZ1R5cGUgfSBmcm9tICcuLi8uLi9jb250ZXh0cy9Sb29tQ29udGV4dCc7XG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcblxuaW50ZXJmYWNlIElQcm9wcyB7XG4gICAgcm9vbUlkOiBzdHJpbmc7XG4gICAgb25DbG9zZTogKCkgPT4gdm9pZDtcbiAgICByZXNpemVOb3RpZmllcjogUmVzaXplTm90aWZpZXI7XG59XG5cbmludGVyZmFjZSBJU3RhdGUge1xuICAgIHRpbWVsaW5lU2V0OiBFdmVudFRpbWVsaW5lU2V0O1xufVxuXG4vKlxuICogQ29tcG9uZW50IHdoaWNoIHNob3dzIHRoZSBmaWx0ZXJlZCBmaWxlIHVzaW5nIGEgVGltZWxpbmVQYW5lbFxuICovXG5AcmVwbGFjZWFibGVDb21wb25lbnQoXCJzdHJ1Y3R1cmVzLkZpbGVQYW5lbFwiKVxuY2xhc3MgRmlsZVBhbmVsIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PElQcm9wcywgSVN0YXRlPiB7XG4gICAgLy8gVGhpcyBpcyB1c2VkIHRvIHRyYWNrIGlmIGEgZGVjcnlwdGVkIGV2ZW50IHdhcyBhIGxpdmUgZXZlbnQgYW5kIHNob3VsZCBiZVxuICAgIC8vIGFkZGVkIHRvIHRoZSB0aW1lbGluZS5cbiAgICBwcml2YXRlIGRlY3J5cHRpbmdFdmVudHMgPSBuZXcgU2V0PHN0cmluZz4oKTtcbiAgICBwdWJsaWMgbm9Sb29tOiBib29sZWFuO1xuICAgIHN0YXRpYyBjb250ZXh0VHlwZSA9IFJvb21Db250ZXh0O1xuXG4gICAgc3RhdGUgPSB7XG4gICAgICAgIHRpbWVsaW5lU2V0OiBudWxsLFxuICAgIH07XG5cbiAgICBwcml2YXRlIG9uUm9vbVRpbWVsaW5lID0gKGV2OiBNYXRyaXhFdmVudCwgcm9vbTogUm9vbSwgdG9TdGFydE9mVGltZWxpbmU6IHRydWUsIHJlbW92ZWQ6IHRydWUsIGRhdGE6IGFueSk6IHZvaWQgPT4ge1xuICAgICAgICBpZiAocm9vbT8ucm9vbUlkICE9PSB0aGlzLnByb3BzPy5yb29tSWQpIHJldHVybjtcbiAgICAgICAgaWYgKHRvU3RhcnRPZlRpbWVsaW5lIHx8ICFkYXRhIHx8ICFkYXRhLmxpdmVFdmVudCB8fCBldi5pc1JlZGFjdGVkKCkpIHJldHVybjtcblxuICAgICAgICBjb25zdCBjbGllbnQgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIGNsaWVudC5kZWNyeXB0RXZlbnRJZk5lZWRlZChldik7XG5cbiAgICAgICAgaWYgKGV2LmlzQmVpbmdEZWNyeXB0ZWQoKSkge1xuICAgICAgICAgICAgdGhpcy5kZWNyeXB0aW5nRXZlbnRzLmFkZChldi5nZXRJZCgpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuYWRkRW5jcnlwdGVkTGl2ZUV2ZW50KGV2KTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwcml2YXRlIG9uRXZlbnREZWNyeXB0ZWQgPSAoZXY6IE1hdHJpeEV2ZW50LCBlcnI/OiBhbnkpOiB2b2lkID0+IHtcbiAgICAgICAgaWYgKGV2LmdldFJvb21JZCgpICE9PSB0aGlzLnByb3BzLnJvb21JZCkgcmV0dXJuO1xuICAgICAgICBjb25zdCBldmVudElkID0gZXYuZ2V0SWQoKTtcblxuICAgICAgICBpZiAoIXRoaXMuZGVjcnlwdGluZ0V2ZW50cy5kZWxldGUoZXZlbnRJZCkpIHJldHVybjtcbiAgICAgICAgaWYgKGVycikgcmV0dXJuO1xuXG4gICAgICAgIHRoaXMuYWRkRW5jcnlwdGVkTGl2ZUV2ZW50KGV2KTtcbiAgICB9O1xuXG4gICAgcHVibGljIGFkZEVuY3J5cHRlZExpdmVFdmVudChldjogTWF0cml4RXZlbnQpOiB2b2lkIHtcbiAgICAgICAgaWYgKCF0aGlzLnN0YXRlLnRpbWVsaW5lU2V0KSByZXR1cm47XG5cbiAgICAgICAgY29uc3QgdGltZWxpbmUgPSB0aGlzLnN0YXRlLnRpbWVsaW5lU2V0LmdldExpdmVUaW1lbGluZSgpO1xuICAgICAgICBpZiAoZXYuZ2V0VHlwZSgpICE9PSBcIm0ucm9vbS5tZXNzYWdlXCIpIHJldHVybjtcbiAgICAgICAgaWYgKFtcIm0uZmlsZVwiLCBcIm0uaW1hZ2VcIiwgXCJtLnZpZGVvXCIsIFwibS5hdWRpb1wiXS5pbmRleE9mKGV2LmdldENvbnRlbnQoKS5tc2d0eXBlKSA9PSAtMSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF0aGlzLnN0YXRlLnRpbWVsaW5lU2V0LmV2ZW50SWRUb1RpbWVsaW5lKGV2LmdldElkKCkpKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLnRpbWVsaW5lU2V0LmFkZEV2ZW50VG9UaW1lbGluZShldiwgdGltZWxpbmUsIGZhbHNlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBjb21wb25lbnREaWRNb3VudCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgY29uc3QgY2xpZW50ID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuXG4gICAgICAgIGF3YWl0IHRoaXMudXBkYXRlVGltZWxpbmVTZXQodGhpcy5wcm9wcy5yb29tSWQpO1xuXG4gICAgICAgIGlmICghTWF0cml4Q2xpZW50UGVnLmdldCgpLmlzUm9vbUVuY3J5cHRlZCh0aGlzLnByb3BzLnJvb21JZCkpIHJldHVybjtcblxuICAgICAgICAvLyBUaGUgdGltZWxpbmVTZXRzIGZpbHRlciBtYWtlcyBzdXJlIHRoYXQgZW5jcnlwdGVkIGV2ZW50cyB0aGF0IGNvbnRhaW5cbiAgICAgICAgLy8gVVJMcyBuZXZlciBnZXQgYWRkZWQgdG8gdGhlIHRpbWVsaW5lLCBldmVuIGlmIHRoZXkgYXJlIGxpdmUgZXZlbnRzLlxuICAgICAgICAvLyBUaGVzZSBtZXRob2RzIGFyZSBoZXJlIHRvIG1hbnVhbGx5IGxpc3RlbiBmb3Igc3VjaCBldmVudHMgYW5kIGFkZFxuICAgICAgICAvLyB0aGVtIGRlc3BpdGUgdGhlIGZpbHRlcidzIGJlc3QgZWZmb3J0cy5cbiAgICAgICAgLy9cbiAgICAgICAgLy8gV2UgZG8gdGhpcyBvbmx5IGZvciBlbmNyeXB0ZWQgcm9vbXMgYW5kIGlmIGFuIGV2ZW50IGluZGV4IGV4aXN0cyxcbiAgICAgICAgLy8gdGhpcyBjb3VsZCBiZSBtYWRlIG1vcmUgZ2VuZXJhbCBpbiB0aGUgZnV0dXJlIG9yIHRoZSBmaWx0ZXIgbG9naWNcbiAgICAgICAgLy8gY291bGQgYmUgZml4ZWQuXG4gICAgICAgIGlmIChFdmVudEluZGV4UGVnLmdldCgpICE9PSBudWxsKSB7XG4gICAgICAgICAgICBjbGllbnQub24oJ1Jvb20udGltZWxpbmUnLCB0aGlzLm9uUm9vbVRpbWVsaW5lKTtcbiAgICAgICAgICAgIGNsaWVudC5vbignRXZlbnQuZGVjcnlwdGVkJywgdGhpcy5vbkV2ZW50RGVjcnlwdGVkKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBjb21wb25lbnRXaWxsVW5tb3VudCgpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgY2xpZW50ID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuICAgICAgICBpZiAoY2xpZW50ID09PSBudWxsKSByZXR1cm47XG5cbiAgICAgICAgaWYgKCFNYXRyaXhDbGllbnRQZWcuZ2V0KCkuaXNSb29tRW5jcnlwdGVkKHRoaXMucHJvcHMucm9vbUlkKSkgcmV0dXJuO1xuXG4gICAgICAgIGlmIChFdmVudEluZGV4UGVnLmdldCgpICE9PSBudWxsKSB7XG4gICAgICAgICAgICBjbGllbnQucmVtb3ZlTGlzdGVuZXIoJ1Jvb20udGltZWxpbmUnLCB0aGlzLm9uUm9vbVRpbWVsaW5lKTtcbiAgICAgICAgICAgIGNsaWVudC5yZW1vdmVMaXN0ZW5lcignRXZlbnQuZGVjcnlwdGVkJywgdGhpcy5vbkV2ZW50RGVjcnlwdGVkKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBmZXRjaEZpbGVFdmVudHNTZXJ2ZXIocm9vbTogUm9vbSk6IFByb21pc2U8RXZlbnRUaW1lbGluZVNldD4ge1xuICAgICAgICBjb25zdCBjbGllbnQgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG5cbiAgICAgICAgY29uc3QgZmlsdGVyID0gbmV3IEZpbHRlcihjbGllbnQuY3JlZGVudGlhbHMudXNlcklkKTtcbiAgICAgICAgZmlsdGVyLnNldERlZmluaXRpb24oXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgXCJyb29tXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgXCJ0aW1lbGluZVwiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBcImNvbnRhaW5zX3VybFwiOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJ0eXBlc1wiOiBbXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJtLnJvb20ubWVzc2FnZVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCBmaWx0ZXJJZCA9IGF3YWl0IGNsaWVudC5nZXRPckNyZWF0ZUZpbHRlcihcIkZJTFRFUl9GSUxFU19cIiArIGNsaWVudC5jcmVkZW50aWFscy51c2VySWQsIGZpbHRlcik7XG4gICAgICAgIGZpbHRlci5maWx0ZXJJZCA9IGZpbHRlcklkO1xuICAgICAgICBjb25zdCB0aW1lbGluZVNldCA9IHJvb20uZ2V0T3JDcmVhdGVGaWx0ZXJlZFRpbWVsaW5lU2V0KGZpbHRlcik7XG5cbiAgICAgICAgcmV0dXJuIHRpbWVsaW5lU2V0O1xuICAgIH1cblxuICAgIHByaXZhdGUgb25QYWdpbmF0aW9uUmVxdWVzdCA9IChcbiAgICAgICAgdGltZWxpbmVXaW5kb3c6IFRpbWVsaW5lV2luZG93LFxuICAgICAgICBkaXJlY3Rpb246IERpcmVjdGlvbixcbiAgICAgICAgbGltaXQ6IG51bWJlcixcbiAgICApOiBQcm9taXNlPGJvb2xlYW4+ID0+IHtcbiAgICAgICAgY29uc3QgY2xpZW50ID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuICAgICAgICBjb25zdCBldmVudEluZGV4ID0gRXZlbnRJbmRleFBlZy5nZXQoKTtcbiAgICAgICAgY29uc3Qgcm9vbUlkID0gdGhpcy5wcm9wcy5yb29tSWQ7XG5cbiAgICAgICAgY29uc3Qgcm9vbSA9IGNsaWVudC5nZXRSb29tKHJvb21JZCk7XG5cbiAgICAgICAgLy8gV2Ugb3ZlcnJpZGUgdGhlIHBhZ2luYXRpb24gcmVxdWVzdCBmb3IgZW5jcnlwdGVkIHJvb21zIHNvIHRoYXQgd2UgYXNrXG4gICAgICAgIC8vIHRoZSBldmVudCBpbmRleCB0byBmdWxmaWxsIHRoZSBwYWdpbmF0aW9uIHJlcXVlc3QuIEFza2luZyB0aGUgc2VydmVyXG4gICAgICAgIC8vIHRvIHBhZ2luYXRlIHdvbid0IGV2ZXIgd29yayBzaW5jZSB0aGUgc2VydmVyIGNhbid0IGNvcnJlY3RseSBmaWx0ZXJcbiAgICAgICAgLy8gb3V0IGV2ZW50cyBjb250YWluaW5nIFVSTHNcbiAgICAgICAgaWYgKGNsaWVudC5pc1Jvb21FbmNyeXB0ZWQocm9vbUlkKSAmJiBldmVudEluZGV4ICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXR1cm4gZXZlbnRJbmRleC5wYWdpbmF0ZVRpbWVsaW5lV2luZG93KHJvb20sIHRpbWVsaW5lV2luZG93LCBkaXJlY3Rpb24sIGxpbWl0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB0aW1lbGluZVdpbmRvdy5wYWdpbmF0ZShkaXJlY3Rpb24sIGxpbWl0KTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwdWJsaWMgYXN5bmMgdXBkYXRlVGltZWxpbmVTZXQocm9vbUlkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgY29uc3QgY2xpZW50ID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuICAgICAgICBjb25zdCByb29tID0gY2xpZW50LmdldFJvb20ocm9vbUlkKTtcbiAgICAgICAgY29uc3QgZXZlbnRJbmRleCA9IEV2ZW50SW5kZXhQZWcuZ2V0KCk7XG5cbiAgICAgICAgdGhpcy5ub1Jvb20gPSAhcm9vbTtcblxuICAgICAgICBpZiAocm9vbSkge1xuICAgICAgICAgICAgbGV0IHRpbWVsaW5lU2V0O1xuXG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHRpbWVsaW5lU2V0ID0gYXdhaXQgdGhpcy5mZXRjaEZpbGVFdmVudHNTZXJ2ZXIocm9vbSk7XG5cbiAgICAgICAgICAgICAgICAvLyBJZiB0aGlzIHJvb20gaXMgZW5jcnlwdGVkIHRoZSBmaWxlIHBhbmVsIHdvbid0IGJlIHBvcHVsYXRlZFxuICAgICAgICAgICAgICAgIC8vIGNvcnJlY3RseSBzaW5jZSB0aGUgZGVmaW5lZCBmaWx0ZXIgZG9lc24ndCBzdXBwb3J0IGVuY3J5cHRlZFxuICAgICAgICAgICAgICAgIC8vIGV2ZW50cyBhbmQgdGhlIHNlcnZlciBjYW4ndCBjaGVjayBpZiBlbmNyeXB0ZWQgZXZlbnRzIGNvbnRhaW5cbiAgICAgICAgICAgICAgICAvLyBVUkxzLlxuICAgICAgICAgICAgICAgIC8vXG4gICAgICAgICAgICAgICAgLy8gVGhpcyBpcyB3aGVyZSBvdXIgZXZlbnQgaW5kZXggY29tZXMgaW50byBwbGFjZSwgd2UgYXNrIHRoZVxuICAgICAgICAgICAgICAgIC8vIGV2ZW50IGluZGV4IHRvIHBvcHVsYXRlIHRoZSB0aW1lbGluZVNldCBmb3IgdXMuIFRoaXMgY2FsbFxuICAgICAgICAgICAgICAgIC8vIHdpbGwgYWRkIDEwIGV2ZW50cyB0byB0aGUgbGl2ZSB0aW1lbGluZSBvZiB0aGUgc2V0LiBNb3JlIGNhblxuICAgICAgICAgICAgICAgIC8vIGJlIHJlcXVlc3RlZCB1c2luZyBwYWdpbmF0aW9uLlxuICAgICAgICAgICAgICAgIGlmIChjbGllbnQuaXNSb29tRW5jcnlwdGVkKHJvb21JZCkgJiYgZXZlbnRJbmRleCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB0aW1lbGluZSA9IHRpbWVsaW5lU2V0LmdldExpdmVUaW1lbGluZSgpO1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBldmVudEluZGV4LnBvcHVsYXRlRmlsZVRpbWVsaW5lKHRpbWVsaW5lU2V0LCB0aW1lbGluZSwgcm9vbSwgMTApO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyB0aW1lbGluZVNldDogdGltZWxpbmVTZXQgfSk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihcIkZhaWxlZCB0byBnZXQgb3IgY3JlYXRlIGZpbGUgcGFuZWwgZmlsdGVyXCIsIGVycm9yKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihcIkZhaWxlZCB0byBhZGQgZmlsdGVyZWQgdGltZWxpbmVTZXQgZm9yIEZpbGVQYW5lbCBhcyBubyByb29tIVwiKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyByZW5kZXIoKSB7XG4gICAgICAgIGlmIChNYXRyaXhDbGllbnRQZWcuZ2V0KCkuaXNHdWVzdCgpKSB7XG4gICAgICAgICAgICByZXR1cm4gPEJhc2VDYXJkXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfRmlsZVBhbmVsIG14X1Jvb21WaWV3X21lc3NhZ2VMaXN0V3JhcHBlclwiXG4gICAgICAgICAgICAgICAgb25DbG9zZT17dGhpcy5wcm9wcy5vbkNsb3NlfVxuICAgICAgICAgICAgICAgIHByZXZpb3VzUGhhc2U9e1JpZ2h0UGFuZWxQaGFzZXMuUm9vbVN1bW1hcnl9XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9Sb29tVmlld19lbXB0eVwiPlxuICAgICAgICAgICAgICAgICAgICB7IF90KFwiWW91IG11c3QgPGE+cmVnaXN0ZXI8L2E+IHRvIHVzZSB0aGlzIGZ1bmN0aW9uYWxpdHlcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIHt9LFxuICAgICAgICAgICAgICAgICAgICAgICAgeyAnYSc6IChzdWIpID0+IDxhIGhyZWY9XCIjL3JlZ2lzdGVyXCIga2V5PVwic3ViXCI+eyBzdWIgfTwvYT4gfSlcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgPC9CYXNlQ2FyZD47XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5ub1Jvb20pIHtcbiAgICAgICAgICAgIHJldHVybiA8QmFzZUNhcmRcbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9GaWxlUGFuZWwgbXhfUm9vbVZpZXdfbWVzc2FnZUxpc3RXcmFwcGVyXCJcbiAgICAgICAgICAgICAgICBvbkNsb3NlPXt0aGlzLnByb3BzLm9uQ2xvc2V9XG4gICAgICAgICAgICAgICAgcHJldmlvdXNQaGFzZT17UmlnaHRQYW5lbFBoYXNlcy5Sb29tU3VtbWFyeX1cbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X1Jvb21WaWV3X2VtcHR5XCI+eyBfdChcIllvdSBtdXN0IGpvaW4gdGhlIHJvb20gdG8gc2VlIGl0cyBmaWxlc1wiKSB9PC9kaXY+XG4gICAgICAgICAgICA8L0Jhc2VDYXJkPjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHdyYXAgYSBUaW1lbGluZVBhbmVsIHdpdGggdGhlIGp1bXAtdG8tZXZlbnQgYml0cyB0dXJuZWQgb2ZmLlxuXG4gICAgICAgIGNvbnN0IGVtcHR5U3RhdGUgPSAoPGRpdiBjbGFzc05hbWU9XCJteF9SaWdodFBhbmVsX2VtcHR5IG14X0ZpbGVQYW5lbF9lbXB0eVwiPlxuICAgICAgICAgICAgPGgyPnsgX3QoJ05vIGZpbGVzIHZpc2libGUgaW4gdGhpcyByb29tJykgfTwvaDI+XG4gICAgICAgICAgICA8cD57IF90KCdBdHRhY2ggZmlsZXMgZnJvbSBjaGF0IG9yIGp1c3QgZHJhZyBhbmQgZHJvcCB0aGVtIGFueXdoZXJlIGluIGEgcm9vbS4nKSB9PC9wPlxuICAgICAgICA8L2Rpdj4pO1xuXG4gICAgICAgIGNvbnN0IGlzUm9vbUVuY3J5cHRlZCA9IHRoaXMubm9Sb29tID8gZmFsc2UgOiBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuaXNSb29tRW5jcnlwdGVkKHRoaXMucHJvcHMucm9vbUlkKTtcblxuICAgICAgICBpZiAodGhpcy5zdGF0ZS50aW1lbGluZVNldCkge1xuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICA8Um9vbUNvbnRleHQuUHJvdmlkZXIgdmFsdWU9e3tcbiAgICAgICAgICAgICAgICAgICAgLi4udGhpcy5jb250ZXh0LFxuICAgICAgICAgICAgICAgICAgICB0aW1lbGluZVJlbmRlcmluZ1R5cGU6IFRpbWVsaW5lUmVuZGVyaW5nVHlwZS5GaWxlLFxuICAgICAgICAgICAgICAgIH19PlxuICAgICAgICAgICAgICAgICAgICA8QmFzZUNhcmRcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X0ZpbGVQYW5lbFwiXG4gICAgICAgICAgICAgICAgICAgICAgICBvbkNsb3NlPXt0aGlzLnByb3BzLm9uQ2xvc2V9XG4gICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c1BoYXNlPXtSaWdodFBhbmVsUGhhc2VzLlJvb21TdW1tYXJ5fVxuICAgICAgICAgICAgICAgICAgICAgICAgd2l0aG91dFNjcm9sbENvbnRhaW5lclxuICAgICAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICAgICAgICA8RGVza3RvcEJ1aWxkc05vdGljZSBpc1Jvb21FbmNyeXB0ZWQ9e2lzUm9vbUVuY3J5cHRlZH0ga2luZD17V2FybmluZ0tpbmQuRmlsZXN9IC8+XG4gICAgICAgICAgICAgICAgICAgICAgICA8VGltZWxpbmVQYW5lbFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hbmFnZVJlYWRSZWNlaXB0cz17ZmFsc2V9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFuYWdlUmVhZE1hcmtlcnM9e2ZhbHNlfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVsaW5lU2V0PXt0aGlzLnN0YXRlLnRpbWVsaW5lU2V0fVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNob3dVcmxQcmV2aWV3PXtmYWxzZX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvblBhZ2luYXRpb25SZXF1ZXN0PXt0aGlzLm9uUGFnaW5hdGlvblJlcXVlc3R9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGlsZVNoYXBlPXtUaWxlU2hhcGUuRmlsZUdyaWR9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzaXplTm90aWZpZXI9e3RoaXMucHJvcHMucmVzaXplTm90aWZpZXJ9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZW1wdHk9e2VtcHR5U3RhdGV9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGF5b3V0PXtMYXlvdXQuR3JvdXB9XG4gICAgICAgICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgICAgICA8L0Jhc2VDYXJkPlxuICAgICAgICAgICAgICAgIDwvUm9vbUNvbnRleHQuUHJvdmlkZXI+XG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICA8Um9vbUNvbnRleHQuUHJvdmlkZXIgdmFsdWU9e3tcbiAgICAgICAgICAgICAgICAgICAgLi4udGhpcy5jb250ZXh0LFxuICAgICAgICAgICAgICAgICAgICB0aW1lbGluZVJlbmRlcmluZ1R5cGU6IFRpbWVsaW5lUmVuZGVyaW5nVHlwZS5GaWxlLFxuICAgICAgICAgICAgICAgIH19PlxuICAgICAgICAgICAgICAgICAgICA8QmFzZUNhcmRcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X0ZpbGVQYW5lbFwiXG4gICAgICAgICAgICAgICAgICAgICAgICBvbkNsb3NlPXt0aGlzLnByb3BzLm9uQ2xvc2V9XG4gICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c1BoYXNlPXtSaWdodFBhbmVsUGhhc2VzLlJvb21TdW1tYXJ5fVxuICAgICAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICAgICAgICA8U3Bpbm5lciAvPlxuICAgICAgICAgICAgICAgICAgICA8L0Jhc2VDYXJkPlxuICAgICAgICAgICAgICAgIDwvUm9vbUNvbnRleHQuUHJvdmlkZXI+XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBGaWxlUGFuZWw7XG4iXX0=