"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _react = _interopRequireWildcard(require("react"));

var _languageHandler = require("../../../languageHandler");

var _AccessibleTooltipButton = _interopRequireDefault(require("../elements/AccessibleTooltipButton"));

var _ContextMenu = _interopRequireWildcard(require("../../structures/ContextMenu"));

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _StyledCheckbox = _interopRequireDefault(require("../elements/StyledCheckbox"));

var _spaces = require("../../../stores/spaces");

var _useSettings = require("../../../hooks/useSettings");

var _SidebarUserSettingsTab = require("../settings/tabs/user/SidebarUserSettingsTab");

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var _actions = require("../../../dispatcher/actions");

var _UserSettingsDialog = require("../dialogs/UserSettingsDialog");

var _theme = require("../../../theme");

var _Dropdown = _interopRequireDefault(require("../elements/Dropdown"));

var _ThemeChoicePanel = _interopRequireDefault(require("../settings/ThemeChoicePanel"));

var _SettingsStore = _interopRequireDefault(require("../../../settings/SettingsStore"));

var _SettingLevel = require("../../../settings/SettingLevel");

var _classnames = _interopRequireDefault(require("classnames"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/*
Copyright 2021 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const QuickSettingsButton = ({
  isPanelCollapsed = false
}) => {
  const orderedThemes = (0, _react.useMemo)(_theme.getOrderedThemes, []);
  const [menuDisplayed, handle, openMenu, closeMenu] = (0, _ContextMenu.useContextMenu)();
  const {
    [_spaces.MetaSpace.Favourites]: favouritesEnabled,
    [_spaces.MetaSpace.People]: peopleEnabled
  } = (0, _useSettings.useSettingValue)("Spaces.enabledMetaSpaces");
  let contextMenu;

  if (menuDisplayed) {
    const themeState = _ThemeChoicePanel.default.calculateThemeState();

    const nonHighContrast = (0, _theme.findNonHighContrastTheme)(themeState.theme);
    const theme = nonHighContrast ? nonHighContrast : themeState.theme;
    contextMenu = /*#__PURE__*/_react.default.createElement(_ContextMenu.default, (0, _extends2.default)({}, (0, _ContextMenu.alwaysAboveRightOf)(handle.current.getBoundingClientRect(), _ContextMenu.ChevronFace.None, 16), {
      wrapperClassName: "mx_QuickSettingsButton_ContextMenuWrapper",
      onFinished: closeMenu,
      managed: false,
      focusLock: true
    }), /*#__PURE__*/_react.default.createElement("h2", null, (0, _languageHandler._t)("Quick settings")), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      onClick: () => {
        closeMenu();

        _dispatcher.default.dispatch({
          action: _actions.Action.ViewUserSettings,
          initialTabId: _UserSettingsDialog.UserTab.Sidebar
        });
      },
      kind: "primary_outline"
    }, (0, _languageHandler._t)("All settings")), /*#__PURE__*/_react.default.createElement("h4", {
      className: "mx_QuickSettingsButton_pinToSidebarHeading"
    }, (0, _languageHandler._t)("Pin to sidebar")), /*#__PURE__*/_react.default.createElement(_StyledCheckbox.default, {
      className: "mx_QuickSettingsButton_favouritesCheckbox",
      checked: !!favouritesEnabled,
      onChange: (0, _SidebarUserSettingsTab.onMetaSpaceChangeFactory)(_spaces.MetaSpace.Favourites)
    }, (0, _languageHandler._t)("Favourites")), /*#__PURE__*/_react.default.createElement(_StyledCheckbox.default, {
      className: "mx_QuickSettingsButton_peopleCheckbox",
      checked: !!peopleEnabled,
      onChange: (0, _SidebarUserSettingsTab.onMetaSpaceChangeFactory)(_spaces.MetaSpace.People)
    }, (0, _languageHandler._t)("People")), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      className: "mx_QuickSettingsButton_moreOptionsButton",
      onClick: () => {
        closeMenu();

        _dispatcher.default.dispatch({
          action: _actions.Action.ViewUserSettings,
          initialTabId: _UserSettingsDialog.UserTab.Sidebar
        });
      }
    }, (0, _languageHandler._t)("More options")), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_QuickSettingsButton_themePicker"
    }, /*#__PURE__*/_react.default.createElement("h4", null, (0, _languageHandler._t)("Theme")), /*#__PURE__*/_react.default.createElement(_Dropdown.default, {
      id: "mx_QuickSettingsButton_themePickerDropdown",
      onOptionChange: async newTheme => {
        // XXX: mostly copied from ThemeChoicePanel
        // doing getValue in the .catch will still return the value we failed to set,
        // so remember what the value was before we tried to set it so we can revert
        // const oldTheme: string = SettingsStore.getValue("theme");
        _SettingsStore.default.setValue("theme", null, _SettingLevel.SettingLevel.DEVICE, newTheme).catch(() => {
          _dispatcher.default.dispatch({
            action: _actions.Action.RecheckTheme
          });
        }); // The settings watcher doesn't fire until the echo comes back from the
        // server, so to make the theme change immediately we need to manually
        // do the dispatch now
        // XXX: The local echoed value appears to be unreliable, in particular
        // when settings custom themes(!) so adding forceTheme to override
        // the value from settings.


        _dispatcher.default.dispatch({
          action: _actions.Action.RecheckTheme,
          forceTheme: newTheme
        });

        closeMenu();
      },
      value: theme,
      label: (0, _languageHandler._t)("Space selection")
    }, orderedThemes.map(theme => /*#__PURE__*/_react.default.createElement("div", {
      key: theme.id
    }, theme.name)))));
  }

  return /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement(_AccessibleTooltipButton.default, {
    className: (0, _classnames.default)("mx_QuickSettingsButton", {
      expanded: !isPanelCollapsed
    }),
    onClick: openMenu,
    title: (0, _languageHandler._t)("Quick settings"),
    inputRef: handle,
    forceHide: !isPanelCollapsed
  }, !isPanelCollapsed ? (0, _languageHandler._t)("Settings") : null), contextMenu);
};

var _default = QuickSettingsButton;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3NwYWNlcy9RdWlja1NldHRpbmdzQnV0dG9uLnRzeCJdLCJuYW1lcyI6WyJRdWlja1NldHRpbmdzQnV0dG9uIiwiaXNQYW5lbENvbGxhcHNlZCIsIm9yZGVyZWRUaGVtZXMiLCJnZXRPcmRlcmVkVGhlbWVzIiwibWVudURpc3BsYXllZCIsImhhbmRsZSIsIm9wZW5NZW51IiwiY2xvc2VNZW51IiwiTWV0YVNwYWNlIiwiRmF2b3VyaXRlcyIsImZhdm91cml0ZXNFbmFibGVkIiwiUGVvcGxlIiwicGVvcGxlRW5hYmxlZCIsImNvbnRleHRNZW51IiwidGhlbWVTdGF0ZSIsIlRoZW1lQ2hvaWNlUGFuZWwiLCJjYWxjdWxhdGVUaGVtZVN0YXRlIiwibm9uSGlnaENvbnRyYXN0IiwidGhlbWUiLCJjdXJyZW50IiwiZ2V0Qm91bmRpbmdDbGllbnRSZWN0IiwiQ2hldnJvbkZhY2UiLCJOb25lIiwiZGVmYXVsdERpc3BhdGNoZXIiLCJkaXNwYXRjaCIsImFjdGlvbiIsIkFjdGlvbiIsIlZpZXdVc2VyU2V0dGluZ3MiLCJpbml0aWFsVGFiSWQiLCJVc2VyVGFiIiwiU2lkZWJhciIsIm5ld1RoZW1lIiwiU2V0dGluZ3NTdG9yZSIsInNldFZhbHVlIiwiU2V0dGluZ0xldmVsIiwiREVWSUNFIiwiY2F0Y2giLCJkaXMiLCJSZWNoZWNrVGhlbWUiLCJmb3JjZVRoZW1lIiwibWFwIiwiaWQiLCJuYW1lIiwiZXhwYW5kZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBOzs7Ozs7QUFwQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBd0JBLE1B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bkQsRUFBMkRKLFFBQTNELEVBQXFFSyxLQUFyRSxDQUEyRSxNQUFNO0FBQzdFQyw4QkFBSWIsUUFBSixDQUFrQztBQUFFQyxZQUFBQSxNQUFNLEVBQUVDLGdCQUFPWTtBQUFqQixXQUFsQztBQUNILFNBRkQsRUFMd0MsQ0FReEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUFDQUQsNEJBQUliLFFBQUosQ0FBa0M7QUFBRUMsVUFBQUEsTUFBTSxFQUFFQyxnQkFBT1ksWUFBakI7QUFBK0JDLFVBQUFBLFVBQVUsRUFBRVI7QUFBM0MsU0FBbEM7O0FBQ0F4QixRQUFBQSxTQUFTO0FBQ1osT0FsQkw7QUFtQkksTUFBQSxLQUFLLEVBQUVXLEtBbkJYO0FBb0JJLE1BQUEsS0FBSyxFQUFFLHlCQUFHLGlCQUFIO0FBcEJYLE9Bc0JNaEIsYUFBYSxDQUFDc0MsR0FBZCxDQUFtQnRCLEtBQUQsaUJBQ2hCO0FBQUssTUFBQSxHQUFHLEVBQUVBLEtBQUssQ0FBQ3VCO0FBQWhCLE9BQ012QixLQUFLLENBQUN3QixJQURaLENBREYsQ0F0Qk4sQ0FGSixDQW5EVSxDQUFkO0FBbUZIOztBQUVELHNCQUFPLHlFQUNILDZCQUFDLGdDQUFEO0FBQ0ksSUFBQSxTQUFTLEVBQUUseUJBQVcsd0JBQVgsRUFBcUM7QUFBRUMsTUFBQUEsUUFBUSxFQUFFLENBQUMxQztBQUFiLEtBQXJDLENBRGY7QUFFSSxJQUFBLE9BQU8sRUFBRUssUUFGYjtBQUdJLElBQUEsS0FBSyxFQUFFLHlCQUFHLGdCQUFILENBSFg7QUFJSSxJQUFBLFFBQVEsRUFBRUQsTUFKZDtBQUtJLElBQUEsU0FBUyxFQUFFLENBQUNKO0FBTGhCLEtBT00sQ0FBQ0EsZ0JBQUQsR0FBb0IseUJBQUcsVUFBSCxDQUFwQixHQUFxQyxJQVAzQyxDQURHLEVBV0RZLFdBWEMsQ0FBUDtBQWFILENBakhEOztlQW1IZWIsbUIiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMjEgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QsIHsgdXNlTWVtbyB9IGZyb20gXCJyZWFjdFwiO1xuXG5pbXBvcnQgeyBfdCB9IGZyb20gXCIuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXJcIjtcbmltcG9ydCBBY2Nlc3NpYmxlVG9vbHRpcEJ1dHRvbiBmcm9tIFwiLi4vZWxlbWVudHMvQWNjZXNzaWJsZVRvb2x0aXBCdXR0b25cIjtcbmltcG9ydCBDb250ZXh0TWVudSwgeyBhbHdheXNBYm92ZVJpZ2h0T2YsIENoZXZyb25GYWNlLCB1c2VDb250ZXh0TWVudSB9IGZyb20gXCIuLi8uLi9zdHJ1Y3R1cmVzL0NvbnRleHRNZW51XCI7XG5pbXBvcnQgQWNjZXNzaWJsZUJ1dHRvbiBmcm9tIFwiLi4vZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvblwiO1xuaW1wb3J0IFN0eWxlZENoZWNrYm94IGZyb20gXCIuLi9lbGVtZW50cy9TdHlsZWRDaGVja2JveFwiO1xuaW1wb3J0IHsgTWV0YVNwYWNlIH0gZnJvbSBcIi4uLy4uLy4uL3N0b3Jlcy9zcGFjZXNcIjtcbmltcG9ydCB7IHVzZVNldHRpbmdWYWx1ZSB9IGZyb20gXCIuLi8uLi8uLi9ob29rcy91c2VTZXR0aW5nc1wiO1xuaW1wb3J0IHsgb25NZXRhU3BhY2VDaGFuZ2VGYWN0b3J5IH0gZnJvbSBcIi4uL3NldHRpbmdzL3RhYnMvdXNlci9TaWRlYmFyVXNlclNldHRpbmdzVGFiXCI7XG5pbXBvcnQgZGVmYXVsdERpc3BhdGNoZXIgZnJvbSBcIi4uLy4uLy4uL2Rpc3BhdGNoZXIvZGlzcGF0Y2hlclwiO1xuaW1wb3J0IHsgQWN0aW9uIH0gZnJvbSBcIi4uLy4uLy4uL2Rpc3BhdGNoZXIvYWN0aW9uc1wiO1xuaW1wb3J0IHsgVXNlclRhYiB9IGZyb20gXCIuLi9kaWFsb2dzL1VzZXJTZXR0aW5nc0RpYWxvZ1wiO1xuaW1wb3J0IHsgZmluZE5vbkhpZ2hDb250cmFzdFRoZW1lLCBnZXRPcmRlcmVkVGhlbWVzIH0gZnJvbSBcIi4uLy4uLy4uL3RoZW1lXCI7XG5pbXBvcnQgRHJvcGRvd24gZnJvbSBcIi4uL2VsZW1lbnRzL0Ryb3Bkb3duXCI7XG5pbXBvcnQgVGhlbWVDaG9pY2VQYW5lbCBmcm9tIFwiLi4vc2V0dGluZ3MvVGhlbWVDaG9pY2VQYW5lbFwiO1xuaW1wb3J0IFNldHRpbmdzU3RvcmUgZnJvbSBcIi4uLy4uLy4uL3NldHRpbmdzL1NldHRpbmdzU3RvcmVcIjtcbmltcG9ydCB7IFNldHRpbmdMZXZlbCB9IGZyb20gXCIuLi8uLi8uLi9zZXR0aW5ncy9TZXR0aW5nTGV2ZWxcIjtcbmltcG9ydCBkaXMgZnJvbSBcIi4uLy4uLy4uL2Rpc3BhdGNoZXIvZGlzcGF0Y2hlclwiO1xuaW1wb3J0IHsgUmVjaGVja1RoZW1lUGF5bG9hZCB9IGZyb20gXCIuLi8uLi8uLi9kaXNwYXRjaGVyL3BheWxvYWRzL1JlY2hlY2tUaGVtZVBheWxvYWRcIjtcbmltcG9ydCBjbGFzc05hbWVzIGZyb20gXCJjbGFzc25hbWVzXCI7XG5cbmNvbnN0IFF1aWNrU2V0dGluZ3NCdXR0b24gPSAoeyBpc1BhbmVsQ29sbGFwc2VkID0gZmFsc2UgfSkgPT4ge1xuICAgIGNvbnN0IG9yZGVyZWRUaGVtZXMgPSB1c2VNZW1vKGdldE9yZGVyZWRUaGVtZXMsIFtdKTtcbiAgICBjb25zdCBbbWVudURpc3BsYXllZCwgaGFuZGxlLCBvcGVuTWVudSwgY2xvc2VNZW51XSA9IHVzZUNvbnRleHRNZW51PEhUTUxEaXZFbGVtZW50PigpO1xuXG4gICAgY29uc3Qge1xuICAgICAgICBbTWV0YVNwYWNlLkZhdm91cml0ZXNdOiBmYXZvdXJpdGVzRW5hYmxlZCxcbiAgICAgICAgW01ldGFTcGFjZS5QZW9wbGVdOiBwZW9wbGVFbmFibGVkLFxuICAgIH0gPSB1c2VTZXR0aW5nVmFsdWU8UmVjb3JkPE1ldGFTcGFjZSwgYm9vbGVhbj4+KFwiU3BhY2VzLmVuYWJsZWRNZXRhU3BhY2VzXCIpO1xuXG4gICAgbGV0IGNvbnRleHRNZW51OiBKU1guRWxlbWVudDtcbiAgICBpZiAobWVudURpc3BsYXllZCkge1xuICAgICAgICBjb25zdCB0aGVtZVN0YXRlID0gVGhlbWVDaG9pY2VQYW5lbC5jYWxjdWxhdGVUaGVtZVN0YXRlKCk7XG4gICAgICAgIGNvbnN0IG5vbkhpZ2hDb250cmFzdCA9IGZpbmROb25IaWdoQ29udHJhc3RUaGVtZSh0aGVtZVN0YXRlLnRoZW1lKTtcbiAgICAgICAgY29uc3QgdGhlbWUgPSBub25IaWdoQ29udHJhc3QgPyBub25IaWdoQ29udHJhc3QgOiB0aGVtZVN0YXRlLnRoZW1lO1xuXG4gICAgICAgIGNvbnRleHRNZW51ID0gPENvbnRleHRNZW51XG4gICAgICAgICAgICB7Li4uYWx3YXlzQWJvdmVSaWdodE9mKGhhbmRsZS5jdXJyZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLCBDaGV2cm9uRmFjZS5Ob25lLCAxNil9XG4gICAgICAgICAgICB3cmFwcGVyQ2xhc3NOYW1lPVwibXhfUXVpY2tTZXR0aW5nc0J1dHRvbl9Db250ZXh0TWVudVdyYXBwZXJcIlxuICAgICAgICAgICAgb25GaW5pc2hlZD17Y2xvc2VNZW51fVxuICAgICAgICAgICAgbWFuYWdlZD17ZmFsc2V9XG4gICAgICAgICAgICBmb2N1c0xvY2s9e3RydWV9XG4gICAgICAgID5cbiAgICAgICAgICAgIDxoMj57IF90KFwiUXVpY2sgc2V0dGluZ3NcIikgfTwvaDI+XG5cbiAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uXG4gICAgICAgICAgICAgICAgb25DbGljaz17KCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjbG9zZU1lbnUoKTtcbiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdERpc3BhdGNoZXIuZGlzcGF0Y2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uOiBBY3Rpb24uVmlld1VzZXJTZXR0aW5ncyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGluaXRpYWxUYWJJZDogVXNlclRhYi5TaWRlYmFyLFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9fVxuICAgICAgICAgICAgICAgIGtpbmQ9XCJwcmltYXJ5X291dGxpbmVcIlxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgIHsgX3QoXCJBbGwgc2V0dGluZ3NcIikgfVxuICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuXG4gICAgICAgICAgICA8aDQgY2xhc3NOYW1lPVwibXhfUXVpY2tTZXR0aW5nc0J1dHRvbl9waW5Ub1NpZGViYXJIZWFkaW5nXCI+eyBfdChcIlBpbiB0byBzaWRlYmFyXCIpIH08L2g0PlxuXG4gICAgICAgICAgICA8U3R5bGVkQ2hlY2tib3hcbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9RdWlja1NldHRpbmdzQnV0dG9uX2Zhdm91cml0ZXNDaGVja2JveFwiXG4gICAgICAgICAgICAgICAgY2hlY2tlZD17ISFmYXZvdXJpdGVzRW5hYmxlZH1cbiAgICAgICAgICAgICAgICBvbkNoYW5nZT17b25NZXRhU3BhY2VDaGFuZ2VGYWN0b3J5KE1ldGFTcGFjZS5GYXZvdXJpdGVzKX1cbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICB7IF90KFwiRmF2b3VyaXRlc1wiKSB9XG4gICAgICAgICAgICA8L1N0eWxlZENoZWNrYm94PlxuICAgICAgICAgICAgPFN0eWxlZENoZWNrYm94XG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfUXVpY2tTZXR0aW5nc0J1dHRvbl9wZW9wbGVDaGVja2JveFwiXG4gICAgICAgICAgICAgICAgY2hlY2tlZD17ISFwZW9wbGVFbmFibGVkfVxuICAgICAgICAgICAgICAgIG9uQ2hhbmdlPXtvbk1ldGFTcGFjZUNoYW5nZUZhY3RvcnkoTWV0YVNwYWNlLlBlb3BsZSl9XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgeyBfdChcIlBlb3BsZVwiKSB9XG4gICAgICAgICAgICA8L1N0eWxlZENoZWNrYm94PlxuICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b25cbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9RdWlja1NldHRpbmdzQnV0dG9uX21vcmVPcHRpb25zQnV0dG9uXCJcbiAgICAgICAgICAgICAgICBvbkNsaWNrPXsoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNsb3NlTWVudSgpO1xuICAgICAgICAgICAgICAgICAgICBkZWZhdWx0RGlzcGF0Y2hlci5kaXNwYXRjaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb246IEFjdGlvbi5WaWV3VXNlclNldHRpbmdzLFxuICAgICAgICAgICAgICAgICAgICAgICAgaW5pdGlhbFRhYklkOiBVc2VyVGFiLlNpZGViYXIsXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH19XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgeyBfdChcIk1vcmUgb3B0aW9uc1wiKSB9XG4gICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG5cbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfUXVpY2tTZXR0aW5nc0J1dHRvbl90aGVtZVBpY2tlclwiPlxuICAgICAgICAgICAgICAgIDxoND57IF90KFwiVGhlbWVcIikgfTwvaDQ+XG4gICAgICAgICAgICAgICAgPERyb3Bkb3duXG4gICAgICAgICAgICAgICAgICAgIGlkPVwibXhfUXVpY2tTZXR0aW5nc0J1dHRvbl90aGVtZVBpY2tlckRyb3Bkb3duXCJcbiAgICAgICAgICAgICAgICAgICAgb25PcHRpb25DaGFuZ2U9e2FzeW5jIChuZXdUaGVtZTogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBYWFg6IG1vc3RseSBjb3BpZWQgZnJvbSBUaGVtZUNob2ljZVBhbmVsXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBkb2luZyBnZXRWYWx1ZSBpbiB0aGUgLmNhdGNoIHdpbGwgc3RpbGwgcmV0dXJuIHRoZSB2YWx1ZSB3ZSBmYWlsZWQgdG8gc2V0LFxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gc28gcmVtZW1iZXIgd2hhdCB0aGUgdmFsdWUgd2FzIGJlZm9yZSB3ZSB0cmllZCB0byBzZXQgaXQgc28gd2UgY2FuIHJldmVydFxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29uc3Qgb2xkVGhlbWU6IHN0cmluZyA9IFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJ0aGVtZVwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIFNldHRpbmdzU3RvcmUuc2V0VmFsdWUoXCJ0aGVtZVwiLCBudWxsLCBTZXR0aW5nTGV2ZWwuREVWSUNFLCBuZXdUaGVtZSkuY2F0Y2goKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcy5kaXNwYXRjaDxSZWNoZWNrVGhlbWVQYXlsb2FkPih7IGFjdGlvbjogQWN0aW9uLlJlY2hlY2tUaGVtZSB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhlIHNldHRpbmdzIHdhdGNoZXIgZG9lc24ndCBmaXJlIHVudGlsIHRoZSBlY2hvIGNvbWVzIGJhY2sgZnJvbSB0aGVcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNlcnZlciwgc28gdG8gbWFrZSB0aGUgdGhlbWUgY2hhbmdlIGltbWVkaWF0ZWx5IHdlIG5lZWQgdG8gbWFudWFsbHlcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRvIHRoZSBkaXNwYXRjaCBub3dcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFhYWDogVGhlIGxvY2FsIGVjaG9lZCB2YWx1ZSBhcHBlYXJzIHRvIGJlIHVucmVsaWFibGUsIGluIHBhcnRpY3VsYXJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdoZW4gc2V0dGluZ3MgY3VzdG9tIHRoZW1lcyghKSBzbyBhZGRpbmcgZm9yY2VUaGVtZSB0byBvdmVycmlkZVxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhlIHZhbHVlIGZyb20gc2V0dGluZ3MuXG4gICAgICAgICAgICAgICAgICAgICAgICBkaXMuZGlzcGF0Y2g8UmVjaGVja1RoZW1lUGF5bG9hZD4oeyBhY3Rpb246IEFjdGlvbi5SZWNoZWNrVGhlbWUsIGZvcmNlVGhlbWU6IG5ld1RoZW1lIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2xvc2VNZW51KCk7XG4gICAgICAgICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlPXt0aGVtZX1cbiAgICAgICAgICAgICAgICAgICAgbGFiZWw9e190KFwiU3BhY2Ugc2VsZWN0aW9uXCIpfVxuICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICAgICAgeyBvcmRlcmVkVGhlbWVzLm1hcCgodGhlbWUpID0+IChcbiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYga2V5PXt0aGVtZS5pZH0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeyB0aGVtZS5uYW1lIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICApKSB9XG4gICAgICAgICAgICAgICAgPC9Ecm9wZG93bj5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICA8L0NvbnRleHRNZW51PjtcbiAgICB9XG5cbiAgICByZXR1cm4gPD5cbiAgICAgICAgPEFjY2Vzc2libGVUb29sdGlwQnV0dG9uXG4gICAgICAgICAgICBjbGFzc05hbWU9e2NsYXNzTmFtZXMoXCJteF9RdWlja1NldHRpbmdzQnV0dG9uXCIsIHsgZXhwYW5kZWQ6ICFpc1BhbmVsQ29sbGFwc2VkIH0pfVxuICAgICAgICAgICAgb25DbGljaz17b3Blbk1lbnV9XG4gICAgICAgICAgICB0aXRsZT17X3QoXCJRdWljayBzZXR0aW5nc1wiKX1cbiAgICAgICAgICAgIGlucHV0UmVmPXtoYW5kbGV9XG4gICAgICAgICAgICBmb3JjZUhpZGU9eyFpc1BhbmVsQ29sbGFwc2VkfVxuICAgICAgICA+XG4gICAgICAgICAgICB7ICFpc1BhbmVsQ29sbGFwc2VkID8gX3QoXCJTZXR0aW5nc1wiKSA6IG51bGwgfVxuICAgICAgICA8L0FjY2Vzc2libGVUb29sdGlwQnV0dG9uPlxuXG4gICAgICAgIHsgY29udGV4dE1lbnUgfVxuICAgIDwvPjtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IFF1aWNrU2V0dGluZ3NCdXR0b247XG4iXX0=