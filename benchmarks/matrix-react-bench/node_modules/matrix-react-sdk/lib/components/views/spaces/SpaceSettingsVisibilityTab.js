"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireWildcard(require("react"));

var _event = require("matrix-js-sdk/src/@types/event");

var _partials = require("matrix-js-sdk/src/@types/partials");

var _languageHandler = require("../../../languageHandler");

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _AliasSettings = _interopRequireDefault(require("../room_settings/AliasSettings"));

var _useStateToggle = require("../../../hooks/useStateToggle");

var _LabelledToggleSwitch = _interopRequireDefault(require("../elements/LabelledToggleSwitch"));

var _useLocalEcho = require("../../../hooks/useLocalEcho");

var _JoinRuleSettings = _interopRequireDefault(require("../settings/JoinRuleSettings"));

var _useRoomState = require("../../../hooks/useRoomState");

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/*
Copyright 2021 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const SpaceSettingsVisibilityTab = ({
  matrixClient: cli,
  space,
  closeSettingsFn
}) => {
  const [error, setError] = (0, _react.useState)("");
  const userId = cli.getUserId();
  const joinRule = (0, _useRoomState.useRoomState)(space, state => state.getJoinRule());
  const [guestAccessEnabled, setGuestAccessEnabled] = (0, _useLocalEcho.useLocalEcho)(() => {
    var _space$currentState$g, _space$currentState$g2;

    return ((_space$currentState$g = space.currentState.getStateEvents(_event.EventType.RoomGuestAccess, "")) === null || _space$currentState$g === void 0 ? void 0 : (_space$currentState$g2 = _space$currentState$g.getContent()) === null || _space$currentState$g2 === void 0 ? void 0 : _space$currentState$g2.guest_access) === _partials.GuestAccess.CanJoin;
  }, guestAccessEnabled => cli.sendStateEvent(space.roomId, _event.EventType.RoomGuestAccess, {
    guest_access: guestAccessEnabled ? _partials.GuestAccess.CanJoin : _partials.GuestAccess.Forbidden
  }, ""), () => setError((0, _languageHandler._t)("Failed to update the guest access of this space")));
  const [historyVisibility, setHistoryVisibility] = (0, _useLocalEcho.useLocalEcho)(() => {
    var _space$currentState$g3, _space$currentState$g4;

    return ((_space$currentState$g3 = space.currentState.getStateEvents(_event.EventType.RoomHistoryVisibility, "")) === null || _space$currentState$g3 === void 0 ? void 0 : (_space$currentState$g4 = _space$currentState$g3.getContent()) === null || _space$currentState$g4 === void 0 ? void 0 : _space$currentState$g4.history_visibility) || _partials.HistoryVisibility.Shared;
  }, historyVisibility => cli.sendStateEvent(space.roomId, _event.EventType.RoomHistoryVisibility, {
    history_visibility: historyVisibility
  }, ""), () => setError((0, _languageHandler._t)("Failed to update the history visibility of this space")));
  const [showAdvancedSection, toggleAdvancedSection] = (0, _useStateToggle.useStateToggle)();
  const canSetGuestAccess = space.currentState.maySendStateEvent(_event.EventType.RoomGuestAccess, userId);
  const canSetHistoryVisibility = space.currentState.maySendStateEvent(_event.EventType.RoomHistoryVisibility, userId);
  const canSetCanonical = space.currentState.mayClientSendStateEvent(_event.EventType.RoomCanonicalAlias, cli);
  const canonicalAliasEv = space.currentState.getStateEvents(_event.EventType.RoomCanonicalAlias, "");
  let advancedSection;

  if (joinRule === _partials.JoinRule.Public) {
    if (showAdvancedSection) {
      advancedSection = /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        onClick: toggleAdvancedSection,
        kind: "link",
        className: "mx_SettingsTab_showAdvanced"
      }, (0, _languageHandler._t)("Hide advanced")), /*#__PURE__*/_react.default.createElement(_LabelledToggleSwitch.default, {
        value: guestAccessEnabled,
        onChange: setGuestAccessEnabled,
        disabled: !canSetGuestAccess,
        label: (0, _languageHandler._t)("Enable guest access")
      }), /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Guests can join a space without having an account."), /*#__PURE__*/_react.default.createElement("br", null), (0, _languageHandler._t)("This may be useful for public spaces.")));
    } else {
      advancedSection = /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        onClick: toggleAdvancedSection,
        kind: "link",
        className: "mx_SettingsTab_showAdvanced"
      }, (0, _languageHandler._t)("Show advanced")));
    }
  }

  let addressesSection;

  if (space.getJoinRule() === _partials.JoinRule.Public) {
    addressesSection = /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_SettingsTab_subheading"
    }, (0, _languageHandler._t)("Address")), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_SettingsTab_section mx_SettingsTab_subsectionText"
    }, /*#__PURE__*/_react.default.createElement(_AliasSettings.default, {
      roomId: space.roomId,
      canSetCanonicalAlias: canSetCanonical,
      canSetAliases: true,
      canonicalAliasEvent: canonicalAliasEv,
      hidePublishSetting: true
    })));
  }

  return /*#__PURE__*/_react.default.createElement("div", {
    className: "mx_SettingsTab"
  }, /*#__PURE__*/_react.default.createElement("div", {
    className: "mx_SettingsTab_heading"
  }, (0, _languageHandler._t)("Visibility")), error && /*#__PURE__*/_react.default.createElement("div", {
    className: "mx_SpaceRoomView_errorText"
  }, error), /*#__PURE__*/_react.default.createElement("div", {
    className: "mx_SettingsTab_section"
  }, /*#__PURE__*/_react.default.createElement("div", {
    className: "mx_SettingsTab_section_caption"
  }, (0, _languageHandler._t)("Decide who can view and join %(spaceName)s.", {
    spaceName: space.name
  })), /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement(_JoinRuleSettings.default, {
    room: space,
    onError: () => setError((0, _languageHandler._t)("Failed to update the visibility of this space")),
    closeSettingsFn: closeSettingsFn
  })), advancedSection, /*#__PURE__*/_react.default.createElement(_LabelledToggleSwitch.default, {
    value: historyVisibility === _partials.HistoryVisibility.WorldReadable,
    onChange: checked => {
      setHistoryVisibility(checked ? _partials.HistoryVisibility.WorldReadable : _partials.HistoryVisibility.Shared);
    },
    disabled: !canSetHistoryVisibility,
    label: (0, _languageHandler._t)("Preview Space")
  }), /*#__PURE__*/_react.default.createElement("div", null, (0, _languageHandler._t)("Allow people to preview your space before they join.")), /*#__PURE__*/_react.default.createElement("b", null, (0, _languageHandler._t)("Recommended for public spaces."))), addressesSection);
};

var _default = SpaceSettingsVisibilityTab;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3NwYWNlcy9TcGFjZVNldHRpbmdzVmlzaWJpbGl0eVRhYi50c3giXSwibmFtZXMiOlsiU3BhY2VTZXR0aW5nc1Zpc2liaWxpdHlUYWIiLCJtYXRyaXhDbGllbnQiLCJjbGkiLCJzcGFjZSIsImNsb3NlU2V0dGluZ3NGbiIsImVycm9yIiwic2V0RXJyb3IiLCJ1c2VySWQiLCJnZXRVc2VySWQiLCJqb2luUnVsZSIsInN0YXRlIiwiZ2V0Sm9pblJ1bGUiLCJndWVzdEFjY2Vzc0VuYWJsZWQiLCJzZXRHdWVzdEFjY2Vzc0VuYWJsZWQiLCJjdXJyZW50U3RhdGUiLCJnZXRTdGF0ZUV2ZW50cyIsIkV2ZW50VHlwZSIsIlJvb21HdWVzdEFjY2VzcyIsImdldENvbnRlbnQiLCJndWVzdF9hY2Nlc3MiLCJHdWVzdEFjY2VzcyIsIkNhbkpvaW4iLCJzZW5kU3RhdGVFdmVudCIsInJvb21JZCIsIkZvcmJpZGRlbiIsImhpc3RvcnlWaXNpYmlsaXR5Iiwic2V0SGlzdG9yeVZpc2liaWxpdHkiLCJSb29tSGlzdG9yeVZpc2liaWxpdHkiLCJoaXN0b3J5X3Zpc2liaWxpdHkiLCJIaXN0b3J5VmlzaWJpbGl0eSIsIlNoYXJlZCIsInNob3dBZHZhbmNlZFNlY3Rpb24iLCJ0b2dnbGVBZHZhbmNlZFNlY3Rpb24iLCJjYW5TZXRHdWVzdEFjY2VzcyIsIm1heVNlbmRTdGF0ZUV2ZW50IiwiY2FuU2V0SGlzdG9yeVZpc2liaWxpdHkiLCJjYW5TZXRDYW5vbmljYWwiLCJtYXlDbGllbnRTZW5kU3RhdGVFdmVudCIsIlJvb21DYW5vbmljYWxBbGlhcyIsImNhbm9uaWNhbEFsaWFzRXYiLCJhZHZhbmNlZFNlY3Rpb24iLCJKb2luUnVsZSIsIlB1YmxpYyIsImFkZHJlc3Nlc1NlY3Rpb24iLCJzcGFjZU5hbWUiLCJuYW1lIiwiV29ybGRSZWFkYWJsZSIsImNoZWNrZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQWdCQTs7QUFH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SS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCwgeyB1c2VTdGF0ZSB9IGZyb20gXCJyZWFjdFwiO1xuaW1wb3J0IHsgUm9vbSB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvcm9vbVwiO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2NsaWVudFwiO1xuaW1wb3J0IHsgRXZlbnRUeXBlIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL0B0eXBlcy9ldmVudFwiO1xuaW1wb3J0IHsgR3Vlc3RBY2Nlc3MsIEhpc3RvcnlWaXNpYmlsaXR5LCBKb2luUnVsZSB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9AdHlwZXMvcGFydGlhbHNcIjtcblxuaW1wb3J0IHsgX3QgfSBmcm9tIFwiLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyXCI7XG5pbXBvcnQgQWNjZXNzaWJsZUJ1dHRvbiBmcm9tIFwiLi4vZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvblwiO1xuaW1wb3J0IEFsaWFzU2V0dGluZ3MgZnJvbSBcIi4uL3Jvb21fc2V0dGluZ3MvQWxpYXNTZXR0aW5nc1wiO1xuaW1wb3J0IHsgdXNlU3RhdGVUb2dnbGUgfSBmcm9tIFwiLi4vLi4vLi4vaG9va3MvdXNlU3RhdGVUb2dnbGVcIjtcbmltcG9ydCBMYWJlbGxlZFRvZ2dsZVN3aXRjaCBmcm9tIFwiLi4vZWxlbWVudHMvTGFiZWxsZWRUb2dnbGVTd2l0Y2hcIjtcbmltcG9ydCB7IHVzZUxvY2FsRWNobyB9IGZyb20gXCIuLi8uLi8uLi9ob29rcy91c2VMb2NhbEVjaG9cIjtcbmltcG9ydCBKb2luUnVsZVNldHRpbmdzIGZyb20gXCIuLi9zZXR0aW5ncy9Kb2luUnVsZVNldHRpbmdzXCI7XG5pbXBvcnQgeyB1c2VSb29tU3RhdGUgfSBmcm9tIFwiLi4vLi4vLi4vaG9va3MvdXNlUm9vbVN0YXRlXCI7XG5cbmludGVyZmFjZSBJUHJvcHMge1xuICAgIG1hdHJpeENsaWVudDogTWF0cml4Q2xpZW50O1xuICAgIHNwYWNlOiBSb29tO1xuICAgIGNsb3NlU2V0dGluZ3NGbigpOiB2b2lkO1xufVxuXG5jb25zdCBTcGFjZVNldHRpbmdzVmlzaWJpbGl0eVRhYiA9ICh7IG1hdHJpeENsaWVudDogY2xpLCBzcGFjZSwgY2xvc2VTZXR0aW5nc0ZuIH06IElQcm9wcykgPT4ge1xuICAgIGNvbnN0IFtlcnJvciwgc2V0RXJyb3JdID0gdXNlU3RhdGUoXCJcIik7XG5cbiAgICBjb25zdCB1c2VySWQgPSBjbGkuZ2V0VXNlcklkKCk7XG5cbiAgICBjb25zdCBqb2luUnVsZSA9IHVzZVJvb21TdGF0ZShzcGFjZSwgc3RhdGUgPT4gc3RhdGUuZ2V0Sm9pblJ1bGUoKSk7XG4gICAgY29uc3QgW2d1ZXN0QWNjZXNzRW5hYmxlZCwgc2V0R3Vlc3RBY2Nlc3NFbmFibGVkXSA9IHVzZUxvY2FsRWNobzxib29sZWFuPihcbiAgICAgICAgKCkgPT4gc3BhY2UuY3VycmVudFN0YXRlLmdldFN0YXRlRXZlbnRzKEV2ZW50VHlwZS5Sb29tR3Vlc3RBY2Nlc3MsIFwiXCIpXG4gICAgICAgICAgICA/LmdldENvbnRlbnQoKT8uZ3Vlc3RfYWNjZXNzID09PSBHdWVzdEFjY2Vzcy5DYW5Kb2luLFxuICAgICAgICBndWVzdEFjY2Vzc0VuYWJsZWQgPT4gY2xpLnNlbmRTdGF0ZUV2ZW50KHNwYWNlLnJvb21JZCwgRXZlbnRUeXBlLlJvb21HdWVzdEFjY2Vzcywge1xuICAgICAgICAgICAgZ3Vlc3RfYWNjZXNzOiBndWVzdEFjY2Vzc0VuYWJsZWQgPyBHdWVzdEFjY2Vzcy5DYW5Kb2luIDogR3Vlc3RBY2Nlc3MuRm9yYmlkZGVuLFxuICAgICAgICB9LCBcIlwiKSxcbiAgICAgICAgKCkgPT4gc2V0RXJyb3IoX3QoXCJGYWlsZWQgdG8gdXBkYXRlIHRoZSBndWVzdCBhY2Nlc3Mgb2YgdGhpcyBzcGFjZVwiKSksXG4gICAgKTtcbiAgICBjb25zdCBbaGlzdG9yeVZpc2liaWxpdHksIHNldEhpc3RvcnlWaXNpYmlsaXR5XSA9IHVzZUxvY2FsRWNobzxIaXN0b3J5VmlzaWJpbGl0eT4oXG4gICAgICAgICgpID0+IHNwYWNlLmN1cnJlbnRTdGF0ZS5nZXRTdGF0ZUV2ZW50cyhFdmVudFR5cGUuUm9vbUhpc3RvcnlWaXNpYmlsaXR5LCBcIlwiKVxuICAgICAgICAgICAgPy5nZXRDb250ZW50KCk/Lmhpc3RvcnlfdmlzaWJpbGl0eSB8fCBIaXN0b3J5VmlzaWJpbGl0eS5TaGFyZWQsXG4gICAgICAgIGhpc3RvcnlWaXNpYmlsaXR5ID0+IGNsaS5zZW5kU3RhdGVFdmVudChzcGFjZS5yb29tSWQsIEV2ZW50VHlwZS5Sb29tSGlzdG9yeVZpc2liaWxpdHksIHtcbiAgICAgICAgICAgIGhpc3RvcnlfdmlzaWJpbGl0eTogaGlzdG9yeVZpc2liaWxpdHksXG4gICAgICAgIH0sIFwiXCIpLFxuICAgICAgICAoKSA9PiBzZXRFcnJvcihfdChcIkZhaWxlZCB0byB1cGRhdGUgdGhlIGhpc3RvcnkgdmlzaWJpbGl0eSBvZiB0aGlzIHNwYWNlXCIpKSxcbiAgICApO1xuXG4gICAgY29uc3QgW3Nob3dBZHZhbmNlZFNlY3Rpb24sIHRvZ2dsZUFkdmFuY2VkU2VjdGlvbl0gPSB1c2VTdGF0ZVRvZ2dsZSgpO1xuXG4gICAgY29uc3QgY2FuU2V0R3Vlc3RBY2Nlc3MgPSBzcGFjZS5jdXJyZW50U3RhdGUubWF5U2VuZFN0YXRlRXZlbnQoRXZlbnRUeXBlLlJvb21HdWVzdEFjY2VzcywgdXNlcklkKTtcbiAgICBjb25zdCBjYW5TZXRIaXN0b3J5VmlzaWJpbGl0eSA9IHNwYWNlLmN1cnJlbnRTdGF0ZS5tYXlTZW5kU3RhdGVFdmVudChFdmVudFR5cGUuUm9vbUhpc3RvcnlWaXNpYmlsaXR5LCB1c2VySWQpO1xuICAgIGNvbnN0IGNhblNldENhbm9uaWNhbCA9IHNwYWNlLmN1cnJlbnRTdGF0ZS5tYXlDbGllbnRTZW5kU3RhdGVFdmVudChFdmVudFR5cGUuUm9vbUNhbm9uaWNhbEFsaWFzLCBjbGkpO1xuICAgIGNvbnN0IGNhbm9uaWNhbEFsaWFzRXYgPSBzcGFjZS5jdXJyZW50U3RhdGUuZ2V0U3RhdGVFdmVudHMoRXZlbnRUeXBlLlJvb21DYW5vbmljYWxBbGlhcywgXCJcIik7XG5cbiAgICBsZXQgYWR2YW5jZWRTZWN0aW9uO1xuICAgIGlmIChqb2luUnVsZSA9PT0gSm9pblJ1bGUuUHVibGljKSB7XG4gICAgICAgIGlmIChzaG93QWR2YW5jZWRTZWN0aW9uKSB7XG4gICAgICAgICAgICBhZHZhbmNlZFNlY3Rpb24gPSA8PlxuICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uIG9uQ2xpY2s9e3RvZ2dsZUFkdmFuY2VkU2VjdGlvbn0ga2luZD1cImxpbmtcIiBjbGFzc05hbWU9XCJteF9TZXR0aW5nc1RhYl9zaG93QWR2YW5jZWRcIj5cbiAgICAgICAgICAgICAgICAgICAgeyBfdChcIkhpZGUgYWR2YW5jZWRcIikgfVxuICAgICAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj5cblxuICAgICAgICAgICAgICAgIDxMYWJlbGxlZFRvZ2dsZVN3aXRjaFxuICAgICAgICAgICAgICAgICAgICB2YWx1ZT17Z3Vlc3RBY2Nlc3NFbmFibGVkfVxuICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZT17c2V0R3Vlc3RBY2Nlc3NFbmFibGVkfVxuICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZD17IWNhblNldEd1ZXN0QWNjZXNzfVxuICAgICAgICAgICAgICAgICAgICBsYWJlbD17X3QoXCJFbmFibGUgZ3Vlc3QgYWNjZXNzXCIpfVxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgPHA+XG4gICAgICAgICAgICAgICAgICAgIHsgX3QoXCJHdWVzdHMgY2FuIGpvaW4gYSBzcGFjZSB3aXRob3V0IGhhdmluZyBhbiBhY2NvdW50LlwiKSB9XG4gICAgICAgICAgICAgICAgICAgIDxiciAvPlxuICAgICAgICAgICAgICAgICAgICB7IF90KFwiVGhpcyBtYXkgYmUgdXNlZnVsIGZvciBwdWJsaWMgc3BhY2VzLlwiKSB9XG4gICAgICAgICAgICAgICAgPC9wPlxuICAgICAgICAgICAgPC8+O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYWR2YW5jZWRTZWN0aW9uID0gPD5cbiAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvbiBvbkNsaWNrPXt0b2dnbGVBZHZhbmNlZFNlY3Rpb259IGtpbmQ9XCJsaW5rXCIgY2xhc3NOYW1lPVwibXhfU2V0dGluZ3NUYWJfc2hvd0FkdmFuY2VkXCI+XG4gICAgICAgICAgICAgICAgICAgIHsgX3QoXCJTaG93IGFkdmFuY2VkXCIpIH1cbiAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICA8Lz47XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBsZXQgYWRkcmVzc2VzU2VjdGlvbjtcbiAgICBpZiAoc3BhY2UuZ2V0Sm9pblJ1bGUoKSA9PT0gSm9pblJ1bGUuUHVibGljKSB7XG4gICAgICAgIGFkZHJlc3Nlc1NlY3Rpb24gPSA8PlxuICAgICAgICAgICAgPHNwYW4gY2xhc3NOYW1lPVwibXhfU2V0dGluZ3NUYWJfc3ViaGVhZGluZ1wiPnsgX3QoXCJBZGRyZXNzXCIpIH08L3NwYW4+XG4gICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X1NldHRpbmdzVGFiX3NlY3Rpb24gbXhfU2V0dGluZ3NUYWJfc3Vic2VjdGlvblRleHRcIj5cbiAgICAgICAgICAgICAgICA8QWxpYXNTZXR0aW5nc1xuICAgICAgICAgICAgICAgICAgICByb29tSWQ9e3NwYWNlLnJvb21JZH1cbiAgICAgICAgICAgICAgICAgICAgY2FuU2V0Q2Fub25pY2FsQWxpYXM9e2NhblNldENhbm9uaWNhbH1cbiAgICAgICAgICAgICAgICAgICAgY2FuU2V0QWxpYXNlcz17dHJ1ZX1cbiAgICAgICAgICAgICAgICAgICAgY2Fub25pY2FsQWxpYXNFdmVudD17Y2Fub25pY2FsQWxpYXNFdn1cbiAgICAgICAgICAgICAgICAgICAgaGlkZVB1Ymxpc2hTZXR0aW5nPXt0cnVlfVxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgPC8+O1xuICAgIH1cblxuICAgIHJldHVybiA8ZGl2IGNsYXNzTmFtZT1cIm14X1NldHRpbmdzVGFiXCI+XG4gICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfU2V0dGluZ3NUYWJfaGVhZGluZ1wiPnsgX3QoXCJWaXNpYmlsaXR5XCIpIH08L2Rpdj5cblxuICAgICAgICB7IGVycm9yICYmIDxkaXYgY2xhc3NOYW1lPVwibXhfU3BhY2VSb29tVmlld19lcnJvclRleHRcIj57IGVycm9yIH08L2Rpdj4gfVxuXG4gICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfU2V0dGluZ3NUYWJfc2VjdGlvblwiPlxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9TZXR0aW5nc1RhYl9zZWN0aW9uX2NhcHRpb25cIj5cbiAgICAgICAgICAgICAgICB7IF90KFwiRGVjaWRlIHdobyBjYW4gdmlldyBhbmQgam9pbiAlKHNwYWNlTmFtZSlzLlwiLCB7IHNwYWNlTmFtZTogc3BhY2UubmFtZSB9KSB9XG4gICAgICAgICAgICA8L2Rpdj5cblxuICAgICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgICAgICA8Sm9pblJ1bGVTZXR0aW5nc1xuICAgICAgICAgICAgICAgICAgICByb29tPXtzcGFjZX1cbiAgICAgICAgICAgICAgICAgICAgb25FcnJvcj17KCkgPT4gc2V0RXJyb3IoX3QoXCJGYWlsZWQgdG8gdXBkYXRlIHRoZSB2aXNpYmlsaXR5IG9mIHRoaXMgc3BhY2VcIikpfVxuICAgICAgICAgICAgICAgICAgICBjbG9zZVNldHRpbmdzRm49e2Nsb3NlU2V0dGluZ3NGbn1cbiAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgPC9kaXY+XG5cbiAgICAgICAgICAgIHsgYWR2YW5jZWRTZWN0aW9uIH1cblxuICAgICAgICAgICAgPExhYmVsbGVkVG9nZ2xlU3dpdGNoXG4gICAgICAgICAgICAgICAgdmFsdWU9e2hpc3RvcnlWaXNpYmlsaXR5ID09PSBIaXN0b3J5VmlzaWJpbGl0eS5Xb3JsZFJlYWRhYmxlfVxuICAgICAgICAgICAgICAgIG9uQ2hhbmdlPXsoY2hlY2tlZDogYm9vbGVhbikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBzZXRIaXN0b3J5VmlzaWJpbGl0eShjaGVja2VkID8gSGlzdG9yeVZpc2liaWxpdHkuV29ybGRSZWFkYWJsZSA6IEhpc3RvcnlWaXNpYmlsaXR5LlNoYXJlZCk7XG4gICAgICAgICAgICAgICAgfX1cbiAgICAgICAgICAgICAgICBkaXNhYmxlZD17IWNhblNldEhpc3RvcnlWaXNpYmlsaXR5fVxuICAgICAgICAgICAgICAgIGxhYmVsPXtfdChcIlByZXZpZXcgU3BhY2VcIil9XG4gICAgICAgICAgICAvPlxuICAgICAgICAgICAgPGRpdj57IF90KFwiQWxsb3cgcGVvcGxlIHRvIHByZXZpZXcgeW91ciBzcGFjZSBiZWZvcmUgdGhleSBqb2luLlwiKSB9PC9kaXY+XG4gICAgICAgICAgICA8Yj57IF90KFwiUmVjb21tZW5kZWQgZm9yIHB1YmxpYyBzcGFjZXMuXCIpIH08L2I+XG4gICAgICAgIDwvZGl2PlxuXG4gICAgICAgIHsgYWRkcmVzc2VzU2VjdGlvbiB9XG4gICAgPC9kaXY+O1xufTtcblxuZXhwb3J0IGRlZmF1bHQgU3BhY2VTZXR0aW5nc1Zpc2liaWxpdHlUYWI7XG4iXX0=