"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireWildcard(require("react"));

var _event = require("matrix-js-sdk/src/@types/event");

var _languageHandler = require("../../../languageHandler");

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _SpaceBasicSettings = _interopRequireDefault(require("./SpaceBasicSettings"));

var _Avatar = require("../../../Avatar");

var _RoomTopic = require("../elements/RoomTopic");

var _space = require("../../../utils/space");

var _logger = require("matrix-js-sdk/src/logger");

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/*
Copyright 2021 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const SpaceSettingsGeneralTab = ({
  matrixClient: cli,
  space,
  onFinished
}) => {
  const [busy, setBusy] = (0, _react.useState)(false);
  const [error, setError] = (0, _react.useState)("");
  const userId = cli.getUserId();
  const [newAvatar, setNewAvatar] = (0, _react.useState)(null); // undefined means to remove avatar

  const canSetAvatar = space.currentState.maySendStateEvent(_event.EventType.RoomAvatar, userId);
  const avatarChanged = newAvatar !== null;
  const [name, setName] = (0, _react.useState)(space.name);
  const canSetName = space.currentState.maySendStateEvent(_event.EventType.RoomName, userId);
  const nameChanged = name !== space.name;
  const currentTopic = (0, _RoomTopic.getTopic)(space);
  const [topic, setTopic] = (0, _react.useState)(currentTopic);
  const canSetTopic = space.currentState.maySendStateEvent(_event.EventType.RoomTopic, userId);
  const topicChanged = topic !== currentTopic;

  const onCancel = () => {
    setNewAvatar(null);
    setName(space.name);
    setTopic(currentTopic);
  };

  const onSave = async () => {
    setBusy(true);
    const promises = [];

    if (avatarChanged) {
      if (newAvatar) {
        promises.push(cli.sendStateEvent(space.roomId, _event.EventType.RoomAvatar, {
          url: await cli.uploadContent(newAvatar)
        }, ""));
      } else {
        promises.push(cli.sendStateEvent(space.roomId, _event.EventType.RoomAvatar, {}, ""));
      }
    }

    if (nameChanged) {
      promises.push(cli.setRoomName(space.roomId, name));
    }

    if (topicChanged) {
      promises.push(cli.setRoomTopic(space.roomId, topic));
    }

    const results = await Promise.allSettled(promises);
    setBusy(false);
    const failures = results.filter(r => r.status === "rejected");

    if (failures.length > 0) {
      _logger.logger.error("Failed to save space settings: ", failures);

      setError((0, _languageHandler._t)("Failed to save space settings."));
    }
  };

  return /*#__PURE__*/_react.default.createElement("div", {
    className: "mx_SettingsTab"
  }, /*#__PURE__*/_react.default.createElement("div", {
    className: "mx_SettingsTab_heading"
  }, (0, _languageHandler._t)("General")), /*#__PURE__*/_react.default.createElement("div", null, (0, _languageHandler._t)("Edit settings relating to your space.")), error && /*#__PURE__*/_react.default.createElement("div", {
    className: "mx_SpaceRoomView_errorText"
  }, error), /*#__PURE__*/_react.default.createElement("div", {
    className: "mx_SettingsTab_section"
  }, /*#__PURE__*/_react.default.createElement(_SpaceBasicSettings.default, {
    avatarUrl: (0, _Avatar.avatarUrlForRoom)(space, 80, 80, "crop"),
    avatarDisabled: busy || !canSetAvatar,
    setAvatar: setNewAvatar,
    name: name,
    nameDisabled: busy || !canSetName,
    setName: setName,
    topic: topic,
    topicDisabled: busy || !canSetTopic,
    setTopic: setTopic
  }), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
    onClick: onCancel,
    disabled: busy || !(avatarChanged || nameChanged || topicChanged),
    kind: "link"
  }, (0, _languageHandler._t)("Cancel")), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
    onClick: onSave,
    disabled: busy,
    kind: "primary"
  }, busy ? (0, _languageHandler._t)("Saving...") : (0, _languageHandler._t)("Save Changes"))), /*#__PURE__*/_react.default.createElement("span", {
    className: "mx_SettingsTab_subheading"
  }, (0, _languageHandler._t)("Leave Space")), /*#__PURE__*/_react.default.createElement("div", {
    className: "mx_SettingsTab_section mx_SettingsTab_subsectionText"
  }, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
    kind: "danger",
    onClick: () => {
      (0, _space.leaveSpace)(space);
    }
  }, (0, _languageHandler._t)("Leave Space"))));
};

var _default = SpaceSettingsGeneralTab;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3NwYWNlcy9TcGFjZVNldHRpbmdzR2VuZXJhbFRhYi50c3giXSwibmFtZXMiOlsiU3BhY2VTZXR0aW5nc0dlbmVyYWxUYWIiLCJtYXRyaXhDbGllbnQiLCJjbGkiLCJzcGFjZSIsIm9uRmluaXNoZWQiLCJidXN5Iiwic2V0QnVzeSIsImVycm9yIiwic2V0RXJyb3IiLCJ1c2VySWQiLCJnZXRVc2VySWQiLCJuZXdBdmF0YXIiLCJzZXROZXdBdmF0YXIiLCJjYW5TZXRBdmF0YXIiLCJjdXJyZW50U3RhdGUiLCJtYXlTZW5kU3RhdGVFdmVudCIsIkV2ZW50VHlwZSIsIlJvb21BdmF0YXIiLCJhdmF0YXJDaGFuZ2VkIiwibmFtZSIsInNldE5hbWUiLCJjYW5TZXROYW1lIiwiUm9vbU5hbWUiLCJuYW1lQ2hhbmdlZCIsImN1cnJlbnRUb3BpYyIsInRvcGljIiwic2V0VG9waWMiLCJjYW5TZXRUb3BpYyIsIlJvb21Ub3BpYyIsInRvcGljQ2hhbmdlZCIsIm9uQ2FuY2VsIiwib25TYXZlIiwicHJvbWlzZXMiLCJwdXNoIiwic2VuZFN0YXRlRXZlbnQiLCJyb29tSWQiLCJ1cmwiLCJ1cGxvYWRDb250ZW50Iiwic2V0Um9vbU5hbWUiLCJzZXRSb29tVG9waWMiLCJyZXN1bHRzIiwiUHJvbWlzZSIsImFsbFNldHRsZWQiLCJmYWlsdXJlcyIsImZpbHRlciIsInIiLCJzdGF0dXMiLCJsZW5ndGgiLCJsb2dnZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQWdCQTs7QUFHQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFFQTs7Ozs7O0FBN0JBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQXNCQSxNQUFNQSx1QkFBdUIsR0FBRyxDQUFDO0FBQUVDLEVBQUFBLFlBQVksRUFBRUMsR0FBaEI7QUFBcUJDLEVB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ekIsSUFBSSxJQUFJLEVBQUVhLGFBQWEsSUFBSUssV0FBakIsSUFBZ0NNLFlBQWxDLENBRnRCO0FBR0ksSUFBQSxJQUFJLEVBQUM7QUFIVCxLQUtNLHlCQUFHLFFBQUgsQ0FMTixDQWJKLGVBb0JJLDZCQUFDLHlCQUFEO0FBQWtCLElBQUEsT0FBTyxFQUFFRSxNQUEzQjtBQUFtQyxJQUFBLFFBQVEsRUFBRTFCLElBQTdDO0FBQW1ELElBQUEsSUFBSSxFQUFDO0FBQXhELEtBQ01BLElBQUksR0FBRyx5QkFBRyxXQUFILENBQUgsR0FBcUIseUJBQUcsY0FBSCxDQUQvQixDQXBCSixDQVBHLGVBZ0NIO0FBQU0sSUFBQSxTQUFTLEVBQUM7QUFBaEIsS0FBOEMseUJBQUcsYUFBSCxDQUE5QyxDQWhDRyxlQWlDSDtBQUFLLElBQUEsU0FBUyxFQUFDO0FBQWYsa0JBQ0ksNkJBQUMseUJBQUQ7QUFDSSxJQUFBLElBQUksRUFBQyxRQURUO0FBRUksSUFBQSxPQUFPLEVBQUUsTUFBTTtBQUNYLDZCQUFXRixLQUFYO0FBQ0g7QUFKTCxLQU1NLHlCQUFHLGFBQUgsQ0FOTixDQURKLENBakNHLENBQVA7QUE0Q0gsQ0FwR0Q7O2VBc0dlSCx1QiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAyMSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCwgeyB1c2VTdGF0ZSB9IGZyb20gXCJyZWFjdFwiO1xuaW1wb3J0IHsgUm9vbSB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvcm9vbVwiO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2NsaWVudFwiO1xuaW1wb3J0IHsgRXZlbnRUeXBlIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL0B0eXBlcy9ldmVudFwiO1xuXG5pbXBvcnQgeyBfdCB9IGZyb20gXCIuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXJcIjtcbmltcG9ydCBBY2Nlc3NpYmxlQnV0dG9uIGZyb20gXCIuLi9lbGVtZW50cy9BY2Nlc3NpYmxlQnV0dG9uXCI7XG5pbXBvcnQgU3BhY2VCYXNpY1NldHRpbmdzIGZyb20gXCIuL1NwYWNlQmFzaWNTZXR0aW5nc1wiO1xuaW1wb3J0IHsgYXZhdGFyVXJsRm9yUm9vbSB9IGZyb20gXCIuLi8uLi8uLi9BdmF0YXJcIjtcbmltcG9ydCB7IElEaWFsb2dQcm9wcyB9IGZyb20gXCIuLi9kaWFsb2dzL0lEaWFsb2dQcm9wc1wiO1xuaW1wb3J0IHsgZ2V0VG9waWMgfSBmcm9tIFwiLi4vZWxlbWVudHMvUm9vbVRvcGljXCI7XG5pbXBvcnQgeyBsZWF2ZVNwYWNlIH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3NwYWNlXCI7XG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcblxuaW50ZXJmYWNlIElQcm9wcyBleHRlbmRzIElEaWFsb2dQcm9wcyB7XG4gICAgbWF0cml4Q2xpZW50OiBNYXRyaXhDbGllbnQ7XG4gICAgc3BhY2U6IFJvb207XG59XG5cbmNvbnN0IFNwYWNlU2V0dGluZ3NHZW5lcmFsVGFiID0gKHsgbWF0cml4Q2xpZW50OiBjbGksIHNwYWNlLCBvbkZpbmlzaGVkIH06IElQcm9wcykgPT4ge1xuICAgIGNvbnN0IFtidXN5LCBzZXRCdXN5XSA9IHVzZVN0YXRlKGZhbHNlKTtcbiAgICBjb25zdCBbZXJyb3IsIHNldEVycm9yXSA9IHVzZVN0YXRlKFwiXCIpO1xuXG4gICAgY29uc3QgdXNlcklkID0gY2xpLmdldFVzZXJJZCgpO1xuXG4gICAgY29uc3QgW25ld0F2YXRhciwgc2V0TmV3QXZhdGFyXSA9IHVzZVN0YXRlPEZpbGU+KG51bGwpOyAvLyB1bmRlZmluZWQgbWVhbnMgdG8gcmVtb3ZlIGF2YXRhclxuICAgIGNvbnN0IGNhblNldEF2YXRhciA9IHNwYWNlLmN1cnJlbnRTdGF0ZS5tYXlTZW5kU3RhdGVFdmVudChFdmVudFR5cGUuUm9vbUF2YXRhciwgdXNlcklkKTtcbiAgICBjb25zdCBhdmF0YXJDaGFuZ2VkID0gbmV3QXZhdGFyICE9PSBudWxsO1xuXG4gICAgY29uc3QgW25hbWUsIHNldE5hbWVdID0gdXNlU3RhdGU8c3RyaW5nPihzcGFjZS5uYW1lKTtcbiAgICBjb25zdCBjYW5TZXROYW1lID0gc3BhY2UuY3VycmVudFN0YXRlLm1heVNlbmRTdGF0ZUV2ZW50KEV2ZW50VHlwZS5Sb29tTmFtZSwgdXNlcklkKTtcbiAgICBjb25zdCBuYW1lQ2hhbmdlZCA9IG5hbWUgIT09IHNwYWNlLm5hbWU7XG5cbiAgICBjb25zdCBjdXJyZW50VG9waWMgPSBnZXRUb3BpYyhzcGFjZSk7XG4gICAgY29uc3QgW3RvcGljLCBzZXRUb3BpY10gPSB1c2VTdGF0ZTxzdHJpbmc+KGN1cnJlbnRUb3BpYyk7XG4gICAgY29uc3QgY2FuU2V0VG9waWMgPSBzcGFjZS5jdXJyZW50U3RhdGUubWF5U2VuZFN0YXRlRXZlbnQoRXZlbnRUeXBlLlJvb21Ub3BpYywgdXNlcklkKTtcbiAgICBjb25zdCB0b3BpY0NoYW5nZWQgPSB0b3BpYyAhPT0gY3VycmVudFRvcGljO1xuXG4gICAgY29uc3Qgb25DYW5jZWwgPSAoKSA9PiB7XG4gICAgICAgIHNldE5ld0F2YXRhcihudWxsKTtcbiAgICAgICAgc2V0TmFtZShzcGFjZS5uYW1lKTtcbiAgICAgICAgc2V0VG9waWMoY3VycmVudFRvcGljKTtcbiAgICB9O1xuXG4gICAgY29uc3Qgb25TYXZlID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICBzZXRCdXN5KHRydWUpO1xuICAgICAgICBjb25zdCBwcm9taXNlcyA9IFtdO1xuXG4gICAgICAgIGlmIChhdmF0YXJDaGFuZ2VkKSB7XG4gICAgICAgICAgICBpZiAobmV3QXZhdGFyKSB7XG4gICAgICAgICAgICAgICAgcHJvbWlzZXMucHVzaChjbGkuc2VuZFN0YXRlRXZlbnQoc3BhY2Uucm9vbUlkLCBFdmVudFR5cGUuUm9vbUF2YXRhciwge1xuICAgICAgICAgICAgICAgICAgICB1cmw6IGF3YWl0IGNsaS51cGxvYWRDb250ZW50KG5ld0F2YXRhciksXG4gICAgICAgICAgICAgICAgfSwgXCJcIikpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBwcm9taXNlcy5wdXNoKGNsaS5zZW5kU3RhdGVFdmVudChzcGFjZS5yb29tSWQsIEV2ZW50VHlwZS5Sb29tQXZhdGFyLCB7fSwgXCJcIikpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG5hbWVDaGFuZ2VkKSB7XG4gICAgICAgICAgICBwcm9taXNlcy5wdXNoKGNsaS5zZXRSb29tTmFtZShzcGFjZS5yb29tSWQsIG5hbWUpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0b3BpY0NoYW5nZWQpIHtcbiAgICAgICAgICAgIHByb21pc2VzLnB1c2goY2xpLnNldFJvb21Ub3BpYyhzcGFjZS5yb29tSWQsIHRvcGljKSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXN1bHRzID0gYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHByb21pc2VzKTtcbiAgICAgICAgc2V0QnVzeShmYWxzZSk7XG4gICAgICAgIGNvbnN0IGZhaWx1cmVzID0gcmVzdWx0cy5maWx0ZXIociA9PiByLnN0YXR1cyA9PT0gXCJyZWplY3RlZFwiKTtcbiAgICAgICAgaWYgKGZhaWx1cmVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihcIkZhaWxlZCB0byBzYXZlIHNwYWNlIHNldHRpbmdzOiBcIiwgZmFpbHVyZXMpO1xuICAgICAgICAgICAgc2V0RXJyb3IoX3QoXCJGYWlsZWQgdG8gc2F2ZSBzcGFjZSBzZXR0aW5ncy5cIikpO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIHJldHVybiA8ZGl2IGNsYXNzTmFtZT1cIm14X1NldHRpbmdzVGFiXCI+XG4gICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfU2V0dGluZ3NUYWJfaGVhZGluZ1wiPnsgX3QoXCJHZW5lcmFsXCIpIH08L2Rpdj5cblxuICAgICAgICA8ZGl2PnsgX3QoXCJFZGl0IHNldHRpbmdzIHJlbGF0aW5nIHRvIHlvdXIgc3BhY2UuXCIpIH08L2Rpdj5cblxuICAgICAgICB7IGVycm9yICYmIDxkaXYgY2xhc3NOYW1lPVwibXhfU3BhY2VSb29tVmlld19lcnJvclRleHRcIj57IGVycm9yIH08L2Rpdj4gfVxuXG4gICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfU2V0dGluZ3NUYWJfc2VjdGlvblwiPlxuICAgICAgICAgICAgPFNwYWNlQmFzaWNTZXR0aW5nc1xuICAgICAgICAgICAgICAgIGF2YXRhclVybD17YXZhdGFyVXJsRm9yUm9vbShzcGFjZSwgODAsIDgwLCBcImNyb3BcIil9XG4gICAgICAgICAgICAgICAgYXZhdGFyRGlzYWJsZWQ9e2J1c3kgfHwgIWNhblNldEF2YXRhcn1cbiAgICAgICAgICAgICAgICBzZXRBdmF0YXI9e3NldE5ld0F2YXRhcn1cbiAgICAgICAgICAgICAgICBuYW1lPXtuYW1lfVxuICAgICAgICAgICAgICAgIG5hbWVEaXNhYmxlZD17YnVzeSB8fCAhY2FuU2V0TmFtZX1cbiAgICAgICAgICAgICAgICBzZXROYW1lPXtzZXROYW1lfVxuICAgICAgICAgICAgICAgIHRvcGljPXt0b3BpY31cbiAgICAgICAgICAgICAgICB0b3BpY0Rpc2FibGVkPXtidXN5IHx8ICFjYW5TZXRUb3BpY31cbiAgICAgICAgICAgICAgICBzZXRUb3BpYz17c2V0VG9waWN9XG4gICAgICAgICAgICAvPlxuXG4gICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvblxuICAgICAgICAgICAgICAgIG9uQ2xpY2s9e29uQ2FuY2VsfVxuICAgICAgICAgICAgICAgIGRpc2FibGVkPXtidXN5IHx8ICEoYXZhdGFyQ2hhbmdlZCB8fCBuYW1lQ2hhbmdlZCB8fCB0b3BpY0NoYW5nZWQpfVxuICAgICAgICAgICAgICAgIGtpbmQ9XCJsaW5rXCJcbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICB7IF90KFwiQ2FuY2VsXCIpIH1cbiAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj5cbiAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uIG9uQ2xpY2s9e29uU2F2ZX0gZGlzYWJsZWQ9e2J1c3l9IGtpbmQ9XCJwcmltYXJ5XCI+XG4gICAgICAgICAgICAgICAgeyBidXN5ID8gX3QoXCJTYXZpbmcuLi5cIikgOiBfdChcIlNhdmUgQ2hhbmdlc1wiKSB9XG4gICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgIDwvZGl2PlxuXG4gICAgICAgIDxzcGFuIGNsYXNzTmFtZT1cIm14X1NldHRpbmdzVGFiX3N1YmhlYWRpbmdcIj57IF90KFwiTGVhdmUgU3BhY2VcIikgfTwvc3Bhbj5cbiAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9TZXR0aW5nc1RhYl9zZWN0aW9uIG14X1NldHRpbmdzVGFiX3N1YnNlY3Rpb25UZXh0XCI+XG4gICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvblxuICAgICAgICAgICAgICAgIGtpbmQ9XCJkYW5nZXJcIlxuICAgICAgICAgICAgICAgIG9uQ2xpY2s9eygpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbGVhdmVTcGFjZShzcGFjZSk7XG4gICAgICAgICAgICAgICAgfX1cbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICB7IF90KFwiTGVhdmUgU3BhY2VcIikgfVxuICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICA8L2Rpdj5cbiAgICA8L2Rpdj47XG59O1xuXG5leHBvcnQgZGVmYXVsdCBTcGFjZVNldHRpbmdzR2VuZXJhbFRhYjtcbiJdfQ==