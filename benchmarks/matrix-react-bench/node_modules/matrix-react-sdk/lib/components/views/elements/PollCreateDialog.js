"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _ScrollableBaseModal = _interopRequireDefault(require("../dialogs/ScrollableBaseModal"));

var _QuestionDialog = _interopRequireDefault(require("../dialogs/QuestionDialog"));

var _react = _interopRequireWildcard(require("react"));

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _languageHandler = require("../../../languageHandler");

var _arrays = require("../../../utils/arrays");

var _Field = _interopRequireDefault(require("./Field"));

var _AccessibleButton = _interopRequireDefault(require("./AccessibleButton"));

var _consts = require("../../../polls/consts");

var _Spinner = _interopRequireDefault(require("./Spinner"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/*
Copyright 2021 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const MIN_OPTIONS = 2;
const MAX_OPTIONS = 20;
const DEFAULT_NUM_OPTIONS = 2;
const MAX_QUESTION_LENGTH = 340;
const MAX_OPTION_LENGTH = 340;

class PollCreateDialog extends _ScrollableBaseModal.default {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "addOptionRef", /*#__PURE__*/(0, _react.createRef)());
    (0, _defineProperty2.default)(this, "onQuestionChange", e => {
      this.setState({
        question: e.target.value
      }, () => this.checkCanSubmit());
    });
    (0, _defineProperty2.default)(this, "onOptionChange", (i, e) => {
      const newOptions = (0, _arrays.arrayFastClone)(this.state.options);
      newOptions[i] = e.target.value;
      this.setState({
        options: newOptions
      }, () => this.checkCanSubmit());
    });
    (0, _defineProperty2.default)(this, "onOptionRemove", i => {
      const newOptions = (0, _arrays.arrayFastClone)(this.state.options);
      newOptions.splice(i, 1);
      this.setState({
        options: newOptions
      }, () => this.checkCanSubmit());
    });
    (0, _defineProperty2.default)(this, "onOptionAdd", () => {
      const newOptions = (0, _arrays.arrayFastClone)(this.state.options);
      newOptions.push("");
      this.setState({
        options: newOptions
      }, () => {
        var _this$addOptionRef$cu, _this$addOptionRef$cu2;

        // Scroll the button into view after the state update to ensure we don't experience
        // a pop-in effect, and to avoid the button getting cut off due to a mid-scroll render.
        (_this$addOptionRef$cu = this.addOptionRef.current) === null || _this$addOptionRef$cu === void 0 ? void 0 : (_this$addOptionRef$cu2 = _this$addOptionRef$cu.scrollIntoView) === null || _this$addOptionRef$cu2 === void 0 ? void 0 : _this$addOptionRef$cu2.call(_this$addOptionRef$cu);
      });
    });
    this.state = {
      title: (0, _languageHandler._t)("Create poll"),
      actionLabel: (0, _languageHandler._t)("Create Poll"),
      canSubmit: false,
      // need to add a question and at least one option first
      question: "",
      options: (0, _arrays.arraySeed)("", DEFAULT_NUM_OPTIONS),
      busy: false
    };
  }

  checkCanSubmit() {
    this.setState({
      canSubmit: !this.state.busy && this.state.question.trim().length > 0 && this.state.options.filter(op => op.trim().length > 0).length >= MIN_OPTIONS
    });
  }

  submit() {
    this.setState({
      busy: true,
      canSubmit: false
    });
    this.matrixClient.sendEvent(this.props.room.roomId, _consts.POLL_START_EVENT_TYPE.name, (0, _consts.makePollContent)(this.state.question, this.state.options, _consts.POLL_KIND_DISCLOSED.name)).then(() => this.props.onFinished(true)).catch(e => {
      console.error("Failed to post poll:", e);

      _Modal.default.createTrackedDialog('Failed to post poll', '', _QuestionDialog.default, {
        title: (0, _languageHandler._t)("Failed to post poll"),
        description: (0, _languageHandler._t)("Sorry, the poll you tried to create was not posted."),
        button: (0, _languageHandler._t)('Try again'),
        cancelButton: (0, _languageHandler._t)('Cancel'),
        onFinished: tryAgain => {
          if (!tryAgain) {
            this.cancel();
          } else {
            this.setState({
              busy: false,
              canSubmit: true
            });
          }
        }
      });
    });
  }

  cancel() {
    this.props.onFinished(false);
  }

  renderContent() {
    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_PollCreateDialog"
    }, /*#__PURE__*/_react.default.createElement("h2", null, (0, _languageHandler._t)("What is your poll question or topic?")), /*#__PURE__*/_react.default.createElement(_Field.default, {
      value: this.state.question,
      maxLength: MAX_QUESTION_LENGTH,
      label: (0, _languageHandler._t)("Question or topic"),
      placeholder: (0, _languageHandler._t)("Write something..."),
      onChange: this.onQuestionChange,
      usePlaceholderAsHint: true,
      disabled: this.state.busy
    }), /*#__PURE__*/_react.default.createElement("h2", null, (0, _languageHandler._t)("Create options")), this.state.options.map((op, i) => /*#__PURE__*/_react.default.createElement("div", {
      key: `option_${i}`,
      className: "mx_PollCreateDialog_option"
    }, /*#__PURE__*/_react.default.createElement(_Field.default, {
      value: op,
      maxLength: MAX_OPTION_LENGTH,
      label: (0, _languageHandler._t)("Option %(number)s", {
        number: i + 1
      }),
      placeholder: (0, _languageHandler._t)("Write an option"),
      onChange: e => this.onOptionChange(i, e),
      usePlaceholderAsHint: true,
      disabled: this.state.busy
    }), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      onClick: () => this.onOptionRemove(i),
      className: "mx_PollCreateDialog_removeOption",
      disabled: this.state.busy
    }))), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      onClick: this.onOptionAdd,
      disabled: this.state.busy || this.state.options.length >= MAX_OPTIONS,
      kind: "secondary",
      className: "mx_PollCreateDialog_addOption",
      inputRef: this.addOptionRef
    }, (0, _languageHandler._t)("Add option")), this.state.busy && /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_PollCreateDialog_busy"
    }, /*#__PURE__*/_react.default.createElement(_Spinner.default, null)));
  }

}

exports.default = PollCreateDialog;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2VsZW1lbnRzL1BvbGxDcmVhdGVEaWFsb2cudHN4Il0sIm5hbWVzIjpbIk1JTl9PUFRJT05TIiwiTUFYX09QVElPTlMiLCJERUZBVUxUX05VTV9PUFRJT05TIiwiTUFYX1FVRVNUSU9OX0xFTkdUSCIsIk1BWF9PUFRJT05fTEVOR1RIIiwiUG9sbENyZWF0ZURpYWxvZyIsIlNjcm9sbGFibGVCYXNlTW9kYWwiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwiZSIsInNldFN0YXRlIiwicXVlc3Rpb24iLCJ0YXJnZXQiLCJ2YWx1ZSIsImNoZWNrQ2FuU3VibWl0IiwiaSIsIm5ld09wdGlvbnMiLCJzdGF0ZSIsIm9wdGlvbnMiLCJzcGxpY2UiLCJwdXNoIiwiYWRkT3B0aW9uUmVmIiwiY3VycmVudCIsInNjcm9sbEludG9WaWV3IiwidGl0bGUiLCJhY3Rpb25MYWJlbCIsImNhblN1Ym1pdCIsImJ1c3kiLCJ0cmltIiwibGVuZ3RoIiwiZmlsdGVyIiwib3AiLCJzdWJtaXQiLCJtYXRyaXhDbGllbnQiLCJzZW5kRXZlbnQiLCJyb29tIiwicm9vbUlkIiwiUE9MTF9TVEFSVF9FVkVOVF9UWVBFIiwibmFtZSIsIlBPTExfS0lORF9ESVNDTE9TRUQiLCJ0aGVuIiwib25GaW5pc2hlZCIsImNhdGNoIiwiY29uc29sZSIsImVycm9yIiwiTW9kYWwiLCJjcmVhdGVUcmFja2VkRGlhbG9nIiwiUXVlc3Rpb25EaWFsb2ciLCJkZXNjcmlwdGlvbiIsImJ1dHRvbiIsImNhbmNlbEJ1dHRvbiIsInRyeUFnYWluIiwiY2FuY2VsIiwicmVuZGVyQ29udGVudCIsIm9uUXVlc3Rpb25DaGFuZ2UiLCJtYXAiLCJudW1iZXIiLCJvbk9wdGlvbkNoYW5nZSIsIm9uT3B0aW9uUmVtb3ZlIiwib25PcHRpb25BZGQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztB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QVB6QixNQUQ4QixlQVU5Qiw2QkFBQyx5QkFBRDtBQUNJLE1BQUEsT0FBTyxFQUFFLE1BQU0sS0FBSytCLGNBQUwsQ0FBb0IzQyxDQUFwQixDQURuQjtBQUVJLE1BQUEsU0FBUyxFQUFDLGtDQUZkO0FBR0ksTUFBQSxRQUFRLEVBQUUsS0FBS0UsS0FBTCxDQUFXVTtBQUh6QixNQVY4QixDQUFsQyxDQWJELGVBOEJILDZCQUFDLHlCQUFEO0FBQ0ksTUFBQSxPQUFPLEVBQUUsS0FBS2dDLFdBRGxCO0FBRUksTUFBQSxRQUFRLEVBQUUsS0FBSzFDLEtBQUwsQ0FBV1UsSUFBWCxJQUFtQixLQUFLVixLQUFMLENBQVdDLE9BQVgsQ0FBbUJXLE1BQW5CLElBQTZCNUIsV0FGOUQ7QUFHSSxNQUFBLElBQUksRUFBQyxXQUhUO0FBSUksTUFBQSxTQUFTLEVBQUMsK0JBSmQ7QUFLSSxNQUFBLFFBQVEsRUFBRSxLQUFLb0I7QUFMbkIsT0FNRyx5QkFBRyxZQUFILENBTkgsQ0E5QkcsRUFzQ0MsS0FBS0osS0FBTCxDQUFXVSxJQUFYLGlCQUNJO0FBQUssTUFBQSxTQUFTLEVBQUM7QUFBZixvQkFBMEMsNkJBQUMsZ0JBQUQsT0FBMUMsQ0F2Q0wsQ0FBUDtBQTBDSDs7QUFySTZFIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDIxIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFNjcm9sbGFibGVCYXNlTW9kYWwsIHsgSVNjcm9sbGFibGVCYXNlU3RhdGUgfSBmcm9tIFwiLi4vZGlhbG9ncy9TY3JvbGxhYmxlQmFzZU1vZGFsXCI7XG5pbXBvcnQgeyBJRGlhbG9nUHJvcHMgfSBmcm9tIFwiLi4vZGlhbG9ncy9JRGlhbG9nUHJvcHNcIjtcbmltcG9ydCBRdWVzdGlvbkRpYWxvZyBmcm9tIFwiLi4vZGlhbG9ncy9RdWVzdGlvbkRpYWxvZ1wiO1xuaW1wb3J0IFJlYWN0LCB7IENoYW5nZUV2ZW50LCBjcmVhdGVSZWYgfSBmcm9tIFwicmVhY3RcIjtcbmltcG9ydCBNb2RhbCBmcm9tICcuLi8uLi8uLi9Nb2RhbCc7XG5pbXBvcnQgeyBfdCB9IGZyb20gXCIuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXJcIjtcbmltcG9ydCB7IFJvb20gfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3Jvb21cIjtcbmltcG9ydCB7IGFycmF5RmFzdENsb25lLCBhcnJheVNlZWQgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvYXJyYXlzXCI7XG5pbXBvcnQgRmllbGQgZnJvbSBcIi4vRmllbGRcIjtcbmltcG9ydCBBY2Nlc3NpYmxlQnV0dG9uIGZyb20gXCIuL0FjY2Vzc2libGVCdXR0b25cIjtcbmltcG9ydCB7IG1ha2VQb2xsQ29udGVudCwgUE9MTF9LSU5EX0RJU0NMT1NFRCwgUE9MTF9TVEFSVF9FVkVOVF9UWVBFIH0gZnJvbSBcIi4uLy4uLy4uL3BvbGxzL2NvbnN0c1wiO1xuaW1wb3J0IFNwaW5uZXIgZnJvbSBcIi4vU3Bpbm5lclwiO1xuXG5pbnRlcmZhY2UgSVByb3BzIGV4dGVuZHMgSURpYWxvZ1Byb3BzIHtcbiAgICByb29tOiBSb29tO1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIGV4dGVuZHMgSVNjcm9sbGFibGVCYXNlU3RhdGUge1xuICAgIHF1ZXN0aW9uOiBzdHJpbmc7XG4gICAgb3B0aW9uczogc3RyaW5nW107XG4gICAgYnVzeTogYm9vbGVhbjtcbn1cblxuY29uc3QgTUlOX09QVElPTlMgPSAyO1xuY29uc3QgTUFYX09QVElPTlMgPSAyMDtcbmNvbnN0IERFRkFVTFRfTlVNX09QVElPTlMgPSAyO1xuY29uc3QgTUFYX1FVRVNUSU9OX0xFTkdUSCA9IDM0MDtcbmNvbnN0IE1BWF9PUFRJT05fTEVOR1RIID0gMzQwO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBQb2xsQ3JlYXRlRGlhbG9nIGV4dGVuZHMgU2Nyb2xsYWJsZUJhc2VNb2RhbDxJUHJvcHMsIElTdGF0ZT4ge1xuICAgIHByaXZhdGUgYWRkT3B0aW9uUmVmID0gY3JlYXRlUmVmPEhUTUxEaXZFbGVtZW50PigpO1xuXG4gICAgcHVibGljIGNvbnN0cnVjdG9yKHByb3BzOiBJUHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuXG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICB0aXRsZTogX3QoXCJDcmVhdGUgcG9sbFwiKSxcbiAgICAgICAgICAgIGFjdGlvbkxhYmVsOiBfdChcIkNyZWF0ZSBQb2xsXCIpLFxuICAgICAgICAgICAgY2FuU3VibWl0OiBmYWxzZSwgLy8gbmVlZCB0byBhZGQgYSBxdWVzdGlvbiBhbmQgYXQgbGVhc3Qgb25lIG9wdGlvbiBmaXJzdFxuXG4gICAgICAgICAgICBxdWVzdGlvbjogXCJcIixcbiAgICAgICAgICAgIG9wdGlvbnM6IGFycmF5U2VlZChcIlwiLCBERUZBVUxUX05VTV9PUFRJT05TKSxcbiAgICAgICAgICAgIGJ1c3k6IGZhbHNlLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgY2hlY2tDYW5TdWJtaXQoKSB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgY2FuU3VibWl0OlxuICAgICAgICAgICAgICAgICF0aGlzLnN0YXRlLmJ1c3kgJiZcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnF1ZXN0aW9uLnRyaW0oKS5sZW5ndGggPiAwICYmXG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS5vcHRpb25zLmZpbHRlcihvcCA9PiBvcC50cmltKCkubGVuZ3RoID4gMCkubGVuZ3RoID49IE1JTl9PUFRJT05TLFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uUXVlc3Rpb25DaGFuZ2UgPSAoZTogQ2hhbmdlRXZlbnQ8SFRNTElucHV0RWxlbWVudD4pID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IHF1ZXN0aW9uOiBlLnRhcmdldC52YWx1ZSB9LCAoKSA9PiB0aGlzLmNoZWNrQ2FuU3VibWl0KCkpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uT3B0aW9uQ2hhbmdlID0gKGk6IG51bWJlciwgZTogQ2hhbmdlRXZlbnQ8SFRNTElucHV0RWxlbWVudD4pID0+IHtcbiAgICAgICAgY29uc3QgbmV3T3B0aW9ucyA9IGFycmF5RmFzdENsb25lKHRoaXMuc3RhdGUub3B0aW9ucyk7XG4gICAgICAgIG5ld09wdGlvbnNbaV0gPSBlLnRhcmdldC52YWx1ZTtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IG9wdGlvbnM6IG5ld09wdGlvbnMgfSwgKCkgPT4gdGhpcy5jaGVja0NhblN1Ym1pdCgpKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbk9wdGlvblJlbW92ZSA9IChpOiBudW1iZXIpID0+IHtcbiAgICAgICAgY29uc3QgbmV3T3B0aW9ucyA9IGFycmF5RmFzdENsb25lKHRoaXMuc3RhdGUub3B0aW9ucyk7XG4gICAgICAgIG5ld09wdGlvbnMuc3BsaWNlKGksIDEpO1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgb3B0aW9uczogbmV3T3B0aW9ucyB9LCAoKSA9PiB0aGlzLmNoZWNrQ2FuU3VibWl0KCkpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uT3B0aW9uQWRkID0gKCkgPT4ge1xuICAgICAgICBjb25zdCBuZXdPcHRpb25zID0gYXJyYXlGYXN0Q2xvbmUodGhpcy5zdGF0ZS5vcHRpb25zKTtcbiAgICAgICAgbmV3T3B0aW9ucy5wdXNoKFwiXCIpO1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgb3B0aW9uczogbmV3T3B0aW9ucyB9LCAoKSA9PiB7XG4gICAgICAgICAgICAvLyBTY3JvbGwgdGhlIGJ1dHRvbiBpbnRvIHZpZXcgYWZ0ZXIgdGhlIHN0YXRlIHVwZGF0ZSB0byBlbnN1cmUgd2UgZG9uJ3QgZXhwZXJpZW5jZVxuICAgICAgICAgICAgLy8gYSBwb3AtaW4gZWZmZWN0LCBhbmQgdG8gYXZvaWQgdGhlIGJ1dHRvbiBnZXR0aW5nIGN1dCBvZmYgZHVlIHRvIGEgbWlkLXNjcm9sbCByZW5kZXIuXG4gICAgICAgICAgICB0aGlzLmFkZE9wdGlvblJlZi5jdXJyZW50Py5zY3JvbGxJbnRvVmlldz8uKCk7XG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBwcm90ZWN0ZWQgc3VibWl0KCk6IHZvaWQge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgYnVzeTogdHJ1ZSwgY2FuU3VibWl0OiBmYWxzZSB9KTtcbiAgICAgICAgdGhpcy5tYXRyaXhDbGllbnQuc2VuZEV2ZW50KFxuICAgICAgICAgICAgdGhpcy5wcm9wcy5yb29tLnJvb21JZCxcbiAgICAgICAgICAgIFBPTExfU1RBUlRfRVZFTlRfVFlQRS5uYW1lLFxuICAgICAgICAgICAgbWFrZVBvbGxDb250ZW50KFxuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUucXVlc3Rpb24sIHRoaXMuc3RhdGUub3B0aW9ucywgUE9MTF9LSU5EX0RJU0NMT1NFRC5uYW1lLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgKS50aGVuKFxuICAgICAgICAgICAgKCkgPT4gdGhpcy5wcm9wcy5vbkZpbmlzaGVkKHRydWUpLFxuICAgICAgICApLmNhdGNoKGUgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIkZhaWxlZCB0byBwb3N0IHBvbGw6XCIsIGUpO1xuICAgICAgICAgICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZyhcbiAgICAgICAgICAgICAgICAnRmFpbGVkIHRvIHBvc3QgcG9sbCcsXG4gICAgICAgICAgICAgICAgJycsXG4gICAgICAgICAgICAgICAgUXVlc3Rpb25EaWFsb2csXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICB0aXRsZTogX3QoXCJGYWlsZWQgdG8gcG9zdCBwb2xsXCIpLFxuICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogX3QoXG4gICAgICAgICAgICAgICAgICAgICAgICBcIlNvcnJ5LCB0aGUgcG9sbCB5b3UgdHJpZWQgdG8gY3JlYXRlIHdhcyBub3QgcG9zdGVkLlwiKSxcbiAgICAgICAgICAgICAgICAgICAgYnV0dG9uOiBfdCgnVHJ5IGFnYWluJyksXG4gICAgICAgICAgICAgICAgICAgIGNhbmNlbEJ1dHRvbjogX3QoJ0NhbmNlbCcpLFxuICAgICAgICAgICAgICAgICAgICBvbkZpbmlzaGVkOiAodHJ5QWdhaW46IGJvb2xlYW4pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdHJ5QWdhaW4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbmNlbCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgYnVzeTogZmFsc2UsIGNhblN1Ym1pdDogdHJ1ZSB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGNhbmNlbCgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5wcm9wcy5vbkZpbmlzaGVkKGZhbHNlKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgcmVuZGVyQ29udGVudCgpOiBSZWFjdC5SZWFjdE5vZGUge1xuICAgICAgICByZXR1cm4gPGRpdiBjbGFzc05hbWU9XCJteF9Qb2xsQ3JlYXRlRGlhbG9nXCI+XG4gICAgICAgICAgICA8aDI+eyBfdChcIldoYXQgaXMgeW91ciBwb2xsIHF1ZXN0aW9uIG9yIHRvcGljP1wiKSB9PC9oMj5cbiAgICAgICAgICAgIDxGaWVsZFxuICAgICAgICAgICAgICAgIHZhbHVlPXt0aGlzLnN0YXRlLnF1ZXN0aW9ufVxuICAgICAgICAgICAgICAgIG1heExlbmd0aD17TUFYX1FVRVNUSU9OX0xFTkdUSH1cbiAgICAgICAgICAgICAgICBsYWJlbD17X3QoXCJRdWVzdGlvbiBvciB0b3BpY1wiKX1cbiAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcj17X3QoXCJXcml0ZSBzb21ldGhpbmcuLi5cIil9XG4gICAgICAgICAgICAgICAgb25DaGFuZ2U9e3RoaXMub25RdWVzdGlvbkNoYW5nZX1cbiAgICAgICAgICAgICAgICB1c2VQbGFjZWhvbGRlckFzSGludD17dHJ1ZX1cbiAgICAgICAgICAgICAgICBkaXNhYmxlZD17dGhpcy5zdGF0ZS5idXN5fVxuICAgICAgICAgICAgLz5cbiAgICAgICAgICAgIDxoMj57IF90KFwiQ3JlYXRlIG9wdGlvbnNcIikgfTwvaDI+XG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS5vcHRpb25zLm1hcCgob3AsIGkpID0+IDxkaXYga2V5PXtgb3B0aW9uXyR7aX1gfSBjbGFzc05hbWU9XCJteF9Qb2xsQ3JlYXRlRGlhbG9nX29wdGlvblwiPlxuICAgICAgICAgICAgICAgICAgICA8RmllbGRcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlPXtvcH1cbiAgICAgICAgICAgICAgICAgICAgICAgIG1heExlbmd0aD17TUFYX09QVElPTl9MRU5HVEh9XG4gICAgICAgICAgICAgICAgICAgICAgICBsYWJlbD17X3QoXCJPcHRpb24gJShudW1iZXIpc1wiLCB7IG51bWJlcjogaSArIDEgfSl9XG4gICAgICAgICAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcj17X3QoXCJXcml0ZSBhbiBvcHRpb25cIil9XG4gICAgICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZT17ZSA9PiB0aGlzLm9uT3B0aW9uQ2hhbmdlKGksIGUpfVxuICAgICAgICAgICAgICAgICAgICAgICAgdXNlUGxhY2Vob2xkZXJBc0hpbnQ9e3RydWV9XG4gICAgICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZD17dGhpcy5zdGF0ZS5idXN5fVxuICAgICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvblxuICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17KCkgPT4gdGhpcy5vbk9wdGlvblJlbW92ZShpKX1cbiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X1BvbGxDcmVhdGVEaWFsb2dfcmVtb3ZlT3B0aW9uXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVkPXt0aGlzLnN0YXRlLmJ1c3l9XG4gICAgICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgPC9kaXY+KVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b25cbiAgICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLm9uT3B0aW9uQWRkfVxuICAgICAgICAgICAgICAgIGRpc2FibGVkPXt0aGlzLnN0YXRlLmJ1c3kgfHwgdGhpcy5zdGF0ZS5vcHRpb25zLmxlbmd0aCA+PSBNQVhfT1BUSU9OU31cbiAgICAgICAgICAgICAgICBraW5kPVwic2Vjb25kYXJ5XCJcbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9Qb2xsQ3JlYXRlRGlhbG9nX2FkZE9wdGlvblwiXG4gICAgICAgICAgICAgICAgaW5wdXRSZWY9e3RoaXMuYWRkT3B0aW9uUmVmfVxuICAgICAgICAgICAgPnsgX3QoXCJBZGQgb3B0aW9uXCIpIH08L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS5idXN5ICYmXG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfUG9sbENyZWF0ZURpYWxvZ19idXN5XCI+PFNwaW5uZXIgLz48L2Rpdj5cbiAgICAgICAgICAgIH1cbiAgICAgICAgPC9kaXY+O1xuICAgIH1cbn1cbiJdfQ==