"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _RoomViewStore = _interopRequireDefault(require("../../../stores/RoomViewStore"));

var _ActiveWidgetStore = _interopRequireWildcard(require("../../../stores/ActiveWidgetStore"));

var _WidgetUtils = _interopRequireDefault(require("../../../utils/WidgetUtils"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _AppTile = _interopRequireDefault(require("./AppTile"));

var _dec, _class;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

let PersistentApp = (_dec = (0, _replaceableComponent.replaceableComponent)("views.elements.PersistentApp"), _dec(_class = class PersistentApp extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "roomStoreToken", void 0);
    (0, _defineProperty2.default)(this, "onRoomViewStoreUpdate", () => {
      if (_RoomViewStore.default.getRoomId() === this.state.roomId) return;
      this.setState({
        roomId: _RoomViewStore.default.getRoomId()
      });
    });
    (0, _defineProperty2.default)(this, "onActiveWidgetStoreUpdate", () => {
      this.setState({
        persistentWidgetId: _ActiveWidgetStore.default.instance.getPersistentWidgetId()
      });
    });
    (0, _defineProperty2.default)(this, "onMyMembership", async (room, membership) => {
      const persistentWidgetInRoomId = _ActiveWidgetStore.default.instance.getRoomId(this.state.persistentWidgetId);

      if (membership !== "join") {
        // we're not in the room anymore - delete
        if (room.roomId === persistentWidgetInRoomId) {
          _ActiveWidgetStore.default.instance.destroyPersistentWidget(this.state.persistentWidgetId);
        }
      }
    });
    this.state = {
      roomId: _RoomViewStore.default.getRoomId(),
      persistentWidgetId: _ActiveWidgetStore.default.instance.getPersistentWidgetId()
    };
  }

  componentDidMount() {
    this.roomStoreToken = _RoomViewStore.default.addListener(this.onRoomViewStoreUpdate);

    _ActiveWidgetStore.default.instance.on(_ActiveWidgetStore.ActiveWidgetStoreEvent.Update, this.onActiveWidgetStoreUpdate);

    _MatrixClientPeg.MatrixClientPeg.get().on("Room.myMembership", this.onMyMembership);
  }

  componentWillUnmount() {
    if (this.roomStoreToken) {
      this.roomStoreToken.remove();
    }

    _ActiveWidgetStore.default.instance.removeListener(_ActiveWidgetStore.ActiveWidgetStoreEvent.Update, this.onActiveWidgetStoreUpdate);

    if (_MatrixClientPeg.MatrixClientPeg.get()) {
      _MatrixClientPeg.MatrixClientPeg.get().removeListener("Room.myMembership", this.onMyMembership);
    }
  }

  render() {
    if (this.state.persistentWidgetId) {
      const persistentWidgetInRoomId = _ActiveWidgetStore.default.instance.getRoomId(this.state.persistentWidgetId);

      const persistentWidgetInRoom = _MatrixClientPeg.MatrixClientPeg.get().getRoom(persistentWidgetInRoomId); // Sanity check the room - the widget may have been destroyed between render cycles, and
      // thus no room is associated anymore.


      if (!persistentWidgetInRoom) return null;
      const myMembership = persistentWidgetInRoom.getMyMembership();

      if (this.state.roomId !== persistentWidgetInRoomId && myMembership === "join") {
        // get the widget data
        const appEvent = _WidgetUtils.default.getRoomWidgets(persistentWidgetInRoom).find(ev => {
          return ev.getStateKey() === _ActiveWidgetStore.default.instance.getPersistentWidgetId();
        });

        const app = _WidgetUtils.default.makeAppConfig(appEvent.getStateKey(), appEvent.getContent(), appEvent.getSender(), persistentWidgetInRoomId, appEvent.getId());

        return /*#__PURE__*/_react.default.createElement(_AppTile.default, {
          key: app.id,
          app: app,
          fullWidth: true,
          room: persistentWidgetInRoom,
          userId: _MatrixClientPeg.MatrixClientPeg.get().credentials.userId,
          creatorUserId: app.creatorUserId,
          widgetPageTitle: _WidgetUtils.default.getWidgetDataTitle(app),
          waitForIframeLoad: app.waitForIframeLoad,
          miniMode: true,
          showMenubar: false
        });
      }
    }

    return null;
  }

}) || _class);
exports.default = PersistentApp;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2VsZW1lbnRzL1BlcnNpc3RlbnRBcHAudHN4Il0sIm5hbWVzIjpbIlBlcnNpc3RlbnRBcHAiLCJSZWFjdCIsIkNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJSb29tVmlld1N0b3JlIiwiZ2V0Um9vbUlkIiwic3RhdGUiLCJyb29tSWQiLCJzZXRTdGF0ZSIsInBlcnNpc3RlbnRXaWRnZXRJZCIsIkFjdGl2ZVdpZGdldFN0b3JlIiwiaW5zdGFuY2UiLCJnZXRQZXJzaXN0ZW50V2lkZ2V0SWQiLCJyb29tIiwibWVtYmVyc2hpcCIsInBlcnNpc3RlbnRXaWRnZXRJblJvb21JZCIsImRlc3Ryb3lQZXJzaXN0ZW50V2lkZ2V0IiwiY29tcG9uZW50RGlkTW91bnQiLCJyb29tU3RvcmVUb2tlbiIsImFkZExpc3RlbmVyIiwib25Sb29tVmlld1N0b3JlVXBkYXRlIiwib24iLCJBY3RpdmVXaWRnZXRTdG9yZUV2ZW50IiwiVXBkYXRlIiwib25BY3RpdmVXaWRnZXRTdG9yZVVwZGF0ZSIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsIm9uTXlNZW1iZXJzaGlwIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJyZW1vdmUiLCJyZW1vdmVMaXN0ZW5lciIsInJlbmRlciIsInBlcnNpc3RlbnRXaWRnZXRJblJvb20iLCJnZXRSb29tIiwibXlNZW1iZXJzaGlwIiwiZ2V0TXlNZW1iZXJzaGlwIiwiYXBwRXZlbnQiLCJXaWRnZXRVdGlscyIsImdldFJvb21XaWRnZXRzIiwiZmluZCIsImV2IiwiZ2V0U3RhdGVLZXkiLCJhcHAiLCJtYWtlQXBwQ29uZmlnIiwiZ2V0Q29udGVudCIsImdldFNlbmRlciIsImdldElkIiwiaWQiLCJjcmVkZW50aWFscyIsInVzZXJJZCIsImNyZWF0b3JVc2VySWQiLCJnZXRXaWRnZXREYXRhVGl0bGUiLCJ3YWl0Rm9ySWZyYW1lTG9hZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7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K0U7QUFDM0U7QUFDQSxjQUFNRSxRQUFRLEdBQUdDLHFCQUFZQyxjQUFaLENBQTJCTixzQkFBM0IsRUFBbURPLElBQW5ELENBQXlEQyxFQUFELElBQVE7QUFDN0UsaUJBQU9BLEVBQUUsQ0FBQ0MsV0FBSCxPQUFxQi9CLDJCQUFrQkMsUUFBbEIsQ0FBMkJDLHFCQUEzQixFQUE1QjtBQUNILFNBRmdCLENBQWpCOztBQUdBLGNBQU04QixHQUFHLEdBQUdMLHFCQUFZTSxhQUFaLENBQ1JQLFFBQVEsQ0FBQ0ssV0FBVCxFQURRLEVBQ2dCTCxRQUFRLENBQUNRLFVBQVQsRUFEaEIsRUFDdUNSLFFBQVEsQ0FBQ1MsU0FBVCxFQUR2QyxFQUVSOUIsd0JBRlEsRUFFa0JxQixRQUFRLENBQUNVLEtBQVQsRUFGbEIsQ0FBWjs7QUFJQSw0QkFBTyw2QkFBQyxnQkFBRDtBQUNILFVBQUEsR0FBRyxFQUFFSixHQUFHLENBQUNLLEVBRE47QUFFSCxVQUFBLEdBQUcsRUFBRUwsR0FGRjtBQUdILFVBQUEsU0FBUyxFQUFFLElBSFI7QUFJSCxVQUFBLElBQUksRUFBRVYsc0JBSkg7QUFLSCxVQUFBLE1BQU0sRUFBRVAsaUNBQWdCQyxHQUFoQixHQUFzQnNCLFdBQXRCLENBQWtDQyxNQUx2QztBQU1ILFVBQUEsYUFBYSxFQUFFUCxHQUFHLENBQUNRLGFBTmhCO0FBT0gsVUFBQSxlQUFlLEVBQUViLHFCQUFZYyxrQkFBWixDQUErQlQsR0FBL0IsQ0FQZDtBQVFILFVBQUEsaUJBQWlCLEVBQUVBLEdBQUcsQ0FBQ1UsaUJBUnBCO0FBU0gsVUFBQSxRQUFRLEVBQUUsSUFUUDtBQVVILFVBQUEsV0FBVyxFQUFFO0FBVlYsVUFBUDtBQVlIO0FBQ0o7O0FBQ0QsV0FBTyxJQUFQO0FBQ0g7O0FBdEZzRSxDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE4IE5ldyBWZWN0b3IgTHRkXG5Db3B5cmlnaHQgMjAxOSwgMjAyMCBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgUm9vbVZpZXdTdG9yZSBmcm9tICcuLi8uLi8uLi9zdG9yZXMvUm9vbVZpZXdTdG9yZSc7XG5pbXBvcnQgQWN0aXZlV2lkZ2V0U3RvcmUsIHsgQWN0aXZlV2lkZ2V0U3RvcmVFdmVudCB9IGZyb20gJy4uLy4uLy4uL3N0b3Jlcy9BY3RpdmVXaWRnZXRTdG9yZSc7XG5pbXBvcnQgV2lkZ2V0VXRpbHMgZnJvbSAnLi4vLi4vLi4vdXRpbHMvV2lkZ2V0VXRpbHMnO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSAnLi4vLi4vLi4vTWF0cml4Q2xpZW50UGVnJztcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5pbXBvcnQgeyBFdmVudFN1YnNjcmlwdGlvbiB9IGZyb20gJ2ZiZW1pdHRlcic7XG5pbXBvcnQgQXBwVGlsZSBmcm9tIFwiLi9BcHBUaWxlXCI7XG5pbXBvcnQgeyBSb29tIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yb29tXCI7XG5cbmludGVyZmFjZSBJUHJvcHMge1xuICAgIC8vIG5vbmVcbn1cblxuaW50ZXJmYWNlIElTdGF0ZSB7XG4gICAgcm9vbUlkOiBzdHJpbmc7XG4gICAgcGVyc2lzdGVudFdpZGdldElkOiBzdHJpbmc7XG59XG5cbkByZXBsYWNlYWJsZUNvbXBvbmVudChcInZpZXdzLmVsZW1lbnRzLlBlcnNpc3RlbnRBcHBcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFBlcnNpc3RlbnRBcHAgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8SVByb3BzLCBJU3RhdGU+IHtcbiAgICBwcml2YXRlIHJvb21TdG9yZVRva2VuOiBFdmVudFN1YnNjcmlwdGlvbjtcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBJUHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuXG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICByb29tSWQ6IFJvb21WaWV3U3RvcmUuZ2V0Um9vbUlkKCksXG4gICAgICAgICAgICBwZXJzaXN0ZW50V2lkZ2V0SWQ6IEFjdGl2ZVdpZGdldFN0b3JlLmluc3RhbmNlLmdldFBlcnNpc3RlbnRXaWRnZXRJZCgpLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHB1YmxpYyBjb21wb25lbnREaWRNb3VudCgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5yb29tU3RvcmVUb2tlbiA9IFJvb21WaWV3U3RvcmUuYWRkTGlzdGVuZXIodGhpcy5vblJvb21WaWV3U3RvcmVVcGRhdGUpO1xuICAgICAgICBBY3RpdmVXaWRnZXRTdG9yZS5pbnN0YW5jZS5vbihBY3RpdmVXaWRnZXRTdG9yZUV2ZW50LlVwZGF0ZSwgdGhpcy5vbkFjdGl2ZVdpZGdldFN0b3JlVXBkYXRlKTtcbiAgICAgICAgTWF0cml4Q2xpZW50UGVnLmdldCgpLm9uKFwiUm9vbS5teU1lbWJlcnNoaXBcIiwgdGhpcy5vbk15TWVtYmVyc2hpcCk7XG4gICAgfVxuXG4gICAgcHVibGljIGNvbXBvbmVudFdpbGxVbm1vdW50KCk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5yb29tU3RvcmVUb2tlbikge1xuICAgICAgICAgICAgdGhpcy5yb29tU3RvcmVUb2tlbi5yZW1vdmUoKTtcbiAgICAgICAgfVxuICAgICAgICBBY3RpdmVXaWRnZXRTdG9yZS5pbnN0YW5jZS5yZW1vdmVMaXN0ZW5lcihBY3RpdmVXaWRnZXRTdG9yZUV2ZW50LlVwZGF0ZSwgdGhpcy5vbkFjdGl2ZVdpZGdldFN0b3JlVXBkYXRlKTtcbiAgICAgICAgaWYgKE1hdHJpeENsaWVudFBlZy5nZXQoKSkge1xuICAgICAgICAgICAgTWF0cml4Q2xpZW50UGVnLmdldCgpLnJlbW92ZUxpc3RlbmVyKFwiUm9vbS5teU1lbWJlcnNoaXBcIiwgdGhpcy5vbk15TWVtYmVyc2hpcCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIG9uUm9vbVZpZXdTdG9yZVVwZGF0ZSA9ICgpOiB2b2lkID0+IHtcbiAgICAgICAgaWYgKFJvb21WaWV3U3RvcmUuZ2V0Um9vbUlkKCkgPT09IHRoaXMuc3RhdGUucm9vbUlkKSByZXR1cm47XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgcm9vbUlkOiBSb29tVmlld1N0b3JlLmdldFJvb21JZCgpLFxuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkFjdGl2ZVdpZGdldFN0b3JlVXBkYXRlID0gKCk6IHZvaWQgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIHBlcnNpc3RlbnRXaWRnZXRJZDogQWN0aXZlV2lkZ2V0U3RvcmUuaW5zdGFuY2UuZ2V0UGVyc2lzdGVudFdpZGdldElkKCksXG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uTXlNZW1iZXJzaGlwID0gYXN5bmMgKHJvb206IFJvb20sIG1lbWJlcnNoaXA6IHN0cmluZyk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgICAgICBjb25zdCBwZXJzaXN0ZW50V2lkZ2V0SW5Sb29tSWQgPSBBY3RpdmVXaWRnZXRTdG9yZS5pbnN0YW5jZS5nZXRSb29tSWQodGhpcy5zdGF0ZS5wZXJzaXN0ZW50V2lkZ2V0SWQpO1xuICAgICAgICBpZiAobWVtYmVyc2hpcCAhPT0gXCJqb2luXCIpIHtcbiAgICAgICAgICAgIC8vIHdlJ3JlIG5vdCBpbiB0aGUgcm9vbSBhbnltb3JlIC0gZGVsZXRlXG4gICAgICAgICAgICBpZiAocm9vbSAucm9vbUlkID09PSBwZXJzaXN0ZW50V2lkZ2V0SW5Sb29tSWQpIHtcbiAgICAgICAgICAgICAgICBBY3RpdmVXaWRnZXRTdG9yZS5pbnN0YW5jZS5kZXN0cm95UGVyc2lzdGVudFdpZGdldCh0aGlzLnN0YXRlLnBlcnNpc3RlbnRXaWRnZXRJZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHVibGljIHJlbmRlcigpOiBKU1guRWxlbWVudCB7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnBlcnNpc3RlbnRXaWRnZXRJZCkge1xuICAgICAgICAgICAgY29uc3QgcGVyc2lzdGVudFdpZGdldEluUm9vbUlkID0gQWN0aXZlV2lkZ2V0U3RvcmUuaW5zdGFuY2UuZ2V0Um9vbUlkKHRoaXMuc3RhdGUucGVyc2lzdGVudFdpZGdldElkKTtcblxuICAgICAgICAgICAgY29uc3QgcGVyc2lzdGVudFdpZGdldEluUm9vbSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRSb29tKHBlcnNpc3RlbnRXaWRnZXRJblJvb21JZCk7XG5cbiAgICAgICAgICAgIC8vIFNhbml0eSBjaGVjayB0aGUgcm9vbSAtIHRoZSB3aWRnZXQgbWF5IGhhdmUgYmVlbiBkZXN0cm95ZWQgYmV0d2VlbiByZW5kZXIgY3ljbGVzLCBhbmRcbiAgICAgICAgICAgIC8vIHRodXMgbm8gcm9vbSBpcyBhc3NvY2lhdGVkIGFueW1vcmUuXG4gICAgICAgICAgICBpZiAoIXBlcnNpc3RlbnRXaWRnZXRJblJvb20pIHJldHVybiBudWxsO1xuXG4gICAgICAgICAgICBjb25zdCBteU1lbWJlcnNoaXAgPSBwZXJzaXN0ZW50V2lkZ2V0SW5Sb29tLmdldE15TWVtYmVyc2hpcCgpO1xuICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUucm9vbUlkICE9PSBwZXJzaXN0ZW50V2lkZ2V0SW5Sb29tSWQgJiYgbXlNZW1iZXJzaGlwID09PSBcImpvaW5cIikge1xuICAgICAgICAgICAgICAgIC8vIGdldCB0aGUgd2lkZ2V0IGRhdGFcbiAgICAgICAgICAgICAgICBjb25zdCBhcHBFdmVudCA9IFdpZGdldFV0aWxzLmdldFJvb21XaWRnZXRzKHBlcnNpc3RlbnRXaWRnZXRJblJvb20pLmZpbmQoKGV2KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBldi5nZXRTdGF0ZUtleSgpID09PSBBY3RpdmVXaWRnZXRTdG9yZS5pbnN0YW5jZS5nZXRQZXJzaXN0ZW50V2lkZ2V0SWQoKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBjb25zdCBhcHAgPSBXaWRnZXRVdGlscy5tYWtlQXBwQ29uZmlnKFxuICAgICAgICAgICAgICAgICAgICBhcHBFdmVudC5nZXRTdGF0ZUtleSgpLCBhcHBFdmVudC5nZXRDb250ZW50KCksIGFwcEV2ZW50LmdldFNlbmRlcigpLFxuICAgICAgICAgICAgICAgICAgICBwZXJzaXN0ZW50V2lkZ2V0SW5Sb29tSWQsIGFwcEV2ZW50LmdldElkKCksXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gPEFwcFRpbGVcbiAgICAgICAgICAgICAgICAgICAga2V5PXthcHAuaWR9XG4gICAgICAgICAgICAgICAgICAgIGFwcD17YXBwfVxuICAgICAgICAgICAgICAgICAgICBmdWxsV2lkdGg9e3RydWV9XG4gICAgICAgICAgICAgICAgICAgIHJvb209e3BlcnNpc3RlbnRXaWRnZXRJblJvb219XG4gICAgICAgICAgICAgICAgICAgIHVzZXJJZD17TWF0cml4Q2xpZW50UGVnLmdldCgpLmNyZWRlbnRpYWxzLnVzZXJJZH1cbiAgICAgICAgICAgICAgICAgICAgY3JlYXRvclVzZXJJZD17YXBwLmNyZWF0b3JVc2VySWR9XG4gICAgICAgICAgICAgICAgICAgIHdpZGdldFBhZ2VUaXRsZT17V2lkZ2V0VXRpbHMuZ2V0V2lkZ2V0RGF0YVRpdGxlKGFwcCl9XG4gICAgICAgICAgICAgICAgICAgIHdhaXRGb3JJZnJhbWVMb2FkPXthcHAud2FpdEZvcklmcmFtZUxvYWR9XG4gICAgICAgICAgICAgICAgICAgIG1pbmlNb2RlPXt0cnVlfVxuICAgICAgICAgICAgICAgICAgICBzaG93TWVudWJhcj17ZmFsc2V9XG4gICAgICAgICAgICAgICAgLz47XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxufVxuXG4iXX0=