"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _url = _interopRequireDefault(require("url"));

var _languageHandler = require("../../../languageHandler");

var _SdkConfig = _interopRequireDefault(require("../../../SdkConfig"));

var _WidgetUtils = _interopRequireDefault(require("../../../utils/WidgetUtils"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _MemberAvatar = _interopRequireDefault(require("../avatars/MemberAvatar"));

var _BaseAvatar = _interopRequireDefault(require("../avatars/BaseAvatar"));

var _AccessibleButton = _interopRequireDefault(require("./AccessibleButton"));

var _TextWithTooltip = _interopRequireDefault(require("./TextWithTooltip"));

var _dec, _class, _class2, _temp;

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

let AppPermission = (_dec = (0, _replaceableComponent.replaceableComponent)("views.elements.AppPermission"), _dec(_class = (_temp = _class2 = class AppPermission extends _react.default.Component {
  constructor(props) {
    super(props); // The first step is to pick apart the widget so we can render information about it

    const urlInfo = this.parseWidgetUrl(); // The second step is to find the user's profile so we can show it on the prompt

    const room = _MatrixClientPeg.MatrixClientPeg.get().getRoom(this.props.roomId);

    let roomMember;
    if (room) roomMember = room.getMember(this.props.creatorUserId); // Set all this into the initial state

    this.state = _objectSpread({
      widgetDomain: null,
      isWrapped: null,
      roomMember
    }, urlInfo);
  }

  parseWidgetUrl() {
    const widgetUrl = _url.default.parse(this.props.url);

    const params = new URLSearchParams(widgetUrl.search); // HACK: We're relying on the query params when we should be relying on the widget's `data`.
    // This is a workaround for Scalar.

    if (_WidgetUtils.default.isScalarUrl(this.props.url) && params && params.get('url')) {
      const unwrappedUrl = _url.default.parse(params.get('url'));

      return {
        widgetDomain: unwrappedUrl.host || unwrappedUrl.hostname,
        isWrapped: true
      };
    } else {
      return {
        widgetDomain: widgetUrl.host || widgetUrl.hostname,
        isWrapped: false
      };
    }
  }

  render() {
    const brand = _SdkConfig.default.get().brand;

    const displayName = this.state.roomMember ? this.state.roomMember.name : this.props.creatorUserId;
    const userId = displayName === this.props.creatorUserId ? null : this.props.creatorUserId;
    const avatar = this.state.roomMember ? /*#__PURE__*/_react.default.createElement(_MemberAvatar.default, {
      member: this.state.roomMember,
      width: 38,
      height: 38
    }) : /*#__PURE__*/_react.default.createElement(_BaseAvatar.default, {
      name: this.props.creatorUserId,
      width: 38,
      height: 38
    });

    const warningTooltipText = /*#__PURE__*/_react.default.createElement("div", null, (0, _languageHandler._t)("Any of the following data may be shared:"), /*#__PURE__*/_react.default.createElement("ul", null, /*#__PURE__*/_react.default.createElement("li", null, (0, _languageHandler._t)("Your display name")), /*#__PURE__*/_react.default.createElement("li", null, (0, _languageHandler._t)("Your avatar URL")), /*#__PURE__*/_react.default.createElement("li", null, (0, _languageHandler._t)("Your user ID")), /*#__PURE__*/_react.default.createElement("li", null, (0, _languageHandler._t)("Your theme")), /*#__PURE__*/_react.default.createElement("li", null, (0, _languageHandler._t)("%(brand)s URL", {
      brand
    })), /*#__PURE__*/_react.default.createElement("li", null, (0, _languageHandler._t)("Room ID")), /*#__PURE__*/_react.default.createElement("li", null, (0, _languageHandler._t)("Widget ID"))));

    const warningTooltip = /*#__PURE__*/_react.default.createElement(_TextWithTooltip.default, {
      tooltip: warningTooltipText,
      tooltipClass: "mx_AppPermissionWarning_tooltip mx_Tooltip_dark"
    }, /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_AppPermissionWarning_helpIcon"
    })); // Due to i18n limitations, we can't dedupe the code for variables in these two messages.


    const warning = this.state.isWrapped ? (0, _languageHandler._t)("Using this widget may share data <helpIcon /> with %(widgetDomain)s & your integration manager.", {
      widgetDomain: this.state.widgetDomain
    }, {
      helpIcon: () => warningTooltip
    }) : (0, _languageHandler._t)("Using this widget may share data <helpIcon /> with %(widgetDomain)s.", {
      widgetDomain: this.state.widgetDomain
    }, {
      helpIcon: () => warningTooltip
    });
    const encryptionWarning = this.props.isRoomEncrypted ? (0, _languageHandler._t)("Widgets do not use message encryption.") : null;
    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_AppPermissionWarning"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_AppPermissionWarning_row mx_AppPermissionWarning_bolder mx_AppPermissionWarning_smallText"
    }, (0, _languageHandler._t)("Widget added by")), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_AppPermissionWarning_row"
    }, avatar, /*#__PURE__*/_react.default.createElement("h4", {
      className: "mx_AppPermissionWarning_bolder"
    }, displayName), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_AppPermissionWarning_smallText"
    }, userId)), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_AppPermissionWarning_row mx_AppPermissionWarning_smallText"
    }, warning), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_AppPermissionWarning_row mx_AppPermissionWarning_smallText"
    }, (0, _languageHandler._t)("This widget may use cookies."), "\xA0", encryptionWarning), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_AppPermissionWarning_row"
    }, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      kind: "primary_sm",
      onClick: this.props.onPermissionGranted
    }, (0, _languageHandler._t)("Continue"))));
  }

}, (0, _defineProperty2.default)(_class2, "defaultProps", {
  onPermissionGranted: () => {}
}), _temp)) || _class);
exports.default = AppPermission;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2VsZW1lbnRzL0FwcFBlcm1pc3Npb24udHN4Il0sIm5hbWVzIjpbIkFwcFBlcm1pc3Npb24iLCJSZWFjdCIsIkNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJ1cmxJbmZvIiwicGFyc2VXaWRnZXRVcmwiLCJyb29tIiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0IiwiZ2V0Um9vbSIsInJvb21JZCIsInJvb21NZW1iZXIiLCJnZXRNZW1iZXIiLCJjcmVhdG9yVXNlcklkIiwic3RhdGUiLCJ3aWRnZXREb21haW4iLCJpc1dyYXBwZWQiLCJ3aWRnZXRVcmwiLCJ1cmwiLCJwYXJzZSIsInBhcmFtcyIsIlVSTFNlYXJjaFBhcmFtcyIsInNlYXJjaCIsIldpZGdldFV0aWxzIiwiaXNTY2FsYXJVcmwiLCJ1bndyYXBwZWRVcmwiLCJob3N0IiwiaG9zdG5hbWUiLCJyZW5kZXIiLCJicmFuZCIsIlNka0NvbmZpZyIsImRpc3BsYXlOYW1lIiwibmFtZSIsInVzZXJJZCIsImF2YXRhciIsIndhcm5pbmdUb29sdGlwVGV4dCIsIndhcm5pbmdUb29sdGlwIiwid2FybmluZyIsImhlbHBJY29uIiwiZW5jcnlwdGlvbldhcm5pbmciLCJpc1Jvb21FbmNyeXB0ZWQiLCJvblBlcm1pc3Npb25HcmFudGVkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWtCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7SUFpQnFCQSxhLFdBRHBCLGdEQUFxQiw4QkFBckIsQyxtQ0FBRCxNQUNxQkEsYUFEckIsU0FDMkNDLGVBQU1DLFNBRGpELENBQzJFO0FBS3ZFQyxFQUFBQSxXQUFXLENBQUNDLEtBQUQsRUFBZ0I7QUFDdkIsVUFBTUEsS0FBTixFQUR1QixDQUd2Qjs7QUFDQSxVQUFNQyxPQUFPLEdBQUcsS0FBS0MsY0FBTCxFQUFoQixDQUp1QixD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ZixvQkFDSSw2QkFBQyx5QkFBRDtBQUFrQixNQUFBLElBQUksRUFBQyxZQUF2QjtBQUFvQyxNQUFBLE9BQU8sRUFBRSxLQUFLcEMsS0FBTCxDQUFXc0M7QUFBeEQsT0FDTSx5QkFBRyxVQUFILENBRE4sQ0FESixDQWZKLENBREo7QUF1Qkg7O0FBM0dzRSxDLHlEQUNoQztBQUNuQ0EsRUFBQUEsbUJBQW1CLEVBQUUsTUFBTSxDQUFFO0FBRE0sQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNyBWZWN0b3IgQ3JlYXRpb25zIEx0ZFxuQ29weXJpZ2h0IDIwMTgsIDIwMTkgTmV3IFZlY3RvciBMdGRcbkNvcHlyaWdodCAyMDE5LCAyMDIwIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB1cmwgZnJvbSAndXJsJztcbmltcG9ydCB7IF90IH0gZnJvbSAnLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyJztcbmltcG9ydCBTZGtDb25maWcgZnJvbSAnLi4vLi4vLi4vU2RrQ29uZmlnJztcbmltcG9ydCBXaWRnZXRVdGlscyBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvV2lkZ2V0VXRpbHNcIjtcbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gXCIuLi8uLi8uLi9NYXRyaXhDbGllbnRQZWdcIjtcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5pbXBvcnQgeyBSb29tTWVtYmVyIH0gZnJvbSAnbWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3Jvb20tbWVtYmVyJztcbmltcG9ydCBNZW1iZXJBdmF0YXIgZnJvbSAnLi4vYXZhdGFycy9NZW1iZXJBdmF0YXInO1xuaW1wb3J0IEJhc2VBdmF0YXIgZnJvbSAnLi4vYXZhdGFycy9CYXNlQXZhdGFyJztcbmltcG9ydCBBY2Nlc3NpYmxlQnV0dG9uIGZyb20gJy4vQWNjZXNzaWJsZUJ1dHRvbic7XG5pbXBvcnQgVGV4dFdpdGhUb29sdGlwIGZyb20gXCIuL1RleHRXaXRoVG9vbHRpcFwiO1xuXG5pbnRlcmZhY2UgSVByb3BzIHtcbiAgICB1cmw6IHN0cmluZztcbiAgICBjcmVhdG9yVXNlcklkOiBzdHJpbmc7XG4gICAgcm9vbUlkOiBzdHJpbmc7XG4gICAgb25QZXJtaXNzaW9uR3JhbnRlZDogKCkgPT4gdm9pZDtcbiAgICBpc1Jvb21FbmNyeXB0ZWQ/OiBib29sZWFuO1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICByb29tTWVtYmVyOiBSb29tTWVtYmVyO1xuICAgIGlzV3JhcHBlZDogYm9vbGVhbjtcbiAgICB3aWRnZXREb21haW46IHN0cmluZztcbn1cblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3MuZWxlbWVudHMuQXBwUGVybWlzc2lvblwiKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQXBwUGVybWlzc2lvbiBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxJUHJvcHMsIElTdGF0ZT4ge1xuICAgIHN0YXRpYyBkZWZhdWx0UHJvcHM6IFBhcnRpYWw8SVByb3BzPiA9IHtcbiAgICAgICAgb25QZXJtaXNzaW9uR3JhbnRlZDogKCkgPT4ge30sXG4gICAgfTtcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBJUHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuXG4gICAgICAgIC8vIFRoZSBmaXJzdCBzdGVwIGlzIHRvIHBpY2sgYXBhcnQgdGhlIHdpZGdldCBzbyB3ZSBjYW4gcmVuZGVyIGluZm9ybWF0aW9uIGFib3V0IGl0XG4gICAgICAgIGNvbnN0IHVybEluZm8gPSB0aGlzLnBhcnNlV2lkZ2V0VXJsKCk7XG5cbiAgICAgICAgLy8gVGhlIHNlY29uZCBzdGVwIGlzIHRvIGZpbmQgdGhlIHVzZXIncyBwcm9maWxlIHNvIHdlIGNhbiBzaG93IGl0IG9uIHRoZSBwcm9tcHRcbiAgICAgICAgY29uc3Qgcm9vbSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRSb29tKHRoaXMucHJvcHMucm9vbUlkKTtcbiAgICAgICAgbGV0IHJvb21NZW1iZXI7XG4gICAgICAgIGlmIChyb29tKSByb29tTWVtYmVyID0gcm9vbS5nZXRNZW1iZXIodGhpcy5wcm9wcy5jcmVhdG9yVXNlcklkKTtcblxuICAgICAgICAvLyBTZXQgYWxsIHRoaXMgaW50byB0aGUgaW5pdGlhbCBzdGF0ZVxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgd2lkZ2V0RG9tYWluOiBudWxsLFxuICAgICAgICAgICAgaXNXcmFwcGVkOiBudWxsLFxuICAgICAgICAgICAgcm9vbU1lbWJlcixcbiAgICAgICAgICAgIC4uLnVybEluZm8sXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwYXJzZVdpZGdldFVybCgpOiB7IGlzV3JhcHBlZDogYm9vbGVhbiwgd2lkZ2V0RG9tYWluOiBzdHJpbmcgfSB7XG4gICAgICAgIGNvbnN0IHdpZGdldFVybCA9IHVybC5wYXJzZSh0aGlzLnByb3BzLnVybCk7XG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IG5ldyBVUkxTZWFyY2hQYXJhbXMod2lkZ2V0VXJsLnNlYXJjaCk7XG5cbiAgICAgICAgLy8gSEFDSzogV2UncmUgcmVseWluZyBvbiB0aGUgcXVlcnkgcGFyYW1zIHdoZW4gd2Ugc2hvdWxkIGJlIHJlbHlpbmcgb24gdGhlIHdpZGdldCdzIGBkYXRhYC5cbiAgICAgICAgLy8gVGhpcyBpcyBhIHdvcmthcm91bmQgZm9yIFNjYWxhci5cbiAgICAgICAgaWYgKFdpZGdldFV0aWxzLmlzU2NhbGFyVXJsKHRoaXMucHJvcHMudXJsKSAmJiBwYXJhbXMgJiYgcGFyYW1zLmdldCgndXJsJykpIHtcbiAgICAgICAgICAgIGNvbnN0IHVud3JhcHBlZFVybCA9IHVybC5wYXJzZShwYXJhbXMuZ2V0KCd1cmwnKSk7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHdpZGdldERvbWFpbjogdW53cmFwcGVkVXJsLmhvc3QgfHwgdW53cmFwcGVkVXJsLmhvc3RuYW1lLFxuICAgICAgICAgICAgICAgIGlzV3JhcHBlZDogdHJ1ZSxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHdpZGdldERvbWFpbjogd2lkZ2V0VXJsLmhvc3QgfHwgd2lkZ2V0VXJsLmhvc3RuYW1lLFxuICAgICAgICAgICAgICAgIGlzV3JhcHBlZDogZmFsc2UsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCBicmFuZCA9IFNka0NvbmZpZy5nZXQoKS5icmFuZDtcblxuICAgICAgICBjb25zdCBkaXNwbGF5TmFtZSA9IHRoaXMuc3RhdGUucm9vbU1lbWJlciA/IHRoaXMuc3RhdGUucm9vbU1lbWJlci5uYW1lIDogdGhpcy5wcm9wcy5jcmVhdG9yVXNlcklkO1xuICAgICAgICBjb25zdCB1c2VySWQgPSBkaXNwbGF5TmFtZSA9PT0gdGhpcy5wcm9wcy5jcmVhdG9yVXNlcklkID8gbnVsbCA6IHRoaXMucHJvcHMuY3JlYXRvclVzZXJJZDtcblxuICAgICAgICBjb25zdCBhdmF0YXIgPSB0aGlzLnN0YXRlLnJvb21NZW1iZXJcbiAgICAgICAgICAgID8gPE1lbWJlckF2YXRhciBtZW1iZXI9e3RoaXMuc3RhdGUucm9vbU1lbWJlcn0gd2lkdGg9ezM4fSBoZWlnaHQ9ezM4fSAvPlxuICAgICAgICAgICAgOiA8QmFzZUF2YXRhciBuYW1lPXt0aGlzLnByb3BzLmNyZWF0b3JVc2VySWR9IHdpZHRoPXszOH0gaGVpZ2h0PXszOH0gLz47XG5cbiAgICAgICAgY29uc3Qgd2FybmluZ1Rvb2x0aXBUZXh0ID0gKFxuICAgICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgICAgICB7IF90KFwiQW55IG9mIHRoZSBmb2xsb3dpbmcgZGF0YSBtYXkgYmUgc2hhcmVkOlwiKSB9XG4gICAgICAgICAgICAgICAgPHVsPlxuICAgICAgICAgICAgICAgICAgICA8bGk+eyBfdChcIllvdXIgZGlzcGxheSBuYW1lXCIpIH08L2xpPlxuICAgICAgICAgICAgICAgICAgICA8bGk+eyBfdChcIllvdXIgYXZhdGFyIFVSTFwiKSB9PC9saT5cbiAgICAgICAgICAgICAgICAgICAgPGxpPnsgX3QoXCJZb3VyIHVzZXIgSURcIikgfTwvbGk+XG4gICAgICAgICAgICAgICAgICAgIDxsaT57IF90KFwiWW91ciB0aGVtZVwiKSB9PC9saT5cbiAgICAgICAgICAgICAgICAgICAgPGxpPnsgX3QoXCIlKGJyYW5kKXMgVVJMXCIsIHsgYnJhbmQgfSkgfTwvbGk+XG4gICAgICAgICAgICAgICAgICAgIDxsaT57IF90KFwiUm9vbSBJRFwiKSB9PC9saT5cbiAgICAgICAgICAgICAgICAgICAgPGxpPnsgX3QoXCJXaWRnZXQgSURcIikgfTwvbGk+XG4gICAgICAgICAgICAgICAgPC91bD5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICApO1xuICAgICAgICBjb25zdCB3YXJuaW5nVG9vbHRpcCA9IChcbiAgICAgICAgICAgIDxUZXh0V2l0aFRvb2x0aXAgdG9vbHRpcD17d2FybmluZ1Rvb2x0aXBUZXh0fSB0b29sdGlwQ2xhc3M9J214X0FwcFBlcm1pc3Npb25XYXJuaW5nX3Rvb2x0aXAgbXhfVG9vbHRpcF9kYXJrJz5cbiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9J214X0FwcFBlcm1pc3Npb25XYXJuaW5nX2hlbHBJY29uJyAvPlxuICAgICAgICAgICAgPC9UZXh0V2l0aFRvb2x0aXA+XG4gICAgICAgICk7XG5cbiAgICAgICAgLy8gRHVlIHRvIGkxOG4gbGltaXRhdGlvbnMsIHdlIGNhbid0IGRlZHVwZSB0aGUgY29kZSBmb3IgdmFyaWFibGVzIGluIHRoZXNlIHR3byBtZXNzYWdlcy5cbiAgICAgICAgY29uc3Qgd2FybmluZyA9IHRoaXMuc3RhdGUuaXNXcmFwcGVkXG4gICAgICAgICAgICA/IF90KFwiVXNpbmcgdGhpcyB3aWRnZXQgbWF5IHNoYXJlIGRhdGEgPGhlbHBJY29uIC8+IHdpdGggJSh3aWRnZXREb21haW4pcyAmIHlvdXIgaW50ZWdyYXRpb24gbWFuYWdlci5cIixcbiAgICAgICAgICAgICAgICB7IHdpZGdldERvbWFpbjogdGhpcy5zdGF0ZS53aWRnZXREb21haW4gfSwgeyBoZWxwSWNvbjogKCkgPT4gd2FybmluZ1Rvb2x0aXAgfSlcbiAgICAgICAgICAgIDogX3QoXCJVc2luZyB0aGlzIHdpZGdldCBtYXkgc2hhcmUgZGF0YSA8aGVscEljb24gLz4gd2l0aCAlKHdpZGdldERvbWFpbilzLlwiLFxuICAgICAgICAgICAgICAgIHsgd2lkZ2V0RG9tYWluOiB0aGlzLnN0YXRlLndpZGdldERvbWFpbiB9LCB7IGhlbHBJY29uOiAoKSA9PiB3YXJuaW5nVG9vbHRpcCB9KTtcblxuICAgICAgICBjb25zdCBlbmNyeXB0aW9uV2FybmluZyA9IHRoaXMucHJvcHMuaXNSb29tRW5jcnlwdGVkID8gX3QoXCJXaWRnZXRzIGRvIG5vdCB1c2UgbWVzc2FnZSBlbmNyeXB0aW9uLlwiKSA6IG51bGw7XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdteF9BcHBQZXJtaXNzaW9uV2FybmluZyc+XG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J214X0FwcFBlcm1pc3Npb25XYXJuaW5nX3JvdyBteF9BcHBQZXJtaXNzaW9uV2FybmluZ19ib2xkZXIgbXhfQXBwUGVybWlzc2lvbldhcm5pbmdfc21hbGxUZXh0Jz5cbiAgICAgICAgICAgICAgICAgICAgeyBfdChcIldpZGdldCBhZGRlZCBieVwiKSB9XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J214X0FwcFBlcm1pc3Npb25XYXJuaW5nX3Jvdyc+XG4gICAgICAgICAgICAgICAgICAgIHsgYXZhdGFyIH1cbiAgICAgICAgICAgICAgICAgICAgPGg0IGNsYXNzTmFtZT0nbXhfQXBwUGVybWlzc2lvbldhcm5pbmdfYm9sZGVyJz57IGRpc3BsYXlOYW1lIH08L2g0PlxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nbXhfQXBwUGVybWlzc2lvbldhcm5pbmdfc21hbGxUZXh0Jz57IHVzZXJJZCB9PC9kaXY+XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J214X0FwcFBlcm1pc3Npb25XYXJuaW5nX3JvdyBteF9BcHBQZXJtaXNzaW9uV2FybmluZ19zbWFsbFRleHQnPlxuICAgICAgICAgICAgICAgICAgICB7IHdhcm5pbmcgfVxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdteF9BcHBQZXJtaXNzaW9uV2FybmluZ19yb3cgbXhfQXBwUGVybWlzc2lvbldhcm5pbmdfc21hbGxUZXh0Jz5cbiAgICAgICAgICAgICAgICAgICAgeyBfdChcIlRoaXMgd2lkZ2V0IG1heSB1c2UgY29va2llcy5cIikgfSZuYnNwO3sgZW5jcnlwdGlvbldhcm5pbmcgfVxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdteF9BcHBQZXJtaXNzaW9uV2FybmluZ19yb3cnPlxuICAgICAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvbiBraW5kPSdwcmltYXJ5X3NtJyBvbkNsaWNrPXt0aGlzLnByb3BzLm9uUGVybWlzc2lvbkdyYW50ZWR9PlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIkNvbnRpbnVlXCIpIH1cbiAgICAgICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICk7XG4gICAgfVxufVxuIl19