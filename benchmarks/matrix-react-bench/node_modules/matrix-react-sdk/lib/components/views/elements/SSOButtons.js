"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _react = _interopRequireDefault(require("react"));

var _lodash = require("lodash");

var _classnames = _interopRequireDefault(require("classnames"));

var _PlatformPeg = _interopRequireDefault(require("../../../PlatformPeg"));

var _AccessibleButton = _interopRequireDefault(require("./AccessibleButton"));

var _languageHandler = require("../../../languageHandler");

var _Login = require("../../../Login");

var _AccessibleTooltipButton = _interopRequireDefault(require("./AccessibleTooltipButton"));

var _Media = require("../../../customisations/Media");

const _excluded = ["matrixClient", "loginType", "fragmentAfterLogin", "idp", "primary", "mini"];

const getIcon = brand => {
  switch (brand) {
    case _Login.IdentityProviderBrand.Apple:
      return require(`../../../../res/img/element-icons/brands/apple.svg`);

    case _Login.IdentityProviderBrand.Facebook:
      return require(`../../../../res/img/element-icons/brands/facebook.svg`);

    case _Login.IdentityProviderBrand.Github:
      return require(`../../../../res/img/element-icons/brands/github.svg`);

    case _Login.IdentityProviderBrand.Gitlab:
      return require(`../../../../res/img/element-icons/brands/gitlab.svg`);

    case _Login.IdentityProviderBrand.Google:
      return require(`../../../../res/img/element-icons/brands/google.svg`);

    case _Login.IdentityProviderBrand.Twitter:
      return require(`../../../../res/img/element-icons/brands/twitter.svg`);

    default:
      return null;
  }
};

const SSOButton = _ref => {
  let {
    matrixClient,
    loginType,
    fragmentAfterLogin,
    idp,
    primary,
    mini
  } = _ref,
      props = (0, _objectWithoutProperties2.default)(_ref, _excluded);
  const label = idp ? (0, _languageHandler._t)("Continue with %(provider)s", {
    provider: idp.name
  }) : (0, _languageHandler._t)("Sign in with single sign-on");

  const onClick = () => {
    _PlatformPeg.default.get().startSingleSignOn(matrixClient, loginType, fragmentAfterLogin, idp === null || idp === void 0 ? void 0 : idp.id);
  };

  let icon;
  let brandClass;
  const brandIcon = idp ? getIcon(idp.brand) : null;

  if (brandIcon) {
    const brandName = idp.brand.split(".").pop();
    brandClass = `mx_SSOButton_brand_${brandName}`;
    icon = /*#__PURE__*/_react.default.createElement("img", {
      src: brandIcon,
      height: "24",
      width: "24",
      alt: brandName
    });
  } else if (typeof (idp === null || idp === void 0 ? void 0 : idp.icon) === "string" && idp.icon.startsWith("mxc://")) {
    const src = (0, _Media.mediaFromMxc)(idp.icon, matrixClient).getSquareThumbnailHttp(24);
    icon = /*#__PURE__*/_react.default.createElement("img", {
      src: src,
      height: "24",
      width: "24",
      alt: idp.name
    });
  }

  const classes = (0, _classnames.default)("mx_SSOButton", {
    [brandClass]: brandClass,
    mx_SSOButton_mini: mini,
    mx_SSOButton_default: !idp,
    mx_SSOButton_primary: primary
  });

  if (mini) {
    // TODO fallback icon
    return /*#__PURE__*/_react.default.createElement(_AccessibleTooltipButton.default, (0, _extends2.default)({}, props, {
      title: label,
      className: classes,
      onClick: onClick
    }), icon);
  }

  return /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, (0, _extends2.default)({}, props, {
    className: classes,
    onClick: onClick
  }), icon, label);
};

const MAX_PER_ROW = 6;

const SSOButtons = ({
  matrixClient,
  flow,
  loginType,
  fragmentAfterLogin,
  primary
}) => {
  const providers = flow.identity_providers || [];

  if (providers.length < 2) {
    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_SSOButtons"
    }, /*#__PURE__*/_react.default.createElement(SSOButton, {
      matrixClient: matrixClient,
      loginType: loginType,
      fragmentAfterLogin: fragmentAfterLogin,
      idp: providers[0],
      primary: primary
    }));
  }

  const rows = Math.ceil(providers.length / MAX_PER_ROW);
  const size = Math.ceil(providers.length / rows);
  return /*#__PURE__*/_react.default.createElement("div", {
    className: "mx_SSOButtons"
  }, (0, _lodash.chunk)(providers, size).map(chunk => /*#__PURE__*/_react.default.createElement("div", {
    key: chunk[0].id,
    className: "mx_SSOButtons_row"
  }, chunk.map(idp => /*#__PURE__*/_react.default.createElement(SSOButton, {
    key: idp.id,
    matrixClient: matrixClient,
    loginType: loginType,
    fragmentAfterLogin: fragmentAfterLogin,
    idp: idp,
    mini: true,
    primary: primary
  })))));
};

var _default = SSOButtons;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2VsZW1lbnRzL1NTT0J1dHRvbnMudHN4Il0sIm5hbWVzIjpbImdldEljb24iLCJicmFuZCIsIklkZW50aXR5UHJvdmlkZXJCcmFuZCIsIkFwcGxlIiwicmVxdWlyZSIsIkZhY2Vib29rIiwiR2l0aHViIiwiR2l0bGFiIiwiR29vZ2xlIiwiVHdpdHRlciIsIlNTT0J1dHRvbiIsIm1hdHJpeENsaWVudCIsImxvZ2luVHlwZSIsImZyYWdtZW50QWZ0ZXJMb2dpbiIsImlkcCIsInByaW1hcnkiLCJtaW5pIiwicHJvcHMiLCJsYWJlbCIsInByb3ZpZGVyIiwibmFtZSIsIm9uQ2xpY2siLCJQbGF0Zm9ybVBlZyIsImdldCIsInN0YXJ0U2luZ2xlU2lnbk9uIiwiaWQiLCJpY29uIiwiYnJhbmRDbGFzcyIsImJyYW5kSWNvbiIsImJyYW5kTmFtZSIsInNwbGl0IiwicG9wIiwic3RhcnRzV2l0aCIsInNyYyIsImdldFNxdWFyZVRodW1ibmFpbEh0dHAiLCJjbGFzc2VzIiwibXhfU1NPQnV0dG9uX21pbmkiLCJteF9TU09CdXR0b25fZGVmYXVsdCIsIm14X1NTT0J1dHRvbl9wcmltYXJ5IiwiTUFYX1BFUl9ST1ciLCJTU09CdXR0b25zIiwiZmxvdyIsInByb3ZpZGVycyIsImlkZW50aXR5X3Byb3ZpZGVycyIsImxlbmd0aCIsInJvd3MiLCJNYXRoIiwiY2VpbCIsInNpemUiLCJtYXAiLCJjaHVuayJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQWdCQTs7QUFDQTs7QUFDQTs7QUFHQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQU9BLE1BQU1BLE9BQU8sR0FBSUMsS0FBRCxJQUEyQztBQUN2RCxVQUFRQSxLQUFSO0FBQ0ksU0FBS0MsNkJBQXNCQyxLQUEzQjtBQUNJLGFBQU9DLE9BQU8sQ0FBRSxvREFBRixDQUFkOztBQUNKLFNBQUtGLDZCQUFzQkcsUUFBM0I7QUFDSSxhQUFPRCxPQUFP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QU1ILFNBQU4sRUFBaUJNLElBQWpCLEVBQXVCQyxHQUF2QixDQUEyQkMsS0FBSyxpQkFDOUI7QUFBSyxJQUFBLEdBQUcsRUFBRUEsS0FBSyxDQUFDLENBQUQsQ0FBTCxDQUFTekIsRUFBbkI7QUFBdUIsSUFBQSxTQUFTLEVBQUM7QUFBakMsS0FDTXlCLEtBQUssQ0FBQ0QsR0FBTixDQUFVbkMsR0FBRyxpQkFDWCw2QkFBQyxTQUFEO0FBQ0ksSUFBQSxHQUFHLEVBQUVBLEdBQUcsQ0FBQ1csRUFEYjtBQUVJLElBQUEsWUFBWSxFQUFFZCxZQUZsQjtBQUdJLElBQUEsU0FBUyxFQUFFQyxTQUhmO0FBSUksSUFBQSxrQkFBa0IsRUFBRUMsa0JBSnhCO0FBS0ksSUFBQSxHQUFHLEVBQUVDLEdBTFQ7QUFNSSxJQUFBLElBQUksRUFBRSxJQU5WO0FBT0ksSUFBQSxPQUFPLEVBQUVDO0FBUGIsSUFERixDQUROLENBREYsQ0FEQyxDQUFQO0FBaUJILENBbENEOztlQW9DZXlCLFUiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMjAgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSBcInJlYWN0XCI7XG5pbXBvcnQgeyBjaHVuayB9IGZyb20gXCJsb2Rhc2hcIjtcbmltcG9ydCBjbGFzc05hbWVzIGZyb20gXCJjbGFzc25hbWVzXCI7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnQgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvY2xpZW50XCI7XG5cbmltcG9ydCBQbGF0Zm9ybVBlZyBmcm9tIFwiLi4vLi4vLi4vUGxhdGZvcm1QZWdcIjtcbmltcG9ydCBBY2Nlc3NpYmxlQnV0dG9uIGZyb20gXCIuL0FjY2Vzc2libGVCdXR0b25cIjtcbmltcG9ydCB7IF90IH0gZnJvbSBcIi4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlclwiO1xuaW1wb3J0IHsgSWRlbnRpdHlQcm92aWRlckJyYW5kLCBJSWRlbnRpdHlQcm92aWRlciwgSVNTT0Zsb3cgfSBmcm9tIFwiLi4vLi4vLi4vTG9naW5cIjtcbmltcG9ydCBBY2Nlc3NpYmxlVG9vbHRpcEJ1dHRvbiBmcm9tIFwiLi9BY2Nlc3NpYmxlVG9vbHRpcEJ1dHRvblwiO1xuaW1wb3J0IHsgbWVkaWFGcm9tTXhjIH0gZnJvbSBcIi4uLy4uLy4uL2N1c3RvbWlzYXRpb25zL01lZGlhXCI7XG5cbmludGVyZmFjZSBJU1NPQnV0dG9uUHJvcHMgZXh0ZW5kcyBPbWl0PElQcm9wcywgXCJmbG93XCI+IHtcbiAgICBpZHA6IElJZGVudGl0eVByb3ZpZGVyO1xuICAgIG1pbmk/OiBib29sZWFuO1xufVxuXG5jb25zdCBnZXRJY29uID0gKGJyYW5kOiBJZGVudGl0eVByb3ZpZGVyQnJhbmQgfCBzdHJpbmcpID0+IHtcbiAgICBzd2l0Y2ggKGJyYW5kKSB7XG4gICAgICAgIGNhc2UgSWRlbnRpdHlQcm92aWRlckJyYW5kLkFwcGxlOlxuICAgICAgICAgICAgcmV0dXJuIHJlcXVpcmUoYC4uLy4uLy4uLy4uL3Jlcy9pbWcvZWxlbWVudC1pY29ucy9icmFuZHMvYXBwbGUuc3ZnYCk7XG4gICAgICAgIGNhc2UgSWRlbnRpdHlQcm92aWRlckJyYW5kLkZhY2Vib29rOlxuICAgICAgICAgICAgcmV0dXJuIHJlcXVpcmUoYC4uLy4uLy4uLy4uL3Jlcy9pbWcvZWxlbWVudC1pY29ucy9icmFuZHMvZmFjZWJvb2suc3ZnYCk7XG4gICAgICAgIGNhc2UgSWRlbnRpdHlQcm92aWRlckJyYW5kLkdpdGh1YjpcbiAgICAgICAgICAgIHJldHVybiByZXF1aXJlKGAuLi8uLi8uLi8uLi9yZXMvaW1nL2VsZW1lbnQtaWNvbnMvYnJhbmRzL2dpdGh1Yi5zdmdgKTtcbiAgICAgICAgY2FzZSBJZGVudGl0eVByb3ZpZGVyQnJhbmQuR2l0bGFiOlxuICAgICAgICAgICAgcmV0dXJuIHJlcXVpcmUoYC4uLy4uLy4uLy4uL3Jlcy9pbWcvZWxlbWVudC1pY29ucy9icmFuZHMvZ2l0bGFiLnN2Z2ApO1xuICAgICAgICBjYXNlIElkZW50aXR5UHJvdmlkZXJCcmFuZC5Hb29nbGU6XG4gICAgICAgICAgICByZXR1cm4gcmVxdWlyZShgLi4vLi4vLi4vLi4vcmVzL2ltZy9lbGVtZW50LWljb25zL2JyYW5kcy9nb29nbGUuc3ZnYCk7XG4gICAgICAgIGNhc2UgSWRlbnRpdHlQcm92aWRlckJyYW5kLlR3aXR0ZXI6XG4gICAgICAgICAgICByZXR1cm4gcmVxdWlyZShgLi4vLi4vLi4vLi4vcmVzL2ltZy9lbGVtZW50LWljb25zL2JyYW5kcy90d2l0dGVyLnN2Z2ApO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxufTtcblxuY29uc3QgU1NPQnV0dG9uOiBSZWFjdC5GQzxJU1NPQnV0dG9uUHJvcHM+ID0gKHtcbiAgICBtYXRyaXhDbGllbnQsXG4gICAgbG9naW5UeXBlLFxuICAgIGZyYWdtZW50QWZ0ZXJMb2dpbixcbiAgICBpZHAsXG4gICAgcHJpbWFyeSxcbiAgICBtaW5pLFxuICAgIC4uLnByb3BzXG59KSA9PiB7XG4gICAgY29uc3QgbGFiZWwgPSBpZHAgPyBfdChcIkNvbnRpbnVlIHdpdGggJShwcm92aWRlcilzXCIsIHsgcHJvdmlkZXI6IGlkcC5uYW1lIH0pIDogX3QoXCJTaWduIGluIHdpdGggc2luZ2xlIHNpZ24tb25cIik7XG5cbiAgICBjb25zdCBvbkNsaWNrID0gKCkgPT4ge1xuICAgICAgICBQbGF0Zm9ybVBlZy5nZXQoKS5zdGFydFNpbmdsZVNpZ25PbihtYXRyaXhDbGllbnQsIGxvZ2luVHlwZSwgZnJhZ21lbnRBZnRlckxvZ2luLCBpZHA/LmlkKTtcbiAgICB9O1xuXG4gICAgbGV0IGljb247XG4gICAgbGV0IGJyYW5kQ2xhc3M7XG4gICAgY29uc3QgYnJhbmRJY29uID0gaWRwID8gZ2V0SWNvbihpZHAuYnJhbmQpIDogbnVsbDtcbiAgICBpZiAoYnJhbmRJY29uKSB7XG4gICAgICAgIGNvbnN0IGJyYW5kTmFtZSA9IGlkcC5icmFuZC5zcGxpdChcIi5cIikucG9wKCk7XG4gICAgICAgIGJyYW5kQ2xhc3MgPSBgbXhfU1NPQnV0dG9uX2JyYW5kXyR7YnJhbmROYW1lfWA7XG4gICAgICAgIGljb24gPSA8aW1nIHNyYz17YnJhbmRJY29ufSBoZWlnaHQ9XCIyNFwiIHdpZHRoPVwiMjRcIiBhbHQ9e2JyYW5kTmFtZX0gLz47XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgaWRwPy5pY29uID09PSBcInN0cmluZ1wiICYmIGlkcC5pY29uLnN0YXJ0c1dpdGgoXCJteGM6Ly9cIikpIHtcbiAgICAgICAgY29uc3Qgc3JjID0gbWVkaWFGcm9tTXhjKGlkcC5pY29uLCBtYXRyaXhDbGllbnQpLmdldFNxdWFyZVRodW1ibmFpbEh0dHAoMjQpO1xuICAgICAgICBpY29uID0gPGltZyBzcmM9e3NyY30gaGVpZ2h0PVwiMjRcIiB3aWR0aD1cIjI0XCIgYWx0PXtpZHAubmFtZX0gLz47XG4gICAgfVxuXG4gICAgY29uc3QgY2xhc3NlcyA9IGNsYXNzTmFtZXMoXCJteF9TU09CdXR0b25cIiwge1xuICAgICAgICBbYnJhbmRDbGFzc106IGJyYW5kQ2xhc3MsXG4gICAgICAgIG14X1NTT0J1dHRvbl9taW5pOiBtaW5pLFxuICAgICAgICBteF9TU09CdXR0b25fZGVmYXVsdDogIWlkcCxcbiAgICAgICAgbXhfU1NPQnV0dG9uX3ByaW1hcnk6IHByaW1hcnksXG4gICAgfSk7XG5cbiAgICBpZiAobWluaSkge1xuICAgICAgICAvLyBUT0RPIGZhbGxiYWNrIGljb25cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxBY2Nlc3NpYmxlVG9vbHRpcEJ1dHRvbiB7Li4ucHJvcHN9IHRpdGxlPXtsYWJlbH0gY2xhc3NOYW1lPXtjbGFzc2VzfSBvbkNsaWNrPXtvbkNsaWNrfT5cbiAgICAgICAgICAgICAgICB7IGljb24gfVxuICAgICAgICAgICAgPC9BY2Nlc3NpYmxlVG9vbHRpcEJ1dHRvbj5cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gKFxuICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvbiB7Li4ucHJvcHN9IGNsYXNzTmFtZT17Y2xhc3Nlc30gb25DbGljaz17b25DbGlja30+XG4gICAgICAgICAgICB7IGljb24gfVxuICAgICAgICAgICAgeyBsYWJlbCB9XG4gICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj5cbiAgICApO1xufTtcblxuaW50ZXJmYWNlIElQcm9wcyB7XG4gICAgbWF0cml4Q2xpZW50OiBNYXRyaXhDbGllbnQ7XG4gICAgZmxvdzogSVNTT0Zsb3c7XG4gICAgbG9naW5UeXBlPzogXCJzc29cIiB8IFwiY2FzXCI7XG4gICAgZnJhZ21lbnRBZnRlckxvZ2luPzogc3RyaW5nO1xuICAgIHByaW1hcnk/OiBib29sZWFuO1xufVxuXG5jb25zdCBNQVhfUEVSX1JPVyA9IDY7XG5cbmNvbnN0IFNTT0J1dHRvbnM6IFJlYWN0LkZDPElQcm9wcz4gPSAoeyBtYXRyaXhDbGllbnQsIGZsb3csIGxvZ2luVHlwZSwgZnJhZ21lbnRBZnRlckxvZ2luLCBwcmltYXJ5IH0pID0+IHtcbiAgICBjb25zdCBwcm92aWRlcnMgPSBmbG93LmlkZW50aXR5X3Byb3ZpZGVycyB8fCBbXTtcbiAgICBpZiAocHJvdmlkZXJzLmxlbmd0aCA8IDIpIHtcbiAgICAgICAgcmV0dXJuIDxkaXYgY2xhc3NOYW1lPVwibXhfU1NPQnV0dG9uc1wiPlxuICAgICAgICAgICAgPFNTT0J1dHRvblxuICAgICAgICAgICAgICAgIG1hdHJpeENsaWVudD17bWF0cml4Q2xpZW50fVxuICAgICAgICAgICAgICAgIGxvZ2luVHlwZT17bG9naW5UeXBlfVxuICAgICAgICAgICAgICAgIGZyYWdtZW50QWZ0ZXJMb2dpbj17ZnJhZ21lbnRBZnRlckxvZ2lufVxuICAgICAgICAgICAgICAgIGlkcD17cHJvdmlkZXJzWzBdfVxuICAgICAgICAgICAgICAgIHByaW1hcnk9e3ByaW1hcnl9XG4gICAgICAgICAgICAvPlxuICAgICAgICA8L2Rpdj47XG4gICAgfVxuXG4gICAgY29uc3Qgcm93cyA9IE1hdGguY2VpbChwcm92aWRlcnMubGVuZ3RoIC8gTUFYX1BFUl9ST1cpO1xuICAgIGNvbnN0IHNpemUgPSBNYXRoLmNlaWwocHJvdmlkZXJzLmxlbmd0aCAvIHJvd3MpO1xuXG4gICAgcmV0dXJuIDxkaXYgY2xhc3NOYW1lPVwibXhfU1NPQnV0dG9uc1wiPlxuICAgICAgICB7IGNodW5rKHByb3ZpZGVycywgc2l6ZSkubWFwKGNodW5rID0+IChcbiAgICAgICAgICAgIDxkaXYga2V5PXtjaHVua1swXS5pZH0gY2xhc3NOYW1lPVwibXhfU1NPQnV0dG9uc19yb3dcIj5cbiAgICAgICAgICAgICAgICB7IGNodW5rLm1hcChpZHAgPT4gKFxuICAgICAgICAgICAgICAgICAgICA8U1NPQnV0dG9uXG4gICAgICAgICAgICAgICAgICAgICAgICBrZXk9e2lkcC5pZH1cbiAgICAgICAgICAgICAgICAgICAgICAgIG1hdHJpeENsaWVudD17bWF0cml4Q2xpZW50fVxuICAgICAgICAgICAgICAgICAgICAgICAgbG9naW5UeXBlPXtsb2dpblR5cGV9XG4gICAgICAgICAgICAgICAgICAgICAgICBmcmFnbWVudEFmdGVyTG9naW49e2ZyYWdtZW50QWZ0ZXJMb2dpbn1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlkcD17aWRwfVxuICAgICAgICAgICAgICAgICAgICAgICAgbWluaT17dHJ1ZX1cbiAgICAgICAgICAgICAgICAgICAgICAgIHByaW1hcnk9e3ByaW1hcnl9XG4gICAgICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgKSkgfVxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICkpIH1cbiAgICA8L2Rpdj47XG59O1xuXG5leHBvcnQgZGVmYXVsdCBTU09CdXR0b25zO1xuIl19