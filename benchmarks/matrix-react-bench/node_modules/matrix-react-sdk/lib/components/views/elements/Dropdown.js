"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var _classnames = _interopRequireDefault(require("classnames"));

var _AccessibleButton = _interopRequireDefault(require("./AccessibleButton"));

var _languageHandler = require("../../../languageHandler");

var _Keyboard = require("../../../Keyboard");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _dec, _class;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

class MenuOption extends _react.default.Component {
  constructor(...args) {
    super(...args);
    (0, _defineProperty2.default)(this, "onMouseEnter", () => {
      this.props.onMouseEnter(this.props.dropdownKey);
    });
    (0, _defineProperty2.default)(this, "onClick", e => {
      e.preventDefault();
      e.stopPropagation();
      this.props.onClick(this.props.dropdownKey);
    });
  }

  render() {
    const optClasses = (0, _classnames.default)({
      mx_Dropdown_option: true,
      mx_Dropdown_option_highlight: this.props.highlighted
    });
    return /*#__PURE__*/_react.default.createElement("div", {
      id: this.props.id,
      className: optClasses,
      onClick: this.onClick,
      onMouseEnter: this.onMouseEnter,
      role: "option",
      "aria-selected": this.props.highlighted,
      ref: this.props.inputRef
    }, this.props.children);
  }

}

(0, _defineProperty2.default)(MenuOption, "defaultProps", {
  disabled: false
});
let Dropdown = (
/*
 * Reusable dropdown select control, akin to react-select,
 * but somewhat simpler as react-select is 79KB of minified
 * javascript.
 */
_dec = (0, _replaceableComponent.replaceableComponent)("views.elements.Dropdown"), _dec(_class = class Dropdown extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "buttonRef", /*#__PURE__*/(0, _react.createRef)());
    (0, _defineProperty2.default)(this, "dropdownRootElement", null);
    (0, _defineProperty2.default)(this, "ignoreEvent", null);
    (0, _defineProperty2.default)(this, "childrenByKey", {});
    (0, _defineProperty2.default)(this, "onDocumentClick", ev => {
      // Close the dropdown if the user clicks anywhere that isn't
      // within our root element
      if (ev !== this.ignoreEvent) {
        this.setState({
          expanded: false
        });
      }
    });
    (0, _defineProperty2.default)(this, "onRootClick", ev => {
      // This captures any clicks that happen within our elements,
      // such that we can then ignore them when they're seen by the
      // click listener on the document handler, ie. not close the
      // dropdown immediately after opening it.
      // NB. We can't just stopPropagation() because then the event
      // doesn't reach the React onClick().
      this.ignoreEvent = ev;
    });
    (0, _defineProperty2.default)(this, "onAccessibleButtonClick", ev => {
      if (this.props.disabled) return;

      if (!this.state.expanded) {
        this.setState({
          expanded: true
        });
        ev.preventDefault();
      } else if (ev.key === _Keyboard.Key.ENTER) {
        // the accessible button consumes enter onKeyDown for firing onClick, so handle it here
        this.props.onOptionChange(this.state.highlightedOption);
        this.close();
      } else if (!ev.key) {
        // collapse on other non-keyboard event activations
        this.setState({
          expanded: false
        });
        ev.preventDefault();
      }
    });
    (0, _defineProperty2.default)(this, "onMenuOptionClick", dropdownKey => {
      this.close();
      this.props.onOptionChange(dropdownKey);
    });
    (0, _defineProperty2.default)(this, "onKeyDown", e => {
      let handled = true; // These keys don't generate keypress events and so needs to be on keyup

      switch (e.key) {
        case _Keyboard.Key.ENTER:
          this.props.onOptionChange(this.state.highlightedOption);
        // fallthrough

        case _Keyboard.Key.ESCAPE:
          this.close();
          break;

        case _Keyboard.Key.ARROW_DOWN:
          this.setState({
            highlightedOption: this.nextOption(this.state.highlightedOption)
          });
          break;

        case _Keyboard.Key.ARROW_UP:
          this.setState({
            highlightedOption: this.prevOption(this.state.highlightedOption)
          });
          break;

        default:
          handled = false;
      }

      if (handled) {
        e.preventDefault();
        e.stopPropagation();
      }
    });
    (0, _defineProperty2.default)(this, "onInputChange", e => {
      this.setState({
        searchQuery: e.currentTarget.value
      });

      if (this.props.onSearchChange) {
        this.props.onSearchChange(e.currentTarget.value);
      }
    });
    (0, _defineProperty2.default)(this, "collectRoot", e => {
      if (this.dropdownRootElement) {
        this.dropdownRootElement.removeEventListener('click', this.onRootClick, false);
      }

      if (e) {
        e.addEventListener('click', this.onRootClick, false);
      }

      this.dropdownRootElement = e;
    });
    (0, _defineProperty2.default)(this, "setHighlightedOption", optionKey => {
      this.setState({
        highlightedOption: optionKey
      });
    });
    this.reindexChildren(this.props.children);

    const firstChild = _react.default.Children.toArray(props.children)[0];

    this.state = {
      // True if the menu is dropped-down
      expanded: false,
      // The key of the highlighted option
      // (the option that would become selected if you pressed enter)
      highlightedOption: firstChild ? firstChild.key : null,
      // the current search query
      searchQuery: ''
    }; // Listen for all clicks on the document so we can close the
    // menu when the user clicks somewhere else

    document.addEventListener('click', this.onDocumentClick, false);
  }

  componentWillUnmount() {
    document.removeEventListener('click', this.onDocumentClick, false);
  } // TODO: [REACT-WARNING] Replace with appropriate lifecycle event


  UNSAFE_componentWillReceiveProps(nextProps) {
    // eslint-disable-line
    if (!nextProps.children || nextProps.children.length === 0) {
      return;
    }

    this.reindexChildren(nextProps.children);
    const firstChild = nextProps.children[0];
    this.setState({
      highlightedOption: firstChild ? firstChild.key : null
    });
  }

  reindexChildren(children) {
    this.childrenByKey = {};

    _react.default.Children.forEach(children, child => {
      this.childrenByKey[child.key] = child;
    });
  }

  close() {
    this.setState({
      expanded: false
    }); // their focus was on the input, its getting unmounted, move it to the button

    if (this.buttonRef.current) {
      this.buttonRef.current.focus();
    }
  }

  nextOption(optionKey) {
    const keys = Object.keys(this.childrenByKey);
    const index = keys.indexOf(optionKey);
    return keys[(index + 1) % keys.length];
  }

  prevOption(optionKey) {
    const keys = Object.keys(this.childrenByKey);
    const index = keys.indexOf(optionKey);
    return keys[index <= 0 ? keys.length - 1 : (index - 1) % keys.length];
  }

  scrollIntoView(node) {
    if (node) {
      node.scrollIntoView({
        block: "nearest",
        behavior: "auto"
      });
    }
  }

  getMenuOptions() {
    const options = _react.default.Children.map(this.props.children, child => {
      const highlighted = this.state.highlightedOption === child.key;
      return /*#__PURE__*/_react.default.createElement(MenuOption, {
        id: `${this.props.id}__${child.key}`,
        key: child.key,
        dropdownKey: child.key,
        highlighted: highlighted,
        onMouseEnter: this.setHighlightedOption,
        onClick: this.onMenuOptionClick,
        inputRef: highlighted ? this.scrollIntoView : undefined
      }, child);
    });

    if (options.length === 0) {
      return [/*#__PURE__*/_react.default.createElement("div", {
        key: "0",
        className: "mx_Dropdown_option",
        role: "option"
      }, (0, _languageHandler._t)("No results"))];
    }

    return options;
  }

  render() {
    let currentValue;
    const menuStyle = {};
    if (this.props.menuWidth) menuStyle.width = this.props.menuWidth;
    let menu;

    if (this.state.expanded) {
      if (this.props.searchEnabled) {
        currentValue = /*#__PURE__*/_react.default.createElement("input", {
          type: "text",
          autoFocus: true,
          className: "mx_Dropdown_option",
          onChange: this.onInputChange,
          value: this.state.searchQuery,
          role: "combobox",
          "aria-autocomplete": "list",
          "aria-activedescendant": `${this.props.id}__${this.state.highlightedOption}`,
          "aria-owns": `${this.props.id}_listbox`,
          "aria-disabled": this.props.disabled,
          "aria-label": this.props.label,
          onKeyDown: this.onKeyDown
        });
      }

      menu = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_Dropdown_menu",
        style: menuStyle,
        role: "listbox",
        id: `${this.props.id}_listbox`
      }, this.getMenuOptions());
    }

    if (!currentValue) {
      const selectedChild = this.props.getShortOption ? this.props.getShortOption(this.props.value) : this.childrenByKey[this.props.value];
      currentValue = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_Dropdown_option",
        id: `${this.props.id}_value`
      }, selectedChild);
    }

    const dropdownClasses = {
      mx_Dropdown: true,
      mx_Dropdown_disabled: this.props.disabled
    };

    if (this.props.className) {
      dropdownClasses[this.props.className] = true;
    } // Note the menu sits inside the AccessibleButton div so it's anchored
    // to the input, but overflows below it. The root contains both.


    return /*#__PURE__*/_react.default.createElement("div", {
      className: (0, _classnames.default)(dropdownClasses),
      ref: this.collectRoot
    }, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      className: "mx_Dropdown_input mx_no_textinput",
      onClick: this.onAccessibleButtonClick,
      "aria-haspopup": "listbox",
      "aria-expanded": this.state.expanded,
      disabled: this.props.disabled,
      inputRef: this.buttonRef,
      "aria-label": this.props.label,
      "aria-describedby": `${this.props.id}_value`,
      onKeyDown: this.onKeyDown
    }, currentValue, /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_Dropdown_arrow"
    }), menu));
  }

}) || _class);
exports.default = Dropdown;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2VsZW1lbnRzL0Ryb3Bkb3duLnRzeCJdLCJuYW1lcyI6WyJNZW51T3B0aW9uIiwiUmVhY3QiLCJDb21wb25lbnQiLCJwcm9wcyIsIm9uTW91c2VFbnRlciIsImRyb3Bkb3duS2V5IiwiZSIsInByZXZlbnREZWZhdWx0Iiwic3RvcFByb3BhZ2F0aW9uIiwib25DbGljayIsInJlbmRlciIsIm9wdENsYXNzZXMiLCJteF9Ecm9wZG93bl9vcHRpb24iLCJteF9Ecm9wZG93bl9vcHRpb25faGlnaGxpZ2h0IiwiaGlnaGxpZ2h0ZWQiLCJpZCIsImlucHV0UmVmIiwiY2hpbGRyZW4iLCJkaXNhYmxlZCIsIkRyb3Bkb3duIiwiY29uc3RydWN0b3IiLCJldiIsImlnbm9yZUV2ZW50Iiwic2V0U3RhdGUiLCJleHBhbmRlZCIsInN0YXRlIiwia2V5IiwiS2V5IiwiRU5URVIiLCJvbk9wdGlvbkNoYW5nZSIsImhpZ2hsaWdodGVkT3B0aW9uIiwiY2xvc2UiLCJoYW5kbGVkIiwiRVNDQVBFIiwiQVJST1dfRE9XTiIsIm5leHRPcHRpb24iLCJBUlJPV19VUCIsInByZXZPcHRpb24iLCJzZWFyY2hRdWVyeSIsImN1cnJlbnRUYXJnZXQiLCJ2YWx1ZSIsIm9uU2VhcmNoQ2hhbmdlIiwiZHJvcGRvd25Sb290RWxlbWVudCIsInJlbW92ZUV2ZW50TGlzdGVuZXIiLCJvblJvb3RDbGljayIsImFkZEV2ZW50TGlzdGVuZXIiLCJvcHRpb25LZXkiLCJyZWluZGV4Q2hpbGRyZW4iLCJmaXJzdENoaWxkIiwiQ2hpbGRyZW4iLCJ0b0FycmF5IiwiZG9jdW1lbnQiLCJvbkRvY3VtZW50Q2xpY2siLCJjb21wb25lbnRXaWxsVW5tb3VudCIsIlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIiwibmV4dFByb3BzIiwibGVuZ3RoIiwiY2hpbGRyZW5CeUtleSIsImZvckVhY2giLCJjaGlsZCIsImJ1dHRvblJlZiIsImN1cnJlbnQiLCJmb2N1cyIsImtleXMiLCJPYmplY3QiLCJpbmRleCIsImluZGV4T2YiLCJzY3JvbGxJbnRvVmlldyIsIm5vZGUiLCJibG9jayIsImJlaGF2aW9yIiwiZ2V0TWVudU9wdGlvbnMiLCJvcHRpb25zIiwibWFwIiwic2V0SGlnaGxpZ2h0ZWRPcHRpb24iLCJvbk1lbnVPcHRpb25DbGljayIsInVuZGVmaW5lZCIsImN1cnJlbnRWYWx1ZSIsIm1lbnVTdHlsZSIsIm1lbnVXaWR0aCIsIndpZHRoIiwibWVudSIsInNlYXJjaEVuYWJsZWQiLCJvbklucHV0Q2hhbmdlIiwibGFiZWwiLCJvbktleURvd24iLCJzZWxlY3RlZENoaWxkIiwiZ2V0U2hvcnRPcHRpb24iLCJkcm9wZG93bkNsYXNzZXMiLCJteF9Ecm9wZG93biIsIm14X0Ryb3Bkb3duX2Rpc2FibGVkIiwiY2xhc3NOYW1lIiwiY29sbGVjdFJvb3QiLCJvbkFjY2Vzc2libGVCdXR0b25DbGljayJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFpQkE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7O0FBWUEsTUFBTUEsVUFBTixTQUF5QkMsZUFBTUMsU0FBL0IsQ0FBMkQ7QUFBQTtBQUFBO0FBQUEsd0RBS2hDLE1BQU07QUFDekIsV0FBS0MsS0FBTCxDQUFXQyxZQUFYLENBQXdCLEtBQUtELEtBQUwsQ0FBV0UsV0FBbkM7QUFDSCxLQVBzRDtBQUFBLG1EQVNwQ0MsQ0FBRCxJQUF5QjtBQUN2Q0EsTUFBQUEsQ0FBQyxDQUFDQyxjQUFGO0FBQ0FELE1BQUFBLENBQUMsQ0FBQ0UsZUFBRjtBQUNBLFdBQUtMLEtBQUwsQ0FBV00sT0FBWCxDQUFtQixLQUFLTixLQUFMLENBQVdFLFdBQTlCO0FBQ0gsS0Fic0Q7QUFBQTs7QUFldkRLLEVBQUFBLE1BQU0sR0FBRztBQUNMLFVBQU1DLFVBQVUsR0FBRyx5QkFBVztBQUMxQkMsTUFBQUEsa0JBQWtCLEVBQUUsSUFETTtBQUUxQkMsTUFBQUEsNEJBQTRCLEVBQUUsS0FBS1YsS0FBTCxDQUFX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YU1JLElBYk4sQ0FERyxDQUFQO0FBaUJIOztBQWxSaUUsQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxOSBNaWNoYWVsIFRlbGF0eW5za2kgPDd0M2NoZ3V5QGdtYWlsLmNvbT5cbkNvcHlyaWdodCAyMDE3IC0gMjAyMSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCwgeyBDaGFuZ2VFdmVudCwgY3JlYXRlUmVmLCBDU1NQcm9wZXJ0aWVzLCBSZWFjdEVsZW1lbnQsIFJlYWN0Tm9kZSwgUmVmIH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IGNsYXNzbmFtZXMgZnJvbSAnY2xhc3NuYW1lcyc7XG5cbmltcG9ydCBBY2Nlc3NpYmxlQnV0dG9uLCB7IEJ1dHRvbkV2ZW50IH0gZnJvbSAnLi9BY2Nlc3NpYmxlQnV0dG9uJztcbmltcG9ydCB7IF90IH0gZnJvbSAnLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyJztcbmltcG9ydCB7IEtleSB9IGZyb20gXCIuLi8uLi8uLi9LZXlib2FyZFwiO1xuaW1wb3J0IHsgcmVwbGFjZWFibGVDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvcmVwbGFjZWFibGVDb21wb25lbnRcIjtcblxuaW50ZXJmYWNlIElNZW51T3B0aW9uUHJvcHMge1xuICAgIGNoaWxkcmVuOiBSZWFjdEVsZW1lbnQ7XG4gICAgaGlnaGxpZ2h0ZWQ/OiBib29sZWFuO1xuICAgIGRyb3Bkb3duS2V5OiBzdHJpbmc7XG4gICAgaWQ/OiBzdHJpbmc7XG4gICAgaW5wdXRSZWY/OiBSZWY8SFRNTERpdkVsZW1lbnQ+O1xuICAgIG9uQ2xpY2soZHJvcGRvd25LZXk6IHN0cmluZyk6IHZvaWQ7XG4gICAgb25Nb3VzZUVudGVyKGRyb3Bkb3duS2V5OiBzdHJpbmcpOiB2b2lkO1xufVxuXG5jbGFzcyBNZW51T3B0aW9uIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PElNZW51T3B0aW9uUHJvcHM+IHtcbiAgICBzdGF0aWMgZGVmYXVsdFByb3BzID0ge1xuICAgICAgICBkaXNhYmxlZDogZmFsc2UsXG4gICAgfTtcblxuICAgIHByaXZhdGUgb25Nb3VzZUVudGVyID0gKCkgPT4ge1xuICAgICAgICB0aGlzLnByb3BzLm9uTW91c2VFbnRlcih0aGlzLnByb3BzLmRyb3Bkb3duS2V5KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkNsaWNrID0gKGU6IFJlYWN0Lk1vdXNlRXZlbnQpID0+IHtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICB0aGlzLnByb3BzLm9uQ2xpY2sodGhpcy5wcm9wcy5kcm9wZG93bktleSk7XG4gICAgfTtcblxuICAgIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3Qgb3B0Q2xhc3NlcyA9IGNsYXNzbmFtZXMoe1xuICAgICAgICAgICAgbXhfRHJvcGRvd25fb3B0aW9uOiB0cnVlLFxuICAgICAgICAgICAgbXhfRHJvcGRvd25fb3B0aW9uX2hpZ2hsaWdodDogdGhpcy5wcm9wcy5oaWdobGlnaHRlZCxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIDxkaXZcbiAgICAgICAgICAgIGlkPXt0aGlzLnByb3BzLmlkfVxuICAgICAgICAgICAgY2xhc3NOYW1lPXtvcHRDbGFzc2VzfVxuICAgICAgICAgICAgb25DbGljaz17dGhpcy5vbkNsaWNrfVxuICAgICAgICAgICAgb25Nb3VzZUVudGVyPXt0aGlzLm9uTW91c2VFbnRlcn1cbiAgICAgICAgICAgIHJvbGU9XCJvcHRpb25cIlxuICAgICAgICAgICAgYXJpYS1zZWxlY3RlZD17dGhpcy5wcm9wcy5oaWdobGlnaHRlZH1cbiAgICAgICAgICAgIHJlZj17dGhpcy5wcm9wcy5pbnB1dFJlZn1cbiAgICAgICAgPlxuICAgICAgICAgICAgeyB0aGlzLnByb3BzLmNoaWxkcmVuIH1cbiAgICAgICAgPC9kaXY+O1xuICAgIH1cbn1cblxuaW50ZXJmYWNlIElQcm9wcyB7XG4gICAgaWQ6IHN0cmluZztcbiAgICAvLyBBUklBIGxhYmVsXG4gICAgbGFiZWw6IHN0cmluZztcbiAgICB2YWx1ZT86IHN0cmluZztcbiAgICBjbGFzc05hbWU/OiBzdHJpbmc7XG4gICAgY2hpbGRyZW46IFJlYWN0RWxlbWVudFtdO1xuICAgIC8vIG5lZ2F0aXZlIGZvciBjb25zaXN0ZW5jeSB3aXRoIEhUTUxcbiAgICBkaXNhYmxlZD86IGJvb2xlYW47XG4gICAgLy8gVGhlIHdpZHRoIHRoYXQgdGhlIGRyb3Bkb3duIHNob3VsZCBiZS4gSWYgc3BlY2lmaWVkLFxuICAgIC8vIHRoZSBkcm9wcGVkLWRvd24gcGFydCBvZiB0aGUgbWVudSB3aWxsIGJlIHNldCB0byB0aGlzXG4gICAgLy8gd2lkdGguXG4gICAgbWVudVdpZHRoPzogbnVtYmVyO1xuICAgIHNlYXJjaEVuYWJsZWQ/OiBib29sZWFuO1xuICAgIC8vIENhbGxlZCB3aGVuIHRoZSBzZWxlY3RlZCBvcHRpb24gY2hhbmdlc1xuICAgIG9uT3B0aW9uQ2hhbmdlKGRyb3Bkb3duS2V5OiBzdHJpbmcpOiB2b2lkO1xuICAgIC8vIENhbGxlZCB3aGVuIHRoZSB2YWx1ZSBvZiB0aGUgc2VhcmNoIGZpZWxkIGNoYW5nZXNcbiAgICBvblNlYXJjaENoYW5nZT8ocXVlcnk6IHN0cmluZyk6IHZvaWQ7XG4gICAgLy8gRnVuY3Rpb24gdGhhdCwgZ2l2ZW4gdGhlIGtleSBvZiBhbiBvcHRpb24sIHJldHVybnNcbiAgICAvLyBhIG5vZGUgcmVwcmVzZW50aW5nIHRoYXQgb3B0aW9uIHRvIGJlIGRpc3BsYXllZCBpbiB0aGVcbiAgICAvLyBib3ggaXRzZWxmIGFzIHRoZSBjdXJyZW50bHktc2VsZWN0ZWQgb3B0aW9uIChpZS4gYXNcbiAgICAvLyBvcHBvc2VkIHRvIGluIHRoZSBhY3R1YWwgZHJvcHBlZC1kb3duIHBhcnQpLiBJZlxuICAgIC8vIHVuc3BlY2lmaWVkLCB0aGUgYXBwcm9wcmlhdGUgY2hpbGQgZWxlbWVudCBpcyB1c2VkIGFzXG4gICAgLy8gaW4gdGhlIGRyb3BwZWQtZG93biBtZW51LlxuICAgIGdldFNob3J0T3B0aW9uPyh2YWx1ZTogc3RyaW5nKTogUmVhY3ROb2RlO1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBleHBhbmRlZDogYm9vbGVhbjtcbiAgICBoaWdobGlnaHRlZE9wdGlvbjogc3RyaW5nIHwgbnVsbDtcbiAgICBzZWFyY2hRdWVyeTogc3RyaW5nO1xufVxuXG4vKlxuICogUmV1c2FibGUgZHJvcGRvd24gc2VsZWN0IGNvbnRyb2wsIGFraW4gdG8gcmVhY3Qtc2VsZWN0LFxuICogYnV0IHNvbWV3aGF0IHNpbXBsZXIgYXMgcmVhY3Qtc2VsZWN0IGlzIDc5S0Igb2YgbWluaWZpZWRcbiAqIGphdmFzY3JpcHQuXG4gKi9cbkByZXBsYWNlYWJsZUNvbXBvbmVudChcInZpZXdzLmVsZW1lbnRzLkRyb3Bkb3duXCIpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBEcm9wZG93biBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxJUHJvcHMsIElTdGF0ZT4ge1xuICAgIHByaXZhdGUgcmVhZG9ubHkgYnV0dG9uUmVmID0gY3JlYXRlUmVmPEhUTUxEaXZFbGVtZW50PigpO1xuICAgIHByaXZhdGUgZHJvcGRvd25Sb290RWxlbWVudDogSFRNTERpdkVsZW1lbnQgPSBudWxsO1xuICAgIHByaXZhdGUgaWdub3JlRXZlbnQ6IE1vdXNlRXZlbnQgPSBudWxsO1xuICAgIHByaXZhdGUgY2hpbGRyZW5CeUtleTogUmVjb3JkPHN0cmluZywgUmVhY3ROb2RlPiA9IHt9O1xuXG4gICAgY29uc3RydWN0b3IocHJvcHM6IElQcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG5cbiAgICAgICAgdGhpcy5yZWluZGV4Q2hpbGRyZW4odGhpcy5wcm9wcy5jaGlsZHJlbik7XG5cbiAgICAgICAgY29uc3QgZmlyc3RDaGlsZCA9IFJlYWN0LkNoaWxkcmVuLnRvQXJyYXkocHJvcHMuY2hpbGRyZW4pWzBdIGFzIFJlYWN0RWxlbWVudDtcblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgLy8gVHJ1ZSBpZiB0aGUgbWVudSBpcyBkcm9wcGVkLWRvd25cbiAgICAgICAgICAgIGV4cGFuZGVkOiBmYWxzZSxcbiAgICAgICAgICAgIC8vIFRoZSBrZXkgb2YgdGhlIGhpZ2hsaWdodGVkIG9wdGlvblxuICAgICAgICAgICAgLy8gKHRoZSBvcHRpb24gdGhhdCB3b3VsZCBiZWNvbWUgc2VsZWN0ZWQgaWYgeW91IHByZXNzZWQgZW50ZXIpXG4gICAgICAgICAgICBoaWdobGlnaHRlZE9wdGlvbjogZmlyc3RDaGlsZCA/IGZpcnN0Q2hpbGQua2V5IGFzIHN0cmluZyA6IG51bGwsXG4gICAgICAgICAgICAvLyB0aGUgY3VycmVudCBzZWFyY2ggcXVlcnlcbiAgICAgICAgICAgIHNlYXJjaFF1ZXJ5OiAnJyxcbiAgICAgICAgfTtcblxuICAgICAgICAvLyBMaXN0ZW4gZm9yIGFsbCBjbGlja3Mgb24gdGhlIGRvY3VtZW50IHNvIHdlIGNhbiBjbG9zZSB0aGVcbiAgICAgICAgLy8gbWVudSB3aGVuIHRoZSB1c2VyIGNsaWNrcyBzb21ld2hlcmUgZWxzZVxuICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMub25Eb2N1bWVudENsaWNrLCBmYWxzZSk7XG4gICAgfVxuXG4gICAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdGhpcy5vbkRvY3VtZW50Q2xpY2ssIGZhbHNlKTtcbiAgICB9XG5cbiAgICAvLyBUT0RPOiBbUkVBQ1QtV0FSTklOR10gUmVwbGFjZSB3aXRoIGFwcHJvcHJpYXRlIGxpZmVjeWNsZSBldmVudFxuICAgIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5leHRQcm9wcykgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lXG4gICAgICAgIGlmICghbmV4dFByb3BzLmNoaWxkcmVuIHx8IG5leHRQcm9wcy5jaGlsZHJlbi5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnJlaW5kZXhDaGlsZHJlbihuZXh0UHJvcHMuY2hpbGRyZW4pO1xuICAgICAgICBjb25zdCBmaXJzdENoaWxkID0gbmV4dFByb3BzLmNoaWxkcmVuWzBdO1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIGhpZ2hsaWdodGVkT3B0aW9uOiBmaXJzdENoaWxkID8gZmlyc3RDaGlsZC5rZXkgOiBudWxsLFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlaW5kZXhDaGlsZHJlbihjaGlsZHJlbjogUmVhY3RFbGVtZW50W10pOiB2b2lkIHtcbiAgICAgICAgdGhpcy5jaGlsZHJlbkJ5S2V5ID0ge307XG4gICAgICAgIFJlYWN0LkNoaWxkcmVuLmZvckVhY2goY2hpbGRyZW4sIChjaGlsZCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5jaGlsZHJlbkJ5S2V5W2NoaWxkLmtleV0gPSBjaGlsZDtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkRvY3VtZW50Q2xpY2sgPSAoZXY6IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgICAgLy8gQ2xvc2UgdGhlIGRyb3Bkb3duIGlmIHRoZSB1c2VyIGNsaWNrcyBhbnl3aGVyZSB0aGF0IGlzbid0XG4gICAgICAgIC8vIHdpdGhpbiBvdXIgcm9vdCBlbGVtZW50XG4gICAgICAgIGlmIChldiAhPT0gdGhpcy5pZ25vcmVFdmVudCkge1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgZXhwYW5kZWQ6IGZhbHNlLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvblJvb3RDbGljayA9IChldjogTW91c2VFdmVudCkgPT4ge1xuICAgICAgICAvLyBUaGlzIGNhcHR1cmVzIGFueSBjbGlja3MgdGhhdCBoYXBwZW4gd2l0aGluIG91ciBlbGVtZW50cyxcbiAgICAgICAgLy8gc3VjaCB0aGF0IHdlIGNhbiB0aGVuIGlnbm9yZSB0aGVtIHdoZW4gdGhleSdyZSBzZWVuIGJ5IHRoZVxuICAgICAgICAvLyBjbGljayBsaXN0ZW5lciBvbiB0aGUgZG9jdW1lbnQgaGFuZGxlciwgaWUuIG5vdCBjbG9zZSB0aGVcbiAgICAgICAgLy8gZHJvcGRvd24gaW1tZWRpYXRlbHkgYWZ0ZXIgb3BlbmluZyBpdC5cbiAgICAgICAgLy8gTkIuIFdlIGNhbid0IGp1c3Qgc3RvcFByb3BhZ2F0aW9uKCkgYmVjYXVzZSB0aGVuIHRoZSBldmVudFxuICAgICAgICAvLyBkb2Vzbid0IHJlYWNoIHRoZSBSZWFjdCBvbkNsaWNrKCkuXG4gICAgICAgIHRoaXMuaWdub3JlRXZlbnQgPSBldjtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkFjY2Vzc2libGVCdXR0b25DbGljayA9IChldjogQnV0dG9uRXZlbnQpID0+IHtcbiAgICAgICAgaWYgKHRoaXMucHJvcHMuZGlzYWJsZWQpIHJldHVybjtcblxuICAgICAgICBpZiAoIXRoaXMuc3RhdGUuZXhwYW5kZWQpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBleHBhbmRlZDogdHJ1ZSB9KTtcbiAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIH0gZWxzZSBpZiAoKGV2IGFzIFJlYWN0LktleWJvYXJkRXZlbnQpLmtleSA9PT0gS2V5LkVOVEVSKSB7XG4gICAgICAgICAgICAvLyB0aGUgYWNjZXNzaWJsZSBidXR0b24gY29uc3VtZXMgZW50ZXIgb25LZXlEb3duIGZvciBmaXJpbmcgb25DbGljaywgc28gaGFuZGxlIGl0IGhlcmVcbiAgICAgICAgICAgIHRoaXMucHJvcHMub25PcHRpb25DaGFuZ2UodGhpcy5zdGF0ZS5oaWdobGlnaHRlZE9wdGlvbik7XG4gICAgICAgICAgICB0aGlzLmNsb3NlKCk7XG4gICAgICAgIH0gZWxzZSBpZiAoIShldiBhcyBSZWFjdC5LZXlib2FyZEV2ZW50KS5rZXkpIHtcbiAgICAgICAgICAgIC8vIGNvbGxhcHNlIG9uIG90aGVyIG5vbi1rZXlib2FyZCBldmVudCBhY3RpdmF0aW9uc1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGV4cGFuZGVkOiBmYWxzZSB9KTtcbiAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBjbG9zZSgpIHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBleHBhbmRlZDogZmFsc2UsXG4gICAgICAgIH0pO1xuICAgICAgICAvLyB0aGVpciBmb2N1cyB3YXMgb24gdGhlIGlucHV0LCBpdHMgZ2V0dGluZyB1bm1vdW50ZWQsIG1vdmUgaXQgdG8gdGhlIGJ1dHRvblxuICAgICAgICBpZiAodGhpcy5idXR0b25SZWYuY3VycmVudCkge1xuICAgICAgICAgICAgdGhpcy5idXR0b25SZWYuY3VycmVudC5mb2N1cygpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbk1lbnVPcHRpb25DbGljayA9IChkcm9wZG93bktleTogc3RyaW5nKSA9PiB7XG4gICAgICAgIHRoaXMuY2xvc2UoKTtcbiAgICAgICAgdGhpcy5wcm9wcy5vbk9wdGlvbkNoYW5nZShkcm9wZG93bktleSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25LZXlEb3duID0gKGU6IFJlYWN0LktleWJvYXJkRXZlbnQpID0+IHtcbiAgICAgICAgbGV0IGhhbmRsZWQgPSB0cnVlO1xuXG4gICAgICAgIC8vIFRoZXNlIGtleXMgZG9uJ3QgZ2VuZXJhdGUga2V5cHJlc3MgZXZlbnRzIGFuZCBzbyBuZWVkcyB0byBiZSBvbiBrZXl1cFxuICAgICAgICBzd2l0Y2ggKGUua2V5KSB7XG4gICAgICAgICAgICBjYXNlIEtleS5FTlRFUjpcbiAgICAgICAgICAgICAgICB0aGlzLnByb3BzLm9uT3B0aW9uQ2hhbmdlKHRoaXMuc3RhdGUuaGlnaGxpZ2h0ZWRPcHRpb24pO1xuICAgICAgICAgICAgICAgIC8vIGZhbGx0aHJvdWdoXG4gICAgICAgICAgICBjYXNlIEtleS5FU0NBUEU6XG4gICAgICAgICAgICAgICAgdGhpcy5jbG9zZSgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBLZXkuQVJST1dfRE9XTjpcbiAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICAgICAgaGlnaGxpZ2h0ZWRPcHRpb246IHRoaXMubmV4dE9wdGlvbih0aGlzLnN0YXRlLmhpZ2hsaWdodGVkT3B0aW9uKSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgS2V5LkFSUk9XX1VQOlxuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgICAgICBoaWdobGlnaHRlZE9wdGlvbjogdGhpcy5wcmV2T3B0aW9uKHRoaXMuc3RhdGUuaGlnaGxpZ2h0ZWRPcHRpb24pLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICBoYW5kbGVkID0gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaGFuZGxlZCkge1xuICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwcml2YXRlIG9uSW5wdXRDaGFuZ2UgPSAoZTogQ2hhbmdlRXZlbnQ8SFRNTElucHV0RWxlbWVudD4pID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBzZWFyY2hRdWVyeTogZS5jdXJyZW50VGFyZ2V0LnZhbHVlLFxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKHRoaXMucHJvcHMub25TZWFyY2hDaGFuZ2UpIHtcbiAgICAgICAgICAgIHRoaXMucHJvcHMub25TZWFyY2hDaGFuZ2UoZS5jdXJyZW50VGFyZ2V0LnZhbHVlKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwcml2YXRlIGNvbGxlY3RSb290ID0gKGU6IEhUTUxEaXZFbGVtZW50KSA9PiB7XG4gICAgICAgIGlmICh0aGlzLmRyb3Bkb3duUm9vdEVsZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMuZHJvcGRvd25Sb290RWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMub25Sb290Q2xpY2ssIGZhbHNlKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZSkge1xuICAgICAgICAgICAgZS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMub25Sb290Q2xpY2ssIGZhbHNlKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmRyb3Bkb3duUm9vdEVsZW1lbnQgPSBlO1xuICAgIH07XG5cbiAgICBwcml2YXRlIHNldEhpZ2hsaWdodGVkT3B0aW9uID0gKG9wdGlvbktleTogc3RyaW5nKSA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgaGlnaGxpZ2h0ZWRPcHRpb246IG9wdGlvbktleSxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgbmV4dE9wdGlvbihvcHRpb25LZXk6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyh0aGlzLmNoaWxkcmVuQnlLZXkpO1xuICAgICAgICBjb25zdCBpbmRleCA9IGtleXMuaW5kZXhPZihvcHRpb25LZXkpO1xuICAgICAgICByZXR1cm4ga2V5c1soaW5kZXggKyAxKSAlIGtleXMubGVuZ3RoXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHByZXZPcHRpb24ob3B0aW9uS2V5OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXModGhpcy5jaGlsZHJlbkJ5S2V5KTtcbiAgICAgICAgY29uc3QgaW5kZXggPSBrZXlzLmluZGV4T2Yob3B0aW9uS2V5KTtcbiAgICAgICAgcmV0dXJuIGtleXNbaW5kZXggPD0gMCA/IGtleXMubGVuZ3RoIC0gMSA6IChpbmRleCAtIDEpICUga2V5cy5sZW5ndGhdO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2Nyb2xsSW50b1ZpZXcobm9kZTogRWxlbWVudCkge1xuICAgICAgICBpZiAobm9kZSkge1xuICAgICAgICAgICAgbm9kZS5zY3JvbGxJbnRvVmlldyh7XG4gICAgICAgICAgICAgICAgYmxvY2s6IFwibmVhcmVzdFwiLFxuICAgICAgICAgICAgICAgIGJlaGF2aW9yOiBcImF1dG9cIixcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRNZW51T3B0aW9ucygpIHtcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IFJlYWN0LkNoaWxkcmVuLm1hcCh0aGlzLnByb3BzLmNoaWxkcmVuLCAoY2hpbGQpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGhpZ2hsaWdodGVkID0gdGhpcy5zdGF0ZS5oaWdobGlnaHRlZE9wdGlvbiA9PT0gY2hpbGQua2V5O1xuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICA8TWVudU9wdGlvblxuICAgICAgICAgICAgICAgICAgICBpZD17YCR7dGhpcy5wcm9wcy5pZH1fXyR7Y2hpbGQua2V5fWB9XG4gICAgICAgICAgICAgICAgICAgIGtleT17Y2hpbGQua2V5fVxuICAgICAgICAgICAgICAgICAgICBkcm9wZG93bktleT17Y2hpbGQua2V5IGFzIHN0cmluZ31cbiAgICAgICAgICAgICAgICAgICAgaGlnaGxpZ2h0ZWQ9e2hpZ2hsaWdodGVkfVxuICAgICAgICAgICAgICAgICAgICBvbk1vdXNlRW50ZXI9e3RoaXMuc2V0SGlnaGxpZ2h0ZWRPcHRpb259XG4gICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s9e3RoaXMub25NZW51T3B0aW9uQ2xpY2t9XG4gICAgICAgICAgICAgICAgICAgIGlucHV0UmVmPXtoaWdobGlnaHRlZCA/IHRoaXMuc2Nyb2xsSW50b1ZpZXcgOiB1bmRlZmluZWR9XG4gICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICB7IGNoaWxkIH1cbiAgICAgICAgICAgICAgICA8L01lbnVPcHRpb24+XG4gICAgICAgICAgICApO1xuICAgICAgICB9KTtcbiAgICAgICAgaWYgKG9wdGlvbnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gWzxkaXYga2V5PVwiMFwiIGNsYXNzTmFtZT1cIm14X0Ryb3Bkb3duX29wdGlvblwiIHJvbGU9XCJvcHRpb25cIj5cbiAgICAgICAgICAgICAgICB7IF90KFwiTm8gcmVzdWx0c1wiKSB9XG4gICAgICAgICAgICA8L2Rpdj5dO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBvcHRpb25zO1xuICAgIH1cblxuICAgIHJlbmRlcigpIHtcbiAgICAgICAgbGV0IGN1cnJlbnRWYWx1ZTtcblxuICAgICAgICBjb25zdCBtZW51U3R5bGU6IENTU1Byb3BlcnRpZXMgPSB7fTtcbiAgICAgICAgaWYgKHRoaXMucHJvcHMubWVudVdpZHRoKSBtZW51U3R5bGUud2lkdGggPSB0aGlzLnByb3BzLm1lbnVXaWR0aDtcblxuICAgICAgICBsZXQgbWVudTtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuZXhwYW5kZWQpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnByb3BzLnNlYXJjaEVuYWJsZWQpIHtcbiAgICAgICAgICAgICAgICBjdXJyZW50VmFsdWUgPSAoXG4gICAgICAgICAgICAgICAgICAgIDxpbnB1dFxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZT1cInRleHRcIlxuICAgICAgICAgICAgICAgICAgICAgICAgYXV0b0ZvY3VzPXt0cnVlfVxuICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfRHJvcGRvd25fb3B0aW9uXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2hhbmdlPXt0aGlzLm9uSW5wdXRDaGFuZ2V9XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZT17dGhpcy5zdGF0ZS5zZWFyY2hRdWVyeX1cbiAgICAgICAgICAgICAgICAgICAgICAgIHJvbGU9XCJjb21ib2JveFwiXG4gICAgICAgICAgICAgICAgICAgICAgICBhcmlhLWF1dG9jb21wbGV0ZT1cImxpc3RcIlxuICAgICAgICAgICAgICAgICAgICAgICAgYXJpYS1hY3RpdmVkZXNjZW5kYW50PXtgJHt0aGlzLnByb3BzLmlkfV9fJHt0aGlzLnN0YXRlLmhpZ2hsaWdodGVkT3B0aW9ufWB9XG4gICAgICAgICAgICAgICAgICAgICAgICBhcmlhLW93bnM9e2Ake3RoaXMucHJvcHMuaWR9X2xpc3Rib3hgfVxuICAgICAgICAgICAgICAgICAgICAgICAgYXJpYS1kaXNhYmxlZD17dGhpcy5wcm9wcy5kaXNhYmxlZH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGFyaWEtbGFiZWw9e3RoaXMucHJvcHMubGFiZWx9XG4gICAgICAgICAgICAgICAgICAgICAgICBvbktleURvd249e3RoaXMub25LZXlEb3dufVxuICAgICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBtZW51ID0gKFxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfRHJvcGRvd25fbWVudVwiIHN0eWxlPXttZW51U3R5bGV9IHJvbGU9XCJsaXN0Ym94XCIgaWQ9e2Ake3RoaXMucHJvcHMuaWR9X2xpc3Rib3hgfT5cbiAgICAgICAgICAgICAgICAgICAgeyB0aGlzLmdldE1lbnVPcHRpb25zKCkgfVxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghY3VycmVudFZhbHVlKSB7XG4gICAgICAgICAgICBjb25zdCBzZWxlY3RlZENoaWxkID0gdGhpcy5wcm9wcy5nZXRTaG9ydE9wdGlvbiA/XG4gICAgICAgICAgICAgICAgdGhpcy5wcm9wcy5nZXRTaG9ydE9wdGlvbih0aGlzLnByb3BzLnZhbHVlKSA6XG4gICAgICAgICAgICAgICAgdGhpcy5jaGlsZHJlbkJ5S2V5W3RoaXMucHJvcHMudmFsdWVdO1xuICAgICAgICAgICAgY3VycmVudFZhbHVlID0gPGRpdiBjbGFzc05hbWU9XCJteF9Ecm9wZG93bl9vcHRpb25cIiBpZD17YCR7dGhpcy5wcm9wcy5pZH1fdmFsdWVgfT5cbiAgICAgICAgICAgICAgICB7IHNlbGVjdGVkQ2hpbGQgfVxuICAgICAgICAgICAgPC9kaXY+O1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZHJvcGRvd25DbGFzc2VzID0ge1xuICAgICAgICAgICAgbXhfRHJvcGRvd246IHRydWUsXG4gICAgICAgICAgICBteF9Ecm9wZG93bl9kaXNhYmxlZDogdGhpcy5wcm9wcy5kaXNhYmxlZCxcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKHRoaXMucHJvcHMuY2xhc3NOYW1lKSB7XG4gICAgICAgICAgICBkcm9wZG93bkNsYXNzZXNbdGhpcy5wcm9wcy5jbGFzc05hbWVdID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIE5vdGUgdGhlIG1lbnUgc2l0cyBpbnNpZGUgdGhlIEFjY2Vzc2libGVCdXR0b24gZGl2IHNvIGl0J3MgYW5jaG9yZWRcbiAgICAgICAgLy8gdG8gdGhlIGlucHV0LCBidXQgb3ZlcmZsb3dzIGJlbG93IGl0LiBUaGUgcm9vdCBjb250YWlucyBib3RoLlxuICAgICAgICByZXR1cm4gPGRpdiBjbGFzc05hbWU9e2NsYXNzbmFtZXMoZHJvcGRvd25DbGFzc2VzKX0gcmVmPXt0aGlzLmNvbGxlY3RSb290fT5cbiAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfRHJvcGRvd25faW5wdXQgbXhfbm9fdGV4dGlucHV0XCJcbiAgICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLm9uQWNjZXNzaWJsZUJ1dHRvbkNsaWNrfVxuICAgICAgICAgICAgICAgIGFyaWEtaGFzcG9wdXA9XCJsaXN0Ym94XCJcbiAgICAgICAgICAgICAgICBhcmlhLWV4cGFuZGVkPXt0aGlzLnN0YXRlLmV4cGFuZGVkfVxuICAgICAgICAgICAgICAgIGRpc2FibGVkPXt0aGlzLnByb3BzLmRpc2FibGVkfVxuICAgICAgICAgICAgICAgIGlucHV0UmVmPXt0aGlzLmJ1dHRvblJlZn1cbiAgICAgICAgICAgICAgICBhcmlhLWxhYmVsPXt0aGlzLnByb3BzLmxhYmVsfVxuICAgICAgICAgICAgICAgIGFyaWEtZGVzY3JpYmVkYnk9e2Ake3RoaXMucHJvcHMuaWR9X3ZhbHVlYH1cbiAgICAgICAgICAgICAgICBvbktleURvd249e3RoaXMub25LZXlEb3dufVxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgIHsgY3VycmVudFZhbHVlIH1cbiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9XCJteF9Ecm9wZG93bl9hcnJvd1wiIC8+XG4gICAgICAgICAgICAgICAgeyBtZW51IH1cbiAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj5cbiAgICAgICAgPC9kaXY+O1xuICAgIH1cbn1cbiJdfQ==