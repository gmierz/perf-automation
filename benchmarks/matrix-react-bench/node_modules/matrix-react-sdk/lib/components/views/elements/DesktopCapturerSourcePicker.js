"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.Tabs = exports.ExistingSource = void 0;
exports.getDesktopCapturerSources = getDesktopCapturerSources;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _languageHandler = require("../../../languageHandler");

var _BaseDialog = _interopRequireDefault(require("..//dialogs/BaseDialog"));

var _DialogButtons = _interopRequireDefault(require("./DialogButtons"));

var _classnames = _interopRequireDefault(require("classnames"));

var _AccessibleButton = _interopRequireDefault(require("./AccessibleButton"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _TabbedView = _interopRequireWildcard(require("../../structures/TabbedView"));

var _dec, _class;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function getDesktopCapturerSources() {
  const options = {
    thumbnailSize: {
      height: 176,
      width: 312
    },
    types: ["screen", "window"]
  };
  return window.electron.getDesktopCapturerSources(options);
}

let Tabs;
exports.Tabs = Tabs;

(function (Tabs) {
  Tabs["Screens"] = "screen";
  Tabs["Windows"] = "window";
})(Tabs || (exports.Tabs = Tabs = {}));

class ExistingSource extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onClick", () => {
      this.props.onSelect(this.props.source);
    });
  }

  render() {
    const thumbnailClasses = (0, _classnames.default)({
      mx_desktopCapturerSourcePicker_source_thumbnail: true,
      mx_desktopCapturerSourcePicker_source_thumbnail_selected: this.props.selected
    });
    return /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      className: "mx_desktopCapturerSourcePicker_source",
      title: this.props.source.name,
      onClick: this.onClick
    }, /*#__PURE__*/_react.default.createElement("img", {
      className: thumbnailClasses,
      src: this.props.source.thumbnailURL
    }), /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_desktopCapturerSourcePicker_source_name"
    }, this.props.source.name));
  }

}

exports.ExistingSource = ExistingSource;
let DesktopCapturerSourcePicker = (_dec = (0, _replaceableComponent.replaceableComponent)("views.elements.DesktopCapturerSourcePicker"), _dec(_class = class DesktopCapturerSourcePicker extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "interval", void 0);
    (0, _defineProperty2.default)(this, "onSelect", source => {
      this.setState({
        selectedSource: source
      });
    });
    (0, _defineProperty2.default)(this, "onShare", () => {
      this.props.onFinished(this.state.selectedSource.id);
    });
    (0, _defineProperty2.default)(this, "onTabChange", () => {
      this.setState({
        selectedSource: null
      });
    });
    (0, _defineProperty2.default)(this, "onCloseClick", () => {
      this.props.onFinished(null);
    });
    this.state = {
      selectedTab: Tabs.Screens,
      sources: [],
      selectedSource: null
    };
  }

  async componentDidMount() {
    // setInterval() first waits and then executes, therefore
    // we call getDesktopCapturerSources() here without any delay.
    // Otherwise the dialog would be left empty for some time.
    this.setState({
      sources: await getDesktopCapturerSources()
    }); // We update the sources every 500ms to get newer thumbnails

    this.interval = setInterval(async () => {
      this.setState({
        sources: await getDesktopCapturerSources()
      });
    }, 500);
  }

  componentWillUnmount() {
    clearInterval(this.interval);
  }

  getTab(type, label) {
    const sources = this.state.sources.filter(source => source.id.startsWith(type)).map(source => {
      var _this$state$selectedS;

      return /*#__PURE__*/_react.default.createElement(ExistingSource, {
        selected: ((_this$state$selectedS = this.state.selectedSource) === null || _this$state$selectedS === void 0 ? void 0 : _this$state$selectedS.id) === source.id,
        source: source,
        onSelect: this.onSelect,
        key: source.id
      });
    });
    return new _TabbedView.Tab(type, label, null, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_desktopCapturerSourcePicker_tab"
    }, sources));
  }

  render() {
    const tabs = [this.getTab("screen", (0, _languageHandler._t)("Share entire screen")), this.getTab("window", (0, _languageHandler._t)("Application window"))];
    return /*#__PURE__*/_react.default.createElement(_BaseDialog.default, {
      className: "mx_desktopCapturerSourcePicker",
      onFinished: this.onCloseClick,
      title: (0, _languageHandler._t)("Share content")
    }, /*#__PURE__*/_react.default.createElement(_TabbedView.default, {
      tabs: tabs,
      tabLocation: _TabbedView.TabLocation.TOP,
      onChange: this.onTabChange
    }), /*#__PURE__*/_react.default.createElement(_DialogButtons.default, {
      primaryButton: (0, _languageHandler._t)("Share"),
      hasCancel: true,
      onCancel: this.onCloseClick,
      onPrimaryButtonClick: this.onShare,
      primaryDisabled: !this.state.selectedSource
    }));
  }

}) || _class);
exports.default = DesktopCapturerSourcePicker;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2VsZW1lbnRzL0Rlc2t0b3BDYXB0dXJlclNvdXJjZVBpY2tlci50c3giXSwibmFtZXMiOlsiZ2V0RGVza3RvcENhcHR1cmVyU291cmNlcyIsIm9wdGlvbnMiLCJ0aHVtYm5haWxTaXplIiwiaGVpZ2h0Iiwid2lkdGgiLCJ0eXBlcyIsIndpbmRvdyIsImVsZWN0cm9uIiwiVGFicyIsIkV4aXN0aW5nU291cmNlIiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwib25TZWxlY3QiLCJzb3VyY2UiLCJyZW5kZXIiLCJ0aHVtYm5haWxDbGFzc2VzIiwibXhfZGVza3RvcENhcHR1cmVyU291cmNlUGlja2VyX3NvdXJjZV90aHVtYm5haWwiLCJteF9kZXNrdG9wQ2FwdHVyZXJTb3VyY2VQaWNrZXJfc291cmNlX3RodW1ibmFpbF9zZWxlY3RlZCIsInNlbGVjdGVkIiwibmFtZSIsIm9uQ2xpY2siLCJ0aHVtYm5haWxVUkwiLCJEZXNrdG9wQ2FwdHVyZXJTb3VyY2VQaWNrZXIiLCJzZXRTdGF0ZSIsInNlbGVjdGVkU291cmNlIiwib25GaW5pc2hlZCIsInN0YXRlIiwiaWQiLCJzZWxlY3RlZFRhYiIsIlNjcmVlbnMiLCJzb3VyY2VzIiwiY29tcG9uZW50RGlkTW91bnQiLCJpbnRlcnZhbCIsInNldEludGVydmFsIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJjbGVhckludGVydmFsIiwiZ2V0VGFiIiwidHlwZSIsImxhYmVsIiwiZmlsdGVyIiwic3RhcnRzV2l0aCIsIm1hcCIsIlRhYiIsInRhYnMiLCJvbkNsb3NlQ2xpY2siLCJUYWJMb2NhdGlvbiIsIlRPUCIsIm9uVGFiQ2hhbmdlIiwib25TaGFyZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7OztBQUVPLFNBQVNBLHlCQUFULEdB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QUhYLG9CQUtJLDZCQUFDLG1CQUFEO0FBQVksTUFBQSxJQUFJLEVBQUVELElBQWxCO0FBQXdCLE1BQUEsV0FBVyxFQUFFRSx3QkFBWUMsR0FBakQ7QUFBc0QsTUFBQSxRQUFRLEVBQUUsS0FBS0M7QUFBckUsTUFMSixlQU1JLDZCQUFDLHNCQUFEO0FBQ0ksTUFBQSxhQUFhLEVBQUUseUJBQUcsT0FBSCxDQURuQjtBQUVJLE1BQUEsU0FBUyxFQUFFLElBRmY7QUFHSSxNQUFBLFFBQVEsRUFBRSxLQUFLSCxZQUhuQjtBQUlJLE1BQUEsb0JBQW9CLEVBQUUsS0FBS0ksT0FKL0I7QUFLSSxNQUFBLGVBQWUsRUFBRSxDQUFDLEtBQUt0QixLQUFMLENBQVdGO0FBTGpDLE1BTkosQ0FESjtBQWdCSDs7QUExRkgsQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAyMSDFoGltb24gQnJhbmRuZXIgPHNpbW9uLmJyYS5hZ0BnbWFpbC5jb20+XG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IF90IH0gZnJvbSAnLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyJztcbmltcG9ydCBCYXNlRGlhbG9nIGZyb20gXCIuLi8vZGlhbG9ncy9CYXNlRGlhbG9nXCI7XG5pbXBvcnQgRGlhbG9nQnV0dG9ucyBmcm9tIFwiLi9EaWFsb2dCdXR0b25zXCI7XG5pbXBvcnQgY2xhc3NOYW1lcyBmcm9tICdjbGFzc25hbWVzJztcbmltcG9ydCBBY2Nlc3NpYmxlQnV0dG9uIGZyb20gJy4vQWNjZXNzaWJsZUJ1dHRvbic7XG5pbXBvcnQgeyByZXBsYWNlYWJsZUNvbXBvbmVudCB9IGZyb20gXCIuLi8uLi8uLi91dGlscy9yZXBsYWNlYWJsZUNvbXBvbmVudFwiO1xuaW1wb3J0IFRhYmJlZFZpZXcsIHsgVGFiLCBUYWJMb2NhdGlvbiB9IGZyb20gJy4uLy4uL3N0cnVjdHVyZXMvVGFiYmVkVmlldyc7XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXREZXNrdG9wQ2FwdHVyZXJTb3VyY2VzKCk6IFByb21pc2U8QXJyYXk8RGVza3RvcENhcHR1cmVyU291cmNlPj4ge1xuICAgIGNvbnN0IG9wdGlvbnM6IEdldFNvdXJjZXNPcHRpb25zID0ge1xuICAgICAgICB0aHVtYm5haWxTaXplOiB7XG4gICAgICAgICAgICBoZWlnaHQ6IDE3NixcbiAgICAgICAgICAgIHdpZHRoOiAzMTIsXG4gICAgICAgIH0sXG4gICAgICAgIHR5cGVzOiBbXG4gICAgICAgICAgICBcInNjcmVlblwiLFxuICAgICAgICAgICAgXCJ3aW5kb3dcIixcbiAgICAgICAgXSxcbiAgICB9O1xuICAgIHJldHVybiB3aW5kb3cuZWxlY3Ryb24uZ2V0RGVza3RvcENhcHR1cmVyU291cmNlcyhvcHRpb25zKTtcbn1cblxuZXhwb3J0IGVudW0gVGFicyB7XG4gICAgU2NyZWVucyA9IFwic2NyZWVuXCIsXG4gICAgV2luZG93cyA9IFwid2luZG93XCIsXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXhpc3RpbmdTb3VyY2VJUHJvcHMge1xuICAgIHNvdXJjZTogRGVza3RvcENhcHR1cmVyU291cmNlO1xuICAgIG9uU2VsZWN0KHNvdXJjZTogRGVza3RvcENhcHR1cmVyU291cmNlKTogdm9pZDtcbiAgICBzZWxlY3RlZDogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGNsYXNzIEV4aXN0aW5nU291cmNlIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PEV4aXN0aW5nU291cmNlSVByb3BzPiB7XG4gICAgY29uc3RydWN0b3IocHJvcHM6IEV4aXN0aW5nU291cmNlSVByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uQ2xpY2sgPSAoKTogdm9pZCA9PiB7XG4gICAgICAgIHRoaXMucHJvcHMub25TZWxlY3QodGhpcy5wcm9wcy5zb3VyY2UpO1xuICAgIH07XG5cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIGNvbnN0IHRodW1ibmFpbENsYXNzZXMgPSBjbGFzc05hbWVzKHtcbiAgICAgICAgICAgIG14X2Rlc2t0b3BDYXB0dXJlclNvdXJjZVBpY2tlcl9zb3VyY2VfdGh1bWJuYWlsOiB0cnVlLFxuICAgICAgICAgICAgbXhfZGVza3RvcENhcHR1cmVyU291cmNlUGlja2VyX3NvdXJjZV90aHVtYm5haWxfc2VsZWN0ZWQ6IHRoaXMucHJvcHMuc2VsZWN0ZWQsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvblxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X2Rlc2t0b3BDYXB0dXJlclNvdXJjZVBpY2tlcl9zb3VyY2VcIlxuICAgICAgICAgICAgICAgIHRpdGxlPXt0aGlzLnByb3BzLnNvdXJjZS5uYW1lfVxuICAgICAgICAgICAgICAgIG9uQ2xpY2s9e3RoaXMub25DbGlja31cbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICA8aW1nXG4gICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT17dGh1bWJuYWlsQ2xhc3Nlc31cbiAgICAgICAgICAgICAgICAgICAgc3JjPXt0aGlzLnByb3BzLnNvdXJjZS50aHVtYm5haWxVUkx9XG4gICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9XCJteF9kZXNrdG9wQ2FwdHVyZXJTb3VyY2VQaWNrZXJfc291cmNlX25hbWVcIj57IHRoaXMucHJvcHMuc291cmNlLm5hbWUgfTwvc3Bhbj5cbiAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj5cbiAgICAgICAgKTtcbiAgICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUGlja2VySVN0YXRlIHtcbiAgICBzZWxlY3RlZFRhYjogVGFicztcbiAgICBzb3VyY2VzOiBBcnJheTxEZXNrdG9wQ2FwdHVyZXJTb3VyY2U+O1xuICAgIHNlbGVjdGVkU291cmNlOiBEZXNrdG9wQ2FwdHVyZXJTb3VyY2UgfCBudWxsO1xufVxuZXhwb3J0IGludGVyZmFjZSBQaWNrZXJJUHJvcHMge1xuICAgIG9uRmluaXNoZWQoc291cmNlSWQ6IHN0cmluZyk6IHZvaWQ7XG59XG5cbkByZXBsYWNlYWJsZUNvbXBvbmVudChcInZpZXdzLmVsZW1lbnRzLkRlc2t0b3BDYXB0dXJlclNvdXJjZVBpY2tlclwiKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRGVza3RvcENhcHR1cmVyU291cmNlUGlja2VyIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PFxuICAgIFBpY2tlcklQcm9wcyxcbiAgICBQaWNrZXJJU3RhdGVcbj4ge1xuICAgIGludGVydmFsOiBudW1iZXI7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wczogUGlja2VySVByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgc2VsZWN0ZWRUYWI6IFRhYnMuU2NyZWVucyxcbiAgICAgICAgICAgIHNvdXJjZXM6IFtdLFxuICAgICAgICAgICAgc2VsZWN0ZWRTb3VyY2U6IG51bGwsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgYXN5bmMgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgICAgIC8vIHNldEludGVydmFsKCkgZmlyc3Qgd2FpdHMgYW5kIHRoZW4gZXhlY3V0ZXMsIHRoZXJlZm9yZVxuICAgICAgICAvLyB3ZSBjYWxsIGdldERlc2t0b3BDYXB0dXJlclNvdXJjZXMoKSBoZXJlIHdpdGhvdXQgYW55IGRlbGF5LlxuICAgICAgICAvLyBPdGhlcndpc2UgdGhlIGRpYWxvZyB3b3VsZCBiZSBsZWZ0IGVtcHR5IGZvciBzb21lIHRpbWUuXG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgc291cmNlczogYXdhaXQgZ2V0RGVza3RvcENhcHR1cmVyU291cmNlcygpLFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBXZSB1cGRhdGUgdGhlIHNvdXJjZXMgZXZlcnkgNTAwbXMgdG8gZ2V0IG5ld2VyIHRodW1ibmFpbHNcbiAgICAgICAgdGhpcy5pbnRlcnZhbCA9IHNldEludGVydmFsKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgIHNvdXJjZXM6IGF3YWl0IGdldERlc2t0b3BDYXB0dXJlclNvdXJjZXMoKSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9LCA1MDApO1xuICAgIH1cblxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgICBjbGVhckludGVydmFsKHRoaXMuaW50ZXJ2YWwpO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25TZWxlY3QgPSAoc291cmNlOiBEZXNrdG9wQ2FwdHVyZXJTb3VyY2UpOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IHNlbGVjdGVkU291cmNlOiBzb3VyY2UgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25TaGFyZSA9ICgpOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5wcm9wcy5vbkZpbmlzaGVkKHRoaXMuc3RhdGUuc2VsZWN0ZWRTb3VyY2UuaWQpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uVGFiQ2hhbmdlID0gKCk6IHZvaWQgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgc2VsZWN0ZWRTb3VyY2U6IG51bGwgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25DbG9zZUNsaWNrID0gKCk6IHZvaWQgPT4ge1xuICAgICAgICB0aGlzLnByb3BzLm9uRmluaXNoZWQobnVsbCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgZ2V0VGFiKHR5cGU6IFwic2NyZWVuXCIgfCBcIndpbmRvd1wiLCBsYWJlbDogc3RyaW5nKTogVGFiIHtcbiAgICAgICAgY29uc3Qgc291cmNlcyA9IHRoaXMuc3RhdGUuc291cmNlcy5maWx0ZXIoKHNvdXJjZSkgPT4gc291cmNlLmlkLnN0YXJ0c1dpdGgodHlwZSkpLm1hcCgoc291cmNlKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgIDxFeGlzdGluZ1NvdXJjZVxuICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZD17dGhpcy5zdGF0ZS5zZWxlY3RlZFNvdXJjZT8uaWQgPT09IHNvdXJjZS5pZH1cbiAgICAgICAgICAgICAgICAgICAgc291cmNlPXtzb3VyY2V9XG4gICAgICAgICAgICAgICAgICAgIG9uU2VsZWN0PXt0aGlzLm9uU2VsZWN0fVxuICAgICAgICAgICAgICAgICAgICBrZXk9e3NvdXJjZS5pZH1cbiAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBUYWIodHlwZSwgbGFiZWwsIG51bGwsIChcbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfZGVza3RvcENhcHR1cmVyU291cmNlUGlja2VyX3RhYlwiPlxuICAgICAgICAgICAgICAgIHsgc291cmNlcyB9XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKSk7XG4gICAgfVxuXG4gICAgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCB0YWJzID0gW1xuICAgICAgICAgICAgdGhpcy5nZXRUYWIoXCJzY3JlZW5cIiwgX3QoXCJTaGFyZSBlbnRpcmUgc2NyZWVuXCIpKSxcbiAgICAgICAgICAgIHRoaXMuZ2V0VGFiKFwid2luZG93XCIsIF90KFwiQXBwbGljYXRpb24gd2luZG93XCIpKSxcbiAgICAgICAgXTtcblxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPEJhc2VEaWFsb2dcbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9kZXNrdG9wQ2FwdHVyZXJTb3VyY2VQaWNrZXJcIlxuICAgICAgICAgICAgICAgIG9uRmluaXNoZWQ9e3RoaXMub25DbG9zZUNsaWNrfVxuICAgICAgICAgICAgICAgIHRpdGxlPXtfdChcIlNoYXJlIGNvbnRlbnRcIil9XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgPFRhYmJlZFZpZXcgdGFicz17dGFic30gdGFiTG9jYXRpb249e1RhYkxvY2F0aW9uLlRPUH0gb25DaGFuZ2U9e3RoaXMub25UYWJDaGFuZ2V9IC8+XG4gICAgICAgICAgICAgICAgPERpYWxvZ0J1dHRvbnNcbiAgICAgICAgICAgICAgICAgICAgcHJpbWFyeUJ1dHRvbj17X3QoXCJTaGFyZVwiKX1cbiAgICAgICAgICAgICAgICAgICAgaGFzQ2FuY2VsPXt0cnVlfVxuICAgICAgICAgICAgICAgICAgICBvbkNhbmNlbD17dGhpcy5vbkNsb3NlQ2xpY2t9XG4gICAgICAgICAgICAgICAgICAgIG9uUHJpbWFyeUJ1dHRvbkNsaWNrPXt0aGlzLm9uU2hhcmV9XG4gICAgICAgICAgICAgICAgICAgIHByaW1hcnlEaXNhYmxlZD17IXRoaXMuc3RhdGUuc2VsZWN0ZWRTb3VyY2V9XG4gICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgIDwvQmFzZURpYWxvZz5cbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=