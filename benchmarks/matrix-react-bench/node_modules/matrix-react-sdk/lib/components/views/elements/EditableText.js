"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var _Keyboard = require("../../../Keyboard");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _dec, _class, _class2, _temp;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

var Phases;

(function (Phases) {
  Phases["Display"] = "display";
  Phases["Edit"] = "edit";
})(Phases || (Phases = {}));

let EditableText = (_dec = (0, _replaceableComponent.replaceableComponent)("views.elements.EditableText"), _dec(_class = (_temp = _class2 = class EditableText extends _react.default.Component {
  // we track value as an JS object field rather than in React state
  // as React doesn't play nice with contentEditable.
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "value", '');
    (0, _defineProperty2.default)(this, "placeholder", false);
    (0, _defineProperty2.default)(this, "editableDiv", /*#__PURE__*/(0, _react.createRef)());
    (0, _defineProperty2.default)(this, "showPlaceholder", show => {
      if (show) {
        this.editableDiv.current.textContent = this.props.placeholder;
        this.editableDiv.current.setAttribute("class", this.props.className + " " + this.props.placeholderClassName);
        this.placeholder = true;
        this.value = '';
      } else {
        this.editableDiv.current.textContent = this.value;
        this.editableDiv.current.setAttribute("class", this.props.className);
        this.placeholder = false;
      }
    });
    (0, _defineProperty2.default)(this, "cancelEdit", () => {
      this.setState({
        phase: Phases.Display
      });
      this.value = this.props.initialValue;
      this.showPlaceholder(!this.value);
      this.onValueChanged(false);
      this.editableDiv.current.blur();
    });
    (0, _defineProperty2.default)(this, "onValueChanged", shouldSubmit => {
      this.props.onValueChanged(this.value, shouldSubmit);
    });
    (0, _defineProperty2.default)(this, "onKeyDown", ev => {
      // console.log("keyDown: textContent=" + ev.target.textContent + ", value=" + this.value + ", placeholder=" + this.placeholder);
      if (this.placeholder) {
        this.showPlaceholder(false);
      }

      if (ev.key === _Keyboard.Key.ENTER) {
        ev.stopPropagation();
        ev.preventDefault();
      } // console.log("keyDown: textContent=" + ev.target.textContent + ", value=" + this.value + ", placeholder=" + this.placeholder);

    });
    (0, _defineProperty2.default)(this, "onKeyUp", ev => {
      // console.log("keyUp: textContent=" + ev.target.textContent + ", value=" + this.value + ", placeholder=" + this.placeholder);
      if (!ev.target.textContent) {
        this.showPlaceholder(true);
      } else if (!this.placeholder) {
        this.value = ev.target.textContent;
      }

      if (ev.key === _Keyboard.Key.ENTER) {
        this.onFinish(ev);
      } else if (ev.key === _Keyboard.Key.ESCAPE) {
        this.cancelEdit();
      } // console.log("keyUp: textContent=" + ev.target.textContent + ", value=" + this.value + ", placeholder=" + this.placeholder);

    });
    (0, _defineProperty2.default)(this, "onClickDiv", () => {
      if (!this.props.editable) return;
      this.setState({
        phase: Phases.Edit
      });
    });
    (0, _defineProperty2.default)(this, "onFocus", ev => {
      //ev.target.setSelectionRange(0, ev.target.textContent.length);
      const node = ev.target.childNodes[0];

      if (node) {
        const range = document.createRange();
        range.setStart(node, 0);
        range.setEnd(node, ev.target.childNodes.length);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      }
    });
    (0, _defineProperty2.default)(this, "onFinish", (ev, shouldSubmit) => {
      // eslint-disable-next-line @typescript-eslint/no-this-alias
      const self = this;
      const submit = "key" in ev && ev.key === _Keyboard.Key.ENTER || shouldSubmit;
      this.setState({
        phase: Phases.Display
      }, () => {
        if (this.value !== this.props.initialValue) {
          self.onValueChanged(submit);
        }
      });
    });
    (0, _defineProperty2.default)(this, "onBlur", ev => {
      const sel = window.getSelection();
      sel.removeAllRanges();

      if (this.props.blurToCancel) {
        this.cancelEdit();
      } else {
        this.onFinish(ev, this.props.blurToSubmit);
      }

      this.showPlaceholder(!this.value);
    });
    this.state = {
      phase: Phases.Display
    };
  } // TODO: [REACT-WARNING] Replace with appropriate lifecycle event
  // eslint-disable-next-line @typescript-eslint/naming-convention, camelcase


  UNSAFE_componentWillReceiveProps(nextProps) {
    if (nextProps.initialValue !== this.props.initialValue) {
      this.value = nextProps.initialValue;

      if (this.editableDiv.current) {
        this.showPlaceholder(!this.value);
      }
    }
  }

  componentDidMount() {
    this.value = this.props.initialValue;

    if (this.editableDiv.current) {
      this.showPlaceholder(!this.value);
    }
  }

  render() {
    const {
      className,
      editable,
      initialValue,
      label,
      labelClassName
    } = this.props;
    let editableEl;

    if (!editable || this.state.phase === Phases.Display && (label || labelClassName) && !this.value) {
      // show the label
      editableEl = /*#__PURE__*/_react.default.createElement("div", {
        className: className + " " + labelClassName,
        onClick: this.onClickDiv
      }, label || initialValue);
    } else {
      // show the content editable div, but manually manage its contents as react and contentEditable don't play nice together
      editableEl = /*#__PURE__*/_react.default.createElement("div", {
        ref: this.editableDiv,
        contentEditable: true,
        className: className,
        onKeyDown: this.onKeyDown,
        onKeyUp: this.onKeyUp,
        onFocus: this.onFocus,
        onBlur: this.onBlur
      });
    }

    return editableEl;
  }

}, (0, _defineProperty2.default)(_class2, "defaultProps", {
  onValueChanged() {},

  initialValue: '',
  label: '',
  placeholder: '',
  editable: true,
  className: "mx_EditableText",
  placeholderClassName: "mx_EditableText_placeholder",
  blurToSubmit: false
}), _temp)) || _class);
exports.default = EditableText;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2VsZW1lbnRzL0VkaXRhYmxlVGV4dC50c3giXSwibmFtZXMiOlsiUGhhc2VzIiwiRWRpdGFibGVUZXh0IiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwic2hvdyIsImVkaXRhYmxlRGl2IiwiY3VycmVudCIsInRleHRDb250ZW50IiwicGxhY2Vob2xkZXIiLCJzZXRBdHRyaWJ1dGUiLCJjbGFzc05hbWUiLCJwbGFjZWhvbGRlckNsYXNzTmFtZSIsInZhbHVlIiwic2V0U3RhdGUiLCJwaGFzZSIsIkRpc3BsYXkiLCJpbml0aWFsVmFsdWUiLCJzaG93UGxhY2Vob2xkZXIiLCJvblZhbHVlQ2hhbmdlZCIsImJsdXIiLCJzaG91bGRTdWJtaXQiLCJldiIsImtleSIsIktleSIsIkVOVEVSIiwic3RvcFByb3BhZ2F0aW9uIiwicHJldmVudERlZmF1bHQiLCJ0YXJnZXQiLCJvbkZpbmlzaCIsIkVTQ0FQRSIsImNhbmNlbEVkaXQiLCJlZGl0YWJsZSIsIkVkaXQiLCJub2RlIiwiY2hpbGROb2RlcyIsInJhbmdlIiwiZG9jdW1lbnQiLCJjcmVhdGVSYW5nZSIsInNldFN0YXJ0Iiwic2V0RW5kIiwibGVuZ3RoIiwic2VsIiwid2luZG93IiwiZ2V0U2VsZWN0aW9uIiwicmVtb3ZlQWxsUmFuZ2VzIiwiYWRkUmFuZ2UiLCJzZWxmIiwic3VibWl0IiwiYmx1clRvQ2FuY2VsIiwiYmx1clRvU3VibWl0Iiwic3RhdGUiLCJVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyIsIm5leHRQcm9wcyIsImNvbXBvbmVudERpZE1vdW50IiwicmVuZGVyIiwibGFiZWwiLCJsYWJlbENsYXNzTmFtZSIsImVkaXRhYmxlRWwiLCJvbkNsaWNrRGl2Iiwib25LZXlEb3duIiwib25LZXlVcCIsIm9uRm9jdXMiLCJvbkJsdXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBaUJBOztBQUNBOztB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bkNvcHlyaWdodCAyMDE4IE5ldyBWZWN0b3IgTHRkXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0LCB7IGNyZWF0ZVJlZiB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IEtleSB9IGZyb20gXCIuLi8uLi8uLi9LZXlib2FyZFwiO1xuaW1wb3J0IHsgcmVwbGFjZWFibGVDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvcmVwbGFjZWFibGVDb21wb25lbnRcIjtcblxuZW51bSBQaGFzZXMge1xuICAgIERpc3BsYXkgPSBcImRpc3BsYXlcIixcbiAgICBFZGl0ID0gXCJlZGl0XCIsXG59XG5cbmludGVyZmFjZSBJUHJvcHMge1xuICAgIG9uVmFsdWVDaGFuZ2VkPzogKHZhbHVlOiBzdHJpbmcsIHNob3VsZFN1Ym1pdDogYm9vbGVhbikgPT4gdm9pZDtcbiAgICBpbml0aWFsVmFsdWU/OiBzdHJpbmc7XG4gICAgbGFiZWw/OiBzdHJpbmc7XG4gICAgcGxhY2Vob2xkZXI/OiBzdHJpbmc7XG4gICAgY2xhc3NOYW1lPzogc3RyaW5nO1xuICAgIGxhYmVsQ2xhc3NOYW1lPzogc3RyaW5nO1xuICAgIHBsYWNlaG9sZGVyQ2xhc3NOYW1lPzogc3RyaW5nO1xuICAgIC8vIE92ZXJyaWRlcyBibHVyVG9TdWJtaXQgaWYgdHJ1ZVxuICAgIGJsdXJUb0NhbmNlbD86IGJvb2xlYW47XG4gICAgLy8gV2lsbCBjYXVzZSBvblZhbHVlQ2hhbmdlZCh2YWx1ZSwgdHJ1ZSkgdG8gZmlyZSBvbiBibHVyXG4gICAgYmx1clRvU3VibWl0PzogYm9vbGVhbjtcbiAgICBlZGl0YWJsZT86IGJvb2xlYW47XG59XG5cbmludGVyZmFjZSBJU3RhdGUge1xuICAgIHBoYXNlOiBQaGFzZXM7XG59XG5cbkByZXBsYWNlYWJsZUNvbXBvbmVudChcInZpZXdzLmVsZW1lbnRzLkVkaXRhYmxlVGV4dFwiKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRWRpdGFibGVUZXh0IGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PElQcm9wcywgSVN0YXRlPiB7XG4gICAgLy8gd2UgdHJhY2sgdmFsdWUgYXMgYW4gSlMgb2JqZWN0IGZpZWxkIHJhdGhlciB0aGFuIGluIFJlYWN0IHN0YXRlXG4gICAgLy8gYXMgUmVhY3QgZG9lc24ndCBwbGF5IG5pY2Ugd2l0aCBjb250ZW50RWRpdGFibGUuXG4gICAgcHVibGljIHZhbHVlID0gJyc7XG4gICAgcHJpdmF0ZSBwbGFjZWhvbGRlciA9IGZhbHNlO1xuICAgIHByaXZhdGUgZWRpdGFibGVEaXYgPSBjcmVhdGVSZWY8SFRNTERpdkVsZW1lbnQ+KCk7XG5cbiAgICBwdWJsaWMgc3RhdGljIGRlZmF1bHRQcm9wczogUGFydGlhbDxJUHJvcHM+ID0ge1xuICAgICAgICBvblZhbHVlQ2hhbmdlZCgpIHt9LFxuICAgICAgICBpbml0aWFsVmFsdWU6ICcnLFxuICAgICAgICBsYWJlbDogJycsXG4gICAgICAgIHBsYWNlaG9sZGVyOiAnJyxcbiAgICAgICAgZWRpdGFibGU6IHRydWUsXG4gICAgICAgIGNsYXNzTmFtZTogXCJteF9FZGl0YWJsZVRleHRcIixcbiAgICAgICAgcGxhY2Vob2xkZXJDbGFzc05hbWU6IFwibXhfRWRpdGFibGVUZXh0X3BsYWNlaG9sZGVyXCIsXG4gICAgICAgIGJsdXJUb1N1Ym1pdDogZmFsc2UsXG4gICAgfTtcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBJUHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuXG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICBwaGFzZTogUGhhc2VzLkRpc3BsYXksXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gVE9ETzogW1JFQUNULVdBUk5JTkddIFJlcGxhY2Ugd2l0aCBhcHByb3ByaWF0ZSBsaWZlY3ljbGUgZXZlbnRcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25hbWluZy1jb252ZW50aW9uLCBjYW1lbGNhc2VcbiAgICBwdWJsaWMgVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV4dFByb3BzOiBJUHJvcHMpOiB2b2lkIHtcbiAgICAgICAgaWYgKG5leHRQcm9wcy5pbml0aWFsVmFsdWUgIT09IHRoaXMucHJvcHMuaW5pdGlhbFZhbHVlKSB7XG4gICAgICAgICAgICB0aGlzLnZhbHVlID0gbmV4dFByb3BzLmluaXRpYWxWYWx1ZTtcbiAgICAgICAgICAgIGlmICh0aGlzLmVkaXRhYmxlRGl2LmN1cnJlbnQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNob3dQbGFjZWhvbGRlcighdGhpcy52YWx1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgY29tcG9uZW50RGlkTW91bnQoKTogdm9pZCB7XG4gICAgICAgIHRoaXMudmFsdWUgPSB0aGlzLnByb3BzLmluaXRpYWxWYWx1ZTtcbiAgICAgICAgaWYgKHRoaXMuZWRpdGFibGVEaXYuY3VycmVudCkge1xuICAgICAgICAgICAgdGhpcy5zaG93UGxhY2Vob2xkZXIoIXRoaXMudmFsdWUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzaG93UGxhY2Vob2xkZXIgPSAoc2hvdzogYm9vbGVhbik6IHZvaWQgPT4ge1xuICAgICAgICBpZiAoc2hvdykge1xuICAgICAgICAgICAgdGhpcy5lZGl0YWJsZURpdi5jdXJyZW50LnRleHRDb250ZW50ID0gdGhpcy5wcm9wcy5wbGFjZWhvbGRlcjtcbiAgICAgICAgICAgIHRoaXMuZWRpdGFibGVEaXYuY3VycmVudC5zZXRBdHRyaWJ1dGUoXCJjbGFzc1wiLCB0aGlzLnByb3BzLmNsYXNzTmFtZVxuICAgICAgICAgICAgICAgICsgXCIgXCIgKyB0aGlzLnByb3BzLnBsYWNlaG9sZGVyQ2xhc3NOYW1lKTtcbiAgICAgICAgICAgIHRoaXMucGxhY2Vob2xkZXIgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy52YWx1ZSA9ICcnO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5lZGl0YWJsZURpdi5jdXJyZW50LnRleHRDb250ZW50ID0gdGhpcy52YWx1ZTtcbiAgICAgICAgICAgIHRoaXMuZWRpdGFibGVEaXYuY3VycmVudC5zZXRBdHRyaWJ1dGUoXCJjbGFzc1wiLCB0aGlzLnByb3BzLmNsYXNzTmFtZSk7XG4gICAgICAgICAgICB0aGlzLnBsYWNlaG9sZGVyID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBjYW5jZWxFZGl0ID0gKCk6IHZvaWQgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIHBoYXNlOiBQaGFzZXMuRGlzcGxheSxcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMudmFsdWUgPSB0aGlzLnByb3BzLmluaXRpYWxWYWx1ZTtcbiAgICAgICAgdGhpcy5zaG93UGxhY2Vob2xkZXIoIXRoaXMudmFsdWUpO1xuICAgICAgICB0aGlzLm9uVmFsdWVDaGFuZ2VkKGZhbHNlKTtcbiAgICAgICAgdGhpcy5lZGl0YWJsZURpdi5jdXJyZW50LmJsdXIoKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvblZhbHVlQ2hhbmdlZCA9IChzaG91bGRTdWJtaXQ6IGJvb2xlYW4pOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5wcm9wcy5vblZhbHVlQ2hhbmdlZCh0aGlzLnZhbHVlLCBzaG91bGRTdWJtaXQpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uS2V5RG93biA9IChldjogUmVhY3QuS2V5Ym9hcmRFdmVudDxIVE1MRGl2RWxlbWVudD4pOiB2b2lkID0+IHtcbiAgICAgICAgLy8gY29uc29sZS5sb2coXCJrZXlEb3duOiB0ZXh0Q29udGVudD1cIiArIGV2LnRhcmdldC50ZXh0Q29udGVudCArIFwiLCB2YWx1ZT1cIiArIHRoaXMudmFsdWUgKyBcIiwgcGxhY2Vob2xkZXI9XCIgKyB0aGlzLnBsYWNlaG9sZGVyKTtcblxuICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlcikge1xuICAgICAgICAgICAgdGhpcy5zaG93UGxhY2Vob2xkZXIoZmFsc2UpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGV2LmtleSA9PT0gS2V5LkVOVEVSKSB7XG4gICAgICAgICAgICBldi5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBjb25zb2xlLmxvZyhcImtleURvd246IHRleHRDb250ZW50PVwiICsgZXYudGFyZ2V0LnRleHRDb250ZW50ICsgXCIsIHZhbHVlPVwiICsgdGhpcy52YWx1ZSArIFwiLCBwbGFjZWhvbGRlcj1cIiArIHRoaXMucGxhY2Vob2xkZXIpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uS2V5VXAgPSAoZXY6IFJlYWN0LktleWJvYXJkRXZlbnQ8SFRNTERpdkVsZW1lbnQ+KTogdm9pZCA9PiB7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKFwia2V5VXA6IHRleHRDb250ZW50PVwiICsgZXYudGFyZ2V0LnRleHRDb250ZW50ICsgXCIsIHZhbHVlPVwiICsgdGhpcy52YWx1ZSArIFwiLCBwbGFjZWhvbGRlcj1cIiArIHRoaXMucGxhY2Vob2xkZXIpO1xuXG4gICAgICAgIGlmICghKGV2LnRhcmdldCBhcyBIVE1MRGl2RWxlbWVudCkudGV4dENvbnRlbnQpIHtcbiAgICAgICAgICAgIHRoaXMuc2hvd1BsYWNlaG9sZGVyKHRydWUpO1xuICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLnBsYWNlaG9sZGVyKSB7XG4gICAgICAgICAgICB0aGlzLnZhbHVlID0gKGV2LnRhcmdldCBhcyBIVE1MRGl2RWxlbWVudCkudGV4dENvbnRlbnQ7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZXYua2V5ID09PSBLZXkuRU5URVIpIHtcbiAgICAgICAgICAgIHRoaXMub25GaW5pc2goZXYpO1xuICAgICAgICB9IGVsc2UgaWYgKGV2LmtleSA9PT0gS2V5LkVTQ0FQRSkge1xuICAgICAgICAgICAgdGhpcy5jYW5jZWxFZGl0KCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBjb25zb2xlLmxvZyhcImtleVVwOiB0ZXh0Q29udGVudD1cIiArIGV2LnRhcmdldC50ZXh0Q29udGVudCArIFwiLCB2YWx1ZT1cIiArIHRoaXMudmFsdWUgKyBcIiwgcGxhY2Vob2xkZXI9XCIgKyB0aGlzLnBsYWNlaG9sZGVyKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkNsaWNrRGl2ID0gKCk6IHZvaWQgPT4ge1xuICAgICAgICBpZiAoIXRoaXMucHJvcHMuZWRpdGFibGUpIHJldHVybjtcblxuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIHBoYXNlOiBQaGFzZXMuRWRpdCxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25Gb2N1cyA9IChldjogUmVhY3QuRm9jdXNFdmVudDxIVE1MRGl2RWxlbWVudD4pOiB2b2lkID0+IHtcbiAgICAgICAgLy9ldi50YXJnZXQuc2V0U2VsZWN0aW9uUmFuZ2UoMCwgZXYudGFyZ2V0LnRleHRDb250ZW50Lmxlbmd0aCk7XG5cbiAgICAgICAgY29uc3Qgbm9kZSA9IGV2LnRhcmdldC5jaGlsZE5vZGVzWzBdO1xuICAgICAgICBpZiAobm9kZSkge1xuICAgICAgICAgICAgY29uc3QgcmFuZ2UgPSBkb2N1bWVudC5jcmVhdGVSYW5nZSgpO1xuICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnQobm9kZSwgMCk7XG4gICAgICAgICAgICByYW5nZS5zZXRFbmQobm9kZSwgZXYudGFyZ2V0LmNoaWxkTm9kZXMubGVuZ3RoKTtcblxuICAgICAgICAgICAgY29uc3Qgc2VsID0gd2luZG93LmdldFNlbGVjdGlvbigpO1xuICAgICAgICAgICAgc2VsLnJlbW92ZUFsbFJhbmdlcygpO1xuICAgICAgICAgICAgc2VsLmFkZFJhbmdlKHJhbmdlKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwcml2YXRlIG9uRmluaXNoID0gKFxuICAgICAgICBldjogUmVhY3QuS2V5Ym9hcmRFdmVudDxIVE1MRGl2RWxlbWVudD4gfCBSZWFjdC5Gb2N1c0V2ZW50PEhUTUxEaXZFbGVtZW50PixcbiAgICAgICAgc2hvdWxkU3VibWl0PzogYm9vbGVhbixcbiAgICApOiB2b2lkID0+IHtcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby10aGlzLWFsaWFzXG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgICAgICBjb25zdCBzdWJtaXQgPSAoXCJrZXlcIiBpbiBldiAmJiBldi5rZXkgPT09IEtleS5FTlRFUikgfHwgc2hvdWxkU3VibWl0O1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIHBoYXNlOiBQaGFzZXMuRGlzcGxheSxcbiAgICAgICAgfSwgKCkgPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMudmFsdWUgIT09IHRoaXMucHJvcHMuaW5pdGlhbFZhbHVlKSB7XG4gICAgICAgICAgICAgICAgc2VsZi5vblZhbHVlQ2hhbmdlZChzdWJtaXQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkJsdXIgPSAoZXY6IFJlYWN0LkZvY3VzRXZlbnQ8SFRNTERpdkVsZW1lbnQ+KTogdm9pZCA9PiB7XG4gICAgICAgIGNvbnN0IHNlbCA9IHdpbmRvdy5nZXRTZWxlY3Rpb24oKTtcbiAgICAgICAgc2VsLnJlbW92ZUFsbFJhbmdlcygpO1xuXG4gICAgICAgIGlmICh0aGlzLnByb3BzLmJsdXJUb0NhbmNlbCkge1xuICAgICAgICAgICAgdGhpcy5jYW5jZWxFZGl0KCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLm9uRmluaXNoKGV2LCB0aGlzLnByb3BzLmJsdXJUb1N1Ym1pdCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnNob3dQbGFjZWhvbGRlcighdGhpcy52YWx1ZSk7XG4gICAgfTtcblxuICAgIHB1YmxpYyByZW5kZXIoKTogSlNYLkVsZW1lbnQge1xuICAgICAgICBjb25zdCB7IGNsYXNzTmFtZSwgZWRpdGFibGUsIGluaXRpYWxWYWx1ZSwgbGFiZWwsIGxhYmVsQ2xhc3NOYW1lIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBsZXQgZWRpdGFibGVFbDtcblxuICAgICAgICBpZiAoIWVkaXRhYmxlIHx8ICh0aGlzLnN0YXRlLnBoYXNlID09PSBQaGFzZXMuRGlzcGxheSAmJlxuICAgICAgICAgICAgKGxhYmVsIHx8IGxhYmVsQ2xhc3NOYW1lKSAmJiAhdGhpcy52YWx1ZSlcbiAgICAgICAgKSB7XG4gICAgICAgICAgICAvLyBzaG93IHRoZSBsYWJlbFxuICAgICAgICAgICAgZWRpdGFibGVFbCA9IDxkaXYgY2xhc3NOYW1lPXtjbGFzc05hbWUgKyBcIiBcIiArIGxhYmVsQ2xhc3NOYW1lfSBvbkNsaWNrPXt0aGlzLm9uQ2xpY2tEaXZ9PlxuICAgICAgICAgICAgICAgIHsgbGFiZWwgfHwgaW5pdGlhbFZhbHVlIH1cbiAgICAgICAgICAgIDwvZGl2PjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIHNob3cgdGhlIGNvbnRlbnQgZWRpdGFibGUgZGl2LCBidXQgbWFudWFsbHkgbWFuYWdlIGl0cyBjb250ZW50cyBhcyByZWFjdCBhbmQgY29udGVudEVkaXRhYmxlIGRvbid0IHBsYXkgbmljZSB0b2dldGhlclxuICAgICAgICAgICAgZWRpdGFibGVFbCA9IDxkaXZcbiAgICAgICAgICAgICAgICByZWY9e3RoaXMuZWRpdGFibGVEaXZ9XG4gICAgICAgICAgICAgICAgY29udGVudEVkaXRhYmxlPXt0cnVlfVxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZT17Y2xhc3NOYW1lfVxuICAgICAgICAgICAgICAgIG9uS2V5RG93bj17dGhpcy5vbktleURvd259XG4gICAgICAgICAgICAgICAgb25LZXlVcD17dGhpcy5vbktleVVwfVxuICAgICAgICAgICAgICAgIG9uRm9jdXM9e3RoaXMub25Gb2N1c31cbiAgICAgICAgICAgICAgICBvbkJsdXI9e3RoaXMub25CbHVyfVxuICAgICAgICAgICAgLz47XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZWRpdGFibGVFbDtcbiAgICB9XG59XG4iXX0=