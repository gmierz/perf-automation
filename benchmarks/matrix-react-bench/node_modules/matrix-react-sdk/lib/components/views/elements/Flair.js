"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireDefault(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _FlairStore = _interopRequireDefault(require("../../../stores/FlairStore"));

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var _MatrixClientContext = _interopRequireDefault(require("../../../contexts/MatrixClientContext"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _Media = require("../../../customisations/Media");

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class;

class FlairAvatar extends _react.default.Component {
  constructor() {
    super();
    this.onClick = this.onClick.bind(this);
  }

  onClick(ev) {
    ev.preventDefault(); // Don't trigger onClick of parent element

    ev.stopPropagation();

    _dispatcher.default.dispatch({
      action: 'view_group',
      group_id: this.props.groupProfile.groupId
    });
  }

  render() {
    const httpUrl = (0, _Media.mediaFromMxc)(this.props.groupProfile.avatarUrl).getSquareThumbnailHttp(16);
    const tooltip = this.props.groupProfile.name ? `${this.props.groupProfile.name} (${this.props.groupProfile.groupId})` : this.props.groupProfile.groupId;
    return /*#__PURE__*/_react.default.createElement("img", {
      src: httpUrl,
      width: "16",
      height: "16",
      onClick: this.onClick,
      title: tooltip
    });
  }

}

FlairAvatar.propTypes = {
  groupProfile: _propTypes.default.shape({
    groupId: _propTypes.default.string.isRequired,
    name: _propTypes.default.string,
    avatarUrl: _propTypes.default.string.isRequired
  })
};
FlairAvatar.contextType = _MatrixClientContext.default;
let Flair = (_dec = (0, _replaceableComponent.replaceableComponent)("views.elements.Flair"), _dec(_class = class Flair extends _react.default.Component {
  constructor() {
    super();
    this.state = {
      profiles: []
    };
  }

  componentDidMount() {
    this._unmounted = false;

    this._generateAvatars(this.props.groups);
  }

  componentWillUnmount() {
    this._unmounted = true;
  } // TODO: [REACT-WARNING] Replace with appropriate lifecycle event


  UNSAFE_componentWillReceiveProps(newProps) {
    // eslint-disable-line camelcase
    this._generateAvatars(newProps.groups);
  }

  async _getGroupProfiles(groups) {
    const profiles = [];

    for (const groupId of groups) {
      let groupProfile = null;

      try {
        groupProfile = await _FlairStore.default.getGroupProfileCached(this.context, groupId);
      } catch (err) {
        _logger.logger.error('Could not get profile for group', groupId, err);
      }

      profiles.push(groupProfile);
    }

    return profiles.filter(p => p !== null);
  }

  async _generateAvatars(groups) {
    if (!groups || groups.length === 0) {
      return;
    }

    const profiles = await this._getGroupProfiles(groups);

    if (!this.unmounted) {
      this.setState({
        profiles: profiles.filter(profile => {
          return profile ? profile.avatarUrl : false;
        })
      });
    }
  }

  render() {
    if (this.state.profiles.length === 0) {
      return null;
    }

    const avatars = this.state.profiles.map((profile, index) => {
      return /*#__PURE__*/_react.default.createElement(FlairAvatar, {
        key: index,
        groupProfile: profile
      });
    });
    return /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_Flair"
    }, avatars);
  }

}) || _class);
exports.default = Flair;
Flair.propTypes = {
  groups: _propTypes.default.arrayOf(_propTypes.default.string)
};
Flair.contextType = _MatrixClientContext.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2VsZW1lbnRzL0ZsYWlyLmpzIl0sIm5hbWVzIjpbIkZsYWlyQXZhdGFyIiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsIm9uQ2xpY2siLCJiaW5kIiwiZXYiLCJwcmV2ZW50RGVmYXVsdCIsInN0b3BQcm9wYWdhdGlvbiIsImRpcyIsImRpc3BhdGNoIiwiYWN0aW9uIiwiZ3JvdXBfaWQiLCJwcm9wcyIsImdyb3VwUHJvZmlsZSIsImdyb3VwSWQiLCJyZW5kZXIiLCJodHRwVXJsIiwiYXZhdGFyVXJsIiwiZ2V0U3F1YXJlVGh1bWJuYWlsSHR0cCIsInRvb2x0aXAiLCJuYW1lIiwicHJvcFR5cGVzIiwiUHJvcFR5cGVzIiwic2hhcGUiLCJzdHJpbmciLCJpc1JlcXVpcmVkIiwiY29udGV4dFR5cGUiLCJNYXRyaXhDbGllbnRDb250ZXh0IiwiRmxhaXIiLCJzdGF0ZSIsInByb2ZpbGVzIiwiY29tcG9uZW50RGlkTW91bnQiLCJfdW5tb3VudGVkIiwiX2dlbmVyYXRlQXZhdGFycyIsImdyb3VwcyIsImNvbXBvbmVudFdpbGxVbm1vdW50IiwiVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMiLCJuZXdQcm9wcyIsIl9nZXRHcm91cFByb2ZpbGVzIiwiRmxhaXJTdG9yZSIsImdldEdyb3VwUHJvZmlsZUNhY2hlZCIsImNvbnRleHQiLCJlcnIiLCJsb2dnZXIiLCJlcnJvciIsInB1c2giLCJmaWx0ZXIiLCJwIiwibGVuZ3RoIiwidW5tb3VudGVkIiwic2V0U3RhdGUiLCJwcm9maWxlIiwiYXZhdGFycyIsIm1hcCIsImluZGV4IiwiYXJyYXlPZiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBZ0JBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOzs7O0FBRUEsTUFBTUEsV0FBTixTQUEwQkMsZUFBTUMsU0FBaEMsQ0FBMEM7QUFDdENDLEVBQUFBLFdBQVcs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QmpDLG1CQUFVRSxNQUE1QjtBQURNLENBQWxCO0FBSUFJLEtBQUssQ0FBQ0YsV0FBTixHQUFvQkMsNEJBQXBCIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiBDb3B5cmlnaHQgMjAxNyBOZXcgVmVjdG9yIEx0ZC5cblxuIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4geW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cbiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcbmltcG9ydCBGbGFpclN0b3JlIGZyb20gJy4uLy4uLy4uL3N0b3Jlcy9GbGFpclN0b3JlJztcbmltcG9ydCBkaXMgZnJvbSAnLi4vLi4vLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyJztcbmltcG9ydCBNYXRyaXhDbGllbnRDb250ZXh0IGZyb20gXCIuLi8uLi8uLi9jb250ZXh0cy9NYXRyaXhDbGllbnRDb250ZXh0XCI7XG5pbXBvcnQgeyByZXBsYWNlYWJsZUNvbXBvbmVudCB9IGZyb20gXCIuLi8uLi8uLi91dGlscy9yZXBsYWNlYWJsZUNvbXBvbmVudFwiO1xuaW1wb3J0IHsgbWVkaWFGcm9tTXhjIH0gZnJvbSBcIi4uLy4uLy4uL2N1c3RvbWlzYXRpb25zL01lZGlhXCI7XG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcblxuY2xhc3MgRmxhaXJBdmF0YXIgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQge1xuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcigpO1xuICAgICAgICB0aGlzLm9uQ2xpY2sgPSB0aGlzLm9uQ2xpY2suYmluZCh0aGlzKTtcbiAgICB9XG5cbiAgICBvbkNsaWNrKGV2KSB7XG4gICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIC8vIERvbid0IHRyaWdnZXIgb25DbGljayBvZiBwYXJlbnQgZWxlbWVudFxuICAgICAgICBldi5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgZGlzLmRpc3BhdGNoKHtcbiAgICAgICAgICAgIGFjdGlvbjogJ3ZpZXdfZ3JvdXAnLFxuICAgICAgICAgICAgZ3JvdXBfaWQ6IHRoaXMucHJvcHMuZ3JvdXBQcm9maWxlLmdyb3VwSWQsXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3QgaHR0cFVybCA9IG1lZGlhRnJvbU14Yyh0aGlzLnByb3BzLmdyb3VwUHJvZmlsZS5hdmF0YXJVcmwpLmdldFNxdWFyZVRodW1ibmFpbEh0dHAoMTYpO1xuICAgICAgICBjb25zdCB0b29sdGlwID0gdGhpcy5wcm9wcy5ncm91cFByb2ZpbGUubmFtZSA/XG4gICAgICAgICAgICBgJHt0aGlzLnByb3BzLmdyb3VwUHJvZmlsZS5uYW1lfSAoJHt0aGlzLnByb3BzLmdyb3VwUHJvZmlsZS5ncm91cElkfSlgOlxuICAgICAgICAgICAgdGhpcy5wcm9wcy5ncm91cFByb2ZpbGUuZ3JvdXBJZDtcbiAgICAgICAgcmV0dXJuIDxpbWdcbiAgICAgICAgICAgIHNyYz17aHR0cFVybH1cbiAgICAgICAgICAgIHdpZHRoPVwiMTZcIlxuICAgICAgICAgICAgaGVpZ2h0PVwiMTZcIlxuICAgICAgICAgICAgb25DbGljaz17dGhpcy5vbkNsaWNrfVxuICAgICAgICAgICAgdGl0bGU9e3Rvb2x0aXB9IC8+O1xuICAgIH1cbn1cblxuRmxhaXJBdmF0YXIucHJvcFR5cGVzID0ge1xuICAgIGdyb3VwUHJvZmlsZTogUHJvcFR5cGVzLnNoYXBlKHtcbiAgICAgICAgZ3JvdXBJZDogUHJvcFR5cGVzLnN0cmluZy5pc1JlcXVpcmVkLFxuICAgICAgICBuYW1lOiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgICAgICBhdmF0YXJVcmw6IFByb3BUeXBlcy5zdHJpbmcuaXNSZXF1aXJlZCxcbiAgICB9KSxcbn07XG5cbkZsYWlyQXZhdGFyLmNvbnRleHRUeXBlID0gTWF0cml4Q2xpZW50Q29udGV4dDtcblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3MuZWxlbWVudHMuRmxhaXJcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEZsYWlyIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50IHtcbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIHByb2ZpbGVzOiBbXSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICAgICAgdGhpcy5fdW5tb3VudGVkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuX2dlbmVyYXRlQXZhdGFycyh0aGlzLnByb3BzLmdyb3Vwcyk7XG4gICAgfVxuXG4gICAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgICAgIHRoaXMuX3VubW91bnRlZCA9IHRydWU7XG4gICAgfVxuXG4gICAgLy8gVE9ETzogW1JFQUNULVdBUk5JTkddIFJlcGxhY2Ugd2l0aCBhcHByb3ByaWF0ZSBsaWZlY3ljbGUgZXZlbnRcbiAgICBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXdQcm9wcykgeyAgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjYW1lbGNhc2VcbiAgICAgICAgdGhpcy5fZ2VuZXJhdGVBdmF0YXJzKG5ld1Byb3BzLmdyb3Vwcyk7XG4gICAgfVxuXG4gICAgYXN5bmMgX2dldEdyb3VwUHJvZmlsZXMoZ3JvdXBzKSB7XG4gICAgICAgIGNvbnN0IHByb2ZpbGVzID0gW107XG4gICAgICAgIGZvciAoY29uc3QgZ3JvdXBJZCBvZiBncm91cHMpIHtcbiAgICAgICAgICAgIGxldCBncm91cFByb2ZpbGUgPSBudWxsO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBncm91cFByb2ZpbGUgPSBhd2FpdCBGbGFpclN0b3JlLmdldEdyb3VwUHJvZmlsZUNhY2hlZCh0aGlzLmNvbnRleHQsIGdyb3VwSWQpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCdDb3VsZCBub3QgZ2V0IHByb2ZpbGUgZm9yIGdyb3VwJywgZ3JvdXBJZCwgZXJyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHByb2ZpbGVzLnB1c2goZ3JvdXBQcm9maWxlKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcHJvZmlsZXMuZmlsdGVyKChwKSA9PiBwICE9PSBudWxsKTtcbiAgICB9XG5cbiAgICBhc3luYyBfZ2VuZXJhdGVBdmF0YXJzKGdyb3Vwcykge1xuICAgICAgICBpZiAoIWdyb3VwcyB8fCBncm91cHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcHJvZmlsZXMgPSBhd2FpdCB0aGlzLl9nZXRHcm91cFByb2ZpbGVzKGdyb3Vwcyk7XG4gICAgICAgIGlmICghdGhpcy51bm1vdW50ZWQpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgIHByb2ZpbGVzOiBwcm9maWxlcy5maWx0ZXIoKHByb2ZpbGUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHByb2ZpbGUgPyBwcm9maWxlLmF2YXRhclVybCA6IGZhbHNlO1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnByb2ZpbGVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgYXZhdGFycyA9IHRoaXMuc3RhdGUucHJvZmlsZXMubWFwKChwcm9maWxlLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIDxGbGFpckF2YXRhciBrZXk9e2luZGV4fSBncm91cFByb2ZpbGU9e3Byb2ZpbGV9IC8+O1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT1cIm14X0ZsYWlyXCI+XG4gICAgICAgICAgICAgICAgeyBhdmF0YXJzIH1cbiAgICAgICAgICAgIDwvc3Bhbj5cbiAgICAgICAgKTtcbiAgICB9XG59XG5cbkZsYWlyLnByb3BUeXBlcyA9IHtcbiAgICBncm91cHM6IFByb3BUeXBlcy5hcnJheU9mKFByb3BUeXBlcy5zdHJpbmcpLFxufTtcblxuRmxhaXIuY29udGV4dFR5cGUgPSBNYXRyaXhDbGllbnRDb250ZXh0O1xuIl19