"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _languageHandler = require("../../../languageHandler");

var sdk = _interopRequireWildcard(require("../../../index"));

var _GroupStore = _interopRequireDefault(require("../../../stores/GroupStore"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _GroupAddressPicker = require("../../../GroupAddressPicker");

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _AutoHideScrollbar = _interopRequireDefault(require("../../structures/AutoHideScrollbar"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _dec, _class, _class2, _temp;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

const INITIAL_LOAD_NUM_ROOMS = 30;
let GroupRoomList = (_dec = (0, _replaceableComponent.replaceableComponent)("views.groups.GroupRoomList"), _dec(_class = (_temp = _class2 = class GroupRoomList extends _react.default.Component {
  constructor(...args) {
    super(...args);
    (0, _defineProperty2.default)(this, "state", {
      rooms: null,
      truncateAt: INITIAL_LOAD_NUM_ROOMS,
      searchQuery: ""
    });
    (0, _defineProperty2.default)(this, "onGroupStoreUpdated", () => {
      if (this._unmounted) return;
      this.setState({
        rooms: _GroupStore.default.getGroupRooms(this.props.groupId)
      });
    });
    (0, _defineProperty2.default)(this, "_createOverflowTile", (overflowCount, totalCount) => {
      // For now we'll pretend this is any entity. It should probably be a separate tile.
      const EntityTile = sdk.getComponent("rooms.EntityTile");
      const BaseAvatar = sdk.getComponent("avatars.BaseAvatar");
      const text = (0, _languageHandler._t)("and %(count)s others...", {
        count: overflowCount
      });
      return /*#__PURE__*/_react.default.createElement(EntityTile, {
        className: "mx_EntityTile_ellipsis",
        avatarJsx: /*#__PURE__*/_react.default.createElement(BaseAvatar, {
          url: require("../../../../res/img/ellipsis.svg"),
          name: "...",
          width: 36,
          height: 36
        }),
        name: text,
        presenceState: "online",
        suppressOnHover: true,
        onClick: this._showFullRoomList
      });
    });
    (0, _defineProperty2.default)(this, "_showFullRoomList", () => {
      this.setState({
        truncateAt: -1
      });
    });
    (0, _defineProperty2.default)(this, "onSearchQueryChanged", ev => {
      this.setState({
        searchQuery: ev.target.value
      });
    });
    (0, _defineProperty2.default)(this, "onAddRoomToGroupButtonClick", () => {
      (0, _GroupAddressPicker.showGroupAddRoomDialog)(this.props.groupId).then(() => {
        this.forceUpdate();
      });
    });
  }

  componentDidMount() {
    this._unmounted = false;

    this._initGroupStore(this.props.groupId);
  }

  componentWillUnmount() {
    this._unmounted = true;

    this._unregisterGroupStore();
  }

  _unregisterGroupStore() {
    _GroupStore.default.unregisterListener(this.onGroupStoreUpdated);
  }

  _initGroupStore(groupId) {
    _GroupStore.default.registerListener(groupId, this.onGroupStoreUpdated); // XXX: This should be more fluxy - let's get the error from GroupStore .getError or something
    // XXX: This is also leaked - we should remove it when unmounting


    _GroupStore.default.on('error', (err, errorGroupId) => {
      if (errorGroupId !== groupId) return;
      this.setState({
        rooms: null
      });
    });
  }

  makeGroupRoomTiles(query) {
    const GroupRoomTile = sdk.getComponent("groups.GroupRoomTile");
    query = (query || "").toLowerCase();
    let roomList = this.state.rooms;

    if (query) {
      roomList = roomList.filter(room => {
        const matchesName = (room.name || "").toLowerCase().includes(query);
        const matchesAlias = (room.canonicalAlias || "").toLowerCase().includes(query);
        return matchesName || matchesAlias;
      });
    }

    roomList = roomList.map((groupRoom, index) => {
      return /*#__PURE__*/_react.default.createElement(GroupRoomTile, {
        key: index,
        groupId: this.props.groupId,
        groupRoom: groupRoom
      });
    });
    return roomList;
  }

  render() {
    if (this.state.rooms === null) {
      return null;
    }

    let inviteButton;

    if (_GroupStore.default.isUserPrivileged(this.props.groupId)) {
      inviteButton = /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        className: "mx_MemberList_invite mx_MemberList_addRoomToCommunity",
        onClick: this.onAddRoomToGroupButtonClick
      }, /*#__PURE__*/_react.default.createElement("span", null, (0, _languageHandler._t)('Add rooms to this community')));
    }

    const inputBox = /*#__PURE__*/_react.default.createElement("input", {
      className: "mx_GroupRoomList_query mx_textinput",
      id: "mx_GroupRoomList_query",
      type: "text",
      onChange: this.onSearchQueryChanged,
      value: this.state.searchQuery,
      placeholder: (0, _languageHandler._t)('Filter community rooms'),
      autoComplete: "off"
    });

    const TruncatedList = sdk.getComponent("elements.TruncatedList");
    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_GroupRoomList",
      role: "tabpanel"
    }, inviteButton, /*#__PURE__*/_react.default.createElement(_AutoHideScrollbar.default, {
      className: "mx_GroupRoomList_joined mx_GroupRoomList_outerWrapper"
    }, /*#__PURE__*/_react.default.createElement(TruncatedList, {
      className: "mx_GroupRoomList_wrapper",
      truncateAt: this.state.truncateAt,
      createOverflowElement: this._createOverflowTile
    }, this.makeGroupRoomTiles(this.state.searchQuery))), inputBox);
  }

}, (0, _defineProperty2.default)(_class2, "propTypes", {
  groupId: _propTypes.default.string.isRequired
}), _temp)) || _class);
exports.default = GroupRoomList;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2dyb3Vwcy9Hcm91cFJvb21MaXN0LmpzIl0sIm5hbWVzIjpbIklOSVRJQUxfTE9BRF9OVU1fUk9PTVMiLCJHcm91cFJvb21MaXN0IiwiUmVhY3QiLCJDb21wb25lbnQiLCJyb29tcyIsInRydW5jYXRlQXQiLCJzZWFyY2hRdWVyeSIsIl91bm1vdW50ZWQiLCJzZXRTdGF0ZSIsIkdyb3VwU3RvcmUiLCJnZXRHcm91cFJvb21zIiwicHJvcHMiLCJncm91cElkIiwib3ZlcmZsb3dDb3VudCIsInRvdGFsQ291bnQiLCJFbnRpdHlUaWxlIiwic2RrIiwiZ2V0Q29tcG9uZW50IiwiQmFzZUF2YXRhciIsInRleHQiLCJjb3VudCIsInJlcXVpcmUiLCJfc2hvd0Z1bGxSb29tTGlzdCIsImV2IiwidGFyZ2V0IiwidmFsdWUiLCJ0aGVuIiwiZm9yY2VVcGRhdGUiLCJjb21wb25lbnREaWRNb3VudCIsIl9pbml0R3JvdXBTdG9yZSIsImNvbXBvbmVudFdpbGxVbm1vdW50IiwiX3VucmVnaXN0ZXJHcm91cFN0b3JlIiwidW5yZWdpc3Rlckxpc3RlbmVyIiwib25Hcm91cFN0b3JlVXBkYXRlZCIsInJlZ2lzdGVyTGlzdGVuZXIiLCJvbiIsImVyciIsImVycm9yR3JvdXBJZCIsIm1ha2VHcm91cFJvb21UaWxlcyIsInF1ZXJ5IiwiR3JvdXBSb29tVGlsZSIsInRvTG93ZXJDYXNlIiwicm9vbUxpc3QiLCJzdGF0ZSIsImZpbHRlciIsInJvb20iLCJtYXRjaGVzTmFtZSIsIm5hbWUiLCJpbmNsdWRlcyIsIm1hdGNoZXNBbGlhcyIsImNhbm9uaWNhbEFsaWFzIiwibWFwIiwiZ3JvdXBSb29tIiwiaW5kZXgiLCJyZW5kZXIiLCJpbnZpdGVCdXR0b24iLCJpc1VzZXJQcml2aWxlZ2VkIiwib25BZGRSb29tVG9Hcm91cEJ1dHRvbkNsaWNrIiwiaW5wdXRCb3giLCJvblNlYXJjaFF1ZXJ5Q2hhbmdlZCIsIlRydW5jYXRlZExp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QUwsQ0FBd0IsS0FBS0ssS0FBTCxDQUFXckMsV0FBbkMsQ0FMTixDQURKLENBRkosRUFXTW9ELFFBWE4sQ0FESjtBQWVIOztBQXBKc0QsQyxzREFDcEM7QUFDZjlDLEVBQUFBLE9BQU8sRUFBRWtELG1CQUFVQyxNQUFWLENBQWlCQztBQURYLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTcgTmV3IFZlY3RvciBMdGQuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBfdCB9IGZyb20gJy4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlcic7XG5pbXBvcnQgKiBhcyBzZGsgZnJvbSAnLi4vLi4vLi4vaW5kZXgnO1xuaW1wb3J0IEdyb3VwU3RvcmUgZnJvbSAnLi4vLi4vLi4vc3RvcmVzL0dyb3VwU3RvcmUnO1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcbmltcG9ydCB7IHNob3dHcm91cEFkZFJvb21EaWFsb2cgfSBmcm9tICcuLi8uLi8uLi9Hcm91cEFkZHJlc3NQaWNrZXInO1xuaW1wb3J0IEFjY2Vzc2libGVCdXR0b24gZnJvbSAnLi4vZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvbic7XG5pbXBvcnQgQXV0b0hpZGVTY3JvbGxiYXIgZnJvbSBcIi4uLy4uL3N0cnVjdHVyZXMvQXV0b0hpZGVTY3JvbGxiYXJcIjtcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5cbmNvbnN0IElOSVRJQUxfTE9BRF9OVU1fUk9PTVMgPSAzMDtcblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3MuZ3JvdXBzLkdyb3VwUm9vbUxpc3RcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEdyb3VwUm9vbUxpc3QgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQge1xuICAgIHN0YXRpYyBwcm9wVHlwZXMgPSB7XG4gICAgICAgIGdyb3VwSWQ6IFByb3BUeXBlcy5zdHJpbmcuaXNSZXF1aXJlZCxcbiAgICB9O1xuXG4gICAgc3RhdGUgPSB7XG4gICAgICAgIHJvb21zOiBudWxsLFxuICAgICAgICB0cnVuY2F0ZUF0OiBJTklUSUFMX0xPQURfTlVNX1JPT01TLFxuICAgICAgICBzZWFyY2hRdWVyeTogXCJcIixcbiAgICB9O1xuXG4gICAgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgICAgIHRoaXMuX3VubW91bnRlZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLl9pbml0R3JvdXBTdG9yZSh0aGlzLnByb3BzLmdyb3VwSWQpO1xuICAgIH1cblxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgICB0aGlzLl91bm1vdW50ZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLl91bnJlZ2lzdGVyR3JvdXBTdG9yZSgpO1xuICAgIH1cblxuICAgIF91bnJlZ2lzdGVyR3JvdXBTdG9yZSgpIHtcbiAgICAgICAgR3JvdXBTdG9yZS51bnJlZ2lzdGVyTGlzdGVuZXIodGhpcy5vbkdyb3VwU3RvcmVVcGRhdGVkKTtcbiAgICB9XG5cbiAgICBfaW5pdEdyb3VwU3RvcmUoZ3JvdXBJZCkge1xuICAgICAgICBHcm91cFN0b3JlLnJlZ2lzdGVyTGlzdGVuZXIoZ3JvdXBJZCwgdGhpcy5vbkdyb3VwU3RvcmVVcGRhdGVkKTtcbiAgICAgICAgLy8gWFhYOiBUaGlzIHNob3VsZCBiZSBtb3JlIGZsdXh5IC0gbGV0J3MgZ2V0IHRoZSBlcnJvciBmcm9tIEdyb3VwU3RvcmUgLmdldEVycm9yIG9yIHNvbWV0aGluZ1xuICAgICAgICAvLyBYWFg6IFRoaXMgaXMgYWxzbyBsZWFrZWQgLSB3ZSBzaG91bGQgcmVtb3ZlIGl0IHdoZW4gdW5tb3VudGluZ1xuICAgICAgICBHcm91cFN0b3JlLm9uKCdlcnJvcicsIChlcnIsIGVycm9yR3JvdXBJZCkgPT4ge1xuICAgICAgICAgICAgaWYgKGVycm9yR3JvdXBJZCAhPT0gZ3JvdXBJZCkgcmV0dXJuO1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgcm9vbXM6IG51bGwsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgb25Hcm91cFN0b3JlVXBkYXRlZCA9ICgpID0+IHtcbiAgICAgICAgaWYgKHRoaXMuX3VubW91bnRlZCkgcmV0dXJuO1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIHJvb21zOiBHcm91cFN0b3JlLmdldEdyb3VwUm9vbXModGhpcy5wcm9wcy5ncm91cElkKSxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIF9jcmVhdGVPdmVyZmxvd1RpbGUgPSAob3ZlcmZsb3dDb3VudCwgdG90YWxDb3VudCkgPT4ge1xuICAgICAgICAvLyBGb3Igbm93IHdlJ2xsIHByZXRlbmQgdGhpcyBpcyBhbnkgZW50aXR5LiBJdCBzaG91bGQgcHJvYmFibHkgYmUgYSBzZXBhcmF0ZSB0aWxlLlxuICAgICAgICBjb25zdCBFbnRpdHlUaWxlID0gc2RrLmdldENvbXBvbmVudChcInJvb21zLkVudGl0eVRpbGVcIik7XG4gICAgICAgIGNvbnN0IEJhc2VBdmF0YXIgPSBzZGsuZ2V0Q29tcG9uZW50KFwiYXZhdGFycy5CYXNlQXZhdGFyXCIpO1xuICAgICAgICBjb25zdCB0ZXh0ID0gX3QoXCJhbmQgJShjb3VudClzIG90aGVycy4uLlwiLCB7IGNvdW50OiBvdmVyZmxvd0NvdW50IH0pO1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPEVudGl0eVRpbGVcbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9FbnRpdHlUaWxlX2VsbGlwc2lzXCJcbiAgICAgICAgICAgICAgICBhdmF0YXJKc3g9e1xuICAgICAgICAgICAgICAgICAgICA8QmFzZUF2YXRhciB1cmw9e3JlcXVpcmUoXCIuLi8uLi8uLi8uLi9yZXMvaW1nL2VsbGlwc2lzLnN2Z1wiKX0gbmFtZT1cIi4uLlwiIHdpZHRoPXszNn0gaGVpZ2h0PXszNn0gLz5cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbmFtZT17dGV4dH1cbiAgICAgICAgICAgICAgICBwcmVzZW5jZVN0YXRlPVwib25saW5lXCJcbiAgICAgICAgICAgICAgICBzdXBwcmVzc09uSG92ZXI9e3RydWV9XG4gICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5fc2hvd0Z1bGxSb29tTGlzdH1cbiAgICAgICAgICAgIC8+XG4gICAgICAgICk7XG4gICAgfTtcblxuICAgIF9zaG93RnVsbFJvb21MaXN0ID0gKCkgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIHRydW5jYXRlQXQ6IC0xLFxuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgb25TZWFyY2hRdWVyeUNoYW5nZWQgPSBldiA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBzZWFyY2hRdWVyeTogZXYudGFyZ2V0LnZhbHVlIH0pO1xuICAgIH07XG5cbiAgICBvbkFkZFJvb21Ub0dyb3VwQnV0dG9uQ2xpY2sgPSAoKSA9PiB7XG4gICAgICAgIHNob3dHcm91cEFkZFJvb21EaWFsb2codGhpcy5wcm9wcy5ncm91cElkKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZm9yY2VVcGRhdGUoKTtcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIG1ha2VHcm91cFJvb21UaWxlcyhxdWVyeSkge1xuICAgICAgICBjb25zdCBHcm91cFJvb21UaWxlID0gc2RrLmdldENvbXBvbmVudChcImdyb3Vwcy5Hcm91cFJvb21UaWxlXCIpO1xuICAgICAgICBxdWVyeSA9IChxdWVyeSB8fCBcIlwiKS50b0xvd2VyQ2FzZSgpO1xuXG4gICAgICAgIGxldCByb29tTGlzdCA9IHRoaXMuc3RhdGUucm9vbXM7XG4gICAgICAgIGlmIChxdWVyeSkge1xuICAgICAgICAgICAgcm9vbUxpc3QgPSByb29tTGlzdC5maWx0ZXIoKHJvb20pID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBtYXRjaGVzTmFtZSA9IChyb29tLm5hbWUgfHwgXCJcIikudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhxdWVyeSk7XG4gICAgICAgICAgICAgICAgY29uc3QgbWF0Y2hlc0FsaWFzID0gKHJvb20uY2Fub25pY2FsQWxpYXMgfHwgXCJcIikudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhxdWVyeSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoZXNOYW1lIHx8IG1hdGNoZXNBbGlhcztcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcm9vbUxpc3QgPSByb29tTGlzdC5tYXAoKGdyb3VwUm9vbSwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgPEdyb3VwUm9vbVRpbGVcbiAgICAgICAgICAgICAgICAgICAga2V5PXtpbmRleH1cbiAgICAgICAgICAgICAgICAgICAgZ3JvdXBJZD17dGhpcy5wcm9wcy5ncm91cElkfVxuICAgICAgICAgICAgICAgICAgICBncm91cFJvb209e2dyb3VwUm9vbX0gLz5cbiAgICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiByb29tTGlzdDtcbiAgICB9XG5cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnJvb21zID09PSBudWxsKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBpbnZpdGVCdXR0b247XG4gICAgICAgIGlmIChHcm91cFN0b3JlLmlzVXNlclByaXZpbGVnZWQodGhpcy5wcm9wcy5ncm91cElkKSkge1xuICAgICAgICAgICAgaW52aXRlQnV0dG9uID0gKFxuICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uXG4gICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X01lbWJlckxpc3RfaW52aXRlIG14X01lbWJlckxpc3RfYWRkUm9vbVRvQ29tbXVuaXR5XCJcbiAgICAgICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5vbkFkZFJvb21Ub0dyb3VwQnV0dG9uQ2xpY2t9XG4gICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICA8c3Bhbj57IF90KCdBZGQgcm9vbXMgdG8gdGhpcyBjb21tdW5pdHknKSB9PC9zcGFuPlxuICAgICAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj5cbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgaW5wdXRCb3ggPSAoXG4gICAgICAgICAgICA8aW5wdXRcbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9Hcm91cFJvb21MaXN0X3F1ZXJ5IG14X3RleHRpbnB1dFwiXG4gICAgICAgICAgICAgICAgaWQ9XCJteF9Hcm91cFJvb21MaXN0X3F1ZXJ5XCJcbiAgICAgICAgICAgICAgICB0eXBlPVwidGV4dFwiXG4gICAgICAgICAgICAgICAgb25DaGFuZ2U9e3RoaXMub25TZWFyY2hRdWVyeUNoYW5nZWR9XG4gICAgICAgICAgICAgICAgdmFsdWU9e3RoaXMuc3RhdGUuc2VhcmNoUXVlcnl9XG4gICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI9e190KCdGaWx0ZXIgY29tbXVuaXR5IHJvb21zJyl9XG4gICAgICAgICAgICAgICAgYXV0b0NvbXBsZXRlPVwib2ZmXCJcbiAgICAgICAgICAgIC8+XG4gICAgICAgICk7XG5cbiAgICAgICAgY29uc3QgVHJ1bmNhdGVkTGlzdCA9IHNkay5nZXRDb21wb25lbnQoXCJlbGVtZW50cy5UcnVuY2F0ZWRMaXN0XCIpO1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9Hcm91cFJvb21MaXN0XCIgcm9sZT1cInRhYnBhbmVsXCI+XG4gICAgICAgICAgICAgICAgeyBpbnZpdGVCdXR0b24gfVxuICAgICAgICAgICAgICAgIDxBdXRvSGlkZVNjcm9sbGJhciBjbGFzc05hbWU9XCJteF9Hcm91cFJvb21MaXN0X2pvaW5lZCBteF9Hcm91cFJvb21MaXN0X291dGVyV3JhcHBlclwiPlxuICAgICAgICAgICAgICAgICAgICA8VHJ1bmNhdGVkTGlzdFxuICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfR3JvdXBSb29tTGlzdF93cmFwcGVyXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRydW5jYXRlQXQ9e3RoaXMuc3RhdGUudHJ1bmNhdGVBdH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZU92ZXJmbG93RWxlbWVudD17dGhpcy5fY3JlYXRlT3ZlcmZsb3dUaWxlfVxuICAgICAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICAgICAgICB7IHRoaXMubWFrZUdyb3VwUm9vbVRpbGVzKHRoaXMuc3RhdGUuc2VhcmNoUXVlcnkpIH1cbiAgICAgICAgICAgICAgICAgICAgPC9UcnVuY2F0ZWRMaXN0PlxuICAgICAgICAgICAgICAgIDwvQXV0b0hpZGVTY3JvbGxiYXI+XG4gICAgICAgICAgICAgICAgeyBpbnB1dEJveCB9XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=