"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _languageHandler = require("../../../languageHandler");

var sdk = _interopRequireWildcard(require("../../../index"));

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var _GroupStore = _interopRequireDefault(require("../../../stores/GroupStore"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _GroupAddressPicker = require("../../../GroupAddressPicker");

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _RightPanelStorePhases = require("../../../stores/RightPanelStorePhases");

var _AutoHideScrollbar = _interopRequireDefault(require("../../structures/AutoHideScrollbar"));

var _actions = require("../../../dispatcher/actions");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _dec, _class, _class2, _temp;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

const INITIAL_LOAD_NUM_MEMBERS = 30;
let GroupMemberList = (_dec = (0, _replaceableComponent.replaceableComponent)("views.groups.GroupMemberList"), _dec(_class = (_temp = _class2 = class GroupMemberList extends _react.default.Component {
  constructor(...args) {
    super(...args);
    (0, _defineProperty2.default)(this, "state", {
      members: null,
      membersError: null,
      invitedMembers: null,
      invitedMembersError: null,
      truncateAt: INITIAL_LOAD_NUM_MEMBERS
    });
    (0, _defineProperty2.default)(this, "_createOverflowTile", (overflowCount, totalCount) => {
      // For now we'll pretend this is any entity. It should probably be a separate tile.
      const EntityTile = sdk.getComponent("rooms.EntityTile");
      const BaseAvatar = sdk.getComponent("avatars.BaseAvatar");
      const text = (0, _languageHandler._t)("and %(count)s others...", {
        count: overflowCount
      });
      return /*#__PURE__*/_react.default.createElement(EntityTile, {
        className: "mx_EntityTile_ellipsis",
        avatarJsx: /*#__PURE__*/_react.default.createElement(BaseAvatar, {
          url: require("../../../../res/img/ellipsis.svg"),
          name: "...",
          width: 36,
          height: 36
        }),
        name: text,
        presenceState: "online",
        suppressOnHover: true,
        onClick: this._showFullMemberList
      });
    });
    (0, _defineProperty2.default)(this, "_showFullMemberList", () => {
      this.setState({
        truncateAt: -1
      });
    });
    (0, _defineProperty2.default)(this, "onSearchQueryChanged", ev => {
      this.setState({
        searchQuery: ev.target.value
      });
    });
    (0, _defineProperty2.default)(this, "onInviteToGroupButtonClick", () => {
      (0, _GroupAddressPicker.showGroupInviteDialog)(this.props.groupId).then(() => {
        _dispatcher.default.dispatch({
          action: _actions.Action.SetRightPanelPhase,
          phase: _RightPanelStorePhases.RightPanelPhases.GroupMemberList,
          refireParams: {
            groupId: this.props.groupId
          }
        });
      });
    });
  }

  componentDidMount() {
    this._unmounted = false;

    this._initGroupStore(this.props.groupId);
  }

  componentWillUnmount() {
    this._unmounted = true;
  }

  _initGroupStore(groupId) {
    _GroupStore.default.registerListener(groupId, () => {
      this._fetchMembers();
    });

    _GroupStore.default.on('error', (err, errorGroupId, stateKey) => {
      if (this._unmounted || groupId !== errorGroupId) return;

      if (stateKey === _GroupStore.default.STATE_KEY.GroupMembers) {
        this.setState({
          membersError: err
        });
      }

      if (stateKey === _GroupStore.default.STATE_KEY.GroupInvitedMembers) {
        this.setState({
          invitedMembersError: err
        });
      }
    });
  }

  _fetchMembers() {
    if (this._unmounted) return;
    this.setState({
      members: _GroupStore.default.getGroupMembers(this.props.groupId),
      invitedMembers: _GroupStore.default.getGroupInvitedMembers(this.props.groupId)
    });
  }

  makeGroupMemberTiles(query, memberList, memberListError) {
    if (memberListError) {
      return /*#__PURE__*/_react.default.createElement("div", {
        className: "warning"
      }, (0, _languageHandler._t)("Failed to load group members"));
    }

    const GroupMemberTile = sdk.getComponent("groups.GroupMemberTile");
    const TruncatedList = sdk.getComponent("elements.TruncatedList");
    query = (query || "").toLowerCase();

    if (query) {
      memberList = memberList.filter(m => {
        const matchesName = (m.displayname || "").toLowerCase().includes(query);
        const matchesId = m.userId.toLowerCase().includes(query);

        if (!matchesName && !matchesId) {
          return false;
        }

        return true;
      });
    }

    const uniqueMembers = {};
    memberList.forEach(m => {
      if (!uniqueMembers[m.userId]) uniqueMembers[m.userId] = m;
    });
    memberList = Object.keys(uniqueMembers).map(userId => uniqueMembers[userId]); // Descending sort on isPrivileged = true = 1 to isPrivileged = false = 0

    memberList.sort((a, b) => {
      if (a.isPrivileged === b.isPrivileged) {
        const aName = a.displayname || a.userId;
        const bName = b.displayname || b.userId;

        if (aName < bName) {
          return -1;
        } else if (aName > bName) {
          return 1;
        } else {
          return 0;
        }
      } else {
        return a.isPrivileged ? -1 : 1;
      }
    });
    const memberTiles = memberList.map(m => {
      return /*#__PURE__*/_react.default.createElement(GroupMemberTile, {
        key: m.userId,
        groupId: this.props.groupId,
        member: m
      });
    });
    return /*#__PURE__*/_react.default.createElement(TruncatedList, {
      className: "mx_MemberList_wrapper",
      truncateAt: this.state.truncateAt,
      createOverflowElement: this._createOverflowTile
    }, memberTiles);
  }

  render() {
    if (this.state.fetching || this.state.fetchingInvitedMembers) {
      const Spinner = sdk.getComponent("elements.Spinner");
      return /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_MemberList"
      }, /*#__PURE__*/_react.default.createElement(Spinner, null));
    }

    const inputBox = /*#__PURE__*/_react.default.createElement("input", {
      className: "mx_GroupMemberList_query mx_textinput",
      id: "mx_GroupMemberList_query",
      type: "text",
      onChange: this.onSearchQueryChanged,
      value: this.state.searchQuery,
      placeholder: (0, _languageHandler._t)('Filter community members'),
      autoComplete: "off"
    });

    const joined = this.state.members ? /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_MemberList_joined"
    }, this.makeGroupMemberTiles(this.state.searchQuery, this.state.members, this.state.membersError)) : /*#__PURE__*/_react.default.createElement("div", null);
    const invited = this.state.invitedMembers && this.state.invitedMembers.length > 0 ? /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_MemberList_invited"
    }, /*#__PURE__*/_react.default.createElement("h2", null, (0, _languageHandler._t)("Invited")), this.makeGroupMemberTiles(this.state.searchQuery, this.state.invitedMembers, this.state.invitedMembersError)) : /*#__PURE__*/_react.default.createElement("div", null);
    let inviteButton;

    if (_GroupStore.default.isUserPrivileged(this.props.groupId)) {
      inviteButton = /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        className: "mx_MemberList_invite mx_MemberList_inviteCommunity",
        onClick: this.onInviteToGroupButtonClick
      }, /*#__PURE__*/_react.default.createElement("span", null, (0, _languageHandler._t)('Invite to this community')));
    }

    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_MemberList",
      role: "tabpanel"
    }, inviteButton, /*#__PURE__*/_react.default.createElement(_AutoHideScrollbar.default, null, joined, invited), inputBox);
  }

}, (0, _defineProperty2.default)(_class2, "propTypes", {
  groupId: _propTypes.default.string.isRequired
}), _temp)) || _class);
exports.default = GroupMemberList;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2dyb3Vwcy9Hcm91cE1lbWJlckxpc3QuanMiXSwibmFtZXMiOlsiSU5JVElBTF9MT0FEX05VTV9NRU1CRVJTIiwiR3JvdXBNZW1iZXJMaXN0IiwiUmVhY3QiLCJDb21wb25lbnQiLCJtZW1iZXJzIiwibWVtYmVyc0Vycm9yIiwiaW52aXRlZE1lbWJlcnMiLCJpbnZpdGVkTWVtYmVyc0Vycm9yIiwidHJ1bmNhdGVBdCIsIm92ZXJmbG93Q291bnQiLCJ0b3RhbENvdW50IiwiRW50aXR5VGlsZSIsInNkayIsImdldENvbXBvbmVudCIsIkJhc2VBdmF0YXIiLCJ0ZXh0IiwiY291bnQiLCJyZXF1aXJlIiwiX3Nob3dGdWxsTWVtYmVyTGlzdCIsInNldFN0YXRlIiwiZXYiLCJzZWFyY2hRdWVyeSIsInRhcmdldCIsInZhbHVlIiwicHJvcHMiLCJncm91cElkIiwidGhlbiIsImRpcyIsImRpc3BhdGNoIiwiYWN0aW9uIiwiQWN0aW9uIiwiU2V0UmlnaHRQYW5lbFBoYXNlIiwicGhhc2UiLCJSaWdodFBhbmVsUGhhc2VzIiwicmVmaXJlUGFyYW1zIiwiY29tcG9uZW50RGlkTW91bnQiLCJfdW5tb3VudGVkIiwiX2luaXRHcm91cFN0b3JlIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJHcm91cFN0b3JlIiwicmVnaXN0ZXJMaXN0ZW5lciIsIl9mZXRjaE1lbWJlcnMiLCJvbiIsImVyciIsImVycm9yR3JvdXBJZCIsInN0YXRlS2V5IiwiU1RBVEVfS0VZIiwiR3JvdXBNZW1iZXJzIiwiR3JvdXBJbnZpdGVkTWVtYmVycyIsImdldEdyb3VwTWVtYmVycyIsImdldEdyb3VwSW52aXRlZE1lbWJlcnMiLCJtYWtlR3JvdXBNZW1iZXJUaWxlcyIsInF1ZXJ5IiwibWVtYmVyTGlzdCIsIm1lbWJlckxpc3RFcnJvciIsIkdyb3VwTWVtYmVyVGlsZSIsIlRydW5jYXRlZExpc3QiLCJ0b0xvd2VyQ2FzZSIsImZpbHRlciIsIm0iLCJtYXRjaGVzTmFtZSIsImRpc3BsYXluYW1lIiwiaW5jbHVkZXMiLCJtYXRjaGVzSWQiLCJ1c2VySWQiLCJ1bmlxdWVNZW1iZXJzIiwiZm9yRWFjaCIsIk9iamVjdCIsImtleXMiLCJtYXAiLCJzb3J0IiwiYSIsImIiLCJpc1ByaXZpbGVnZWQiLCJhTmFtZSIsImJOYW1lIiwibWVtYmVyVGlsZXMiLCJzdGF0ZSIsIl9jcmVhdGVPdmVyZmxvd1RpbGUiLCJyZW5kZXIiLCJmZXRjaGluZyIsImZldGNoaW5nSW52aXRlZE1lbWJlcnMiLCJTcGlubmVyIiwiaW5wdXRCb3giLCJvblNlYXJjaFF1ZXJ5Q2hhbmdlZCIsImpvaW5lZCIsImludml0ZWQiLCJsZW5ndGgiLCJpbnZpdGVCdXR0b24iLCJpc1VzZXJQcml2aWxlZ2VkIiwib25JbnZpdGVUb0dyb3VwQnV0dG9uQ2xpY2siLCJQcm9wVHlwZXMiLCJzdHJpbmciLCJpc1JlcXVpcmVkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWlCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7QUFFQSxNQUFNQSx3QkFBd0IsR0FBRyxFQUFqQztJQUdxQkMsZSxXQURwQixnREFBcUIsOEJBQXJCLEMsbUNBQUQsTUFDcUJBLGVBRHJCLFNBQzZDQyxlQUFNQyxTQURuRCxDQUM2RDtBQUFBO0FBQUE7QUFBQSxpREFLakQ7QUFDSkMsTUFBQUEsT0FBTyxFQUFFLElBREw7QUFFSkMsTUFBQUEsWUFBWSxFQUFFLElBRlY7QUFHSkMsTUFBQUEsY0FBYyxFQUFFLElBSFo7QUFJSkMsTUFBQUEsbUJBQW1CLEVBQUUsSUFKakI7QUFLSkMsTUFBQUEsVUFBVSxFQUFFUjtBQUxSLEtBTGlEO0FBQUEsK0RBaURuQyxDQUFDUyxhQUFELEVBQWdCQyxVQUFoQixLQUErQjtBQUNqRDtBQUNBLFlBQU1DLFVBQVUsR0FBR0MsR0FBRyxDQUFDQyxZQUFKLENBQWlCLGtCQUFqQixDQUFuQjtBQUNB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QkFBRyxTQUFILENBQU4sQ0FESixFQUdRLEtBQUtwQyxvQkFBTCxDQUNJLEtBQUswQixLQUFMLENBQVd4RCxXQURmLEVBRUksS0FBS3dELEtBQUwsQ0FBV3ZFLGNBRmYsRUFHSSxLQUFLdUUsS0FBTCxDQUFXdEUsbUJBSGYsQ0FIUixDQURZLGdCQVVILHlDQVZiO0FBWUEsUUFBSWlGLFlBQUo7O0FBQ0EsUUFBSWpELG9CQUFXa0QsZ0JBQVgsQ0FBNEIsS0FBS2pFLEtBQUwsQ0FBV0MsT0FBdkMsQ0FBSixFQUFxRDtBQUNqRCtELE1BQUFBLFlBQVksZ0JBQ1IsNkJBQUMseUJBQUQ7QUFDSSxRQUFBLFNBQVMsRUFBQyxvREFEZDtBQUVJLFFBQUEsT0FBTyxFQUFFLEtBQUtFO0FBRmxCLHNCQUlJLDJDQUFRLHlCQUFHLDBCQUFILENBQVIsQ0FKSixDQURKO0FBUUg7O0FBRUQsd0JBQ0k7QUFBSyxNQUFBLFNBQVMsRUFBQyxlQUFmO0FBQStCLE1BQUEsSUFBSSxFQUFDO0FBQXBDLE9BQ01GLFlBRE4sZUFFSSw2QkFBQywwQkFBRCxRQUNNSCxNQUROLEVBRU1DLE9BRk4sQ0FGSixFQU1NSCxRQU5OLENBREo7QUFVSDs7QUFsTndELEMsc0RBQ3RDO0FBQ2YxRCxFQUFBQSxPQUFPLEVBQUVrRSxtQkFBVUMsTUFBVixDQUFpQkM7QUFEWCxDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE3IFZlY3RvciBDcmVhdGlvbnMgTHRkLlxuQ29weXJpZ2h0IDIwMTcgTmV3IFZlY3RvciBMdGQuXG5Db3B5cmlnaHQgMjAxOSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgX3QgfSBmcm9tICcuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXInO1xuaW1wb3J0ICogYXMgc2RrIGZyb20gJy4uLy4uLy4uL2luZGV4JztcbmltcG9ydCBkaXMgZnJvbSAnLi4vLi4vLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyJztcbmltcG9ydCBHcm91cFN0b3JlIGZyb20gJy4uLy4uLy4uL3N0b3Jlcy9Hcm91cFN0b3JlJztcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcyc7XG5pbXBvcnQgeyBzaG93R3JvdXBJbnZpdGVEaWFsb2cgfSBmcm9tICcuLi8uLi8uLi9Hcm91cEFkZHJlc3NQaWNrZXInO1xuaW1wb3J0IEFjY2Vzc2libGVCdXR0b24gZnJvbSAnLi4vZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvbic7XG5pbXBvcnQgeyBSaWdodFBhbmVsUGhhc2VzIH0gZnJvbSBcIi4uLy4uLy4uL3N0b3Jlcy9SaWdodFBhbmVsU3RvcmVQaGFzZXNcIjtcbmltcG9ydCBBdXRvSGlkZVNjcm9sbGJhciBmcm9tIFwiLi4vLi4vc3RydWN0dXJlcy9BdXRvSGlkZVNjcm9sbGJhclwiO1xuaW1wb3J0IHsgQWN0aW9uIH0gZnJvbSBcIi4uLy4uLy4uL2Rpc3BhdGNoZXIvYWN0aW9uc1wiO1xuaW1wb3J0IHsgcmVwbGFjZWFibGVDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvcmVwbGFjZWFibGVDb21wb25lbnRcIjtcblxuY29uc3QgSU5JVElBTF9MT0FEX05VTV9NRU1CRVJTID0gMzA7XG5cbkByZXBsYWNlYWJsZUNvbXBvbmVudChcInZpZXdzLmdyb3Vwcy5Hcm91cE1lbWJlckxpc3RcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEdyb3VwTWVtYmVyTGlzdCBleHRlbmRzIFJlYWN0LkNvbXBvbmVudCB7XG4gICAgc3RhdGljIHByb3BUeXBlcyA9IHtcbiAgICAgICAgZ3JvdXBJZDogUHJvcFR5cGVzLnN0cmluZy5pc1JlcXVpcmVkLFxuICAgIH07XG5cbiAgICBzdGF0ZSA9IHtcbiAgICAgICAgbWVtYmVyczogbnVsbCxcbiAgICAgICAgbWVtYmVyc0Vycm9yOiBudWxsLFxuICAgICAgICBpbnZpdGVkTWVtYmVyczogbnVsbCxcbiAgICAgICAgaW52aXRlZE1lbWJlcnNFcnJvcjogbnVsbCxcbiAgICAgICAgdHJ1bmNhdGVBdDogSU5JVElBTF9MT0FEX05VTV9NRU1CRVJTLFxuICAgIH07XG5cbiAgICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICAgICAgdGhpcy5fdW5tb3VudGVkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuX2luaXRHcm91cFN0b3JlKHRoaXMucHJvcHMuZ3JvdXBJZCk7XG4gICAgfVxuXG4gICAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgICAgIHRoaXMuX3VubW91bnRlZCA9IHRydWU7XG4gICAgfVxuXG4gICAgX2luaXRHcm91cFN0b3JlKGdyb3VwSWQpIHtcbiAgICAgICAgR3JvdXBTdG9yZS5yZWdpc3Rlckxpc3RlbmVyKGdyb3VwSWQsICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuX2ZldGNoTWVtYmVycygpO1xuICAgICAgICB9KTtcbiAgICAgICAgR3JvdXBTdG9yZS5vbignZXJyb3InLCAoZXJyLCBlcnJvckdyb3VwSWQsIHN0YXRlS2V5KSA9PiB7XG4gICAgICAgICAgICBpZiAodGhpcy5fdW5tb3VudGVkIHx8IGdyb3VwSWQgIT09IGVycm9yR3JvdXBJZCkgcmV0dXJuO1xuICAgICAgICAgICAgaWYgKHN0YXRlS2V5ID09PSBHcm91cFN0b3JlLlNUQVRFX0tFWS5Hcm91cE1lbWJlcnMpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICAgICAgbWVtYmVyc0Vycm9yOiBlcnIsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoc3RhdGVLZXkgPT09IEdyb3VwU3RvcmUuU1RBVEVfS0VZLkdyb3VwSW52aXRlZE1lbWJlcnMpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICAgICAgaW52aXRlZE1lbWJlcnNFcnJvcjogZXJyLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfZmV0Y2hNZW1iZXJzKCkge1xuICAgICAgICBpZiAodGhpcy5fdW5tb3VudGVkKSByZXR1cm47XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgbWVtYmVyczogR3JvdXBTdG9yZS5nZXRHcm91cE1lbWJlcnModGhpcy5wcm9wcy5ncm91cElkKSxcbiAgICAgICAgICAgIGludml0ZWRNZW1iZXJzOiBHcm91cFN0b3JlLmdldEdyb3VwSW52aXRlZE1lbWJlcnModGhpcy5wcm9wcy5ncm91cElkKSxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgX2NyZWF0ZU92ZXJmbG93VGlsZSA9IChvdmVyZmxvd0NvdW50LCB0b3RhbENvdW50KSA9PiB7XG4gICAgICAgIC8vIEZvciBub3cgd2UnbGwgcHJldGVuZCB0aGlzIGlzIGFueSBlbnRpdHkuIEl0IHNob3VsZCBwcm9iYWJseSBiZSBhIHNlcGFyYXRlIHRpbGUuXG4gICAgICAgIGNvbnN0IEVudGl0eVRpbGUgPSBzZGsuZ2V0Q29tcG9uZW50KFwicm9vbXMuRW50aXR5VGlsZVwiKTtcbiAgICAgICAgY29uc3QgQmFzZUF2YXRhciA9IHNkay5nZXRDb21wb25lbnQoXCJhdmF0YXJzLkJhc2VBdmF0YXJcIik7XG4gICAgICAgIGNvbnN0IHRleHQgPSBfdChcImFuZCAlKGNvdW50KXMgb3RoZXJzLi4uXCIsIHsgY291bnQ6IG92ZXJmbG93Q291bnQgfSk7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8RW50aXR5VGlsZVxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X0VudGl0eVRpbGVfZWxsaXBzaXNcIlxuICAgICAgICAgICAgICAgIGF2YXRhckpzeD17XG4gICAgICAgICAgICAgICAgICAgIDxCYXNlQXZhdGFyIHVybD17cmVxdWlyZShcIi4uLy4uLy4uLy4uL3Jlcy9pbWcvZWxsaXBzaXMuc3ZnXCIpfSBuYW1lPVwiLi4uXCIgd2lkdGg9ezM2fSBoZWlnaHQ9ezM2fSAvPlxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBuYW1lPXt0ZXh0fVxuICAgICAgICAgICAgICAgIHByZXNlbmNlU3RhdGU9XCJvbmxpbmVcIlxuICAgICAgICAgICAgICAgIHN1cHByZXNzT25Ib3Zlcj17dHJ1ZX1cbiAgICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLl9zaG93RnVsbE1lbWJlckxpc3R9XG4gICAgICAgICAgICAvPlxuICAgICAgICApO1xuICAgIH07XG5cbiAgICBfc2hvd0Z1bGxNZW1iZXJMaXN0ID0gKCkgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIHRydW5jYXRlQXQ6IC0xLFxuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgb25TZWFyY2hRdWVyeUNoYW5nZWQgPSBldiA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBzZWFyY2hRdWVyeTogZXYudGFyZ2V0LnZhbHVlIH0pO1xuICAgIH07XG5cbiAgICBtYWtlR3JvdXBNZW1iZXJUaWxlcyhxdWVyeSwgbWVtYmVyTGlzdCwgbWVtYmVyTGlzdEVycm9yKSB7XG4gICAgICAgIGlmIChtZW1iZXJMaXN0RXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVybiA8ZGl2IGNsYXNzTmFtZT1cIndhcm5pbmdcIj57IF90KFwiRmFpbGVkIHRvIGxvYWQgZ3JvdXAgbWVtYmVyc1wiKSB9PC9kaXY+O1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgR3JvdXBNZW1iZXJUaWxlID0gc2RrLmdldENvbXBvbmVudChcImdyb3Vwcy5Hcm91cE1lbWJlclRpbGVcIik7XG4gICAgICAgIGNvbnN0IFRydW5jYXRlZExpc3QgPSBzZGsuZ2V0Q29tcG9uZW50KFwiZWxlbWVudHMuVHJ1bmNhdGVkTGlzdFwiKTtcbiAgICAgICAgcXVlcnkgPSAocXVlcnkgfHwgXCJcIikudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgaWYgKHF1ZXJ5KSB7XG4gICAgICAgICAgICBtZW1iZXJMaXN0ID0gbWVtYmVyTGlzdC5maWx0ZXIoKG0pID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBtYXRjaGVzTmFtZSA9IChtLmRpc3BsYXluYW1lIHx8IFwiXCIpLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMocXVlcnkpO1xuICAgICAgICAgICAgICAgIGNvbnN0IG1hdGNoZXNJZCA9IG0udXNlcklkLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMocXVlcnkpO1xuXG4gICAgICAgICAgICAgICAgaWYgKCFtYXRjaGVzTmFtZSAmJiAhbWF0Y2hlc0lkKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdW5pcXVlTWVtYmVycyA9IHt9O1xuICAgICAgICBtZW1iZXJMaXN0LmZvckVhY2goKG0pID0+IHtcbiAgICAgICAgICAgIGlmICghdW5pcXVlTWVtYmVyc1ttLnVzZXJJZF0pIHVuaXF1ZU1lbWJlcnNbbS51c2VySWRdID0gbTtcbiAgICAgICAgfSk7XG4gICAgICAgIG1lbWJlckxpc3QgPSBPYmplY3Qua2V5cyh1bmlxdWVNZW1iZXJzKS5tYXAoKHVzZXJJZCkgPT4gdW5pcXVlTWVtYmVyc1t1c2VySWRdKTtcbiAgICAgICAgLy8gRGVzY2VuZGluZyBzb3J0IG9uIGlzUHJpdmlsZWdlZCA9IHRydWUgPSAxIHRvIGlzUHJpdmlsZWdlZCA9IGZhbHNlID0gMFxuICAgICAgICBtZW1iZXJMaXN0LnNvcnQoKGEsIGIpID0+IHtcbiAgICAgICAgICAgIGlmIChhLmlzUHJpdmlsZWdlZCA9PT0gYi5pc1ByaXZpbGVnZWQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBhTmFtZSA9IGEuZGlzcGxheW5hbWUgfHwgYS51c2VySWQ7XG4gICAgICAgICAgICAgICAgY29uc3QgYk5hbWUgPSBiLmRpc3BsYXluYW1lIHx8IGIudXNlcklkO1xuICAgICAgICAgICAgICAgIGlmIChhTmFtZSA8IGJOYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAtMTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFOYW1lID4gYk5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gYS5pc1ByaXZpbGVnZWQgPyAtMSA6IDE7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IG1lbWJlclRpbGVzID0gbWVtYmVyTGlzdC5tYXAoKG0pID0+IHtcbiAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgPEdyb3VwTWVtYmVyVGlsZSBrZXk9e20udXNlcklkfSBncm91cElkPXt0aGlzLnByb3BzLmdyb3VwSWR9IG1lbWJlcj17bX0gLz5cbiAgICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiA8VHJ1bmNhdGVkTGlzdFxuICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfTWVtYmVyTGlzdF93cmFwcGVyXCJcbiAgICAgICAgICAgIHRydW5jYXRlQXQ9e3RoaXMuc3RhdGUudHJ1bmNhdGVBdH1cbiAgICAgICAgICAgIGNyZWF0ZU92ZXJmbG93RWxlbWVudD17dGhpcy5fY3JlYXRlT3ZlcmZsb3dUaWxlfVxuICAgICAgICA+XG4gICAgICAgICAgICB7IG1lbWJlclRpbGVzIH1cbiAgICAgICAgPC9UcnVuY2F0ZWRMaXN0PjtcbiAgICB9XG5cbiAgICBvbkludml0ZVRvR3JvdXBCdXR0b25DbGljayA9ICgpID0+IHtcbiAgICAgICAgc2hvd0dyb3VwSW52aXRlRGlhbG9nKHRoaXMucHJvcHMuZ3JvdXBJZCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICBkaXMuZGlzcGF0Y2goe1xuICAgICAgICAgICAgICAgIGFjdGlvbjogQWN0aW9uLlNldFJpZ2h0UGFuZWxQaGFzZSxcbiAgICAgICAgICAgICAgICBwaGFzZTogUmlnaHRQYW5lbFBoYXNlcy5Hcm91cE1lbWJlckxpc3QsXG4gICAgICAgICAgICAgICAgcmVmaXJlUGFyYW1zOiB7IGdyb3VwSWQ6IHRoaXMucHJvcHMuZ3JvdXBJZCB9LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLmZldGNoaW5nIHx8IHRoaXMuc3RhdGUuZmV0Y2hpbmdJbnZpdGVkTWVtYmVycykge1xuICAgICAgICAgICAgY29uc3QgU3Bpbm5lciA9IHNkay5nZXRDb21wb25lbnQoXCJlbGVtZW50cy5TcGlubmVyXCIpO1xuICAgICAgICAgICAgcmV0dXJuICg8ZGl2IGNsYXNzTmFtZT1cIm14X01lbWJlckxpc3RcIj5cbiAgICAgICAgICAgICAgICA8U3Bpbm5lciAvPlxuICAgICAgICAgICAgPC9kaXY+KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGlucHV0Qm94ID0gKFxuICAgICAgICAgICAgPGlucHV0XG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfR3JvdXBNZW1iZXJMaXN0X3F1ZXJ5IG14X3RleHRpbnB1dFwiXG4gICAgICAgICAgICAgICAgaWQ9XCJteF9Hcm91cE1lbWJlckxpc3RfcXVlcnlcIlxuICAgICAgICAgICAgICAgIHR5cGU9XCJ0ZXh0XCJcbiAgICAgICAgICAgICAgICBvbkNoYW5nZT17dGhpcy5vblNlYXJjaFF1ZXJ5Q2hhbmdlZH1cbiAgICAgICAgICAgICAgICB2YWx1ZT17dGhpcy5zdGF0ZS5zZWFyY2hRdWVyeX1cbiAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcj17X3QoJ0ZpbHRlciBjb21tdW5pdHkgbWVtYmVycycpfVxuICAgICAgICAgICAgICAgIGF1dG9Db21wbGV0ZT1cIm9mZlwiXG4gICAgICAgICAgICAvPlxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IGpvaW5lZCA9IHRoaXMuc3RhdGUubWVtYmVycyA/IDxkaXYgY2xhc3NOYW1lPVwibXhfTWVtYmVyTGlzdF9qb2luZWRcIj5cbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICB0aGlzLm1ha2VHcm91cE1lbWJlclRpbGVzKFxuICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnNlYXJjaFF1ZXJ5LFxuICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLm1lbWJlcnMsXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUubWVtYmVyc0Vycm9yLFxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIH1cbiAgICAgICAgPC9kaXY+IDogPGRpdiAvPjtcblxuICAgICAgICBjb25zdCBpbnZpdGVkID0gKHRoaXMuc3RhdGUuaW52aXRlZE1lbWJlcnMgJiYgdGhpcy5zdGF0ZS5pbnZpdGVkTWVtYmVycy5sZW5ndGggPiAwKSA/XG4gICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X01lbWJlckxpc3RfaW52aXRlZFwiPlxuICAgICAgICAgICAgICAgIDxoMj57IF90KFwiSW52aXRlZFwiKSB9PC9oMj5cbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubWFrZUdyb3VwTWVtYmVyVGlsZXMoXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnNlYXJjaFF1ZXJ5LFxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS5pbnZpdGVkTWVtYmVycyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUuaW52aXRlZE1lbWJlcnNFcnJvcixcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIDwvZGl2PiA6IDxkaXYgLz47XG5cbiAgICAgICAgbGV0IGludml0ZUJ1dHRvbjtcbiAgICAgICAgaWYgKEdyb3VwU3RvcmUuaXNVc2VyUHJpdmlsZWdlZCh0aGlzLnByb3BzLmdyb3VwSWQpKSB7XG4gICAgICAgICAgICBpbnZpdGVCdXR0b24gPSAoXG4gICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b25cbiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfTWVtYmVyTGlzdF9pbnZpdGUgbXhfTWVtYmVyTGlzdF9pbnZpdGVDb21tdW5pdHlcIlxuICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLm9uSW52aXRlVG9Hcm91cEJ1dHRvbkNsaWNrfVxuICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICAgICAgPHNwYW4+eyBfdCgnSW52aXRlIHRvIHRoaXMgY29tbXVuaXR5JykgfTwvc3Bhbj5cbiAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfTWVtYmVyTGlzdFwiIHJvbGU9XCJ0YWJwYW5lbFwiPlxuICAgICAgICAgICAgICAgIHsgaW52aXRlQnV0dG9uIH1cbiAgICAgICAgICAgICAgICA8QXV0b0hpZGVTY3JvbGxiYXI+XG4gICAgICAgICAgICAgICAgICAgIHsgam9pbmVkIH1cbiAgICAgICAgICAgICAgICAgICAgeyBpbnZpdGVkIH1cbiAgICAgICAgICAgICAgICA8L0F1dG9IaWRlU2Nyb2xsYmFyPlxuICAgICAgICAgICAgICAgIHsgaW5wdXRCb3ggfVxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICk7XG4gICAgfVxufVxuIl19