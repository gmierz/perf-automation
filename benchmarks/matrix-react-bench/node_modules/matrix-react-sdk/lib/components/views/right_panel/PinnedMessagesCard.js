"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.useReadPinnedEvents = exports.usePinnedEvents = exports.default = exports.ReadPinsEventId = void 0;

var _react = _interopRequireWildcard(require("react"));

var _event = require("matrix-js-sdk/src/models/event");

var _event2 = require("matrix-js-sdk/src/@types/event");

var _languageHandler = require("../../../languageHandler");

var _BaseCard = _interopRequireDefault(require("./BaseCard"));

var _Spinner = _interopRequireDefault(require("../elements/Spinner"));

var _MatrixClientContext = _interopRequireDefault(require("../../../contexts/MatrixClientContext"));

var _useEventEmitter = require("../../../hooks/useEventEmitter");

var _PinningUtils = _interopRequireDefault(require("../../../utils/PinningUtils"));

var _useAsyncMemo = require("../../../hooks/useAsyncMemo");

var _PinnedEventTile = _interopRequireDefault(require("../rooms/PinnedEventTile"));

var _useRoomState = require("../../../hooks/useRoomState");

var _logger = require("matrix-js-sdk/src/logger");

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/*
Copyright 2021 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const usePinnedEvents = room => {
  const [pinnedEvents, setPinnedEvents] = (0, _react.useState)([]);
  const update = (0, _react.useCallback)(ev => {
    var _room$currentState$ge, _room$currentState$ge2;

    if (!room) return;
    if (ev && ev.getType() !== _event2.EventType.RoomPinnedEvents) return;
    setPinnedEvents(((_room$currentState$ge = room.currentState.getStateEvents(_event2.EventType.RoomPinnedEvents, "")) === null || _room$currentState$ge === void 0 ? void 0 : (_room$currentState$ge2 = _room$currentState$ge.getContent()) === null || _room$currentState$ge2 === void 0 ? void 0 : _room$currentState$ge2.pinned) || []);
  }, [room]);
  (0, _useEventEmitter.useEventEmitter)(room === null || room === void 0 ? void 0 : room.currentState, "RoomState.events", update);
  (0, _react.useEffect)(() => {
    update();
    return () => {
      setPinnedEvents([]);
    };
  }, [update]);
  return pinnedEvents;
};

exports.usePinnedEvents = usePinnedEvents;
const ReadPinsEventId = "im.vector.room.read_pins";
exports.ReadPinsEventId = ReadPinsEventId;

const useReadPinnedEvents = room => {
  const [readPinnedEvents, setReadPinnedEvents] = (0, _react.useState)(new Set());
  const update = (0, _react.useCallback)(ev => {
    var _room$getAccountData, _room$getAccountData$;

    if (!room) return;
    if (ev && ev.getType() !== ReadPinsEventId) return;
    const readPins = (_room$getAccountData = room.getAccountData(ReadPinsEventId)) === null || _room$getAccountData === void 0 ? void 0 : (_room$getAccountData$ = _room$getAccountData.getContent()) === null || _room$getAccountData$ === void 0 ? void 0 : _room$getAccountData$.event_ids;
    setReadPinnedEvents(new Set(readPins || []));
  }, [room]);
  (0, _useEventEmitter.useEventEmitter)(room, "Room.accountData", update);
  (0, _react.useEffect)(() => {
    update();
    return () => {
      setReadPinnedEvents(new Set());
    };
  }, [update]);
  return readPinnedEvents;
};

exports.useReadPinnedEvents = useReadPinnedEvents;

const PinnedMessagesCard = ({
  room,
  onClose
}) => {
  const cli = (0, _react.useContext)(_MatrixClientContext.default);
  const canUnpin = (0, _useRoomState.useRoomState)(room, state => state.mayClientSendStateEvent(_event2.EventType.RoomPinnedEvents, cli));
  const pinnedEventIds = usePinnedEvents(room);
  const readPinnedEvents = useReadPinnedEvents(room);
  (0, _react.useEffect)(() => {
    const newlyRead = pinnedEventIds.filter(id => !readPinnedEvents.has(id));

    if (newlyRead.length > 0) {
      // clear out any read pinned events which no longer are pinned
      cli.setRoomAccountData(room.roomId, ReadPinsEventId, {
        event_ids: pinnedEventIds
      });
    }
  }, [cli, room.roomId, pinnedEventIds, readPinnedEvents]);
  const pinnedEvents = (0, _useAsyncMemo.useAsyncMemo)(() => {
    const promises = pinnedEventIds.map(async eventId => {
      var _timelineSet$getTimel;

      const timelineSet = room.getUnfilteredTimelineSet();
      const localEvent = timelineSet === null || timelineSet === void 0 ? void 0 : (_timelineSet$getTimel = timelineSet.getTimelineForEvent(eventId)) === null || _timelineSet$getTimel === void 0 ? void 0 : _timelineSet$getTimel.getEvents().find(e => e.getId() === eventId);
      if (localEvent) return localEvent;

      try {
        const evJson = await cli.fetchRoomEvent(room.roomId, eventId);
        const event = new _event.MatrixEvent(evJson);

        if (event.isEncrypted()) {
          await cli.decryptEventIfNeeded(event); // TODO await?
        }

        if (event && _PinningUtils.default.isPinnable(event)) {
          return event;
        }
      } catch (err) {
        _logger.logger.error("Error looking up pinned event " + eventId + " in room " + room.roomId);

        _logger.logger.error(err);
      }

      return null;
    });
    return Promise.all(promises);
  }, [cli, room, pinnedEventIds], null);
  let content;

  if (!pinnedEvents) {
    content = /*#__PURE__*/_react.default.createElement(_Spinner.default, null);
  } else if (pinnedEvents.length > 0) {
    const onUnpinClicked = async event => {
      var _pinnedEvents$getCont;

      const pinnedEvents = room.currentState.getStateEvents(_event2.EventType.RoomPinnedEvents, "");

      if (pinnedEvents !== null && pinnedEvents !== void 0 && (_pinnedEvents$getCont = pinnedEvents.getContent()) !== null && _pinnedEvents$getCont !== void 0 && _pinnedEvents$getCont.pinned) {
        const pinned = pinnedEvents.getContent().pinned;
        const index = pinned.indexOf(event.getId());

        if (index !== -1) {
          pinned.splice(index, 1);
          await cli.sendStateEvent(room.roomId, _event2.EventType.RoomPinnedEvents, {
            pinned
          }, "");
        }
      }
    }; // show them in reverse, with latest pinned at the top


    content = pinnedEvents.filter(Boolean).reverse().map(ev => /*#__PURE__*/_react.default.createElement(_PinnedEventTile.default, {
      key: ev.getId(),
      room: room,
      event: ev,
      onUnpinClicked: canUnpin ? () => onUnpinClicked(ev) : undefined
    }));
  } else {
    content = /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_PinnedMessagesCard_empty"
    }, /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_PinnedMessagesCard_MessageActionBar"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_MessageActionBar_maskButton mx_MessageActionBar_reactButton"
    }), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_MessageActionBar_maskButton mx_MessageActionBar_replyButton"
    }), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_MessageActionBar_maskButton mx_MessageActionBar_optionsButton"
    })), /*#__PURE__*/_react.default.createElement("h2", null, (0, _languageHandler._t)("Nothing pinned, yet")), (0, _languageHandler._t)("If you have permissions, open the menu on any message and select " + "<b>Pin</b> to stick them here.", {}, {
      b: sub => /*#__PURE__*/_react.default.createElement("b", null, sub)
    })));
  }

  return /*#__PURE__*/_react.default.createElement(_BaseCard.default, {
    header: /*#__PURE__*/_react.default.createElement("h2", null, (0, _languageHandler._t)("Pinned messages")),
    className: "mx_PinnedMessagesCard",
    onClose: onClose
  }, content);
};

var _default = PinnedMessagesCard;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3JpZ2h0X3BhbmVsL1Bpbm5lZE1lc3NhZ2VzQ2FyZC50c3giXSwibmFtZXMiOlsidXNlUGlubmVkRXZlbnRzIiwicm9vbSIsInBpbm5lZEV2ZW50cyIsInNldFBpbm5lZEV2ZW50cyIsInVwZGF0ZSIsImV2IiwiZ2V0VHlwZSIsIkV2ZW50VHlwZSIsIlJvb21QaW5uZWRFdmVudHMiLCJjdXJyZW50U3RhdGUiLCJnZXRTdGF0ZUV2ZW50cyIsImdldENvbnRlbnQiLCJwaW5uZWQiLCJSZWFkUGluc0V2ZW50SWQiLCJ1c2VSZWFkUGlubmVkRXZlbnRzIiwicmVhZFBpbm5lZEV2ZW50cyIsInNldFJlYWRQaW5uZWRFdmVudHMiLCJTZXQiLCJyZWFkUGlucyIsImdldEFjY291bnREYXRhIiwiZXZlbnRfaWRzIiwiUGlubmVkTWVzc2FnZXNDYXJkIiwib25DbG9zZSIsImNsaSIsIk1hdHJpeENsaWVudENvbnRleHQiLCJjYW5VbnBpbiIsInN0YXRlIiwibWF5Q2xpZW50U2VuZFN0YXRlRXZlbnQiLCJwaW5uZWRFdmVudElkcyIsIm5ld2x5UmVhZCIsImZpbHRlciIsImlkIiwiaGFzIiwibGVuZ3RoIiwic2V0Um9vbUFjY291bnREYXRhIiwicm9vbUlkIiwicHJvbWlzZXMiLCJtYXAiLCJldmVudElkIiwidGltZWxpbmVTZXQiLCJnZXRVbmZpbHRlcmVkVGltZWxpbmVTZXQiLCJsb2NhbEV2ZW50IiwiZ2V0VGltZWxpbmVGb3JFdmVudCIsImdldEV2ZW50cyIsImZpbmQiLCJlIiwiZ2V0SWQiLCJldkpzb24iLCJmZXRjaFJvb21FdmVudCIsImV2ZW50IiwiTWF0cml4RXZlbnQiLCJpc0VuY3J5cHRlZCIsImRlY3J5cHRFdmVudElmTmVlZGVkIiwiUGlubmluZ1V0aWxzIiwiaXNQaW5uYWJsZSIsImVyciIsImxvZ2dlciIsImVycm9yIiwiUHJvbWlzZSIsImFsbCIsImNvbnRlbnQiLCJvblVucGluQ2xpY2tlZCIsImluZGV4IiwiaW5kZXhPZiIsInNwbGljZSIsInNlbmRTdGF0ZUV2ZW50IiwiQm9vbGVhbiIsInJldmVyc2UiLCJ1bmRlZmluZWQiLCJiIiwic3ViIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFnQkE7O0FBRUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7Ozs7OztBQS9CQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUF3Qk8sTUFBTUEsZUFBZSxHQUFJQyxJQUFELElBQTBCO0FBQ3JELFFBQU0sQ0FBQ0MsWUFBRCxFQUFlQyxlQUFmLElBQWtDLHFCQUFtQixFQUFuQixDQUF4QztBQUVBLFFBQU1DLE1BQU0sR0FBRyx3QkFBYUMsRUFBRCxJQUFzQjtBQUFBOztBQUM3QyxRQUFJLENBQUNKLElBQUwsRUFBVztBQUNYLFFBQUlJLEVBQUUsSUFBSUEsRUFBRSxDQUFDQyxPQUFILE9BQWlCQyxrQkFBVUMsZ0JBQXJDLEVBQXVEO0FBQ3ZETCxJQUFBQSxlQUFlLENBQUMsMEJBQUFGLElBQUksQ0FBQ1EsWUFBTCxDQUFrQkMsY0FBbEIsQ0FBaUNILGtCQUFVQyxnQkFBM0MsRUFBNkQsRUFBN0QsMkdBQWtFRyxVQUFsRSxvRkFBZ0ZDLE1BQWhGLEtBQTBGLEVBQTNGLENBQWY7QUFDSCxHQUpjLEVBSVosQ0FBQ1gsSUFBRCxDQUpZLENBQWY7QUFNQSx3Q0FBZ0JBLElBQWhCLGFBQWdCQSxJQUFoQix1QkFBZ0JBLElBQUksQ0FBRVEsWUFBdEIsRUFBb0Msa0JBQXBDLEVBQXdETCxNQUF4RDtBQUNBLHdCQUFVLE1BQU07QUFDWkEsSUFBQUEsTUFBTTtBQUNOLFdBQU8sTUFBTTtBQUNURCxNQUFBQSxlQUFlLENBQUMsRUFBRCxDQUFmO0FBQ0gsS0FGRDtBQUdILEdBTEQsRUFLRyxDQUFDQyxNQUFELENBTEg7QUFNQSxTQUFPRixZQUFQO0FBQ0gsQ0Fq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QUFLLE1BQUEsU0FBUyxFQUFDO0FBQWYsTUFISixDQUZKLGVBUUkseUNBQU0seUJBQUcscUJBQUgsQ0FBTixDQVJKLEVBU00seUJBQUcsc0VBQ0QsZ0NBREYsRUFDb0MsRUFEcEMsRUFDd0M7QUFDdENTLE1BQUFBLENBQUMsRUFBRUMsR0FBRyxpQkFBSSx3Q0FBS0EsR0FBTDtBQUQ0QixLQUR4QyxDQVROLENBRE0sQ0FBVjtBQWdCSDs7QUFFRCxzQkFBTyw2QkFBQyxpQkFBRDtBQUNILElBQUEsTUFBTSxlQUFFLHlDQUFNLHlCQUFHLGlCQUFILENBQU4sQ0FETDtBQUVILElBQUEsU0FBUyxFQUFDLHVCQUZQO0FBR0gsSUFBQSxPQUFPLEVBQUVoRDtBQUhOLEtBS0RzQyxPQUxDLENBQVA7QUFPSCxDQTVGRDs7ZUE4RmV2QyxrQiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAyMSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCwgeyB1c2VDYWxsYmFjaywgdXNlQ29udGV4dCwgdXNlRWZmZWN0LCB1c2VTdGF0ZSB9IGZyb20gXCJyZWFjdFwiO1xuaW1wb3J0IHsgUm9vbSB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvcm9vbVwiO1xuaW1wb3J0IHsgTWF0cml4RXZlbnQgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL2V2ZW50XCI7XG5pbXBvcnQgeyBFdmVudFR5cGUgfSBmcm9tICdtYXRyaXgtanMtc2RrL3NyYy9AdHlwZXMvZXZlbnQnO1xuXG5pbXBvcnQgeyBfdCB9IGZyb20gXCIuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXJcIjtcbmltcG9ydCBCYXNlQ2FyZCBmcm9tIFwiLi9CYXNlQ2FyZFwiO1xuaW1wb3J0IFNwaW5uZXIgZnJvbSBcIi4uL2VsZW1lbnRzL1NwaW5uZXJcIjtcbmltcG9ydCBNYXRyaXhDbGllbnRDb250ZXh0IGZyb20gXCIuLi8uLi8uLi9jb250ZXh0cy9NYXRyaXhDbGllbnRDb250ZXh0XCI7XG5pbXBvcnQgeyB1c2VFdmVudEVtaXR0ZXIgfSBmcm9tIFwiLi4vLi4vLi4vaG9va3MvdXNlRXZlbnRFbWl0dGVyXCI7XG5pbXBvcnQgUGlubmluZ1V0aWxzIGZyb20gXCIuLi8uLi8uLi91dGlscy9QaW5uaW5nVXRpbHNcIjtcbmltcG9ydCB7IHVzZUFzeW5jTWVtbyB9IGZyb20gXCIuLi8uLi8uLi9ob29rcy91c2VBc3luY01lbW9cIjtcbmltcG9ydCBQaW5uZWRFdmVudFRpbGUgZnJvbSBcIi4uL3Jvb21zL1Bpbm5lZEV2ZW50VGlsZVwiO1xuaW1wb3J0IHsgdXNlUm9vbVN0YXRlIH0gZnJvbSBcIi4uLy4uLy4uL2hvb2tzL3VzZVJvb21TdGF0ZVwiO1xuXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbG9nZ2VyXCI7XG5cbmludGVyZmFjZSBJUHJvcHMge1xuICAgIHJvb206IFJvb207XG4gICAgb25DbG9zZSgpOiB2b2lkO1xufVxuXG5leHBvcnQgY29uc3QgdXNlUGlubmVkRXZlbnRzID0gKHJvb206IFJvb20pOiBzdHJpbmdbXSA9PiB7XG4gICAgY29uc3QgW3Bpbm5lZEV2ZW50cywgc2V0UGlubmVkRXZlbnRzXSA9IHVzZVN0YXRlPHN0cmluZ1tdPihbXSk7XG5cbiAgICBjb25zdCB1cGRhdGUgPSB1c2VDYWxsYmFjaygoZXY/OiBNYXRyaXhFdmVudCkgPT4ge1xuICAgICAgICBpZiAoIXJvb20pIHJldHVybjtcbiAgICAgICAgaWYgKGV2ICYmIGV2LmdldFR5cGUoKSAhPT0gRXZlbnRUeXBlLlJvb21QaW5uZWRFdmVudHMpIHJldHVybjtcbiAgICAgICAgc2V0UGlubmVkRXZlbnRzKHJvb20uY3VycmVudFN0YXRlLmdldFN0YXRlRXZlbnRzKEV2ZW50VHlwZS5Sb29tUGlubmVkRXZlbnRzLCBcIlwiKT8uZ2V0Q29udGVudCgpPy5waW5uZWQgfHwgW10pO1xuICAgIH0sIFtyb29tXSk7XG5cbiAgICB1c2VFdmVudEVtaXR0ZXIocm9vbT8uY3VycmVudFN0YXRlLCBcIlJvb21TdGF0ZS5ldmVudHNcIiwgdXBkYXRlKTtcbiAgICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgICAgICB1cGRhdGUoKTtcbiAgICAgICAgcmV0dXJuICgpID0+IHtcbiAgICAgICAgICAgIHNldFBpbm5lZEV2ZW50cyhbXSk7XG4gICAgICAgIH07XG4gICAgfSwgW3VwZGF0ZV0pO1xuICAgIHJldHVybiBwaW5uZWRFdmVudHM7XG59O1xuXG5leHBvcnQgY29uc3QgUmVhZFBpbnNFdmVudElkID0gXCJpbS52ZWN0b3Iucm9vbS5yZWFkX3BpbnNcIjtcblxuZXhwb3J0IGNvbnN0IHVzZVJlYWRQaW5uZWRFdmVudHMgPSAocm9vbTogUm9vbSk6IFNldDxzdHJpbmc+ID0+IHtcbiAgICBjb25zdCBbcmVhZFBpbm5lZEV2ZW50cywgc2V0UmVhZFBpbm5lZEV2ZW50c10gPSB1c2VTdGF0ZTxTZXQ8c3RyaW5nPj4obmV3IFNldCgpKTtcblxuICAgIGNvbnN0IHVwZGF0ZSA9IHVzZUNhbGxiYWNrKChldj86IE1hdHJpeEV2ZW50KSA9PiB7XG4gICAgICAgIGlmICghcm9vbSkgcmV0dXJuO1xuICAgICAgICBpZiAoZXYgJiYgZXYuZ2V0VHlwZSgpICE9PSBSZWFkUGluc0V2ZW50SWQpIHJldHVybjtcbiAgICAgICAgY29uc3QgcmVhZFBpbnMgPSByb29tLmdldEFjY291bnREYXRhKFJlYWRQaW5zRXZlbnRJZCk/LmdldENvbnRlbnQoKT8uZXZlbnRfaWRzO1xuICAgICAgICBzZXRSZWFkUGlubmVkRXZlbnRzKG5ldyBTZXQocmVhZFBpbnMgfHwgW10pKTtcbiAgICB9LCBbcm9vbV0pO1xuXG4gICAgdXNlRXZlbnRFbWl0dGVyKHJvb20sIFwiUm9vbS5hY2NvdW50RGF0YVwiLCB1cGRhdGUpO1xuICAgIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgICAgIHVwZGF0ZSgpO1xuICAgICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICAgICAgc2V0UmVhZFBpbm5lZEV2ZW50cyhuZXcgU2V0KCkpO1xuICAgICAgICB9O1xuICAgIH0sIFt1cGRhdGVdKTtcbiAgICByZXR1cm4gcmVhZFBpbm5lZEV2ZW50cztcbn07XG5cbmNvbnN0IFBpbm5lZE1lc3NhZ2VzQ2FyZCA9ICh7IHJvb20sIG9uQ2xvc2UgfTogSVByb3BzKSA9PiB7XG4gICAgY29uc3QgY2xpID0gdXNlQ29udGV4dChNYXRyaXhDbGllbnRDb250ZXh0KTtcbiAgICBjb25zdCBjYW5VbnBpbiA9IHVzZVJvb21TdGF0ZShyb29tLCBzdGF0ZSA9PiBzdGF0ZS5tYXlDbGllbnRTZW5kU3RhdGVFdmVudChFdmVudFR5cGUuUm9vbVBpbm5lZEV2ZW50cywgY2xpKSk7XG4gICAgY29uc3QgcGlubmVkRXZlbnRJZHMgPSB1c2VQaW5uZWRFdmVudHMocm9vbSk7XG4gICAgY29uc3QgcmVhZFBpbm5lZEV2ZW50cyA9IHVzZVJlYWRQaW5uZWRFdmVudHMocm9vbSk7XG5cbiAgICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgICAgICBjb25zdCBuZXdseVJlYWQgPSBwaW5uZWRFdmVudElkcy5maWx0ZXIoaWQgPT4gIXJlYWRQaW5uZWRFdmVudHMuaGFzKGlkKSk7XG4gICAgICAgIGlmIChuZXdseVJlYWQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgLy8gY2xlYXIgb3V0IGFueSByZWFkIHBpbm5lZCBldmVudHMgd2hpY2ggbm8gbG9uZ2VyIGFyZSBwaW5uZWRcbiAgICAgICAgICAgIGNsaS5zZXRSb29tQWNjb3VudERhdGEocm9vbS5yb29tSWQsIFJlYWRQaW5zRXZlbnRJZCwge1xuICAgICAgICAgICAgICAgIGV2ZW50X2lkczogcGlubmVkRXZlbnRJZHMsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH0sIFtjbGksIHJvb20ucm9vbUlkLCBwaW5uZWRFdmVudElkcywgcmVhZFBpbm5lZEV2ZW50c10pO1xuXG4gICAgY29uc3QgcGlubmVkRXZlbnRzID0gdXNlQXN5bmNNZW1vKCgpID0+IHtcbiAgICAgICAgY29uc3QgcHJvbWlzZXMgPSBwaW5uZWRFdmVudElkcy5tYXAoYXN5bmMgZXZlbnRJZCA9PiB7XG4gICAgICAgICAgICBjb25zdCB0aW1lbGluZVNldCA9IHJvb20uZ2V0VW5maWx0ZXJlZFRpbWVsaW5lU2V0KCk7XG4gICAgICAgICAgICBjb25zdCBsb2NhbEV2ZW50ID0gdGltZWxpbmVTZXQ/LmdldFRpbWVsaW5lRm9yRXZlbnQoZXZlbnRJZCk/LmdldEV2ZW50cygpLmZpbmQoZSA9PiBlLmdldElkKCkgPT09IGV2ZW50SWQpO1xuICAgICAgICAgICAgaWYgKGxvY2FsRXZlbnQpIHJldHVybiBsb2NhbEV2ZW50O1xuXG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGV2SnNvbiA9IGF3YWl0IGNsaS5mZXRjaFJvb21FdmVudChyb29tLnJvb21JZCwgZXZlbnRJZCk7XG4gICAgICAgICAgICAgICAgY29uc3QgZXZlbnQgPSBuZXcgTWF0cml4RXZlbnQoZXZKc29uKTtcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQuaXNFbmNyeXB0ZWQoKSkge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBjbGkuZGVjcnlwdEV2ZW50SWZOZWVkZWQoZXZlbnQpOyAvLyBUT0RPIGF3YWl0P1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQgJiYgUGlubmluZ1V0aWxzLmlzUGlubmFibGUoZXZlbnQpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBldmVudDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoXCJFcnJvciBsb29raW5nIHVwIHBpbm5lZCBldmVudCBcIiArIGV2ZW50SWQgKyBcIiBpbiByb29tIFwiICsgcm9vbS5yb29tSWQpO1xuICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihlcnIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChwcm9taXNlcyk7XG4gICAgfSwgW2NsaSwgcm9vbSwgcGlubmVkRXZlbnRJZHNdLCBudWxsKTtcblxuICAgIGxldCBjb250ZW50O1xuICAgIGlmICghcGlubmVkRXZlbnRzKSB7XG4gICAgICAgIGNvbnRlbnQgPSA8U3Bpbm5lciAvPjtcbiAgICB9IGVsc2UgaWYgKHBpbm5lZEV2ZW50cy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbnN0IG9uVW5waW5DbGlja2VkID0gYXN5bmMgKGV2ZW50OiBNYXRyaXhFdmVudCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcGlubmVkRXZlbnRzID0gcm9vbS5jdXJyZW50U3RhdGUuZ2V0U3RhdGVFdmVudHMoRXZlbnRUeXBlLlJvb21QaW5uZWRFdmVudHMsIFwiXCIpO1xuICAgICAgICAgICAgaWYgKHBpbm5lZEV2ZW50cz8uZ2V0Q29udGVudCgpPy5waW5uZWQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBwaW5uZWQgPSBwaW5uZWRFdmVudHMuZ2V0Q29udGVudCgpLnBpbm5lZDtcbiAgICAgICAgICAgICAgICBjb25zdCBpbmRleCA9IHBpbm5lZC5pbmRleE9mKGV2ZW50LmdldElkKCkpO1xuICAgICAgICAgICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgcGlubmVkLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGNsaS5zZW5kU3RhdGVFdmVudChyb29tLnJvb21JZCwgRXZlbnRUeXBlLlJvb21QaW5uZWRFdmVudHMsIHsgcGlubmVkIH0sIFwiXCIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICAvLyBzaG93IHRoZW0gaW4gcmV2ZXJzZSwgd2l0aCBsYXRlc3QgcGlubmVkIGF0IHRoZSB0b3BcbiAgICAgICAgY29udGVudCA9IHBpbm5lZEV2ZW50cy5maWx0ZXIoQm9vbGVhbikucmV2ZXJzZSgpLm1hcChldiA9PiAoXG4gICAgICAgICAgICA8UGlubmVkRXZlbnRUaWxlXG4gICAgICAgICAgICAgICAga2V5PXtldi5nZXRJZCgpfVxuICAgICAgICAgICAgICAgIHJvb209e3Jvb219XG4gICAgICAgICAgICAgICAgZXZlbnQ9e2V2fVxuICAgICAgICAgICAgICAgIG9uVW5waW5DbGlja2VkPXtjYW5VbnBpbiA/ICgpID0+IG9uVW5waW5DbGlja2VkKGV2KSA6IHVuZGVmaW5lZH1cbiAgICAgICAgICAgIC8+XG4gICAgICAgICkpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnRlbnQgPSA8ZGl2IGNsYXNzTmFtZT1cIm14X1Bpbm5lZE1lc3NhZ2VzQ2FyZF9lbXB0eVwiPlxuICAgICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgICAgICB7IC8qIFhYWDogV2UgcmV1c2UgdGhlIGNsYXNzZXMgZm9yIHNpbXBsaWNpdHksIGJ1dCBkZWxpYmVyYXRlbHkgbm90IHRoZSBjb21wb25lbnRzIGZvciBub24taW50ZXJhY3Rpdml0eS4gKi8gfVxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfUGlubmVkTWVzc2FnZXNDYXJkX01lc3NhZ2VBY3Rpb25CYXJcIj5cbiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9NZXNzYWdlQWN0aW9uQmFyX21hc2tCdXR0b24gbXhfTWVzc2FnZUFjdGlvbkJhcl9yZWFjdEJ1dHRvblwiIC8+XG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfTWVzc2FnZUFjdGlvbkJhcl9tYXNrQnV0dG9uIG14X01lc3NhZ2VBY3Rpb25CYXJfcmVwbHlCdXR0b25cIiAvPlxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X01lc3NhZ2VBY3Rpb25CYXJfbWFza0J1dHRvbiBteF9NZXNzYWdlQWN0aW9uQmFyX29wdGlvbnNCdXR0b25cIiAvPlxuICAgICAgICAgICAgICAgIDwvZGl2PlxuXG4gICAgICAgICAgICAgICAgPGgyPnsgX3QoXCJOb3RoaW5nIHBpbm5lZCwgeWV0XCIpIH08L2gyPlxuICAgICAgICAgICAgICAgIHsgX3QoXCJJZiB5b3UgaGF2ZSBwZXJtaXNzaW9ucywgb3BlbiB0aGUgbWVudSBvbiBhbnkgbWVzc2FnZSBhbmQgc2VsZWN0IFwiICtcbiAgICAgICAgICAgICAgICAgICAgXCI8Yj5QaW48L2I+IHRvIHN0aWNrIHRoZW0gaGVyZS5cIiwge30sIHtcbiAgICAgICAgICAgICAgICAgICAgYjogc3ViID0+IDxiPnsgc3ViIH08L2I+LFxuICAgICAgICAgICAgICAgIH0pIH1cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICA8L2Rpdj47XG4gICAgfVxuXG4gICAgcmV0dXJuIDxCYXNlQ2FyZFxuICAgICAgICBoZWFkZXI9ezxoMj57IF90KFwiUGlubmVkIG1lc3NhZ2VzXCIpIH08L2gyPn1cbiAgICAgICAgY2xhc3NOYW1lPVwibXhfUGlubmVkTWVzc2FnZXNDYXJkXCJcbiAgICAgICAgb25DbG9zZT17b25DbG9zZX1cbiAgICA+XG4gICAgICAgIHsgY29udGVudCB9XG4gICAgPC9CYXNlQ2FyZD47XG59O1xuXG5leHBvcnQgZGVmYXVsdCBQaW5uZWRNZXNzYWdlc0NhcmQ7XG4iXX0=