"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _languageHandler = require("../../../languageHandler");

var _HeaderButton = _interopRequireDefault(require("./HeaderButton"));

var _HeaderButtons = _interopRequireWildcard(require("./HeaderButtons"));

var _RightPanelStorePhases = require("../../../stores/RightPanelStorePhases");

var _actions = require("../../../dispatcher/actions");

var _RightPanelStore = _interopRequireDefault(require("../../../stores/RightPanelStore"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _useSettings = require("../../../hooks/useSettings");

var _PinnedMessagesCard = require("./PinnedMessagesCard");

var _threads = require("../../../dispatcher/dispatch-actions/threads");

var _SettingsStore = _interopRequireDefault(require("../../../settings/SettingsStore"));

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var _RoomNotificationStateStore = require("../../../stores/notifications/RoomNotificationStateStore");

var _NotificationColor = require("../../../stores/notifications/NotificationColor");

var _dec, _class, _class2, _temp;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

const ROOM_INFO_PHASES = [_RightPanelStorePhases.RightPanelPhases.RoomSummary, _RightPanelStorePhases.RightPanelPhases.Widget, _RightPanelStorePhases.RightPanelPhases.FilePanel, _RightPanelStorePhases.RightPanelPhases.RoomMemberList, _RightPanelStorePhases.RightPanelPhases.RoomMemberInfo, _RightPanelStorePhases.RightPanelPhases.EncryptionPanel, _RightPanelStorePhases.RightPanelPhases.Room3pidMemberInfo];

const UnreadIndicator = ({
  className
}) => {
  return /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement("div", {
    className: "mx_RightPanel_headerButton_unreadIndicator_bg"
  }), /*#__PURE__*/_react.default.createElement("div", {
    className: className
  }));
};

const PinnedMessagesHeaderButton = ({
  room,
  isHighlighted,
  onClick
}) => {
  const pinningEnabled = (0, _useSettings.useSettingValue)("feature_pinning");
  const pinnedEvents = (0, _PinnedMessagesCard.usePinnedEvents)(pinningEnabled && room);
  const readPinnedEvents = (0, _PinnedMessagesCard.useReadPinnedEvents)(pinningEnabled && room);
  if (!pinningEnabled) return null;
  let unreadIndicator;

  if (pinnedEvents.some(id => !readPinnedEvents.has(id))) {
    unreadIndicator = /*#__PURE__*/_react.default.createElement(UnreadIndicator, {
      className: "mx_RightPanel_headerButton_unreadIndicator"
    });
  }

  return /*#__PURE__*/_react.default.createElement(_HeaderButton.default, {
    name: "pinnedMessagesButton",
    title: (0, _languageHandler._t)("Pinned messages"),
    isHighlighted: isHighlighted,
    onClick: onClick,
    analytics: ["Right Panel", "Pinned Messages Button", "click"]
  }, unreadIndicator);
};

const TimelineCardHeaderButton = ({
  room,
  isHighlighted,
  onClick
}) => {
  if (!_SettingsStore.default.getValue("feature_maximised_widgets")) return null;
  let unreadIndicator;

  switch (_RoomNotificationStateStore.RoomNotificationStateStore.instance.getRoomState(room).color) {
    case _NotificationColor.NotificationColor.Grey:
      unreadIndicator = /*#__PURE__*/_react.default.createElement(UnreadIndicator, {
        className: "mx_RightPanel_headerButton_unreadIndicator mx_Indicator_gray"
      });
      break;

    case _NotificationColor.NotificationColor.Red:
      unreadIndicator = /*#__PURE__*/_react.default.createElement(UnreadIndicator, {
        className: "mx_RightPanel_headerButton_unreadIndicator"
      });
      break;

    default:
      break;
  }

  return /*#__PURE__*/_react.default.createElement(_HeaderButton.default, {
    name: "timelineCardButton",
    title: (0, _languageHandler._t)("Chat"),
    isHighlighted: isHighlighted,
    onClick: onClick,
    analytics: ["Right Panel", "Timeline Panel Button", "click"]
  }, unreadIndicator);
};

let RoomHeaderButtons = (_dec = (0, _replaceableComponent.replaceableComponent)("views.right_panel.RoomHeaderButtons"), _dec(_class = (_temp = _class2 = class RoomHeaderButtons extends _HeaderButtons.default {
  constructor(props) {
    super(props, _HeaderButtons.HeaderKind.Room);
    (0, _defineProperty2.default)(this, "onRoomSummaryClicked", () => {
      // use roomPanelPhase rather than this.state.phase as it remembers the latest one if we close
      const lastPhase = _RightPanelStore.default.getSharedInstance().roomPanelPhase;

      if (ROOM_INFO_PHASES.includes(lastPhase)) {
        if (this.state.phase === lastPhase) {
          this.setPhase(lastPhase);
        } else {
          this.setPhase(lastPhase, _RightPanelStore.default.getSharedInstance().roomPanelPhaseParams);
        }
      } else {
        // This toggles for us, if needed
        this.setPhase(_RightPanelStorePhases.RightPanelPhases.RoomSummary);
      }
    });
    (0, _defineProperty2.default)(this, "onNotificationsClicked", () => {
      // This toggles for us, if needed
      this.setPhase(_RightPanelStorePhases.RightPanelPhases.NotificationPanel);
    });
    (0, _defineProperty2.default)(this, "onPinnedMessagesClicked", () => {
      // This toggles for us, if needed
      this.setPhase(_RightPanelStorePhases.RightPanelPhases.PinnedMessages);
    });
    (0, _defineProperty2.default)(this, "onTimelineCardClicked", () => {
      this.setPhase(_RightPanelStorePhases.RightPanelPhases.Timeline);
    });
    (0, _defineProperty2.default)(this, "onThreadsPanelClicked", () => {
      if (RoomHeaderButtons.THREAD_PHASES.includes(this.state.phase)) {
        _dispatcher.default.dispatch({
          action: _actions.Action.ToggleRightPanel,
          type: "room"
        });
      } else {
        (0, _threads.dispatchShowThreadsPanelEvent)();
      }
    });
  }

  onAction(payload) {
    if (payload.action === _actions.Action.ViewUser) {
      if (payload.member) {
        this.setPhase(_RightPanelStorePhases.RightPanelPhases.RoomMemberInfo, {
          member: payload.member
        });
      } else {
        this.setPhase(_RightPanelStorePhases.RightPanelPhases.RoomMemberList);
      }
    } else if (payload.action === "view_3pid_invite") {
      if (payload.event) {
        this.setPhase(_RightPanelStorePhases.RightPanelPhases.Room3pidMemberInfo, {
          event: payload.event
        });
      } else {
        this.setPhase(_RightPanelStorePhases.RightPanelPhases.RoomMemberList);
      }
    }
  }

  renderButtons() {
    const rightPanelPhaseButtons = new Map();
    rightPanelPhaseButtons.set(_RightPanelStorePhases.RightPanelPhases.PinnedMessages, /*#__PURE__*/_react.default.createElement(PinnedMessagesHeaderButton, {
      room: this.props.room,
      isHighlighted: this.isPhase(_RightPanelStorePhases.RightPanelPhases.PinnedMessages),
      onClick: this.onPinnedMessagesClicked
    }));
    rightPanelPhaseButtons.set(_RightPanelStorePhases.RightPanelPhases.Timeline, /*#__PURE__*/_react.default.createElement(TimelineCardHeaderButton, {
      room: this.props.room,
      isHighlighted: this.isPhase(_RightPanelStorePhases.RightPanelPhases.Timeline),
      onClick: this.onTimelineCardClicked
    }));
    rightPanelPhaseButtons.set(_RightPanelStorePhases.RightPanelPhases.ThreadPanel, _SettingsStore.default.getValue("feature_thread") ? /*#__PURE__*/_react.default.createElement(_HeaderButton.default, {
      name: "threadsButton",
      title: (0, _languageHandler._t)("Threads"),
      onClick: this.onThreadsPanelClicked,
      isHighlighted: this.isPhase(RoomHeaderButtons.THREAD_PHASES),
      analytics: ['Right Panel', 'Threads List Button', 'click']
    }) : null);
    rightPanelPhaseButtons.set(_RightPanelStorePhases.RightPanelPhases.NotificationPanel, /*#__PURE__*/_react.default.createElement(_HeaderButton.default, {
      name: "notifsButton",
      title: (0, _languageHandler._t)('Notifications'),
      isHighlighted: this.isPhase(_RightPanelStorePhases.RightPanelPhases.NotificationPanel),
      onClick: this.onNotificationsClicked,
      analytics: ['Right Panel', 'Notification List Button', 'click']
    }));
    rightPanelPhaseButtons.set(_RightPanelStorePhases.RightPanelPhases.RoomSummary, /*#__PURE__*/_react.default.createElement(_HeaderButton.default, {
      name: "roomSummaryButton",
      title: (0, _languageHandler._t)('Room Info'),
      isHighlighted: this.isPhase(ROOM_INFO_PHASES),
      onClick: this.onRoomSummaryClicked,
      analytics: ['Right Panel', 'Room Summary Button', 'click']
    }));
    return /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, Array.from(rightPanelPhaseButtons.keys()).map(phase => this.props.excludedRightPanelPhaseButtons.includes(phase) ? null : rightPanelPhaseButtons.get(phase)));
  }

}, (0, _defineProperty2.default)(_class2, "THREAD_PHASES", [_RightPanelStorePhases.RightPanelPhases.ThreadPanel, _RightPanelStorePhases.RightPanelPhases.ThreadView]), _temp)) || _class);
exports.default = RoomHeaderButtons;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3JpZ2h0X3BhbmVsL1Jvb21IZWFkZXJCdXR0b25zLnRzeCJdLCJuYW1lcyI6WyJST09NX0lORk9fUEhBU0VTIiwiUmlnaHRQYW5lbFBoYXNlcyIsIlJvb21TdW1tYXJ5IiwiV2lkZ2V0IiwiRmlsZVBhbmVsIiwiUm9vbU1lbWJlckxpc3QiLCJSb29tTWVtYmVySW5mbyIsIkVuY3J5cHRpb25QYW5lbCIsIlJvb20zcGlkTWVtYmVySW5mbyIsIlVucmVhZEluZGljYXRvciIsImNsYXNzTmFtZSIsIlBpbm5lZE1lc3NhZ2VzSGVhZGVyQnV0dG9uIiwicm9vbSIsImlzSGlnaGxpZ2h0ZWQiLCJvbkNsaWNrIiwicGlubmluZ0VuYWJsZWQiLCJwaW5uZWRFdmVudHMiLCJyZWFkUGlubmVkRXZlbnRzIiwidW5yZWFkSW5kaWNhdG9yIiwic29tZSIsImlkIiwiaGFzIiwiVGltZWxpbmVDYXJkSGVhZGVyQnV0dG9uIiwiU2V0dGluZ3NTdG9yZSIsImdldFZhbHVlIiwiUm9vbU5vdGlmaWNhdGlvblN0YXRlU3RvcmUiLCJpbnN0YW5jZSIsImdldFJvb21TdGF0ZSIsImNvbG9yIiwiTm90aWZpY2F0aW9uQ29sb3IiLCJHcmV5IiwiUmVkIiwiUm9vbUhlYWRlckJ1dHRvbnMiLCJIZWFkZXJCdXR0b25zIiwiY29uc3RydWN0b3IiLCJwcm9wcyIsIkhlYWRlcktpbmQiLCJSb29tIiwibGFzdFBoYXNlIiwiUmlnaHRQYW5lbFN0b3JlIiwiZ2V0U2hhcmVkSW5zdGFuY2UiLCJyb29tUGFuZWxQaGFzZSIsImluY2x1ZGVzIiwic3RhdGUiLCJwaGFzZSIsInNldFBoYXNlIiwicm9vbVBhbmVsUGhhc2VQYXJhbXMiLCJOb3RpZmljYXRpb25QYW5lbCIsIlBpbm5lZE1lc3NhZ2VzIiwiVGltZWxpbmUiLCJUSFJFQURfUEhBU0VTIiwiZGlzIiwiZGlzcGF0Y2giLCJhY3Rpb24iLCJBY3Rpb24iLCJUb2dnbGVSaWdodFBhbmVsIiwidHlwZSIsIm9uQWN0aW9uIiwicGF5bG9hZCIsIlZpZXdVc2VyIiwibWVtYmVyIiwiZXZlbnQiLCJyZW5kZXJCdXR0b25zIiwicmlnaHRQYW5lbFBoYXNlQnV0dG9ucyIsIk1hcCIsInNldCIsImlzUGhhc2UiLCJvblBpbm5lZE1lc3NhZ2VzQ2xpY2tlZCIsIm9uVGltZWxpbmVDYXJkQ2xpY2tlZCIsIlRocmVhZFBhbmVsIiwib25UaHJlYWRzUGFuZWxDbGlja2VkIiwib25Ob3RpZmljYXRpb25zQ2xpY2tlZCIsIm9uUm9vbVN1bW1hcnlDbGlja2VkIiwiQXJyYXkiLCJmcm9tIiwia2V5cyIsIm1hcCIsImV4Y2x1ZGVkUmlnaHRQYW5lbFBoYXNlQnV0dG9ucyIsImdldCIsIlRocmVhZFZpZXciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBb0JBOztBQUdBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7OztBQUVBLE1BQU1BLGdCQUFnQixHQUFHLENBQ3JCQyx3Q0FBaUJDLFdBREksRUFFckJELHdDQUFpQkUsTUFGSSxFQUdyQkYsd0NBQWlCRyxTQUhJLEVBSXJCSCx3Q0FBaUJJLGNBSkksRUFLckJKLHdDQUFpQkssY0FMSSxFQU1yQkwsd0NBQWlCTSxlQU5JLEVBT3JCTix3Q0FBaUJPLGtCQVBJLENBQXpCOztBQWNBLE1BQU1DLGVBQWUsR0FBRyxDQUFDO0FBQUVDLEVBQUFBO0FBQUYsQ0FBRCxLQUEwQztBQUM5RCxzQkFBTyw2QkFBQyxjQUFELENBQU8sUUFBUCxxQkFDSDtBQUFLLElBQUEsU0FBUyxFQUFDO0FBQWYsSUFERyxlQUVIO0FBQUssSUFBQSxTQUFTLEVBQUVBO0FBQWhCLElBRkcsQ0FBUDtBQUlILENBTEQ7O0FBYUEsTUFBTUMsMEJBQTBCLEdBQUcsQ0FBQztBQUFFQyxFQUFBQSxJQUFGO0FBQVFDLEVBQUFBLGFBQVI7QUFBdUJDLEVBQUFBO0FBQXZCLENBQUQsS0FBMEQ7QUFD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a2V0IEx0ZFxuQ29weXJpZ2h0IDIwMTcgVmVjdG9yIENyZWF0aW9ucyBMdGRcbkNvcHlyaWdodCAyMDE3IE5ldyBWZWN0b3IgTHRkXG5Db3B5cmlnaHQgMjAxOCBOZXcgVmVjdG9yIEx0ZFxuQ29weXJpZ2h0IDIwMTksIDIwMjAgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSBcInJlYWN0XCI7XG5pbXBvcnQgeyBSb29tIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yb29tXCI7XG5cbmltcG9ydCB7IF90IH0gZnJvbSAnLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyJztcbmltcG9ydCBIZWFkZXJCdXR0b24gZnJvbSAnLi9IZWFkZXJCdXR0b24nO1xuaW1wb3J0IEhlYWRlckJ1dHRvbnMsIHsgSGVhZGVyS2luZCB9IGZyb20gJy4vSGVhZGVyQnV0dG9ucyc7XG5pbXBvcnQgeyBSaWdodFBhbmVsUGhhc2VzIH0gZnJvbSBcIi4uLy4uLy4uL3N0b3Jlcy9SaWdodFBhbmVsU3RvcmVQaGFzZXNcIjtcbmltcG9ydCB7IEFjdGlvbiB9IGZyb20gXCIuLi8uLi8uLi9kaXNwYXRjaGVyL2FjdGlvbnNcIjtcbmltcG9ydCB7IEFjdGlvblBheWxvYWQgfSBmcm9tIFwiLi4vLi4vLi4vZGlzcGF0Y2hlci9wYXlsb2Fkc1wiO1xuaW1wb3J0IFJpZ2h0UGFuZWxTdG9yZSBmcm9tIFwiLi4vLi4vLi4vc3RvcmVzL1JpZ2h0UGFuZWxTdG9yZVwiO1xuaW1wb3J0IHsgcmVwbGFjZWFibGVDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvcmVwbGFjZWFibGVDb21wb25lbnRcIjtcbmltcG9ydCB7IHVzZVNldHRpbmdWYWx1ZSB9IGZyb20gXCIuLi8uLi8uLi9ob29rcy91c2VTZXR0aW5nc1wiO1xuaW1wb3J0IHsgdXNlUmVhZFBpbm5lZEV2ZW50cywgdXNlUGlubmVkRXZlbnRzIH0gZnJvbSAnLi9QaW5uZWRNZXNzYWdlc0NhcmQnO1xuaW1wb3J0IHsgZGlzcGF0Y2hTaG93VGhyZWFkc1BhbmVsRXZlbnQgfSBmcm9tIFwiLi4vLi4vLi4vZGlzcGF0Y2hlci9kaXNwYXRjaC1hY3Rpb25zL3RocmVhZHNcIjtcbmltcG9ydCBTZXR0aW5nc1N0b3JlIGZyb20gXCIuLi8uLi8uLi9zZXR0aW5ncy9TZXR0aW5nc1N0b3JlXCI7XG5pbXBvcnQgZGlzIGZyb20gXCIuLi8uLi8uLi9kaXNwYXRjaGVyL2Rpc3BhdGNoZXJcIjtcbmltcG9ydCB7IFJvb21Ob3RpZmljYXRpb25TdGF0ZVN0b3JlIH0gZnJvbSBcIi4uLy4uLy4uL3N0b3Jlcy9ub3RpZmljYXRpb25zL1Jvb21Ob3RpZmljYXRpb25TdGF0ZVN0b3JlXCI7XG5pbXBvcnQgeyBOb3RpZmljYXRpb25Db2xvciB9IGZyb20gXCIuLi8uLi8uLi9zdG9yZXMvbm90aWZpY2F0aW9ucy9Ob3RpZmljYXRpb25Db2xvclwiO1xuXG5jb25zdCBST09NX0lORk9fUEhBU0VTID0gW1xuICAgIFJpZ2h0UGFuZWxQaGFzZXMuUm9vbVN1bW1hcnksXG4gICAgUmlnaHRQYW5lbFBoYXNlcy5XaWRnZXQsXG4gICAgUmlnaHRQYW5lbFBoYXNlcy5GaWxlUGFuZWwsXG4gICAgUmlnaHRQYW5lbFBoYXNlcy5Sb29tTWVtYmVyTGlzdCxcbiAgICBSaWdodFBhbmVsUGhhc2VzLlJvb21NZW1iZXJJbmZvLFxuICAgIFJpZ2h0UGFuZWxQaGFzZXMuRW5jcnlwdGlvblBhbmVsLFxuICAgIFJpZ2h0UGFuZWxQaGFzZXMuUm9vbTNwaWRNZW1iZXJJbmZvLFxuXTtcblxuaW50ZXJmYWNlIElVbnJlYWRJbmRpY2F0b3JQcm9wcyB7XG4gICAgY2xhc3NOYW1lOiBzdHJpbmc7XG59XG5cbmNvbnN0IFVucmVhZEluZGljYXRvciA9ICh7IGNsYXNzTmFtZSB9OiBJVW5yZWFkSW5kaWNhdG9yUHJvcHMpID0+IHtcbiAgICByZXR1cm4gPFJlYWN0LkZyYWdtZW50PlxuICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X1JpZ2h0UGFuZWxfaGVhZGVyQnV0dG9uX3VucmVhZEluZGljYXRvcl9iZ1wiIC8+XG4gICAgICAgIDxkaXYgY2xhc3NOYW1lPXtjbGFzc05hbWV9IC8+XG4gICAgPC9SZWFjdC5GcmFnbWVudD47XG59O1xuXG5pbnRlcmZhY2UgSUhlYWRlckJ1dHRvblByb3BzIHtcbiAgICByb29tOiBSb29tO1xuICAgIGlzSGlnaGxpZ2h0ZWQ6IGJvb2xlYW47XG4gICAgb25DbGljazogKCkgPT4gdm9pZDtcbn1cblxuY29uc3QgUGlubmVkTWVzc2FnZXNIZWFkZXJCdXR0b24gPSAoeyByb29tLCBpc0hpZ2hsaWdodGVkLCBvbkNsaWNrIH06IElIZWFkZXJCdXR0b25Qcm9wcykgPT4ge1xuICAgIGNvbnN0IHBpbm5pbmdFbmFibGVkID0gdXNlU2V0dGluZ1ZhbHVlKFwiZmVhdHVyZV9waW5uaW5nXCIpO1xuICAgIGNvbnN0IHBpbm5lZEV2ZW50cyA9IHVzZVBpbm5lZEV2ZW50cyhwaW5uaW5nRW5hYmxlZCAmJiByb29tKTtcbiAgICBjb25zdCByZWFkUGlubmVkRXZlbnRzID0gdXNlUmVhZFBpbm5lZEV2ZW50cyhwaW5uaW5nRW5hYmxlZCAmJiByb29tKTtcbiAgICBpZiAoIXBpbm5pbmdFbmFibGVkKSByZXR1cm4gbnVsbDtcblxuICAgIGxldCB1bnJlYWRJbmRpY2F0b3I7XG4gICAgaWYgKHBpbm5lZEV2ZW50cy5zb21lKGlkID0+ICFyZWFkUGlubmVkRXZlbnRzLmhhcyhpZCkpKSB7XG4gICAgICAgIHVucmVhZEluZGljYXRvciA9IDxVbnJlYWRJbmRpY2F0b3IgY2xhc3NOYW1lPVwibXhfUmlnaHRQYW5lbF9oZWFkZXJCdXR0b25fdW5yZWFkSW5kaWNhdG9yXCIgLz47XG4gICAgfVxuXG4gICAgcmV0dXJuIDxIZWFkZXJCdXR0b25cbiAgICAgICAgbmFtZT1cInBpbm5lZE1lc3NhZ2VzQnV0dG9uXCJcbiAgICAgICAgdGl0bGU9e190KFwiUGlubmVkIG1lc3NhZ2VzXCIpfVxuICAgICAgICBpc0hpZ2hsaWdodGVkPXtpc0hpZ2hsaWdodGVkfVxuICAgICAgICBvbkNsaWNrPXtvbkNsaWNrfVxuICAgICAgICBhbmFseXRpY3M9e1tcIlJpZ2h0IFBhbmVsXCIsIFwiUGlubmVkIE1lc3NhZ2VzIEJ1dHRvblwiLCBcImNsaWNrXCJdfVxuICAgID5cbiAgICAgICAgeyB1bnJlYWRJbmRpY2F0b3IgfVxuICAgIDwvSGVhZGVyQnV0dG9uPjtcbn07XG5cbmNvbnN0IFRpbWVsaW5lQ2FyZEhlYWRlckJ1dHRvbiA9ICh7IHJvb20sIGlzSGlnaGxpZ2h0ZWQsIG9uQ2xpY2sgfTogSUhlYWRlckJ1dHRvblByb3BzKSA9PiB7XG4gICAgaWYgKCFTZXR0aW5nc1N0b3JlLmdldFZhbHVlKFwiZmVhdHVyZV9tYXhpbWlzZWRfd2lkZ2V0c1wiKSkgcmV0dXJuIG51bGw7XG4gICAgbGV0IHVucmVhZEluZGljYXRvcjtcbiAgICBzd2l0Y2ggKFJvb21Ob3RpZmljYXRpb25TdGF0ZVN0b3JlLmluc3RhbmNlLmdldFJvb21TdGF0ZShyb29tKS5jb2xvcikge1xuICAgICAgICBjYXNlIE5vdGlmaWNhdGlvbkNvbG9yLkdyZXk6XG4gICAgICAgICAgICB1bnJlYWRJbmRpY2F0b3IgPVxuICAgICAgICAgICAgICAgIDxVbnJlYWRJbmRpY2F0b3IgY2xhc3NOYW1lPVwibXhfUmlnaHRQYW5lbF9oZWFkZXJCdXR0b25fdW5yZWFkSW5kaWNhdG9yIG14X0luZGljYXRvcl9ncmF5XCIgLz47XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBOb3RpZmljYXRpb25Db2xvci5SZWQ6XG4gICAgICAgICAgICB1bnJlYWRJbmRpY2F0b3IgPVxuICAgICAgICAgICAgICAgIDxVbnJlYWRJbmRpY2F0b3IgY2xhc3NOYW1lPVwibXhfUmlnaHRQYW5lbF9oZWFkZXJCdXR0b25fdW5yZWFkSW5kaWNhdG9yXCIgLz47XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICByZXR1cm4gPEhlYWRlckJ1dHRvblxuICAgICAgICBuYW1lPVwidGltZWxpbmVDYXJkQnV0dG9uXCJcbiAgICAgICAgdGl0bGU9e190KFwiQ2hhdFwiKX1cbiAgICAgICAgaXNIaWdobGlnaHRlZD17aXNIaWdobGlnaHRlZH1cbiAgICAgICAgb25DbGljaz17b25DbGlja31cbiAgICAgICAgYW5hbHl0aWNzPXtbXCJSaWdodCBQYW5lbFwiLCBcIlRpbWVsaW5lIFBhbmVsIEJ1dHRvblwiLCBcImNsaWNrXCJdfVxuICAgID5cbiAgICAgICAgeyB1bnJlYWRJbmRpY2F0b3IgfVxuICAgIDwvSGVhZGVyQnV0dG9uPjtcbn07XG5cbmludGVyZmFjZSBJUHJvcHMge1xuICAgIHJvb20/OiBSb29tO1xuICAgIGV4Y2x1ZGVkUmlnaHRQYW5lbFBoYXNlQnV0dG9ucz86IEFycmF5PFJpZ2h0UGFuZWxQaGFzZXM+O1xufVxuXG5AcmVwbGFjZWFibGVDb21wb25lbnQoXCJ2aWV3cy5yaWdodF9wYW5lbC5Sb29tSGVhZGVyQnV0dG9uc1wiKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUm9vbUhlYWRlckJ1dHRvbnMgZXh0ZW5kcyBIZWFkZXJCdXR0b25zPElQcm9wcz4ge1xuICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IFRIUkVBRF9QSEFTRVMgPSBbXG4gICAgICAgIFJpZ2h0UGFuZWxQaGFzZXMuVGhyZWFkUGFuZWwsXG4gICAgICAgIFJpZ2h0UGFuZWxQaGFzZXMuVGhyZWFkVmlldyxcbiAgICBdO1xuXG4gICAgY29uc3RydWN0b3IocHJvcHM6IElQcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcywgSGVhZGVyS2luZC5Sb29tKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgb25BY3Rpb24ocGF5bG9hZDogQWN0aW9uUGF5bG9hZCkge1xuICAgICAgICBpZiAocGF5bG9hZC5hY3Rpb24gPT09IEFjdGlvbi5WaWV3VXNlcikge1xuICAgICAgICAgICAgaWYgKHBheWxvYWQubWVtYmVyKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRQaGFzZShSaWdodFBhbmVsUGhhc2VzLlJvb21NZW1iZXJJbmZvLCB7IG1lbWJlcjogcGF5bG9hZC5tZW1iZXIgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0UGhhc2UoUmlnaHRQYW5lbFBoYXNlcy5Sb29tTWVtYmVyTGlzdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAocGF5bG9hZC5hY3Rpb24gPT09IFwidmlld18zcGlkX2ludml0ZVwiKSB7XG4gICAgICAgICAgICBpZiAocGF5bG9hZC5ldmVudCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0UGhhc2UoUmlnaHRQYW5lbFBoYXNlcy5Sb29tM3BpZE1lbWJlckluZm8sIHsgZXZlbnQ6IHBheWxvYWQuZXZlbnQgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0UGhhc2UoUmlnaHRQYW5lbFBoYXNlcy5Sb29tTWVtYmVyTGlzdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIG9uUm9vbVN1bW1hcnlDbGlja2VkID0gKCkgPT4ge1xuICAgICAgICAvLyB1c2Ugcm9vbVBhbmVsUGhhc2UgcmF0aGVyIHRoYW4gdGhpcy5zdGF0ZS5waGFzZSBhcyBpdCByZW1lbWJlcnMgdGhlIGxhdGVzdCBvbmUgaWYgd2UgY2xvc2VcbiAgICAgICAgY29uc3QgbGFzdFBoYXNlID0gUmlnaHRQYW5lbFN0b3JlLmdldFNoYXJlZEluc3RhbmNlKCkucm9vbVBhbmVsUGhhc2U7XG4gICAgICAgIGlmIChST09NX0lORk9fUEhBU0VTLmluY2x1ZGVzKGxhc3RQaGFzZSkpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlLnBoYXNlID09PSBsYXN0UGhhc2UpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldFBoYXNlKGxhc3RQaGFzZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0UGhhc2UobGFzdFBoYXNlLCBSaWdodFBhbmVsU3RvcmUuZ2V0U2hhcmVkSW5zdGFuY2UoKS5yb29tUGFuZWxQaGFzZVBhcmFtcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBUaGlzIHRvZ2dsZXMgZm9yIHVzLCBpZiBuZWVkZWRcbiAgICAgICAgICAgIHRoaXMuc2V0UGhhc2UoUmlnaHRQYW5lbFBoYXNlcy5Sb29tU3VtbWFyeSk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbk5vdGlmaWNhdGlvbnNDbGlja2VkID0gKCkgPT4ge1xuICAgICAgICAvLyBUaGlzIHRvZ2dsZXMgZm9yIHVzLCBpZiBuZWVkZWRcbiAgICAgICAgdGhpcy5zZXRQaGFzZShSaWdodFBhbmVsUGhhc2VzLk5vdGlmaWNhdGlvblBhbmVsKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvblBpbm5lZE1lc3NhZ2VzQ2xpY2tlZCA9ICgpID0+IHtcbiAgICAgICAgLy8gVGhpcyB0b2dnbGVzIGZvciB1cywgaWYgbmVlZGVkXG4gICAgICAgIHRoaXMuc2V0UGhhc2UoUmlnaHRQYW5lbFBoYXNlcy5QaW5uZWRNZXNzYWdlcyk7XG4gICAgfTtcbiAgICBwcml2YXRlIG9uVGltZWxpbmVDYXJkQ2xpY2tlZCA9ICgpID0+IHtcbiAgICAgICAgdGhpcy5zZXRQaGFzZShSaWdodFBhbmVsUGhhc2VzLlRpbWVsaW5lKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvblRocmVhZHNQYW5lbENsaWNrZWQgPSAoKSA9PiB7XG4gICAgICAgIGlmIChSb29tSGVhZGVyQnV0dG9ucy5USFJFQURfUEhBU0VTLmluY2x1ZGVzKHRoaXMuc3RhdGUucGhhc2UpKSB7XG4gICAgICAgICAgICBkaXMuZGlzcGF0Y2goe1xuICAgICAgICAgICAgICAgIGFjdGlvbjogQWN0aW9uLlRvZ2dsZVJpZ2h0UGFuZWwsXG4gICAgICAgICAgICAgICAgdHlwZTogXCJyb29tXCIsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGRpc3BhdGNoU2hvd1RocmVhZHNQYW5lbEV2ZW50KCk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHVibGljIHJlbmRlckJ1dHRvbnMoKSB7XG4gICAgICAgIGNvbnN0IHJpZ2h0UGFuZWxQaGFzZUJ1dHRvbnM6IE1hcDxSaWdodFBhbmVsUGhhc2VzLCBhbnk+ID0gbmV3IE1hcCgpO1xuXG4gICAgICAgIHJpZ2h0UGFuZWxQaGFzZUJ1dHRvbnMuc2V0KFJpZ2h0UGFuZWxQaGFzZXMuUGlubmVkTWVzc2FnZXMsXG4gICAgICAgICAgICA8UGlubmVkTWVzc2FnZXNIZWFkZXJCdXR0b25cbiAgICAgICAgICAgICAgICByb29tPXt0aGlzLnByb3BzLnJvb219XG4gICAgICAgICAgICAgICAgaXNIaWdobGlnaHRlZD17dGhpcy5pc1BoYXNlKFJpZ2h0UGFuZWxQaGFzZXMuUGlubmVkTWVzc2FnZXMpfVxuICAgICAgICAgICAgICAgIG9uQ2xpY2s9e3RoaXMub25QaW5uZWRNZXNzYWdlc0NsaWNrZWR9IC8+LFxuICAgICAgICApO1xuICAgICAgICByaWdodFBhbmVsUGhhc2VCdXR0b25zLnNldChSaWdodFBhbmVsUGhhc2VzLlRpbWVsaW5lLFxuICAgICAgICAgICAgPFRpbWVsaW5lQ2FyZEhlYWRlckJ1dHRvblxuICAgICAgICAgICAgICAgIHJvb209e3RoaXMucHJvcHMucm9vbX1cbiAgICAgICAgICAgICAgICBpc0hpZ2hsaWdodGVkPXt0aGlzLmlzUGhhc2UoUmlnaHRQYW5lbFBoYXNlcy5UaW1lbGluZSl9XG4gICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5vblRpbWVsaW5lQ2FyZENsaWNrZWR9IC8+LFxuICAgICAgICApO1xuICAgICAgICByaWdodFBhbmVsUGhhc2VCdXR0b25zLnNldChSaWdodFBhbmVsUGhhc2VzLlRocmVhZFBhbmVsLFxuICAgICAgICAgICAgU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcImZlYXR1cmVfdGhyZWFkXCIpXG4gICAgICAgICAgICAgICAgPyA8SGVhZGVyQnV0dG9uXG4gICAgICAgICAgICAgICAgICAgIG5hbWU9XCJ0aHJlYWRzQnV0dG9uXCJcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU9e190KFwiVGhyZWFkc1wiKX1cbiAgICAgICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5vblRocmVhZHNQYW5lbENsaWNrZWR9XG4gICAgICAgICAgICAgICAgICAgIGlzSGlnaGxpZ2h0ZWQ9e3RoaXMuaXNQaGFzZShSb29tSGVhZGVyQnV0dG9ucy5USFJFQURfUEhBU0VTKX1cbiAgICAgICAgICAgICAgICAgICAgYW5hbHl0aWNzPXtbJ1JpZ2h0IFBhbmVsJywgJ1RocmVhZHMgTGlzdCBCdXR0b24nLCAnY2xpY2snXX0gLz5cbiAgICAgICAgICAgICAgICA6IG51bGwsXG4gICAgICAgICk7XG4gICAgICAgIHJpZ2h0UGFuZWxQaGFzZUJ1dHRvbnMuc2V0KFJpZ2h0UGFuZWxQaGFzZXMuTm90aWZpY2F0aW9uUGFuZWwsXG4gICAgICAgICAgICA8SGVhZGVyQnV0dG9uXG4gICAgICAgICAgICAgICAgbmFtZT1cIm5vdGlmc0J1dHRvblwiXG4gICAgICAgICAgICAgICAgdGl0bGU9e190KCdOb3RpZmljYXRpb25zJyl9XG4gICAgICAgICAgICAgICAgaXNIaWdobGlnaHRlZD17dGhpcy5pc1BoYXNlKFJpZ2h0UGFuZWxQaGFzZXMuTm90aWZpY2F0aW9uUGFuZWwpfVxuICAgICAgICAgICAgICAgIG9uQ2xpY2s9e3RoaXMub25Ob3RpZmljYXRpb25zQ2xpY2tlZH1cbiAgICAgICAgICAgICAgICBhbmFseXRpY3M9e1snUmlnaHQgUGFuZWwnLCAnTm90aWZpY2F0aW9uIExpc3QgQnV0dG9uJywgJ2NsaWNrJ119IC8+LFxuICAgICAgICApO1xuICAgICAgICByaWdodFBhbmVsUGhhc2VCdXR0b25zLnNldChSaWdodFBhbmVsUGhhc2VzLlJvb21TdW1tYXJ5LFxuICAgICAgICAgICAgPEhlYWRlckJ1dHRvblxuICAgICAgICAgICAgICAgIG5hbWU9XCJyb29tU3VtbWFyeUJ1dHRvblwiXG4gICAgICAgICAgICAgICAgdGl0bGU9e190KCdSb29tIEluZm8nKX1cbiAgICAgICAgICAgICAgICBpc0hpZ2hsaWdodGVkPXt0aGlzLmlzUGhhc2UoUk9PTV9JTkZPX1BIQVNFUyl9XG4gICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5vblJvb21TdW1tYXJ5Q2xpY2tlZH1cbiAgICAgICAgICAgICAgICBhbmFseXRpY3M9e1snUmlnaHQgUGFuZWwnLCAnUm9vbSBTdW1tYXJ5IEJ1dHRvbicsICdjbGljayddfSAvPixcbiAgICAgICAgKTtcblxuICAgICAgICByZXR1cm4gPD5cbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBBcnJheS5mcm9tKHJpZ2h0UGFuZWxQaGFzZUJ1dHRvbnMua2V5cygpKS5tYXAoKHBoYXNlKSA9PlxuICAgICAgICAgICAgICAgICAgICAoIHRoaXMucHJvcHMuZXhjbHVkZWRSaWdodFBhbmVsUGhhc2VCdXR0b25zLmluY2x1ZGVzKHBoYXNlKVxuICAgICAgICAgICAgICAgICAgICAgICAgPyBudWxsXG4gICAgICAgICAgICAgICAgICAgICAgICA6IHJpZ2h0UGFuZWxQaGFzZUJ1dHRvbnMuZ2V0KHBoYXNlKSkpXG4gICAgICAgICAgICB9XG4gICAgICAgIDwvPjtcbiAgICB9XG59XG4iXX0=