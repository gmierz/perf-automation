"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireWildcard(require("react"));

var _VerificationRequest = require("matrix-js-sdk/src/crypto/verification/request/VerificationRequest");

var _EncryptionInfo = _interopRequireDefault(require("./EncryptionInfo"));

var _VerificationPanel = _interopRequireDefault(require("./VerificationPanel"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _createRoom = require("../../../createRoom");

var _useEventEmitter = require("../../../hooks/useEventEmitter");

var _Modal = _interopRequireDefault(require("../../../Modal"));

var sdk = _interopRequireWildcard(require("../../../index"));

var _languageHandler = require("../../../languageHandler");

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var _actions = require("../../../dispatcher/actions");

var _RightPanelStorePhases = require("../../../stores/RightPanelStorePhases");

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/*
Copyright 2019, 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
// cancellation codes which constitute a key mismatch
const MISMATCHES = ["m.key_mismatch", "m.user_error", "m.mismatched_sas"];

const EncryptionPanel = props => {
  const {
    verificationRequest,
    verificationRequestPromise,
    member,
    onClose,
    layout,
    isRoomEncrypted
  } = props;
  const [request, setRequest] = (0, _react.useState)(verificationRequest); // state to show a spinner immediately after clicking "start verification",
  // before we have a request

  const [isRequesting, setRequesting] = (0, _react.useState)(false);
  const [phase, setPhase] = (0, _react.useState)(request === null || request === void 0 ? void 0 : request.phase);
  (0, _react.useEffect)(() => {
    setRequest(verificationRequest);

    if (verificationRequest) {
      setRequesting(false);
      setPhase(verificationRequest.phase);
    }
  }, [verificationRequest]);
  (0, _react.useEffect)(() => {
    async function awaitPromise() {
      setRequesting(true);
      const requestFromPromise = await verificationRequestPromise;
      setRequesting(false);
      setRequest(requestFromPromise);
      setPhase(requestFromPromise.phase);
    }

    if (verificationRequestPromise) {
      awaitPromise();
    }
  }, [verificationRequestPromise]);
  const changeHandler = (0, _react.useCallback)(() => {
    // handle transitions -> cancelled for mismatches which fire a modal instead of showing a card
    if (request && request.cancelled && MISMATCHES.includes(request.cancellationCode)) {
      // FIXME: Using an import will result in test failures
      const ErrorDialog = sdk.getComponent("dialogs.ErrorDialog");

      _Modal.default.createTrackedDialog("Verification failed", "insecure", ErrorDialog, {
        headerImage: require("../../../../res/img/e2e/warning.svg"),
        title: (0, _languageHandler._t)("Your messages are not secure"),
        description: /*#__PURE__*/_react.default.createElement("div", null, (0, _languageHandler._t)("One of the following may be compromised:"), /*#__PURE__*/_react.default.createElement("ul", null, /*#__PURE__*/_react.default.createElement("li", null, (0, _languageHandler._t)("Your homeserver")), /*#__PURE__*/_react.default.createElement("li", null, (0, _languageHandler._t)("The homeserver the user you're verifying is connected to")), /*#__PURE__*/_react.default.createElement("li", null, (0, _languageHandler._t)("Yours, or the other users' internet connection")), /*#__PURE__*/_react.default.createElement("li", null, (0, _languageHandler._t)("Yours, or the other users' session")))),
        onFinished: onClose
      });

      return; // don't update phase here as we will be transitioning away from this view shortly
    }

    if (request) {
      setPhase(request.phase);
    }
  }, [onClose, request]);
  (0, _useEventEmitter.useEventEmitter)(request, "change", changeHandler);
  const onStartVerification = (0, _react.useCallback)(async () => {
    setRequesting(true);

    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    const roomId = await (0, _createRoom.ensureDMExists)(cli, member.userId);
    const verificationRequest_ = await cli.requestVerificationDM(member.userId, roomId);
    setRequest(verificationRequest_);
    setPhase(verificationRequest_.phase); // Notify the RightPanelStore about this

    _dispatcher.default.dispatch({
      action: _actions.Action.SetRightPanelPhase,
      phase: _RightPanelStorePhases.RightPanelPhases.EncryptionPanel,
      refireParams: {
        member,
        verificationRequest: verificationRequest_
      }
    });
  }, [member]);
  const requested = !request && isRequesting || request && (phase === _VerificationRequest.PHASE_REQUESTED || phase === _VerificationRequest.PHASE_UNSENT || phase === undefined);
  const isSelfVerification = request ? request.isSelfVerification : member.userId === _MatrixClientPeg.MatrixClientPeg.get().getUserId();

  if (!request || requested) {
    const initiatedByMe = !request && isRequesting || request && request.initiatedByMe;
    return /*#__PURE__*/_react.default.createElement(_EncryptionInfo.default, {
      isRoomEncrypted: isRoomEncrypted,
      onStartVerification: onStartVerification,
      member: member,
      isSelfVerification: isSelfVerification,
      waitingForOtherParty: requested && initiatedByMe,
      waitingForNetwork: requested && !initiatedByMe,
      inDialog: layout === "dialog"
    });
  } else {
    return /*#__PURE__*/_react.default.createElement(_VerificationPanel.default, {
      isRoomEncrypted: isRoomEncrypted,
      layout: layout,
      onClose: onClose,
      member: member,
      request: request,
      key: request.channel.transactionId,
      inDialog: layout === "dialog",
      phase: phase
    });
  }
};

var _default = EncryptionPanel;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3JpZ2h0X3BhbmVsL0VuY3J5cHRpb25QYW5lbC50c3giXSwibmFtZXMiOlsiTUlTTUFUQ0hFUyIsIkVuY3J5cHRpb25QYW5lbCIsInByb3BzIiwidmVyaWZpY2F0aW9uUmVxdWVzdCIsInZlcmlmaWNhdGlvblJlcXVlc3RQcm9taXNlIiwibWVtYmVyIiwib25DbG9zZSIsImxheW91dCIsImlzUm9vbUVuY3J5cHRlZCIsInJlcXVlc3QiLCJzZXRSZXF1ZXN0IiwiaXNSZXF1ZXN0aW5nIiwic2V0UmVxdWVzdGluZyIsInBoYXNlIiwic2V0UGhhc2UiLCJhd2FpdFByb21pc2UiLCJyZXF1ZXN0RnJvbVByb21pc2UiLCJjaGFuZ2VIYW5kbGVyIiwiY2FuY2VsbGVkIiwiaW5jbHVkZXMiLCJjYW5jZWxsYXRpb25Db2RlIiwiRXJyb3JEaWFsb2ciLCJzZGsiLCJnZXRDb21wb25lbnQiLCJNb2RhbCIsImNyZWF0ZVRyYWNrZWREaWFsb2ciLCJoZWFkZXJJbWFnZSIsInJlcXVpcmUiLCJ0aXRsZSIsImRlc2NyaXB0aW9uIiwib25GaW5pc2hlZCIsIm9uU3RhcnRWZXJpZmljYXRpb24iLCJjbGkiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJyb29tSWQiLCJ1c2VySWQiLCJ2ZXJpZmljYXRpb25SZXF1ZXN0XyIsInJlcXVlc3RWZXJpZmljYXRpb25ETSIsImRpcyIsImRpc3BhdGNoIiwiYWN0aW9uIiwiQWN0aW9uIiwiU2V0UmlnaHRQYW5lbFBoYXNlIiwiUmlnaHRQYW5lbFBoYXNlcyIsInJlZmlyZVBhcmFtcyIsInJlcXVlc3RlZCIsIlBIQVNFX1JFUVVFU1RFRCIsIlBIQVNFX1VOU0VOVCIsInVuZGVmaW5lZCIsImlzU2VsZlZlcmlmaWNhdGlvbiIsImdldFVzZXJJZCIsImluaXRpYXRlZEJ5TWUiLCJjaGFubmVsIiwidHJhbnNhY3Rpb25JZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBZ0JBOztBQUlB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Z0JDLEdBQWhCLEdBQXNCaUIsU0FBdEIsRUFGdEI7O0FBR0EsTUFBSSxDQUFDMUMsT0FBRCxJQUFZcUMsU0FBaEIsRUFBMkI7QUFDdkIsVUFBTU0sYUFBYSxHQUFJLENBQUMzQyxPQUFELElBQVlFLFlBQWIsSUFBK0JGLE9BQU8sSUFBSUEsT0FBTyxDQUFDMkMsYUFBeEU7QUFDQSx3QkFDSSw2QkFBQyx1QkFBRDtBQUNJLE1BQUEsZUFBZSxFQUFFNUMsZUFEckI7QUFFSSxNQUFBLG1CQUFtQixFQUFFdUIsbUJBRnpCO0FBR0ksTUFBQSxNQUFNLEVBQUUxQixNQUhaO0FBSUksTUFBQSxrQkFBa0IsRUFBRTZDLGtCQUp4QjtBQUtJLE1BQUEsb0JBQW9CLEVBQUVKLFNBQVMsSUFBSU0sYUFMdkM7QUFNSSxNQUFBLGlCQUFpQixFQUFFTixTQUFTLElBQUksQ0FBQ00sYUFOckM7QUFPSSxNQUFBLFFBQVEsRUFBRTdDLE1BQU0sS0FBSztBQVB6QixNQURKO0FBVUgsR0FaRCxNQVlPO0FBQ0gsd0JBQ0ksNkJBQUMsMEJBQUQ7QUFDSSxNQUFBLGVBQWUsRUFBRUMsZUFEckI7QUFFSSxNQUFBLE1BQU0sRUFBRUQsTUFGWjtBQUdJLE1BQUEsT0FBTyxFQUFFRCxPQUhiO0FBSUksTUFBQSxNQUFNLEVBQUVELE1BSlo7QUFLSSxNQUFBLE9BQU8sRUFBRUksT0FMYjtBQU1JLE1BQUEsR0FBRyxFQUFFQSxPQUFPLENBQUM0QyxPQUFSLENBQWdCQyxhQU56QjtBQU9JLE1BQUEsUUFBUSxFQUFFL0MsTUFBTSxLQUFLLFFBUHpCO0FBUUksTUFBQSxLQUFLLEVBQUVNO0FBUlgsTUFESjtBQVlIO0FBQ0osQ0E3R0Q7O2VBK0dlWixlIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE5LCAyMDIwIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0LCB7IHVzZUNhbGxiYWNrLCB1c2VFZmZlY3QsIHVzZVN0YXRlIH0gZnJvbSBcInJlYWN0XCI7XG5pbXBvcnQgeyBWZXJpZmljYXRpb25SZXF1ZXN0IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2NyeXB0by92ZXJpZmljYXRpb24vcmVxdWVzdC9WZXJpZmljYXRpb25SZXF1ZXN0XCI7XG5pbXBvcnQgeyBSb29tTWVtYmVyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yb29tLW1lbWJlclwiO1xuaW1wb3J0IHsgVXNlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvdXNlclwiO1xuaW1wb3J0IHsgUEhBU0VfUkVRVUVTVEVELCBQSEFTRV9VTlNFTlQgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvY3J5cHRvL3ZlcmlmaWNhdGlvbi9yZXF1ZXN0L1ZlcmlmaWNhdGlvblJlcXVlc3RcIjtcblxuaW1wb3J0IEVuY3J5cHRpb25JbmZvIGZyb20gXCIuL0VuY3J5cHRpb25JbmZvXCI7XG5pbXBvcnQgVmVyaWZpY2F0aW9uUGFuZWwgZnJvbSBcIi4vVmVyaWZpY2F0aW9uUGFuZWxcIjtcbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gXCIuLi8uLi8uLi9NYXRyaXhDbGllbnRQZWdcIjtcbmltcG9ydCB7IGVuc3VyZURNRXhpc3RzIH0gZnJvbSBcIi4uLy4uLy4uL2NyZWF0ZVJvb21cIjtcbmltcG9ydCB7IHVzZUV2ZW50RW1pdHRlciB9IGZyb20gXCIuLi8uLi8uLi9ob29rcy91c2VFdmVudEVtaXR0ZXJcIjtcbmltcG9ydCBNb2RhbCBmcm9tIFwiLi4vLi4vLi4vTW9kYWxcIjtcbmltcG9ydCAqIGFzIHNkayBmcm9tIFwiLi4vLi4vLi4vaW5kZXhcIjtcbmltcG9ydCB7IF90IH0gZnJvbSBcIi4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlclwiO1xuaW1wb3J0IGRpcyBmcm9tIFwiLi4vLi4vLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyXCI7XG5pbXBvcnQgeyBBY3Rpb24gfSBmcm9tIFwiLi4vLi4vLi4vZGlzcGF0Y2hlci9hY3Rpb25zXCI7XG5pbXBvcnQgeyBSaWdodFBhbmVsUGhhc2VzIH0gZnJvbSBcIi4uLy4uLy4uL3N0b3Jlcy9SaWdodFBhbmVsU3RvcmVQaGFzZXNcIjtcblxuLy8gY2FuY2VsbGF0aW9uIGNvZGVzIHdoaWNoIGNvbnN0aXR1dGUgYSBrZXkgbWlzbWF0Y2hcbmNvbnN0IE1JU01BVENIRVMgPSBbXCJtLmtleV9taXNtYXRjaFwiLCBcIm0udXNlcl9lcnJvclwiLCBcIm0ubWlzbWF0Y2hlZF9zYXNcIl07XG5cbmludGVyZmFjZSBJUHJvcHMge1xuICAgIG1lbWJlcjogUm9vbU1lbWJlciB8IFVzZXI7XG4gICAgb25DbG9zZTogKCkgPT4gdm9pZDtcbiAgICB2ZXJpZmljYXRpb25SZXF1ZXN0OiBWZXJpZmljYXRpb25SZXF1ZXN0O1xuICAgIHZlcmlmaWNhdGlvblJlcXVlc3RQcm9taXNlPzogUHJvbWlzZTxWZXJpZmljYXRpb25SZXF1ZXN0PjtcbiAgICBsYXlvdXQ6IHN0cmluZztcbiAgICBpc1Jvb21FbmNyeXB0ZWQ6IGJvb2xlYW47XG59XG5cbmNvbnN0IEVuY3J5cHRpb25QYW5lbDogUmVhY3QuRkM8SVByb3BzPiA9IChwcm9wczogSVByb3BzKSA9PiB7XG4gICAgY29uc3Qge1xuICAgICAgICB2ZXJpZmljYXRpb25SZXF1ZXN0LFxuICAgICAgICB2ZXJpZmljYXRpb25SZXF1ZXN0UHJvbWlzZSxcbiAgICAgICAgbWVtYmVyLFxuICAgICAgICBvbkNsb3NlLFxuICAgICAgICBsYXlvdXQsXG4gICAgICAgIGlzUm9vbUVuY3J5cHRlZCxcbiAgICB9ID0gcHJvcHM7XG4gICAgY29uc3QgW3JlcXVlc3QsIHNldFJlcXVlc3RdID0gdXNlU3RhdGUodmVyaWZpY2F0aW9uUmVxdWVzdCk7XG4gICAgLy8gc3RhdGUgdG8gc2hvdyBhIHNwaW5uZXIgaW1tZWRpYXRlbHkgYWZ0ZXIgY2xpY2tpbmcgXCJzdGFydCB2ZXJpZmljYXRpb25cIixcbiAgICAvLyBiZWZvcmUgd2UgaGF2ZSBhIHJlcXVlc3RcbiAgICBjb25zdCBbaXNSZXF1ZXN0aW5nLCBzZXRSZXF1ZXN0aW5nXSA9IHVzZVN0YXRlKGZhbHNlKTtcbiAgICBjb25zdCBbcGhhc2UsIHNldFBoYXNlXSA9IHVzZVN0YXRlKHJlcXVlc3Q/LnBoYXNlKTtcbiAgICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgICAgICBzZXRSZXF1ZXN0KHZlcmlmaWNhdGlvblJlcXVlc3QpO1xuICAgICAgICBpZiAodmVyaWZpY2F0aW9uUmVxdWVzdCkge1xuICAgICAgICAgICAgc2V0UmVxdWVzdGluZyhmYWxzZSk7XG4gICAgICAgICAgICBzZXRQaGFzZSh2ZXJpZmljYXRpb25SZXF1ZXN0LnBoYXNlKTtcbiAgICAgICAgfVxuICAgIH0sIFt2ZXJpZmljYXRpb25SZXF1ZXN0XSk7XG5cbiAgICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgICAgICBhc3luYyBmdW5jdGlvbiBhd2FpdFByb21pc2UoKSB7XG4gICAgICAgICAgICBzZXRSZXF1ZXN0aW5nKHRydWUpO1xuICAgICAgICAgICAgY29uc3QgcmVxdWVzdEZyb21Qcm9taXNlID0gYXdhaXQgdmVyaWZpY2F0aW9uUmVxdWVzdFByb21pc2U7XG4gICAgICAgICAgICBzZXRSZXF1ZXN0aW5nKGZhbHNlKTtcbiAgICAgICAgICAgIHNldFJlcXVlc3QocmVxdWVzdEZyb21Qcm9taXNlKTtcbiAgICAgICAgICAgIHNldFBoYXNlKHJlcXVlc3RGcm9tUHJvbWlzZS5waGFzZSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHZlcmlmaWNhdGlvblJlcXVlc3RQcm9taXNlKSB7XG4gICAgICAgICAgICBhd2FpdFByb21pc2UoKTtcbiAgICAgICAgfVxuICAgIH0sIFt2ZXJpZmljYXRpb25SZXF1ZXN0UHJvbWlzZV0pO1xuICAgIGNvbnN0IGNoYW5nZUhhbmRsZXIgPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgICAgIC8vIGhhbmRsZSB0cmFuc2l0aW9ucyAtPiBjYW5jZWxsZWQgZm9yIG1pc21hdGNoZXMgd2hpY2ggZmlyZSBhIG1vZGFsIGluc3RlYWQgb2Ygc2hvd2luZyBhIGNhcmRcbiAgICAgICAgaWYgKHJlcXVlc3QgJiYgcmVxdWVzdC5jYW5jZWxsZWQgJiYgTUlTTUFUQ0hFUy5pbmNsdWRlcyhyZXF1ZXN0LmNhbmNlbGxhdGlvbkNvZGUpKSB7XG4gICAgICAgICAgICAvLyBGSVhNRTogVXNpbmcgYW4gaW1wb3J0IHdpbGwgcmVzdWx0IGluIHRlc3QgZmFpbHVyZXNcbiAgICAgICAgICAgIGNvbnN0IEVycm9yRGlhbG9nID0gc2RrLmdldENvbXBvbmVudChcImRpYWxvZ3MuRXJyb3JEaWFsb2dcIik7XG4gICAgICAgICAgICBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nKFwiVmVyaWZpY2F0aW9uIGZhaWxlZFwiLCBcImluc2VjdXJlXCIsIEVycm9yRGlhbG9nLCB7XG4gICAgICAgICAgICAgICAgaGVhZGVySW1hZ2U6IHJlcXVpcmUoXCIuLi8uLi8uLi8uLi9yZXMvaW1nL2UyZS93YXJuaW5nLnN2Z1wiKSxcbiAgICAgICAgICAgICAgICB0aXRsZTogX3QoXCJZb3VyIG1lc3NhZ2VzIGFyZSBub3Qgc2VjdXJlXCIpLFxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiA8ZGl2PlxuICAgICAgICAgICAgICAgICAgICB7IF90KFwiT25lIG9mIHRoZSBmb2xsb3dpbmcgbWF5IGJlIGNvbXByb21pc2VkOlwiKSB9XG4gICAgICAgICAgICAgICAgICAgIDx1bD5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxsaT57IF90KFwiWW91ciBob21lc2VydmVyXCIpIH08L2xpPlxuICAgICAgICAgICAgICAgICAgICAgICAgPGxpPnsgX3QoXCJUaGUgaG9tZXNlcnZlciB0aGUgdXNlciB5b3UncmUgdmVyaWZ5aW5nIGlzIGNvbm5lY3RlZCB0b1wiKSB9PC9saT5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxsaT57IF90KFwiWW91cnMsIG9yIHRoZSBvdGhlciB1c2VycycgaW50ZXJuZXQgY29ubmVjdGlvblwiKSB9PC9saT5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxsaT57IF90KFwiWW91cnMsIG9yIHRoZSBvdGhlciB1c2Vycycgc2Vzc2lvblwiKSB9PC9saT5cbiAgICAgICAgICAgICAgICAgICAgPC91bD5cbiAgICAgICAgICAgICAgICA8L2Rpdj4sXG4gICAgICAgICAgICAgICAgb25GaW5pc2hlZDogb25DbG9zZSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuOyAvLyBkb24ndCB1cGRhdGUgcGhhc2UgaGVyZSBhcyB3ZSB3aWxsIGJlIHRyYW5zaXRpb25pbmcgYXdheSBmcm9tIHRoaXMgdmlldyBzaG9ydGx5XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocmVxdWVzdCkge1xuICAgICAgICAgICAgc2V0UGhhc2UocmVxdWVzdC5waGFzZSk7XG4gICAgICAgIH1cbiAgICB9LCBbb25DbG9zZSwgcmVxdWVzdF0pO1xuICAgIHVzZUV2ZW50RW1pdHRlcihyZXF1ZXN0LCBcImNoYW5nZVwiLCBjaGFuZ2VIYW5kbGVyKTtcblxuICAgIGNvbnN0IG9uU3RhcnRWZXJpZmljYXRpb24gPSB1c2VDYWxsYmFjayhhc3luYyAoKSA9PiB7XG4gICAgICAgIHNldFJlcXVlc3RpbmcodHJ1ZSk7XG4gICAgICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICAgICAgY29uc3Qgcm9vbUlkID0gYXdhaXQgZW5zdXJlRE1FeGlzdHMoY2xpLCBtZW1iZXIudXNlcklkKTtcbiAgICAgICAgY29uc3QgdmVyaWZpY2F0aW9uUmVxdWVzdF8gPSBhd2FpdCBjbGkucmVxdWVzdFZlcmlmaWNhdGlvbkRNKG1lbWJlci51c2VySWQsIHJvb21JZCk7XG4gICAgICAgIHNldFJlcXVlc3QodmVyaWZpY2F0aW9uUmVxdWVzdF8pO1xuICAgICAgICBzZXRQaGFzZSh2ZXJpZmljYXRpb25SZXF1ZXN0Xy5waGFzZSk7XG4gICAgICAgIC8vIE5vdGlmeSB0aGUgUmlnaHRQYW5lbFN0b3JlIGFib3V0IHRoaXNcbiAgICAgICAgZGlzLmRpc3BhdGNoKHtcbiAgICAgICAgICAgIGFjdGlvbjogQWN0aW9uLlNldFJpZ2h0UGFuZWxQaGFzZSxcbiAgICAgICAgICAgIHBoYXNlOiBSaWdodFBhbmVsUGhhc2VzLkVuY3J5cHRpb25QYW5lbCxcbiAgICAgICAgICAgIHJlZmlyZVBhcmFtczogeyBtZW1iZXIsIHZlcmlmaWNhdGlvblJlcXVlc3Q6IHZlcmlmaWNhdGlvblJlcXVlc3RfIH0sXG4gICAgICAgIH0pO1xuICAgIH0sIFttZW1iZXJdKTtcblxuICAgIGNvbnN0IHJlcXVlc3RlZCA9XG4gICAgICAgICghcmVxdWVzdCAmJiBpc1JlcXVlc3RpbmcpIHx8XG4gICAgICAgIChyZXF1ZXN0ICYmIChwaGFzZSA9PT0gUEhBU0VfUkVRVUVTVEVEIHx8IHBoYXNlID09PSBQSEFTRV9VTlNFTlQgfHwgcGhhc2UgPT09IHVuZGVmaW5lZCkpO1xuICAgIGNvbnN0IGlzU2VsZlZlcmlmaWNhdGlvbiA9IHJlcXVlc3QgP1xuICAgICAgICByZXF1ZXN0LmlzU2VsZlZlcmlmaWNhdGlvbiA6XG4gICAgICAgIG1lbWJlci51c2VySWQgPT09IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRVc2VySWQoKTtcbiAgICBpZiAoIXJlcXVlc3QgfHwgcmVxdWVzdGVkKSB7XG4gICAgICAgIGNvbnN0IGluaXRpYXRlZEJ5TWUgPSAoIXJlcXVlc3QgJiYgaXNSZXF1ZXN0aW5nKSB8fCAocmVxdWVzdCAmJiByZXF1ZXN0LmluaXRpYXRlZEJ5TWUpO1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPEVuY3J5cHRpb25JbmZvXG4gICAgICAgICAgICAgICAgaXNSb29tRW5jcnlwdGVkPXtpc1Jvb21FbmNyeXB0ZWR9XG4gICAgICAgICAgICAgICAgb25TdGFydFZlcmlmaWNhdGlvbj17b25TdGFydFZlcmlmaWNhdGlvbn1cbiAgICAgICAgICAgICAgICBtZW1iZXI9e21lbWJlcn1cbiAgICAgICAgICAgICAgICBpc1NlbGZWZXJpZmljYXRpb249e2lzU2VsZlZlcmlmaWNhdGlvbn1cbiAgICAgICAgICAgICAgICB3YWl0aW5nRm9yT3RoZXJQYXJ0eT17cmVxdWVzdGVkICYmIGluaXRpYXRlZEJ5TWV9XG4gICAgICAgICAgICAgICAgd2FpdGluZ0Zvck5ldHdvcms9e3JlcXVlc3RlZCAmJiAhaW5pdGlhdGVkQnlNZX1cbiAgICAgICAgICAgICAgICBpbkRpYWxvZz17bGF5b3V0ID09PSBcImRpYWxvZ1wifSAvPlxuICAgICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8VmVyaWZpY2F0aW9uUGFuZWxcbiAgICAgICAgICAgICAgICBpc1Jvb21FbmNyeXB0ZWQ9e2lzUm9vbUVuY3J5cHRlZH1cbiAgICAgICAgICAgICAgICBsYXlvdXQ9e2xheW91dH1cbiAgICAgICAgICAgICAgICBvbkNsb3NlPXtvbkNsb3NlfVxuICAgICAgICAgICAgICAgIG1lbWJlcj17bWVtYmVyfVxuICAgICAgICAgICAgICAgIHJlcXVlc3Q9e3JlcXVlc3R9XG4gICAgICAgICAgICAgICAga2V5PXtyZXF1ZXN0LmNoYW5uZWwudHJhbnNhY3Rpb25JZH1cbiAgICAgICAgICAgICAgICBpbkRpYWxvZz17bGF5b3V0ID09PSBcImRpYWxvZ1wifVxuICAgICAgICAgICAgICAgIHBoYXNlPXtwaGFzZX1cbiAgICAgICAgICAgIC8+XG4gICAgICAgICk7XG4gICAgfVxufTtcblxuZXhwb3J0IGRlZmF1bHQgRW5jcnlwdGlvblBhbmVsO1xuIl19