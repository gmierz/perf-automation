"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _phonenumber = require("../../../phonenumber");

var _SdkConfig = _interopRequireDefault(require("../../../SdkConfig"));

var _languageHandler = require("../../../languageHandler");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _Dropdown = _interopRequireDefault(require("../elements/Dropdown"));

var _dec, _class;

const COUNTRIES_BY_ISO2 = {};

for (const c of _phonenumber.COUNTRIES) {
  COUNTRIES_BY_ISO2[c.iso2] = c;
}

function countryMatchesSearchQuery(query, country) {
  // Remove '+' if present (when searching for a prefix)
  if (query[0] === '+') {
    query = query.slice(1);
  }

  if (country.name.toUpperCase().indexOf(query.toUpperCase()) == 0) return true;
  if (country.iso2 == query.toUpperCase()) return true;
  if (country.prefix.indexOf(query) !== -1) return true;
  return false;
}

let CountryDropdown = (_dec = (0, _replaceableComponent.replaceableComponent)("views.auth.CountryDropdown"), _dec(_class = class CountryDropdown extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onSearchChange", search => {
      this.setState({
        searchQuery: search
      });
    });
    (0, _defineProperty2.default)(this, "onOptionChange", iso2 => {
      this.props.onOptionChange(COUNTRIES_BY_ISO2[iso2]);
    });
    (0, _defineProperty2.default)(this, "getShortOption", iso2 => {
      if (!this.props.isSmall) {
        return undefined;
      }

      let countryPrefix;

      if (this.props.showPrefix) {
        countryPrefix = '+' + COUNTRIES_BY_ISO2[iso2].prefix;
      }

      return /*#__PURE__*/_react.default.createElement("span", {
        className: "mx_CountryDropdown_shortOption"
      }, this.flagImgForIso2(iso2), countryPrefix);
    });
    let defaultCountry = _phonenumber.COUNTRIES[0];

    const defaultCountryCode = _SdkConfig.default.get()["defaultCountryCode"];

    if (defaultCountryCode) {
      const country = _phonenumber.COUNTRIES.find(c => c.iso2 === defaultCountryCode.toUpperCase());

      if (country) defaultCountry = country;
    }

    this.state = {
      searchQuery: '',
      defaultCountry
    };
  }

  componentDidMount() {
    if (!this.props.value) {
      // If no value is given, we start with the default
      // country selected, but our parent component
      // doesn't know this, therefore we do this.
      this.props.onOptionChange(this.state.defaultCountry);
    }
  }

  flagImgForIso2(iso2) {
    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_Dropdown_option_emoji"
    }, (0, _phonenumber.getEmojiFlag)(iso2));
  }

  render() {
    let displayedCountries;

    if (this.state.searchQuery) {
      displayedCountries = _phonenumber.COUNTRIES.filter(countryMatchesSearchQuery.bind(this, this.state.searchQuery));

      if (this.state.searchQuery.length == 2 && COUNTRIES_BY_ISO2[this.state.searchQuery.toUpperCase()]) {
        // exact ISO2 country name match: make the first result the matches ISO2
        const matched = COUNTRIES_BY_ISO2[this.state.searchQuery.toUpperCase()];
        displayedCountries = displayedCountries.filter(c => {
          return c.iso2 != matched.iso2;
        });
        displayedCountries.unshift(matched);
      }
    } else {
      displayedCountries = _phonenumber.COUNTRIES;
    }

    const options = displayedCountries.map(country => {
      return /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_CountryDropdown_option",
        key: country.iso2
      }, this.flagImgForIso2(country.iso2), (0, _languageHandler._t)(country.name), " (+", country.prefix, ")");
    }); // default value here too, otherwise we need to handle null / undefined
    // values between mounting and the initial value propgating

    const value = this.props.value || this.state.defaultCountry.iso2;
    return /*#__PURE__*/_react.default.createElement(_Dropdown.default, {
      id: "mx_CountryDropdown",
      className: this.props.className + " mx_CountryDropdown",
      onOptionChange: this.onOptionChange,
      onSearchChange: this.onSearchChange,
      menuWidth: 298,
      getShortOption: this.getShortOption,
      value: value,
      searchEnabled: true,
      disabled: this.props.disabled,
      label: (0, _languageHandler._t)("Country Dropdown")
    }, options);
  }

}) || _class);
exports.default = CountryDropdown;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2F1dGgvQ291bnRyeURyb3Bkb3duLnRzeCJdLCJuYW1lcyI6WyJDT1VOVFJJRVNfQllfSVNPMiIsImMiLCJDT1VOVFJJRVMiLCJpc28yIiwiY291bnRyeU1hdGNoZXNTZWFyY2hRdWVyeSIsInF1ZXJ5IiwiY291bnRyeSIsInNsaWNlIiwibmFtZSIsInRvVXBwZXJDYXNlIiwiaW5kZXhPZiIsInByZWZpeCIsIkNvdW50cnlEcm9wZG93biIsIlJlYWN0IiwiQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsInNlYXJjaCIsInNldFN0YXRlIiwic2VhcmNoUXVlcnkiLCJvbk9wdGlvbkNoYW5nZSIsImlzU21hbGwiLCJ1bmRlZmluZWQiLCJjb3VudHJ5UHJlZml4Iiwic2hvd1ByZWZpeCIsImZsYWdJbWdGb3JJc28yIiwiZGVmYXVsdENvdW50cnkiLCJkZWZhdWx0Q291bnRyeUNvZGUiLCJTZGtDb25maWciLCJnZXQiLCJmaW5kIiwic3RhdGUiLCJjb21wb25lbnREaWRNb3VudCIsInZhbHVlIiwicmVuZGVyIiwiZGlzcGxheWVkQ291bnRyaWVzIiwiZmlsdGVyIiwiYmluZCIsImxlbmd0aCIsIm1hdGNoZWQiLCJ1bnNoaWZ0Iiwib3B0aW9ucyIsIm1hcCIsImNsYXNzTmFtZSIsIm9uU2VhcmNoQ2hhbmdlIiwiZ2V0U2hvcnRPcHRpb24iLCJkaXNhYmxlZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFnQkE7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxpQkFBaUIsR0FBRyxFQUExQjs7QUFDQSxLQUFLLE1BQU1DLENBQVgsSUFBZ0JDLHNCQUFoQixFQUEyQjtBQUN2QkYsRUFBQUEsaUJBQWlCLENBQUNDLENBQUMsQ0FBQ0UsSUFBSCxDQUFqQixHQUE0QkYsQ0FBNUI7QUFDSDs7QUFFRCxTQUFTRyx5QkFBVCxDQUFtQ0MsS0FBbkMsRUFBa0RDLE9BQWxE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RUEsd0JBQU8sNkJBQUMsaUJBQUQ7QUFDSCxNQUFBLEVBQUUsRUFBQyxvQkFEQTtBQUVILE1BQUEsU0FBUyxFQUFFLEtBQUthLEtBQUwsQ0FBVzJCLFNBQVgsR0FBdUIscUJBRi9CO0FBR0gsTUFBQSxjQUFjLEVBQUUsS0FBS3ZCLGNBSGxCO0FBSUgsTUFBQSxjQUFjLEVBQUUsS0FBS3dCLGNBSmxCO0FBS0gsTUFBQSxTQUFTLEVBQUUsR0FMUjtBQU1ILE1BQUEsY0FBYyxFQUFFLEtBQUtDLGNBTmxCO0FBT0gsTUFBQSxLQUFLLEVBQUVaLEtBUEo7QUFRSCxNQUFBLGFBQWEsRUFBRSxJQVJaO0FBU0gsTUFBQSxRQUFRLEVBQUUsS0FBS2pCLEtBQUwsQ0FBVzhCLFFBVGxCO0FBVUgsTUFBQSxLQUFLLEVBQUUseUJBQUcsa0JBQUg7QUFWSixPQVlETCxPQVpDLENBQVA7QUFjSDs7QUFwR3dFLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTcgVmVjdG9yIENyZWF0aW9ucyBMdGRcblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuXG5pbXBvcnQgeyBDT1VOVFJJRVMsIGdldEVtb2ppRmxhZywgUGhvbmVOdW1iZXJDb3VudHJ5RGVmaW5pdGlvbiB9IGZyb20gJy4uLy4uLy4uL3Bob25lbnVtYmVyJztcbmltcG9ydCBTZGtDb25maWcgZnJvbSBcIi4uLy4uLy4uL1Nka0NvbmZpZ1wiO1xuaW1wb3J0IHsgX3QgfSBmcm9tIFwiLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyXCI7XG5pbXBvcnQgeyByZXBsYWNlYWJsZUNvbXBvbmVudCB9IGZyb20gXCIuLi8uLi8uLi91dGlscy9yZXBsYWNlYWJsZUNvbXBvbmVudFwiO1xuaW1wb3J0IERyb3Bkb3duIGZyb20gXCIuLi9lbGVtZW50cy9Ecm9wZG93blwiO1xuXG5jb25zdCBDT1VOVFJJRVNfQllfSVNPMiA9IHt9O1xuZm9yIChjb25zdCBjIG9mIENPVU5UUklFUykge1xuICAgIENPVU5UUklFU19CWV9JU08yW2MuaXNvMl0gPSBjO1xufVxuXG5mdW5jdGlvbiBjb3VudHJ5TWF0Y2hlc1NlYXJjaFF1ZXJ5KHF1ZXJ5OiBzdHJpbmcsIGNvdW50cnk6IFBob25lTnVtYmVyQ291bnRyeURlZmluaXRpb24pOiBib29sZWFuIHtcbiAgICAvLyBSZW1vdmUgJysnIGlmIHByZXNlbnQgKHdoZW4gc2VhcmNoaW5nIGZvciBhIHByZWZpeClcbiAgICBpZiAocXVlcnlbMF0gPT09ICcrJykge1xuICAgICAgICBxdWVyeSA9IHF1ZXJ5LnNsaWNlKDEpO1xuICAgIH1cblxuICAgIGlmIChjb3VudHJ5Lm5hbWUudG9VcHBlckNhc2UoKS5pbmRleE9mKHF1ZXJ5LnRvVXBwZXJDYXNlKCkpID09IDApIHJldHVybiB0cnVlO1xuICAgIGlmIChjb3VudHJ5LmlzbzIgPT0gcXVlcnkudG9VcHBlckNhc2UoKSkgcmV0dXJuIHRydWU7XG4gICAgaWYgKGNvdW50cnkucHJlZml4LmluZGV4T2YocXVlcnkpICE9PSAtMSkgcmV0dXJuIHRydWU7XG4gICAgcmV0dXJuIGZhbHNlO1xufVxuXG5pbnRlcmZhY2UgSVByb3BzIHtcbiAgICB2YWx1ZT86IHN0cmluZztcbiAgICBvbk9wdGlvbkNoYW5nZTogKGNvdW50cnk6IFBob25lTnVtYmVyQ291bnRyeURlZmluaXRpb24pID0+IHZvaWQ7XG4gICAgaXNTbWFsbDogYm9vbGVhbjsgLy8gaWYgaXNTbWFsbCwgc2hvdyArNDQgaW4gdGhlIHNlbGVjdGVkIHZhbHVlXG4gICAgc2hvd1ByZWZpeDogYm9vbGVhbjtcbiAgICBjbGFzc05hbWU/OiBzdHJpbmc7XG4gICAgZGlzYWJsZWQ/OiBib29sZWFuO1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBzZWFyY2hRdWVyeTogc3RyaW5nO1xuICAgIGRlZmF1bHRDb3VudHJ5OiBQaG9uZU51bWJlckNvdW50cnlEZWZpbml0aW9uO1xufVxuXG5AcmVwbGFjZWFibGVDb21wb25lbnQoXCJ2aWV3cy5hdXRoLkNvdW50cnlEcm9wZG93blwiKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ291bnRyeURyb3Bkb3duIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PElQcm9wcywgSVN0YXRlPiB7XG4gICAgY29uc3RydWN0b3IocHJvcHM6IElQcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG5cbiAgICAgICAgbGV0IGRlZmF1bHRDb3VudHJ5OiBQaG9uZU51bWJlckNvdW50cnlEZWZpbml0aW9uID0gQ09VTlRSSUVTWzBdO1xuICAgICAgICBjb25zdCBkZWZhdWx0Q291bnRyeUNvZGUgPSBTZGtDb25maWcuZ2V0KClbXCJkZWZhdWx0Q291bnRyeUNvZGVcIl07XG4gICAgICAgIGlmIChkZWZhdWx0Q291bnRyeUNvZGUpIHtcbiAgICAgICAgICAgIGNvbnN0IGNvdW50cnkgPSBDT1VOVFJJRVMuZmluZChjID0+IGMuaXNvMiA9PT0gZGVmYXVsdENvdW50cnlDb2RlLnRvVXBwZXJDYXNlKCkpO1xuICAgICAgICAgICAgaWYgKGNvdW50cnkpIGRlZmF1bHRDb3VudHJ5ID0gY291bnRyeTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICBzZWFyY2hRdWVyeTogJycsXG4gICAgICAgICAgICBkZWZhdWx0Q291bnRyeSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY29tcG9uZW50RGlkTW91bnQoKTogdm9pZCB7XG4gICAgICAgIGlmICghdGhpcy5wcm9wcy52YWx1ZSkge1xuICAgICAgICAgICAgLy8gSWYgbm8gdmFsdWUgaXMgZ2l2ZW4sIHdlIHN0YXJ0IHdpdGggdGhlIGRlZmF1bHRcbiAgICAgICAgICAgIC8vIGNvdW50cnkgc2VsZWN0ZWQsIGJ1dCBvdXIgcGFyZW50IGNvbXBvbmVudFxuICAgICAgICAgICAgLy8gZG9lc24ndCBrbm93IHRoaXMsIHRoZXJlZm9yZSB3ZSBkbyB0aGlzLlxuICAgICAgICAgICAgdGhpcy5wcm9wcy5vbk9wdGlvbkNoYW5nZSh0aGlzLnN0YXRlLmRlZmF1bHRDb3VudHJ5KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgb25TZWFyY2hDaGFuZ2UgPSAoc2VhcmNoOiBzdHJpbmcpOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBzZWFyY2hRdWVyeTogc2VhcmNoLFxuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbk9wdGlvbkNoYW5nZSA9IChpc28yOiBzdHJpbmcpOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5wcm9wcy5vbk9wdGlvbkNoYW5nZShDT1VOVFJJRVNfQllfSVNPMltpc28yXSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgZmxhZ0ltZ0ZvcklzbzIoaXNvMjogc3RyaW5nKTogUmVhY3QuUmVhY3ROb2RlIHtcbiAgICAgICAgcmV0dXJuIDxkaXYgY2xhc3NOYW1lPVwibXhfRHJvcGRvd25fb3B0aW9uX2Vtb2ppXCI+eyBnZXRFbW9qaUZsYWcoaXNvMikgfTwvZGl2PjtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFNob3J0T3B0aW9uID0gKGlzbzI6IHN0cmluZyk6IFJlYWN0LlJlYWN0Tm9kZSA9PiB7XG4gICAgICAgIGlmICghdGhpcy5wcm9wcy5pc1NtYWxsKSB7XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgICAgIGxldCBjb3VudHJ5UHJlZml4O1xuICAgICAgICBpZiAodGhpcy5wcm9wcy5zaG93UHJlZml4KSB7XG4gICAgICAgICAgICBjb3VudHJ5UHJlZml4ID0gJysnICsgQ09VTlRSSUVTX0JZX0lTTzJbaXNvMl0ucHJlZml4O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiA8c3BhbiBjbGFzc05hbWU9XCJteF9Db3VudHJ5RHJvcGRvd25fc2hvcnRPcHRpb25cIj5cbiAgICAgICAgICAgIHsgdGhpcy5mbGFnSW1nRm9ySXNvMihpc28yKSB9XG4gICAgICAgICAgICB7IGNvdW50cnlQcmVmaXggfVxuICAgICAgICA8L3NwYW4+O1xuICAgIH07XG5cbiAgICBwdWJsaWMgcmVuZGVyKCk6IFJlYWN0LlJlYWN0Tm9kZSB7XG4gICAgICAgIGxldCBkaXNwbGF5ZWRDb3VudHJpZXM7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnNlYXJjaFF1ZXJ5KSB7XG4gICAgICAgICAgICBkaXNwbGF5ZWRDb3VudHJpZXMgPSBDT1VOVFJJRVMuZmlsdGVyKFxuICAgICAgICAgICAgICAgIGNvdW50cnlNYXRjaGVzU2VhcmNoUXVlcnkuYmluZCh0aGlzLCB0aGlzLnN0YXRlLnNlYXJjaFF1ZXJ5KSxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS5zZWFyY2hRdWVyeS5sZW5ndGggPT0gMiAmJlxuICAgICAgICAgICAgICAgIENPVU5UUklFU19CWV9JU08yW3RoaXMuc3RhdGUuc2VhcmNoUXVlcnkudG9VcHBlckNhc2UoKV1cbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgIC8vIGV4YWN0IElTTzIgY291bnRyeSBuYW1lIG1hdGNoOiBtYWtlIHRoZSBmaXJzdCByZXN1bHQgdGhlIG1hdGNoZXMgSVNPMlxuICAgICAgICAgICAgICAgIGNvbnN0IG1hdGNoZWQgPSBDT1VOVFJJRVNfQllfSVNPMlt0aGlzLnN0YXRlLnNlYXJjaFF1ZXJ5LnRvVXBwZXJDYXNlKCldO1xuICAgICAgICAgICAgICAgIGRpc3BsYXllZENvdW50cmllcyA9IGRpc3BsYXllZENvdW50cmllcy5maWx0ZXIoKGMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGMuaXNvMiAhPSBtYXRjaGVkLmlzbzI7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgZGlzcGxheWVkQ291bnRyaWVzLnVuc2hpZnQobWF0Y2hlZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBkaXNwbGF5ZWRDb3VudHJpZXMgPSBDT1VOVFJJRVM7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBvcHRpb25zID0gZGlzcGxheWVkQ291bnRyaWVzLm1hcCgoY291bnRyeSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIDxkaXYgY2xhc3NOYW1lPVwibXhfQ291bnRyeURyb3Bkb3duX29wdGlvblwiIGtleT17Y291bnRyeS5pc28yfT5cbiAgICAgICAgICAgICAgICB7IHRoaXMuZmxhZ0ltZ0ZvcklzbzIoY291bnRyeS5pc28yKSB9XG4gICAgICAgICAgICAgICAgeyBfdChjb3VudHJ5Lm5hbWUpIH0gKCt7IGNvdW50cnkucHJlZml4IH0pXG4gICAgICAgICAgICA8L2Rpdj47XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIGRlZmF1bHQgdmFsdWUgaGVyZSB0b28sIG90aGVyd2lzZSB3ZSBuZWVkIHRvIGhhbmRsZSBudWxsIC8gdW5kZWZpbmVkXG4gICAgICAgIC8vIHZhbHVlcyBiZXR3ZWVuIG1vdW50aW5nIGFuZCB0aGUgaW5pdGlhbCB2YWx1ZSBwcm9wZ2F0aW5nXG4gICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5wcm9wcy52YWx1ZSB8fCB0aGlzLnN0YXRlLmRlZmF1bHRDb3VudHJ5LmlzbzI7XG5cbiAgICAgICAgcmV0dXJuIDxEcm9wZG93blxuICAgICAgICAgICAgaWQ9XCJteF9Db3VudHJ5RHJvcGRvd25cIlxuICAgICAgICAgICAgY2xhc3NOYW1lPXt0aGlzLnByb3BzLmNsYXNzTmFtZSArIFwiIG14X0NvdW50cnlEcm9wZG93blwifVxuICAgICAgICAgICAgb25PcHRpb25DaGFuZ2U9e3RoaXMub25PcHRpb25DaGFuZ2V9XG4gICAgICAgICAgICBvblNlYXJjaENoYW5nZT17dGhpcy5vblNlYXJjaENoYW5nZX1cbiAgICAgICAgICAgIG1lbnVXaWR0aD17Mjk4fVxuICAgICAgICAgICAgZ2V0U2hvcnRPcHRpb249e3RoaXMuZ2V0U2hvcnRPcHRpb259XG4gICAgICAgICAgICB2YWx1ZT17dmFsdWV9XG4gICAgICAgICAgICBzZWFyY2hFbmFibGVkPXt0cnVlfVxuICAgICAgICAgICAgZGlzYWJsZWQ9e3RoaXMucHJvcHMuZGlzYWJsZWR9XG4gICAgICAgICAgICBsYWJlbD17X3QoXCJDb3VudHJ5IERyb3Bkb3duXCIpfVxuICAgICAgICA+XG4gICAgICAgICAgICB7IG9wdGlvbnMgfVxuICAgICAgICA8L0Ryb3Bkb3duPjtcbiAgICB9XG59XG4iXX0=