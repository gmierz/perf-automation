"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var _languageHandler = require("../../../languageHandler");

var _CountlyAnalytics = _interopRequireDefault(require("../../../CountlyAnalytics"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class, _class2, _temp;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

const DIV_ID = 'mx_recaptcha';
let CaptchaForm = (
/**
 * A pure UI component which displays a captcha form.
 */
_dec = (0, _replaceableComponent.replaceableComponent)("views.auth.CaptchaForm"), _dec(_class = (_temp = _class2 = class CaptchaForm extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "captchaWidgetId", void 0);
    (0, _defineProperty2.default)(this, "recaptchaContainer", /*#__PURE__*/(0, _react.createRef)());
    this.state = {
      errorText: undefined
    };

    _CountlyAnalytics.default.instance.track("onboarding_grecaptcha_begin");
  }

  componentDidMount() {
    // Just putting a script tag into the returned jsx doesn't work, annoyingly,
    // so we do this instead.
    if (this.isRecaptchaReady()) {
      // already loaded
      this.onCaptchaLoaded();
    } else {
      _logger.logger.log("Loading recaptcha script...");

      window.mxOnRecaptchaLoaded = () => {
        this.onCaptchaLoaded();
      };

      const scriptTag = document.createElement('script');
      scriptTag.setAttribute('src', `https://www.recaptcha.net/recaptcha/api.js?onload=mxOnRecaptchaLoaded&render=explicit`);
      this.recaptchaContainer.current.appendChild(scriptTag);
    }
  }

  componentWillUnmount() {
    this.resetRecaptcha();
  } // Borrowed directly from: https://github.com/codeep/react-recaptcha-google/commit/e118fa5670fa268426969323b2e7fe77698376ba


  isRecaptchaReady() {
    return typeof window !== "undefined" && typeof global.grecaptcha !== "undefined" && typeof global.grecaptcha.render === 'function';
  }

  renderRecaptcha(divId) {
    if (!this.isRecaptchaReady()) {
      _logger.logger.error("grecaptcha not loaded!");

      throw new Error("Recaptcha did not load successfully");
    }

    const publicKey = this.props.sitePublicKey;

    if (!publicKey) {
      _logger.logger.error("No public key for recaptcha!");

      throw new Error("This server has not supplied enough information for Recaptcha " + "authentication");
    }

    _logger.logger.info("Rendering to %s", divId);

    this.captchaWidgetId = global.grecaptcha.render(divId, {
      sitekey: publicKey,
      callback: this.props.onCaptchaResponse
    });
  }

  resetRecaptcha() {
    if (this.captchaWidgetId) {
      var _global, _global$grecaptcha;

      (_global = global) === null || _global === void 0 ? void 0 : (_global$grecaptcha = _global.grecaptcha) === null || _global$grecaptcha === void 0 ? void 0 : _global$grecaptcha.reset(this.captchaWidgetId);
    }
  }

  onCaptchaLoaded() {
    _logger.logger.log("Loaded recaptcha script.");

    try {
      this.renderRecaptcha(DIV_ID); // clear error if re-rendered

      this.setState({
        errorText: null
      });

      _CountlyAnalytics.default.instance.track("onboarding_grecaptcha_loaded");
    } catch (e) {
      this.setState({
        errorText: e.toString()
      });

      _CountlyAnalytics.default.instance.track("onboarding_grecaptcha_error", {
        error: e.toString()
      });
    }
  }

  render() {
    let error = null;

    if (this.state.errorText) {
      error = /*#__PURE__*/_react.default.createElement("div", {
        className: "error"
      }, this.state.errorText);
    }

    return /*#__PURE__*/_react.default.createElement("div", {
      ref: this.recaptchaContainer
    }, /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("This homeserver would like to make sure you are not a robot.")), /*#__PURE__*/_react.default.createElement("div", {
      id: DIV_ID
    }), error);
  }

}, (0, _defineProperty2.default)(_class2, "defaultProps", {
  onCaptchaResponse: () => {}
}), _temp)) || _class);
exports.default = CaptchaForm;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2F1dGgvQ2FwdGNoYUZvcm0udHN4Il0sIm5hbWVzIjpbIkRJVl9JRCIsIkNhcHRjaGFGb3JtIiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwic3RhdGUiLCJlcnJvclRleHQiLCJ1bmRlZmluZWQiLCJDb3VudGx5QW5hbHl0aWNzIiwiaW5zdGFuY2UiLCJ0cmFjayIsImNvbXBvbmVudERpZE1vdW50IiwiaXNSZWNhcHRjaGFSZWFkeSIsIm9uQ2FwdGNoYUxvYWRlZCIsImxvZ2dlciIsImxvZyIsIndpbmRvdyIsIm14T25SZWNhcHRjaGFMb2FkZWQiLCJzY3JpcHRUYWciLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJzZXRBdHRyaWJ1dGUiLCJyZWNhcHRjaGFDb250YWluZXIiLCJjdXJyZW50IiwiYXBwZW5kQ2hpbGQiLCJjb21wb25lbnRXaWxsVW5tb3VudCIsInJlc2V0UmVjYXB0Y2hhIiwiZ2xvYmFsIiwiZ3JlY2FwdGNoYSIsInJlbmRlciIsInJlbmRlclJlY2FwdGNoYSIsImRpdklkIiwiZXJyb3IiLCJFcnJvciIsInB1YmxpY0tleSIsInNpdGVQdWJsaWNLZXkiLCJpbmZvIiwiY2FwdGNoYVdpZGdldElkIiwic2l0ZWtleSIsImNhbGxiYWNrIiwib25DYXB0Y2hhUmVzcG9uc2UiLCJyZXNldCIsInNldFN0YXRlIiwiZSIsInRvU3RyaW5nIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWdCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7Ozs7Ozs7QUFFQSxNQUFNQSxNQUFNLEdBQUcsY0FBZjtJQWdCcUJDLFc7QUFKckI7QUFDQTtBQUNBO09BQ0MsZ0RBQXFCLHdCQUFyQixDLG1DQUFELE1BQ3FCQSxXQURyQixTQUN5Q0MsZUFBTUMsU0FEL0MsQ0FDK0Y7QUFRM0ZDLEVBQUFBLFdBQVcsQ0FBQ0MsS0FBRCxFQUEyQjtBQUNsQyxVQUFNQSxLQUFOO0FB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QUVEZixFQUFBQSxNQUFNLEdBQUc7QUFDTCxRQUFJRyxLQUFLLEdBQUcsSUFBWjs7QUFDQSxRQUFJLEtBQUszQixLQUFMLENBQVdDLFNBQWYsRUFBMEI7QUFDdEIwQixNQUFBQSxLQUFLLGdCQUNEO0FBQUssUUFBQSxTQUFTLEVBQUM7QUFBZixTQUNNLEtBQUszQixLQUFMLENBQVdDLFNBRGpCLENBREo7QUFLSDs7QUFFRCx3QkFDSTtBQUFLLE1BQUEsR0FBRyxFQUFFLEtBQUtnQjtBQUFmLG9CQUNJLHdDQUFLLHlCQUNELDhEQURDLENBQUwsQ0FESixlQUlJO0FBQUssTUFBQSxFQUFFLEVBQUV2QjtBQUFULE1BSkosRUFLTWlDLEtBTE4sQ0FESjtBQVNIOztBQTdHMEYsQyx5REFDckU7QUFDbEJRLEVBQUFBLGlCQUFpQixFQUFFLE1BQU0sQ0FBRTtBQURULEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTUsIDIwMTYgT3Blbk1hcmtldCBMdGRcblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QsIHsgY3JlYXRlUmVmIH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgX3QgfSBmcm9tICcuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXInO1xuaW1wb3J0IENvdW50bHlBbmFseXRpY3MgZnJvbSBcIi4uLy4uLy4uL0NvdW50bHlBbmFseXRpY3NcIjtcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcblxuY29uc3QgRElWX0lEID0gJ214X3JlY2FwdGNoYSc7XG5cbmludGVyZmFjZSBJQ2FwdGNoYUZvcm1Qcm9wcyB7XG4gICAgc2l0ZVB1YmxpY0tleTogc3RyaW5nO1xuICAgIG9uQ2FwdGNoYVJlc3BvbnNlOiAocmVzcG9uc2U6IHN0cmluZykgPT4gdm9pZDtcbn1cblxuaW50ZXJmYWNlIElDYXB0Y2hhRm9ybVN0YXRlIHtcbiAgICBlcnJvclRleHQ/OiBzdHJpbmc7XG5cbn1cblxuLyoqXG4gKiBBIHB1cmUgVUkgY29tcG9uZW50IHdoaWNoIGRpc3BsYXlzIGEgY2FwdGNoYSBmb3JtLlxuICovXG5AcmVwbGFjZWFibGVDb21wb25lbnQoXCJ2aWV3cy5hdXRoLkNhcHRjaGFGb3JtXCIpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDYXB0Y2hhRm9ybSBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxJQ2FwdGNoYUZvcm1Qcm9wcywgSUNhcHRjaGFGb3JtU3RhdGU+IHtcbiAgICBzdGF0aWMgZGVmYXVsdFByb3BzID0ge1xuICAgICAgICBvbkNhcHRjaGFSZXNwb25zZTogKCkgPT4ge30sXG4gICAgfTtcblxuICAgIHByaXZhdGUgY2FwdGNoYVdpZGdldElkPzogc3RyaW5nO1xuICAgIHByaXZhdGUgcmVjYXB0Y2hhQ29udGFpbmVyID0gY3JlYXRlUmVmPEhUTUxEaXZFbGVtZW50PigpO1xuXG4gICAgY29uc3RydWN0b3IocHJvcHM6IElDYXB0Y2hhRm9ybVByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgZXJyb3JUZXh0OiB1bmRlZmluZWQsXG4gICAgICAgIH07XG5cbiAgICAgICAgQ291bnRseUFuYWx5dGljcy5pbnN0YW5jZS50cmFjayhcIm9uYm9hcmRpbmdfZ3JlY2FwdGNoYV9iZWdpblwiKTtcbiAgICB9XG5cbiAgICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICAgICAgLy8gSnVzdCBwdXR0aW5nIGEgc2NyaXB0IHRhZyBpbnRvIHRoZSByZXR1cm5lZCBqc3ggZG9lc24ndCB3b3JrLCBhbm5veWluZ2x5LFxuICAgICAgICAvLyBzbyB3ZSBkbyB0aGlzIGluc3RlYWQuXG4gICAgICAgIGlmICh0aGlzLmlzUmVjYXB0Y2hhUmVhZHkoKSkge1xuICAgICAgICAgICAgLy8gYWxyZWFkeSBsb2FkZWRcbiAgICAgICAgICAgIHRoaXMub25DYXB0Y2hhTG9hZGVkKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsb2dnZXIubG9nKFwiTG9hZGluZyByZWNhcHRjaGEgc2NyaXB0Li4uXCIpO1xuICAgICAgICAgICAgd2luZG93Lm14T25SZWNhcHRjaGFMb2FkZWQgPSAoKSA9PiB7IHRoaXMub25DYXB0Y2hhTG9hZGVkKCk7IH07XG4gICAgICAgICAgICBjb25zdCBzY3JpcHRUYWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtcbiAgICAgICAgICAgIHNjcmlwdFRhZy5zZXRBdHRyaWJ1dGUoXG4gICAgICAgICAgICAgICAgJ3NyYycsIGBodHRwczovL3d3dy5yZWNhcHRjaGEubmV0L3JlY2FwdGNoYS9hcGkuanM/b25sb2FkPW14T25SZWNhcHRjaGFMb2FkZWQmcmVuZGVyPWV4cGxpY2l0YCxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICB0aGlzLnJlY2FwdGNoYUNvbnRhaW5lci5jdXJyZW50LmFwcGVuZENoaWxkKHNjcmlwdFRhZyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICAgICAgdGhpcy5yZXNldFJlY2FwdGNoYSgpO1xuICAgIH1cblxuICAgIC8vIEJvcnJvd2VkIGRpcmVjdGx5IGZyb206IGh0dHBzOi8vZ2l0aHViLmNvbS9jb2RlZXAvcmVhY3QtcmVjYXB0Y2hhLWdvb2dsZS9jb21taXQvZTExOGZhNTY3MGZhMjY4NDI2OTY5MzIzYjJlN2ZlNzc2OTgzNzZiYVxuICAgIHByaXZhdGUgaXNSZWNhcHRjaGFSZWFkeSgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHR5cGVvZiB3aW5kb3cgIT09IFwidW5kZWZpbmVkXCIgJiZcbiAgICAgICAgICAgIHR5cGVvZiBnbG9iYWwuZ3JlY2FwdGNoYSAhPT0gXCJ1bmRlZmluZWRcIiAmJlxuICAgICAgICAgICAgdHlwZW9mIGdsb2JhbC5ncmVjYXB0Y2hhLnJlbmRlciA9PT0gJ2Z1bmN0aW9uJztcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlbmRlclJlY2FwdGNoYShkaXZJZDogc3RyaW5nKSB7XG4gICAgICAgIGlmICghdGhpcy5pc1JlY2FwdGNoYVJlYWR5KCkpIHtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihcImdyZWNhcHRjaGEgbm90IGxvYWRlZCFcIik7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJSZWNhcHRjaGEgZGlkIG5vdCBsb2FkIHN1Y2Nlc3NmdWxseVwiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHB1YmxpY0tleSA9IHRoaXMucHJvcHMuc2l0ZVB1YmxpY0tleTtcbiAgICAgICAgaWYgKCFwdWJsaWNLZXkpIHtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihcIk5vIHB1YmxpYyBrZXkgZm9yIHJlY2FwdGNoYSFcIik7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICAgICAgXCJUaGlzIHNlcnZlciBoYXMgbm90IHN1cHBsaWVkIGVub3VnaCBpbmZvcm1hdGlvbiBmb3IgUmVjYXB0Y2hhIFwiXG4gICAgICAgICAgICAgICAgKyBcImF1dGhlbnRpY2F0aW9uXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgbG9nZ2VyLmluZm8oXCJSZW5kZXJpbmcgdG8gJXNcIiwgZGl2SWQpO1xuICAgICAgICB0aGlzLmNhcHRjaGFXaWRnZXRJZCA9IGdsb2JhbC5ncmVjYXB0Y2hhLnJlbmRlcihkaXZJZCwge1xuICAgICAgICAgICAgc2l0ZWtleTogcHVibGljS2V5LFxuICAgICAgICAgICAgY2FsbGJhY2s6IHRoaXMucHJvcHMub25DYXB0Y2hhUmVzcG9uc2UsXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVzZXRSZWNhcHRjaGEoKSB7XG4gICAgICAgIGlmICh0aGlzLmNhcHRjaGFXaWRnZXRJZCkge1xuICAgICAgICAgICAgZ2xvYmFsPy5ncmVjYXB0Y2hhPy5yZXNldCh0aGlzLmNhcHRjaGFXaWRnZXRJZCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIG9uQ2FwdGNoYUxvYWRlZCgpIHtcbiAgICAgICAgbG9nZ2VyLmxvZyhcIkxvYWRlZCByZWNhcHRjaGEgc2NyaXB0LlwiKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHRoaXMucmVuZGVyUmVjYXB0Y2hhKERJVl9JRCk7XG4gICAgICAgICAgICAvLyBjbGVhciBlcnJvciBpZiByZS1yZW5kZXJlZFxuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgZXJyb3JUZXh0OiBudWxsLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBDb3VudGx5QW5hbHl0aWNzLmluc3RhbmNlLnRyYWNrKFwib25ib2FyZGluZ19ncmVjYXB0Y2hhX2xvYWRlZFwiKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgZXJyb3JUZXh0OiBlLnRvU3RyaW5nKCksXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIENvdW50bHlBbmFseXRpY3MuaW5zdGFuY2UudHJhY2soXCJvbmJvYXJkaW5nX2dyZWNhcHRjaGFfZXJyb3JcIiwgeyBlcnJvcjogZS50b1N0cmluZygpIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmVuZGVyKCkge1xuICAgICAgICBsZXQgZXJyb3IgPSBudWxsO1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5lcnJvclRleHQpIHtcbiAgICAgICAgICAgIGVycm9yID0gKFxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwiZXJyb3JcIj5cbiAgICAgICAgICAgICAgICAgICAgeyB0aGlzLnN0YXRlLmVycm9yVGV4dCB9XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXYgcmVmPXt0aGlzLnJlY2FwdGNoYUNvbnRhaW5lcn0+XG4gICAgICAgICAgICAgICAgPHA+eyBfdChcbiAgICAgICAgICAgICAgICAgICAgXCJUaGlzIGhvbWVzZXJ2ZXIgd291bGQgbGlrZSB0byBtYWtlIHN1cmUgeW91IGFyZSBub3QgYSByb2JvdC5cIixcbiAgICAgICAgICAgICAgICApIH08L3A+XG4gICAgICAgICAgICAgICAgPGRpdiBpZD17RElWX0lEfSAvPlxuICAgICAgICAgICAgICAgIHsgZXJyb3IgfVxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICk7XG4gICAgfVxufVxuIl19