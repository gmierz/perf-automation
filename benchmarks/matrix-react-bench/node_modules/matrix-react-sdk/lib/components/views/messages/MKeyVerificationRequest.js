"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _languageHandler = require("../../../languageHandler");

var _KeyVerificationStateObserver = require("../../../utils/KeyVerificationStateObserver");

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var _RightPanelStorePhases = require("../../../stores/RightPanelStorePhases");

var _actions = require("../../../dispatcher/actions");

var _EventTileBubble = _interopRequireDefault(require("./EventTileBubble"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class;

let MKeyVerificationRequest = (_dec = (0, _replaceableComponent.replaceableComponent)("views.messages.MKeyVerificationRequest"), _dec(_class = class MKeyVerificationRequest extends _react.default.Component {
  constructor(...args) {
    super(...args);
    (0, _defineProperty2.default)(this, "openRequest", () => {
      const {
        verificationRequest
      } = this.props.mxEvent;

      const member = _MatrixClientPeg.MatrixClientPeg.get().getUser(verificationRequest.otherUserId);

      _dispatcher.default.dispatch({
        action: _actions.Action.SetRightPanelPhase,
        phase: _RightPanelStorePhases.RightPanelPhases.EncryptionPanel,
        refireParams: {
          verificationRequest,
          member
        }
      });
    });
    (0, _defineProperty2.default)(this, "onRequestChanged", () => {
      this.forceUpdate();
    });
    (0, _defineProperty2.default)(this, "onAcceptClicked", async () => {
      const request = this.props.mxEvent.verificationRequest;

      if (request) {
        try {
          this.openRequest();
          await request.accept();
        } catch (err) {
          _logger.logger.error(err.message);
        }
      }
    });
    (0, _defineProperty2.default)(this, "onRejectClicked", async () => {
      const request = this.props.mxEvent.verificationRequest;

      if (request) {
        try {
          await request.cancel();
        } catch (err) {
          _logger.logger.error(err.message);
        }
      }
    });
  }

  componentDidMount() {
    const request = this.props.mxEvent.verificationRequest;

    if (request) {
      request.on("change", this.onRequestChanged);
    }
  }

  componentWillUnmount() {
    const request = this.props.mxEvent.verificationRequest;

    if (request) {
      request.off("change", this.onRequestChanged);
    }
  }

  acceptedLabel(userId) {
    const client = _MatrixClientPeg.MatrixClientPeg.get();

    const myUserId = client.getUserId();

    if (userId === myUserId) {
      return (0, _languageHandler._t)("You accepted");
    } else {
      return (0, _languageHandler._t)("%(name)s accepted", {
        name: (0, _KeyVerificationStateObserver.getNameForEventRoom)(userId, this.props.mxEvent.getRoomId())
      });
    }
  }

  cancelledLabel(userId) {
    const client = _MatrixClientPeg.MatrixClientPeg.get();

    const myUserId = client.getUserId();
    const {
      cancellationCode
    } = this.props.mxEvent.verificationRequest;
    const declined = cancellationCode === "m.user";

    if (userId === myUserId) {
      if (declined) {
        return (0, _languageHandler._t)("You declined");
      } else {
        return (0, _languageHandler._t)("You cancelled");
      }
    } else {
      if (declined) {
        return (0, _languageHandler._t)("%(name)s declined", {
          name: (0, _KeyVerificationStateObserver.getNameForEventRoom)(userId, this.props.mxEvent.getRoomId())
        });
      } else {
        return (0, _languageHandler._t)("%(name)s cancelled", {
          name: (0, _KeyVerificationStateObserver.getNameForEventRoom)(userId, this.props.mxEvent.getRoomId())
        });
      }
    }
  }

  render() {
    const {
      mxEvent
    } = this.props;
    const request = mxEvent.verificationRequest;

    if (!request || request.invalid) {
      return null;
    }

    let title;
    let subtitle;
    let stateNode;

    if (!request.canAccept) {
      let stateLabel;
      const accepted = request.ready || request.started || request.done;

      if (accepted) {
        stateLabel = /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
          onClick: this.openRequest
        }, this.acceptedLabel(request.receivingUserId));
      } else if (request.cancelled) {
        stateLabel = this.cancelledLabel(request.cancellingUserId);
      } else if (request.accepting) {
        stateLabel = (0, _languageHandler._t)("Accepting …");
      } else if (request.declining) {
        stateLabel = (0, _languageHandler._t)("Declining …");
      }

      stateNode = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_cryptoEvent_state"
      }, stateLabel);
    }

    if (!request.initiatedByMe) {
      const name = (0, _KeyVerificationStateObserver.getNameForEventRoom)(request.requestingUserId, mxEvent.getRoomId());
      title = (0, _languageHandler._t)("%(name)s wants to verify", {
        name
      });
      subtitle = (0, _KeyVerificationStateObserver.userLabelForEventRoom)(request.requestingUserId, mxEvent.getRoomId());

      if (request.canAccept) {
        stateNode = /*#__PURE__*/_react.default.createElement("div", {
          className: "mx_cryptoEvent_buttons"
        }, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
          kind: "danger",
          onClick: this.onRejectClicked
        }, (0, _languageHandler._t)("Decline")), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
          kind: "primary",
          onClick: this.onAcceptClicked
        }, (0, _languageHandler._t)("Accept")));
      }
    } else {
      // request sent by us
      title = (0, _languageHandler._t)("You sent a verification request");
      subtitle = (0, _KeyVerificationStateObserver.userLabelForEventRoom)(request.receivingUserId, mxEvent.getRoomId());
    }

    if (title) {
      return /*#__PURE__*/_react.default.createElement(_EventTileBubble.default, {
        className: "mx_cryptoEvent mx_cryptoEvent_icon",
        title: title,
        subtitle: subtitle
      }, stateNode);
    }

    return null;
  }

}) || _class);
exports.default = MKeyVerificationRequest;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL21lc3NhZ2VzL01LZXlWZXJpZmljYXRpb25SZXF1ZXN0LnRzeCJdLCJuYW1lcyI6WyJNS2V5VmVyaWZpY2F0aW9uUmVxdWVzdCIsIlJlYWN0IiwiQ29tcG9uZW50IiwidmVyaWZpY2F0aW9uUmVxdWVzdCIsInByb3BzIiwibXhFdmVudCIsIm1lbWJlciIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsImdldFVzZXIiLCJvdGhlclVzZXJJZCIsImRpcyIsImRpc3BhdGNoIiwiYWN0aW9uIiwiQWN0aW9uIiwiU2V0UmlnaHRQYW5lbFBoYXNlIiwicGhhc2UiLCJSaWdodFBhbmVsUGhhc2VzIiwiRW5jcnlwdGlvblBhbmVsIiwicmVmaXJlUGFyYW1zIiwiZm9yY2VVcGRhdGUiLCJyZXF1ZXN0Iiwib3BlblJlcXVlc3QiLCJhY2NlcHQiLCJlcnIiLCJsb2dnZXIiLCJlcnJvciIsIm1lc3NhZ2UiLCJjYW5jZWwiLCJjb21wb25lbnREaWRNb3VudCIsIm9uIiwib25SZXF1ZXN0Q2hhbmdlZCIsImNvbXBvbmVudFdpbGxVbm1vdW50Iiwib2ZmIiwiYWNjZXB0ZWRMYWJlbCIsInVzZXJJZCIsImNsaWVudCIsIm15VXNlcklkIiwiZ2V0VXNlcklkIiwibmFtZSIsImdldFJvb21JZCIsImNhbmNlbGxlZExhYmVsIiwiY2FuY2VsbGF0aW9uQ29kZSIsImRlY2xpbmVkIiwicmVuZGVyIiwiaW52YWxpZCIsInRpdGxlIiwic3VidGl0bGUiLCJzdGF0ZU5vZGUiLCJjYW5BY2NlcHQiLCJzdGF0ZUxhYmVsIiwiYWNjZXB0ZWQiLCJyZWFkeSIsInN0YXJ0ZWQiLCJkb25lIiwicmVjZWl2aW5nVXNlcklkIiwiY2FuY2VsbGVkIiwiY2FuY2VsbGluZ1VzZXJJZCIsImFjY2VwdGluZyIsImRlY2xpbmluZyIsImluaXRpYXRlZEJ5TWUiLCJyZXF1ZXN0aW5nVXNlcklkIiwib25SZWplY3RDbGlja2VkIiwib25BY2NlcHRDbGlj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QUFDQSxVQUFJbkIsT0FBTyxDQUFDNEIsU0FBWixFQUF1QjtBQUNuQkQsUUFBQUEsU0FBUyxnQkFBSTtBQUFLLFVBQUEsU0FBUyxFQUFDO0FBQWYsd0JBQ1QsNkJBQUMseUJBQUQ7QUFBa0IsVUFBQSxJQUFJLEVBQUMsUUFBdkI7QUFBZ0MsVUFBQSxPQUFPLEVBQUUsS0FBS2M7QUFBOUMsV0FDTSx5QkFBRyxTQUFILENBRE4sQ0FEUyxlQUlULDZCQUFDLHlCQUFEO0FBQWtCLFVBQUEsSUFBSSxFQUFDLFNBQXZCO0FBQWlDLFVBQUEsT0FBTyxFQUFFLEtBQUtDO0FBQS9DLFdBQ00seUJBQUcsUUFBSCxDQUROLENBSlMsQ0FBYjtBQVFIO0FBQ0osS0FkRCxNQWNPO0FBQUU7QUFDTGpCLE1BQUFBLEtBQUssR0FBRyx5QkFBRyxpQ0FBSCxDQUFSO0FBQ0FDLE1BQUFBLFFBQVEsR0FBRyx5REFBc0IxQixPQUFPLENBQUNrQyxlQUE5QixFQUErQ2xELE9BQU8sQ0FBQ21DLFNBQVIsRUFBL0MsQ0FBWDtBQUNIOztBQUVELFFBQUlNLEtBQUosRUFBVztBQUNQLDBCQUFPLDZCQUFDLHdCQUFEO0FBQ0gsUUFBQSxTQUFTLEVBQUMsb0NBRFA7QUFFSCxRQUFBLEtBQUssRUFBRUEsS0FGSjtBQUdILFFBQUEsUUFBUSxFQUFFQztBQUhQLFNBS0RDLFNBTEMsQ0FBUDtBQU9IOztBQUNELFdBQU8sSUFBUDtBQUNIOztBQTVJd0UsQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxOSwgMjAyMCBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBNYXRyaXhFdmVudCB9IGZyb20gJ21hdHJpeC1qcy1zZGsvc3JjJztcbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gJy4uLy4uLy4uL01hdHJpeENsaWVudFBlZyc7XG5pbXBvcnQgeyBfdCB9IGZyb20gJy4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlcic7XG5pbXBvcnQgeyBnZXROYW1lRm9yRXZlbnRSb29tLCB1c2VyTGFiZWxGb3JFdmVudFJvb20gfVxuICAgIGZyb20gJy4uLy4uLy4uL3V0aWxzL0tleVZlcmlmaWNhdGlvblN0YXRlT2JzZXJ2ZXInO1xuaW1wb3J0IGRpcyBmcm9tIFwiLi4vLi4vLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyXCI7XG5pbXBvcnQgeyBSaWdodFBhbmVsUGhhc2VzIH0gZnJvbSBcIi4uLy4uLy4uL3N0b3Jlcy9SaWdodFBhbmVsU3RvcmVQaGFzZXNcIjtcbmltcG9ydCB7IEFjdGlvbiB9IGZyb20gXCIuLi8uLi8uLi9kaXNwYXRjaGVyL2FjdGlvbnNcIjtcbmltcG9ydCBFdmVudFRpbGVCdWJibGUgZnJvbSBcIi4vRXZlbnRUaWxlQnViYmxlXCI7XG5pbXBvcnQgeyByZXBsYWNlYWJsZUNvbXBvbmVudCB9IGZyb20gXCIuLi8uLi8uLi91dGlscy9yZXBsYWNlYWJsZUNvbXBvbmVudFwiO1xuaW1wb3J0IEFjY2Vzc2libGVCdXR0b24gZnJvbSAnLi4vZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvbic7XG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcblxuaW50ZXJmYWNlIElQcm9wcyB7XG4gICAgbXhFdmVudDogTWF0cml4RXZlbnQ7XG59XG5cbkByZXBsYWNlYWJsZUNvbXBvbmVudChcInZpZXdzLm1lc3NhZ2VzLk1LZXlWZXJpZmljYXRpb25SZXF1ZXN0XCIpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBNS2V5VmVyaWZpY2F0aW9uUmVxdWVzdCBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxJUHJvcHM+IHtcbiAgICBwdWJsaWMgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLnByb3BzLm14RXZlbnQudmVyaWZpY2F0aW9uUmVxdWVzdDtcbiAgICAgICAgaWYgKHJlcXVlc3QpIHtcbiAgICAgICAgICAgIHJlcXVlc3Qub24oXCJjaGFuZ2VcIiwgdGhpcy5vblJlcXVlc3RDaGFuZ2VkKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICAgICAgY29uc3QgcmVxdWVzdCA9IHRoaXMucHJvcHMubXhFdmVudC52ZXJpZmljYXRpb25SZXF1ZXN0O1xuICAgICAgICBpZiAocmVxdWVzdCkge1xuICAgICAgICAgICAgcmVxdWVzdC5vZmYoXCJjaGFuZ2VcIiwgdGhpcy5vblJlcXVlc3RDaGFuZ2VkKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgb3BlblJlcXVlc3QgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHsgdmVyaWZpY2F0aW9uUmVxdWVzdCB9ID0gdGhpcy5wcm9wcy5teEV2ZW50O1xuICAgICAgICBjb25zdCBtZW1iZXIgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZ2V0VXNlcih2ZXJpZmljYXRpb25SZXF1ZXN0Lm90aGVyVXNlcklkKTtcbiAgICAgICAgZGlzLmRpc3BhdGNoKHtcbiAgICAgICAgICAgIGFjdGlvbjogQWN0aW9uLlNldFJpZ2h0UGFuZWxQaGFzZSxcbiAgICAgICAgICAgIHBoYXNlOiBSaWdodFBhbmVsUGhhc2VzLkVuY3J5cHRpb25QYW5lbCxcbiAgICAgICAgICAgIHJlZmlyZVBhcmFtczogeyB2ZXJpZmljYXRpb25SZXF1ZXN0LCBtZW1iZXIgfSxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25SZXF1ZXN0Q2hhbmdlZCA9ICgpID0+IHtcbiAgICAgICAgdGhpcy5mb3JjZVVwZGF0ZSgpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uQWNjZXB0Q2xpY2tlZCA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgcmVxdWVzdCA9IHRoaXMucHJvcHMubXhFdmVudC52ZXJpZmljYXRpb25SZXF1ZXN0O1xuICAgICAgICBpZiAocmVxdWVzdCkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICB0aGlzLm9wZW5SZXF1ZXN0KCk7XG4gICAgICAgICAgICAgICAgYXdhaXQgcmVxdWVzdC5hY2NlcHQoKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihlcnIubWVzc2FnZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvblJlamVjdENsaWNrZWQgPSBhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLnByb3BzLm14RXZlbnQudmVyaWZpY2F0aW9uUmVxdWVzdDtcbiAgICAgICAgaWYgKHJlcXVlc3QpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgcmVxdWVzdC5jYW5jZWwoKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihlcnIubWVzc2FnZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBhY2NlcHRlZExhYmVsKHVzZXJJZDogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IGNsaWVudCA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICAgICAgY29uc3QgbXlVc2VySWQgPSBjbGllbnQuZ2V0VXNlcklkKCk7XG4gICAgICAgIGlmICh1c2VySWQgPT09IG15VXNlcklkKSB7XG4gICAgICAgICAgICByZXR1cm4gX3QoXCJZb3UgYWNjZXB0ZWRcIik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gX3QoXCIlKG5hbWUpcyBhY2NlcHRlZFwiLCB7IG5hbWU6IGdldE5hbWVGb3JFdmVudFJvb20odXNlcklkLCB0aGlzLnByb3BzLm14RXZlbnQuZ2V0Um9vbUlkKCkpIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjYW5jZWxsZWRMYWJlbCh1c2VySWQ6IHN0cmluZykge1xuICAgICAgICBjb25zdCBjbGllbnQgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIGNvbnN0IG15VXNlcklkID0gY2xpZW50LmdldFVzZXJJZCgpO1xuICAgICAgICBjb25zdCB7IGNhbmNlbGxhdGlvbkNvZGUgfSA9IHRoaXMucHJvcHMubXhFdmVudC52ZXJpZmljYXRpb25SZXF1ZXN0O1xuICAgICAgICBjb25zdCBkZWNsaW5lZCA9IGNhbmNlbGxhdGlvbkNvZGUgPT09IFwibS51c2VyXCI7XG4gICAgICAgIGlmICh1c2VySWQgPT09IG15VXNlcklkKSB7XG4gICAgICAgICAgICBpZiAoZGVjbGluZWQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gX3QoXCJZb3UgZGVjbGluZWRcIik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBfdChcIllvdSBjYW5jZWxsZWRcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoZGVjbGluZWQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gX3QoXCIlKG5hbWUpcyBkZWNsaW5lZFwiLCB7IG5hbWU6IGdldE5hbWVGb3JFdmVudFJvb20odXNlcklkLCB0aGlzLnByb3BzLm14RXZlbnQuZ2V0Um9vbUlkKCkpIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gX3QoXCIlKG5hbWUpcyBjYW5jZWxsZWRcIiwgeyBuYW1lOiBnZXROYW1lRm9yRXZlbnRSb29tKHVzZXJJZCwgdGhpcy5wcm9wcy5teEV2ZW50LmdldFJvb21JZCgpKSB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyByZW5kZXIoKSB7XG4gICAgICAgIGNvbnN0IHsgbXhFdmVudCB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgcmVxdWVzdCA9IG14RXZlbnQudmVyaWZpY2F0aW9uUmVxdWVzdDtcblxuICAgICAgICBpZiAoIXJlcXVlc3QgfHwgcmVxdWVzdC5pbnZhbGlkKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCB0aXRsZTtcbiAgICAgICAgbGV0IHN1YnRpdGxlO1xuICAgICAgICBsZXQgc3RhdGVOb2RlO1xuXG4gICAgICAgIGlmICghcmVxdWVzdC5jYW5BY2NlcHQpIHtcbiAgICAgICAgICAgIGxldCBzdGF0ZUxhYmVsO1xuICAgICAgICAgICAgY29uc3QgYWNjZXB0ZWQgPSByZXF1ZXN0LnJlYWR5IHx8IHJlcXVlc3Quc3RhcnRlZCB8fCByZXF1ZXN0LmRvbmU7XG4gICAgICAgICAgICBpZiAoYWNjZXB0ZWQpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZUxhYmVsID0gKDxBY2Nlc3NpYmxlQnV0dG9uIG9uQ2xpY2s9e3RoaXMub3BlblJlcXVlc3R9PlxuICAgICAgICAgICAgICAgICAgICB7IHRoaXMuYWNjZXB0ZWRMYWJlbChyZXF1ZXN0LnJlY2VpdmluZ1VzZXJJZCkgfVxuICAgICAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj4pO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChyZXF1ZXN0LmNhbmNlbGxlZCkge1xuICAgICAgICAgICAgICAgIHN0YXRlTGFiZWwgPSB0aGlzLmNhbmNlbGxlZExhYmVsKHJlcXVlc3QuY2FuY2VsbGluZ1VzZXJJZCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHJlcXVlc3QuYWNjZXB0aW5nKSB7XG4gICAgICAgICAgICAgICAgc3RhdGVMYWJlbCA9IF90KFwiQWNjZXB0aW5nIOKAplwiKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAocmVxdWVzdC5kZWNsaW5pbmcpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZUxhYmVsID0gX3QoXCJEZWNsaW5pbmcg4oCmXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc3RhdGVOb2RlID0gKDxkaXYgY2xhc3NOYW1lPVwibXhfY3J5cHRvRXZlbnRfc3RhdGVcIj57IHN0YXRlTGFiZWwgfTwvZGl2Pik7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXJlcXVlc3QuaW5pdGlhdGVkQnlNZSkge1xuICAgICAgICAgICAgY29uc3QgbmFtZSA9IGdldE5hbWVGb3JFdmVudFJvb20ocmVxdWVzdC5yZXF1ZXN0aW5nVXNlcklkLCBteEV2ZW50LmdldFJvb21JZCgpKTtcbiAgICAgICAgICAgIHRpdGxlID0gX3QoXCIlKG5hbWUpcyB3YW50cyB0byB2ZXJpZnlcIiwgeyBuYW1lIH0pO1xuICAgICAgICAgICAgc3VidGl0bGUgPSB1c2VyTGFiZWxGb3JFdmVudFJvb20ocmVxdWVzdC5yZXF1ZXN0aW5nVXNlcklkLCBteEV2ZW50LmdldFJvb21JZCgpKTtcbiAgICAgICAgICAgIGlmIChyZXF1ZXN0LmNhbkFjY2VwdCkge1xuICAgICAgICAgICAgICAgIHN0YXRlTm9kZSA9ICg8ZGl2IGNsYXNzTmFtZT1cIm14X2NyeXB0b0V2ZW50X2J1dHRvbnNcIj5cbiAgICAgICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b24ga2luZD1cImRhbmdlclwiIG9uQ2xpY2s9e3RoaXMub25SZWplY3RDbGlja2VkfT5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCJEZWNsaW5lXCIpIH1cbiAgICAgICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvbiBraW5kPVwicHJpbWFyeVwiIG9uQ2xpY2s9e3RoaXMub25BY2NlcHRDbGlja2VkfT5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCJBY2NlcHRcIikgfVxuICAgICAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICAgICAgPC9kaXY+KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHsgLy8gcmVxdWVzdCBzZW50IGJ5IHVzXG4gICAgICAgICAgICB0aXRsZSA9IF90KFwiWW91IHNlbnQgYSB2ZXJpZmljYXRpb24gcmVxdWVzdFwiKTtcbiAgICAgICAgICAgIHN1YnRpdGxlID0gdXNlckxhYmVsRm9yRXZlbnRSb29tKHJlcXVlc3QucmVjZWl2aW5nVXNlcklkLCBteEV2ZW50LmdldFJvb21JZCgpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aXRsZSkge1xuICAgICAgICAgICAgcmV0dXJuIDxFdmVudFRpbGVCdWJibGVcbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9jcnlwdG9FdmVudCBteF9jcnlwdG9FdmVudF9pY29uXCJcbiAgICAgICAgICAgICAgICB0aXRsZT17dGl0bGV9XG4gICAgICAgICAgICAgICAgc3VidGl0bGU9e3N1YnRpdGxlfVxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgIHsgc3RhdGVOb2RlIH1cbiAgICAgICAgICAgIDwvRXZlbnRUaWxlQnViYmxlPjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG59XG4iXX0=