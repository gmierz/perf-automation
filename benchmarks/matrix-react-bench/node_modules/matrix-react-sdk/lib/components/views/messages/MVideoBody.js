"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _blurhash = require("blurhash");

var _languageHandler = require("../../../languageHandler");

var _SettingsStore = _interopRequireDefault(require("../../../settings/SettingsStore"));

var _InlineSpinner = _interopRequireDefault(require("../elements/InlineSpinner"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _Media = require("../../../customisations/Media");

var _ContentMessages = require("../../../ContentMessages");

var _MFileBody = _interopRequireDefault(require("./MFileBody"));

var _logger = require("matrix-js-sdk/src/logger");

var _ImageSize = require("../../../settings/enums/ImageSize");

var _dec, _class;

let MVideoBody = (_dec = (0, _replaceableComponent.replaceableComponent)("views.messages.MVideoBody"), _dec(_class = class MVideoBody extends _react.default.PureComponent {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "videoRef", /*#__PURE__*/_react.default.createRef());
    (0, _defineProperty2.default)(this, "sizeWatcher", void 0);
    (0, _defineProperty2.default)(this, "videoOnPlay", async () => {
      if (this.hasContentUrl() || this.state.fetchingData || this.state.error) {
        // We have the file, we are fetching the file, or there is an error.
        return;
      }

      this.setState({
        // To stop subsequent download attempts
        fetchingData: true
      });

      if (!this.props.mediaEventHelper.media.isEncrypted) {
        this.setState({
          error: "No file given in content"
        });
        return;
      }

      this.setState({
        decryptedUrl: await this.props.mediaEventHelper.sourceUrl.value,
        decryptedBlob: await this.props.mediaEventHelper.sourceBlob.value,
        fetchingData: false
      }, () => {
        if (!this.videoRef.current) return;
        this.videoRef.current.play();
      });
      this.props.onHeightChanged();
    });
    (0, _defineProperty2.default)(this, "getFileBody", () => {
      if (this.props.forExport) return null;
      return this.props.tileShape && /*#__PURE__*/_react.default.createElement(_MFileBody.default, (0, _extends2.default)({}, this.props, {
        showGenericPlaceholder: false
      }));
    });
    this.state = {
      fetchingData: false,
      decryptedUrl: null,
      decryptedThumbnailUrl: null,
      decryptedBlob: null,
      error: null,
      posterLoading: false,
      blurhashUrl: null
    };
  }

  suggestedDimensions(isPortrait) {
    return (0, _ImageSize.suggestedSize)(_SettingsStore.default.getValue("Images.size"));
  }

  thumbScale(fullWidth, fullHeight, thumbWidth, thumbHeight) {
    if (!fullWidth || !fullHeight) {
      // Cannot calculate thumbnail height for image: missing w/h in metadata. We can't even
      // log this because it's spammy
      return undefined;
    }

    if (!thumbWidth || !thumbHeight) {
      const dims = this.suggestedDimensions(fullWidth < fullHeight);
      thumbWidth = dims.w;
      thumbHeight = dims.h;
    }

    if (fullWidth < thumbWidth && fullHeight < thumbHeight) {
      // no scaling needs to be applied
      return 1;
    } // always scale the videos based on their width.


    const widthMulti = thumbWidth / fullWidth;
    return widthMulti;
  }

  getContentUrl() {
    var _content$file;

    const content = this.props.mxEvent.getContent(); // During export, the content url will point to the MSC, which will later point to a local url

    if (this.props.forExport) return ((_content$file = content.file) === null || _content$file === void 0 ? void 0 : _content$file.url) || content.url;
    const media = (0, _Media.mediaFromContent)(content);

    if (media.isEncrypted) {
      return this.state.decryptedUrl;
    } else {
      return media.srcHttp;
    }
  }

  hasContentUrl() {
    const url = this.getContentUrl();
    return url && !url.startsWith("data:");
  }

  getThumbUrl() {
    // there's no need of thumbnail when the content is local
    if (this.props.forExport) return null;
    const content = this.props.mxEvent.getContent();
    const media = (0, _Media.mediaFromContent)(content);

    if (media.isEncrypted && this.state.decryptedThumbnailUrl) {
      return this.state.decryptedThumbnailUrl;
    } else if (this.state.posterLoading) {
      return this.state.blurhashUrl;
    } else if (media.hasThumbnail) {
      return media.thumbnailHttp;
    } else {
      return null;
    }
  }

  loadBlurhash() {
    var _this$props$mxEvent$g;

    const info = (_this$props$mxEvent$g = this.props.mxEvent.getContent()) === null || _this$props$mxEvent$g === void 0 ? void 0 : _this$props$mxEvent$g.info;
    if (!info[_ContentMessages.BLURHASH_FIELD]) return;
    const canvas = document.createElement("canvas");
    let width = info.w;
    let height = info.h;
    const scale = this.thumbScale(info.w, info.h);

    if (scale) {
      width = Math.floor(info.w * scale);
      height = Math.floor(info.h * scale);
    }

    canvas.width = width;
    canvas.height = height;
    const pixels = (0, _blurhash.decode)(info[_ContentMessages.BLURHASH_FIELD], width, height);
    const ctx = canvas.getContext("2d");
    const imgData = ctx.createImageData(width, height);
    imgData.data.set(pixels);
    ctx.putImageData(imgData, 0, 0);
    this.setState({
      blurhashUrl: canvas.toDataURL(),
      posterLoading: true
    });
    const content = this.props.mxEvent.getContent();
    const media = (0, _Media.mediaFromContent)(content);

    if (media.hasThumbnail) {
      const image = new Image();

      image.onload = () => {
        this.setState({
          posterLoading: false
        });
      };

      image.src = media.thumbnailHttp;
    }
  }

  async componentDidMount() {
    this.sizeWatcher = _SettingsStore.default.watchSetting("Images.size", null, () => {
      this.forceUpdate(); // we don't really have a reliable thing to update, so just update the whole thing
    });
    this.loadBlurhash();

    if (this.props.mediaEventHelper.media.isEncrypted && this.state.decryptedUrl === null) {
      try {
        const autoplay = _SettingsStore.default.getValue("autoplayVideo");

        const thumbnailUrl = await this.props.mediaEventHelper.thumbnailUrl.value;

        if (autoplay) {
          _logger.logger.log("Preloading video");

          this.setState({
            decryptedUrl: await this.props.mediaEventHelper.sourceUrl.value,
            decryptedThumbnailUrl: thumbnailUrl,
            decryptedBlob: await this.props.mediaEventHelper.sourceBlob.value
          });
          this.props.onHeightChanged();
        } else {
          var _content$info, _content$info2;

          _logger.logger.log("NOT preloading video");

          const content = this.props.mxEvent.getContent();
          this.setState({
            // For Chrome and Electron, we need to set some non-empty `src` to
            // enable the play button. Firefox does not seem to care either
            // way, so it's fine to do for all browsers.
            decryptedUrl: `data:${content === null || content === void 0 ? void 0 : (_content$info = content.info) === null || _content$info === void 0 ? void 0 : _content$info.mimetype},`,
            decryptedThumbnailUrl: thumbnailUrl || `data:${content === null || content === void 0 ? void 0 : (_content$info2 = content.info) === null || _content$info2 === void 0 ? void 0 : _content$info2.mimetype},`,
            decryptedBlob: null
          });
        }
      } catch (err) {
        _logger.logger.warn("Unable to decrypt attachment: ", err); // Set a placeholder image when we can't decrypt the image.


        this.setState({
          error: err
        });
      }
    }
  }

  componentWillUnmount() {
    _SettingsStore.default.unwatchSetting(this.sizeWatcher);
  }

  render() {
    const content = this.props.mxEvent.getContent();

    const autoplay = _SettingsStore.default.getValue("autoplayVideo");

    if (this.state.error !== null) {
      return /*#__PURE__*/_react.default.createElement("span", {
        className: "mx_MVideoBody"
      }, /*#__PURE__*/_react.default.createElement("img", {
        src: require("../../../../res/img/warning.svg"),
        width: "16",
        height: "16"
      }), (0, _languageHandler._t)("Error decrypting video"));
    } // Important: If we aren't autoplaying and we haven't decrypted it yet, show a video with a poster.


    if (!this.props.forExport && content.file !== undefined && this.state.decryptedUrl === null && autoplay) {
      // Need to decrypt the attachment
      // The attachment is decrypted in componentDidMount.
      // For now add an img tag with a spinner.
      return /*#__PURE__*/_react.default.createElement("span", {
        className: "mx_MVideoBody"
      }, /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_MImageBody_thumbnail mx_MImageBody_thumbnail_spinner"
      }, /*#__PURE__*/_react.default.createElement(_InlineSpinner.default, null)));
    }

    const contentUrl = this.getContentUrl();
    const thumbUrl = this.getThumbUrl();
    const defaultDims = this.suggestedDimensions(false);
    let height = defaultDims.h;
    let width = defaultDims.w;
    let poster = null;
    let preload = "metadata";

    if (content.info) {
      const scale = this.thumbScale(content.info.w, content.info.h);

      if (scale) {
        width = Math.floor(content.info.w * scale);
        height = Math.floor(content.info.h * scale);
      }

      if (thumbUrl) {
        poster = thumbUrl;
        preload = "none";
      }
    }

    const fileBody = this.getFileBody();
    return /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_MVideoBody"
    }, /*#__PURE__*/_react.default.createElement("video", {
      className: "mx_MVideoBody",
      ref: this.videoRef,
      src: contentUrl,
      title: content.body,
      controls: true,
      preload: preload,
      muted: autoplay,
      autoPlay: autoplay,
      height: height,
      width: width,
      poster: poster,
      onPlay: this.videoOnPlay
    }), fileBody);
  }

}) || _class);
exports.default = MVideoBody;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL21lc3NhZ2VzL01WaWRlb0JvZHkudHN4Il0sIm5hbWVzIjpbIk1WaWRlb0JvZHkiLCJSZWFjdCIsIlB1cmVDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwiY3JlYXRlUmVmIiwiaGFzQ29udGVudFVybCIsInN0YXRlIiwiZmV0Y2hpbmdEYXRhIiwiZXJyb3IiLCJzZXRTdGF0ZSIsIm1lZGlhRXZlbnRIZWxwZXIiLCJtZWRpYSIsImlzRW5jcnlwdGVkIiwiZGVjcnlwdGVkVXJsIiwic291cmNlVXJsIiwidmFsdWUiLCJkZWNyeXB0ZWRCbG9iIiwic291cmNlQmxvYiIsInZpZGVvUmVmIiwiY3VycmVudCIsInBsYXkiLCJvbkhlaWdodENoYW5nZWQiLCJmb3JFeHBvcnQiLCJ0aWxlU2hhcGUiLCJkZWNyeXB0ZWRUaHVtYm5haWxVcmwiLCJwb3N0ZXJMb2FkaW5nIiwiYmx1cmhhc2hVcmwiLCJzdWdnZXN0ZWREaW1lbnNpb25zIiwiaXNQb3J0cmFpdCIsIlNldHRpbmdzU3RvcmUiLCJnZXRWYWx1ZSIsInRodW1iU2NhbGUiLCJmdWxsV2lkdGgiLCJmdWxsSGVpZ2h0IiwidGh1bWJXaWR0aCIsInRodW1iSGVpZ2h0IiwidW5kZWZpbmVkIiwiZGltcyIsInciLCJoIiwid2lkdGhNdWx0aSIsImdldENvbnRlbnRVcmwiLCJjb250ZW50IiwibXhFdmVudCIsImdldENvbnRlbnQiLCJmaWxlIiwidXJsIiwic3JjSHR0cCIsInN0YXJ0c1dpdGgiLCJnZXRUaHVtYlVybCIsImhhc1RodW1ibmFpbCIsInRodW1ibmFpbEh0dHAiLCJsb2FkQmx1cmhhc2giLCJpbmZvIiwiQkxVUkhBU0hfRklFTEQiLCJjYW52YXMiLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJ3aWR0aCIsImhlaWdodCIsInNjYWxlIiwiTWF0aCIsImZsb29yIiwicGl4ZWxzIiwiY3R4IiwiZ2V0Q29udGV4dCIsImltZ0RhdGEiLCJjcmVhdGVJbWFnZURhdGEiLCJkYXRhIiwic2V0IiwicHV0SW1hZ2VEYXRhIiwidG9EYXRhVVJMIiwiaW1hZ2UiLCJJbWFnZSIsIm9ubG9hZCIsInNyYyIsImNvbXBvbmVudERpZE1vdW50Iiwic2l6ZVdhdGNoZXIiLCJ3YXRjaFNldHRpbmciLCJmb3JjZVVwZGF0ZSIsImF1dG9wbGF5IiwidGh1bWJuYWlsVXJsIiwibG9nZ2VyIiwibG9nIiwibWltZXR5cGUiLCJlcnIiLCJ3YXJuIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJ1bndhdGNoU2V0dGluZyIsInJlbmRlciIsInJlcXVpcmUiLCJjb250ZW50VXJsIiwidGh1bWJVcmwiLCJkZWZhdWx0RGltcyIsInBvc3RlciIsInByZWxvYWQiLCJmaWxlQm9keSIsImdldEZpbGVCb2R5IiwiYm9keSIsInZpZGVvT25QbGF5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBOztBQUVBOztBQUNBOzs7O0lBYXFCQSxVLFdBRHBCLGdEQUFxQiwyQkFBckIsQyxnQkFBRCxNQUNxQkEsVUFEckIsU0FDd0NDLGVBQU1DLGFBRDlDLENBQ2dGO0FBSTVFQyxFQUFBQSxXQUFXLENBQUNDLEtBQUQsRUFBUTtBQUNmLFVBQU1BLEtBQU47QUFEZSxpRUFIQUgsZUFBTUksU0FBTixFQUdBO0FBQUE7QUFBQSx1REFxS0csWUFBWTtBQUM5QixVQUFJLEtBQUtDLGFBQUwsTUFBd0IsS0FBS0MsS0FBTCxDQUFXQyxZQUFuQyxJQUFtRCxLQUFLRCxLQUFMLENBQVdFLEtBQWxFLEVBQXlFO0FBQ3JFO0FBQ0E7QUFDSDs7QUFDRCxXQUFLQyxRQUFMLENBQWM7QUFDVjtBQUNBRixRQUFBQSxZQUFZLEVBQUU7QUFGSixPQUFkOztBQUlBLFVBQUksQ0FBQyxLQUFLSixLQUFMLENBQVdPLGdCQUFYLENBQTRCQyxLQUE1QixDQUFrQ0MsV0FBdkMsRUFBb0Q7QUFDaEQsYUFBS0gsUUFBTCxD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Q0FBYixHQUFpQnNCLEtBQTVCLENBQVI7QUFDQUQsUUFBQUEsTUFBTSxHQUFHRSxJQUFJLENBQUNDLEtBQUwsQ0FBV3BCLE9BQU8sQ0FBQ1csSUFBUixDQUFhZCxDQUFiLEdBQWlCcUIsS0FBNUIsQ0FBVDtBQUNIOztBQUVELFVBQUlnQyxRQUFKLEVBQWM7QUFDVkUsUUFBQUEsTUFBTSxHQUFHRixRQUFUO0FBQ0FHLFFBQUFBLE9BQU8sR0FBRyxNQUFWO0FBQ0g7QUFDSjs7QUFFRCxVQUFNQyxRQUFRLEdBQUcsS0FBS0MsV0FBTCxFQUFqQjtBQUNBLHdCQUNJO0FBQU0sTUFBQSxTQUFTLEVBQUM7QUFBaEIsb0JBQ0k7QUFDSSxNQUFBLFNBQVMsRUFBQyxlQURkO0FBRUksTUFBQSxHQUFHLEVBQUUsS0FBSy9FLFFBRmQ7QUFHSSxNQUFBLEdBQUcsRUFBRXlFLFVBSFQ7QUFJSSxNQUFBLEtBQUssRUFBRWpELE9BQU8sQ0FBQ3dELElBSm5CO0FBS0ksTUFBQSxRQUFRLE1BTFo7QUFNSSxNQUFBLE9BQU8sRUFBRUgsT0FOYjtBQU9JLE1BQUEsS0FBSyxFQUFFZixRQVBYO0FBUUksTUFBQSxRQUFRLEVBQUVBLFFBUmQ7QUFTSSxNQUFBLE1BQU0sRUFBRXJCLE1BVFo7QUFVSSxNQUFBLEtBQUssRUFBRUQsS0FWWDtBQVdJLE1BQUEsTUFBTSxFQUFFb0MsTUFYWjtBQVlJLE1BQUEsTUFBTSxFQUFFLEtBQUtLO0FBWmpCLE1BREosRUFlTUgsUUFmTixDQURKO0FBbUJIOztBQTNRMkUsQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNSAtIDIwMjEgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgZGVjb2RlIH0gZnJvbSBcImJsdXJoYXNoXCI7XG5cbmltcG9ydCB7IF90IH0gZnJvbSAnLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyJztcbmltcG9ydCBTZXR0aW5nc1N0b3JlIGZyb20gXCIuLi8uLi8uLi9zZXR0aW5ncy9TZXR0aW5nc1N0b3JlXCI7XG5pbXBvcnQgSW5saW5lU3Bpbm5lciBmcm9tICcuLi9lbGVtZW50cy9JbmxpbmVTcGlubmVyJztcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5pbXBvcnQgeyBtZWRpYUZyb21Db250ZW50IH0gZnJvbSBcIi4uLy4uLy4uL2N1c3RvbWlzYXRpb25zL01lZGlhXCI7XG5pbXBvcnQgeyBCTFVSSEFTSF9GSUVMRCB9IGZyb20gXCIuLi8uLi8uLi9Db250ZW50TWVzc2FnZXNcIjtcbmltcG9ydCB7IElNZWRpYUV2ZW50Q29udGVudCB9IGZyb20gXCIuLi8uLi8uLi9jdXN0b21pc2F0aW9ucy9tb2RlbHMvSU1lZGlhRXZlbnRDb250ZW50XCI7XG5pbXBvcnQgeyBJQm9keVByb3BzIH0gZnJvbSBcIi4vSUJvZHlQcm9wc1wiO1xuaW1wb3J0IE1GaWxlQm9keSBmcm9tIFwiLi9NRmlsZUJvZHlcIjtcblxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2xvZ2dlclwiO1xuaW1wb3J0IHsgSW1hZ2VTaXplLCBzdWdnZXN0ZWRTaXplIGFzIHN1Z2dlc3RlZFZpZGVvU2l6ZSB9IGZyb20gXCIuLi8uLi8uLi9zZXR0aW5ncy9lbnVtcy9JbWFnZVNpemVcIjtcblxuaW50ZXJmYWNlIElTdGF0ZSB7XG4gICAgZGVjcnlwdGVkVXJsPzogc3RyaW5nO1xuICAgIGRlY3J5cHRlZFRodW1ibmFpbFVybD86IHN0cmluZztcbiAgICBkZWNyeXB0ZWRCbG9iPzogQmxvYjtcbiAgICBlcnJvcj86IGFueTtcbiAgICBmZXRjaGluZ0RhdGE6IGJvb2xlYW47XG4gICAgcG9zdGVyTG9hZGluZzogYm9vbGVhbjtcbiAgICBibHVyaGFzaFVybDogc3RyaW5nO1xufVxuXG5AcmVwbGFjZWFibGVDb21wb25lbnQoXCJ2aWV3cy5tZXNzYWdlcy5NVmlkZW9Cb2R5XCIpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBNVmlkZW9Cb2R5IGV4dGVuZHMgUmVhY3QuUHVyZUNvbXBvbmVudDxJQm9keVByb3BzLCBJU3RhdGU+IHtcbiAgICBwcml2YXRlIHZpZGVvUmVmID0gUmVhY3QuY3JlYXRlUmVmPEhUTUxWaWRlb0VsZW1lbnQ+KCk7XG4gICAgcHJpdmF0ZSBzaXplV2F0Y2hlcjogc3RyaW5nO1xuXG4gICAgY29uc3RydWN0b3IocHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuXG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICBmZXRjaGluZ0RhdGE6IGZhbHNlLFxuICAgICAgICAgICAgZGVjcnlwdGVkVXJsOiBudWxsLFxuICAgICAgICAgICAgZGVjcnlwdGVkVGh1bWJuYWlsVXJsOiBudWxsLFxuICAgICAgICAgICAgZGVjcnlwdGVkQmxvYjogbnVsbCxcbiAgICAgICAgICAgIGVycm9yOiBudWxsLFxuICAgICAgICAgICAgcG9zdGVyTG9hZGluZzogZmFsc2UsXG4gICAgICAgICAgICBibHVyaGFzaFVybDogbnVsbCxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN1Z2dlc3RlZERpbWVuc2lvbnMoaXNQb3J0cmFpdCk6IHsgdzogbnVtYmVyLCBoOiBudW1iZXIgfSB7XG4gICAgICAgIHJldHVybiBzdWdnZXN0ZWRWaWRlb1NpemUoU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcIkltYWdlcy5zaXplXCIpIGFzIEltYWdlU2l6ZSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB0aHVtYlNjYWxlKFxuICAgICAgICBmdWxsV2lkdGg6IG51bWJlcixcbiAgICAgICAgZnVsbEhlaWdodDogbnVtYmVyLFxuICAgICAgICB0aHVtYldpZHRoPzogbnVtYmVyLFxuICAgICAgICB0aHVtYkhlaWdodD86IG51bWJlcixcbiAgICApOiBudW1iZXIge1xuICAgICAgICBpZiAoIWZ1bGxXaWR0aCB8fCAhZnVsbEhlaWdodCkge1xuICAgICAgICAgICAgLy8gQ2Fubm90IGNhbGN1bGF0ZSB0aHVtYm5haWwgaGVpZ2h0IGZvciBpbWFnZTogbWlzc2luZyB3L2ggaW4gbWV0YWRhdGEuIFdlIGNhbid0IGV2ZW5cbiAgICAgICAgICAgIC8vIGxvZyB0aGlzIGJlY2F1c2UgaXQncyBzcGFtbXlcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXRodW1iV2lkdGggfHwgIXRodW1iSGVpZ2h0KSB7XG4gICAgICAgICAgICBjb25zdCBkaW1zID0gdGhpcy5zdWdnZXN0ZWREaW1lbnNpb25zKGZ1bGxXaWR0aCA8IGZ1bGxIZWlnaHQpO1xuICAgICAgICAgICAgdGh1bWJXaWR0aCA9IGRpbXMudztcbiAgICAgICAgICAgIHRodW1iSGVpZ2h0ID0gZGltcy5oO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGZ1bGxXaWR0aCA8IHRodW1iV2lkdGggJiYgZnVsbEhlaWdodCA8IHRodW1iSGVpZ2h0KSB7XG4gICAgICAgICAgICAvLyBubyBzY2FsaW5nIG5lZWRzIHRvIGJlIGFwcGxpZWRcbiAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gYWx3YXlzIHNjYWxlIHRoZSB2aWRlb3MgYmFzZWQgb24gdGhlaXIgd2lkdGguXG4gICAgICAgIGNvbnN0IHdpZHRoTXVsdGkgPSB0aHVtYldpZHRoIC8gZnVsbFdpZHRoO1xuICAgICAgICByZXR1cm4gd2lkdGhNdWx0aTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldENvbnRlbnRVcmwoKTogc3RyaW5nfG51bGwge1xuICAgICAgICBjb25zdCBjb250ZW50ID0gdGhpcy5wcm9wcy5teEV2ZW50LmdldENvbnRlbnQ8SU1lZGlhRXZlbnRDb250ZW50PigpO1xuICAgICAgICAvLyBEdXJpbmcgZXhwb3J0LCB0aGUgY29udGVudCB1cmwgd2lsbCBwb2ludCB0byB0aGUgTVNDLCB3aGljaCB3aWxsIGxhdGVyIHBvaW50IHRvIGEgbG9jYWwgdXJsXG4gICAgICAgIGlmICh0aGlzLnByb3BzLmZvckV4cG9ydCkgcmV0dXJuIGNvbnRlbnQuZmlsZT8udXJsIHx8IGNvbnRlbnQudXJsO1xuICAgICAgICBjb25zdCBtZWRpYSA9IG1lZGlhRnJvbUNvbnRlbnQoY29udGVudCk7XG4gICAgICAgIGlmIChtZWRpYS5pc0VuY3J5cHRlZCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGUuZGVjcnlwdGVkVXJsO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIG1lZGlhLnNyY0h0dHA7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGhhc0NvbnRlbnRVcmwoKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IHVybCA9IHRoaXMuZ2V0Q29udGVudFVybCgpO1xuICAgICAgICByZXR1cm4gdXJsICYmICF1cmwuc3RhcnRzV2l0aChcImRhdGE6XCIpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0VGh1bWJVcmwoKTogc3RyaW5nfG51bGwge1xuICAgICAgICAvLyB0aGVyZSdzIG5vIG5lZWQgb2YgdGh1bWJuYWlsIHdoZW4gdGhlIGNvbnRlbnQgaXMgbG9jYWxcbiAgICAgICAgaWYgKHRoaXMucHJvcHMuZm9yRXhwb3J0KSByZXR1cm4gbnVsbDtcblxuICAgICAgICBjb25zdCBjb250ZW50ID0gdGhpcy5wcm9wcy5teEV2ZW50LmdldENvbnRlbnQ8SU1lZGlhRXZlbnRDb250ZW50PigpO1xuICAgICAgICBjb25zdCBtZWRpYSA9IG1lZGlhRnJvbUNvbnRlbnQoY29udGVudCk7XG5cbiAgICAgICAgaWYgKG1lZGlhLmlzRW5jcnlwdGVkICYmIHRoaXMuc3RhdGUuZGVjcnlwdGVkVGh1bWJuYWlsVXJsKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZS5kZWNyeXB0ZWRUaHVtYm5haWxVcmw7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5zdGF0ZS5wb3N0ZXJMb2FkaW5nKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZS5ibHVyaGFzaFVybDtcbiAgICAgICAgfSBlbHNlIGlmIChtZWRpYS5oYXNUaHVtYm5haWwpIHtcbiAgICAgICAgICAgIHJldHVybiBtZWRpYS50aHVtYm5haWxIdHRwO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGxvYWRCbHVyaGFzaCgpIHtcbiAgICAgICAgY29uc3QgaW5mbyA9IHRoaXMucHJvcHMubXhFdmVudC5nZXRDb250ZW50KCk/LmluZm87XG4gICAgICAgIGlmICghaW5mb1tCTFVSSEFTSF9GSUVMRF0pIHJldHVybjtcblxuICAgICAgICBjb25zdCBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiY2FudmFzXCIpO1xuXG4gICAgICAgIGxldCB3aWR0aCA9IGluZm8udztcbiAgICAgICAgbGV0IGhlaWdodCA9IGluZm8uaDtcbiAgICAgICAgY29uc3Qgc2NhbGUgPSB0aGlzLnRodW1iU2NhbGUoaW5mby53LCBpbmZvLmgpO1xuICAgICAgICBpZiAoc2NhbGUpIHtcbiAgICAgICAgICAgIHdpZHRoID0gTWF0aC5mbG9vcihpbmZvLncgKiBzY2FsZSk7XG4gICAgICAgICAgICBoZWlnaHQgPSBNYXRoLmZsb29yKGluZm8uaCAqIHNjYWxlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNhbnZhcy53aWR0aCA9IHdpZHRoO1xuICAgICAgICBjYW52YXMuaGVpZ2h0ID0gaGVpZ2h0O1xuXG4gICAgICAgIGNvbnN0IHBpeGVscyA9IGRlY29kZShpbmZvW0JMVVJIQVNIX0ZJRUxEXSwgd2lkdGgsIGhlaWdodCk7XG4gICAgICAgIGNvbnN0IGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KFwiMmRcIik7XG4gICAgICAgIGNvbnN0IGltZ0RhdGEgPSBjdHguY3JlYXRlSW1hZ2VEYXRhKHdpZHRoLCBoZWlnaHQpO1xuICAgICAgICBpbWdEYXRhLmRhdGEuc2V0KHBpeGVscyk7XG4gICAgICAgIGN0eC5wdXRJbWFnZURhdGEoaW1nRGF0YSwgMCwgMCk7XG5cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBibHVyaGFzaFVybDogY2FudmFzLnRvRGF0YVVSTCgpLFxuICAgICAgICAgICAgcG9zdGVyTG9hZGluZzogdHJ1ZSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgY29udGVudCA9IHRoaXMucHJvcHMubXhFdmVudC5nZXRDb250ZW50PElNZWRpYUV2ZW50Q29udGVudD4oKTtcbiAgICAgICAgY29uc3QgbWVkaWEgPSBtZWRpYUZyb21Db250ZW50KGNvbnRlbnQpO1xuICAgICAgICBpZiAobWVkaWEuaGFzVGh1bWJuYWlsKSB7XG4gICAgICAgICAgICBjb25zdCBpbWFnZSA9IG5ldyBJbWFnZSgpO1xuICAgICAgICAgICAgaW1hZ2Uub25sb2FkID0gKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBwb3N0ZXJMb2FkaW5nOiBmYWxzZSB9KTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBpbWFnZS5zcmMgPSBtZWRpYS50aHVtYm5haWxIdHRwO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgICAgICB0aGlzLnNpemVXYXRjaGVyID0gU2V0dGluZ3NTdG9yZS53YXRjaFNldHRpbmcoXCJJbWFnZXMuc2l6ZVwiLCBudWxsLCAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmZvcmNlVXBkYXRlKCk7IC8vIHdlIGRvbid0IHJlYWxseSBoYXZlIGEgcmVsaWFibGUgdGhpbmcgdG8gdXBkYXRlLCBzbyBqdXN0IHVwZGF0ZSB0aGUgd2hvbGUgdGhpbmdcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5sb2FkQmx1cmhhc2goKTtcblxuICAgICAgICBpZiAodGhpcy5wcm9wcy5tZWRpYUV2ZW50SGVscGVyLm1lZGlhLmlzRW5jcnlwdGVkICYmIHRoaXMuc3RhdGUuZGVjcnlwdGVkVXJsID09PSBudWxsKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGF1dG9wbGF5ID0gU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcImF1dG9wbGF5VmlkZW9cIikgYXMgYm9vbGVhbjtcbiAgICAgICAgICAgICAgICBjb25zdCB0aHVtYm5haWxVcmwgPSBhd2FpdCB0aGlzLnByb3BzLm1lZGlhRXZlbnRIZWxwZXIudGh1bWJuYWlsVXJsLnZhbHVlO1xuICAgICAgICAgICAgICAgIGlmIChhdXRvcGxheSkge1xuICAgICAgICAgICAgICAgICAgICBsb2dnZXIubG9nKFwiUHJlbG9hZGluZyB2aWRlb1wiKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICBkZWNyeXB0ZWRVcmw6IGF3YWl0IHRoaXMucHJvcHMubWVkaWFFdmVudEhlbHBlci5zb3VyY2VVcmwudmFsdWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWNyeXB0ZWRUaHVtYm5haWxVcmw6IHRodW1ibmFpbFVybCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlY3J5cHRlZEJsb2I6IGF3YWl0IHRoaXMucHJvcHMubWVkaWFFdmVudEhlbHBlci5zb3VyY2VCbG9iLnZhbHVlLFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wcm9wcy5vbkhlaWdodENoYW5nZWQoKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBsb2dnZXIubG9nKFwiTk9UIHByZWxvYWRpbmcgdmlkZW9cIik7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSB0aGlzLnByb3BzLm14RXZlbnQuZ2V0Q29udGVudDxJTWVkaWFFdmVudENvbnRlbnQ+KCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gRm9yIENocm9tZSBhbmQgRWxlY3Ryb24sIHdlIG5lZWQgdG8gc2V0IHNvbWUgbm9uLWVtcHR5IGBzcmNgIHRvXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBlbmFibGUgdGhlIHBsYXkgYnV0dG9uLiBGaXJlZm94IGRvZXMgbm90IHNlZW0gdG8gY2FyZSBlaXRoZXJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdheSwgc28gaXQncyBmaW5lIHRvIGRvIGZvciBhbGwgYnJvd3NlcnMuXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWNyeXB0ZWRVcmw6IGBkYXRhOiR7Y29udGVudD8uaW5mbz8ubWltZXR5cGV9LGAsXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWNyeXB0ZWRUaHVtYm5haWxVcmw6IHRodW1ibmFpbFVybCB8fCBgZGF0YToke2NvbnRlbnQ/LmluZm8/Lm1pbWV0eXBlfSxgLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGVjcnlwdGVkQmxvYjogbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgICAgbG9nZ2VyLndhcm4oXCJVbmFibGUgdG8gZGVjcnlwdCBhdHRhY2htZW50OiBcIiwgZXJyKTtcbiAgICAgICAgICAgICAgICAvLyBTZXQgYSBwbGFjZWhvbGRlciBpbWFnZSB3aGVuIHdlIGNhbid0IGRlY3J5cHQgdGhlIGltYWdlLlxuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgICBTZXR0aW5nc1N0b3JlLnVud2F0Y2hTZXR0aW5nKHRoaXMuc2l6ZVdhdGNoZXIpO1xuICAgIH1cblxuICAgIHByaXZhdGUgdmlkZW9PblBsYXkgPSBhc3luYyAoKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLmhhc0NvbnRlbnRVcmwoKSB8fCB0aGlzLnN0YXRlLmZldGNoaW5nRGF0YSB8fCB0aGlzLnN0YXRlLmVycm9yKSB7XG4gICAgICAgICAgICAvLyBXZSBoYXZlIHRoZSBmaWxlLCB3ZSBhcmUgZmV0Y2hpbmcgdGhlIGZpbGUsIG9yIHRoZXJlIGlzIGFuIGVycm9yLlxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgLy8gVG8gc3RvcCBzdWJzZXF1ZW50IGRvd25sb2FkIGF0dGVtcHRzXG4gICAgICAgICAgICBmZXRjaGluZ0RhdGE6IHRydWUsXG4gICAgICAgIH0pO1xuICAgICAgICBpZiAoIXRoaXMucHJvcHMubWVkaWFFdmVudEhlbHBlci5tZWRpYS5pc0VuY3J5cHRlZCkge1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgZXJyb3I6IFwiTm8gZmlsZSBnaXZlbiBpbiBjb250ZW50XCIsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIGRlY3J5cHRlZFVybDogYXdhaXQgdGhpcy5wcm9wcy5tZWRpYUV2ZW50SGVscGVyLnNvdXJjZVVybC52YWx1ZSxcbiAgICAgICAgICAgIGRlY3J5cHRlZEJsb2I6IGF3YWl0IHRoaXMucHJvcHMubWVkaWFFdmVudEhlbHBlci5zb3VyY2VCbG9iLnZhbHVlLFxuICAgICAgICAgICAgZmV0Y2hpbmdEYXRhOiBmYWxzZSxcbiAgICAgICAgfSwgKCkgPT4ge1xuICAgICAgICAgICAgaWYgKCF0aGlzLnZpZGVvUmVmLmN1cnJlbnQpIHJldHVybjtcbiAgICAgICAgICAgIHRoaXMudmlkZW9SZWYuY3VycmVudC5wbGF5KCk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnByb3BzLm9uSGVpZ2h0Q2hhbmdlZCgpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIGdldEZpbGVCb2R5ID0gKCkgPT4ge1xuICAgICAgICBpZiAodGhpcy5wcm9wcy5mb3JFeHBvcnQpIHJldHVybiBudWxsO1xuICAgICAgICByZXR1cm4gdGhpcy5wcm9wcy50aWxlU2hhcGUgJiYgPE1GaWxlQm9keSB7Li4udGhpcy5wcm9wc30gc2hvd0dlbmVyaWNQbGFjZWhvbGRlcj17ZmFsc2V9IC8+O1xuICAgIH07XG5cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIGNvbnN0IGNvbnRlbnQgPSB0aGlzLnByb3BzLm14RXZlbnQuZ2V0Q29udGVudCgpO1xuICAgICAgICBjb25zdCBhdXRvcGxheSA9IFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJhdXRvcGxheVZpZGVvXCIpO1xuXG4gICAgICAgIGlmICh0aGlzLnN0YXRlLmVycm9yICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT1cIm14X01WaWRlb0JvZHlcIj5cbiAgICAgICAgICAgICAgICAgICAgPGltZyBzcmM9e3JlcXVpcmUoXCIuLi8uLi8uLi8uLi9yZXMvaW1nL3dhcm5pbmcuc3ZnXCIpfSB3aWR0aD1cIjE2XCIgaGVpZ2h0PVwiMTZcIiAvPlxuICAgICAgICAgICAgICAgICAgICB7IF90KFwiRXJyb3IgZGVjcnlwdGluZyB2aWRlb1wiKSB9XG4gICAgICAgICAgICAgICAgPC9zcGFuPlxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEltcG9ydGFudDogSWYgd2UgYXJlbid0IGF1dG9wbGF5aW5nIGFuZCB3ZSBoYXZlbid0IGRlY3J5cHRlZCBpdCB5ZXQsIHNob3cgYSB2aWRlbyB3aXRoIGEgcG9zdGVyLlxuICAgICAgICBpZiAoIXRoaXMucHJvcHMuZm9yRXhwb3J0ICYmIGNvbnRlbnQuZmlsZSAhPT0gdW5kZWZpbmVkICYmIHRoaXMuc3RhdGUuZGVjcnlwdGVkVXJsID09PSBudWxsICYmIGF1dG9wbGF5KSB7XG4gICAgICAgICAgICAvLyBOZWVkIHRvIGRlY3J5cHQgdGhlIGF0dGFjaG1lbnRcbiAgICAgICAgICAgIC8vIFRoZSBhdHRhY2htZW50IGlzIGRlY3J5cHRlZCBpbiBjb21wb25lbnREaWRNb3VudC5cbiAgICAgICAgICAgIC8vIEZvciBub3cgYWRkIGFuIGltZyB0YWcgd2l0aCBhIHNwaW5uZXIuXG4gICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT1cIm14X01WaWRlb0JvZHlcIj5cbiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9NSW1hZ2VCb2R5X3RodW1ibmFpbCBteF9NSW1hZ2VCb2R5X3RodW1ibmFpbF9zcGlubmVyXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICA8SW5saW5lU3Bpbm5lciAvPlxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICA8L3NwYW4+XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY29udGVudFVybCA9IHRoaXMuZ2V0Q29udGVudFVybCgpO1xuICAgICAgICBjb25zdCB0aHVtYlVybCA9IHRoaXMuZ2V0VGh1bWJVcmwoKTtcbiAgICAgICAgY29uc3QgZGVmYXVsdERpbXMgPSB0aGlzLnN1Z2dlc3RlZERpbWVuc2lvbnMoZmFsc2UpO1xuICAgICAgICBsZXQgaGVpZ2h0ID0gZGVmYXVsdERpbXMuaDtcbiAgICAgICAgbGV0IHdpZHRoID0gZGVmYXVsdERpbXMudztcbiAgICAgICAgbGV0IHBvc3RlciA9IG51bGw7XG4gICAgICAgIGxldCBwcmVsb2FkID0gXCJtZXRhZGF0YVwiO1xuICAgICAgICBpZiAoY29udGVudC5pbmZvKSB7XG4gICAgICAgICAgICBjb25zdCBzY2FsZSA9IHRoaXMudGh1bWJTY2FsZShjb250ZW50LmluZm8udywgY29udGVudC5pbmZvLmgpO1xuICAgICAgICAgICAgaWYgKHNjYWxlKSB7XG4gICAgICAgICAgICAgICAgd2lkdGggPSBNYXRoLmZsb29yKGNvbnRlbnQuaW5mby53ICogc2NhbGUpO1xuICAgICAgICAgICAgICAgIGhlaWdodCA9IE1hdGguZmxvb3IoY29udGVudC5pbmZvLmggKiBzY2FsZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICh0aHVtYlVybCkge1xuICAgICAgICAgICAgICAgIHBvc3RlciA9IHRodW1iVXJsO1xuICAgICAgICAgICAgICAgIHByZWxvYWQgPSBcIm5vbmVcIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGZpbGVCb2R5ID0gdGhpcy5nZXRGaWxlQm9keSgpO1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPHNwYW4gY2xhc3NOYW1lPVwibXhfTVZpZGVvQm9keVwiPlxuICAgICAgICAgICAgICAgIDx2aWRlb1xuICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9NVmlkZW9Cb2R5XCJcbiAgICAgICAgICAgICAgICAgICAgcmVmPXt0aGlzLnZpZGVvUmVmfVxuICAgICAgICAgICAgICAgICAgICBzcmM9e2NvbnRlbnRVcmx9XG4gICAgICAgICAgICAgICAgICAgIHRpdGxlPXtjb250ZW50LmJvZHl9XG4gICAgICAgICAgICAgICAgICAgIGNvbnRyb2xzXG4gICAgICAgICAgICAgICAgICAgIHByZWxvYWQ9e3ByZWxvYWR9XG4gICAgICAgICAgICAgICAgICAgIG11dGVkPXthdXRvcGxheX1cbiAgICAgICAgICAgICAgICAgICAgYXV0b1BsYXk9e2F1dG9wbGF5fVxuICAgICAgICAgICAgICAgICAgICBoZWlnaHQ9e2hlaWdodH1cbiAgICAgICAgICAgICAgICAgICAgd2lkdGg9e3dpZHRofVxuICAgICAgICAgICAgICAgICAgICBwb3N0ZXI9e3Bvc3Rlcn1cbiAgICAgICAgICAgICAgICAgICAgb25QbGF5PXt0aGlzLnZpZGVvT25QbGF5fVxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgeyBmaWxlQm9keSB9XG4gICAgICAgICAgICA8L3NwYW4+XG4gICAgICAgICk7XG4gICAgfVxufVxuIl19