"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _classnames = _interopRequireDefault(require("classnames"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _languageHandler = require("../../../languageHandler");

var _KeyVerificationStateObserver = require("../../../utils/KeyVerificationStateObserver");

var _EventTileBubble = _interopRequireDefault(require("./EventTileBubble"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _event = require("matrix-js-sdk/src/@types/event");

var _dec, _class;

let MKeyVerificationConclusion = (_dec = (0, _replaceableComponent.replaceableComponent)("views.messages.MKeyVerificationConclusion"), _dec(_class = class MKeyVerificationConclusion extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onRequestChanged", () => {
      this.forceUpdate();
    });
    (0, _defineProperty2.default)(this, "onTrustChanged", userId => {
      const {
        mxEvent
      } = this.props;
      const request = mxEvent.verificationRequest;

      if (!request || request.otherUserId !== userId) {
        return;
      }

      this.forceUpdate();
    });
  }

  componentDidMount() {
    const request = this.props.mxEvent.verificationRequest;

    if (request) {
      request.on("change", this.onRequestChanged);
    }

    _MatrixClientPeg.MatrixClientPeg.get().on("userTrustStatusChanged", this.onTrustChanged);
  }

  componentWillUnmount() {
    const request = this.props.mxEvent.verificationRequest;

    if (request) {
      request.off("change", this.onRequestChanged);
    }

    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    if (cli) {
      cli.removeListener("userTrustStatusChanged", this.onTrustChanged);
    }
  }

  static shouldRender(mxEvent, request) {
    // normally should not happen
    if (!request) {
      return false;
    } // .cancel event that was sent after the verification finished, ignore


    if (mxEvent.getType() === _event.EventType.KeyVerificationCancel && !request.cancelled) {
      return false;
    } // .done event that was sent after the verification cancelled, ignore


    if (mxEvent.getType() === _event.EventType.KeyVerificationDone && !request.done) {
      return false;
    } // request hasn't concluded yet


    if (request.pending) {
      return false;
    } // User isn't actually verified


    if (!_MatrixClientPeg.MatrixClientPeg.get().checkUserTrust(request.otherUserId).isCrossSigningVerified()) {
      return false;
    }

    return true;
  }

  render() {
    const {
      mxEvent
    } = this.props;
    const request = mxEvent.verificationRequest;

    if (!MKeyVerificationConclusion.shouldRender(mxEvent, request)) {
      return null;
    }

    const client = _MatrixClientPeg.MatrixClientPeg.get();

    const myUserId = client.getUserId();
    let title;

    if (request.done) {
      title = (0, _languageHandler._t)("You verified %(name)s", {
        name: (0, _KeyVerificationStateObserver.getNameForEventRoom)(request.otherUserId, mxEvent.getRoomId())
      });
    } else if (request.cancelled) {
      const userId = request.cancellingUserId;

      if (userId === myUserId) {
        title = (0, _languageHandler._t)("You cancelled verifying %(name)s", {
          name: (0, _KeyVerificationStateObserver.getNameForEventRoom)(request.otherUserId, mxEvent.getRoomId())
        });
      } else {
        title = (0, _languageHandler._t)("%(name)s cancelled verifying", {
          name: (0, _KeyVerificationStateObserver.getNameForEventRoom)(userId, mxEvent.getRoomId())
        });
      }
    }

    if (title) {
      const classes = (0, _classnames.default)("mx_cryptoEvent mx_cryptoEvent_icon", {
        mx_cryptoEvent_icon_verified: request.done
      });
      return /*#__PURE__*/_react.default.createElement(_EventTileBubble.default, {
        className: classes,
        title: title,
        subtitle: (0, _KeyVerificationStateObserver.userLabelForEventRoom)(request.otherUserId, mxEvent.getRoomId())
      });
    }

    return null;
  }

}) || _class);
exports.default = MKeyVerificationConclusion;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL21lc3NhZ2VzL01LZXlWZXJpZmljYXRpb25Db25jbHVzaW9uLnRzeCJdLCJuYW1lcyI6WyJNS2V5VmVyaWZpY2F0aW9uQ29uY2x1c2lvbiIsIlJlYWN0IiwiQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsImZvcmNlVXBkYXRlIiwidXNlcklkIiwibXhFdmVudCIsInJlcXVlc3QiLCJ2ZXJpZmljYXRpb25SZXF1ZXN0Iiwib3RoZXJVc2VySWQiLCJjb21wb25lbnREaWRNb3VudCIsIm9uIiwib25SZXF1ZXN0Q2hhbmdlZCIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsIm9uVHJ1c3RDaGFuZ2VkIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJvZmYiLCJjbGkiLCJyZW1vdmVMaXN0ZW5lciIsInNob3VsZFJlbmRlciIsImdldFR5cGUiLCJFdmVudFR5cGUiLCJLZXlWZXJpZmljYXRpb25DYW5jZWwiLCJjYW5jZWxsZWQiLCJLZXlWZXJpZmljYXRpb25Eb25lIiwiZG9uZSIsInBlbmRpbmciLCJjaGVja1VzZXJUcnVzdCIsImlzQ3Jvc3NTaWduaW5nVmVyaWZpZWQiLCJyZW5kZXIiLCJjbGllbnQiLCJteVVzZXJJZCIsImdldFVzZXJJZCIsInRpdGxlIiwibmFtZSIsImdldFJvb21JZCIsImNhbmNlbGxpbmdVc2VySWQiLCJjbGFzc2VzIiwibXhfY3J5cHRvRXZlbnRfaWNvbl92ZXJpZmllZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFnQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0E7Ozs7SUFRcUJBLDBCLFdBRHBCLGdEQUFxQiwyQ0FBckIsQyxnQkFBRCxNQUNxQkEsMEJBRHJCLFNBQ3dEQyxlQUFNQyxTQUQ5RCxDQUNnRjtBQUM1RUMsRUFBQUEsV0FBVyxDQUFDQyxLQUFELEVBQWdCO0FBQ3ZCLFVBQU1BLEtBQU47QUFEdUIsNERBdUJBLE1BQVk7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U0FBUixFQUF6QztBQUFSLE9BRkksQ0FBUjtBQUlILEtBTEQsTUFLTyxJQUFJN0IsT0FBTyxDQUFDaUIsU0FBWixFQUF1QjtBQUMxQixZQUFNbkIsTUFBTSxHQUFHRSxPQUFPLENBQUM4QixnQkFBdkI7O0FBQ0EsVUFBSWhDLE1BQU0sS0FBSzJCLFFBQWYsRUFBeUI7QUFDckJFLFFBQUFBLEtBQUssR0FBRyx5QkFBRyxrQ0FBSCxFQUNKO0FBQUVDLFVBQUFBLElBQUksRUFBRSx1REFBb0I1QixPQUFPLENBQUNFLFdBQTVCLEVBQXlDSCxPQUFPLENBQUM4QixTQUFSLEVBQXpDO0FBQVIsU0FESSxDQUFSO0FBRUgsT0FIRCxNQUdPO0FBQ0hGLFFBQUFBLEtBQUssR0FBRyx5QkFBRyw4QkFBSCxFQUNKO0FBQUVDLFVBQUFBLElBQUksRUFBRSx1REFBb0I5QixNQUFwQixFQUE0QkMsT0FBTyxDQUFDOEIsU0FBUixFQUE1QjtBQUFSLFNBREksQ0FBUjtBQUVIO0FBQ0o7O0FBRUQsUUFBSUYsS0FBSixFQUFXO0FBQ1AsWUFBTUksT0FBTyxHQUFHLHlCQUFXLG9DQUFYLEVBQWlEO0FBQzdEQyxRQUFBQSw0QkFBNEIsRUFBRWhDLE9BQU8sQ0FBQ21CO0FBRHVCLE9BQWpELENBQWhCO0FBR0EsMEJBQU8sNkJBQUMsd0JBQUQ7QUFDSCxRQUFBLFNBQVMsRUFBRVksT0FEUjtBQUVILFFBQUEsS0FBSyxFQUFFSixLQUZKO0FBR0gsUUFBQSxRQUFRLEVBQUUseURBQXNCM0IsT0FBTyxDQUFDRSxXQUE5QixFQUEyQ0gsT0FBTyxDQUFDOEIsU0FBUixFQUEzQztBQUhQLFFBQVA7QUFLSDs7QUFFRCxXQUFPLElBQVA7QUFDSDs7QUF6RzJFLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTksIDIwMjAgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IGNsYXNzTmFtZXMgZnJvbSAnY2xhc3NuYW1lcyc7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tICcuLi8uLi8uLi9NYXRyaXhDbGllbnRQZWcnO1xuaW1wb3J0IHsgX3QgfSBmcm9tICcuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXInO1xuaW1wb3J0IHsgZ2V0TmFtZUZvckV2ZW50Um9vbSwgdXNlckxhYmVsRm9yRXZlbnRSb29tIH0gZnJvbSAnLi4vLi4vLi4vdXRpbHMvS2V5VmVyaWZpY2F0aW9uU3RhdGVPYnNlcnZlcic7XG5pbXBvcnQgRXZlbnRUaWxlQnViYmxlIGZyb20gXCIuL0V2ZW50VGlsZUJ1YmJsZVwiO1xuaW1wb3J0IHsgcmVwbGFjZWFibGVDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvcmVwbGFjZWFibGVDb21wb25lbnRcIjtcbmltcG9ydCB7IE1hdHJpeEV2ZW50IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9ldmVudFwiO1xuaW1wb3J0IHsgVmVyaWZpY2F0aW9uUmVxdWVzdCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9jcnlwdG8vdmVyaWZpY2F0aW9uL3JlcXVlc3QvVmVyaWZpY2F0aW9uUmVxdWVzdFwiO1xuaW1wb3J0IHsgRXZlbnRUeXBlIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL0B0eXBlcy9ldmVudFwiO1xuXG5pbnRlcmZhY2UgSVByb3BzIHtcbiAgICAvKiB0aGUgTWF0cml4RXZlbnQgdG8gc2hvdyAqL1xuICAgIG14RXZlbnQ6IE1hdHJpeEV2ZW50O1xufVxuXG5AcmVwbGFjZWFibGVDb21wb25lbnQoXCJ2aWV3cy5tZXNzYWdlcy5NS2V5VmVyaWZpY2F0aW9uQ29uY2x1c2lvblwiKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTUtleVZlcmlmaWNhdGlvbkNvbmNsdXNpb24gZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8SVByb3BzPiB7XG4gICAgY29uc3RydWN0b3IocHJvcHM6IElQcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG4gICAgfVxuXG4gICAgcHVibGljIGNvbXBvbmVudERpZE1vdW50KCk6IHZvaWQge1xuICAgICAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5wcm9wcy5teEV2ZW50LnZlcmlmaWNhdGlvblJlcXVlc3Q7XG4gICAgICAgIGlmIChyZXF1ZXN0KSB7XG4gICAgICAgICAgICByZXF1ZXN0Lm9uKFwiY2hhbmdlXCIsIHRoaXMub25SZXF1ZXN0Q2hhbmdlZCk7XG4gICAgICAgIH1cbiAgICAgICAgTWF0cml4Q2xpZW50UGVnLmdldCgpLm9uKFwidXNlclRydXN0U3RhdHVzQ2hhbmdlZFwiLCB0aGlzLm9uVHJ1c3RDaGFuZ2VkKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY29tcG9uZW50V2lsbFVubW91bnQoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLnByb3BzLm14RXZlbnQudmVyaWZpY2F0aW9uUmVxdWVzdDtcbiAgICAgICAgaWYgKHJlcXVlc3QpIHtcbiAgICAgICAgICAgIHJlcXVlc3Qub2ZmKFwiY2hhbmdlXCIsIHRoaXMub25SZXF1ZXN0Q2hhbmdlZCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY2xpID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuICAgICAgICBpZiAoY2xpKSB7XG4gICAgICAgICAgICBjbGkucmVtb3ZlTGlzdGVuZXIoXCJ1c2VyVHJ1c3RTdGF0dXNDaGFuZ2VkXCIsIHRoaXMub25UcnVzdENoYW5nZWQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvblJlcXVlc3RDaGFuZ2VkID0gKCk6IHZvaWQgPT4ge1xuICAgICAgICB0aGlzLmZvcmNlVXBkYXRlKCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25UcnVzdENoYW5nZWQgPSAodXNlcklkOiBzdHJpbmcpOiB2b2lkID0+IHtcbiAgICAgICAgY29uc3QgeyBteEV2ZW50IH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCByZXF1ZXN0ID0gbXhFdmVudC52ZXJpZmljYXRpb25SZXF1ZXN0O1xuICAgICAgICBpZiAoIXJlcXVlc3QgfHwgcmVxdWVzdC5vdGhlclVzZXJJZCAhPT0gdXNlcklkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5mb3JjZVVwZGF0ZSgpO1xuICAgIH07XG5cbiAgICBwdWJsaWMgc3RhdGljIHNob3VsZFJlbmRlcihteEV2ZW50OiBNYXRyaXhFdmVudCwgcmVxdWVzdDogVmVyaWZpY2F0aW9uUmVxdWVzdCk6IGJvb2xlYW4ge1xuICAgICAgICAvLyBub3JtYWxseSBzaG91bGQgbm90IGhhcHBlblxuICAgICAgICBpZiAoIXJlcXVlc3QpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICAvLyAuY2FuY2VsIGV2ZW50IHRoYXQgd2FzIHNlbnQgYWZ0ZXIgdGhlIHZlcmlmaWNhdGlvbiBmaW5pc2hlZCwgaWdub3JlXG4gICAgICAgIGlmIChteEV2ZW50LmdldFR5cGUoKSA9PT0gRXZlbnRUeXBlLktleVZlcmlmaWNhdGlvbkNhbmNlbCAmJiAhcmVxdWVzdC5jYW5jZWxsZWQpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICAvLyAuZG9uZSBldmVudCB0aGF0IHdhcyBzZW50IGFmdGVyIHRoZSB2ZXJpZmljYXRpb24gY2FuY2VsbGVkLCBpZ25vcmVcbiAgICAgICAgaWYgKG14RXZlbnQuZ2V0VHlwZSgpID09PSBFdmVudFR5cGUuS2V5VmVyaWZpY2F0aW9uRG9uZSAmJiAhcmVxdWVzdC5kb25lKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICAvLyByZXF1ZXN0IGhhc24ndCBjb25jbHVkZWQgeWV0XG4gICAgICAgIGlmIChyZXF1ZXN0LnBlbmRpbmcpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFVzZXIgaXNuJ3QgYWN0dWFsbHkgdmVyaWZpZWRcbiAgICAgICAgaWYgKCFNYXRyaXhDbGllbnRQZWcuZ2V0KCkuY2hlY2tVc2VyVHJ1c3QocmVxdWVzdC5vdGhlclVzZXJJZCkuaXNDcm9zc1NpZ25pbmdWZXJpZmllZCgpKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVuZGVyKCk6IEpTWC5FbGVtZW50IHtcbiAgICAgICAgY29uc3QgeyBteEV2ZW50IH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCByZXF1ZXN0ID0gbXhFdmVudC52ZXJpZmljYXRpb25SZXF1ZXN0O1xuXG4gICAgICAgIGlmICghTUtleVZlcmlmaWNhdGlvbkNvbmNsdXNpb24uc2hvdWxkUmVuZGVyKG14RXZlbnQsIHJlcXVlc3QpKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGNsaWVudCA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICAgICAgY29uc3QgbXlVc2VySWQgPSBjbGllbnQuZ2V0VXNlcklkKCk7XG5cbiAgICAgICAgbGV0IHRpdGxlO1xuXG4gICAgICAgIGlmIChyZXF1ZXN0LmRvbmUpIHtcbiAgICAgICAgICAgIHRpdGxlID0gX3QoXG4gICAgICAgICAgICAgICAgXCJZb3UgdmVyaWZpZWQgJShuYW1lKXNcIixcbiAgICAgICAgICAgICAgICB7IG5hbWU6IGdldE5hbWVGb3JFdmVudFJvb20ocmVxdWVzdC5vdGhlclVzZXJJZCwgbXhFdmVudC5nZXRSb29tSWQoKSkgfSxcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSBpZiAocmVxdWVzdC5jYW5jZWxsZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHVzZXJJZCA9IHJlcXVlc3QuY2FuY2VsbGluZ1VzZXJJZDtcbiAgICAgICAgICAgIGlmICh1c2VySWQgPT09IG15VXNlcklkKSB7XG4gICAgICAgICAgICAgICAgdGl0bGUgPSBfdChcIllvdSBjYW5jZWxsZWQgdmVyaWZ5aW5nICUobmFtZSlzXCIsXG4gICAgICAgICAgICAgICAgICAgIHsgbmFtZTogZ2V0TmFtZUZvckV2ZW50Um9vbShyZXF1ZXN0Lm90aGVyVXNlcklkLCBteEV2ZW50LmdldFJvb21JZCgpKSB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGl0bGUgPSBfdChcIiUobmFtZSlzIGNhbmNlbGxlZCB2ZXJpZnlpbmdcIixcbiAgICAgICAgICAgICAgICAgICAgeyBuYW1lOiBnZXROYW1lRm9yRXZlbnRSb29tKHVzZXJJZCwgbXhFdmVudC5nZXRSb29tSWQoKSkgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGl0bGUpIHtcbiAgICAgICAgICAgIGNvbnN0IGNsYXNzZXMgPSBjbGFzc05hbWVzKFwibXhfY3J5cHRvRXZlbnQgbXhfY3J5cHRvRXZlbnRfaWNvblwiLCB7XG4gICAgICAgICAgICAgICAgbXhfY3J5cHRvRXZlbnRfaWNvbl92ZXJpZmllZDogcmVxdWVzdC5kb25lLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gPEV2ZW50VGlsZUJ1YmJsZVxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZT17Y2xhc3Nlc31cbiAgICAgICAgICAgICAgICB0aXRsZT17dGl0bGV9XG4gICAgICAgICAgICAgICAgc3VidGl0bGU9e3VzZXJMYWJlbEZvckV2ZW50Um9vbShyZXF1ZXN0Lm90aGVyVXNlcklkLCBteEV2ZW50LmdldFJvb21JZCgpKX1cbiAgICAgICAgICAgIC8+O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxufVxuIl19