"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var HtmlUtils = _interopRequireWildcard(require("../../../HtmlUtils"));

var _MessageDiffUtils = require("../../../utils/MessageDiffUtils");

var _DateUtils = require("../../../DateUtils");

var _pillify = require("../../../utils/pillify");

var _languageHandler = require("../../../languageHandler");

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _classnames = _interopRequireDefault(require("classnames"));

var _RedactedBody = _interopRequireDefault(require("./RedactedBody"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _ConfirmAndWaitRedactDialog = _interopRequireDefault(require("../dialogs/ConfirmAndWaitRedactDialog"));

var _ViewSource = _interopRequireDefault(require("../../structures/ViewSource"));

var _dec, _class;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function getReplacedContent(event) {
  const originalContent = event.getOriginalContent();
  return originalContent["m.new_content"] || originalContent;
}

let EditHistoryMessage = (_dec = (0, _replaceableComponent.replaceableComponent)("views.messages.EditHistoryMessage"), _dec(_class = class EditHistoryMessage extends _react.default.PureComponent {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "content", /*#__PURE__*/(0, _react.createRef)());
    (0, _defineProperty2.default)(this, "pills", []);
    (0, _defineProperty2.default)(this, "onAssociatedStatusChanged", () => {
      this.setState({
        sendStatus: this.props.mxEvent.getAssociatedStatus()
      });
    });
    (0, _defineProperty2.default)(this, "onRedactClick", async () => {
      const event = this.props.mxEvent;

      const cli = _MatrixClientPeg.MatrixClientPeg.get();

      _Modal.default.createTrackedDialog('Confirm Redact Dialog', 'Edit history', _ConfirmAndWaitRedactDialog.default, {
        redact: () => cli.redactEvent(event.getRoomId(), event.getId())
      }, 'mx_Dialog_confirmredact');
    });
    (0, _defineProperty2.default)(this, "onViewSourceClick", () => {
      _Modal.default.createTrackedDialog('View Event Source', 'Edit history', _ViewSource.default, {
        mxEvent: this.props.mxEvent
      }, 'mx_Dialog_viewsource');
    });

    const _cli = _MatrixClientPeg.MatrixClientPeg.get();

    const {
      userId
    } = _cli.credentials;
    const _event = this.props.mxEvent;

    const room = _cli.getRoom(_event.getRoomId());

    if (_event.localRedactionEvent()) {
      _event.localRedactionEvent().on("status", this.onAssociatedStatusChanged);
    }

    const canRedact = room.currentState.maySendRedactionForEvent(_event, userId);
    this.state = {
      canRedact,
      sendStatus: _event.getAssociatedStatus()
    };
  }

  pillifyLinks() {
    // not present for redacted events
    if (this.content.current) {
      (0, _pillify.pillifyLinks)(this.content.current.children, this.props.mxEvent, this.pills);
    }
  }

  componentDidMount() {
    this.pillifyLinks();
  }

  componentWillUnmount() {
    (0, _pillify.unmountPills)(this.pills);
    const event = this.props.mxEvent;

    if (event.localRedactionEvent()) {
      event.localRedactionEvent().off("status", this.onAssociatedStatusChanged);
    }
  }

  componentDidUpdate() {
    this.pillifyLinks();
  }

  renderActionBar() {
    // hide the button when already redacted
    let redactButton;

    if (!this.props.mxEvent.isRedacted() && !this.props.isBaseEvent && this.state.canRedact) {
      redactButton = /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        onClick: this.onRedactClick
      }, (0, _languageHandler._t)("Remove"));
    }

    const viewSourceButton = /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      onClick: this.onViewSourceClick
    }, (0, _languageHandler._t)("View Source")); // disabled remove button when not allowed


    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_MessageActionBar"
    }, redactButton, viewSourceButton);
  }

  render() {
    const {
      mxEvent
    } = this.props;
    const content = getReplacedContent(mxEvent);
    let contentContainer;

    if (mxEvent.isRedacted()) {
      contentContainer = /*#__PURE__*/_react.default.createElement(_RedactedBody.default, {
        mxEvent: this.props.mxEvent
      });
    } else {
      let contentElements;

      if (this.props.previousEdit) {
        contentElements = (0, _MessageDiffUtils.editBodyDiffToHtml)(getReplacedContent(this.props.previousEdit), content);
      } else {
        contentElements = HtmlUtils.bodyToHtml(content, null, {
          stripReplyFallback: true,
          returnString: false
        });
      }

      if (mxEvent.getContent().msgtype === "m.emote") {
        const name = mxEvent.sender ? mxEvent.sender.name : mxEvent.getSender();
        contentContainer = /*#__PURE__*/_react.default.createElement("div", {
          className: "mx_EventTile_content",
          ref: this.content
        }, "*\xA0", /*#__PURE__*/_react.default.createElement("span", {
          className: "mx_MEmoteBody_sender"
        }, name), "\xA0", contentElements);
      } else {
        contentContainer = /*#__PURE__*/_react.default.createElement("div", {
          className: "mx_EventTile_content",
          ref: this.content
        }, contentElements);
      }
    }

    const timestamp = (0, _DateUtils.formatTime)(new Date(mxEvent.getTs()), this.props.isTwelveHour);
    const isSending = ['sending', 'queued', 'encrypting'].indexOf(this.state.sendStatus) !== -1;
    const classes = (0, _classnames.default)({
      "mx_EventTile": true,
      // Note: we keep the `sending` state class for tests, not for our styles
      "mx_EventTile_sending": isSending
    });
    return /*#__PURE__*/_react.default.createElement("li", null, /*#__PURE__*/_react.default.createElement("div", {
      className: classes
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_EventTile_line"
    }, /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_MessageTimestamp"
    }, timestamp), contentContainer, this.renderActionBar())));
  }

}) || _class);
exports.default = EditHistoryMessage;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL21lc3NhZ2VzL0VkaXRIaXN0b3J5TWVzc2FnZS50c3giXSwibmFtZXMiOlsiZ2V0UmVwbGFjZWRDb250ZW50IiwiZXZlbnQiLCJvcmlnaW5hbENvbnRlbnQiLCJnZXRPcmlnaW5hbENvbnRlbnQiLCJFZGl0SGlzdG9yeU1lc3NhZ2UiLCJSZWFjdCIsIlB1cmVDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwic2V0U3RhdGUiLCJzZW5kU3RhdHVzIiwibXhFdmVudCIsImdldEFzc29jaWF0ZWRTdGF0dXMiLCJjbGkiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJNb2RhbCIsImNyZWF0ZVRyYWNrZWREaWFsb2ciLCJDb25maXJtQW5kV2FpdFJlZGFjdERpYWxvZyIsInJlZGFjdCIsInJlZGFjdEV2ZW50IiwiZ2V0Um9vbUlkIiwiZ2V0SWQiLCJWaWV3U291cmNlIiwidXNlcklkIiwiY3JlZGVudGlhbHMiLCJyb29tIiwiZ2V0Um9vbSIsImxvY2FsUmVkYWN0aW9uRXZlbnQiLCJvbiIsIm9uQXNzb2NpYXRlZFN0YXR1c0NoYW5nZWQiLCJjYW5SZWRhY3QiLCJjdXJyZW50U3RhdGUiLCJtYXlTZW5kUmVkYWN0aW9uRm9yRXZlbnQiLCJzdGF0ZSIsInBpbGxpZnlMaW5rcyIsImNvbnRlbnQiLCJjdXJyZW50IiwiY2hpbGRyZW4iLCJwaWxscyIsImNvbXBvbmVudERpZE1vdW50IiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJvZmYiLCJjb21wb25lbnREaWRVcGRhdGUiLCJyZW5kZXJBY3Rpb25CYXIiLCJyZWRhY3RCdXR0b24iLCJpc1JlZGFjdGVkIiwiaXNCYXNlRXZlbnQiLCJvblJlZGFjdENsaWNrIiwidmlld1NvdXJjZUJ1dHRvbiIsIm9uVmlld1NvdXJjZUNsaWNrIiwicmVuZGVyIiwiY29udGVudENvbnRhaW5lciIsImNvbnRlbnRFbGVtZW50cyIsInByZXZpb3VzRWRpdCIsIkh0bWxVdGlscyIsImJvZHlUb0h0bWwiLCJzdHJpcFJlcGx5RmFsbGJhY2siLCJyZXR1cm5TdHJpbmciLCJnZXRDb250ZW50IiwibXNndHlwZSIsIm5hbWUiLCJzZW5kZXIiLCJnZXRTZW5kZXIiLCJ0aW1lc3RhbXAiLCJEYXRlIiwiZ2V0VHMiLCJpc1R3ZWx2ZUhvdXIiLCJpc1NlbmRpbmciLCJpbmRleE9mIiwiY2xhc3NlcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFnQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7O0FBRUEsU0FBU0Esa0JBQVQsQ0FBNEJDLEtBQTVCLEVBQW1DO0FBQy9CLFFBQU1DLGVBQWUsR0FBR0QsS0FBSyxDQUFDRSxrQkFBTixFQUF4QjtBQUNBLFNBQU9ELGVBQWUsQ0FBQyxlQUFELENBQWYsSUFBb0NBLGVBQTNDO0FBQ0g7O0lBZ0JvQkUsa0IsV0FEcEIsZ0RBQXFCLG1DQUFyQixDLGdCQUFELE1BQ3FCQSxrQkFEckIsU0FDZ0RDLGVBQU1DLGFBRHRELENBQ29GO0FBSWhGQyxFQUFBQSxXQUFXLENBQUNDLEtBQUQsRUFBZ0I7QUFDdkIsVUFBTUEsS0FBTjtBQUR1QixnRUFIVCx1QkFHUztBQUFBLGlEQUZBLEVBRUE7QUFBQSxxRUFjUyxNQUFZO0FBQzVDLFdBQUtDLFFBQUwsQ0FBYztBQUFFQyxRQUFBQSxVQUFVLEVBQUUsS0FBS0YsS0FBTCxDQUFXRyxPQUFYLENBQW1CQyxtQkFBbkI7QUFBZCxPQUFkO0FBQ0gsS0FoQjBCO0FBQUEseURBa0JILFlBQTJCO0FBQy9DLFlBQU1YLEtBQUssR0FBRyxLQUFLTyxLQUFMLENBQVdHLE9BQXpCOztBQUNBLFlBQU1FLEdBQUcsR0FBR0MsaUNBQWdCQyxHQUFoQixFQUFaOztBQUVBQyxxQkFBTUMsbUJBQU4sQ0FBMEIsdUJBQTFCLEVBQW1ELGNBQW5ELEVBQW1FQyxtQ0FBbkUsRUFBK0Y7QUFDM0ZDLFFBQUFBLE1BQU0sRUFB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QSxTQUFTLEVBQUMsc0JBQWY7QUFBc0MsVUFBQSxHQUFHLEVBQUUsS0FBS2hCO0FBQWhELFdBQTJEaUIsZUFBM0QsQ0FBbkI7QUFDSDtBQUNKOztBQUVELFVBQU1XLFNBQVMsR0FBRywyQkFBVyxJQUFJQyxJQUFKLENBQVN0RCxPQUFPLENBQUN1RCxLQUFSLEVBQVQsQ0FBWCxFQUFzQyxLQUFLMUQsS0FBTCxDQUFXMkQsWUFBakQsQ0FBbEI7QUFDQSxVQUFNQyxTQUFTLEdBQUksQ0FBQyxTQUFELEVBQVksUUFBWixFQUFzQixZQUF0QixFQUFvQ0MsT0FBcEMsQ0FBNEMsS0FBS25DLEtBQUwsQ0FBV3hCLFVBQXZELE1BQXVFLENBQUMsQ0FBM0Y7QUFDQSxVQUFNNEQsT0FBTyxHQUFHLHlCQUFXO0FBQ3ZCLHNCQUFnQixJQURPO0FBRXZCO0FBQ0EsOEJBQXdCRjtBQUhELEtBQVgsQ0FBaEI7QUFLQSx3QkFDSSxzREFDSTtBQUFLLE1BQUEsU0FBUyxFQUFFRTtBQUFoQixvQkFDSTtBQUFLLE1BQUEsU0FBUyxFQUFDO0FBQWYsb0JBQ0k7QUFBTSxNQUFBLFNBQVMsRUFBQztBQUFoQixPQUF3Q04sU0FBeEMsQ0FESixFQUVNWixnQkFGTixFQUdNLEtBQUtSLGVBQUwsRUFITixDQURKLENBREosQ0FESjtBQVdIOztBQXBJK0UsQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxOSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCwgeyBjcmVhdGVSZWYgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgKiBhcyBIdG1sVXRpbHMgZnJvbSAnLi4vLi4vLi4vSHRtbFV0aWxzJztcbmltcG9ydCB7IGVkaXRCb2R5RGlmZlRvSHRtbCB9IGZyb20gJy4uLy4uLy4uL3V0aWxzL01lc3NhZ2VEaWZmVXRpbHMnO1xuaW1wb3J0IHsgZm9ybWF0VGltZSB9IGZyb20gJy4uLy4uLy4uL0RhdGVVdGlscyc7XG5pbXBvcnQgeyBFdmVudFN0YXR1cywgTWF0cml4RXZlbnQgfSBmcm9tICdtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvZXZlbnQnO1xuaW1wb3J0IHsgcGlsbGlmeUxpbmtzLCB1bm1vdW50UGlsbHMgfSBmcm9tICcuLi8uLi8uLi91dGlscy9waWxsaWZ5JztcbmltcG9ydCB7IF90IH0gZnJvbSAnLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyJztcbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gJy4uLy4uLy4uL01hdHJpeENsaWVudFBlZyc7XG5pbXBvcnQgTW9kYWwgZnJvbSAnLi4vLi4vLi4vTW9kYWwnO1xuaW1wb3J0IGNsYXNzTmFtZXMgZnJvbSAnY2xhc3NuYW1lcyc7XG5pbXBvcnQgUmVkYWN0ZWRCb2R5IGZyb20gXCIuL1JlZGFjdGVkQm9keVwiO1xuaW1wb3J0IHsgcmVwbGFjZWFibGVDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvcmVwbGFjZWFibGVDb21wb25lbnRcIjtcbmltcG9ydCBBY2Nlc3NpYmxlQnV0dG9uIGZyb20gXCIuLi9lbGVtZW50cy9BY2Nlc3NpYmxlQnV0dG9uXCI7XG5pbXBvcnQgQ29uZmlybUFuZFdhaXRSZWRhY3REaWFsb2cgZnJvbSBcIi4uL2RpYWxvZ3MvQ29uZmlybUFuZFdhaXRSZWRhY3REaWFsb2dcIjtcbmltcG9ydCBWaWV3U291cmNlIGZyb20gXCIuLi8uLi9zdHJ1Y3R1cmVzL1ZpZXdTb3VyY2VcIjtcblxuZnVuY3Rpb24gZ2V0UmVwbGFjZWRDb250ZW50KGV2ZW50KSB7XG4gICAgY29uc3Qgb3JpZ2luYWxDb250ZW50ID0gZXZlbnQuZ2V0T3JpZ2luYWxDb250ZW50KCk7XG4gICAgcmV0dXJuIG9yaWdpbmFsQ29udGVudFtcIm0ubmV3X2NvbnRlbnRcIl0gfHwgb3JpZ2luYWxDb250ZW50O1xufVxuXG5pbnRlcmZhY2UgSVByb3BzIHtcbiAgICAvLyB0aGUgbWVzc2FnZSBldmVudCBiZWluZyBlZGl0ZWRcbiAgICBteEV2ZW50OiBNYXRyaXhFdmVudDtcbiAgICBwcmV2aW91c0VkaXQ/OiBNYXRyaXhFdmVudDtcbiAgICBpc0Jhc2VFdmVudD86IGJvb2xlYW47XG4gICAgaXNUd2VsdmVIb3VyPzogYm9vbGVhbjtcbn1cblxuaW50ZXJmYWNlIElTdGF0ZSB7XG4gICAgY2FuUmVkYWN0OiBib29sZWFuO1xuICAgIHNlbmRTdGF0dXM6IEV2ZW50U3RhdHVzO1xufVxuXG5AcmVwbGFjZWFibGVDb21wb25lbnQoXCJ2aWV3cy5tZXNzYWdlcy5FZGl0SGlzdG9yeU1lc3NhZ2VcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEVkaXRIaXN0b3J5TWVzc2FnZSBleHRlbmRzIFJlYWN0LlB1cmVDb21wb25lbnQ8SVByb3BzLCBJU3RhdGU+IHtcbiAgICBwcml2YXRlIGNvbnRlbnQgPSBjcmVhdGVSZWY8SFRNTERpdkVsZW1lbnQ+KCk7XG4gICAgcHJpdmF0ZSBwaWxsczogRWxlbWVudFtdID0gW107XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wczogSVByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcblxuICAgICAgICBjb25zdCBjbGkgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIGNvbnN0IHsgdXNlcklkIH0gPSBjbGkuY3JlZGVudGlhbHM7XG4gICAgICAgIGNvbnN0IGV2ZW50ID0gdGhpcy5wcm9wcy5teEV2ZW50O1xuICAgICAgICBjb25zdCByb29tID0gY2xpLmdldFJvb20oZXZlbnQuZ2V0Um9vbUlkKCkpO1xuICAgICAgICBpZiAoZXZlbnQubG9jYWxSZWRhY3Rpb25FdmVudCgpKSB7XG4gICAgICAgICAgICBldmVudC5sb2NhbFJlZGFjdGlvbkV2ZW50KCkub24oXCJzdGF0dXNcIiwgdGhpcy5vbkFzc29jaWF0ZWRTdGF0dXNDaGFuZ2VkKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBjYW5SZWRhY3QgPSByb29tLmN1cnJlbnRTdGF0ZS5tYXlTZW5kUmVkYWN0aW9uRm9yRXZlbnQoZXZlbnQsIHVzZXJJZCk7XG4gICAgICAgIHRoaXMuc3RhdGUgPSB7IGNhblJlZGFjdCwgc2VuZFN0YXR1czogZXZlbnQuZ2V0QXNzb2NpYXRlZFN0YXR1cygpIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkFzc29jaWF0ZWRTdGF0dXNDaGFuZ2VkID0gKCk6IHZvaWQgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgc2VuZFN0YXR1czogdGhpcy5wcm9wcy5teEV2ZW50LmdldEFzc29jaWF0ZWRTdGF0dXMoKSB9KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvblJlZGFjdENsaWNrID0gYXN5bmMgKCk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgICAgICBjb25zdCBldmVudCA9IHRoaXMucHJvcHMubXhFdmVudDtcbiAgICAgICAgY29uc3QgY2xpID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuXG4gICAgICAgIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coJ0NvbmZpcm0gUmVkYWN0IERpYWxvZycsICdFZGl0IGhpc3RvcnknLCBDb25maXJtQW5kV2FpdFJlZGFjdERpYWxvZywge1xuICAgICAgICAgICAgcmVkYWN0OiAoKSA9PiBjbGkucmVkYWN0RXZlbnQoZXZlbnQuZ2V0Um9vbUlkKCksIGV2ZW50LmdldElkKCkpLFxuICAgICAgICB9LCAnbXhfRGlhbG9nX2NvbmZpcm1yZWRhY3QnKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvblZpZXdTb3VyY2VDbGljayA9ICgpOiB2b2lkID0+IHtcbiAgICAgICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZygnVmlldyBFdmVudCBTb3VyY2UnLCAnRWRpdCBoaXN0b3J5JywgVmlld1NvdXJjZSwge1xuICAgICAgICAgICAgbXhFdmVudDogdGhpcy5wcm9wcy5teEV2ZW50LFxuICAgICAgICB9LCAnbXhfRGlhbG9nX3ZpZXdzb3VyY2UnKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBwaWxsaWZ5TGlua3MoKTogdm9pZCB7XG4gICAgICAgIC8vIG5vdCBwcmVzZW50IGZvciByZWRhY3RlZCBldmVudHNcbiAgICAgICAgaWYgKHRoaXMuY29udGVudC5jdXJyZW50KSB7XG4gICAgICAgICAgICBwaWxsaWZ5TGlua3ModGhpcy5jb250ZW50LmN1cnJlbnQuY2hpbGRyZW4sIHRoaXMucHJvcHMubXhFdmVudCwgdGhpcy5waWxscyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgY29tcG9uZW50RGlkTW91bnQoKTogdm9pZCB7XG4gICAgICAgIHRoaXMucGlsbGlmeUxpbmtzKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGNvbXBvbmVudFdpbGxVbm1vdW50KCk6IHZvaWQge1xuICAgICAgICB1bm1vdW50UGlsbHModGhpcy5waWxscyk7XG4gICAgICAgIGNvbnN0IGV2ZW50ID0gdGhpcy5wcm9wcy5teEV2ZW50O1xuICAgICAgICBpZiAoZXZlbnQubG9jYWxSZWRhY3Rpb25FdmVudCgpKSB7XG4gICAgICAgICAgICBldmVudC5sb2NhbFJlZGFjdGlvbkV2ZW50KCkub2ZmKFwic3RhdHVzXCIsIHRoaXMub25Bc3NvY2lhdGVkU3RhdHVzQ2hhbmdlZCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgY29tcG9uZW50RGlkVXBkYXRlKCk6IHZvaWQge1xuICAgICAgICB0aGlzLnBpbGxpZnlMaW5rcygpO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVuZGVyQWN0aW9uQmFyKCk6IEpTWC5FbGVtZW50IHtcbiAgICAgICAgLy8gaGlkZSB0aGUgYnV0dG9uIHdoZW4gYWxyZWFkeSByZWRhY3RlZFxuICAgICAgICBsZXQgcmVkYWN0QnV0dG9uO1xuICAgICAgICBpZiAoIXRoaXMucHJvcHMubXhFdmVudC5pc1JlZGFjdGVkKCkgJiYgIXRoaXMucHJvcHMuaXNCYXNlRXZlbnQgJiYgdGhpcy5zdGF0ZS5jYW5SZWRhY3QpIHtcbiAgICAgICAgICAgIHJlZGFjdEJ1dHRvbiA9IChcbiAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvbiBvbkNsaWNrPXt0aGlzLm9uUmVkYWN0Q2xpY2t9PlxuICAgICAgICAgICAgICAgICAgICB7IF90KFwiUmVtb3ZlXCIpIH1cbiAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHZpZXdTb3VyY2VCdXR0b24gPSAoXG4gICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvbiBvbkNsaWNrPXt0aGlzLm9uVmlld1NvdXJjZUNsaWNrfT5cbiAgICAgICAgICAgICAgICB7IF90KFwiVmlldyBTb3VyY2VcIikgfVxuICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICApO1xuICAgICAgICAvLyBkaXNhYmxlZCByZW1vdmUgYnV0dG9uIHdoZW4gbm90IGFsbG93ZWRcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfTWVzc2FnZUFjdGlvbkJhclwiPlxuICAgICAgICAgICAgICAgIHsgcmVkYWN0QnV0dG9uIH1cbiAgICAgICAgICAgICAgICB7IHZpZXdTb3VyY2VCdXR0b24gfVxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHVibGljIHJlbmRlcigpOiBKU1guRWxlbWVudCB7XG4gICAgICAgIGNvbnN0IHsgbXhFdmVudCB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgY29udGVudCA9IGdldFJlcGxhY2VkQ29udGVudChteEV2ZW50KTtcbiAgICAgICAgbGV0IGNvbnRlbnRDb250YWluZXI7XG4gICAgICAgIGlmIChteEV2ZW50LmlzUmVkYWN0ZWQoKSkge1xuICAgICAgICAgICAgY29udGVudENvbnRhaW5lciA9IDxSZWRhY3RlZEJvZHkgbXhFdmVudD17dGhpcy5wcm9wcy5teEV2ZW50fSAvPjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxldCBjb250ZW50RWxlbWVudHM7XG4gICAgICAgICAgICBpZiAodGhpcy5wcm9wcy5wcmV2aW91c0VkaXQpIHtcbiAgICAgICAgICAgICAgICBjb250ZW50RWxlbWVudHMgPSBlZGl0Qm9keURpZmZUb0h0bWwoZ2V0UmVwbGFjZWRDb250ZW50KHRoaXMucHJvcHMucHJldmlvdXNFZGl0KSwgY29udGVudCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnRlbnRFbGVtZW50cyA9IEh0bWxVdGlscy5ib2R5VG9IdG1sKFxuICAgICAgICAgICAgICAgICAgICBjb250ZW50LFxuICAgICAgICAgICAgICAgICAgICBudWxsLFxuICAgICAgICAgICAgICAgICAgICB7IHN0cmlwUmVwbHlGYWxsYmFjazogdHJ1ZSwgcmV0dXJuU3RyaW5nOiBmYWxzZSB9LFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAobXhFdmVudC5nZXRDb250ZW50KCkubXNndHlwZSA9PT0gXCJtLmVtb3RlXCIpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gbXhFdmVudC5zZW5kZXIgPyBteEV2ZW50LnNlbmRlci5uYW1lIDogbXhFdmVudC5nZXRTZW5kZXIoKTtcbiAgICAgICAgICAgICAgICBjb250ZW50Q29udGFpbmVyID0gKFxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0V2ZW50VGlsZV9jb250ZW50XCIgcmVmPXt0aGlzLmNvbnRlbnR9PiombmJzcDtcbiAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT1cIm14X01FbW90ZUJvZHlfc2VuZGVyXCI+eyBuYW1lIH08L3NwYW4+XG4gICAgICAgICAgICAgICAgICAgICAgICAmbmJzcDt7IGNvbnRlbnRFbGVtZW50cyB9XG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnRlbnRDb250YWluZXIgPSA8ZGl2IGNsYXNzTmFtZT1cIm14X0V2ZW50VGlsZV9jb250ZW50XCIgcmVmPXt0aGlzLmNvbnRlbnR9PnsgY29udGVudEVsZW1lbnRzIH08L2Rpdj47XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB0aW1lc3RhbXAgPSBmb3JtYXRUaW1lKG5ldyBEYXRlKG14RXZlbnQuZ2V0VHMoKSksIHRoaXMucHJvcHMuaXNUd2VsdmVIb3VyKTtcbiAgICAgICAgY29uc3QgaXNTZW5kaW5nID0gKFsnc2VuZGluZycsICdxdWV1ZWQnLCAnZW5jcnlwdGluZyddLmluZGV4T2YodGhpcy5zdGF0ZS5zZW5kU3RhdHVzKSAhPT0gLTEpO1xuICAgICAgICBjb25zdCBjbGFzc2VzID0gY2xhc3NOYW1lcyh7XG4gICAgICAgICAgICBcIm14X0V2ZW50VGlsZVwiOiB0cnVlLFxuICAgICAgICAgICAgLy8gTm90ZTogd2Uga2VlcCB0aGUgYHNlbmRpbmdgIHN0YXRlIGNsYXNzIGZvciB0ZXN0cywgbm90IGZvciBvdXIgc3R5bGVzXG4gICAgICAgICAgICBcIm14X0V2ZW50VGlsZV9zZW5kaW5nXCI6IGlzU2VuZGluZyxcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8bGk+XG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9e2NsYXNzZXN9PlxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0V2ZW50VGlsZV9saW5lXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9XCJteF9NZXNzYWdlVGltZXN0YW1wXCI+eyB0aW1lc3RhbXAgfTwvc3Bhbj5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgY29udGVudENvbnRhaW5lciB9XG4gICAgICAgICAgICAgICAgICAgICAgICB7IHRoaXMucmVuZGVyQWN0aW9uQmFyKCkgfVxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgIDwvbGk+XG4gICAgICAgICk7XG4gICAgfVxufVxuIl19