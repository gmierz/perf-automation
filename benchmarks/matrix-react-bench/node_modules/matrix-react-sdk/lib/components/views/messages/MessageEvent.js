"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var sdk = _interopRequireWildcard(require("../../../index"));

var _SettingsStore = _interopRequireDefault(require("../../../settings/SettingsStore"));

var _Mjolnir = require("../../../mjolnir/Mjolnir");

var _RedactedBody = _interopRequireDefault(require("./RedactedBody"));

var _UnknownBody = _interopRequireDefault(require("./UnknownBody"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _MediaEventHelper = require("../../../utils/MediaEventHelper");

var _event = require("matrix-js-sdk/src/@types/event");

var _consts = require("../../../polls/consts");

var _dec, _class;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

let MessageEvent = (_dec = (0, _replaceableComponent.replaceableComponent)("views.messages.MessageEvent"), _dec(_class = class MessageEvent extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "body", /*#__PURE__*/(0, _react.createRef)());
    (0, _defineProperty2.default)(this, "mediaHelper", void 0);
    (0, _defineProperty2.default)(this, "getEventTileOps", () => {
      var _this$body$current, _this$body$current$ge;

      return ((_this$body$current = this.body.current) === null || _this$body$current === void 0 ? void 0 : (_this$body$current$ge = _this$body$current.getEventTileOps) === null || _this$body$current$ge === void 0 ? void 0 : _this$body$current$ge.call(_this$body$current)) || null;
    });
    (0, _defineProperty2.default)(this, "onTileUpdate", () => {
      this.forceUpdate();
    });

    if (_MediaEventHelper.MediaEventHelper.isEligible(this.props.mxEvent)) {
      this.mediaHelper = new _MediaEventHelper.MediaEventHelper(this.props.mxEvent);
    }
  }

  componentWillUnmount() {
    var _this$mediaHelper;

    (_this$mediaHelper = this.mediaHelper) === null || _this$mediaHelper === void 0 ? void 0 : _this$mediaHelper.destroy();
  }

  componentDidUpdate(prevProps) {
    if (this.props.mxEvent !== prevProps.mxEvent && _MediaEventHelper.MediaEventHelper.isEligible(this.props.mxEvent)) {
      var _this$mediaHelper2;

      (_this$mediaHelper2 = this.mediaHelper) === null || _this$mediaHelper2 === void 0 ? void 0 : _this$mediaHelper2.destroy();
      this.mediaHelper = new _MediaEventHelper.MediaEventHelper(this.props.mxEvent);
    }
  }

  get bodyTypes() {
    return _objectSpread({
      [_event.MsgType.Text]: sdk.getComponent('messages.TextualBody'),
      [_event.MsgType.Notice]: sdk.getComponent('messages.TextualBody'),
      [_event.MsgType.Emote]: sdk.getComponent('messages.TextualBody'),
      [_event.MsgType.Image]: sdk.getComponent('messages.MImageBody'),
      [_event.MsgType.File]: sdk.getComponent('messages.MFileBody'),
      [_event.MsgType.Audio]: sdk.getComponent('messages.MVoiceOrAudioBody'),
      [_event.MsgType.Video]: sdk.getComponent('messages.MVideoBody')
    }, this.props.overrideBodyTypes || {});
  }

  get evTypes() {
    return _objectSpread({
      [_event.EventType.Sticker]: sdk.getComponent('messages.MStickerBody')
    }, this.props.overrideEventTypes || {});
  }

  getMediaHelper() {
    return this.mediaHelper;
  }

  render() {
    const content = this.props.mxEvent.getContent();
    const type = this.props.mxEvent.getType();
    const msgtype = content.msgtype;
    let BodyType = _RedactedBody.default;

    if (!this.props.mxEvent.isRedacted()) {
      // only resolve BodyType if event is not redacted
      if (type && this.evTypes[type]) {
        BodyType = this.evTypes[type];
      } else if (msgtype && this.bodyTypes[msgtype]) {
        BodyType = this.bodyTypes[msgtype];
      } else if (content.url) {
        // Fallback to MFileBody if there's a content URL
        BodyType = this.bodyTypes[_event.MsgType.File];
      } else {
        // Fallback to UnknownBody otherwise if not redacted
        BodyType = _UnknownBody.default;
      }

      if (type && type === _consts.POLL_START_EVENT_TYPE.name) {
        // TODO: this can all disappear when Polls comes out of labs -
        // instead, add something like this into this.evTypes:
        // [EventType.Poll]: "messages.MPollBody"
        if (_SettingsStore.default.getValue("feature_polls")) {
          BodyType = sdk.getComponent('messages.MPollBody');
        }
      }
    }

    if (_SettingsStore.default.getValue("feature_mjolnir")) {
      const key = `mx_mjolnir_render_${this.props.mxEvent.getRoomId()}__${this.props.mxEvent.getId()}`;
      const allowRender = localStorage.getItem(key) === "true";

      if (!allowRender) {
        const userDomain = this.props.mxEvent.getSender().split(':').slice(1).join(':');

        const userBanned = _Mjolnir.Mjolnir.sharedInstance().isUserBanned(this.props.mxEvent.getSender());

        const serverBanned = _Mjolnir.Mjolnir.sharedInstance().isServerBanned(userDomain);

        if (userBanned || serverBanned) {
          BodyType = sdk.getComponent('messages.MjolnirBody');
        }
      }
    } // @ts-ignore - this is a dynamic react component


    return BodyType ? /*#__PURE__*/_react.default.createElement(BodyType, {
      ref: this.body,
      mxEvent: this.props.mxEvent,
      highlights: this.props.highlights,
      highlightLink: this.props.highlightLink,
      showUrlPreview: this.props.showUrlPreview,
      tileShape: this.props.tileShape,
      forExport: this.props.forExport,
      maxImageHeight: this.props.maxImageHeight,
      replacingEventId: this.props.replacingEventId,
      editState: this.props.editState,
      onHeightChanged: this.props.onHeightChanged,
      onMessageAllowed: this.onTileUpdate,
      permalinkCreator: this.props.permalinkCreator,
      mediaEventHelper: this.mediaHelper,
      getRelationsForEvent: this.props.getRelationsForEvent
    }) : null;
  }

}) || _class);
exports.default = MessageEvent;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL21lc3NhZ2VzL01lc3NhZ2VFdmVudC50c3giXSwibmFtZXMiOlsiTWVzc2FnZUV2ZW50IiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwiYm9keSIsImN1cnJlbnQiLCJnZXRFdmVudFRpbGVPcHMiLCJmb3JjZVVwZGF0ZSIsIk1lZGlhRXZlbnRIZWxwZXIiLCJpc0VsaWdpYmxlIiwibXhFdmVudCIsIm1lZGlhSGVscGVyIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJkZXN0cm95IiwiY29tcG9uZW50RGlkVXBkYXRlIiwicHJldlByb3BzIiwiYm9keVR5cGVzIiwiTXNnVHlwZSIsIlRleHQiLCJzZGsiLCJnZXRDb21wb25lbnQiLCJOb3RpY2UiLCJFbW90ZSIsIkltYWdlIiwiRmlsZSIsIkF1ZGlvIiwiVmlkZW8iLCJvdmVycmlkZUJvZHlUeXBlcyIsImV2VHlwZXMiLCJFdmVudFR5cGUiLCJTdGlja2VyIiwib3ZlcnJpZGVFdmVudFR5cGVzIiwiZ2V0TWVkaWFIZWxwZXIiLCJyZW5kZXIiLCJjb250ZW50IiwiZ2V0Q29udGVudCIsInR5cGUiLCJnZXRUeXBlIiwibXNndHlwZSIsIkJvZHlUeXBlIiwiUmVkYWN0ZWRCb2R5IiwiaXNSZWRhY3RlZCIsInVybCIsIlVua25vd25Cb2R5IiwiUE9MTF9TVEFSVF9FVkVOVF9UWVBFIiwibmFtZSIsIlNldHRpbmdzU3RvcmUiLCJnZXRWYWx1ZSIsImtleSIsImdldFJvb21JZCIsImdldElkIiwiYWxsb3dSZW5kZXIiLCJsb2NhbFN0b3JhZ2UiLCJnZXRJdGVtIiwidXNlckRvbWFpbiIsImdldFNlbmRlciIsInNwbGl0Iiwic2xpY2UiLCJqb2luIiwidXNlckJhbm5lZCIsIk1qb2xuaXIiLCJzaGFyZWRJbnN0YW5jZSIsImlzVXNlckJhbm5lZCIsInNlcnZlckJhbm5lZCIsImlzU2VydmVyQmFubmVkIiwiaGlnaGxpZ2h0cyIsImhpZ2hsaWdodExpbmsiLCJzaG93VXJsUHJldmlldyIsInRpbGVTaGFwZSIsImZvckV4cG9ydCIsIm1heEltYWdlSGVpZ2h0IiwicmVwbGFjaW5nRXZlbnRJZCIsImVkaXRTdGF0ZSIsIm9uSGVpZ2h0Q2hhbmdlZCIsIm9uVGlsZVVwZGF0ZSIsInBlcm1hbGlua0NyZWF0b3IiLCJnZXRSZWxhdGlvbnNGb3JFdmVudCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFnQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0E7O0FBRUE7O0FBRUE7Ozs7Ozs7Ozs7OztJQWNxQkEsWSxXQURwQixnREFBcUIsNkJBQXJCLEMsZ0JBQUQsTUFDcUJBLFlBRHJCLFNBQzBDQyxlQUFNQyxTQURoRCxDQUM0RztBQUlqR0MsRUFBQUEsV0FBVyxDQUFDQyxLQUFELEVBQWdCO0FBQzlCLFVBQU1BLEtBQU47QUFEOEIsNkRBSG9DLHVCQUdwQztBQUFBO0FBQUEsMkRBeUNULE1BQU07QUFBQTs7QUFDM0IsYUFBTyx1QkFBQyxLQUFLQyxJQUFMLENBQVVDLE9BQVgsbUdBQTJDQyxlQUEzQyw2R0FBa0UsSUFBekU7QUFDSCxLQTNDaUM7QUFBQSx3REFpRFgsTUFBTTtBQUN6QixXQUFLQyxXQUFMO0FBQ0gsS0FuRGlDOztBQUc5QixRQUFJQyxtQ0FBaUJDLFVBQWpCLENBQTRCLEtBQUtOLEtBQUwsQ0FBV08sT0FBdkMsQ0FBSixFQUFxRDtBQUNqRCxXQUFLQyxXQUFMLEdBQW1CLElBQUlILGtDQUFKLENBQXFCLEtBQUtMLEtBQUwsQ0FBV08sT0FBaEMsQ0FBbkI7QUFDSDtBQUNKOztBQUVNRSxFQUFBQSxvQkFBb0IsR0FBRztBQUFBOztBQUMxQiw4QkFBS0QsV0FBTCx3RUFBa0JFLE9BQWxCO0FBQ0g7O0FBRU1DLEVBQUFBLGtCQUFrQixDQUFDQyxTQUFELEVBQThCO0FBQ25ELFFBQUksS0FBS1osS0FBTCxDQUFXTyxPQUFYLEtBQXVCSyxTQUFTLENBQUNMLE9BQWpDLElBQTRDRixtQ0FBaUJDLFVB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S0FBS2hFLEtBQUwsQ0FBV2lFLFNBTlI7QUFPZCxNQUFBLFNBQVMsRUFBRSxLQUFLakUsS0FBTCxDQUFXa0UsU0FQUjtBQVFkLE1BQUEsY0FBYyxFQUFFLEtBQUtsRSxLQUFMLENBQVdtRSxjQVJiO0FBU2QsTUFBQSxnQkFBZ0IsRUFBRSxLQUFLbkUsS0FBTCxDQUFXb0UsZ0JBVGY7QUFVZCxNQUFBLFNBQVMsRUFBRSxLQUFLcEUsS0FBTCxDQUFXcUUsU0FWUjtBQVdkLE1BQUEsZUFBZSxFQUFFLEtBQUtyRSxLQUFMLENBQVdzRSxlQVhkO0FBWWQsTUFBQSxnQkFBZ0IsRUFBRSxLQUFLQyxZQVpUO0FBYWQsTUFBQSxnQkFBZ0IsRUFBRSxLQUFLdkUsS0FBTCxDQUFXd0UsZ0JBYmY7QUFjZCxNQUFBLGdCQUFnQixFQUFFLEtBQUtoRSxXQWRUO0FBZWQsTUFBQSxvQkFBb0IsRUFBRSxLQUFLUixLQUFMLENBQVd5RTtBQWZuQixNQUFILEdBZ0JWLElBaEJMO0FBaUJIOztBQXZIdUcsQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNSAtIDIwMjEgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QsIHsgY3JlYXRlUmVmIH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0ICogYXMgc2RrIGZyb20gJy4uLy4uLy4uL2luZGV4JztcbmltcG9ydCBTZXR0aW5nc1N0b3JlIGZyb20gXCIuLi8uLi8uLi9zZXR0aW5ncy9TZXR0aW5nc1N0b3JlXCI7XG5pbXBvcnQgeyBNam9sbmlyIH0gZnJvbSBcIi4uLy4uLy4uL21qb2xuaXIvTWpvbG5pclwiO1xuaW1wb3J0IFJlZGFjdGVkQm9keSBmcm9tIFwiLi9SZWRhY3RlZEJvZHlcIjtcbmltcG9ydCBVbmtub3duQm9keSBmcm9tIFwiLi9Vbmtub3duQm9keVwiO1xuaW1wb3J0IHsgcmVwbGFjZWFibGVDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvcmVwbGFjZWFibGVDb21wb25lbnRcIjtcbmltcG9ydCB7IElNZWRpYUJvZHkgfSBmcm9tIFwiLi9JTWVkaWFCb2R5XCI7XG5pbXBvcnQgeyBJT3BlcmFibGVFdmVudFRpbGUgfSBmcm9tIFwiLi4vY29udGV4dF9tZW51cy9NZXNzYWdlQ29udGV4dE1lbnVcIjtcbmltcG9ydCB7IE1lZGlhRXZlbnRIZWxwZXIgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvTWVkaWFFdmVudEhlbHBlclwiO1xuaW1wb3J0IHsgUmVhY3RBbnlDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vQHR5cGVzL2NvbW1vblwiO1xuaW1wb3J0IHsgRXZlbnRUeXBlLCBNc2dUeXBlIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL0B0eXBlcy9ldmVudFwiO1xuaW1wb3J0IHsgSUJvZHlQcm9wcyB9IGZyb20gXCIuL0lCb2R5UHJvcHNcIjtcbmltcG9ydCB7IFBPTExfU1RBUlRfRVZFTlRfVFlQRSB9IGZyb20gJy4uLy4uLy4uL3BvbGxzL2NvbnN0cyc7XG5pbXBvcnQgeyBSZWxhdGlvbnMgfSBmcm9tICdtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvcmVsYXRpb25zJztcblxuLy8gb25NZXNzYWdlQWxsb3dlZCBpcyBoYW5kbGVkIGludGVybmFsbHlcbmludGVyZmFjZSBJUHJvcHMgZXh0ZW5kcyBPbWl0PElCb2R5UHJvcHMsIFwib25NZXNzYWdlQWxsb3dlZFwiPiB7XG4gICAgLyogb3ZlcnJpZGVzIGZvciB0aGUgbXNndHlwZS1zcGVjaWZpYyBjb21wb25lbnRzLCB1c2VkIGJ5IFJlcGx5VGlsZSB0byBvdmVycmlkZSBmaWxlIHJlbmRlcmluZyAqL1xuICAgIG92ZXJyaWRlQm9keVR5cGVzPzogUmVjb3JkPHN0cmluZywgUmVhY3QuQ29tcG9uZW50PjtcbiAgICBvdmVycmlkZUV2ZW50VHlwZXM/OiBSZWNvcmQ8c3RyaW5nLCBSZWFjdC5Db21wb25lbnQ+O1xuXG4gICAgLy8gaGVscGVyIGZ1bmN0aW9uIHRvIGFjY2VzcyByZWxhdGlvbnMgZm9yIHRoaXMgZXZlbnRcbiAgICBnZXRSZWxhdGlvbnNGb3JFdmVudD86IChldmVudElkOiBzdHJpbmcsIHJlbGF0aW9uVHlwZTogc3RyaW5nLCBldmVudFR5cGU6IHN0cmluZykgPT4gUmVsYXRpb25zO1xufVxuXG5AcmVwbGFjZWFibGVDb21wb25lbnQoXCJ2aWV3cy5tZXNzYWdlcy5NZXNzYWdlRXZlbnRcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE1lc3NhZ2VFdmVudCBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxJUHJvcHM+IGltcGxlbWVudHMgSU1lZGlhQm9keSwgSU9wZXJhYmxlRXZlbnRUaWxlIHtcbiAgICBwcml2YXRlIGJvZHk6IFJlYWN0LlJlZk9iamVjdDxSZWFjdC5Db21wb25lbnQgfCBJT3BlcmFibGVFdmVudFRpbGU+ID0gY3JlYXRlUmVmKCk7XG4gICAgcHJpdmF0ZSBtZWRpYUhlbHBlcjogTWVkaWFFdmVudEhlbHBlcjtcblxuICAgIHB1YmxpYyBjb25zdHJ1Y3Rvcihwcm9wczogSVByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcblxuICAgICAgICBpZiAoTWVkaWFFdmVudEhlbHBlci5pc0VsaWdpYmxlKHRoaXMucHJvcHMubXhFdmVudCkpIHtcbiAgICAgICAgICAgIHRoaXMubWVkaWFIZWxwZXIgPSBuZXcgTWVkaWFFdmVudEhlbHBlcih0aGlzLnByb3BzLm14RXZlbnQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgICB0aGlzLm1lZGlhSGVscGVyPy5kZXN0cm95KCk7XG4gICAgfVxuXG4gICAgcHVibGljIGNvbXBvbmVudERpZFVwZGF0ZShwcmV2UHJvcHM6IFJlYWRvbmx5PElQcm9wcz4pIHtcbiAgICAgICAgaWYgKHRoaXMucHJvcHMubXhFdmVudCAhPT0gcHJldlByb3BzLm14RXZlbnQgJiYgTWVkaWFFdmVudEhlbHBlci5pc0VsaWdpYmxlKHRoaXMucHJvcHMubXhFdmVudCkpIHtcbiAgICAgICAgICAgIHRoaXMubWVkaWFIZWxwZXI/LmRlc3Ryb3koKTtcbiAgICAgICAgICAgIHRoaXMubWVkaWFIZWxwZXIgPSBuZXcgTWVkaWFFdmVudEhlbHBlcih0aGlzLnByb3BzLm14RXZlbnQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXQgYm9keVR5cGVzKCk6IFJlY29yZDxzdHJpbmcsIFJlYWN0LkNvbXBvbmVudD4ge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgW01zZ1R5cGUuVGV4dF06IHNkay5nZXRDb21wb25lbnQoJ21lc3NhZ2VzLlRleHR1YWxCb2R5JyksXG4gICAgICAgICAgICBbTXNnVHlwZS5Ob3RpY2VdOiBzZGsuZ2V0Q29tcG9uZW50KCdtZXNzYWdlcy5UZXh0dWFsQm9keScpLFxuICAgICAgICAgICAgW01zZ1R5cGUuRW1vdGVdOiBzZGsuZ2V0Q29tcG9uZW50KCdtZXNzYWdlcy5UZXh0dWFsQm9keScpLFxuICAgICAgICAgICAgW01zZ1R5cGUuSW1hZ2VdOiBzZGsuZ2V0Q29tcG9uZW50KCdtZXNzYWdlcy5NSW1hZ2VCb2R5JyksXG4gICAgICAgICAgICBbTXNnVHlwZS5GaWxlXTogc2RrLmdldENvbXBvbmVudCgnbWVzc2FnZXMuTUZpbGVCb2R5JyksXG4gICAgICAgICAgICBbTXNnVHlwZS5BdWRpb106IHNkay5nZXRDb21wb25lbnQoJ21lc3NhZ2VzLk1Wb2ljZU9yQXVkaW9Cb2R5JyksXG4gICAgICAgICAgICBbTXNnVHlwZS5WaWRlb106IHNkay5nZXRDb21wb25lbnQoJ21lc3NhZ2VzLk1WaWRlb0JvZHknKSxcblxuICAgICAgICAgICAgLi4uKHRoaXMucHJvcHMub3ZlcnJpZGVCb2R5VHlwZXMgfHwge30pLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0IGV2VHlwZXMoKTogUmVjb3JkPHN0cmluZywgUmVhY3QuQ29tcG9uZW50PiB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBbRXZlbnRUeXBlLlN0aWNrZXJdOiBzZGsuZ2V0Q29tcG9uZW50KCdtZXNzYWdlcy5NU3RpY2tlckJvZHknKSxcblxuICAgICAgICAgICAgLi4uKHRoaXMucHJvcHMub3ZlcnJpZGVFdmVudFR5cGVzIHx8IHt9KSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0RXZlbnRUaWxlT3BzID0gKCkgPT4ge1xuICAgICAgICByZXR1cm4gKHRoaXMuYm9keS5jdXJyZW50IGFzIElPcGVyYWJsZUV2ZW50VGlsZSk/LmdldEV2ZW50VGlsZU9wcz8uKCkgfHwgbnVsbDtcbiAgICB9O1xuXG4gICAgcHVibGljIGdldE1lZGlhSGVscGVyKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5tZWRpYUhlbHBlcjtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uVGlsZVVwZGF0ZSA9ICgpID0+IHtcbiAgICAgICAgdGhpcy5mb3JjZVVwZGF0ZSgpO1xuICAgIH07XG5cbiAgICBwdWJsaWMgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCBjb250ZW50ID0gdGhpcy5wcm9wcy5teEV2ZW50LmdldENvbnRlbnQoKTtcbiAgICAgICAgY29uc3QgdHlwZSA9IHRoaXMucHJvcHMubXhFdmVudC5nZXRUeXBlKCk7XG4gICAgICAgIGNvbnN0IG1zZ3R5cGUgPSBjb250ZW50Lm1zZ3R5cGU7XG4gICAgICAgIGxldCBCb2R5VHlwZTogUmVhY3RBbnlDb21wb25lbnQgPSBSZWRhY3RlZEJvZHk7XG4gICAgICAgIGlmICghdGhpcy5wcm9wcy5teEV2ZW50LmlzUmVkYWN0ZWQoKSkge1xuICAgICAgICAgICAgLy8gb25seSByZXNvbHZlIEJvZHlUeXBlIGlmIGV2ZW50IGlzIG5vdCByZWRhY3RlZFxuICAgICAgICAgICAgaWYgKHR5cGUgJiYgdGhpcy5ldlR5cGVzW3R5cGVdKSB7XG4gICAgICAgICAgICAgICAgQm9keVR5cGUgPSB0aGlzLmV2VHlwZXNbdHlwZV07XG4gICAgICAgICAgICB9IGVsc2UgaWYgKG1zZ3R5cGUgJiYgdGhpcy5ib2R5VHlwZXNbbXNndHlwZV0pIHtcbiAgICAgICAgICAgICAgICBCb2R5VHlwZSA9IHRoaXMuYm9keVR5cGVzW21zZ3R5cGVdO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChjb250ZW50LnVybCkge1xuICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrIHRvIE1GaWxlQm9keSBpZiB0aGVyZSdzIGEgY29udGVudCBVUkxcbiAgICAgICAgICAgICAgICBCb2R5VHlwZSA9IHRoaXMuYm9keVR5cGVzW01zZ1R5cGUuRmlsZV07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrIHRvIFVua25vd25Cb2R5IG90aGVyd2lzZSBpZiBub3QgcmVkYWN0ZWRcbiAgICAgICAgICAgICAgICBCb2R5VHlwZSA9IFVua25vd25Cb2R5O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAodHlwZSAmJiB0eXBlID09PSBQT0xMX1NUQVJUX0VWRU5UX1RZUEUubmFtZSkge1xuICAgICAgICAgICAgICAgIC8vIFRPRE86IHRoaXMgY2FuIGFsbCBkaXNhcHBlYXIgd2hlbiBQb2xscyBjb21lcyBvdXQgb2YgbGFicyAtXG4gICAgICAgICAgICAgICAgLy8gaW5zdGVhZCwgYWRkIHNvbWV0aGluZyBsaWtlIHRoaXMgaW50byB0aGlzLmV2VHlwZXM6XG4gICAgICAgICAgICAgICAgLy8gW0V2ZW50VHlwZS5Qb2xsXTogXCJtZXNzYWdlcy5NUG9sbEJvZHlcIlxuICAgICAgICAgICAgICAgIGlmIChTZXR0aW5nc1N0b3JlLmdldFZhbHVlKFwiZmVhdHVyZV9wb2xsc1wiKSkge1xuICAgICAgICAgICAgICAgICAgICBCb2R5VHlwZSA9IHNkay5nZXRDb21wb25lbnQoJ21lc3NhZ2VzLk1Qb2xsQm9keScpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChTZXR0aW5nc1N0b3JlLmdldFZhbHVlKFwiZmVhdHVyZV9tam9sbmlyXCIpKSB7XG4gICAgICAgICAgICBjb25zdCBrZXkgPSBgbXhfbWpvbG5pcl9yZW5kZXJfJHt0aGlzLnByb3BzLm14RXZlbnQuZ2V0Um9vbUlkKCl9X18ke3RoaXMucHJvcHMubXhFdmVudC5nZXRJZCgpfWA7XG4gICAgICAgICAgICBjb25zdCBhbGxvd1JlbmRlciA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleSkgPT09IFwidHJ1ZVwiO1xuXG4gICAgICAgICAgICBpZiAoIWFsbG93UmVuZGVyKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdXNlckRvbWFpbiA9IHRoaXMucHJvcHMubXhFdmVudC5nZXRTZW5kZXIoKS5zcGxpdCgnOicpLnNsaWNlKDEpLmpvaW4oJzonKTtcbiAgICAgICAgICAgICAgICBjb25zdCB1c2VyQmFubmVkID0gTWpvbG5pci5zaGFyZWRJbnN0YW5jZSgpLmlzVXNlckJhbm5lZCh0aGlzLnByb3BzLm14RXZlbnQuZ2V0U2VuZGVyKCkpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHNlcnZlckJhbm5lZCA9IE1qb2xuaXIuc2hhcmVkSW5zdGFuY2UoKS5pc1NlcnZlckJhbm5lZCh1c2VyRG9tYWluKTtcblxuICAgICAgICAgICAgICAgIGlmICh1c2VyQmFubmVkIHx8IHNlcnZlckJhbm5lZCkge1xuICAgICAgICAgICAgICAgICAgICBCb2R5VHlwZSA9IHNkay5nZXRDb21wb25lbnQoJ21lc3NhZ2VzLk1qb2xuaXJCb2R5Jyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gQHRzLWlnbm9yZSAtIHRoaXMgaXMgYSBkeW5hbWljIHJlYWN0IGNvbXBvbmVudFxuICAgICAgICByZXR1cm4gQm9keVR5cGUgPyA8Qm9keVR5cGVcbiAgICAgICAgICAgIHJlZj17dGhpcy5ib2R5fVxuICAgICAgICAgICAgbXhFdmVudD17dGhpcy5wcm9wcy5teEV2ZW50fVxuICAgICAgICAgICAgaGlnaGxpZ2h0cz17dGhpcy5wcm9wcy5oaWdobGlnaHRzfVxuICAgICAgICAgICAgaGlnaGxpZ2h0TGluaz17dGhpcy5wcm9wcy5oaWdobGlnaHRMaW5rfVxuICAgICAgICAgICAgc2hvd1VybFByZXZpZXc9e3RoaXMucHJvcHMuc2hvd1VybFByZXZpZXd9XG4gICAgICAgICAgICB0aWxlU2hhcGU9e3RoaXMucHJvcHMudGlsZVNoYXBlfVxuICAgICAgICAgICAgZm9yRXhwb3J0PXt0aGlzLnByb3BzLmZvckV4cG9ydH1cbiAgICAgICAgICAgIG1heEltYWdlSGVpZ2h0PXt0aGlzLnByb3BzLm1heEltYWdlSGVpZ2h0fVxuICAgICAgICAgICAgcmVwbGFjaW5nRXZlbnRJZD17dGhpcy5wcm9wcy5yZXBsYWNpbmdFdmVudElkfVxuICAgICAgICAgICAgZWRpdFN0YXRlPXt0aGlzLnByb3BzLmVkaXRTdGF0ZX1cbiAgICAgICAgICAgIG9uSGVpZ2h0Q2hhbmdlZD17dGhpcy5wcm9wcy5vbkhlaWdodENoYW5nZWR9XG4gICAgICAgICAgICBvbk1lc3NhZ2VBbGxvd2VkPXt0aGlzLm9uVGlsZVVwZGF0ZX1cbiAgICAgICAgICAgIHBlcm1hbGlua0NyZWF0b3I9e3RoaXMucHJvcHMucGVybWFsaW5rQ3JlYXRvcn1cbiAgICAgICAgICAgIG1lZGlhRXZlbnRIZWxwZXI9e3RoaXMubWVkaWFIZWxwZXJ9XG4gICAgICAgICAgICBnZXRSZWxhdGlvbnNGb3JFdmVudD17dGhpcy5wcm9wcy5nZXRSZWxhdGlvbnNGb3JFdmVudH1cbiAgICAgICAgLz4gOiBudWxsO1xuICAgIH1cbn1cbiJdfQ==