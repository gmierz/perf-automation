"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var _languageHandler = require("../../../languageHandler");

var _MemberAvatar = _interopRequireDefault(require("../avatars/MemberAvatar"));

var _CallEventGrouper = require("../../structures/CallEventGrouper");

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _call = require("matrix-js-sdk/src/webrtc/call");

var _InfoTooltip = _interopRequireWildcard(require("../elements/InfoTooltip"));

var _classnames = _interopRequireDefault(require("classnames"));

var _AccessibleTooltipButton = _interopRequireDefault(require("../elements/AccessibleTooltipButton"));

var _DateUtils = require("../../../DateUtils");

var _Clock = _interopRequireDefault(require("../audio_messages/Clock"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/*
Copyright 2021 Šimon Brandner <simon.bra.ag@gmail.com>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const MAX_NON_NARROW_WIDTH = 450 / 70 * 100;

class CallEvent extends _react.default.PureComponent {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "wrapperElement", /*#__PURE__*/(0, _react.createRef)());
    (0, _defineProperty2.default)(this, "resizeObserver", void 0);
    (0, _defineProperty2.default)(this, "onLengthChanged", length => {
      this.setState({
        length
      });
    });
    (0, _defineProperty2.default)(this, "resizeObserverCallback", entries => {
      const wrapperElementEntry = entries.find(entry => entry.target === this.wrapperElement.current);
      if (!wrapperElementEntry) return;
      this.setState({
        narrow: wrapperElementEntry.contentRect.width < MAX_NON_NARROW_WIDTH
      });
    });
    (0, _defineProperty2.default)(this, "onSilencedChanged", newState => {
      this.setState({
        silenced: newState
      });
    });
    (0, _defineProperty2.default)(this, "onStateChanged", newState => {
      this.setState({
        callState: newState
      });
    });
    this.state = {
      callState: this.props.callEventGrouper.state,
      silenced: false,
      narrow: false,
      length: 0
    };
  }

  componentDidMount() {
    this.props.callEventGrouper.addListener(_CallEventGrouper.CallEventGrouperEvent.StateChanged, this.onStateChanged);
    this.props.callEventGrouper.addListener(_CallEventGrouper.CallEventGrouperEvent.SilencedChanged, this.onSilencedChanged);
    this.props.callEventGrouper.addListener(_CallEventGrouper.CallEventGrouperEvent.LengthChanged, this.onLengthChanged);
    this.resizeObserver = new ResizeObserver(this.resizeObserverCallback);
    this.resizeObserver.observe(this.wrapperElement.current);
  }

  componentWillUnmount() {
    this.props.callEventGrouper.removeListener(_CallEventGrouper.CallEventGrouperEvent.StateChanged, this.onStateChanged);
    this.props.callEventGrouper.removeListener(_CallEventGrouper.CallEventGrouperEvent.SilencedChanged, this.onSilencedChanged);
    this.props.callEventGrouper.removeListener(_CallEventGrouper.CallEventGrouperEvent.LengthChanged, this.onLengthChanged);
    this.resizeObserver.disconnect();
  }

  renderCallBackButton(text) {
    return /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      className: "mx_CallEvent_content_button mx_CallEvent_content_button_callBack",
      onClick: this.props.callEventGrouper.callBack,
      kind: "primary"
    }, /*#__PURE__*/_react.default.createElement("span", null, " ", text, " "));
  }

  renderSilenceIcon() {
    const silenceClass = (0, _classnames.default)({
      "mx_CallEvent_iconButton": true,
      "mx_CallEvent_unSilence": this.state.silenced,
      "mx_CallEvent_silence": !this.state.silenced
    });
    return /*#__PURE__*/_react.default.createElement(_AccessibleTooltipButton.default, {
      className: silenceClass,
      onClick: this.props.callEventGrouper.toggleSilenced,
      title: this.state.silenced ? (0, _languageHandler._t)("Sound on") : (0, _languageHandler._t)("Silence call")
    });
  }

  renderContent(state) {
    if (state === _call.CallState.Ringing) {
      let silenceIcon;

      if (!this.state.narrow) {
        silenceIcon = this.renderSilenceIcon();
      }

      return /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_CallEvent_content"
      }, silenceIcon, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        className: "mx_CallEvent_content_button mx_CallEvent_content_button_reject",
        onClick: this.props.callEventGrouper.rejectCall,
        kind: "danger"
      }, /*#__PURE__*/_react.default.createElement("span", null, " ", (0, _languageHandler._t)("Decline"), " ")), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        className: "mx_CallEvent_content_button mx_CallEvent_content_button_answer",
        onClick: this.props.callEventGrouper.answerCall,
        kind: "primary"
      }, /*#__PURE__*/_react.default.createElement("span", null, " ", (0, _languageHandler._t)("Accept"), " ")));
    }

    if (state === _call.CallState.Ended) {
      const hangupReason = this.props.callEventGrouper.hangupReason;
      const gotRejected = this.props.callEventGrouper.gotRejected;

      if (gotRejected) {
        return /*#__PURE__*/_react.default.createElement("div", {
          className: "mx_CallEvent_content"
        }, (0, _languageHandler._t)("Call declined"), this.renderCallBackButton((0, _languageHandler._t)("Call back")));
      } else if ([_call.CallErrorCode.UserHangup, "user hangup"].includes(hangupReason) || !hangupReason) {
        // workaround for https://github.com/vector-im/element-web/issues/5178
        // it seems Android randomly sets a reason of "user hangup" which is
        // interpreted as an error code :(
        // https://github.com/vector-im/riot-android/issues/2623
        // Also the correct hangup code as of VoIP v1 (with underscore)
        // Also, if we don't have a reason
        const duration = this.props.callEventGrouper.duration;
        let text = (0, _languageHandler._t)("Call ended");

        if (duration) {
          text += " • " + (0, _DateUtils.formatCallTime)(duration);
        }

        return /*#__PURE__*/_react.default.createElement("div", {
          className: "mx_CallEvent_content"
        }, text);
      } else if (hangupReason === _call.CallErrorCode.InviteTimeout) {
        return /*#__PURE__*/_react.default.createElement("div", {
          className: "mx_CallEvent_content"
        }, (0, _languageHandler._t)("No answer"), this.renderCallBackButton((0, _languageHandler._t)("Call back")));
      }

      let reason;

      if (hangupReason === _call.CallErrorCode.IceFailed) {
        // We couldn't establish a connection at all
        reason = (0, _languageHandler._t)("Could not connect media");
      } else if (hangupReason === "ice_timeout") {
        // We established a connection but it died
        reason = (0, _languageHandler._t)("Connection failed");
      } else if (hangupReason === _call.CallErrorCode.NoUserMedia) {
        // The other side couldn't open capture devices
        reason = (0, _languageHandler._t)("Their device couldn't start the camera or microphone");
      } else if (hangupReason === "unknown_error") {
        // An error code the other side doesn't have a way to express
        // (as opposed to an error code they gave but we don't know about,
        // in which case we show the error code)
        reason = (0, _languageHandler._t)("An unknown error occurred");
      } else if (hangupReason === _call.CallErrorCode.UserBusy) {
        reason = (0, _languageHandler._t)("The user you called is busy.");
      } else {
        reason = (0, _languageHandler._t)('Unknown failure: %(reason)s', {
          reason: hangupReason
        });
      }

      return /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_CallEvent_content"
      }, /*#__PURE__*/_react.default.createElement(_InfoTooltip.default, {
        tooltip: reason,
        className: "mx_CallEvent_content_tooltip",
        kind: _InfoTooltip.InfoTooltipKind.Warning
      }), (0, _languageHandler._t)("Connection failed"), this.renderCallBackButton((0, _languageHandler._t)("Retry")));
    }

    if (state === _call.CallState.Connected) {
      return /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_CallEvent_content"
      }, /*#__PURE__*/_react.default.createElement(_Clock.default, {
        seconds: this.state.length
      }));
    }

    if (state === _call.CallState.Connecting) {
      return /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_CallEvent_content"
      }, (0, _languageHandler._t)("Connecting"));
    }

    if (state === _CallEventGrouper.CustomCallState.Missed) {
      return /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_CallEvent_content"
      }, (0, _languageHandler._t)("Missed call"), this.renderCallBackButton((0, _languageHandler._t)("Call back")));
    }

    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_CallEvent_content"
    }, (0, _languageHandler._t)("The call is in an unknown state!"));
  }

  render() {
    const event = this.props.mxEvent;
    const sender = event.sender ? event.sender.name : event.getSender();
    const isVoice = this.props.callEventGrouper.isVoice;
    const callType = isVoice ? (0, _languageHandler._t)("Voice call") : (0, _languageHandler._t)("Video call");
    const callState = this.state.callState;
    const hangupReason = this.props.callEventGrouper.hangupReason;
    const content = this.renderContent(callState);
    const className = (0, _classnames.default)("mx_CallEvent", {
      mx_CallEvent_voice: isVoice,
      mx_CallEvent_video: !isVoice,
      mx_CallEvent_narrow: this.state.narrow,
      mx_CallEvent_missed: callState === _CallEventGrouper.CustomCallState.Missed,
      mx_CallEvent_noAnswer: callState === _call.CallState.Ended && hangupReason === _call.CallErrorCode.InviteTimeout,
      mx_CallEvent_rejected: callState === _call.CallState.Ended && this.props.callEventGrouper.gotRejected
    });
    let silenceIcon;

    if (this.state.narrow && this.state.callState === _call.CallState.Ringing) {
      silenceIcon = this.renderSilenceIcon();
    }

    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_CallEvent_wrapper",
      ref: this.wrapperElement
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: className
    }, silenceIcon, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_CallEvent_info"
    }, /*#__PURE__*/_react.default.createElement(_MemberAvatar.default, {
      member: event.sender,
      width: 32,
      height: 32
    }), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_CallEvent_info_basic"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_CallEvent_sender"
    }, sender), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_CallEvent_type"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_CallEvent_type_icon"
    }), callType))), content));
  }

}

exports.default = CallEvent;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL21lc3NhZ2VzL0NhbGxFdmVudC50c3giXSwibmFtZXMiOlsiTUFYX05PTl9OQVJST1dfV0lEVEgiLCJDYWxsRXZlbnQiLCJSZWFjdCIsIlB1cmVDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwibGVuZ3RoIiwic2V0U3RhdGUiLCJlbnRyaWVzIiwid3JhcHBlckVsZW1lbnRFbnRyeSIsImZpbmQiLCJlbnRyeSIsInRhcmdldCIsIndyYXBwZXJFbGVtZW50IiwiY3VycmVudCIsIm5hcnJvdyIsImNvbnRlbnRSZWN0Iiwid2lkdGgiLCJuZXdTdGF0ZSIsInNpbGVuY2VkIiwiY2FsbFN0YXRlIiwic3RhdGUiLCJjYWxsRXZlbnRHcm91cGVyIiwiY29tcG9uZW50RGlkTW91bnQiLCJhZGRMaXN0ZW5lciIsIkNhbGxFdmVudEdyb3VwZXJFdmVudCIsIlN0YXRlQ2hhbmdlZCIsIm9uU3RhdGVDaGFuZ2VkIiwiU2lsZW5jZWRDaGFuZ2VkIiwib25TaWxlbmNlZENoYW5nZWQiLCJMZW5ndGhDaGFuZ2VkIiwib25MZW5ndGhDaGFuZ2VkIiwicmVzaXplT2JzZXJ2ZXIiLCJSZXNpemVPYnNlcnZlciIsInJlc2l6ZU9ic2VydmVyQ2FsbGJhY2siLCJvYnNlcnZlIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJyZW1vdmVMaXN0ZW5lciIsImRpc2Nvbm5lY3QiLCJyZW5kZXJDYWxsQmFja0J1dHRvbiIsInRleHQiLCJjYWxsQmFjayIsInJlbmRlclNpbGVuY2VJY29uIiwic2lsZW5jZUNsYXNzIiwidG9nZ2xlU2lsZW5jZWQiLCJyZW5kZXJDb250ZW50IiwiQ2FsbFN0YXRlIiwiUmluZ2luZyIsInNpbGVuY2VJY29uIiwicmVqZWN0Q2FsbCIsImFuc3dlckNhbGwiLCJFbmRlZCIsImhhbmd1cFJlYXNvbiIsImdvdFJlamVjdGVkIiwiQ2FsbEVycm9yQ29kZSIsIlVzZXJIYW5ndXAiLCJpbmNsdWRlcyIsImR1cmF0aW9uIiwiSW52aXRlVGltZW91dCIsInJlYXNvbiIsIkljZUZhaWxlZCIsIk5vVXNlck1lZGlhIiwiVXNlckJ1c3kiLCJJbmZvVG9vbHRpcEtpbmQiLCJXYXJuaW5nIiwiQ29ubmVjdGVkIiwiQ29ubmVjdGluZyIsIkN1c3RvbUNhbGxTdGF0ZSIsIk1pc3NlZCIsInJlbmRlciIsImV2ZW50IiwibXhFdmVudCIsInNlbmRlciIsIm5hbWUiLCJnZXRTZW5kZXIiLCJpc1ZvaWNlIiwiY2FsbFR5cGUiLCJjb250ZW50IiwiY2xhc3NOYW1lIiwibXhfQ2FsbEV2ZW50X3ZvaWNlIiwibXhfQ2FsbEV2ZW50X3ZpZGVvIiwibXhfQ2FsbEV2ZW50X25hcnJvdyIsIm14X0NhbGxFdmVudF9taXNzZWQiLCJteF9DYWxsRXZlbnRfbm9BbnN3ZXIiLCJteF9DYWxsRXZlbnRfcmVqZWN0ZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUdBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7QUE1QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBZ0JBLE1BQU1BLG9CQUFvQixHQUFHLE1BQU0sRUFBTixHQUFXLEdBQXhDOztBQWNlLE1BQU1DLFNBQU4sU0FBd0JDLGVBQU1DLGFBQTlCLENBQTREO0FBSXZFQyxFQUFBQSxXQUFXLENBQUNDLEtBQUQsRUFBZ0I7QUFDdkIsVUFBTUEsS0FBTjtBQUR1Qix1RUFIRix1QkFHRTtBQUFBO0FBQUEsMkRBNEJBQyxNQUFELElBQTBCO0FBQ2hELFdBQUtDLFFBQUwsQ0FBYztBQUFFRCxRQUFBQTtBQUFGLE9BQWQ7QUFDSCxLQTlCMEI7QUFBQSxrRUFnQ09FLE9BQUQsSUFBMEM7QUFDdkUsWUFBTUMsbUJBQW1CLEdBQUdELE9BQU8sQ0FBQ0UsSUFBUixDQUFjQyxLQUFELElBQVdBLEtBQUssQ0FBQ0MsTUFBTixLQUFp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Q0FBV04sTUFBWCxJQUFxQixLQUFLTSxLQUFMLENBQVdELFNBQVgsS0FBeUIwQixnQkFBVUMsT0FBNUQsRUFBcUU7QUFDakVDLE1BQUFBLFdBQVcsR0FBRyxLQUFLTixpQkFBTCxFQUFkO0FBQ0g7O0FBRUQsd0JBQ0k7QUFBSyxNQUFBLFNBQVMsRUFBQyxzQkFBZjtBQUFzQyxNQUFBLEdBQUcsRUFBRSxLQUFLN0I7QUFBaEQsb0JBQ0k7QUFBSyxNQUFBLFNBQVMsRUFBRWlFO0FBQWhCLE9BQ005QixXQUROLGVBRUk7QUFBSyxNQUFBLFNBQVMsRUFBQztBQUFmLG9CQUNJLDZCQUFDLHFCQUFEO0FBQ0ksTUFBQSxNQUFNLEVBQUVzQixLQUFLLENBQUNFLE1BRGxCO0FBRUksTUFBQSxLQUFLLEVBQUUsRUFGWDtBQUdJLE1BQUEsTUFBTSxFQUFFO0FBSFosTUFESixlQU1JO0FBQUssTUFBQSxTQUFTLEVBQUM7QUFBZixvQkFDSTtBQUFLLE1BQUEsU0FBUyxFQUFDO0FBQWYsT0FDTUEsTUFETixDQURKLGVBSUk7QUFBSyxNQUFBLFNBQVMsRUFBQztBQUFmLG9CQUNJO0FBQUssTUFBQSxTQUFTLEVBQUM7QUFBZixNQURKLEVBRU1JLFFBRk4sQ0FKSixDQU5KLENBRkosRUFrQk1DLE9BbEJOLENBREosQ0FESjtBQXdCSDs7QUEzUHNFIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDIxIMWgaW1vbiBCcmFuZG5lciA8c2ltb24uYnJhLmFnQGdtYWlsLmNvbT5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QsIHsgY3JlYXRlUmVmIH0gZnJvbSAncmVhY3QnO1xuXG5pbXBvcnQgeyBNYXRyaXhFdmVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvZXZlbnRcIjtcbmltcG9ydCB7IF90IH0gZnJvbSAnLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyJztcbmltcG9ydCBNZW1iZXJBdmF0YXIgZnJvbSAnLi4vYXZhdGFycy9NZW1iZXJBdmF0YXInO1xuaW1wb3J0IENhbGxFdmVudEdyb3VwZXIsIHsgQ2FsbEV2ZW50R3JvdXBlckV2ZW50LCBDdXN0b21DYWxsU3RhdGUgfSBmcm9tICcuLi8uLi9zdHJ1Y3R1cmVzL0NhbGxFdmVudEdyb3VwZXInO1xuaW1wb3J0IEFjY2Vzc2libGVCdXR0b24gZnJvbSAnLi4vZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvbic7XG5pbXBvcnQgeyBDYWxsRXJyb3JDb2RlLCBDYWxsU3RhdGUgfSBmcm9tICdtYXRyaXgtanMtc2RrL3NyYy93ZWJydGMvY2FsbCc7XG5pbXBvcnQgSW5mb1Rvb2x0aXAsIHsgSW5mb1Rvb2x0aXBLaW5kIH0gZnJvbSAnLi4vZWxlbWVudHMvSW5mb1Rvb2x0aXAnO1xuaW1wb3J0IGNsYXNzTmFtZXMgZnJvbSAnY2xhc3NuYW1lcyc7XG5pbXBvcnQgQWNjZXNzaWJsZVRvb2x0aXBCdXR0b24gZnJvbSAnLi4vZWxlbWVudHMvQWNjZXNzaWJsZVRvb2x0aXBCdXR0b24nO1xuaW1wb3J0IHsgZm9ybWF0Q2FsbFRpbWUgfSBmcm9tIFwiLi4vLi4vLi4vRGF0ZVV0aWxzXCI7XG5pbXBvcnQgQ2xvY2sgZnJvbSBcIi4uL2F1ZGlvX21lc3NhZ2VzL0Nsb2NrXCI7XG5cbmNvbnN0IE1BWF9OT05fTkFSUk9XX1dJRFRIID0gNDUwIC8gNzAgKiAxMDA7XG5cbmludGVyZmFjZSBJUHJvcHMge1xuICAgIG14RXZlbnQ6IE1hdHJpeEV2ZW50O1xuICAgIGNhbGxFdmVudEdyb3VwZXI6IENhbGxFdmVudEdyb3VwZXI7XG59XG5cbmludGVyZmFjZSBJU3RhdGUge1xuICAgIGNhbGxTdGF0ZTogQ2FsbFN0YXRlIHwgQ3VzdG9tQ2FsbFN0YXRlO1xuICAgIHNpbGVuY2VkOiBib29sZWFuO1xuICAgIG5hcnJvdzogYm9vbGVhbjtcbiAgICBsZW5ndGg6IG51bWJlcjtcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ2FsbEV2ZW50IGV4dGVuZHMgUmVhY3QuUHVyZUNvbXBvbmVudDxJUHJvcHMsIElTdGF0ZT4ge1xuICAgIHByaXZhdGUgd3JhcHBlckVsZW1lbnQgPSBjcmVhdGVSZWY8SFRNTERpdkVsZW1lbnQ+KCk7XG4gICAgcHJpdmF0ZSByZXNpemVPYnNlcnZlcjogUmVzaXplT2JzZXJ2ZXI7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wczogSVByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgY2FsbFN0YXRlOiB0aGlzLnByb3BzLmNhbGxFdmVudEdyb3VwZXIuc3RhdGUsXG4gICAgICAgICAgICBzaWxlbmNlZDogZmFsc2UsXG4gICAgICAgICAgICBuYXJyb3c6IGZhbHNlLFxuICAgICAgICAgICAgbGVuZ3RoOiAwLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgICAgICB0aGlzLnByb3BzLmNhbGxFdmVudEdyb3VwZXIuYWRkTGlzdGVuZXIoQ2FsbEV2ZW50R3JvdXBlckV2ZW50LlN0YXRlQ2hhbmdlZCwgdGhpcy5vblN0YXRlQ2hhbmdlZCk7XG4gICAgICAgIHRoaXMucHJvcHMuY2FsbEV2ZW50R3JvdXBlci5hZGRMaXN0ZW5lcihDYWxsRXZlbnRHcm91cGVyRXZlbnQuU2lsZW5jZWRDaGFuZ2VkLCB0aGlzLm9uU2lsZW5jZWRDaGFuZ2VkKTtcbiAgICAgICAgdGhpcy5wcm9wcy5jYWxsRXZlbnRHcm91cGVyLmFkZExpc3RlbmVyKENhbGxFdmVudEdyb3VwZXJFdmVudC5MZW5ndGhDaGFuZ2VkLCB0aGlzLm9uTGVuZ3RoQ2hhbmdlZCk7XG5cbiAgICAgICAgdGhpcy5yZXNpemVPYnNlcnZlciA9IG5ldyBSZXNpemVPYnNlcnZlcih0aGlzLnJlc2l6ZU9ic2VydmVyQ2FsbGJhY2spO1xuICAgICAgICB0aGlzLnJlc2l6ZU9ic2VydmVyLm9ic2VydmUodGhpcy53cmFwcGVyRWxlbWVudC5jdXJyZW50KTtcbiAgICB9XG5cbiAgICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICAgICAgdGhpcy5wcm9wcy5jYWxsRXZlbnRHcm91cGVyLnJlbW92ZUxpc3RlbmVyKENhbGxFdmVudEdyb3VwZXJFdmVudC5TdGF0ZUNoYW5nZWQsIHRoaXMub25TdGF0ZUNoYW5nZWQpO1xuICAgICAgICB0aGlzLnByb3BzLmNhbGxFdmVudEdyb3VwZXIucmVtb3ZlTGlzdGVuZXIoQ2FsbEV2ZW50R3JvdXBlckV2ZW50LlNpbGVuY2VkQ2hhbmdlZCwgdGhpcy5vblNpbGVuY2VkQ2hhbmdlZCk7XG4gICAgICAgIHRoaXMucHJvcHMuY2FsbEV2ZW50R3JvdXBlci5yZW1vdmVMaXN0ZW5lcihDYWxsRXZlbnRHcm91cGVyRXZlbnQuTGVuZ3RoQ2hhbmdlZCwgdGhpcy5vbkxlbmd0aENoYW5nZWQpO1xuXG4gICAgICAgIHRoaXMucmVzaXplT2JzZXJ2ZXIuZGlzY29ubmVjdCgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25MZW5ndGhDaGFuZ2VkID0gKGxlbmd0aDogbnVtYmVyKTogdm9pZCA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBsZW5ndGggfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgcmVzaXplT2JzZXJ2ZXJDYWxsYmFjayA9IChlbnRyaWVzOiBSZXNpemVPYnNlcnZlckVudHJ5W10pOiB2b2lkID0+IHtcbiAgICAgICAgY29uc3Qgd3JhcHBlckVsZW1lbnRFbnRyeSA9IGVudHJpZXMuZmluZCgoZW50cnkpID0+IGVudHJ5LnRhcmdldCA9PT0gdGhpcy53cmFwcGVyRWxlbWVudC5jdXJyZW50KTtcbiAgICAgICAgaWYgKCF3cmFwcGVyRWxlbWVudEVudHJ5KSByZXR1cm47XG5cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IG5hcnJvdzogd3JhcHBlckVsZW1lbnRFbnRyeS5jb250ZW50UmVjdC53aWR0aCA8IE1BWF9OT05fTkFSUk9XX1dJRFRIIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uU2lsZW5jZWRDaGFuZ2VkID0gKG5ld1N0YXRlKSA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBzaWxlbmNlZDogbmV3U3RhdGUgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25TdGF0ZUNoYW5nZWQgPSAobmV3U3RhdGU6IENhbGxTdGF0ZSkgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgY2FsbFN0YXRlOiBuZXdTdGF0ZSB9KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSByZW5kZXJDYWxsQmFja0J1dHRvbih0ZXh0OiBzdHJpbmcpOiBKU1guRWxlbWVudCB7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvblxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X0NhbGxFdmVudF9jb250ZW50X2J1dHRvbiBteF9DYWxsRXZlbnRfY29udGVudF9idXR0b25fY2FsbEJhY2tcIlxuICAgICAgICAgICAgICAgIG9uQ2xpY2s9e3RoaXMucHJvcHMuY2FsbEV2ZW50R3JvdXBlci5jYWxsQmFja31cbiAgICAgICAgICAgICAgICBraW5kPVwicHJpbWFyeVwiXG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgPHNwYW4+IHsgdGV4dCB9IDwvc3Bhbj5cbiAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj5cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlbmRlclNpbGVuY2VJY29uKCk6IEpTWC5FbGVtZW50IHtcbiAgICAgICAgY29uc3Qgc2lsZW5jZUNsYXNzID0gY2xhc3NOYW1lcyh7XG4gICAgICAgICAgICBcIm14X0NhbGxFdmVudF9pY29uQnV0dG9uXCI6IHRydWUsXG4gICAgICAgICAgICBcIm14X0NhbGxFdmVudF91blNpbGVuY2VcIjogdGhpcy5zdGF0ZS5zaWxlbmNlZCxcbiAgICAgICAgICAgIFwibXhfQ2FsbEV2ZW50X3NpbGVuY2VcIjogIXRoaXMuc3RhdGUuc2lsZW5jZWQsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8QWNjZXNzaWJsZVRvb2x0aXBCdXR0b25cbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9e3NpbGVuY2VDbGFzc31cbiAgICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLnByb3BzLmNhbGxFdmVudEdyb3VwZXIudG9nZ2xlU2lsZW5jZWR9XG4gICAgICAgICAgICAgICAgdGl0bGU9e3RoaXMuc3RhdGUuc2lsZW5jZWQgPyBfdChcIlNvdW5kIG9uXCIpIDogX3QoXCJTaWxlbmNlIGNhbGxcIil9XG4gICAgICAgICAgICAvPlxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVuZGVyQ29udGVudChzdGF0ZTogQ2FsbFN0YXRlIHwgQ3VzdG9tQ2FsbFN0YXRlKTogSlNYLkVsZW1lbnQge1xuICAgICAgICBpZiAoc3RhdGUgPT09IENhbGxTdGF0ZS5SaW5naW5nKSB7XG4gICAgICAgICAgICBsZXQgc2lsZW5jZUljb247XG4gICAgICAgICAgICBpZiAoIXRoaXMuc3RhdGUubmFycm93KSB7XG4gICAgICAgICAgICAgICAgc2lsZW5jZUljb24gPSB0aGlzLnJlbmRlclNpbGVuY2VJY29uKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9DYWxsRXZlbnRfY29udGVudFwiPlxuICAgICAgICAgICAgICAgICAgICB7IHNpbGVuY2VJY29uIH1cbiAgICAgICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b25cbiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X0NhbGxFdmVudF9jb250ZW50X2J1dHRvbiBteF9DYWxsRXZlbnRfY29udGVudF9idXR0b25fcmVqZWN0XCJcbiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s9e3RoaXMucHJvcHMuY2FsbEV2ZW50R3JvdXBlci5yZWplY3RDYWxsfVxuICAgICAgICAgICAgICAgICAgICAgICAga2luZD1cImRhbmdlclwiXG4gICAgICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuPiB7IF90KFwiRGVjbGluZVwiKSB9IDwvc3Bhbj5cbiAgICAgICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvblxuICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfQ2FsbEV2ZW50X2NvbnRlbnRfYnV0dG9uIG14X0NhbGxFdmVudF9jb250ZW50X2J1dHRvbl9hbnN3ZXJcIlxuICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5wcm9wcy5jYWxsRXZlbnRHcm91cGVyLmFuc3dlckNhbGx9XG4gICAgICAgICAgICAgICAgICAgICAgICBraW5kPVwicHJpbWFyeVwiXG4gICAgICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuPiB7IF90KFwiQWNjZXB0XCIpIH0gPC9zcGFuPlxuICAgICAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzdGF0ZSA9PT0gQ2FsbFN0YXRlLkVuZGVkKSB7XG4gICAgICAgICAgICBjb25zdCBoYW5ndXBSZWFzb24gPSB0aGlzLnByb3BzLmNhbGxFdmVudEdyb3VwZXIuaGFuZ3VwUmVhc29uO1xuICAgICAgICAgICAgY29uc3QgZ290UmVqZWN0ZWQgPSB0aGlzLnByb3BzLmNhbGxFdmVudEdyb3VwZXIuZ290UmVqZWN0ZWQ7XG5cbiAgICAgICAgICAgIGlmIChnb3RSZWplY3RlZCkge1xuICAgICAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfQ2FsbEV2ZW50X2NvbnRlbnRcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCJDYWxsIGRlY2xpbmVkXCIpIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgdGhpcy5yZW5kZXJDYWxsQmFja0J1dHRvbihfdChcIkNhbGwgYmFja1wiKSkgfVxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSBlbHNlIGlmICgoW0NhbGxFcnJvckNvZGUuVXNlckhhbmd1cCwgXCJ1c2VyIGhhbmd1cFwiXS5pbmNsdWRlcyhoYW5ndXBSZWFzb24pIHx8ICFoYW5ndXBSZWFzb24pKSB7XG4gICAgICAgICAgICAgICAgLy8gd29ya2Fyb3VuZCBmb3IgaHR0cHM6Ly9naXRodWIuY29tL3ZlY3Rvci1pbS9lbGVtZW50LXdlYi9pc3N1ZXMvNTE3OFxuICAgICAgICAgICAgICAgIC8vIGl0IHNlZW1zIEFuZHJvaWQgcmFuZG9tbHkgc2V0cyBhIHJlYXNvbiBvZiBcInVzZXIgaGFuZ3VwXCIgd2hpY2ggaXNcbiAgICAgICAgICAgICAgICAvLyBpbnRlcnByZXRlZCBhcyBhbiBlcnJvciBjb2RlIDooXG4gICAgICAgICAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3ZlY3Rvci1pbS9yaW90LWFuZHJvaWQvaXNzdWVzLzI2MjNcbiAgICAgICAgICAgICAgICAvLyBBbHNvIHRoZSBjb3JyZWN0IGhhbmd1cCBjb2RlIGFzIG9mIFZvSVAgdjEgKHdpdGggdW5kZXJzY29yZSlcbiAgICAgICAgICAgICAgICAvLyBBbHNvLCBpZiB3ZSBkb24ndCBoYXZlIGEgcmVhc29uXG4gICAgICAgICAgICAgICAgY29uc3QgZHVyYXRpb24gPSB0aGlzLnByb3BzLmNhbGxFdmVudEdyb3VwZXIuZHVyYXRpb247XG4gICAgICAgICAgICAgICAgbGV0IHRleHQgPSBfdChcIkNhbGwgZW5kZWRcIik7XG4gICAgICAgICAgICAgICAgaWYgKGR1cmF0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIHRleHQgKz0gXCIg4oCiIFwiICsgZm9ybWF0Q2FsbFRpbWUoZHVyYXRpb24pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0NhbGxFdmVudF9jb250ZW50XCI+XG4gICAgICAgICAgICAgICAgICAgICAgICB7IHRleHQgfVxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChoYW5ndXBSZWFzb24gPT09IENhbGxFcnJvckNvZGUuSW52aXRlVGltZW91dCkge1xuICAgICAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfQ2FsbEV2ZW50X2NvbnRlbnRcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCJObyBhbnN3ZXJcIikgfVxuICAgICAgICAgICAgICAgICAgICAgICAgeyB0aGlzLnJlbmRlckNhbGxCYWNrQnV0dG9uKF90KFwiQ2FsbCBiYWNrXCIpKSB9XG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCByZWFzb247XG4gICAgICAgICAgICBpZiAoaGFuZ3VwUmVhc29uID09PSBDYWxsRXJyb3JDb2RlLkljZUZhaWxlZCkge1xuICAgICAgICAgICAgICAgIC8vIFdlIGNvdWxkbid0IGVzdGFibGlzaCBhIGNvbm5lY3Rpb24gYXQgYWxsXG4gICAgICAgICAgICAgICAgcmVhc29uID0gX3QoXCJDb3VsZCBub3QgY29ubmVjdCBtZWRpYVwiKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFuZ3VwUmVhc29uID09PSBcImljZV90aW1lb3V0XCIpIHtcbiAgICAgICAgICAgICAgICAvLyBXZSBlc3RhYmxpc2hlZCBhIGNvbm5lY3Rpb24gYnV0IGl0IGRpZWRcbiAgICAgICAgICAgICAgICByZWFzb24gPSBfdChcIkNvbm5lY3Rpb24gZmFpbGVkXCIpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChoYW5ndXBSZWFzb24gPT09IENhbGxFcnJvckNvZGUuTm9Vc2VyTWVkaWEpIHtcbiAgICAgICAgICAgICAgICAvLyBUaGUgb3RoZXIgc2lkZSBjb3VsZG4ndCBvcGVuIGNhcHR1cmUgZGV2aWNlc1xuICAgICAgICAgICAgICAgIHJlYXNvbiA9IF90KFwiVGhlaXIgZGV2aWNlIGNvdWxkbid0IHN0YXJ0IHRoZSBjYW1lcmEgb3IgbWljcm9waG9uZVwiKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFuZ3VwUmVhc29uID09PSBcInVua25vd25fZXJyb3JcIikge1xuICAgICAgICAgICAgICAgIC8vIEFuIGVycm9yIGNvZGUgdGhlIG90aGVyIHNpZGUgZG9lc24ndCBoYXZlIGEgd2F5IHRvIGV4cHJlc3NcbiAgICAgICAgICAgICAgICAvLyAoYXMgb3Bwb3NlZCB0byBhbiBlcnJvciBjb2RlIHRoZXkgZ2F2ZSBidXQgd2UgZG9uJ3Qga25vdyBhYm91dCxcbiAgICAgICAgICAgICAgICAvLyBpbiB3aGljaCBjYXNlIHdlIHNob3cgdGhlIGVycm9yIGNvZGUpXG4gICAgICAgICAgICAgICAgcmVhc29uID0gX3QoXCJBbiB1bmtub3duIGVycm9yIG9jY3VycmVkXCIpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChoYW5ndXBSZWFzb24gPT09IENhbGxFcnJvckNvZGUuVXNlckJ1c3kpIHtcbiAgICAgICAgICAgICAgICByZWFzb24gPSBfdChcIlRoZSB1c2VyIHlvdSBjYWxsZWQgaXMgYnVzeS5cIik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlYXNvbiA9IF90KCdVbmtub3duIGZhaWx1cmU6ICUocmVhc29uKXMnLCB7IHJlYXNvbjogaGFuZ3VwUmVhc29uIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfQ2FsbEV2ZW50X2NvbnRlbnRcIj5cbiAgICAgICAgICAgICAgICAgICAgPEluZm9Ub29sdGlwXG4gICAgICAgICAgICAgICAgICAgICAgICB0b29sdGlwPXtyZWFzb259XG4gICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9DYWxsRXZlbnRfY29udGVudF90b29sdGlwXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIGtpbmQ9e0luZm9Ub29sdGlwS2luZC5XYXJuaW5nfVxuICAgICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgICAgICB7IF90KFwiQ29ubmVjdGlvbiBmYWlsZWRcIikgfVxuICAgICAgICAgICAgICAgICAgICB7IHRoaXMucmVuZGVyQ2FsbEJhY2tCdXR0b24oX3QoXCJSZXRyeVwiKSkgfVxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoc3RhdGUgPT09IENhbGxTdGF0ZS5Db25uZWN0ZWQpIHtcbiAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9DYWxsRXZlbnRfY29udGVudFwiPlxuICAgICAgICAgICAgICAgICAgICA8Q2xvY2sgc2Vjb25kcz17dGhpcy5zdGF0ZS5sZW5ndGh9IC8+XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzdGF0ZSA9PT0gQ2FsbFN0YXRlLkNvbm5lY3RpbmcpIHtcbiAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9DYWxsRXZlbnRfY29udGVudFwiPlxuICAgICAgICAgICAgICAgICAgICB7IF90KFwiQ29ubmVjdGluZ1wiKSB9XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzdGF0ZSA9PT0gQ3VzdG9tQ2FsbFN0YXRlLk1pc3NlZCkge1xuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0NhbGxFdmVudF9jb250ZW50XCI+XG4gICAgICAgICAgICAgICAgICAgIHsgX3QoXCJNaXNzZWQgY2FsbFwiKSB9XG4gICAgICAgICAgICAgICAgICAgIHsgdGhpcy5yZW5kZXJDYWxsQmFja0J1dHRvbihfdChcIkNhbGwgYmFja1wiKSkgfVxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0NhbGxFdmVudF9jb250ZW50XCI+XG4gICAgICAgICAgICAgICAgeyBfdChcIlRoZSBjYWxsIGlzIGluIGFuIHVua25vd24gc3RhdGUhXCIpIH1cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICApO1xuICAgIH1cblxuICAgIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3QgZXZlbnQgPSB0aGlzLnByb3BzLm14RXZlbnQ7XG4gICAgICAgIGNvbnN0IHNlbmRlciA9IGV2ZW50LnNlbmRlciA/IGV2ZW50LnNlbmRlci5uYW1lIDogZXZlbnQuZ2V0U2VuZGVyKCk7XG4gICAgICAgIGNvbnN0IGlzVm9pY2UgPSB0aGlzLnByb3BzLmNhbGxFdmVudEdyb3VwZXIuaXNWb2ljZTtcbiAgICAgICAgY29uc3QgY2FsbFR5cGUgPSBpc1ZvaWNlID8gX3QoXCJWb2ljZSBjYWxsXCIpIDogX3QoXCJWaWRlbyBjYWxsXCIpO1xuICAgICAgICBjb25zdCBjYWxsU3RhdGUgPSB0aGlzLnN0YXRlLmNhbGxTdGF0ZTtcbiAgICAgICAgY29uc3QgaGFuZ3VwUmVhc29uID0gdGhpcy5wcm9wcy5jYWxsRXZlbnRHcm91cGVyLmhhbmd1cFJlYXNvbjtcbiAgICAgICAgY29uc3QgY29udGVudCA9IHRoaXMucmVuZGVyQ29udGVudChjYWxsU3RhdGUpO1xuICAgICAgICBjb25zdCBjbGFzc05hbWUgPSBjbGFzc05hbWVzKFwibXhfQ2FsbEV2ZW50XCIsIHtcbiAgICAgICAgICAgIG14X0NhbGxFdmVudF92b2ljZTogaXNWb2ljZSxcbiAgICAgICAgICAgIG14X0NhbGxFdmVudF92aWRlbzogIWlzVm9pY2UsXG4gICAgICAgICAgICBteF9DYWxsRXZlbnRfbmFycm93OiB0aGlzLnN0YXRlLm5hcnJvdyxcbiAgICAgICAgICAgIG14X0NhbGxFdmVudF9taXNzZWQ6IGNhbGxTdGF0ZSA9PT0gQ3VzdG9tQ2FsbFN0YXRlLk1pc3NlZCxcbiAgICAgICAgICAgIG14X0NhbGxFdmVudF9ub0Fuc3dlcjogY2FsbFN0YXRlID09PSBDYWxsU3RhdGUuRW5kZWQgJiYgaGFuZ3VwUmVhc29uID09PSBDYWxsRXJyb3JDb2RlLkludml0ZVRpbWVvdXQsXG4gICAgICAgICAgICBteF9DYWxsRXZlbnRfcmVqZWN0ZWQ6IGNhbGxTdGF0ZSA9PT0gQ2FsbFN0YXRlLkVuZGVkICYmIHRoaXMucHJvcHMuY2FsbEV2ZW50R3JvdXBlci5nb3RSZWplY3RlZCxcbiAgICAgICAgfSk7XG4gICAgICAgIGxldCBzaWxlbmNlSWNvbjtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUubmFycm93ICYmIHRoaXMuc3RhdGUuY2FsbFN0YXRlID09PSBDYWxsU3RhdGUuUmluZ2luZykge1xuICAgICAgICAgICAgc2lsZW5jZUljb24gPSB0aGlzLnJlbmRlclNpbGVuY2VJY29uKCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9DYWxsRXZlbnRfd3JhcHBlclwiIHJlZj17dGhpcy53cmFwcGVyRWxlbWVudH0+XG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9e2NsYXNzTmFtZX0+XG4gICAgICAgICAgICAgICAgICAgIHsgc2lsZW5jZUljb24gfVxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0NhbGxFdmVudF9pbmZvXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICA8TWVtYmVyQXZhdGFyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVtYmVyPXtldmVudC5zZW5kZXJ9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg9ezMyfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodD17MzJ9XG4gICAgICAgICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9DYWxsRXZlbnRfaW5mb19iYXNpY1wiPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfQ2FsbEV2ZW50X3NlbmRlclwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IHNlbmRlciB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9DYWxsRXZlbnRfdHlwZVwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0NhbGxFdmVudF90eXBlX2ljb25cIiAvPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IGNhbGxUeXBlIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgeyBjb250ZW50IH1cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICApO1xuICAgIH1cbn1cbiJdfQ==