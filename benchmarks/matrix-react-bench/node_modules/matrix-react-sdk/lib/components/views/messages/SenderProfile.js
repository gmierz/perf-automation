"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _event = require("matrix-js-sdk/src/@types/event");

var _Flair = _interopRequireDefault(require("../elements/Flair"));

var _FlairStore = _interopRequireDefault(require("../../../stores/FlairStore"));

var _FormattingUtils = require("../../../utils/FormattingUtils");

var _MatrixClientContext = _interopRequireDefault(require("../../../contexts/MatrixClientContext"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _dec, _class, _class2, _temp;

let SenderProfile = (_dec = (0, _replaceableComponent.replaceableComponent)("views.messages.SenderProfile"), _dec(_class = (_temp = _class2 = class SenderProfile extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "unmounted", false);
    (0, _defineProperty2.default)(this, "onRoomStateEvents", event => {
      if (event.getType() === 'm.room.related_groups' && event.getRoomId() === this.props.mxEvent.getRoomId()) {
        this.updateRelatedGroups();
      }
    });
    const senderId = this.props.mxEvent.getSender();
    this.state = {
      userGroups: _FlairStore.default.cachedPublicisedGroups(senderId) || [],
      relatedGroups: []
    };
  }

  componentDidMount() {
    this.updateRelatedGroups();

    if (this.state.userGroups.length === 0) {
      this.getPublicisedGroups();
    }

    this.context.on('RoomState.events', this.onRoomStateEvents);
  }

  componentWillUnmount() {
    this.unmounted = true;
    this.context.removeListener('RoomState.events', this.onRoomStateEvents);
  }

  async getPublicisedGroups() {
    const userGroups = await _FlairStore.default.getPublicisedGroupsCached(this.context, this.props.mxEvent.getSender());
    if (this.unmounted) return;
    this.setState({
      userGroups
    });
  }

  updateRelatedGroups() {
    const room = this.context.getRoom(this.props.mxEvent.getRoomId());
    if (!room) return;
    const relatedGroupsEvent = room.currentState.getStateEvents('m.room.related_groups', '');
    this.setState({
      relatedGroups: (relatedGroupsEvent === null || relatedGroupsEvent === void 0 ? void 0 : relatedGroupsEvent.getContent().groups) || []
    });
  }

  getDisplayedGroups(userGroups, relatedGroups) {
    let displayedGroups = userGroups || [];

    if (relatedGroups && relatedGroups.length > 0) {
      displayedGroups = relatedGroups.filter(groupId => {
        return displayedGroups.includes(groupId);
      });
    } else {
      displayedGroups = [];
    }

    return displayedGroups;
  }

  render() {
    var _mxEvent$sender, _mxEvent$sender2, _mxEvent$sender3;

    const {
      mxEvent
    } = this.props;
    const colorClass = (0, _FormattingUtils.getUserNameColorClass)(mxEvent.getSender());
    const {
      msgtype
    } = mxEvent.getContent();
    const disambiguate = (_mxEvent$sender = mxEvent.sender) === null || _mxEvent$sender === void 0 ? void 0 : _mxEvent$sender.disambiguate;
    const displayName = ((_mxEvent$sender2 = mxEvent.sender) === null || _mxEvent$sender2 === void 0 ? void 0 : _mxEvent$sender2.rawDisplayName) || mxEvent.getSender() || "";
    const mxid = ((_mxEvent$sender3 = mxEvent.sender) === null || _mxEvent$sender3 === void 0 ? void 0 : _mxEvent$sender3.userId) || mxEvent.getSender() || "";

    if (msgtype === _event.MsgType.Emote) {
      return null; // emote message must include the name so don't duplicate it
    }

    let mxidElement;

    if (disambiguate) {
      mxidElement = /*#__PURE__*/_react.default.createElement("span", {
        className: "mx_SenderProfile_mxid"
      }, mxid);
    }

    let flair;

    if (this.props.enableFlair) {
      const displayedGroups = this.getDisplayedGroups(this.state.userGroups, this.state.relatedGroups);
      flair = /*#__PURE__*/_react.default.createElement(_Flair.default, {
        key: "flair",
        userId: mxEvent.getSender(),
        groups: displayedGroups
      });
    }

    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_SenderProfile",
      dir: "auto",
      onClick: this.props.onClick
    }, /*#__PURE__*/_react.default.createElement("span", {
      className: `mx_SenderProfile_displayName ${colorClass}`
    }, displayName), mxidElement, flair);
  }

}, (0, _defineProperty2.default)(_class2, "contextType", _MatrixClientContext.default), _temp)) || _class);
exports.default = SenderProfile;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL21lc3NhZ2VzL1NlbmRlclByb2ZpbGUudHN4Il0sIm5hbWVzIjpbIlNlbmRlclByb2ZpbGUiLCJSZWFjdCIsIkNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJldmVudCIsImdldFR5cGUiLCJnZXRSb29tSWQiLCJteEV2ZW50IiwidXBkYXRlUmVsYXRlZEdyb3VwcyIsInNlbmRlcklkIiwiZ2V0U2VuZGVyIiwic3RhdGUiLCJ1c2VyR3JvdXBzIiwiRmxhaXJTdG9yZSIsImNhY2hlZFB1YmxpY2lzZWRHcm91cHMiLCJyZWxhdGVkR3JvdXBzIiwiY29tcG9uZW50RGlkTW91bnQiLCJsZW5ndGgiLCJnZXRQdWJsaWNpc2VkR3JvdXBzIiwiY29udGV4dCIsIm9uIiwib25Sb29tU3RhdGVFdmVudHMiLCJjb21wb25lbnRXaWxsVW5tb3VudCIsInVubW91bnRlZCIsInJlbW92ZUxpc3RlbmVyIiwiZ2V0UHVibGljaXNlZEdyb3Vwc0NhY2hlZCIsInNldFN0YXRlIiwicm9vbSIsImdldFJvb20iLCJyZWxhdGVkR3JvdXBzRXZlbnQiLCJjdXJyZW50U3RhdGUiLCJnZXRTdGF0ZUV2ZW50cyIsImdldENvbnRlbnQiLCJncm91cHMiLCJnZXREaXNwbGF5ZWRHcm91cHMiLCJkaXNwbGF5ZWRHcm91cHMiLCJmaWx0ZXIiLCJncm91cElkIiwiaW5jbHVkZXMiLCJyZW5kZXIiLCJjb2xvckNsYXNzIiwibXNndHlwZSIsImRpc2FtYmlndWF0ZSIsInNlbmRlciIsImRpc3BsYXlOYW1lIiwicmF3RGlzcGxheU5hbWUiLCJteGlkIiwidXNlcklkIiwiTXNnVHlwZSIsIkVtb3RlIiwibXhpZEVsZW1lbnQiLCJmbGFpciIsImVuYWJsZUZsYWlyIiwib25DbGljayIsIk1hdHJpeENsaWVudENvbnRleHQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUVBOztBQUVBOztBQUNBOztBQUNBOztBQUNB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LHdCQUNJO0FBQUssTUFBQSxTQUFTLEVBQUMsa0JBQWY7QUFBa0MsTUFBQSxHQUFHLEVBQUMsTUFBdEM7QUFBNkMsTUFBQSxPQUFPLEVBQUUsS0FBS2hDLEtBQUwsQ0FBV2tEO0FBQWpFLG9CQUNJO0FBQU0sTUFBQSxTQUFTLEVBQUcsZ0NBQStCYixVQUFXO0FBQTVELE9BQ01JLFdBRE4sQ0FESixFQUlNTSxXQUpOLEVBS01DLEtBTE4sQ0FESjtBQVNIOztBQTFHc0UsQyx3REFDbERHLDRCIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiBDb3B5cmlnaHQgMjAxNSwgMjAxNiBPcGVuTWFya2V0IEx0ZFxuXG4gTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBNYXRyaXhFdmVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvZXZlbnRcIjtcbmltcG9ydCB7IE1zZ1R5cGUgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvQHR5cGVzL2V2ZW50XCI7XG5cbmltcG9ydCBGbGFpciBmcm9tICcuLi9lbGVtZW50cy9GbGFpcic7XG5pbXBvcnQgRmxhaXJTdG9yZSBmcm9tICcuLi8uLi8uLi9zdG9yZXMvRmxhaXJTdG9yZSc7XG5pbXBvcnQgeyBnZXRVc2VyTmFtZUNvbG9yQ2xhc3MgfSBmcm9tICcuLi8uLi8uLi91dGlscy9Gb3JtYXR0aW5nVXRpbHMnO1xuaW1wb3J0IE1hdHJpeENsaWVudENvbnRleHQgZnJvbSBcIi4uLy4uLy4uL2NvbnRleHRzL01hdHJpeENsaWVudENvbnRleHRcIjtcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5cbmludGVyZmFjZSBJUHJvcHMge1xuICAgIG14RXZlbnQ6IE1hdHJpeEV2ZW50O1xuICAgIG9uQ2xpY2s/KCk6IHZvaWQ7XG4gICAgZW5hYmxlRmxhaXI6IGJvb2xlYW47XG59XG5cbmludGVyZmFjZSBJU3RhdGUge1xuICAgIHVzZXJHcm91cHM7XG4gICAgcmVsYXRlZEdyb3Vwcztcbn1cblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3MubWVzc2FnZXMuU2VuZGVyUHJvZmlsZVwiKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU2VuZGVyUHJvZmlsZSBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxJUHJvcHMsIElTdGF0ZT4ge1xuICAgIHN0YXRpYyBjb250ZXh0VHlwZSA9IE1hdHJpeENsaWVudENvbnRleHQ7XG4gICAgcHJpdmF0ZSB1bm1vdW50ZWQgPSBmYWxzZTtcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBJUHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuICAgICAgICBjb25zdCBzZW5kZXJJZCA9IHRoaXMucHJvcHMubXhFdmVudC5nZXRTZW5kZXIoKTtcblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgdXNlckdyb3VwczogRmxhaXJTdG9yZS5jYWNoZWRQdWJsaWNpc2VkR3JvdXBzKHNlbmRlcklkKSB8fCBbXSxcbiAgICAgICAgICAgIHJlbGF0ZWRHcm91cHM6IFtdLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgICAgICB0aGlzLnVwZGF0ZVJlbGF0ZWRHcm91cHMoKTtcblxuICAgICAgICBpZiAodGhpcy5zdGF0ZS51c2VyR3JvdXBzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgdGhpcy5nZXRQdWJsaWNpc2VkR3JvdXBzKCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmNvbnRleHQub24oJ1Jvb21TdGF0ZS5ldmVudHMnLCB0aGlzLm9uUm9vbVN0YXRlRXZlbnRzKTtcbiAgICB9XG5cbiAgICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICAgICAgdGhpcy51bm1vdW50ZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLmNvbnRleHQucmVtb3ZlTGlzdGVuZXIoJ1Jvb21TdGF0ZS5ldmVudHMnLCB0aGlzLm9uUm9vbVN0YXRlRXZlbnRzKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIGdldFB1YmxpY2lzZWRHcm91cHMoKSB7XG4gICAgICAgIGNvbnN0IHVzZXJHcm91cHMgPSBhd2FpdCBGbGFpclN0b3JlLmdldFB1YmxpY2lzZWRHcm91cHNDYWNoZWQodGhpcy5jb250ZXh0LCB0aGlzLnByb3BzLm14RXZlbnQuZ2V0U2VuZGVyKCkpO1xuICAgICAgICBpZiAodGhpcy51bm1vdW50ZWQpIHJldHVybjtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IHVzZXJHcm91cHMgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvblJvb21TdGF0ZUV2ZW50cyA9IChldmVudDogTWF0cml4RXZlbnQpID0+IHtcbiAgICAgICAgaWYgKGV2ZW50LmdldFR5cGUoKSA9PT0gJ20ucm9vbS5yZWxhdGVkX2dyb3VwcycgJiYgZXZlbnQuZ2V0Um9vbUlkKCkgPT09IHRoaXMucHJvcHMubXhFdmVudC5nZXRSb29tSWQoKSkge1xuICAgICAgICAgICAgdGhpcy51cGRhdGVSZWxhdGVkR3JvdXBzKCk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSB1cGRhdGVSZWxhdGVkR3JvdXBzKCkge1xuICAgICAgICBjb25zdCByb29tID0gdGhpcy5jb250ZXh0LmdldFJvb20odGhpcy5wcm9wcy5teEV2ZW50LmdldFJvb21JZCgpKTtcbiAgICAgICAgaWYgKCFyb29tKSByZXR1cm47XG5cbiAgICAgICAgY29uc3QgcmVsYXRlZEdyb3Vwc0V2ZW50ID0gcm9vbS5jdXJyZW50U3RhdGUuZ2V0U3RhdGVFdmVudHMoJ20ucm9vbS5yZWxhdGVkX2dyb3VwcycsICcnKTtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICByZWxhdGVkR3JvdXBzOiByZWxhdGVkR3JvdXBzRXZlbnQ/LmdldENvbnRlbnQoKS5ncm91cHMgfHwgW10sXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0RGlzcGxheWVkR3JvdXBzKHVzZXJHcm91cHM/OiBzdHJpbmdbXSwgcmVsYXRlZEdyb3Vwcz86IHN0cmluZ1tdKSB7XG4gICAgICAgIGxldCBkaXNwbGF5ZWRHcm91cHMgPSB1c2VyR3JvdXBzIHx8IFtdO1xuICAgICAgICBpZiAocmVsYXRlZEdyb3VwcyAmJiByZWxhdGVkR3JvdXBzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGRpc3BsYXllZEdyb3VwcyA9IHJlbGF0ZWRHcm91cHMuZmlsdGVyKChncm91cElkKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRpc3BsYXllZEdyb3Vwcy5pbmNsdWRlcyhncm91cElkKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZGlzcGxheWVkR3JvdXBzID0gW107XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGRpc3BsYXllZEdyb3VwcztcbiAgICB9XG5cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIGNvbnN0IHsgbXhFdmVudCB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgY29sb3JDbGFzcyA9IGdldFVzZXJOYW1lQ29sb3JDbGFzcyhteEV2ZW50LmdldFNlbmRlcigpKTtcbiAgICAgICAgY29uc3QgeyBtc2d0eXBlIH0gPSBteEV2ZW50LmdldENvbnRlbnQoKTtcblxuICAgICAgICBjb25zdCBkaXNhbWJpZ3VhdGUgPSBteEV2ZW50LnNlbmRlcj8uZGlzYW1iaWd1YXRlO1xuICAgICAgICBjb25zdCBkaXNwbGF5TmFtZSA9IG14RXZlbnQuc2VuZGVyPy5yYXdEaXNwbGF5TmFtZSB8fCBteEV2ZW50LmdldFNlbmRlcigpIHx8IFwiXCI7XG4gICAgICAgIGNvbnN0IG14aWQgPSBteEV2ZW50LnNlbmRlcj8udXNlcklkIHx8IG14RXZlbnQuZ2V0U2VuZGVyKCkgfHwgXCJcIjtcblxuICAgICAgICBpZiAobXNndHlwZSA9PT0gTXNnVHlwZS5FbW90ZSkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7IC8vIGVtb3RlIG1lc3NhZ2UgbXVzdCBpbmNsdWRlIHRoZSBuYW1lIHNvIGRvbid0IGR1cGxpY2F0ZSBpdFxuICAgICAgICB9XG5cbiAgICAgICAgbGV0IG14aWRFbGVtZW50O1xuICAgICAgICBpZiAoZGlzYW1iaWd1YXRlKSB7XG4gICAgICAgICAgICBteGlkRWxlbWVudCA9IChcbiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9XCJteF9TZW5kZXJQcm9maWxlX214aWRcIj5cbiAgICAgICAgICAgICAgICAgICAgeyBteGlkIH1cbiAgICAgICAgICAgICAgICA8L3NwYW4+XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGZsYWlyO1xuICAgICAgICBpZiAodGhpcy5wcm9wcy5lbmFibGVGbGFpcikge1xuICAgICAgICAgICAgY29uc3QgZGlzcGxheWVkR3JvdXBzID0gdGhpcy5nZXREaXNwbGF5ZWRHcm91cHMoXG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS51c2VyR3JvdXBzLCB0aGlzLnN0YXRlLnJlbGF0ZWRHcm91cHMsXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBmbGFpciA9IDxGbGFpciBrZXk9J2ZsYWlyJ1xuICAgICAgICAgICAgICAgIHVzZXJJZD17bXhFdmVudC5nZXRTZW5kZXIoKX1cbiAgICAgICAgICAgICAgICBncm91cHM9e2Rpc3BsYXllZEdyb3Vwc31cbiAgICAgICAgICAgIC8+O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfU2VuZGVyUHJvZmlsZVwiIGRpcj1cImF1dG9cIiBvbkNsaWNrPXt0aGlzLnByb3BzLm9uQ2xpY2t9PlxuICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT17YG14X1NlbmRlclByb2ZpbGVfZGlzcGxheU5hbWUgJHtjb2xvckNsYXNzfWB9PlxuICAgICAgICAgICAgICAgICAgICB7IGRpc3BsYXlOYW1lIH1cbiAgICAgICAgICAgICAgICA8L3NwYW4+XG4gICAgICAgICAgICAgICAgeyBteGlkRWxlbWVudCB9XG4gICAgICAgICAgICAgICAgeyBmbGFpciB9XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=