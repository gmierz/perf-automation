"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _react = _interopRequireDefault(require("react"));

var _classnames = _interopRequireDefault(require("classnames"));

var _event = require("matrix-js-sdk/src/@types/event");

var _languageHandler = require("../../../languageHandler");

var _EventUtils = require("../../../utils/EventUtils");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _ContextMenuTooltipButton = require("../../../accessibility/context_menu/ContextMenuTooltipButton");

var _ContextMenu = _interopRequireWildcard(require("../../structures/ContextMenu"));

var _ReactionPicker = _interopRequireDefault(require("../emojipicker/ReactionPicker"));

var _ReactionsRowButton = _interopRequireDefault(require("./ReactionsRowButton"));

var _MatrixClientContext = _interopRequireDefault(require("../../../contexts/MatrixClientContext"));

var _dec, _class, _class2, _temp;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

// The maximum number of reactions to initially show on a message.
const MAX_ITEMS_WHEN_LIMITED = 8;

const ReactButton = ({
  mxEvent,
  reactions
}) => {
  const [menuDisplayed, button, openMenu, closeMenu] = (0, _ContextMenu.useContextMenu)();
  let contextMenu;

  if (menuDisplayed) {
    const buttonRect = button.current.getBoundingClientRect();
    contextMenu = /*#__PURE__*/_react.default.createElement(_ContextMenu.default, (0, _extends2.default)({}, (0, _ContextMenu.aboveLeftOf)(buttonRect), {
      onFinished: closeMenu,
      managed: false
    }), /*#__PURE__*/_react.default.createElement(_ReactionPicker.default, {
      mxEvent: mxEvent,
      reactions: reactions,
      onFinished: closeMenu
    }));
  }

  return /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement(_ContextMenuTooltipButton.ContextMenuTooltipButton, {
    className: (0, _classnames.default)("mx_ReactionsRow_addReactionButton", {
      mx_ReactionsRow_addReactionButton_active: menuDisplayed
    }),
    title: (0, _languageHandler._t)("Add reaction"),
    onClick: openMenu,
    onContextMenu: e => {
      e.preventDefault();
      openMenu();
    },
    isExpanded: menuDisplayed,
    inputRef: button
  }), contextMenu);
};

let ReactionsRow = (_dec = (0, _replaceableComponent.replaceableComponent)("views.messages.ReactionsRow"), _dec(_class = (_temp = _class2 = class ReactionsRow extends _react.default.PureComponent {
  constructor(props, context) {
    super(props, context);
    (0, _defineProperty2.default)(this, "onDecrypted", () => {
      // Decryption changes whether the event is actionable
      this.forceUpdate();
    });
    (0, _defineProperty2.default)(this, "onReactionsChange", () => {
      // TODO: Call `onHeightChanged` as needed
      this.setState({
        myReactions: this.getMyReactions()
      }); // Using `forceUpdate` for the moment, since we know the overall set of reactions
      // has changed (this is triggered by events for that purpose only) and
      // `PureComponent`s shallow state / props compare would otherwise filter this out.

      this.forceUpdate();
    });
    (0, _defineProperty2.default)(this, "onShowAllClick", () => {
      this.setState({
        showAll: true
      });
    });
    this.state = {
      myReactions: this.getMyReactions(),
      showAll: false
    };
  }

  componentDidMount() {
    const {
      mxEvent,
      reactions
    } = this.props;

    if (mxEvent.isBeingDecrypted() || mxEvent.shouldAttemptDecryption()) {
      mxEvent.once("Event.decrypted", this.onDecrypted);
    }

    if (reactions) {
      reactions.on("Relations.add", this.onReactionsChange);
      reactions.on("Relations.remove", this.onReactionsChange);
      reactions.on("Relations.redaction", this.onReactionsChange);
    }
  }

  componentWillUnmount() {
    const {
      mxEvent,
      reactions
    } = this.props;
    mxEvent.off("Event.decrypted", this.onDecrypted);

    if (reactions) {
      reactions.off("Relations.add", this.onReactionsChange);
      reactions.off("Relations.remove", this.onReactionsChange);
      reactions.off("Relations.redaction", this.onReactionsChange);
    }
  }

  componentDidUpdate(prevProps) {
    if (prevProps.reactions !== this.props.reactions) {
      this.props.reactions.on("Relations.add", this.onReactionsChange);
      this.props.reactions.on("Relations.remove", this.onReactionsChange);
      this.props.reactions.on("Relations.redaction", this.onReactionsChange);
      this.onReactionsChange();
    }
  }

  getMyReactions() {
    const reactions = this.props.reactions;

    if (!reactions) {
      return null;
    }

    const userId = this.context.getUserId();
    const myReactions = reactions.getAnnotationsBySender()[userId];

    if (!myReactions) {
      return null;
    }

    return [...myReactions.values()];
  }

  render() {
    const {
      mxEvent,
      reactions
    } = this.props;
    const {
      myReactions,
      showAll
    } = this.state;

    if (!reactions || !(0, _EventUtils.isContentActionable)(mxEvent)) {
      return null;
    }

    let items = reactions.getSortedAnnotationsByKey().map(([content, events]) => {
      const count = events.size;

      if (!count) {
        return null;
      }

      const myReactionEvent = myReactions && myReactions.find(mxEvent => {
        if (mxEvent.isRedacted()) {
          return false;
        }

        return mxEvent.getRelation().key === content;
      });
      return /*#__PURE__*/_react.default.createElement(_ReactionsRowButton.default, {
        key: content,
        content: content,
        count: count,
        mxEvent: mxEvent,
        reactionEvents: events,
        myReactionEvent: myReactionEvent
      });
    }).filter(item => !!item);
    if (!items.length) return null; // Show the first MAX_ITEMS if there are MAX_ITEMS + 1 or more items.
    // The "+ 1" ensure that the "show all" reveals something that takes up
    // more space than the button itself.

    let showAllButton;

    if (items.length > MAX_ITEMS_WHEN_LIMITED + 1 && !showAll) {
      items = items.slice(0, MAX_ITEMS_WHEN_LIMITED);
      showAllButton = /*#__PURE__*/_react.default.createElement("a", {
        className: "mx_ReactionsRow_showAll",
        href: "#",
        onClick: this.onShowAllClick
      }, (0, _languageHandler._t)("Show all"));
    }

    const cli = this.context;
    let addReactionButton;
    const room = cli.getRoom(mxEvent.getRoomId());

    if (room.getMyMembership() === "join" && room.currentState.maySendEvent(_event.EventType.Reaction, cli.getUserId())) {
      addReactionButton = /*#__PURE__*/_react.default.createElement(ReactButton, {
        mxEvent: mxEvent,
        reactions: reactions
      });
    }

    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_ReactionsRow",
      role: "toolbar",
      "aria-label": (0, _languageHandler._t)("Reactions")
    }, items, showAllButton, addReactionButton);
  }

}, (0, _defineProperty2.default)(_class2, "contextType", _MatrixClientContext.default), _temp)) || _class);
exports.default = ReactionsRow;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL21lc3NhZ2VzL1JlYWN0aW9uc1Jvdy50c3giXSwibmFtZXMiOlsiTUFYX0lURU1TX1dIRU5fTElNSVRFRCIsIlJlYWN0QnV0dG9uIiwibXhFdmVudCIsInJlYWN0aW9ucyIsIm1lbnVEaXNwbGF5ZWQiLCJidXR0b24iLCJvcGVuTWVudSIsImNsb3NlTWVudSIsImNvbnRleHRNZW51IiwiYnV0dG9uUmVjdCIsImN1cnJlbnQiLCJnZXRCb3VuZGluZ0NsaWVudFJlY3QiLCJteF9SZWFjdGlvbnNSb3dfYWRkUmVhY3Rpb25CdXR0b25fYWN0aXZlIiwiZSIsInByZXZlbnREZWZhdWx0IiwiUmVhY3Rpb25zUm93IiwiUmVhY3QiLCJQdXJlQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsImNvbnRleHQiLCJmb3JjZVVwZGF0ZSIsInNldFN0YXRlIiwibXlSZWFjdGlvbnMiLCJnZXRNeVJlYWN0aW9ucyIsInNob3dBbGwiLCJzdGF0ZSIsImNvbXBvbmVudERpZE1vdW50IiwiaXNCZWluZ0RlY3J5cHRlZCIsInNob3VsZEF0dGVtcHREZWNyeXB0aW9uIiwib25jZSIsIm9uRGVjcnlwdGVkIiwib24iLCJvblJlYWN0aW9uc0NoYW5nZSIsImNvbXBvbmVudFdpbGxVbm1vdW50Iiwib2ZmIiwiY29tcG9uZW50RGlkVXBkYXRlIiwicHJldlByb3BzIiwidXNlcklkIiwiZ2V0VXNlcklkIiwiZ2V0QW5ub3RhdGlvbnNCeVNlbmRlciIsInZhbHVlcyIsInJlbmRlciIsIml0ZW1zIiwiZ2V0U29ydGVkQW5ub3RhdGlvbnNCeUtleSIsIm1hcCIsImNvbnRlbnQiLCJldmVudHMiLCJjb3VudCIsInNpemUiLCJteVJlYWN0aW9uRXZlbnQiLCJmaW5kIiwiaXNSZWRhY3RlZCIsImdldFJlbGF0aW9uIiwia2V5IiwiZmlsdGVyIiwiaXRlbSIsImxlbmd0aCIsInNob3dBbGxCdXR0b24iLCJzbGljZSIsIm9uU2hvd0FsbENsaWNrIiwiY2xpIiwiYWRkUmVhY3Rpb25CdXR0b24iLCJyb29tIiwiZ2V0Um9vbSIsImdldFJvb21JZCIsImdldE15TWVtYmVyc2hpcCIsImN1cnJlbnRTdGF0ZSIsIm1heVNlbmRFdmVudCIsIkV2ZW50VHlwZSIsIlJlYWN0aW9uIiwiTWF0cml4Q2xpZW50Q29udGV4dCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQWdCQTs7QUFDQTs7QUFDQTs7QUFJQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7QUFFQTtBQUNBLE1BQU1BLHNCQUFzQixHQUFHLENBQS9COztBQUVBLE1BQU1DLFdBQVcsR0FBRyxDQUFDO0FBQUVDLEVBQUFBLE9BQUY7QUFBV0MsRUFBQUE7QUFBWCxDQUFELEtBQW9DO0FBQ3BELFFBQU0sQ0FBQ0MsYUFBRCxFQUFnQkMsTUFBaEIsRUFBd0JDLFFBQXhCLEVBQWtDQyxTQUFsQyxJQUErQyxrQ0FBckQ7QUFFQSxNQUFJQyxXQUFKOztBQUNBLE1BQUlKLGFBQUosRUFBbUI7QUFDZixVQUFNSyxVQUFVLEdBQUdKLE1BQU0sQ0FBQ0ssT0FBUCxDQUFlQyxxQkFBZixFQUFuQjtBQUNBSCxJQUFBQSxXQUFXLGdCQUFHLDZCQUFDLG9CQUFELDZCQUFpQiw4QkFBWUMsVUFBWixDQUFqQjtBQUEwQyxNQUFBLFVBQVUsRUFBRUYsU0FBdEQ7QUFBaUUsTUFBQSxPQUFPLEVBQUU7QUFBMUUscUJBQ1YsNkJBQUMsdUJBQUQ7QUFBZ0IsTUFBQSxPQUFPLEVBQUVMLE9BQXpCO0FBQWtDLE1BQUEsU0FBUyxFQUFFQyxTQUE3QztBQUF3RCxNQUFBLFVBQVUsRUFBRUk7QUFBcEUsTUFEVSxDQUFkO0FBR0g7O0FBRUQsc0JBQU8sNkJBQUMsY0FBRCxDQUFPLFFBQVAscUJBQ0gsNkJBQUMsa0RBQUQ7QUFDSSxJQUFBLFNBQVMsRUFBRSx5QkFBVyxtQ0FBWCxFQUFnRDtBQUN2REssTUFBQUEsd0NBQXdDLEVBQUVSO0FBRGEsS0FBaEQsQ0FEZjtBQUlJ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QUFiOztBQUNBLFFBQUlGLElBQUksQ0FBQ0csZUFBTCxPQUEyQixNQUEzQixJQUFxQ0gsSUFBSSxDQUFDSSxZQUFMLENBQWtCQyxZQUFsQixDQUErQkMsaUJBQVVDLFFBQXpDLEVBQW1EVCxHQUFHLENBQUN0QixTQUFKLEVBQW5ELENBQXpDLEVBQThHO0FBQzFHdUIsTUFBQUEsaUJBQWlCLGdCQUFHLDZCQUFDLFdBQUQ7QUFBYSxRQUFBLE9BQU8sRUFBRTVELE9BQXRCO0FBQStCLFFBQUEsU0FBUyxFQUFFQztBQUExQyxRQUFwQjtBQUNIOztBQUVELHdCQUFPO0FBQ0gsTUFBQSxTQUFTLEVBQUMsaUJBRFA7QUFFSCxNQUFBLElBQUksRUFBQyxTQUZGO0FBR0gsb0JBQVkseUJBQUcsV0FBSDtBQUhULE9BS0R3QyxLQUxDLEVBTURlLGFBTkMsRUFPREksaUJBUEMsQ0FBUDtBQVNIOztBQWpKeUUsQyx3REFDckRTLDRCIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE5LCAyMDIxIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0IGZyb20gXCJyZWFjdFwiO1xuaW1wb3J0IGNsYXNzTmFtZXMgZnJvbSBcImNsYXNzbmFtZXNcIjtcbmltcG9ydCB7IEV2ZW50VHlwZSB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9AdHlwZXMvZXZlbnRcIjtcbmltcG9ydCB7IE1hdHJpeEV2ZW50IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9ldmVudFwiO1xuaW1wb3J0IHsgUmVsYXRpb25zIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yZWxhdGlvbnNcIjtcblxuaW1wb3J0IHsgX3QgfSBmcm9tICcuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXInO1xuaW1wb3J0IHsgaXNDb250ZW50QWN0aW9uYWJsZSB9IGZyb20gJy4uLy4uLy4uL3V0aWxzL0V2ZW50VXRpbHMnO1xuaW1wb3J0IHsgcmVwbGFjZWFibGVDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvcmVwbGFjZWFibGVDb21wb25lbnRcIjtcbmltcG9ydCB7IENvbnRleHRNZW51VG9vbHRpcEJ1dHRvbiB9IGZyb20gXCIuLi8uLi8uLi9hY2Nlc3NpYmlsaXR5L2NvbnRleHRfbWVudS9Db250ZXh0TWVudVRvb2x0aXBCdXR0b25cIjtcbmltcG9ydCBDb250ZXh0TWVudSwgeyBhYm92ZUxlZnRPZiwgdXNlQ29udGV4dE1lbnUgfSBmcm9tIFwiLi4vLi4vc3RydWN0dXJlcy9Db250ZXh0TWVudVwiO1xuaW1wb3J0IFJlYWN0aW9uUGlja2VyIGZyb20gXCIuLi9lbW9qaXBpY2tlci9SZWFjdGlvblBpY2tlclwiO1xuaW1wb3J0IFJlYWN0aW9uc1Jvd0J1dHRvbiBmcm9tIFwiLi9SZWFjdGlvbnNSb3dCdXR0b25cIjtcbmltcG9ydCBNYXRyaXhDbGllbnRDb250ZXh0IGZyb20gXCIuLi8uLi8uLi9jb250ZXh0cy9NYXRyaXhDbGllbnRDb250ZXh0XCI7XG5cbi8vIFRoZSBtYXhpbXVtIG51bWJlciBvZiByZWFjdGlvbnMgdG8gaW5pdGlhbGx5IHNob3cgb24gYSBtZXNzYWdlLlxuY29uc3QgTUFYX0lURU1TX1dIRU5fTElNSVRFRCA9IDg7XG5cbmNvbnN0IFJlYWN0QnV0dG9uID0gKHsgbXhFdmVudCwgcmVhY3Rpb25zIH06IElQcm9wcykgPT4ge1xuICAgIGNvbnN0IFttZW51RGlzcGxheWVkLCBidXR0b24sIG9wZW5NZW51LCBjbG9zZU1lbnVdID0gdXNlQ29udGV4dE1lbnUoKTtcblxuICAgIGxldCBjb250ZXh0TWVudTtcbiAgICBpZiAobWVudURpc3BsYXllZCkge1xuICAgICAgICBjb25zdCBidXR0b25SZWN0ID0gYnV0dG9uLmN1cnJlbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgICAgIGNvbnRleHRNZW51ID0gPENvbnRleHRNZW51IHsuLi5hYm92ZUxlZnRPZihidXR0b25SZWN0KX0gb25GaW5pc2hlZD17Y2xvc2VNZW51fSBtYW5hZ2VkPXtmYWxzZX0+XG4gICAgICAgICAgICA8UmVhY3Rpb25QaWNrZXIgbXhFdmVudD17bXhFdmVudH0gcmVhY3Rpb25zPXtyZWFjdGlvbnN9IG9uRmluaXNoZWQ9e2Nsb3NlTWVudX0gLz5cbiAgICAgICAgPC9Db250ZXh0TWVudT47XG4gICAgfVxuXG4gICAgcmV0dXJuIDxSZWFjdC5GcmFnbWVudD5cbiAgICAgICAgPENvbnRleHRNZW51VG9vbHRpcEJ1dHRvblxuICAgICAgICAgICAgY2xhc3NOYW1lPXtjbGFzc05hbWVzKFwibXhfUmVhY3Rpb25zUm93X2FkZFJlYWN0aW9uQnV0dG9uXCIsIHtcbiAgICAgICAgICAgICAgICBteF9SZWFjdGlvbnNSb3dfYWRkUmVhY3Rpb25CdXR0b25fYWN0aXZlOiBtZW51RGlzcGxheWVkLFxuICAgICAgICAgICAgfSl9XG4gICAgICAgICAgICB0aXRsZT17X3QoXCJBZGQgcmVhY3Rpb25cIil9XG4gICAgICAgICAgICBvbkNsaWNrPXtvcGVuTWVudX1cbiAgICAgICAgICAgIG9uQ29udGV4dE1lbnU9e2UgPT4ge1xuICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICBvcGVuTWVudSgpO1xuICAgICAgICAgICAgfX1cbiAgICAgICAgICAgIGlzRXhwYW5kZWQ9e21lbnVEaXNwbGF5ZWR9XG4gICAgICAgICAgICBpbnB1dFJlZj17YnV0dG9ufVxuICAgICAgICAvPlxuXG4gICAgICAgIHsgY29udGV4dE1lbnUgfVxuICAgIDwvUmVhY3QuRnJhZ21lbnQ+O1xufTtcblxuaW50ZXJmYWNlIElQcm9wcyB7XG4gICAgLy8gVGhlIGV2ZW50IHdlJ3JlIGRpc3BsYXlpbmcgcmVhY3Rpb25zIGZvclxuICAgIG14RXZlbnQ6IE1hdHJpeEV2ZW50O1xuICAgIC8vIFRoZSBSZWxhdGlvbnMgbW9kZWwgZnJvbSB0aGUgSlMgU0RLIGZvciByZWFjdGlvbnMgdG8gYG14RXZlbnRgXG4gICAgcmVhY3Rpb25zPzogUmVsYXRpb25zO1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBteVJlYWN0aW9uczogTWF0cml4RXZlbnRbXTtcbiAgICBzaG93QWxsOiBib29sZWFuO1xufVxuXG5AcmVwbGFjZWFibGVDb21wb25lbnQoXCJ2aWV3cy5tZXNzYWdlcy5SZWFjdGlvbnNSb3dcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJlYWN0aW9uc1JvdyBleHRlbmRzIFJlYWN0LlB1cmVDb21wb25lbnQ8SVByb3BzLCBJU3RhdGU+IHtcbiAgICBzdGF0aWMgY29udGV4dFR5cGUgPSBNYXRyaXhDbGllbnRDb250ZXh0O1xuXG4gICAgY29uc3RydWN0b3IocHJvcHMsIGNvbnRleHQpIHtcbiAgICAgICAgc3VwZXIocHJvcHMsIGNvbnRleHQpO1xuXG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICBteVJlYWN0aW9uczogdGhpcy5nZXRNeVJlYWN0aW9ucygpLFxuICAgICAgICAgICAgc2hvd0FsbDogZmFsc2UsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgICAgIGNvbnN0IHsgbXhFdmVudCwgcmVhY3Rpb25zIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgICAgIGlmIChteEV2ZW50LmlzQmVpbmdEZWNyeXB0ZWQoKSB8fCBteEV2ZW50LnNob3VsZEF0dGVtcHREZWNyeXB0aW9uKCkpIHtcbiAgICAgICAgICAgIG14RXZlbnQub25jZShcIkV2ZW50LmRlY3J5cHRlZFwiLCB0aGlzLm9uRGVjcnlwdGVkKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChyZWFjdGlvbnMpIHtcbiAgICAgICAgICAgIHJlYWN0aW9ucy5vbihcIlJlbGF0aW9ucy5hZGRcIiwgdGhpcy5vblJlYWN0aW9uc0NoYW5nZSk7XG4gICAgICAgICAgICByZWFjdGlvbnMub24oXCJSZWxhdGlvbnMucmVtb3ZlXCIsIHRoaXMub25SZWFjdGlvbnNDaGFuZ2UpO1xuICAgICAgICAgICAgcmVhY3Rpb25zLm9uKFwiUmVsYXRpb25zLnJlZGFjdGlvblwiLCB0aGlzLm9uUmVhY3Rpb25zQ2hhbmdlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgICBjb25zdCB7IG14RXZlbnQsIHJlYWN0aW9ucyB9ID0gdGhpcy5wcm9wcztcblxuICAgICAgICBteEV2ZW50Lm9mZihcIkV2ZW50LmRlY3J5cHRlZFwiLCB0aGlzLm9uRGVjcnlwdGVkKTtcblxuICAgICAgICBpZiAocmVhY3Rpb25zKSB7XG4gICAgICAgICAgICByZWFjdGlvbnMub2ZmKFwiUmVsYXRpb25zLmFkZFwiLCB0aGlzLm9uUmVhY3Rpb25zQ2hhbmdlKTtcbiAgICAgICAgICAgIHJlYWN0aW9ucy5vZmYoXCJSZWxhdGlvbnMucmVtb3ZlXCIsIHRoaXMub25SZWFjdGlvbnNDaGFuZ2UpO1xuICAgICAgICAgICAgcmVhY3Rpb25zLm9mZihcIlJlbGF0aW9ucy5yZWRhY3Rpb25cIiwgdGhpcy5vblJlYWN0aW9uc0NoYW5nZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb21wb25lbnREaWRVcGRhdGUocHJldlByb3BzOiBJUHJvcHMpIHtcbiAgICAgICAgaWYgKHByZXZQcm9wcy5yZWFjdGlvbnMgIT09IHRoaXMucHJvcHMucmVhY3Rpb25zKSB7XG4gICAgICAgICAgICB0aGlzLnByb3BzLnJlYWN0aW9ucy5vbihcIlJlbGF0aW9ucy5hZGRcIiwgdGhpcy5vblJlYWN0aW9uc0NoYW5nZSk7XG4gICAgICAgICAgICB0aGlzLnByb3BzLnJlYWN0aW9ucy5vbihcIlJlbGF0aW9ucy5yZW1vdmVcIiwgdGhpcy5vblJlYWN0aW9uc0NoYW5nZSk7XG4gICAgICAgICAgICB0aGlzLnByb3BzLnJlYWN0aW9ucy5vbihcIlJlbGF0aW9ucy5yZWRhY3Rpb25cIiwgdGhpcy5vblJlYWN0aW9uc0NoYW5nZSk7XG4gICAgICAgICAgICB0aGlzLm9uUmVhY3Rpb25zQ2hhbmdlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIG9uRGVjcnlwdGVkID0gKCkgPT4ge1xuICAgICAgICAvLyBEZWNyeXB0aW9uIGNoYW5nZXMgd2hldGhlciB0aGUgZXZlbnQgaXMgYWN0aW9uYWJsZVxuICAgICAgICB0aGlzLmZvcmNlVXBkYXRlKCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25SZWFjdGlvbnNDaGFuZ2UgPSAoKSA9PiB7XG4gICAgICAgIC8vIFRPRE86IENhbGwgYG9uSGVpZ2h0Q2hhbmdlZGAgYXMgbmVlZGVkXG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgbXlSZWFjdGlvbnM6IHRoaXMuZ2V0TXlSZWFjdGlvbnMoKSxcbiAgICAgICAgfSk7XG4gICAgICAgIC8vIFVzaW5nIGBmb3JjZVVwZGF0ZWAgZm9yIHRoZSBtb21lbnQsIHNpbmNlIHdlIGtub3cgdGhlIG92ZXJhbGwgc2V0IG9mIHJlYWN0aW9uc1xuICAgICAgICAvLyBoYXMgY2hhbmdlZCAodGhpcyBpcyB0cmlnZ2VyZWQgYnkgZXZlbnRzIGZvciB0aGF0IHB1cnBvc2Ugb25seSkgYW5kXG4gICAgICAgIC8vIGBQdXJlQ29tcG9uZW50YHMgc2hhbGxvdyBzdGF0ZSAvIHByb3BzIGNvbXBhcmUgd291bGQgb3RoZXJ3aXNlIGZpbHRlciB0aGlzIG91dC5cbiAgICAgICAgdGhpcy5mb3JjZVVwZGF0ZSgpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIGdldE15UmVhY3Rpb25zKCkge1xuICAgICAgICBjb25zdCByZWFjdGlvbnMgPSB0aGlzLnByb3BzLnJlYWN0aW9ucztcbiAgICAgICAgaWYgKCFyZWFjdGlvbnMpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHVzZXJJZCA9IHRoaXMuY29udGV4dC5nZXRVc2VySWQoKTtcbiAgICAgICAgY29uc3QgbXlSZWFjdGlvbnMgPSByZWFjdGlvbnMuZ2V0QW5ub3RhdGlvbnNCeVNlbmRlcigpW3VzZXJJZF07XG4gICAgICAgIGlmICghbXlSZWFjdGlvbnMpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBbLi4ubXlSZWFjdGlvbnMudmFsdWVzKCldO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25TaG93QWxsQ2xpY2sgPSAoKSA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgc2hvd0FsbDogdHJ1ZSxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3QgeyBteEV2ZW50LCByZWFjdGlvbnMgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGNvbnN0IHsgbXlSZWFjdGlvbnMsIHNob3dBbGwgfSA9IHRoaXMuc3RhdGU7XG5cbiAgICAgICAgaWYgKCFyZWFjdGlvbnMgfHwgIWlzQ29udGVudEFjdGlvbmFibGUobXhFdmVudCkpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGl0ZW1zID0gcmVhY3Rpb25zLmdldFNvcnRlZEFubm90YXRpb25zQnlLZXkoKS5tYXAoKFtjb250ZW50LCBldmVudHNdKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjb3VudCA9IGV2ZW50cy5zaXplO1xuICAgICAgICAgICAgaWYgKCFjb3VudCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgbXlSZWFjdGlvbkV2ZW50ID0gbXlSZWFjdGlvbnMgJiYgbXlSZWFjdGlvbnMuZmluZChteEV2ZW50ID0+IHtcbiAgICAgICAgICAgICAgICBpZiAobXhFdmVudC5pc1JlZGFjdGVkKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gbXhFdmVudC5nZXRSZWxhdGlvbigpLmtleSA9PT0gY29udGVudDtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIDxSZWFjdGlvbnNSb3dCdXR0b25cbiAgICAgICAgICAgICAgICBrZXk9e2NvbnRlbnR9XG4gICAgICAgICAgICAgICAgY29udGVudD17Y29udGVudH1cbiAgICAgICAgICAgICAgICBjb3VudD17Y291bnR9XG4gICAgICAgICAgICAgICAgbXhFdmVudD17bXhFdmVudH1cbiAgICAgICAgICAgICAgICByZWFjdGlvbkV2ZW50cz17ZXZlbnRzfVxuICAgICAgICAgICAgICAgIG15UmVhY3Rpb25FdmVudD17bXlSZWFjdGlvbkV2ZW50fVxuICAgICAgICAgICAgLz47XG4gICAgICAgIH0pLmZpbHRlcihpdGVtID0+ICEhaXRlbSk7XG5cbiAgICAgICAgaWYgKCFpdGVtcy5sZW5ndGgpIHJldHVybiBudWxsO1xuXG4gICAgICAgIC8vIFNob3cgdGhlIGZpcnN0IE1BWF9JVEVNUyBpZiB0aGVyZSBhcmUgTUFYX0lURU1TICsgMSBvciBtb3JlIGl0ZW1zLlxuICAgICAgICAvLyBUaGUgXCIrIDFcIiBlbnN1cmUgdGhhdCB0aGUgXCJzaG93IGFsbFwiIHJldmVhbHMgc29tZXRoaW5nIHRoYXQgdGFrZXMgdXBcbiAgICAgICAgLy8gbW9yZSBzcGFjZSB0aGFuIHRoZSBidXR0b24gaXRzZWxmLlxuICAgICAgICBsZXQgc2hvd0FsbEJ1dHRvbjtcbiAgICAgICAgaWYgKChpdGVtcy5sZW5ndGggPiBNQVhfSVRFTVNfV0hFTl9MSU1JVEVEICsgMSkgJiYgIXNob3dBbGwpIHtcbiAgICAgICAgICAgIGl0ZW1zID0gaXRlbXMuc2xpY2UoMCwgTUFYX0lURU1TX1dIRU5fTElNSVRFRCk7XG4gICAgICAgICAgICBzaG93QWxsQnV0dG9uID0gPGFcbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9SZWFjdGlvbnNSb3dfc2hvd0FsbFwiXG4gICAgICAgICAgICAgICAgaHJlZj1cIiNcIlxuICAgICAgICAgICAgICAgIG9uQ2xpY2s9e3RoaXMub25TaG93QWxsQ2xpY2t9XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgeyBfdChcIlNob3cgYWxsXCIpIH1cbiAgICAgICAgICAgIDwvYT47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBjbGkgPSB0aGlzLmNvbnRleHQ7XG5cbiAgICAgICAgbGV0IGFkZFJlYWN0aW9uQnV0dG9uO1xuICAgICAgICBjb25zdCByb29tID0gY2xpLmdldFJvb20obXhFdmVudC5nZXRSb29tSWQoKSk7XG4gICAgICAgIGlmIChyb29tLmdldE15TWVtYmVyc2hpcCgpID09PSBcImpvaW5cIiAmJiByb29tLmN1cnJlbnRTdGF0ZS5tYXlTZW5kRXZlbnQoRXZlbnRUeXBlLlJlYWN0aW9uLCBjbGkuZ2V0VXNlcklkKCkpKSB7XG4gICAgICAgICAgICBhZGRSZWFjdGlvbkJ1dHRvbiA9IDxSZWFjdEJ1dHRvbiBteEV2ZW50PXtteEV2ZW50fSByZWFjdGlvbnM9e3JlYWN0aW9uc30gLz47XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gPGRpdlxuICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfUmVhY3Rpb25zUm93XCJcbiAgICAgICAgICAgIHJvbGU9XCJ0b29sYmFyXCJcbiAgICAgICAgICAgIGFyaWEtbGFiZWw9e190KFwiUmVhY3Rpb25zXCIpfVxuICAgICAgICA+XG4gICAgICAgICAgICB7IGl0ZW1zIH1cbiAgICAgICAgICAgIHsgc2hvd0FsbEJ1dHRvbiB9XG4gICAgICAgICAgICB7IGFkZFJlYWN0aW9uQnV0dG9uIH1cbiAgICAgICAgPC9kaXY+O1xuICAgIH1cbn1cbiJdfQ==