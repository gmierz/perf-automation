"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _languageHandler = require("../../../languageHandler");

var _EncryptionInfo = require("../right_panel/EncryptionInfo");

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _FontManager = require("../../../utils/FontManager");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _dec, _class;

function capFirst(s) {
  return s.charAt(0).toUpperCase() + s.slice(1);
}

let VerificationShowSas = (_dec = (0, _replaceableComponent.replaceableComponent)("views.verification.VerificationShowSas"), _dec(_class = class VerificationShowSas extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onMatchClick", () => {
      this.setState({
        pending: true
      });
      this.props.onDone();
    });
    (0, _defineProperty2.default)(this, "onDontMatchClick", () => {
      this.setState({
        cancelling: true
      });
      this.props.onCancel();
    });
    this.state = {
      pending: false
    };
  }

  componentWillMount() {
    // As this component is also used before login (during complete security),
    // also make sure we have a working emoji font to display the SAS emojis here.
    // This is also done from LoggedInView.
    (0, _FontManager.fixupColorFonts)();
  }

  render() {
    let sasDisplay;
    let sasCaption;

    if (this.props.sas.emoji) {
      const emojiBlocks = this.props.sas.emoji.map((emoji, i) => /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_VerificationShowSas_emojiSas_block",
        key: i
      }, /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_VerificationShowSas_emojiSas_emoji"
      }, emoji[0]), /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_VerificationShowSas_emojiSas_label"
      }, (0, _languageHandler._t)(capFirst(emoji[1])))));
      sasDisplay = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_VerificationShowSas_emojiSas"
      }, emojiBlocks.slice(0, 4), /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_VerificationShowSas_emojiSas_break"
      }), emojiBlocks.slice(4));
      sasCaption = this.props.isSelf ? (0, _languageHandler._t)("Confirm the emoji below are displayed on both sessions, in the same order:") : (0, _languageHandler._t)("Verify this user by confirming the following emoji appear on their screen.");
    } else if (this.props.sas.decimal) {
      const numberBlocks = this.props.sas.decimal.map((num, i) => /*#__PURE__*/_react.default.createElement("span", {
        key: i
      }, num));
      sasDisplay = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_VerificationShowSas_decimalSas"
      }, numberBlocks);
      sasCaption = this.props.isSelf ? (0, _languageHandler._t)("Verify this session by confirming the following number appears on its screen.") : (0, _languageHandler._t)("Verify this user by confirming the following number appears on their screen.");
    } else {
      return /*#__PURE__*/_react.default.createElement("div", null, (0, _languageHandler._t)("Unable to find a supported verification method."), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        kind: "primary",
        onClick: this.props.onCancel
      }, (0, _languageHandler._t)('Cancel')));
    }

    let confirm;

    if (this.state.pending && this.props.isSelf) {
      let text; // device shouldn't be null in this situation but it can be, eg. if the device is
      // logged out during verification

      if (this.props.device) {
        text = (0, _languageHandler._t)("Waiting for you to verify on your other session, %(deviceName)s (%(deviceId)s)…", {
          deviceName: this.props.device ? this.props.device.getDisplayName() : '',
          deviceId: this.props.device ? this.props.device.deviceId : ''
        });
      } else {
        text = (0, _languageHandler._t)("Waiting for you to verify on your other session…");
      }

      confirm = /*#__PURE__*/_react.default.createElement("p", null, text);
    } else if (this.state.pending || this.state.cancelling) {
      let text;

      if (this.state.pending) {
        const {
          displayName
        } = this.props;
        text = (0, _languageHandler._t)("Waiting for %(displayName)s to verify…", {
          displayName
        });
      } else {
        text = (0, _languageHandler._t)("Cancelling…");
      }

      confirm = /*#__PURE__*/_react.default.createElement(_EncryptionInfo.PendingActionSpinner, {
        text: text
      });
    } else {
      confirm = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_VerificationShowSas_buttonRow"
      }, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        onClick: this.onDontMatchClick,
        kind: "danger"
      }, (0, _languageHandler._t)("They don't match")), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        onClick: this.onMatchClick,
        kind: "primary"
      }, (0, _languageHandler._t)("They match")));
    }

    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_VerificationShowSas"
    }, /*#__PURE__*/_react.default.createElement("p", null, sasCaption), sasDisplay, /*#__PURE__*/_react.default.createElement("p", null, this.props.isSelf ? "" : (0, _languageHandler._t)("To be secure, do this in person or use a trusted way to communicate.")), confirm);
  }

}) || _class);
exports.default = VerificationShowSas;
// List of Emoji strings from the js-sdk, for i18n
(0, _languageHandler._td)("Dog");
(0, _languageHandler._td)("Cat");
(0, _languageHandler._td)("Lion");
(0, _languageHandler._td)("Horse");
(0, _languageHandler._td)("Unicorn");
(0, _languageHandler._td)("Pig");
(0, _languageHandler._td)("Elephant");
(0, _languageHandler._td)("Rabbit");
(0, _languageHandler._td)("Panda");
(0, _languageHandler._td)("Rooster");
(0, _languageHandler._td)("Penguin");
(0, _languageHandler._td)("Turtle");
(0, _languageHandler._td)("Fish");
(0, _languageHandler._td)("Octopus");
(0, _languageHandler._td)("Butterfly");
(0, _languageHandler._td)("Flower");
(0, _languageHandler._td)("Tree");
(0, _languageHandler._td)("Cactus");
(0, _languageHandler._td)("Mushroom");
(0, _languageHandler._td)("Globe");
(0, _languageHandler._td)("Moon");
(0, _languageHandler._td)("Cloud");
(0, _languageHandler._td)("Fire");
(0, _languageHandler._td)("Banana");
(0, _languageHandler._td)("Apple");
(0, _languageHandler._td)("Strawberry");
(0, _languageHandler._td)("Corn");
(0, _languageHandler._td)("Pizza");
(0, _languageHandler._td)("Cake");
(0, _languageHandler._td)("Heart");
(0, _languageHandler._td)("Smiley");
(0, _languageHandler._td)("Robot");
(0, _languageHandler._td)("Hat");
(0, _languageHandler._td)("Glasses");
(0, _languageHandler._td)("Spanner");
(0, _languageHandler._td)("Santa");
(0, _languageHandler._td)("Thumbs up");
(0, _languageHandler._td)("Umbrella");
(0, _languageHandler._td)("Hourglass");
(0, _languageHandler._td)("Clock");
(0, _languageHandler._td)("Gift");
(0, _languageHandler._td)("Light bulb");
(0, _languageHandler._td)("Book");
(0, _languageHandler._td)("Pencil");
(0, _languageHandler._td)("Paperclip");
(0, _languageHandler._td)("Scissors");
(0, _languageHandler._td)("Lock");
(0, _languageHandler._td)("Key");
(0, _languageHandler._td)("Hammer");
(0, _languageHandler._td)("Telephone");
(0, _languageHandler._td)("Flag");
(0, _languageHandler._td)("Train");
(0, _languageHandler._td)("Bicycle");
(0, _languageHandler._td)("Aeroplane");
(0, _languageHandler._td)("Rocket");
(0, _languageHandler._td)("Trophy");
(0, _languageHandler._td)("Ball");
(0, _languageHandler._td)("Guitar");
(0, _languageHandler._td)("Trumpet");
(0, _languageHandler._td)("Bell");
(0, _languageHandler._td)("Anchor");
(0, _languageHandler._td)("Headphones");
(0, _languageHandler._td)("Folder");
(0, _languageHandler._td)("Pin");
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3ZlcmlmaWNhdGlvbi9WZXJpZmljYXRpb25TaG93U2FzLnRzeCJdLCJuYW1lcyI6WyJjYXBGaXJzdCIsInMiLCJjaGFyQXQiLCJ0b1VwcGVyQ2FzZSIsInNsaWNlIiwiVmVyaWZpY2F0aW9uU2hvd1NhcyIsIlJlYWN0IiwiQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsInNldFN0YXRlIiwicGVuZGluZyIsIm9uRG9uZSIsImNhbmNlbGxpbmciLCJvbkNhbmNlbCIsInN0YXRlIiwiY29tcG9uZW50V2lsbE1vdW50IiwicmVuZGVyIiwic2FzRGlzcGxheSIsInNhc0NhcHRpb24iLCJzYXMiLCJlbW9qaSIsImVtb2ppQmxvY2tzIiwibWFwIiwiaSIsImlzU2VsZiIsImRlY2ltYWwiLCJudW1iZXJCbG9ja3MiLCJudW0iLCJjb25maXJtIiwidGV4dCIsImRldmljZSIsImRldmljZU5hbWUiLCJnZXREaXNwbGF5TmFtZSIsImRldmljZUlkIiwiZGlzcGxheU5hbWUiLCJvbkRvbnRNYXRjaENsaWNrIiwib25NYXRjaENsaWNrIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWdCQTs7QUFHQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQWtCQSxTQUFTQSxRQUFULENBQWtCQyxDQUFsQixFQUFxQjtBQUNqQixTQUFPQSxDQUFDLENBQUNDLE1BQUYsQ0FBUyxDQUFULEVBQVlDLFdBQVosS0FBNEJGLENBQUMsQ0FBQ0csS0FBRixDQUFRLENBQVIsQ0FBbkM7QUFDSDs7SUFHb0JDLG1CLFdBRHBCLGdEQUFxQix3Q0FBckIsQyxnQkFBRCxNQUNxQkEsbUJBRHJCLFNBQ2lEQyxlQUFNQyxTQUR2RCxDQUNpRjtBQUM3RUMsRUFBQUEsV0FBVyxDQUFDQyxLQUFELEVBQWdCO0FBQ3ZCLFVBQU1BLEtBQU47QUFEdUIsd0RBZUosTUFBWTtBQUMvQixXQUFLQyxRQUFMLENBQWM7QUFBRUMsUUFBQUEs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QUo7QUFDQSwwQkFBSSxVQUFKO0FBQ0EsMEJBQUksTUFBSjtBQUNBLDBCQUFJLEtBQUo7QUFDQSwwQkFBSSxRQUFKO0FBQ0EsMEJBQUksV0FBSjtBQUNBLDBCQUFJLE1BQUo7QUFDQSwwQkFBSSxPQUFKO0FBQ0EsMEJBQUksU0FBSjtBQUNBLDBCQUFJLFdBQUo7QUFDQSwwQkFBSSxRQUFKO0FBQ0EsMEJBQUksUUFBSjtBQUNBLDBCQUFJLE1BQUo7QUFDQSwwQkFBSSxRQUFKO0FBQ0EsMEJBQUksU0FBSjtBQUNBLDBCQUFJLE1BQUo7QUFDQSwwQkFBSSxRQUFKO0FBQ0EsMEJBQUksWUFBSjtBQUNBLDBCQUFJLFFBQUo7QUFDQSwwQkFBSSxLQUFKIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE5IFZlY3RvciBDcmVhdGlvbnMgTHRkXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IElHZW5lcmF0ZWRTYXMgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvY3J5cHRvL3ZlcmlmaWNhdGlvbi9TQVNcIjtcbmltcG9ydCB7IERldmljZUluZm8gfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvL2NyeXB0by9kZXZpY2VpbmZvXCI7XG5pbXBvcnQgeyBfdCwgX3RkIH0gZnJvbSAnLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyJztcbmltcG9ydCB7IFBlbmRpbmdBY3Rpb25TcGlubmVyIH0gZnJvbSBcIi4uL3JpZ2h0X3BhbmVsL0VuY3J5cHRpb25JbmZvXCI7XG5pbXBvcnQgQWNjZXNzaWJsZUJ1dHRvbiBmcm9tIFwiLi4vZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvblwiO1xuaW1wb3J0IHsgZml4dXBDb2xvckZvbnRzIH0gZnJvbSAnLi4vLi4vLi4vdXRpbHMvRm9udE1hbmFnZXInO1xuaW1wb3J0IHsgcmVwbGFjZWFibGVDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvcmVwbGFjZWFibGVDb21wb25lbnRcIjtcblxuaW50ZXJmYWNlIElQcm9wcyB7XG4gICAgcGVuZGluZz86IGJvb2xlYW47XG4gICAgZGlzcGxheU5hbWU/OiBzdHJpbmc7IC8vIHJlcXVpcmVkIGlmIHBlbmRpbmcgaXMgdHJ1ZVxuICAgIGRldmljZT86IERldmljZUluZm87XG4gICAgb25Eb25lOiAoKSA9PiB2b2lkO1xuICAgIG9uQ2FuY2VsOiAoKSA9PiB2b2lkO1xuICAgIHNhczogSUdlbmVyYXRlZFNhcztcbiAgICBpc1NlbGY/OiBib29sZWFuO1xuICAgIGluRGlhbG9nPzogYm9vbGVhbjsgLy8gd2hldGhlciB0aGlzIGNvbXBvbmVudCBpcyBiZWluZyBzaG93biBpbiBhIGRpYWxvZyBhbmQgdG8gdXNlIERpYWxvZ0J1dHRvbnNcbn1cblxuaW50ZXJmYWNlIElTdGF0ZSB7XG4gICAgcGVuZGluZzogYm9vbGVhbjtcbiAgICBjYW5jZWxsaW5nPzogYm9vbGVhbjtcbn1cblxuZnVuY3Rpb24gY2FwRmlyc3Qocykge1xuICAgIHJldHVybiBzLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgcy5zbGljZSgxKTtcbn1cblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3MudmVyaWZpY2F0aW9uLlZlcmlmaWNhdGlvblNob3dTYXNcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFZlcmlmaWNhdGlvblNob3dTYXMgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8SVByb3BzLCBJU3RhdGU+IHtcbiAgICBjb25zdHJ1Y3Rvcihwcm9wczogSVByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgcGVuZGluZzogZmFsc2UsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHVibGljIGNvbXBvbmVudFdpbGxNb3VudCgpOiB2b2lkIHtcbiAgICAgICAgLy8gQXMgdGhpcyBjb21wb25lbnQgaXMgYWxzbyB1c2VkIGJlZm9yZSBsb2dpbiAoZHVyaW5nIGNvbXBsZXRlIHNlY3VyaXR5KSxcbiAgICAgICAgLy8gYWxzbyBtYWtlIHN1cmUgd2UgaGF2ZSBhIHdvcmtpbmcgZW1vamkgZm9udCB0byBkaXNwbGF5IHRoZSBTQVMgZW1vamlzIGhlcmUuXG4gICAgICAgIC8vIFRoaXMgaXMgYWxzbyBkb25lIGZyb20gTG9nZ2VkSW5WaWV3LlxuICAgICAgICBmaXh1cENvbG9yRm9udHMoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uTWF0Y2hDbGljayA9ICgpOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IHBlbmRpbmc6IHRydWUgfSk7XG4gICAgICAgIHRoaXMucHJvcHMub25Eb25lKCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25Eb250TWF0Y2hDbGljayA9ICgpOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGNhbmNlbGxpbmc6IHRydWUgfSk7XG4gICAgICAgIHRoaXMucHJvcHMub25DYW5jZWwoKTtcbiAgICB9O1xuXG4gICAgcmVuZGVyKCkge1xuICAgICAgICBsZXQgc2FzRGlzcGxheTtcbiAgICAgICAgbGV0IHNhc0NhcHRpb247XG4gICAgICAgIGlmICh0aGlzLnByb3BzLnNhcy5lbW9qaSkge1xuICAgICAgICAgICAgY29uc3QgZW1vamlCbG9ja3MgPSB0aGlzLnByb3BzLnNhcy5lbW9qaS5tYXAoXG4gICAgICAgICAgICAgICAgKGVtb2ppLCBpKSA9PiA8ZGl2IGNsYXNzTmFtZT1cIm14X1ZlcmlmaWNhdGlvblNob3dTYXNfZW1vamlTYXNfYmxvY2tcIiBrZXk9e2l9PlxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X1ZlcmlmaWNhdGlvblNob3dTYXNfZW1vamlTYXNfZW1vamlcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgZW1vamlbMF0gfVxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9WZXJpZmljYXRpb25TaG93U2FzX2Vtb2ppU2FzX2xhYmVsXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICB7IF90KGNhcEZpcnN0KGVtb2ppWzFdKSkgfVxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICA8L2Rpdj4sXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgc2FzRGlzcGxheSA9IDxkaXYgY2xhc3NOYW1lPVwibXhfVmVyaWZpY2F0aW9uU2hvd1Nhc19lbW9qaVNhc1wiPlxuICAgICAgICAgICAgICAgIHsgZW1vamlCbG9ja3Muc2xpY2UoMCwgNCkgfVxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfVmVyaWZpY2F0aW9uU2hvd1Nhc19lbW9qaVNhc19icmVha1wiIC8+XG4gICAgICAgICAgICAgICAgeyBlbW9qaUJsb2Nrcy5zbGljZSg0KSB9XG4gICAgICAgICAgICA8L2Rpdj47XG4gICAgICAgICAgICBzYXNDYXB0aW9uID0gdGhpcy5wcm9wcy5pc1NlbGYgP1xuICAgICAgICAgICAgICAgIF90KFxuICAgICAgICAgICAgICAgICAgICBcIkNvbmZpcm0gdGhlIGVtb2ppIGJlbG93IGFyZSBkaXNwbGF5ZWQgb24gYm90aCBzZXNzaW9ucywgaW4gdGhlIHNhbWUgb3JkZXI6XCIsXG4gICAgICAgICAgICAgICAgKTpcbiAgICAgICAgICAgICAgICBfdChcbiAgICAgICAgICAgICAgICAgICAgXCJWZXJpZnkgdGhpcyB1c2VyIGJ5IGNvbmZpcm1pbmcgdGhlIGZvbGxvd2luZyBlbW9qaSBhcHBlYXIgb24gdGhlaXIgc2NyZWVuLlwiLFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5wcm9wcy5zYXMuZGVjaW1hbCkge1xuICAgICAgICAgICAgY29uc3QgbnVtYmVyQmxvY2tzID0gdGhpcy5wcm9wcy5zYXMuZGVjaW1hbC5tYXAoKG51bSwgaSkgPT4gPHNwYW4ga2V5PXtpfT5cbiAgICAgICAgICAgICAgICB7IG51bSB9XG4gICAgICAgICAgICA8L3NwYW4+KTtcbiAgICAgICAgICAgIHNhc0Rpc3BsYXkgPSA8ZGl2IGNsYXNzTmFtZT1cIm14X1ZlcmlmaWNhdGlvblNob3dTYXNfZGVjaW1hbFNhc1wiPlxuICAgICAgICAgICAgICAgIHsgbnVtYmVyQmxvY2tzIH1cbiAgICAgICAgICAgIDwvZGl2PjtcbiAgICAgICAgICAgIHNhc0NhcHRpb24gPSB0aGlzLnByb3BzLmlzU2VsZiA/XG4gICAgICAgICAgICAgICAgX3QoXG4gICAgICAgICAgICAgICAgICAgIFwiVmVyaWZ5IHRoaXMgc2Vzc2lvbiBieSBjb25maXJtaW5nIHRoZSBmb2xsb3dpbmcgbnVtYmVyIGFwcGVhcnMgb24gaXRzIHNjcmVlbi5cIixcbiAgICAgICAgICAgICAgICApOlxuICAgICAgICAgICAgICAgIF90KFxuICAgICAgICAgICAgICAgICAgICBcIlZlcmlmeSB0aGlzIHVzZXIgYnkgY29uZmlybWluZyB0aGUgZm9sbG93aW5nIG51bWJlciBhcHBlYXJzIG9uIHRoZWlyIHNjcmVlbi5cIixcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIDxkaXY+XG4gICAgICAgICAgICAgICAgeyBfdChcIlVuYWJsZSB0byBmaW5kIGEgc3VwcG9ydGVkIHZlcmlmaWNhdGlvbiBtZXRob2QuXCIpIH1cbiAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvbiBraW5kPVwicHJpbWFyeVwiIG9uQ2xpY2s9e3RoaXMucHJvcHMub25DYW5jZWx9PlxuICAgICAgICAgICAgICAgICAgICB7IF90KCdDYW5jZWwnKSB9XG4gICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgPC9kaXY+O1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGNvbmZpcm07XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnBlbmRpbmcgJiYgdGhpcy5wcm9wcy5pc1NlbGYpIHtcbiAgICAgICAgICAgIGxldCB0ZXh0O1xuICAgICAgICAgICAgLy8gZGV2aWNlIHNob3VsZG4ndCBiZSBudWxsIGluIHRoaXMgc2l0dWF0aW9uIGJ1dCBpdCBjYW4gYmUsIGVnLiBpZiB0aGUgZGV2aWNlIGlzXG4gICAgICAgICAgICAvLyBsb2dnZWQgb3V0IGR1cmluZyB2ZXJpZmljYXRpb25cbiAgICAgICAgICAgIGlmICh0aGlzLnByb3BzLmRldmljZSkge1xuICAgICAgICAgICAgICAgIHRleHQgPSBfdChcIldhaXRpbmcgZm9yIHlvdSB0byB2ZXJpZnkgb24geW91ciBvdGhlciBzZXNzaW9uLCAlKGRldmljZU5hbWUpcyAoJShkZXZpY2VJZClzKeKAplwiLCB7XG4gICAgICAgICAgICAgICAgICAgIGRldmljZU5hbWU6IHRoaXMucHJvcHMuZGV2aWNlID8gdGhpcy5wcm9wcy5kZXZpY2UuZ2V0RGlzcGxheU5hbWUoKSA6ICcnLFxuICAgICAgICAgICAgICAgICAgICBkZXZpY2VJZDogdGhpcy5wcm9wcy5kZXZpY2UgPyB0aGlzLnByb3BzLmRldmljZS5kZXZpY2VJZCA6ICcnLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0ZXh0ID0gX3QoXCJXYWl0aW5nIGZvciB5b3UgdG8gdmVyaWZ5IG9uIHlvdXIgb3RoZXIgc2Vzc2lvbuKAplwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbmZpcm0gPSA8cD57IHRleHQgfTwvcD47XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5zdGF0ZS5wZW5kaW5nIHx8IHRoaXMuc3RhdGUuY2FuY2VsbGluZykge1xuICAgICAgICAgICAgbGV0IHRleHQ7XG4gICAgICAgICAgICBpZiAodGhpcy5zdGF0ZS5wZW5kaW5nKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgeyBkaXNwbGF5TmFtZSB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgICAgICAgICB0ZXh0ID0gX3QoXCJXYWl0aW5nIGZvciAlKGRpc3BsYXlOYW1lKXMgdG8gdmVyaWZ54oCmXCIsIHsgZGlzcGxheU5hbWUgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRleHQgPSBfdChcIkNhbmNlbGxpbmfigKZcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25maXJtID0gPFBlbmRpbmdBY3Rpb25TcGlubmVyIHRleHQ9e3RleHR9IC8+O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uZmlybSA9IDxkaXYgY2xhc3NOYW1lPVwibXhfVmVyaWZpY2F0aW9uU2hvd1Nhc19idXR0b25Sb3dcIj5cbiAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvbiBvbkNsaWNrPXt0aGlzLm9uRG9udE1hdGNoQ2xpY2t9IGtpbmQ9XCJkYW5nZXJcIj5cbiAgICAgICAgICAgICAgICAgICAgeyBfdChcIlRoZXkgZG9uJ3QgbWF0Y2hcIikgfVxuICAgICAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj5cbiAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvbiBvbkNsaWNrPXt0aGlzLm9uTWF0Y2hDbGlja30ga2luZD1cInByaW1hcnlcIj5cbiAgICAgICAgICAgICAgICAgICAgeyBfdChcIlRoZXkgbWF0Y2hcIikgfVxuICAgICAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj5cbiAgICAgICAgICAgIDwvZGl2PjtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiA8ZGl2IGNsYXNzTmFtZT1cIm14X1ZlcmlmaWNhdGlvblNob3dTYXNcIj5cbiAgICAgICAgICAgIDxwPnsgc2FzQ2FwdGlvbiB9PC9wPlxuICAgICAgICAgICAgeyBzYXNEaXNwbGF5IH1cbiAgICAgICAgICAgIDxwPnsgdGhpcy5wcm9wcy5pc1NlbGYgP1xuICAgICAgICAgICAgICAgIFwiXCI6XG4gICAgICAgICAgICAgICAgX3QoXCJUbyBiZSBzZWN1cmUsIGRvIHRoaXMgaW4gcGVyc29uIG9yIHVzZSBhIHRydXN0ZWQgd2F5IHRvIGNvbW11bmljYXRlLlwiKSB9PC9wPlxuICAgICAgICAgICAgeyBjb25maXJtIH1cbiAgICAgICAgPC9kaXY+O1xuICAgIH1cbn1cblxuLy8gTGlzdCBvZiBFbW9qaSBzdHJpbmdzIGZyb20gdGhlIGpzLXNkaywgZm9yIGkxOG5cbl90ZChcIkRvZ1wiKTtcbl90ZChcIkNhdFwiKTtcbl90ZChcIkxpb25cIik7XG5fdGQoXCJIb3JzZVwiKTtcbl90ZChcIlVuaWNvcm5cIik7XG5fdGQoXCJQaWdcIik7XG5fdGQoXCJFbGVwaGFudFwiKTtcbl90ZChcIlJhYmJpdFwiKTtcbl90ZChcIlBhbmRhXCIpO1xuX3RkKFwiUm9vc3RlclwiKTtcbl90ZChcIlBlbmd1aW5cIik7XG5fdGQoXCJUdXJ0bGVcIik7XG5fdGQoXCJGaXNoXCIpO1xuX3RkKFwiT2N0b3B1c1wiKTtcbl90ZChcIkJ1dHRlcmZseVwiKTtcbl90ZChcIkZsb3dlclwiKTtcbl90ZChcIlRyZWVcIik7XG5fdGQoXCJDYWN0dXNcIik7XG5fdGQoXCJNdXNocm9vbVwiKTtcbl90ZChcIkdsb2JlXCIpO1xuX3RkKFwiTW9vblwiKTtcbl90ZChcIkNsb3VkXCIpO1xuX3RkKFwiRmlyZVwiKTtcbl90ZChcIkJhbmFuYVwiKTtcbl90ZChcIkFwcGxlXCIpO1xuX3RkKFwiU3RyYXdiZXJyeVwiKTtcbl90ZChcIkNvcm5cIik7XG5fdGQoXCJQaXp6YVwiKTtcbl90ZChcIkNha2VcIik7XG5fdGQoXCJIZWFydFwiKTtcbl90ZChcIlNtaWxleVwiKTtcbl90ZChcIlJvYm90XCIpO1xuX3RkKFwiSGF0XCIpO1xuX3RkKFwiR2xhc3Nlc1wiKTtcbl90ZChcIlNwYW5uZXJcIik7XG5fdGQoXCJTYW50YVwiKTtcbl90ZChcIlRodW1icyB1cFwiKTtcbl90ZChcIlVtYnJlbGxhXCIpO1xuX3RkKFwiSG91cmdsYXNzXCIpO1xuX3RkKFwiQ2xvY2tcIik7XG5fdGQoXCJHaWZ0XCIpO1xuX3RkKFwiTGlnaHQgYnVsYlwiKTtcbl90ZChcIkJvb2tcIik7XG5fdGQoXCJQZW5jaWxcIik7XG5fdGQoXCJQYXBlcmNsaXBcIik7XG5fdGQoXCJTY2lzc29yc1wiKTtcbl90ZChcIkxvY2tcIik7XG5fdGQoXCJLZXlcIik7XG5fdGQoXCJIYW1tZXJcIik7XG5fdGQoXCJUZWxlcGhvbmVcIik7XG5fdGQoXCJGbGFnXCIpO1xuX3RkKFwiVHJhaW5cIik7XG5fdGQoXCJCaWN5Y2xlXCIpO1xuX3RkKFwiQWVyb3BsYW5lXCIpO1xuX3RkKFwiUm9ja2V0XCIpO1xuX3RkKFwiVHJvcGh5XCIpO1xuX3RkKFwiQmFsbFwiKTtcbl90ZChcIkd1aXRhclwiKTtcbl90ZChcIlRydW1wZXRcIik7XG5fdGQoXCJCZWxsXCIpO1xuX3RkKFwiQW5jaG9yXCIpO1xuX3RkKFwiSGVhZHBob25lc1wiKTtcbl90ZChcIkZvbGRlclwiKTtcbl90ZChcIlBpblwiKTtcbiJdfQ==