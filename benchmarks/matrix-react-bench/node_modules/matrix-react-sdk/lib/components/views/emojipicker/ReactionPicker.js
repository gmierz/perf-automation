"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _EmojiPicker = _interopRequireDefault(require("./EmojiPicker"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _actions = require("../../../dispatcher/actions");

var _dec, _class;

let ReactionPicker = (_dec = (0, _replaceableComponent.replaceableComponent)("views.emojipicker.ReactionPicker"), _dec(_class = class ReactionPicker extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onReactionsChange", () => {
      this.setState({
        selectedEmojis: new Set(Object.keys(this.getReactions()))
      });
    });
    (0, _defineProperty2.default)(this, "onChoose", reaction => {
      this.componentWillUnmount();
      this.props.onFinished();
      const myReactions = this.getReactions();

      if (myReactions.hasOwnProperty(reaction)) {
        _MatrixClientPeg.MatrixClientPeg.get().redactEvent(this.props.mxEvent.getRoomId(), myReactions[reaction]);

        _dispatcher.default.fire(_actions.Action.FocusAComposer); // Tell the emoji picker not to bump this in the more frequently used list.


        return false;
      } else {
        _MatrixClientPeg.MatrixClientPeg.get().sendEvent(this.props.mxEvent.getRoomId(), "m.reaction", {
          "m.relates_to": {
            "rel_type": "m.annotation",
            "event_id": this.props.mxEvent.getId(),
            "key": reaction
          }
        });

        _dispatcher.default.dispatch({
          action: "message_sent"
        });

        _dispatcher.default.fire(_actions.Action.FocusAComposer);

        return true;
      }
    });
    this.state = {
      selectedEmojis: new Set(Object.keys(this.getReactions()))
    };
    this.addListeners();
  }

  componentDidUpdate(prevProps) {
    if (prevProps.reactions !== this.props.reactions) {
      this.addListeners();
      this.onReactionsChange();
    }
  }

  addListeners() {
    if (this.props.reactions) {
      this.props.reactions.on("Relations.add", this.onReactionsChange);
      this.props.reactions.on("Relations.remove", this.onReactionsChange);
      this.props.reactions.on("Relations.redaction", this.onReactionsChange);
    }
  }

  componentWillUnmount() {
    if (this.props.reactions) {
      this.props.reactions.removeListener("Relations.add", this.onReactionsChange);
      this.props.reactions.removeListener("Relations.remove", this.onReactionsChange);
      this.props.reactions.removeListener("Relations.redaction", this.onReactionsChange);
    }
  }

  getReactions() {
    if (!this.props.reactions) {
      return {};
    }

    const userId = _MatrixClientPeg.MatrixClientPeg.get().getUserId();

    const myAnnotations = this.props.reactions.getAnnotationsBySender()[userId] || [];
    return Object.fromEntries([...myAnnotations].filter(event => !event.isRedacted()).map(event => [event.getRelation().key, event.getId()]));
  }

  render() {
    return /*#__PURE__*/_react.default.createElement(_EmojiPicker.default, {
      onChoose: this.onChoose,
      selectedEmojis: this.state.selectedEmojis,
      showQuickReactions: true
    });
  }

}) || _class);
var _default = ReactionPicker;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2Vtb2ppcGlja2VyL1JlYWN0aW9uUGlja2VyLnRzeCJdLCJuYW1lcyI6WyJSZWFjdGlvblBpY2tlciIsIlJlYWN0IiwiQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsInNldFN0YXRlIiwic2VsZWN0ZWRFbW9qaXMiLCJTZXQiLCJPYmplY3QiLCJrZXlzIiwiZ2V0UmVhY3Rpb25zIiwicmVhY3Rpb24iLCJjb21wb25lbnRXaWxsVW5tb3VudCIsIm9uRmluaXNoZWQiLCJteVJlYWN0aW9ucyIsImhhc093blByb3BlcnR5IiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0IiwicmVkYWN0RXZlbnQiLCJteEV2ZW50IiwiZ2V0Um9vbUlkIiwiZGlzIiwiZmlyZSIsIkFjdGlvbiIsIkZvY3VzQUNvbXBvc2VyIiwic2VuZEV2ZW50IiwiZ2V0SWQiLCJkaXNwYXRjaCIsImFjdGlvbiIsInN0YXRlIiwiYWRkTGlzdGVuZXJzIiwiY29tcG9uZW50RGlkVXBkYXRlIiwicHJldlByb3BzIiwicmVhY3Rpb25zIiwib25SZWFjdGlvbnNDaGFuZ2UiLCJvbiIsInJlbW92ZUxpc3RlbmVyIiwidXNlcklkIiwiZ2V0VXNlcklkIiwibXlBbm5vdGF0aW9ucyIsImdldEFubm90YXRpb25zQnlTZW5kZXIiLCJmcm9tRW50cmllcyIsImZpbHRlciIsImV2ZW50IiwiaXNSZWRhY3RlZCIsIm1hcCIsImdldFJlbGF0aW9uIiwia2V5IiwicmVuZGVyIiwib25DaG9vc2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBaUJBOztBQUdBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0lBYU1BLGMsV0FETCxnREFBcUIsa0NBQXJCLEMsZ0JBQUQsTUFDTUEsY0FETixTQUM2QkMsZUFBTUMsU0FEbkMsQ0FDNkQ7QUFDekRDLEVBQUFBLFdBQVcsQ0FBQ0MsS0FBRCxFQUFRO0FBQ2YsVUFBTUEsS0FBTjtBQURlLDZEQTJDUyxN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LGlDQUFnQkMsR0FBaEIsR0FBc0JxQixTQUF0QixFQUFmOztBQUNBLFVBQU1DLGFBQWEsR0FBRyxLQUFLbkMsS0FBTCxDQUFXNkIsU0FBWCxDQUFxQk8sc0JBQXJCLEdBQThDSCxNQUE5QyxLQUF5RCxFQUEvRTtBQUNBLFdBQU83QixNQUFNLENBQUNpQyxXQUFQLENBQW1CLENBQUMsR0FBR0YsYUFBSixFQUNyQkcsTUFEcUIsQ0FDZEMsS0FBSyxJQUFJLENBQUNBLEtBQUssQ0FBQ0MsVUFBTixFQURJLEVBRXJCQyxHQUZxQixDQUVqQkYsS0FBSyxJQUFJLENBQUNBLEtBQUssQ0FBQ0csV0FBTixHQUFvQkMsR0FBckIsRUFBMEJKLEtBQUssQ0FBQ2pCLEtBQU4sRUFBMUIsQ0FGUSxDQUFuQixDQUFQO0FBR0g7O0FBa0NEc0IsRUFBQUEsTUFBTSxHQUFHO0FBQ0wsd0JBQU8sNkJBQUMsb0JBQUQ7QUFDSCxNQUFBLFFBQVEsRUFBRSxLQUFLQyxRQURaO0FBRUgsTUFBQSxjQUFjLEVBQUUsS0FBS3BCLEtBQUwsQ0FBV3ZCLGNBRnhCO0FBR0gsTUFBQSxrQkFBa0IsRUFBRTtBQUhqQixNQUFQO0FBS0g7O0FBbEZ3RCxDO2VBcUY5Q04sYyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxOSBUdWxpciBBc29rYW4gPHR1bGlyQG1hdW5pdW0ubmV0PlxuQ29weXJpZ2h0IDIwMjAgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgTWF0cml4RXZlbnQgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL2V2ZW50XCI7XG5cbmltcG9ydCBFbW9qaVBpY2tlciBmcm9tIFwiLi9FbW9qaVBpY2tlclwiO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSBcIi4uLy4uLy4uL01hdHJpeENsaWVudFBlZ1wiO1xuaW1wb3J0IGRpcyBmcm9tIFwiLi4vLi4vLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyXCI7XG5pbXBvcnQgeyByZXBsYWNlYWJsZUNvbXBvbmVudCB9IGZyb20gXCIuLi8uLi8uLi91dGlscy9yZXBsYWNlYWJsZUNvbXBvbmVudFwiO1xuaW1wb3J0IHsgQWN0aW9uIH0gZnJvbSAnLi4vLi4vLi4vZGlzcGF0Y2hlci9hY3Rpb25zJztcblxuaW50ZXJmYWNlIElQcm9wcyB7XG4gICAgbXhFdmVudDogTWF0cml4RXZlbnQ7XG4gICAgcmVhY3Rpb25zOiBhbnk7IC8vIFRPRE8gdHlwZSB0aGlzIG9uY2UganMtc2RrIGlzIG1vcmUgdHlwZXNjcmlwdGVkXG4gICAgb25GaW5pc2hlZCgpOiB2b2lkO1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBzZWxlY3RlZEVtb2ppczogU2V0PHN0cmluZz47XG59XG5cbkByZXBsYWNlYWJsZUNvbXBvbmVudChcInZpZXdzLmVtb2ppcGlja2VyLlJlYWN0aW9uUGlja2VyXCIpXG5jbGFzcyBSZWFjdGlvblBpY2tlciBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxJUHJvcHMsIElTdGF0ZT4ge1xuICAgIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgc2VsZWN0ZWRFbW9qaXM6IG5ldyBTZXQoT2JqZWN0LmtleXModGhpcy5nZXRSZWFjdGlvbnMoKSkpLFxuICAgICAgICB9O1xuICAgICAgICB0aGlzLmFkZExpc3RlbmVycygpO1xuICAgIH1cblxuICAgIGNvbXBvbmVudERpZFVwZGF0ZShwcmV2UHJvcHMpIHtcbiAgICAgICAgaWYgKHByZXZQcm9wcy5yZWFjdGlvbnMgIT09IHRoaXMucHJvcHMucmVhY3Rpb25zKSB7XG4gICAgICAgICAgICB0aGlzLmFkZExpc3RlbmVycygpO1xuICAgICAgICAgICAgdGhpcy5vblJlYWN0aW9uc0NoYW5nZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhZGRMaXN0ZW5lcnMoKSB7XG4gICAgICAgIGlmICh0aGlzLnByb3BzLnJlYWN0aW9ucykge1xuICAgICAgICAgICAgdGhpcy5wcm9wcy5yZWFjdGlvbnMub24oXCJSZWxhdGlvbnMuYWRkXCIsIHRoaXMub25SZWFjdGlvbnNDaGFuZ2UpO1xuICAgICAgICAgICAgdGhpcy5wcm9wcy5yZWFjdGlvbnMub24oXCJSZWxhdGlvbnMucmVtb3ZlXCIsIHRoaXMub25SZWFjdGlvbnNDaGFuZ2UpO1xuICAgICAgICAgICAgdGhpcy5wcm9wcy5yZWFjdGlvbnMub24oXCJSZWxhdGlvbnMucmVkYWN0aW9uXCIsIHRoaXMub25SZWFjdGlvbnNDaGFuZ2UpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgICAgIGlmICh0aGlzLnByb3BzLnJlYWN0aW9ucykge1xuICAgICAgICAgICAgdGhpcy5wcm9wcy5yZWFjdGlvbnMucmVtb3ZlTGlzdGVuZXIoXCJSZWxhdGlvbnMuYWRkXCIsIHRoaXMub25SZWFjdGlvbnNDaGFuZ2UpO1xuICAgICAgICAgICAgdGhpcy5wcm9wcy5yZWFjdGlvbnMucmVtb3ZlTGlzdGVuZXIoXCJSZWxhdGlvbnMucmVtb3ZlXCIsIHRoaXMub25SZWFjdGlvbnNDaGFuZ2UpO1xuICAgICAgICAgICAgdGhpcy5wcm9wcy5yZWFjdGlvbnMucmVtb3ZlTGlzdGVuZXIoXCJSZWxhdGlvbnMucmVkYWN0aW9uXCIsIHRoaXMub25SZWFjdGlvbnNDaGFuZ2UpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRSZWFjdGlvbnMoKSB7XG4gICAgICAgIGlmICghdGhpcy5wcm9wcy5yZWFjdGlvbnMpIHtcbiAgICAgICAgICAgIHJldHVybiB7fTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB1c2VySWQgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZ2V0VXNlcklkKCk7XG4gICAgICAgIGNvbnN0IG15QW5ub3RhdGlvbnMgPSB0aGlzLnByb3BzLnJlYWN0aW9ucy5nZXRBbm5vdGF0aW9uc0J5U2VuZGVyKClbdXNlcklkXSB8fCBbXTtcbiAgICAgICAgcmV0dXJuIE9iamVjdC5mcm9tRW50cmllcyhbLi4ubXlBbm5vdGF0aW9uc11cbiAgICAgICAgICAgIC5maWx0ZXIoZXZlbnQgPT4gIWV2ZW50LmlzUmVkYWN0ZWQoKSlcbiAgICAgICAgICAgIC5tYXAoZXZlbnQgPT4gW2V2ZW50LmdldFJlbGF0aW9uKCkua2V5LCBldmVudC5nZXRJZCgpXSkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25SZWFjdGlvbnNDaGFuZ2UgPSAoKSA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgc2VsZWN0ZWRFbW9qaXM6IG5ldyBTZXQoT2JqZWN0LmtleXModGhpcy5nZXRSZWFjdGlvbnMoKSkpLFxuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgb25DaG9vc2UgPSAocmVhY3Rpb246IHN0cmluZykgPT4ge1xuICAgICAgICB0aGlzLmNvbXBvbmVudFdpbGxVbm1vdW50KCk7XG4gICAgICAgIHRoaXMucHJvcHMub25GaW5pc2hlZCgpO1xuICAgICAgICBjb25zdCBteVJlYWN0aW9ucyA9IHRoaXMuZ2V0UmVhY3Rpb25zKCk7XG4gICAgICAgIGlmIChteVJlYWN0aW9ucy5oYXNPd25Qcm9wZXJ0eShyZWFjdGlvbikpIHtcbiAgICAgICAgICAgIE1hdHJpeENsaWVudFBlZy5nZXQoKS5yZWRhY3RFdmVudChcbiAgICAgICAgICAgICAgICB0aGlzLnByb3BzLm14RXZlbnQuZ2V0Um9vbUlkKCksXG4gICAgICAgICAgICAgICAgbXlSZWFjdGlvbnNbcmVhY3Rpb25dLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGRpcy5maXJlKEFjdGlvbi5Gb2N1c0FDb21wb3Nlcik7XG4gICAgICAgICAgICAvLyBUZWxsIHRoZSBlbW9qaSBwaWNrZXIgbm90IHRvIGJ1bXAgdGhpcyBpbiB0aGUgbW9yZSBmcmVxdWVudGx5IHVzZWQgbGlzdC5cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIE1hdHJpeENsaWVudFBlZy5nZXQoKS5zZW5kRXZlbnQodGhpcy5wcm9wcy5teEV2ZW50LmdldFJvb21JZCgpLCBcIm0ucmVhY3Rpb25cIiwge1xuICAgICAgICAgICAgICAgIFwibS5yZWxhdGVzX3RvXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgXCJyZWxfdHlwZVwiOiBcIm0uYW5ub3RhdGlvblwiLFxuICAgICAgICAgICAgICAgICAgICBcImV2ZW50X2lkXCI6IHRoaXMucHJvcHMubXhFdmVudC5nZXRJZCgpLFxuICAgICAgICAgICAgICAgICAgICBcImtleVwiOiByZWFjdGlvbixcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBkaXMuZGlzcGF0Y2goeyBhY3Rpb246IFwibWVzc2FnZV9zZW50XCIgfSk7XG4gICAgICAgICAgICBkaXMuZmlyZShBY3Rpb24uRm9jdXNBQ29tcG9zZXIpO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcmVuZGVyKCkge1xuICAgICAgICByZXR1cm4gPEVtb2ppUGlja2VyXG4gICAgICAgICAgICBvbkNob29zZT17dGhpcy5vbkNob29zZX1cbiAgICAgICAgICAgIHNlbGVjdGVkRW1vamlzPXt0aGlzLnN0YXRlLnNlbGVjdGVkRW1vamlzfVxuICAgICAgICAgICAgc2hvd1F1aWNrUmVhY3Rpb25zPXt0cnVlfVxuICAgICAgICAvPjtcbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFJlYWN0aW9uUGlja2VyO1xuIl19