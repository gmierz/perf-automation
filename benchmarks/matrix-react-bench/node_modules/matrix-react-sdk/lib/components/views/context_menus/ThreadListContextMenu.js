"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _react = _interopRequireWildcard(require("react"));

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var _actions = require("../../../dispatcher/actions");

var _strings = require("../../../utils/strings");

var _ContextMenu = require("../../structures/ContextMenu");

var _languageHandler = require("../../../languageHandler");

var _IconizedContextMenu = _interopRequireWildcard(require("./IconizedContextMenu"));

var _WidgetLayoutStore = require("../../../stores/widgets/WidgetLayoutStore");

var _MatrixClientPeg = require("../../../MatrixClientPeg");

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/*
Copyright 2021 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const contextMenuBelow = elementRect => {
  // align the context menu's icons with the icon which opened the context menu
  const left = elementRect.left + window.pageXOffset + elementRect.width;
  const top = elementRect.bottom + window.pageYOffset;
  const chevronFace = _ContextMenu.ChevronFace.None;
  return {
    left,
    top,
    chevronFace
  };
};

const ThreadListContextMenu = ({
  mxEvent,
  permalinkCreator,
  onMenuToggle
}) => {
  const [optionsPosition, setOptionsPosition] = (0, _react.useState)(null);
  const closeThreadOptions = (0, _react.useCallback)(() => {
    setOptionsPosition(null);
  }, []);
  const viewInRoom = (0, _react.useCallback)(evt => {
    evt.preventDefault();
    evt.stopPropagation();

    _dispatcher.default.dispatch({
      action: _actions.Action.ViewRoom,
      event_id: mxEvent.getId(),
      highlighted: true,
      room_id: mxEvent.getRoomId()
    });

    closeThreadOptions();
  }, [mxEvent, closeThreadOptions]);
  const copyLinkToThread = (0, _react.useCallback)(async evt => {
    evt.preventDefault();
    evt.stopPropagation();
    const matrixToUrl = permalinkCreator.forEvent(mxEvent.getId());
    await (0, _strings.copyPlaintext)(matrixToUrl);
    closeThreadOptions();
  }, [mxEvent, closeThreadOptions, permalinkCreator]);
  const toggleOptionsMenu = (0, _react.useCallback)(ev => {
    if (!!optionsPosition) {
      closeThreadOptions();
    } else {
      const position = ev.currentTarget.getBoundingClientRect();
      setOptionsPosition(position);
    }
  }, [closeThreadOptions, optionsPosition]);
  (0, _react.useEffect)(() => {
    if (onMenuToggle) {
      onMenuToggle(!!optionsPosition);
    }
  }, [optionsPosition, onMenuToggle]);
  const isMainSplitTimelineShown = !_WidgetLayoutStore.WidgetLayoutStore.instance.hasMaximisedWidget(_MatrixClientPeg.MatrixClientPeg.get().getRoom(mxEvent.getRoomId()));
  return /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement(_ContextMenu.ContextMenuTooltipButton, {
    className: "mx_MessageActionBar_maskButton mx_MessageActionBar_optionsButton",
    onClick: toggleOptionsMenu,
    title: (0, _languageHandler._t)("Thread options"),
    isExpanded: !!optionsPosition
  }), !!optionsPosition && /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.default, (0, _extends2.default)({
    onFinished: closeThreadOptions,
    className: "mx_RoomTile_contextMenu",
    compact: true,
    rightAligned: true
  }, contextMenuBelow(optionsPosition)), /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOptionList, null, isMainSplitTimelineShown && /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOption, {
    onClick: e => viewInRoom(e),
    label: (0, _languageHandler._t)("View in room"),
    iconClassName: "mx_ThreadPanel_viewInRoom"
  }), /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOption, {
    onClick: e => copyLinkToThread(e),
    label: (0, _languageHandler._t)("Copy link to thread"),
    iconClassName: "mx_ThreadPanel_copyLinkToThread"
  }))));
};

var _default = ThreadListContextMenu;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2NvbnRleHRfbWVudXMvVGhyZWFkTGlzdENvbnRleHRNZW51LnRzeCJdLCJuYW1lcyI6WyJjb250ZXh0TWVudUJlbG93IiwiZWxlbWVudFJlY3QiLCJsZWZ0Iiwid2luZG93IiwicGFnZVhPZmZzZXQiLCJ3aWR0aCIsInRvcCIsImJvdHRvbSIsInBhZ2VZT2Zmc2V0IiwiY2hldnJvbkZhY2UiLCJDaGV2cm9uRmFjZSIsIk5vbmUiLCJUaHJlYWRMaXN0Q29udGV4dE1lbnUiLCJteEV2ZW50IiwicGVybWFsaW5rQ3JlYXRvciIsIm9uTWVudVRvZ2dsZSIsIm9wdGlvbnNQb3NpdGlvbiIsInNldE9wdGlvbnNQb3NpdGlvbiIsImNsb3NlVGhyZWFkT3B0aW9ucyIsInZpZXdJblJvb20iLCJldnQiLCJwcmV2ZW50RGVmYXVsdCIsInN0b3BQcm9wYWdhdGlvbiIsImRpcyIsImRpc3BhdGNoIiwiYWN0aW9uIiwiQWN0aW9uIiwiVmlld1Jvb20iLCJldmVudF9pZCIsImdldElkIiwiaGlnaGxpZ2h0ZWQiLCJyb29tX2lkIiwiZ2V0Um9vbUlkIiwiY29weUxpbmtUb1RocmVhZCIsIm1hdHJpeFRvVXJsIiwiZm9yRXZlbnQiLCJ0b2dnbGVPcHRpb25zTWVudSIsImV2IiwicG9zaXRpb24iLCJjdXJyZW50VGFyZ2V0IiwiZ2V0Qm91bmRpbmdDbGllbnRSZWN0IiwiaXNNYWluU3BsaXRUaW1lbGluZVNob3duIiwiV2lkZ2V0TGF5b3V0U3RvcmUiLCJpbnN0YW5jZSIsImhhc01heGltaXNlZFdpZGdldCIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsImdldFJvb20iLCJlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWdCQTs7QUFHQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7O0FBM0JBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FB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QyxxQ0FBRDtBQUNJLElBQUEsU0FBUyxFQUFDLGtFQURkO0FBRUksSUFBQSxPQUFPLEVBQUVJLGlCQUZiO0FBR0ksSUFBQSxLQUFLLEVBQUUseUJBQUcsZ0JBQUgsQ0FIWDtBQUlJLElBQUEsVUFBVSxFQUFFLENBQUMsQ0FBQ3BCO0FBSmxCLElBREcsRUFPRCxDQUFDLENBQUNBLGVBQUYsaUJBQXNCLDZCQUFDLDRCQUFEO0FBQ3BCLElBQUEsVUFBVSxFQUFFRSxrQkFEUTtBQUVwQixJQUFBLFNBQVMsRUFBQyx5QkFGVTtBQUdwQixJQUFBLE9BQU8sTUFIYTtBQUlwQixJQUFBLFlBQVk7QUFKUSxLQUtoQmxCLGdCQUFnQixDQUFDZ0IsZUFBRCxDQUxBLGdCQU9wQiw2QkFBQyxrREFBRCxRQUNNeUIsd0JBQXdCLGlCQUN6Qiw2QkFBQyw4Q0FBRDtBQUNJLElBQUEsT0FBTyxFQUFHTyxDQUFELElBQU83QixVQUFVLENBQUM2QixDQUFELENBRDlCO0FBRUksSUFBQSxLQUFLLEVBQUUseUJBQUcsY0FBSCxDQUZYO0FBR0ksSUFBQSxhQUFhLEVBQUM7QUFIbEIsSUFGTCxlQU9JLDZCQUFDLDhDQUFEO0FBQ0ksSUFBQSxPQUFPLEVBQUdBLENBQUQsSUFBT2YsZ0JBQWdCLENBQUNlLENBQUQsQ0FEcEM7QUFFSSxJQUFBLEtBQUssRUFBRSx5QkFBRyxxQkFBSCxDQUZYO0FBR0ksSUFBQSxhQUFhLEVBQUM7QUFIbEIsSUFQSixDQVBvQixDQVByQixDQUFQO0FBNkJILENBekVEOztlQTJFZXBDLHFCIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDIxIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0LCB7IHVzZUNhbGxiYWNrLCB1c2VFZmZlY3QsIHVzZVN0YXRlIH0gZnJvbSBcInJlYWN0XCI7XG5pbXBvcnQgeyBNYXRyaXhFdmVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyY1wiO1xuaW1wb3J0IHsgQnV0dG9uRXZlbnQgfSBmcm9tIFwiLi4vZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvblwiO1xuaW1wb3J0IGRpcyBmcm9tICcuLi8uLi8uLi9kaXNwYXRjaGVyL2Rpc3BhdGNoZXInO1xuaW1wb3J0IHsgQWN0aW9uIH0gZnJvbSBcIi4uLy4uLy4uL2Rpc3BhdGNoZXIvYWN0aW9uc1wiO1xuaW1wb3J0IHsgUm9vbVBlcm1hbGlua0NyZWF0b3IgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvcGVybWFsaW5rcy9QZXJtYWxpbmtzXCI7XG5pbXBvcnQgeyBjb3B5UGxhaW50ZXh0IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3N0cmluZ3NcIjtcbmltcG9ydCB7IENoZXZyb25GYWNlLCBDb250ZXh0TWVudVRvb2x0aXBCdXR0b24gfSBmcm9tIFwiLi4vLi4vc3RydWN0dXJlcy9Db250ZXh0TWVudVwiO1xuaW1wb3J0IHsgX3QgfSBmcm9tIFwiLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyXCI7XG5pbXBvcnQgSWNvbml6ZWRDb250ZXh0TWVudSwgeyBJY29uaXplZENvbnRleHRNZW51T3B0aW9uLCBJY29uaXplZENvbnRleHRNZW51T3B0aW9uTGlzdCB9IGZyb20gXCIuL0ljb25pemVkQ29udGV4dE1lbnVcIjtcbmltcG9ydCB7IFdpZGdldExheW91dFN0b3JlIH0gZnJvbSBcIi4uLy4uLy4uL3N0b3Jlcy93aWRnZXRzL1dpZGdldExheW91dFN0b3JlXCI7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tIFwiLi4vLi4vLi4vTWF0cml4Q2xpZW50UGVnXCI7XG5cbmludGVyZmFjZSBJUHJvcHMge1xuICAgIG14RXZlbnQ6IE1hdHJpeEV2ZW50O1xuICAgIHBlcm1hbGlua0NyZWF0b3I6IFJvb21QZXJtYWxpbmtDcmVhdG9yO1xuICAgIG9uTWVudVRvZ2dsZT86IChvcGVuOiBib29sZWFuKSA9PiB2b2lkO1xufVxuXG5jb25zdCBjb250ZXh0TWVudUJlbG93ID0gKGVsZW1lbnRSZWN0OiBET01SZWN0KSA9PiB7XG4gICAgLy8gYWxpZ24gdGhlIGNvbnRleHQgbWVudSdzIGljb25zIHdpdGggdGhlIGljb24gd2hpY2ggb3BlbmVkIHRoZSBjb250ZXh0IG1lbnVcbiAgICBjb25zdCBsZWZ0ID0gZWxlbWVudFJlY3QubGVmdCArIHdpbmRvdy5wYWdlWE9mZnNldCArIGVsZW1lbnRSZWN0LndpZHRoO1xuICAgIGNvbnN0IHRvcCA9IGVsZW1lbnRSZWN0LmJvdHRvbSArIHdpbmRvdy5wYWdlWU9mZnNldDtcbiAgICBjb25zdCBjaGV2cm9uRmFjZSA9IENoZXZyb25GYWNlLk5vbmU7XG4gICAgcmV0dXJuIHsgbGVmdCwgdG9wLCBjaGV2cm9uRmFjZSB9O1xufTtcblxuY29uc3QgVGhyZWFkTGlzdENvbnRleHRNZW51OiBSZWFjdC5GQzxJUHJvcHM+ID0gKHsgbXhFdmVudCwgcGVybWFsaW5rQ3JlYXRvciwgb25NZW51VG9nZ2xlIH0pID0+IHtcbiAgICBjb25zdCBbb3B0aW9uc1Bvc2l0aW9uLCBzZXRPcHRpb25zUG9zaXRpb25dID0gdXNlU3RhdGUobnVsbCk7XG4gICAgY29uc3QgY2xvc2VUaHJlYWRPcHRpb25zID0gdXNlQ2FsbGJhY2soKCkgPT4ge1xuICAgICAgICBzZXRPcHRpb25zUG9zaXRpb24obnVsbCk7XG4gICAgfSwgW10pO1xuXG4gICAgY29uc3Qgdmlld0luUm9vbSA9IHVzZUNhbGxiYWNrKChldnQ6IEJ1dHRvbkV2ZW50KTogdm9pZCA9PiB7XG4gICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIGRpcy5kaXNwYXRjaCh7XG4gICAgICAgICAgICBhY3Rpb246IEFjdGlvbi5WaWV3Um9vbSxcbiAgICAgICAgICAgIGV2ZW50X2lkOiBteEV2ZW50LmdldElkKCksXG4gICAgICAgICAgICBoaWdobGlnaHRlZDogdHJ1ZSxcbiAgICAgICAgICAgIHJvb21faWQ6IG14RXZlbnQuZ2V0Um9vbUlkKCksXG4gICAgICAgIH0pO1xuICAgICAgICBjbG9zZVRocmVhZE9wdGlvbnMoKTtcbiAgICB9LCBbbXhFdmVudCwgY2xvc2VUaHJlYWRPcHRpb25zXSk7XG5cbiAgICBjb25zdCBjb3B5TGlua1RvVGhyZWFkID0gdXNlQ2FsbGJhY2soYXN5bmMgKGV2dDogQnV0dG9uRXZlbnQpID0+IHtcbiAgICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIGV2dC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgY29uc3QgbWF0cml4VG9VcmwgPSBwZXJtYWxpbmtDcmVhdG9yLmZvckV2ZW50KG14RXZlbnQuZ2V0SWQoKSk7XG4gICAgICAgIGF3YWl0IGNvcHlQbGFpbnRleHQobWF0cml4VG9VcmwpO1xuICAgICAgICBjbG9zZVRocmVhZE9wdGlvbnMoKTtcbiAgICB9LCBbbXhFdmVudCwgY2xvc2VUaHJlYWRPcHRpb25zLCBwZXJtYWxpbmtDcmVhdG9yXSk7XG5cbiAgICBjb25zdCB0b2dnbGVPcHRpb25zTWVudSA9IHVzZUNhbGxiYWNrKChldjogQnV0dG9uRXZlbnQpOiB2b2lkID0+IHtcbiAgICAgICAgaWYgKCEhb3B0aW9uc1Bvc2l0aW9uKSB7XG4gICAgICAgICAgICBjbG9zZVRocmVhZE9wdGlvbnMoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9uID0gZXYuY3VycmVudFRhcmdldC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICAgICAgICAgIHNldE9wdGlvbnNQb3NpdGlvbihwb3NpdGlvbik7XG4gICAgICAgIH1cbiAgICB9LCBbY2xvc2VUaHJlYWRPcHRpb25zLCBvcHRpb25zUG9zaXRpb25dKTtcblxuICAgIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgICAgIGlmIChvbk1lbnVUb2dnbGUpIHtcbiAgICAgICAgICAgIG9uTWVudVRvZ2dsZSghIW9wdGlvbnNQb3NpdGlvbik7XG4gICAgICAgIH1cbiAgICB9LCBbb3B0aW9uc1Bvc2l0aW9uLCBvbk1lbnVUb2dnbGVdKTtcblxuICAgIGNvbnN0IGlzTWFpblNwbGl0VGltZWxpbmVTaG93biA9ICFXaWRnZXRMYXlvdXRTdG9yZS5pbnN0YW5jZS5oYXNNYXhpbWlzZWRXaWRnZXQoXG4gICAgICAgIE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRSb29tKG14RXZlbnQuZ2V0Um9vbUlkKCkpLFxuICAgICk7XG4gICAgcmV0dXJuIDxSZWFjdC5GcmFnbWVudD5cbiAgICAgICAgPENvbnRleHRNZW51VG9vbHRpcEJ1dHRvblxuICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfTWVzc2FnZUFjdGlvbkJhcl9tYXNrQnV0dG9uIG14X01lc3NhZ2VBY3Rpb25CYXJfb3B0aW9uc0J1dHRvblwiXG4gICAgICAgICAgICBvbkNsaWNrPXt0b2dnbGVPcHRpb25zTWVudX1cbiAgICAgICAgICAgIHRpdGxlPXtfdChcIlRocmVhZCBvcHRpb25zXCIpfVxuICAgICAgICAgICAgaXNFeHBhbmRlZD17ISFvcHRpb25zUG9zaXRpb259XG4gICAgICAgIC8+XG4gICAgICAgIHsgISFvcHRpb25zUG9zaXRpb24gJiYgKDxJY29uaXplZENvbnRleHRNZW51XG4gICAgICAgICAgICBvbkZpbmlzaGVkPXtjbG9zZVRocmVhZE9wdGlvbnN9XG4gICAgICAgICAgICBjbGFzc05hbWU9XCJteF9Sb29tVGlsZV9jb250ZXh0TWVudVwiXG4gICAgICAgICAgICBjb21wYWN0XG4gICAgICAgICAgICByaWdodEFsaWduZWRcbiAgICAgICAgICAgIHsuLi5jb250ZXh0TWVudUJlbG93KG9wdGlvbnNQb3NpdGlvbil9XG4gICAgICAgID5cbiAgICAgICAgICAgIDxJY29uaXplZENvbnRleHRNZW51T3B0aW9uTGlzdD5cbiAgICAgICAgICAgICAgICB7IGlzTWFpblNwbGl0VGltZWxpbmVTaG93biAmJlxuICAgICAgICAgICAgICAgICA8SWNvbml6ZWRDb250ZXh0TWVudU9wdGlvblxuICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17KGUpID0+IHZpZXdJblJvb20oZSl9XG4gICAgICAgICAgICAgICAgICAgICBsYWJlbD17X3QoXCJWaWV3IGluIHJvb21cIil9XG4gICAgICAgICAgICAgICAgICAgICBpY29uQ2xhc3NOYW1lPVwibXhfVGhyZWFkUGFuZWxfdmlld0luUm9vbVwiXG4gICAgICAgICAgICAgICAgIC8+IH1cbiAgICAgICAgICAgICAgICA8SWNvbml6ZWRDb250ZXh0TWVudU9wdGlvblxuICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXsoZSkgPT4gY29weUxpbmtUb1RocmVhZChlKX1cbiAgICAgICAgICAgICAgICAgICAgbGFiZWw9e190KFwiQ29weSBsaW5rIHRvIHRocmVhZFwiKX1cbiAgICAgICAgICAgICAgICAgICAgaWNvbkNsYXNzTmFtZT1cIm14X1RocmVhZFBhbmVsX2NvcHlMaW5rVG9UaHJlYWRcIlxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICA8L0ljb25pemVkQ29udGV4dE1lbnVPcHRpb25MaXN0PlxuICAgICAgICA8L0ljb25pemVkQ29udGV4dE1lbnU+KSB9XG4gICAgPC9SZWFjdC5GcmFnbWVudD47XG59O1xuXG5leHBvcnQgZGVmYXVsdCBUaHJlYWRMaXN0Q29udGV4dE1lbnU7XG4iXX0=