"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _react = _interopRequireWildcard(require("react"));

var _matrixWidgetApi = require("matrix-widget-api");

var _IconizedContextMenu = _interopRequireWildcard(require("./IconizedContextMenu"));

var _ContextMenu = require("../../structures/ContextMenu");

var _languageHandler = require("../../../languageHandler");

var _WidgetUtils = _interopRequireDefault(require("../../../utils/WidgetUtils"));

var _WidgetMessagingStore = require("../../../stores/widgets/WidgetMessagingStore");

var _RoomContext = _interopRequireDefault(require("../../../contexts/RoomContext"));

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var _SettingsStore = _interopRequireDefault(require("../../../settings/SettingsStore"));

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _QuestionDialog = _interopRequireDefault(require("../dialogs/QuestionDialog"));

var _ErrorDialog = _interopRequireDefault(require("../dialogs/ErrorDialog"));

var _WidgetType = require("../../../widgets/WidgetType");

var _MatrixClientContext = _interopRequireDefault(require("../../../contexts/MatrixClientContext"));

var _WidgetLayoutStore = require("../../../stores/widgets/WidgetLayoutStore");

var _Livestream = require("../../../Livestream");

var _logger = require("matrix-js-sdk/src/logger");

const _excluded = ["onFinished", "app", "userWidget", "onDeleteClick", "onEditClick", "showUnpin"];

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

const WidgetContextMenu = _ref => {
  let {
    onFinished,
    app,
    userWidget,
    onDeleteClick,
    onEditClick,
    showUnpin
  } = _ref,
      props = (0, _objectWithoutProperties2.default)(_ref, _excluded);
  const cli = (0, _react.useContext)(_MatrixClientContext.default);
  const {
    room,
    roomId
  } = (0, _react.useContext)(_RoomContext.default);

  const widgetMessaging = _WidgetMessagingStore.WidgetMessagingStore.instance.getMessagingForId(app.id);

  const canModify = userWidget || _WidgetUtils.default.canUserModifyWidgets(roomId);

  let streamAudioStreamButton;

  if ((0, _Livestream.getConfigLivestreamUrl)() && _WidgetType.WidgetType.JITSI.matches(app.type)) {
    const onStreamAudioClick = async () => {
      try {
        await (0, _Livestream.startJitsiAudioLivestream)(widgetMessaging, roomId);
      } catch (err) {
        _logger.logger.error("Failed to start livestream", err); // XXX: won't i18n well, but looks like widget api only support 'message'?


        const message = err.message || (0, _languageHandler._t)("Unable to start audio streaming.");

        _Modal.default.createTrackedDialog('WidgetContext Menu', 'Livestream failed', _ErrorDialog.default, {
          title: (0, _languageHandler._t)('Failed to start livestream'),
          description: message
        });
      }

      onFinished();
    };

    streamAudioStreamButton = /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOption, {
      onClick: onStreamAudioClick,
      label: (0, _languageHandler._t)("Start audio stream")
    });
  }

  let unpinButton;

  if (showUnpin) {
    const onUnpinClick = () => {
      _WidgetLayoutStore.WidgetLayoutStore.instance.moveToContainer(room, app, _WidgetLayoutStore.Container.Right);

      onFinished();
    };

    unpinButton = /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOption, {
      onClick: onUnpinClick,
      label: (0, _languageHandler._t)("Unpin")
    });
  }

  let editButton;

  if (canModify && _WidgetUtils.default.isManagedByManager(app)) {
    const _onEditClick = () => {
      if (onEditClick) {
        onEditClick();
      } else {
        _WidgetUtils.default.editWidget(room, app);
      }

      onFinished();
    };

    editButton = /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOption, {
      onClick: _onEditClick,
      label: (0, _languageHandler._t)("Edit")
    });
  }

  let snapshotButton;

  if (widgetMessaging !== null && widgetMessaging !== void 0 && widgetMessaging.hasCapability(_matrixWidgetApi.MatrixCapabilities.Screenshots)) {
    const onSnapshotClick = () => {
      widgetMessaging === null || widgetMessaging === void 0 ? void 0 : widgetMessaging.takeScreenshot().then(data => {
        _dispatcher.default.dispatch({
          action: 'picture_snapshot',
          file: data.screenshot
        });
      }).catch(err => {
        _logger.logger.error("Failed to take screenshot: ", err);
      });
      onFinished();
    };

    snapshotButton = /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOption, {
      onClick: onSnapshotClick,
      label: (0, _languageHandler._t)("Take a picture")
    });
  }

  let deleteButton;

  if (onDeleteClick || canModify) {
    const _onDeleteClick = () => {
      if (onDeleteClick) {
        onDeleteClick();
      } else {
        // Show delete confirmation dialog
        _Modal.default.createTrackedDialog('Delete Widget', '', _QuestionDialog.default, {
          title: (0, _languageHandler._t)("Delete Widget"),
          description: (0, _languageHandler._t)("Deleting a widget removes it for all users in this room." + " Are you sure you want to delete this widget?"),
          button: (0, _languageHandler._t)("Delete widget"),
          onFinished: confirmed => {
            if (!confirmed) return;

            _WidgetUtils.default.setRoomWidget(roomId, app.id);
          }
        });
      }

      onFinished();
    };

    deleteButton = /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOption, {
      onClick: _onDeleteClick,
      label: userWidget ? (0, _languageHandler._t)("Remove") : (0, _languageHandler._t)("Remove for everyone")
    });
  }

  let isAllowedWidget = _SettingsStore.default.getValue("allowedWidgets", roomId)[app.eventId];

  if (isAllowedWidget === undefined) {
    isAllowedWidget = app.creatorUserId === cli.getUserId();
  }

  const isLocalWidget = _WidgetType.WidgetType.JITSI.matches(app.type);

  let revokeButton;

  if (!userWidget && !isLocalWidget && isAllowedWidget) {
    const onRevokeClick = () => {
      _logger.logger.info("Revoking permission for widget to load: " + app.eventId);

      const current = _SettingsStore.default.getValue("allowedWidgets", roomId);

      current[app.eventId] = false;

      const level = _SettingsStore.default.firstSupportedLevel("allowedWidgets");

      _SettingsStore.default.setValue("allowedWidgets", roomId, level, current).catch(err => {
        _logger.logger.error(err); // We don't really need to do anything about this - the user will just hit the button again.

      });

      onFinished();
    };

    revokeButton = /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOption, {
      onClick: onRevokeClick,
      label: (0, _languageHandler._t)("Revoke permissions")
    });
  }

  const pinnedWidgets = _WidgetLayoutStore.WidgetLayoutStore.instance.getContainerWidgets(room, _WidgetLayoutStore.Container.Top);

  const widgetIndex = pinnedWidgets.findIndex(widget => widget.id === app.id);
  let moveLeftButton;

  if (showUnpin && widgetIndex > 0) {
    const onClick = () => {
      _WidgetLayoutStore.WidgetLayoutStore.instance.moveWithinContainer(room, _WidgetLayoutStore.Container.Top, app, -1);

      onFinished();
    };

    moveLeftButton = /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOption, {
      onClick: onClick,
      label: (0, _languageHandler._t)("Move left")
    });
  }

  let moveRightButton;

  if (showUnpin && widgetIndex < pinnedWidgets.length - 1) {
    const onClick = () => {
      _WidgetLayoutStore.WidgetLayoutStore.instance.moveWithinContainer(room, _WidgetLayoutStore.Container.Top, app, 1);

      onFinished();
    };

    moveRightButton = /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOption, {
      onClick: onClick,
      label: (0, _languageHandler._t)("Move right")
    });
  }

  return /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.default, (0, _extends2.default)({}, props, {
    chevronFace: _ContextMenu.ChevronFace.None,
    onFinished: onFinished
  }), /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOptionList, null, streamAudioStreamButton, editButton, revokeButton, deleteButton, snapshotButton, moveLeftButton, moveRightButton, unpinButton));
};

var _default = WidgetContextMenu;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2NvbnRleHRfbWVudXMvV2lkZ2V0Q29udGV4dE1lbnUudHN4Il0sIm5hbWVzIjpbIldpZGdldENvbnRleHRNZW51Iiwib25GaW5pc2hlZCIsImFwcCIsInVzZXJXaWRnZXQiLCJvbkRlbGV0ZUNsaWNrIiwib25FZGl0Q2xpY2siLCJzaG93VW5waW4iLCJwcm9wcyIsImNsaSIsIk1hdHJpeENsaWVudENvbnRleHQiLCJyb29tIiwicm9vbUlkIiwiUm9vbUNvbnRleHQiLCJ3aWRnZXRNZXNzYWdpbmciLCJXaWRnZXRNZXNzYWdpbmdTdG9yZSIsImluc3RhbmNlIiwiZ2V0TWVzc2FnaW5nRm9ySWQiLCJpZCIsImNhbk1vZGlmeSIsIldpZGdldFV0aWxzIiwiY2FuVXNlck1vZGlmeVdpZGdldHMiLCJzdHJlYW1BdWRpb1N0cmVhbUJ1dHRvbiIsIldpZGdldFR5cGUiLCJKSVRTSSIsIm1hdGNoZXMiLCJ0eXBlIiwib25TdHJlYW1BdWRpb0NsaWNrIiwiZXJyIiwibG9nZ2VyIiwiZXJyb3IiLCJtZXNzYWdlIiwiTW9kYWwiLCJjcmVhdGVUcmFja2VkRGlhbG9nIiwiRXJyb3JEaWFsb2ciLCJ0aXRsZSIsImRlc2NyaXB0aW9uIiwidW5waW5CdXR0b24iLCJvblVucGluQ2xpY2siLCJXaWRnZXRMYXlvdXRTdG9yZSIsIm1vdmVUb0NvbnRhaW5lciIsIkNvbnRhaW5lciIsIlJpZ2h0IiwiZWRpdEJ1dHRvbiIsImlzTWFuYWdlZEJ5TWFuYWdlciIsIl9vbkVkaXRDbGljayIsImVkaXRXaWRnZXQiLCJzbmFwc2hvdEJ1dHRvbiIsImhhc0NhcGFiaWxpdHkiLCJNYXRyaXhDYXBhYmlsaXRpZXMiLCJTY3JlZW5zaG90cyIsIm9uU25hcHNob3RDbGljayIsInRha2VTY3JlZW5zaG90IiwidGhlbiIsImRhdGEiLCJkaXMiLCJkaXNwYXRjaCIsImFjdGlvbiIsImZpbGUiLCJzY3JlZW5zaG90IiwiY2F0Y2giLCJkZWxldGVCdXR0b24iLCJfb25EZWxldGVDbGljayIsIlF1ZXN0aW9uRGlhbG9nIiwiYnV0dG9uIiwiY29uZmlybWVkIiwic2V0Um9vbVdpZGdldCIsImlzQWxsb3dlZFdpZGdldCIsIlNldHRpbmdzU3RvcmUiLCJnZXRWYWx1ZSIsImV2ZW50SWQiLCJ1bmRlZmluZWQiLCJjcmVhdG9yVXNlcklkIiwiZ2V0VXNlcklkIiwiaXNMb2NhbFdpZGdldCIsInJldm9rZUJ1dHRvbiIsIm9uUmV2b2tlQ2xpY2siLCJpbmZvIiwiY3VycmVudCIsImxldmVsIiwiZmlyc3RTdXBwb3J0ZWRMZXZlbCIsInNldFZhbHVlIiwicGlubmVkV2lkZ2V0cyIsImdldENvbnRhaW5lcldpZGdldHMiLCJUb3AiLCJ3aWRnZXRJbmRleCIsImZpbmRJbmRleCIsIndpZGdldCIsIm1vdmVMZWZ0QnV0dG9uIiwib25DbGljayIsIm1vdmVXaXRoaW5Db250YWluZXIiLCJtb3ZlUmlnaHRCdXR0b24iLCJsZW5ndGgiLCJDaGV2cm9uRmFjZSIsIk5vbmUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFnQkE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7Ozs7Ozs7O0FBWUEsTUFBTUEsaUJBQW1DLEdBQUcsUUFRdEM7QUFBQSxNQVJ1QztBQUN6Q0MsSUFBQUEsVUFEeUM7QUFFekNDLElBQUFBLEdBRnlDO0FBR3pDQyxJQUFBQSxVQUh5QztBQUl6Q0MsSUFBQUEsYUFKeUM7QUFLekNDLElBQUFBLFdBTHlDO0FBTXpDQyxJQUFBQTtBQU55QyxHQVF2QztBQUFBLE1BRENDLEtBQ0Q7QUFDRixRQUFNQyxHQUFHLEdBQUcsdUJBQVdDLDRCQUFYLENBQVo7QUFDQSxRQUFNO0FBQUVDLElBQUFBLElBQUY7QUFBUUMsSUFBQUE7QUFBUixNQUFtQix1QkFBV0Msb0JBQVgsQ0FBekI7O0FBRUEsUUFBTUMsZUFBZSxH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QUFZQyxJQUF6RDtBQUErRCxJQUFBLFVBQVUsRUFBRTVGO0FBQTNFLG1CQUNILDZCQUFDLGtEQUFELFFBQ01vQix1QkFETixFQUVNcUIsVUFGTixFQUdNZ0MsWUFITixFQUlNZCxZQUpOLEVBS01kLGNBTE4sRUFNTXlDLGNBTk4sRUFPTUcsZUFQTixFQVFNdEQsV0FSTixDQURHLENBQVA7QUFZSCxDQXJLRDs7ZUF1S2VwQyxpQiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAyMCBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCwgeyB1c2VDb250ZXh0IH0gZnJvbSBcInJlYWN0XCI7XG5pbXBvcnQgeyBNYXRyaXhDYXBhYmlsaXRpZXMgfSBmcm9tIFwibWF0cml4LXdpZGdldC1hcGlcIjtcblxuaW1wb3J0IEljb25pemVkQ29udGV4dE1lbnUsIHsgSWNvbml6ZWRDb250ZXh0TWVudU9wdGlvbiwgSWNvbml6ZWRDb250ZXh0TWVudU9wdGlvbkxpc3QgfSBmcm9tIFwiLi9JY29uaXplZENvbnRleHRNZW51XCI7XG5pbXBvcnQgeyBDaGV2cm9uRmFjZSB9IGZyb20gXCIuLi8uLi9zdHJ1Y3R1cmVzL0NvbnRleHRNZW51XCI7XG5pbXBvcnQgeyBfdCB9IGZyb20gXCIuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXJcIjtcbmltcG9ydCB7IElBcHAgfSBmcm9tIFwiLi4vLi4vLi4vc3RvcmVzL1dpZGdldFN0b3JlXCI7XG5pbXBvcnQgV2lkZ2V0VXRpbHMgZnJvbSBcIi4uLy4uLy4uL3V0aWxzL1dpZGdldFV0aWxzXCI7XG5pbXBvcnQgeyBXaWRnZXRNZXNzYWdpbmdTdG9yZSB9IGZyb20gXCIuLi8uLi8uLi9zdG9yZXMvd2lkZ2V0cy9XaWRnZXRNZXNzYWdpbmdTdG9yZVwiO1xuaW1wb3J0IFJvb21Db250ZXh0IGZyb20gXCIuLi8uLi8uLi9jb250ZXh0cy9Sb29tQ29udGV4dFwiO1xuaW1wb3J0IGRpcyBmcm9tIFwiLi4vLi4vLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyXCI7XG5pbXBvcnQgU2V0dGluZ3NTdG9yZSBmcm9tIFwiLi4vLi4vLi4vc2V0dGluZ3MvU2V0dGluZ3NTdG9yZVwiO1xuaW1wb3J0IE1vZGFsIGZyb20gXCIuLi8uLi8uLi9Nb2RhbFwiO1xuaW1wb3J0IFF1ZXN0aW9uRGlhbG9nIGZyb20gXCIuLi9kaWFsb2dzL1F1ZXN0aW9uRGlhbG9nXCI7XG5pbXBvcnQgRXJyb3JEaWFsb2cgZnJvbSBcIi4uL2RpYWxvZ3MvRXJyb3JEaWFsb2dcIjtcbmltcG9ydCB7IFdpZGdldFR5cGUgfSBmcm9tIFwiLi4vLi4vLi4vd2lkZ2V0cy9XaWRnZXRUeXBlXCI7XG5pbXBvcnQgTWF0cml4Q2xpZW50Q29udGV4dCBmcm9tIFwiLi4vLi4vLi4vY29udGV4dHMvTWF0cml4Q2xpZW50Q29udGV4dFwiO1xuaW1wb3J0IHsgQ29udGFpbmVyLCBXaWRnZXRMYXlvdXRTdG9yZSB9IGZyb20gXCIuLi8uLi8uLi9zdG9yZXMvd2lkZ2V0cy9XaWRnZXRMYXlvdXRTdG9yZVwiO1xuaW1wb3J0IHsgZ2V0Q29uZmlnTGl2ZXN0cmVhbVVybCwgc3RhcnRKaXRzaUF1ZGlvTGl2ZXN0cmVhbSB9IGZyb20gXCIuLi8uLi8uLi9MaXZlc3RyZWFtXCI7XG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcblxuaW50ZXJmYWNlIElQcm9wcyBleHRlbmRzIFJlYWN0LkNvbXBvbmVudFByb3BzPHR5cGVvZiBJY29uaXplZENvbnRleHRNZW51PiB7XG4gICAgYXBwOiBJQXBwO1xuICAgIHVzZXJXaWRnZXQ/OiBib29sZWFuO1xuICAgIHNob3dVbnBpbj86IGJvb2xlYW47XG4gICAgLy8gb3ZlcnJpZGUgZGVsZXRlIGhhbmRsZXJcbiAgICBvbkRlbGV0ZUNsaWNrPygpOiB2b2lkO1xuICAgIC8vIG92ZXJyaWRlIGVkaXQgaGFuZGxlclxuICAgIG9uRWRpdENsaWNrPygpOiB2b2lkO1xufVxuXG5jb25zdCBXaWRnZXRDb250ZXh0TWVudTogUmVhY3QuRkM8SVByb3BzPiA9ICh7XG4gICAgb25GaW5pc2hlZCxcbiAgICBhcHAsXG4gICAgdXNlcldpZGdldCxcbiAgICBvbkRlbGV0ZUNsaWNrLFxuICAgIG9uRWRpdENsaWNrLFxuICAgIHNob3dVbnBpbixcbiAgICAuLi5wcm9wc1xufSkgPT4ge1xuICAgIGNvbnN0IGNsaSA9IHVzZUNvbnRleHQoTWF0cml4Q2xpZW50Q29udGV4dCk7XG4gICAgY29uc3QgeyByb29tLCByb29tSWQgfSA9IHVzZUNvbnRleHQoUm9vbUNvbnRleHQpO1xuXG4gICAgY29uc3Qgd2lkZ2V0TWVzc2FnaW5nID0gV2lkZ2V0TWVzc2FnaW5nU3RvcmUuaW5zdGFuY2UuZ2V0TWVzc2FnaW5nRm9ySWQoYXBwLmlkKTtcbiAgICBjb25zdCBjYW5Nb2RpZnkgPSB1c2VyV2lkZ2V0IHx8IFdpZGdldFV0aWxzLmNhblVzZXJNb2RpZnlXaWRnZXRzKHJvb21JZCk7XG5cbiAgICBsZXQgc3RyZWFtQXVkaW9TdHJlYW1CdXR0b247XG4gICAgaWYgKGdldENvbmZpZ0xpdmVzdHJlYW1VcmwoKSAmJiBXaWRnZXRUeXBlLkpJVFNJLm1hdGNoZXMoYXBwLnR5cGUpKSB7XG4gICAgICAgIGNvbnN0IG9uU3RyZWFtQXVkaW9DbGljayA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgc3RhcnRKaXRzaUF1ZGlvTGl2ZXN0cmVhbSh3aWRnZXRNZXNzYWdpbmcsIHJvb21JZCk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoXCJGYWlsZWQgdG8gc3RhcnQgbGl2ZXN0cmVhbVwiLCBlcnIpO1xuICAgICAgICAgICAgICAgIC8vIFhYWDogd29uJ3QgaTE4biB3ZWxsLCBidXQgbG9va3MgbGlrZSB3aWRnZXQgYXBpIG9ubHkgc3VwcG9ydCAnbWVzc2FnZSc/XG4gICAgICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IGVyci5tZXNzYWdlIHx8IF90KFwiVW5hYmxlIHRvIHN0YXJ0IGF1ZGlvIHN0cmVhbWluZy5cIik7XG4gICAgICAgICAgICAgICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZygnV2lkZ2V0Q29udGV4dCBNZW51JywgJ0xpdmVzdHJlYW0gZmFpbGVkJywgRXJyb3JEaWFsb2csIHtcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6IF90KCdGYWlsZWQgdG8gc3RhcnQgbGl2ZXN0cmVhbScpLFxuICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogbWVzc2FnZSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG9uRmluaXNoZWQoKTtcbiAgICAgICAgfTtcbiAgICAgICAgc3RyZWFtQXVkaW9TdHJlYW1CdXR0b24gPSA8SWNvbml6ZWRDb250ZXh0TWVudU9wdGlvblxuICAgICAgICAgICAgb25DbGljaz17b25TdHJlYW1BdWRpb0NsaWNrfVxuICAgICAgICAgICAgbGFiZWw9e190KFwiU3RhcnQgYXVkaW8gc3RyZWFtXCIpfVxuICAgICAgICAvPjtcbiAgICB9XG5cbiAgICBsZXQgdW5waW5CdXR0b247XG4gICAgaWYgKHNob3dVbnBpbikge1xuICAgICAgICBjb25zdCBvblVucGluQ2xpY2sgPSAoKSA9PiB7XG4gICAgICAgICAgICBXaWRnZXRMYXlvdXRTdG9yZS5pbnN0YW5jZS5tb3ZlVG9Db250YWluZXIocm9vbSwgYXBwLCBDb250YWluZXIuUmlnaHQpO1xuICAgICAgICAgICAgb25GaW5pc2hlZCgpO1xuICAgICAgICB9O1xuXG4gICAgICAgIHVucGluQnV0dG9uID0gPEljb25pemVkQ29udGV4dE1lbnVPcHRpb24gb25DbGljaz17b25VbnBpbkNsaWNrfSBsYWJlbD17X3QoXCJVbnBpblwiKX0gLz47XG4gICAgfVxuXG4gICAgbGV0IGVkaXRCdXR0b247XG4gICAgaWYgKGNhbk1vZGlmeSAmJiBXaWRnZXRVdGlscy5pc01hbmFnZWRCeU1hbmFnZXIoYXBwKSkge1xuICAgICAgICBjb25zdCBfb25FZGl0Q2xpY2sgPSAoKSA9PiB7XG4gICAgICAgICAgICBpZiAob25FZGl0Q2xpY2spIHtcbiAgICAgICAgICAgICAgICBvbkVkaXRDbGljaygpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBXaWRnZXRVdGlscy5lZGl0V2lkZ2V0KHJvb20sIGFwcCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBvbkZpbmlzaGVkKCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgZWRpdEJ1dHRvbiA9IDxJY29uaXplZENvbnRleHRNZW51T3B0aW9uIG9uQ2xpY2s9e19vbkVkaXRDbGlja30gbGFiZWw9e190KFwiRWRpdFwiKX0gLz47XG4gICAgfVxuXG4gICAgbGV0IHNuYXBzaG90QnV0dG9uO1xuICAgIGlmICh3aWRnZXRNZXNzYWdpbmc/Lmhhc0NhcGFiaWxpdHkoTWF0cml4Q2FwYWJpbGl0aWVzLlNjcmVlbnNob3RzKSkge1xuICAgICAgICBjb25zdCBvblNuYXBzaG90Q2xpY2sgPSAoKSA9PiB7XG4gICAgICAgICAgICB3aWRnZXRNZXNzYWdpbmc/LnRha2VTY3JlZW5zaG90KCkudGhlbihkYXRhID0+IHtcbiAgICAgICAgICAgICAgICBkaXMuZGlzcGF0Y2goe1xuICAgICAgICAgICAgICAgICAgICBhY3Rpb246ICdwaWN0dXJlX3NuYXBzaG90JyxcbiAgICAgICAgICAgICAgICAgICAgZmlsZTogZGF0YS5zY3JlZW5zaG90LFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoXCJGYWlsZWQgdG8gdGFrZSBzY3JlZW5zaG90OiBcIiwgZXJyKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgb25GaW5pc2hlZCgpO1xuICAgICAgICB9O1xuXG4gICAgICAgIHNuYXBzaG90QnV0dG9uID0gPEljb25pemVkQ29udGV4dE1lbnVPcHRpb24gb25DbGljaz17b25TbmFwc2hvdENsaWNrfSBsYWJlbD17X3QoXCJUYWtlIGEgcGljdHVyZVwiKX0gLz47XG4gICAgfVxuXG4gICAgbGV0IGRlbGV0ZUJ1dHRvbjtcbiAgICBpZiAob25EZWxldGVDbGljayB8fCBjYW5Nb2RpZnkpIHtcbiAgICAgICAgY29uc3QgX29uRGVsZXRlQ2xpY2sgPSAoKSA9PiB7XG4gICAgICAgICAgICBpZiAob25EZWxldGVDbGljaykge1xuICAgICAgICAgICAgICAgIG9uRGVsZXRlQ2xpY2soKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gU2hvdyBkZWxldGUgY29uZmlybWF0aW9uIGRpYWxvZ1xuICAgICAgICAgICAgICAgIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coJ0RlbGV0ZSBXaWRnZXQnLCAnJywgUXVlc3Rpb25EaWFsb2csIHtcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6IF90KFwiRGVsZXRlIFdpZGdldFwiKSxcbiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IF90KFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJEZWxldGluZyBhIHdpZGdldCByZW1vdmVzIGl0IGZvciBhbGwgdXNlcnMgaW4gdGhpcyByb29tLlwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiIEFyZSB5b3Ugc3VyZSB5b3Ugd2FudCB0byBkZWxldGUgdGhpcyB3aWRnZXQ/XCIpLFxuICAgICAgICAgICAgICAgICAgICBidXR0b246IF90KFwiRGVsZXRlIHdpZGdldFwiKSxcbiAgICAgICAgICAgICAgICAgICAgb25GaW5pc2hlZDogKGNvbmZpcm1lZCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjb25maXJtZWQpIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgIFdpZGdldFV0aWxzLnNldFJvb21XaWRnZXQocm9vbUlkLCBhcHAuaWQpO1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBvbkZpbmlzaGVkKCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgZGVsZXRlQnV0dG9uID0gPEljb25pemVkQ29udGV4dE1lbnVPcHRpb25cbiAgICAgICAgICAgIG9uQ2xpY2s9e19vbkRlbGV0ZUNsaWNrfVxuICAgICAgICAgICAgbGFiZWw9e3VzZXJXaWRnZXQgPyBfdChcIlJlbW92ZVwiKSA6IF90KFwiUmVtb3ZlIGZvciBldmVyeW9uZVwiKX1cbiAgICAgICAgLz47XG4gICAgfVxuXG4gICAgbGV0IGlzQWxsb3dlZFdpZGdldCA9IFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJhbGxvd2VkV2lkZ2V0c1wiLCByb29tSWQpW2FwcC5ldmVudElkXTtcbiAgICBpZiAoaXNBbGxvd2VkV2lkZ2V0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgaXNBbGxvd2VkV2lkZ2V0ID0gYXBwLmNyZWF0b3JVc2VySWQgPT09IGNsaS5nZXRVc2VySWQoKTtcbiAgICB9XG5cbiAgICBjb25zdCBpc0xvY2FsV2lkZ2V0ID0gV2lkZ2V0VHlwZS5KSVRTSS5tYXRjaGVzKGFwcC50eXBlKTtcbiAgICBsZXQgcmV2b2tlQnV0dG9uO1xuICAgIGlmICghdXNlcldpZGdldCAmJiAhaXNMb2NhbFdpZGdldCAmJiBpc0FsbG93ZWRXaWRnZXQpIHtcbiAgICAgICAgY29uc3Qgb25SZXZva2VDbGljayA9ICgpID0+IHtcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKFwiUmV2b2tpbmcgcGVybWlzc2lvbiBmb3Igd2lkZ2V0IHRvIGxvYWQ6IFwiICsgYXBwLmV2ZW50SWQpO1xuICAgICAgICAgICAgY29uc3QgY3VycmVudCA9IFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJhbGxvd2VkV2lkZ2V0c1wiLCByb29tSWQpO1xuICAgICAgICAgICAgY3VycmVudFthcHAuZXZlbnRJZF0gPSBmYWxzZTtcbiAgICAgICAgICAgIGNvbnN0IGxldmVsID0gU2V0dGluZ3NTdG9yZS5maXJzdFN1cHBvcnRlZExldmVsKFwiYWxsb3dlZFdpZGdldHNcIik7XG4gICAgICAgICAgICBTZXR0aW5nc1N0b3JlLnNldFZhbHVlKFwiYWxsb3dlZFdpZGdldHNcIiwgcm9vbUlkLCBsZXZlbCwgY3VycmVudCkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZXJyKTtcbiAgICAgICAgICAgICAgICAvLyBXZSBkb24ndCByZWFsbHkgbmVlZCB0byBkbyBhbnl0aGluZyBhYm91dCB0aGlzIC0gdGhlIHVzZXIgd2lsbCBqdXN0IGhpdCB0aGUgYnV0dG9uIGFnYWluLlxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBvbkZpbmlzaGVkKCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgcmV2b2tlQnV0dG9uID0gPEljb25pemVkQ29udGV4dE1lbnVPcHRpb24gb25DbGljaz17b25SZXZva2VDbGlja30gbGFiZWw9e190KFwiUmV2b2tlIHBlcm1pc3Npb25zXCIpfSAvPjtcbiAgICB9XG5cbiAgICBjb25zdCBwaW5uZWRXaWRnZXRzID0gV2lkZ2V0TGF5b3V0U3RvcmUuaW5zdGFuY2UuZ2V0Q29udGFpbmVyV2lkZ2V0cyhyb29tLCBDb250YWluZXIuVG9wKTtcbiAgICBjb25zdCB3aWRnZXRJbmRleCA9IHBpbm5lZFdpZGdldHMuZmluZEluZGV4KHdpZGdldCA9PiB3aWRnZXQuaWQgPT09IGFwcC5pZCk7XG5cbiAgICBsZXQgbW92ZUxlZnRCdXR0b247XG4gICAgaWYgKHNob3dVbnBpbiAmJiB3aWRnZXRJbmRleCA+IDApIHtcbiAgICAgICAgY29uc3Qgb25DbGljayA9ICgpID0+IHtcbiAgICAgICAgICAgIFdpZGdldExheW91dFN0b3JlLmluc3RhbmNlLm1vdmVXaXRoaW5Db250YWluZXIocm9vbSwgQ29udGFpbmVyLlRvcCwgYXBwLCAtMSk7XG4gICAgICAgICAgICBvbkZpbmlzaGVkKCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgbW92ZUxlZnRCdXR0b24gPSA8SWNvbml6ZWRDb250ZXh0TWVudU9wdGlvbiBvbkNsaWNrPXtvbkNsaWNrfSBsYWJlbD17X3QoXCJNb3ZlIGxlZnRcIil9IC8+O1xuICAgIH1cblxuICAgIGxldCBtb3ZlUmlnaHRCdXR0b247XG4gICAgaWYgKHNob3dVbnBpbiAmJiB3aWRnZXRJbmRleCA8IHBpbm5lZFdpZGdldHMubGVuZ3RoIC0gMSkge1xuICAgICAgICBjb25zdCBvbkNsaWNrID0gKCkgPT4ge1xuICAgICAgICAgICAgV2lkZ2V0TGF5b3V0U3RvcmUuaW5zdGFuY2UubW92ZVdpdGhpbkNvbnRhaW5lcihyb29tLCBDb250YWluZXIuVG9wLCBhcHAsIDEpO1xuICAgICAgICAgICAgb25GaW5pc2hlZCgpO1xuICAgICAgICB9O1xuXG4gICAgICAgIG1vdmVSaWdodEJ1dHRvbiA9IDxJY29uaXplZENvbnRleHRNZW51T3B0aW9uIG9uQ2xpY2s9e29uQ2xpY2t9IGxhYmVsPXtfdChcIk1vdmUgcmlnaHRcIil9IC8+O1xuICAgIH1cblxuICAgIHJldHVybiA8SWNvbml6ZWRDb250ZXh0TWVudSB7Li4ucHJvcHN9IGNoZXZyb25GYWNlPXtDaGV2cm9uRmFjZS5Ob25lfSBvbkZpbmlzaGVkPXtvbkZpbmlzaGVkfT5cbiAgICAgICAgPEljb25pemVkQ29udGV4dE1lbnVPcHRpb25MaXN0PlxuICAgICAgICAgICAgeyBzdHJlYW1BdWRpb1N0cmVhbUJ1dHRvbiB9XG4gICAgICAgICAgICB7IGVkaXRCdXR0b24gfVxuICAgICAgICAgICAgeyByZXZva2VCdXR0b24gfVxuICAgICAgICAgICAgeyBkZWxldGVCdXR0b24gfVxuICAgICAgICAgICAgeyBzbmFwc2hvdEJ1dHRvbiB9XG4gICAgICAgICAgICB7IG1vdmVMZWZ0QnV0dG9uIH1cbiAgICAgICAgICAgIHsgbW92ZVJpZ2h0QnV0dG9uIH1cbiAgICAgICAgICAgIHsgdW5waW5CdXR0b24gfVxuICAgICAgICA8L0ljb25pemVkQ29udGV4dE1lbnVPcHRpb25MaXN0PlxuICAgIDwvSWNvbml6ZWRDb250ZXh0TWVudT47XG59O1xuXG5leHBvcnQgZGVmYXVsdCBXaWRnZXRDb250ZXh0TWVudTtcbiJdfQ==