"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _react = _interopRequireWildcard(require("react"));

var _logger = require("matrix-js-sdk/src/logger");

var _IconizedContextMenu = _interopRequireWildcard(require("./IconizedContextMenu"));

var _languageHandler = require("../../../languageHandler");

var _MatrixClientContext = _interopRequireDefault(require("../../../contexts/MatrixClientContext"));

var _models = require("../../../stores/room-list/models");

var _RoomListStore = _interopRequireWildcard(require("../../../stores/room-list/RoomListStore"));

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var _RoomListActions = _interopRequireDefault(require("../../../actions/RoomListActions"));

var _Keyboard = require("../../../Keyboard");

var _EchoChamber = require("../../../stores/local-echo/EchoChamber");

var _RoomNotifs = require("../../../RoomNotifs");

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _ExportDialog = _interopRequireDefault(require("../dialogs/ExportDialog"));

var _RoomSummaryCard = require("../right_panel/RoomSummaryCard");

var _RoomViewStore = _interopRequireDefault(require("../../../stores/RoomViewStore"));

var _actions = require("../../../dispatcher/actions");

var _RightPanelStorePhases = require("../../../stores/RightPanelStorePhases");

var _RoomSettingsDialog = require("../dialogs/RoomSettingsDialog");

var _useEventEmitter = require("../../../hooks/useEventEmitter");

const _excluded = ["room", "onFinished"];

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

const RoomContextMenu = _ref => {
  let {
    room,
    onFinished
  } = _ref,
      props = (0, _objectWithoutProperties2.default)(_ref, _excluded);
  const cli = (0, _react.useContext)(_MatrixClientContext.default);
  const roomTags = (0, _useEventEmitter.useEventEmitterState)(_RoomListStore.default.instance, _RoomListStore.LISTS_UPDATE_EVENT, () => _RoomListStore.default.instance.getTagsForRoom(room));
  let leaveOption;

  if (roomTags.includes(_models.DefaultTagID.Archived)) {
    const onForgetRoomClick = ev => {
      ev.preventDefault();
      ev.stopPropagation();

      _dispatcher.default.dispatch({
        action: "forget_room",
        room_id: room.roomId
      });

      onFinished();
    };

    leaveOption = /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOption, {
      iconClassName: "mx_RoomTile_iconSignOut",
      label: (0, _languageHandler._t)("Forget"),
      className: "mx_IconizedContextMenu_option_red",
      onClick: onForgetRoomClick
    });
  } else {
    const onLeaveRoomClick = ev => {
      ev.preventDefault();
      ev.stopPropagation();

      _dispatcher.default.dispatch({
        action: "leave_room",
        room_id: room.roomId
      });

      onFinished();
    };

    leaveOption = /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOption, {
      onClick: onLeaveRoomClick,
      label: (0, _languageHandler._t)("Leave"),
      className: "mx_IconizedContextMenu_option_red",
      iconClassName: "mx_RoomTile_iconSignOut"
    });
  }

  let inviteOption;

  if (room.canInvite(cli.getUserId())) {
    const onInviteClick = ev => {
      ev.preventDefault();
      ev.stopPropagation();

      _dispatcher.default.dispatch({
        action: "view_invite",
        roomId: room.roomId
      });

      onFinished();
    };

    inviteOption = /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOption, {
      onClick: onInviteClick,
      label: (0, _languageHandler._t)("Invite"),
      iconClassName: "mx_RoomTile_iconInvite"
    });
  }

  let favouriteOption;
  let lowPriorityOption;
  let notificationOption;

  if (room.getMyMembership() === "join") {
    const isFavorite = roomTags.includes(_models.DefaultTagID.Favourite);
    favouriteOption = /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuCheckbox, {
      onClick: e => onTagRoom(e, _models.DefaultTagID.Favourite),
      active: isFavorite,
      label: isFavorite ? (0, _languageHandler._t)("Favourited") : (0, _languageHandler._t)("Favourite"),
      iconClassName: "mx_RoomTile_iconStar"
    });
    const isLowPriority = roomTags.includes(_models.DefaultTagID.LowPriority);
    lowPriorityOption = /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuCheckbox, {
      onClick: e => onTagRoom(e, _models.DefaultTagID.LowPriority),
      active: isLowPriority,
      label: (0, _languageHandler._t)("Low priority"),
      iconClassName: "mx_RoomTile_iconArrowDown"
    });

    const echoChamber = _EchoChamber.EchoChamber.forRoom(room);

    let notificationLabel;
    let iconClassName;

    switch (echoChamber.notificationVolume) {
      case _RoomNotifs.RoomNotifState.AllMessages:
        notificationLabel = (0, _languageHandler._t)("Default");
        iconClassName = "mx_RoomTile_iconNotificationsDefault";
        break;

      case _RoomNotifs.RoomNotifState.AllMessagesLoud:
        notificationLabel = (0, _languageHandler._t)("All messages");
        iconClassName = "mx_RoomTile_iconNotificationsAllMessages";
        break;

      case _RoomNotifs.RoomNotifState.MentionsOnly:
        notificationLabel = (0, _languageHandler._t)("Mentions only");
        iconClassName = "mx_RoomTile_iconNotificationsMentionsKeywords";
        break;

      case _RoomNotifs.RoomNotifState.Mute:
        notificationLabel = (0, _languageHandler._t)("Mute");
        iconClassName = "mx_RoomTile_iconNotificationsNone";
        break;
    }

    notificationOption = /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOption, {
      onClick: ev => {
        ev.preventDefault();
        ev.stopPropagation();

        _dispatcher.default.dispatch({
          action: "open_room_settings",
          room_id: room.roomId,
          initial_tab_id: _RoomSettingsDialog.ROOM_NOTIFICATIONS_TAB
        });

        onFinished();
      },
      label: (0, _languageHandler._t)("Notifications"),
      iconClassName: iconClassName
    }, /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_IconizedContextMenu_sublabel"
    }, notificationLabel));
  }

  const onTagRoom = (ev, tagId) => {
    ev.preventDefault();
    ev.stopPropagation();

    if (tagId === _models.DefaultTagID.Favourite || tagId === _models.DefaultTagID.LowPriority) {
      const inverseTag = tagId === _models.DefaultTagID.Favourite ? _models.DefaultTagID.LowPriority : _models.DefaultTagID.Favourite;

      const isApplied = _RoomListStore.default.instance.getTagsForRoom(room).includes(tagId);

      const removeTag = isApplied ? tagId : inverseTag;
      const addTag = isApplied ? null : tagId;

      _dispatcher.default.dispatch(_RoomListActions.default.tagRoom(cli, room, removeTag, addTag, undefined, 0));
    } else {
      _logger.logger.warn(`Unexpected tag ${tagId} applied to ${room.roomId}`);
    }

    if (ev.key === _Keyboard.Key.ENTER) {
      // Implements https://www.w3.org/TR/wai-aria-practices/#keyboard-interaction-12
      onFinished();
    }
  };

  const ensureViewingRoom = () => {
    if (_RoomViewStore.default.getRoomId() === room.roomId) return;

    _dispatcher.default.dispatch({
      action: "view_room",
      room_id: room.roomId
    }, true);
  };

  return /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.default, (0, _extends2.default)({}, props, {
    onFinished: onFinished,
    className: "mx_RoomTile_contextMenu",
    compact: true
  }), /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOptionList, null, inviteOption, notificationOption, favouriteOption, /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOption, {
    onClick: ev => {
      ev.preventDefault();
      ev.stopPropagation();
      ensureViewingRoom();
      (0, _RoomSummaryCard.onRoomMembersClick)(false);
      onFinished();
    },
    label: (0, _languageHandler._t)("People"),
    iconClassName: "mx_RoomTile_iconPeople"
  }, /*#__PURE__*/_react.default.createElement("span", {
    className: "mx_IconizedContextMenu_sublabel"
  }, room.getJoinedMemberCount())), /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOption, {
    onClick: ev => {
      ev.preventDefault();
      ev.stopPropagation();
      ensureViewingRoom();
      (0, _RoomSummaryCard.onRoomFilesClick)(false);
      onFinished();
    },
    label: (0, _languageHandler._t)("Files"),
    iconClassName: "mx_RoomTile_iconFiles"
  }), /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOption, {
    onClick: ev => {
      ev.preventDefault();
      ev.stopPropagation();
      ensureViewingRoom();

      _dispatcher.default.dispatch({
        action: _actions.Action.SetRightPanelPhase,
        phase: _RightPanelStorePhases.RightPanelPhases.RoomSummary,
        allowClose: false
      });

      onFinished();
    },
    label: (0, _languageHandler._t)("Widgets"),
    iconClassName: "mx_RoomTile_iconWidgets"
  }), lowPriorityOption, /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOption, {
    onClick: ev => {
      ev.preventDefault();
      ev.stopPropagation();

      _dispatcher.default.dispatch({
        action: "copy_room",
        room_id: room.roomId
      });

      onFinished();
    },
    label: (0, _languageHandler._t)("Copy link"),
    iconClassName: "mx_RoomTile_iconCopyLink"
  }), /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOption, {
    onClick: ev => {
      ev.preventDefault();
      ev.stopPropagation();

      _dispatcher.default.dispatch({
        action: "open_room_settings",
        room_id: room.roomId
      });

      onFinished();
    },
    label: (0, _languageHandler._t)("Settings"),
    iconClassName: "mx_RoomTile_iconSettings"
  }), /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOption, {
    onClick: ev => {
      ev.preventDefault();
      ev.stopPropagation();

      _Modal.default.createTrackedDialog('Export room dialog', '', _ExportDialog.default, {
        room
      });

      onFinished();
    },
    label: (0, _languageHandler._t)("Export chat"),
    iconClassName: "mx_RoomTile_iconExport"
  }), leaveOption));
};

var _default = RoomContextMenu;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2NvbnRleHRfbWVudXMvUm9vbUNvbnRleHRNZW51LnRzeCJdLCJuYW1lcyI6WyJSb29tQ29udGV4dE1lbnUiLCJyb29tIiwib25GaW5pc2hlZCIsInByb3BzIiwiY2xpIiwiTWF0cml4Q2xpZW50Q29udGV4dCIsInJvb21UYWdzIiwiUm9vbUxpc3RTdG9yZSIsImluc3RhbmNlIiwiTElTVFNfVVBEQVRFX0VWRU5UIiwiZ2V0VGFnc0ZvclJvb20iLCJsZWF2ZU9wdGlvbiIsImluY2x1ZGVzIiwiRGVmYXVsdFRhZ0lEIiwiQXJjaGl2ZWQiLCJvbkZvcmdldFJvb21DbGljayIsImV2IiwicHJldmVudERlZmF1bHQiLCJzdG9wUHJvcGFnYXRpb24iLCJkaXMiLCJkaXNwYXRjaCIsImFjdGlvbiIsInJvb21faWQiLCJyb29tSWQiLCJvbkxlYXZlUm9vbUNsaWNrIiwiaW52aXRlT3B0aW9uIiwiY2FuSW52aXRlIiwiZ2V0VXNlcklkIiwib25JbnZpdGVDbGljayIsImZhdm91cml0ZU9wdGlvbiIsImxvd1ByaW9yaXR5T3B0aW9uIiwibm90aWZpY2F0aW9uT3B0aW9uIiwiZ2V0TXlNZW1iZXJzaGlwIiwiaXNGYXZvcml0ZSIsIkZhdm91cml0ZSIsImUiLCJvblRhZ1Jvb20iLCJpc0xvd1ByaW9yaXR5IiwiTG93UHJpb3JpdHkiLCJlY2hvQ2hhbWJlciIsIkVjaG9DaGFtYmVyIiwiZm9yUm9vbSIsIm5vdGlmaWNhdGlvbkxhYmVsIiwiaWNvbkNsYXNzTmFtZSIsIm5vdGlmaWNhdGlvblZvbHVtZSIsIlJvb21Ob3RpZlN0YXRlIiwiQWxsTWVzc2FnZXMiLCJBbGxNZXNzYWdlc0xvdWQiLCJNZW50aW9uc09ubHkiLCJNdXRlIiwiaW5pdGlhbF90YWJfaWQiLCJST09NX05PVElGSUNBVElPTlNfVEFCIiwidGFnSWQiLCJpbnZlcnNlVGFnIiwiaXNBcHBsaWVkIiwicmVtb3ZlVGFnIiwiYWRkVGFnIiwiUm9vbUxpc3RBY3Rpb25zIiwidGFnUm9vbSIsInVuZGVmaW5lZCIsImxvZ2dlciIsIndhcm4iLCJrZXkiLCJLZXkiLCJFTlRFUiIsImVuc3VyZVZpZXdpbmdSb29tIiwiUm9vbVZpZXdTdG9yZSIsImdldFJvb21JZCIsImdldEpvaW5lZE1lbWJlckNvdW50IiwiZGVmYXVsdERpc3BhdGNoZXIiLCJBY3Rpb24iLCJTZXRSaWdodFBhbmVsUGhhc2UiLCJwaGFzZSIsIlJpZ2h0UGFuZWxQaGFzZXMiLCJSb29tU3VtbWFyeSIsImFsbG93Q2xvc2UiLCJNb2RhbCIsImNyZWF0ZVRyYWNrZWREaWFsb2ciLCJFeHBvcnREaWFsb2ciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFnQkE7O0FBRUE7O0FBR0E7O0FBS0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7O0FBTUEsTUFBTUEsZUFBZSxHQUFHLFFBQTRDO0FBQUEsTUFBM0M7QUFBRUMsSUFBQUEsSUFBRjtBQUFRQyxJQUFBQTtBQUFSLEdBQTJDO0FBQUEsTUFBcEJDLEtBQW9CO0FBQ2hFLFFBQU1DLEdBQUcsR0FBRyx1QkFBV0MsNEJBQVgsQ0FBWjtBQUNBLFFBQU1DLFFBQVEsR0FBRywyQ0FDYkMsdUJBQWNDLFFBREQsRUFFYkMsaUNBRmEsRUFHYixNQUFNRix1QkFBY0MsUUFBZCxDQUF1QkUsY0FBdkIsQ0FBc0NULElBQXRDLENBSE8sQ0FBakI7QUFNQSxNQUFJVSxXQUFKOztBQUNBLE1BQUlMLFFBQVEsQ0FBQ00sUUFBVCxDQUFrQkMscUJBQWFDLFFBQS9CLENBQUosRUFBOEM7QUFDMUMsVUFBTUMsaUJBQWlCLEdBQUlDLEVBQUQsSUFBcUI7QUFDM0NBLE1BQUFBLEVBQUUsQ0FBQ0MsY0FBSDtBQUNBRCxNQUFBQSxFQUFFLENBQUNFLGVBQUg7O0FBRUFDLDBCQUFJQyxRQUFKLENBQWE7QUFDVEMsUUFBQUEsTUFBTSxF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QUNJLElBQUEsT0FBTyxFQUFHYyxFQUFELElBQXFCO0FBQzFCQSxNQUFBQSxFQUFFLENBQUNDLGNBQUg7QUFDQUQsTUFBQUEsRUFBRSxDQUFDRSxlQUFIOztBQUVBMEQscUJBQU1DLG1CQUFOLENBQTBCLG9CQUExQixFQUFnRCxFQUFoRCxFQUFvREMscUJBQXBELEVBQWtFO0FBQUU3RSxRQUFBQTtBQUFGLE9BQWxFOztBQUNBQyxNQUFBQSxVQUFVO0FBQ2IsS0FQTDtBQVFJLElBQUEsS0FBSyxFQUFFLHlCQUFHLGFBQUgsQ0FSWDtBQVNJLElBQUEsYUFBYSxFQUFDO0FBVGxCLElBcEZKLEVBZ0dNUyxXQWhHTixDQURHLENBQVA7QUFvR0gsQ0FsUUQ7O2VBb1FlWCxlIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDIxIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0LCB7IHVzZUNvbnRleHQgfSBmcm9tIFwicmVhY3RcIjtcbmltcG9ydCB7IFJvb20gfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3Jvb21cIjtcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcblxuaW1wb3J0IHsgSVByb3BzIGFzIElDb250ZXh0TWVudVByb3BzIH0gZnJvbSBcIi4uLy4uL3N0cnVjdHVyZXMvQ29udGV4dE1lbnVcIjtcbmltcG9ydCBJY29uaXplZENvbnRleHRNZW51LCB7XG4gICAgSWNvbml6ZWRDb250ZXh0TWVudUNoZWNrYm94LFxuICAgIEljb25pemVkQ29udGV4dE1lbnVPcHRpb24sXG4gICAgSWNvbml6ZWRDb250ZXh0TWVudU9wdGlvbkxpc3QsXG59IGZyb20gXCIuL0ljb25pemVkQ29udGV4dE1lbnVcIjtcbmltcG9ydCB7IF90IH0gZnJvbSBcIi4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlclwiO1xuaW1wb3J0IE1hdHJpeENsaWVudENvbnRleHQgZnJvbSBcIi4uLy4uLy4uL2NvbnRleHRzL01hdHJpeENsaWVudENvbnRleHRcIjtcbmltcG9ydCB7IEJ1dHRvbkV2ZW50IH0gZnJvbSBcIi4uL2VsZW1lbnRzL0FjY2Vzc2libGVCdXR0b25cIjtcbmltcG9ydCB7IERlZmF1bHRUYWdJRCwgVGFnSUQgfSBmcm9tIFwiLi4vLi4vLi4vc3RvcmVzL3Jvb20tbGlzdC9tb2RlbHNcIjtcbmltcG9ydCBSb29tTGlzdFN0b3JlLCB7IExJU1RTX1VQREFURV9FVkVOVCB9IGZyb20gXCIuLi8uLi8uLi9zdG9yZXMvcm9vbS1saXN0L1Jvb21MaXN0U3RvcmVcIjtcbmltcG9ydCBkaXMgZnJvbSBcIi4uLy4uLy4uL2Rpc3BhdGNoZXIvZGlzcGF0Y2hlclwiO1xuaW1wb3J0IFJvb21MaXN0QWN0aW9ucyBmcm9tIFwiLi4vLi4vLi4vYWN0aW9ucy9Sb29tTGlzdEFjdGlvbnNcIjtcbmltcG9ydCB7IEtleSB9IGZyb20gXCIuLi8uLi8uLi9LZXlib2FyZFwiO1xuaW1wb3J0IHsgRWNob0NoYW1iZXIgfSBmcm9tIFwiLi4vLi4vLi4vc3RvcmVzL2xvY2FsLWVjaG8vRWNob0NoYW1iZXJcIjtcbmltcG9ydCB7IFJvb21Ob3RpZlN0YXRlIH0gZnJvbSBcIi4uLy4uLy4uL1Jvb21Ob3RpZnNcIjtcbmltcG9ydCBNb2RhbCBmcm9tIFwiLi4vLi4vLi4vTW9kYWxcIjtcbmltcG9ydCBFeHBvcnREaWFsb2cgZnJvbSBcIi4uL2RpYWxvZ3MvRXhwb3J0RGlhbG9nXCI7XG5pbXBvcnQgeyBvblJvb21GaWxlc0NsaWNrLCBvblJvb21NZW1iZXJzQ2xpY2sgfSBmcm9tIFwiLi4vcmlnaHRfcGFuZWwvUm9vbVN1bW1hcnlDYXJkXCI7XG5pbXBvcnQgUm9vbVZpZXdTdG9yZSBmcm9tIFwiLi4vLi4vLi4vc3RvcmVzL1Jvb21WaWV3U3RvcmVcIjtcbmltcG9ydCBkZWZhdWx0RGlzcGF0Y2hlciBmcm9tIFwiLi4vLi4vLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyXCI7XG5pbXBvcnQgeyBTZXRSaWdodFBhbmVsUGhhc2VQYXlsb2FkIH0gZnJvbSBcIi4uLy4uLy4uL2Rpc3BhdGNoZXIvcGF5bG9hZHMvU2V0UmlnaHRQYW5lbFBoYXNlUGF5bG9hZFwiO1xuaW1wb3J0IHsgQWN0aW9uIH0gZnJvbSBcIi4uLy4uLy4uL2Rpc3BhdGNoZXIvYWN0aW9uc1wiO1xuaW1wb3J0IHsgUmlnaHRQYW5lbFBoYXNlcyB9IGZyb20gXCIuLi8uLi8uLi9zdG9yZXMvUmlnaHRQYW5lbFN0b3JlUGhhc2VzXCI7XG5pbXBvcnQgeyBST09NX05PVElGSUNBVElPTlNfVEFCIH0gZnJvbSBcIi4uL2RpYWxvZ3MvUm9vbVNldHRpbmdzRGlhbG9nXCI7XG5pbXBvcnQgeyB1c2VFdmVudEVtaXR0ZXJTdGF0ZSB9IGZyb20gXCIuLi8uLi8uLi9ob29rcy91c2VFdmVudEVtaXR0ZXJcIjtcblxuaW50ZXJmYWNlIElQcm9wcyBleHRlbmRzIElDb250ZXh0TWVudVByb3BzIHtcbiAgICByb29tOiBSb29tO1xufVxuXG5jb25zdCBSb29tQ29udGV4dE1lbnUgPSAoeyByb29tLCBvbkZpbmlzaGVkLCAuLi5wcm9wcyB9OiBJUHJvcHMpID0+IHtcbiAgICBjb25zdCBjbGkgPSB1c2VDb250ZXh0KE1hdHJpeENsaWVudENvbnRleHQpO1xuICAgIGNvbnN0IHJvb21UYWdzID0gdXNlRXZlbnRFbWl0dGVyU3RhdGUoXG4gICAgICAgIFJvb21MaXN0U3RvcmUuaW5zdGFuY2UsXG4gICAgICAgIExJU1RTX1VQREFURV9FVkVOVCxcbiAgICAgICAgKCkgPT4gUm9vbUxpc3RTdG9yZS5pbnN0YW5jZS5nZXRUYWdzRm9yUm9vbShyb29tKSxcbiAgICApO1xuXG4gICAgbGV0IGxlYXZlT3B0aW9uOiBKU1guRWxlbWVudDtcbiAgICBpZiAocm9vbVRhZ3MuaW5jbHVkZXMoRGVmYXVsdFRhZ0lELkFyY2hpdmVkKSkge1xuICAgICAgICBjb25zdCBvbkZvcmdldFJvb21DbGljayA9IChldjogQnV0dG9uRXZlbnQpID0+IHtcbiAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICBldi5zdG9wUHJvcGFnYXRpb24oKTtcblxuICAgICAgICAgICAgZGlzLmRpc3BhdGNoKHtcbiAgICAgICAgICAgICAgICBhY3Rpb246IFwiZm9yZ2V0X3Jvb21cIixcbiAgICAgICAgICAgICAgICByb29tX2lkOiByb29tLnJvb21JZCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgb25GaW5pc2hlZCgpO1xuICAgICAgICB9O1xuXG4gICAgICAgIGxlYXZlT3B0aW9uID0gPEljb25pemVkQ29udGV4dE1lbnVPcHRpb25cbiAgICAgICAgICAgIGljb25DbGFzc05hbWU9XCJteF9Sb29tVGlsZV9pY29uU2lnbk91dFwiXG4gICAgICAgICAgICBsYWJlbD17X3QoXCJGb3JnZXRcIil9XG4gICAgICAgICAgICBjbGFzc05hbWU9XCJteF9JY29uaXplZENvbnRleHRNZW51X29wdGlvbl9yZWRcIlxuICAgICAgICAgICAgb25DbGljaz17b25Gb3JnZXRSb29tQ2xpY2t9XG4gICAgICAgIC8+O1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IG9uTGVhdmVSb29tQ2xpY2sgPSAoZXY6IEJ1dHRvbkV2ZW50KSA9PiB7XG4gICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgZXYuc3RvcFByb3BhZ2F0aW9uKCk7XG5cbiAgICAgICAgICAgIGRpcy5kaXNwYXRjaCh7XG4gICAgICAgICAgICAgICAgYWN0aW9uOiBcImxlYXZlX3Jvb21cIixcbiAgICAgICAgICAgICAgICByb29tX2lkOiByb29tLnJvb21JZCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgb25GaW5pc2hlZCgpO1xuICAgICAgICB9O1xuXG4gICAgICAgIGxlYXZlT3B0aW9uID0gPEljb25pemVkQ29udGV4dE1lbnVPcHRpb25cbiAgICAgICAgICAgIG9uQ2xpY2s9e29uTGVhdmVSb29tQ2xpY2t9XG4gICAgICAgICAgICBsYWJlbD17X3QoXCJMZWF2ZVwiKX1cbiAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X0ljb25pemVkQ29udGV4dE1lbnVfb3B0aW9uX3JlZFwiXG4gICAgICAgICAgICBpY29uQ2xhc3NOYW1lPVwibXhfUm9vbVRpbGVfaWNvblNpZ25PdXRcIlxuICAgICAgICAvPjtcbiAgICB9XG5cbiAgICBsZXQgaW52aXRlT3B0aW9uOiBKU1guRWxlbWVudDtcbiAgICBpZiAocm9vbS5jYW5JbnZpdGUoY2xpLmdldFVzZXJJZCgpKSkge1xuICAgICAgICBjb25zdCBvbkludml0ZUNsaWNrID0gKGV2OiBCdXR0b25FdmVudCkgPT4ge1xuICAgICAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIGV2LnN0b3BQcm9wYWdhdGlvbigpO1xuXG4gICAgICAgICAgICBkaXMuZGlzcGF0Y2goe1xuICAgICAgICAgICAgICAgIGFjdGlvbjogXCJ2aWV3X2ludml0ZVwiLFxuICAgICAgICAgICAgICAgIHJvb21JZDogcm9vbS5yb29tSWQsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIG9uRmluaXNoZWQoKTtcbiAgICAgICAgfTtcblxuICAgICAgICBpbnZpdGVPcHRpb24gPSA8SWNvbml6ZWRDb250ZXh0TWVudU9wdGlvblxuICAgICAgICAgICAgb25DbGljaz17b25JbnZpdGVDbGlja31cbiAgICAgICAgICAgIGxhYmVsPXtfdChcIkludml0ZVwiKX1cbiAgICAgICAgICAgIGljb25DbGFzc05hbWU9XCJteF9Sb29tVGlsZV9pY29uSW52aXRlXCJcbiAgICAgICAgLz47XG4gICAgfVxuXG4gICAgbGV0IGZhdm91cml0ZU9wdGlvbjogSlNYLkVsZW1lbnQ7XG4gICAgbGV0IGxvd1ByaW9yaXR5T3B0aW9uOiBKU1guRWxlbWVudDtcbiAgICBsZXQgbm90aWZpY2F0aW9uT3B0aW9uOiBKU1guRWxlbWVudDtcbiAgICBpZiAocm9vbS5nZXRNeU1lbWJlcnNoaXAoKSA9PT0gXCJqb2luXCIpIHtcbiAgICAgICAgY29uc3QgaXNGYXZvcml0ZSA9IHJvb21UYWdzLmluY2x1ZGVzKERlZmF1bHRUYWdJRC5GYXZvdXJpdGUpO1xuICAgICAgICBmYXZvdXJpdGVPcHRpb24gPSA8SWNvbml6ZWRDb250ZXh0TWVudUNoZWNrYm94XG4gICAgICAgICAgICBvbkNsaWNrPXsoZSkgPT4gb25UYWdSb29tKGUsIERlZmF1bHRUYWdJRC5GYXZvdXJpdGUpfVxuICAgICAgICAgICAgYWN0aXZlPXtpc0Zhdm9yaXRlfVxuICAgICAgICAgICAgbGFiZWw9e2lzRmF2b3JpdGUgPyBfdChcIkZhdm91cml0ZWRcIikgOiBfdChcIkZhdm91cml0ZVwiKX1cbiAgICAgICAgICAgIGljb25DbGFzc05hbWU9XCJteF9Sb29tVGlsZV9pY29uU3RhclwiXG4gICAgICAgIC8+O1xuXG4gICAgICAgIGNvbnN0IGlzTG93UHJpb3JpdHkgPSByb29tVGFncy5pbmNsdWRlcyhEZWZhdWx0VGFnSUQuTG93UHJpb3JpdHkpO1xuICAgICAgICBsb3dQcmlvcml0eU9wdGlvbiA9IDxJY29uaXplZENvbnRleHRNZW51Q2hlY2tib3hcbiAgICAgICAgICAgIG9uQ2xpY2s9eyhlKSA9PiBvblRhZ1Jvb20oZSwgRGVmYXVsdFRhZ0lELkxvd1ByaW9yaXR5KX1cbiAgICAgICAgICAgIGFjdGl2ZT17aXNMb3dQcmlvcml0eX1cbiAgICAgICAgICAgIGxhYmVsPXtfdChcIkxvdyBwcmlvcml0eVwiKX1cbiAgICAgICAgICAgIGljb25DbGFzc05hbWU9XCJteF9Sb29tVGlsZV9pY29uQXJyb3dEb3duXCJcbiAgICAgICAgLz47XG5cbiAgICAgICAgY29uc3QgZWNob0NoYW1iZXIgPSBFY2hvQ2hhbWJlci5mb3JSb29tKHJvb20pO1xuICAgICAgICBsZXQgbm90aWZpY2F0aW9uTGFiZWw6IHN0cmluZztcbiAgICAgICAgbGV0IGljb25DbGFzc05hbWU6IHN0cmluZztcbiAgICAgICAgc3dpdGNoIChlY2hvQ2hhbWJlci5ub3RpZmljYXRpb25Wb2x1bWUpIHtcbiAgICAgICAgICAgIGNhc2UgUm9vbU5vdGlmU3RhdGUuQWxsTWVzc2FnZXM6XG4gICAgICAgICAgICAgICAgbm90aWZpY2F0aW9uTGFiZWwgPSBfdChcIkRlZmF1bHRcIik7XG4gICAgICAgICAgICAgICAgaWNvbkNsYXNzTmFtZSA9IFwibXhfUm9vbVRpbGVfaWNvbk5vdGlmaWNhdGlvbnNEZWZhdWx0XCI7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFJvb21Ob3RpZlN0YXRlLkFsbE1lc3NhZ2VzTG91ZDpcbiAgICAgICAgICAgICAgICBub3RpZmljYXRpb25MYWJlbCA9IF90KFwiQWxsIG1lc3NhZ2VzXCIpO1xuICAgICAgICAgICAgICAgIGljb25DbGFzc05hbWUgPSBcIm14X1Jvb21UaWxlX2ljb25Ob3RpZmljYXRpb25zQWxsTWVzc2FnZXNcIjtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgUm9vbU5vdGlmU3RhdGUuTWVudGlvbnNPbmx5OlxuICAgICAgICAgICAgICAgIG5vdGlmaWNhdGlvbkxhYmVsID0gX3QoXCJNZW50aW9ucyBvbmx5XCIpO1xuICAgICAgICAgICAgICAgIGljb25DbGFzc05hbWUgPSBcIm14X1Jvb21UaWxlX2ljb25Ob3RpZmljYXRpb25zTWVudGlvbnNLZXl3b3Jkc1wiO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBSb29tTm90aWZTdGF0ZS5NdXRlOlxuICAgICAgICAgICAgICAgIG5vdGlmaWNhdGlvbkxhYmVsID0gX3QoXCJNdXRlXCIpO1xuICAgICAgICAgICAgICAgIGljb25DbGFzc05hbWUgPSBcIm14X1Jvb21UaWxlX2ljb25Ob3RpZmljYXRpb25zTm9uZVwiO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG5cbiAgICAgICAgbm90aWZpY2F0aW9uT3B0aW9uID0gPEljb25pemVkQ29udGV4dE1lbnVPcHRpb25cbiAgICAgICAgICAgIG9uQ2xpY2s9eyhldjogQnV0dG9uRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIGV2LnN0b3BQcm9wYWdhdGlvbigpO1xuXG4gICAgICAgICAgICAgICAgZGlzLmRpc3BhdGNoKHtcbiAgICAgICAgICAgICAgICAgICAgYWN0aW9uOiBcIm9wZW5fcm9vbV9zZXR0aW5nc1wiLFxuICAgICAgICAgICAgICAgICAgICByb29tX2lkOiByb29tLnJvb21JZCxcbiAgICAgICAgICAgICAgICAgICAgaW5pdGlhbF90YWJfaWQ6IFJPT01fTk9USUZJQ0FUSU9OU19UQUIsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgb25GaW5pc2hlZCgpO1xuICAgICAgICAgICAgfX1cbiAgICAgICAgICAgIGxhYmVsPXtfdChcIk5vdGlmaWNhdGlvbnNcIil9XG4gICAgICAgICAgICBpY29uQ2xhc3NOYW1lPXtpY29uQ2xhc3NOYW1lfVxuICAgICAgICA+XG4gICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9XCJteF9JY29uaXplZENvbnRleHRNZW51X3N1YmxhYmVsXCI+XG4gICAgICAgICAgICAgICAgeyBub3RpZmljYXRpb25MYWJlbCB9XG4gICAgICAgICAgICA8L3NwYW4+XG4gICAgICAgIDwvSWNvbml6ZWRDb250ZXh0TWVudU9wdGlvbj47XG4gICAgfVxuXG4gICAgY29uc3Qgb25UYWdSb29tID0gKGV2OiBCdXR0b25FdmVudCwgdGFnSWQ6IFRhZ0lEKSA9PiB7XG4gICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIGV2LnN0b3BQcm9wYWdhdGlvbigpO1xuXG4gICAgICAgIGlmICh0YWdJZCA9PT0gRGVmYXVsdFRhZ0lELkZhdm91cml0ZSB8fCB0YWdJZCA9PT0gRGVmYXVsdFRhZ0lELkxvd1ByaW9yaXR5KSB7XG4gICAgICAgICAgICBjb25zdCBpbnZlcnNlVGFnID0gdGFnSWQgPT09IERlZmF1bHRUYWdJRC5GYXZvdXJpdGUgPyBEZWZhdWx0VGFnSUQuTG93UHJpb3JpdHkgOiBEZWZhdWx0VGFnSUQuRmF2b3VyaXRlO1xuICAgICAgICAgICAgY29uc3QgaXNBcHBsaWVkID0gUm9vbUxpc3RTdG9yZS5pbnN0YW5jZS5nZXRUYWdzRm9yUm9vbShyb29tKS5pbmNsdWRlcyh0YWdJZCk7XG4gICAgICAgICAgICBjb25zdCByZW1vdmVUYWcgPSBpc0FwcGxpZWQgPyB0YWdJZCA6IGludmVyc2VUYWc7XG4gICAgICAgICAgICBjb25zdCBhZGRUYWcgPSBpc0FwcGxpZWQgPyBudWxsIDogdGFnSWQ7XG4gICAgICAgICAgICBkaXMuZGlzcGF0Y2goUm9vbUxpc3RBY3Rpb25zLnRhZ1Jvb20oY2xpLCByb29tLCByZW1vdmVUYWcsIGFkZFRhZywgdW5kZWZpbmVkLCAwKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsb2dnZXIud2FybihgVW5leHBlY3RlZCB0YWcgJHt0YWdJZH0gYXBwbGllZCB0byAke3Jvb20ucm9vbUlkfWApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKChldiBhcyBSZWFjdC5LZXlib2FyZEV2ZW50KS5rZXkgPT09IEtleS5FTlRFUikge1xuICAgICAgICAgICAgLy8gSW1wbGVtZW50cyBodHRwczovL3d3dy53My5vcmcvVFIvd2FpLWFyaWEtcHJhY3RpY2VzLyNrZXlib2FyZC1pbnRlcmFjdGlvbi0xMlxuICAgICAgICAgICAgb25GaW5pc2hlZCgpO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIGNvbnN0IGVuc3VyZVZpZXdpbmdSb29tID0gKCkgPT4ge1xuICAgICAgICBpZiAoUm9vbVZpZXdTdG9yZS5nZXRSb29tSWQoKSA9PT0gcm9vbS5yb29tSWQpIHJldHVybjtcbiAgICAgICAgZGlzLmRpc3BhdGNoKHtcbiAgICAgICAgICAgIGFjdGlvbjogXCJ2aWV3X3Jvb21cIixcbiAgICAgICAgICAgIHJvb21faWQ6IHJvb20ucm9vbUlkLFxuICAgICAgICB9LCB0cnVlKTtcbiAgICB9O1xuXG4gICAgcmV0dXJuIDxJY29uaXplZENvbnRleHRNZW51IHsuLi5wcm9wc30gb25GaW5pc2hlZD17b25GaW5pc2hlZH0gY2xhc3NOYW1lPVwibXhfUm9vbVRpbGVfY29udGV4dE1lbnVcIiBjb21wYWN0PlxuICAgICAgICA8SWNvbml6ZWRDb250ZXh0TWVudU9wdGlvbkxpc3Q+XG4gICAgICAgICAgICB7IGludml0ZU9wdGlvbiB9XG4gICAgICAgICAgICB7IG5vdGlmaWNhdGlvbk9wdGlvbiB9XG4gICAgICAgICAgICB7IGZhdm91cml0ZU9wdGlvbiB9XG5cbiAgICAgICAgICAgIDxJY29uaXplZENvbnRleHRNZW51T3B0aW9uXG4gICAgICAgICAgICAgICAgb25DbGljaz17KGV2OiBCdXR0b25FdmVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgICAgICBldi5zdG9wUHJvcGFnYXRpb24oKTtcblxuICAgICAgICAgICAgICAgICAgICBlbnN1cmVWaWV3aW5nUm9vbSgpO1xuICAgICAgICAgICAgICAgICAgICBvblJvb21NZW1iZXJzQ2xpY2soZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICBvbkZpbmlzaGVkKCk7XG4gICAgICAgICAgICAgICAgfX1cbiAgICAgICAgICAgICAgICBsYWJlbD17X3QoXCJQZW9wbGVcIil9XG4gICAgICAgICAgICAgICAgaWNvbkNsYXNzTmFtZT1cIm14X1Jvb21UaWxlX2ljb25QZW9wbGVcIlxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT1cIm14X0ljb25pemVkQ29udGV4dE1lbnVfc3VibGFiZWxcIj5cbiAgICAgICAgICAgICAgICAgICAgeyByb29tLmdldEpvaW5lZE1lbWJlckNvdW50KCkgfVxuICAgICAgICAgICAgICAgIDwvc3Bhbj5cbiAgICAgICAgICAgIDwvSWNvbml6ZWRDb250ZXh0TWVudU9wdGlvbj5cblxuICAgICAgICAgICAgPEljb25pemVkQ29udGV4dE1lbnVPcHRpb25cbiAgICAgICAgICAgICAgICBvbkNsaWNrPXsoZXY6IEJ1dHRvbkV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgIGV2LnN0b3BQcm9wYWdhdGlvbigpO1xuXG4gICAgICAgICAgICAgICAgICAgIGVuc3VyZVZpZXdpbmdSb29tKCk7XG4gICAgICAgICAgICAgICAgICAgIG9uUm9vbUZpbGVzQ2xpY2soZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICBvbkZpbmlzaGVkKCk7XG4gICAgICAgICAgICAgICAgfX1cbiAgICAgICAgICAgICAgICBsYWJlbD17X3QoXCJGaWxlc1wiKX1cbiAgICAgICAgICAgICAgICBpY29uQ2xhc3NOYW1lPVwibXhfUm9vbVRpbGVfaWNvbkZpbGVzXCJcbiAgICAgICAgICAgIC8+XG5cbiAgICAgICAgICAgIDxJY29uaXplZENvbnRleHRNZW51T3B0aW9uXG4gICAgICAgICAgICAgICAgb25DbGljaz17KGV2OiBCdXR0b25FdmVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgICAgICBldi5zdG9wUHJvcGFnYXRpb24oKTtcblxuICAgICAgICAgICAgICAgICAgICBlbnN1cmVWaWV3aW5nUm9vbSgpO1xuICAgICAgICAgICAgICAgICAgICBkZWZhdWx0RGlzcGF0Y2hlci5kaXNwYXRjaDxTZXRSaWdodFBhbmVsUGhhc2VQYXlsb2FkPih7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb246IEFjdGlvbi5TZXRSaWdodFBhbmVsUGhhc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICBwaGFzZTogUmlnaHRQYW5lbFBoYXNlcy5Sb29tU3VtbWFyeSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFsbG93Q2xvc2U6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgb25GaW5pc2hlZCgpO1xuICAgICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAgICAgbGFiZWw9e190KFwiV2lkZ2V0c1wiKX1cbiAgICAgICAgICAgICAgICBpY29uQ2xhc3NOYW1lPVwibXhfUm9vbVRpbGVfaWNvbldpZGdldHNcIlxuICAgICAgICAgICAgLz5cblxuICAgICAgICAgICAgeyBsb3dQcmlvcml0eU9wdGlvbiB9XG5cbiAgICAgICAgICAgIDxJY29uaXplZENvbnRleHRNZW51T3B0aW9uXG4gICAgICAgICAgICAgICAgb25DbGljaz17KGV2OiBCdXR0b25FdmVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgICAgICBldi5zdG9wUHJvcGFnYXRpb24oKTtcblxuICAgICAgICAgICAgICAgICAgICBkaXMuZGlzcGF0Y2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uOiBcImNvcHlfcm9vbVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgcm9vbV9pZDogcm9vbS5yb29tSWQsXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBvbkZpbmlzaGVkKCk7XG4gICAgICAgICAgICAgICAgfX1cbiAgICAgICAgICAgICAgICBsYWJlbD17X3QoXCJDb3B5IGxpbmtcIil9XG4gICAgICAgICAgICAgICAgaWNvbkNsYXNzTmFtZT1cIm14X1Jvb21UaWxlX2ljb25Db3B5TGlua1wiXG4gICAgICAgICAgICAvPlxuXG4gICAgICAgICAgICA8SWNvbml6ZWRDb250ZXh0TWVudU9wdGlvblxuICAgICAgICAgICAgICAgIG9uQ2xpY2s9eyhldjogQnV0dG9uRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICAgICAgZXYuc3RvcFByb3BhZ2F0aW9uKCk7XG5cbiAgICAgICAgICAgICAgICAgICAgZGlzLmRpc3BhdGNoKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbjogXCJvcGVuX3Jvb21fc2V0dGluZ3NcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvb21faWQ6IHJvb20ucm9vbUlkLFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgb25GaW5pc2hlZCgpO1xuICAgICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAgICAgbGFiZWw9e190KFwiU2V0dGluZ3NcIil9XG4gICAgICAgICAgICAgICAgaWNvbkNsYXNzTmFtZT1cIm14X1Jvb21UaWxlX2ljb25TZXR0aW5nc1wiXG4gICAgICAgICAgICAvPlxuXG4gICAgICAgICAgICA8SWNvbml6ZWRDb250ZXh0TWVudU9wdGlvblxuICAgICAgICAgICAgICAgIG9uQ2xpY2s9eyhldjogQnV0dG9uRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICAgICAgZXYuc3RvcFByb3BhZ2F0aW9uKCk7XG5cbiAgICAgICAgICAgICAgICAgICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZygnRXhwb3J0IHJvb20gZGlhbG9nJywgJycsIEV4cG9ydERpYWxvZywgeyByb29tIH0pO1xuICAgICAgICAgICAgICAgICAgICBvbkZpbmlzaGVkKCk7XG4gICAgICAgICAgICAgICAgfX1cbiAgICAgICAgICAgICAgICBsYWJlbD17X3QoXCJFeHBvcnQgY2hhdFwiKX1cbiAgICAgICAgICAgICAgICBpY29uQ2xhc3NOYW1lPVwibXhfUm9vbVRpbGVfaWNvbkV4cG9ydFwiXG4gICAgICAgICAgICAvPlxuXG4gICAgICAgICAgICB7IGxlYXZlT3B0aW9uIH1cbiAgICAgICAgPC9JY29uaXplZENvbnRleHRNZW51T3B0aW9uTGlzdD5cbiAgICA8L0ljb25pemVkQ29udGV4dE1lbnU+O1xufTtcblxuZXhwb3J0IGRlZmF1bHQgUm9vbUNvbnRleHRNZW51O1xuXG4iXX0=