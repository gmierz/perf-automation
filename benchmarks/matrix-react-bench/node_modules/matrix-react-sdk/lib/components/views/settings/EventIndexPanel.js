"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _languageHandler = require("../../../languageHandler");

var _SdkConfig = _interopRequireDefault(require("../../../SdkConfig"));

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _SettingsStore = _interopRequireDefault(require("../../../settings/SettingsStore"));

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _FormattingUtils = require("../../../utils/FormattingUtils");

var _EventIndexPeg = _interopRequireDefault(require("../../../indexing/EventIndexPeg"));

var _SettingLevel = require("../../../settings/SettingLevel");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _SeshatResetDialog = _interopRequireDefault(require("../dialogs/SeshatResetDialog"));

var _InlineSpinner = _interopRequireDefault(require("../elements/InlineSpinner"));

var _dec, _class;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

let EventIndexPanel = (_dec = (0, _replaceableComponent.replaceableComponent)("views.settings.EventIndexPanel"), _dec(_class = class EventIndexPanel extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "updateCurrentRoom", async room => {
      const eventIndex = _EventIndexPeg.default.get();

      let stats;

      try {
        stats = await eventIndex.getStats();
      } catch {
        // This call may fail if sporadically, not a huge issue as we will
        // try later again and probably succeed.
        return;
      }

      this.setState({
        eventIndexSize: stats.size,
        roomCount: stats.roomCount
      });
    });
    (0, _defineProperty2.default)(this, "onManage", async () => {
      _Modal.default.createTrackedDialogAsync('Message search', 'Message search', // @ts-ignore: TS doesn't seem to like the type of this now that it
      // has also been converted to TS as well, but I can't figure out why...
      Promise.resolve().then(() => _interopRequireWildcard(require('../../../async-components/views/dialogs/eventindex/ManageEventIndexDialog'))), {
        onFinished: () => {}
      }, null,
      /* priority = */
      false,
      /* static = */
      true);
    });
    (0, _defineProperty2.default)(this, "onEnable", async () => {
      this.setState({
        enabling: true
      });
      await _EventIndexPeg.default.initEventIndex();
      await _EventIndexPeg.default.get().addInitialCheckpoints();
      await _EventIndexPeg.default.get().startCrawler();
      await _SettingsStore.default.setValue('enableEventIndexing', null, _SettingLevel.SettingLevel.DEVICE, true);
      await this.updateState();
    });
    (0, _defineProperty2.default)(this, "confirmEventStoreReset", () => {
      const {
        close
      } = _Modal.default.createDialog(_SeshatResetDialog.default, {
        onFinished: async success => {
          if (success) {
            await _SettingsStore.default.setValue('enableEventIndexing', null, _SettingLevel.SettingLevel.DEVICE, false);
            await _EventIndexPeg.default.deleteEventIndex();
            await this.onEnable();
            close();
          }
        }
      });
    });
    this.state = {
      enabling: false,
      eventIndexSize: 0,
      roomCount: 0,
      eventIndexingEnabled: _SettingsStore.default.getValueAt(_SettingLevel.SettingLevel.DEVICE, 'enableEventIndexing')
    };
  }

  componentWillUnmount() {
    const eventIndex = _EventIndexPeg.default.get();

    if (eventIndex !== null) {
      eventIndex.removeListener("changedCheckpoint", this.updateCurrentRoom);
    }
  }

  componentDidMount() {
    this.updateState();
  }

  async updateState() {
    const eventIndex = _EventIndexPeg.default.get();

    const eventIndexingEnabled = _SettingsStore.default.getValueAt(_SettingLevel.SettingLevel.DEVICE, 'enableEventIndexing');

    const enabling = false;
    let eventIndexSize = 0;
    let roomCount = 0;

    if (eventIndex !== null) {
      eventIndex.on("changedCheckpoint", this.updateCurrentRoom);

      try {
        const stats = await eventIndex.getStats();
        eventIndexSize = stats.size;
        roomCount = stats.roomCount;
      } catch {// This call may fail if sporadically, not a huge issue as we
        // will try later again in the updateCurrentRoom call and
        // probably succeed.
      }
    }

    this.setState({
      enabling,
      eventIndexSize,
      roomCount,
      eventIndexingEnabled
    });
  }

  render() {
    let eventIndexingSettings = null;

    const brand = _SdkConfig.default.get().brand;

    if (_EventIndexPeg.default.get() !== null) {
      eventIndexingSettings = /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_SettingsTab_subsectionText"
      }, (0, _languageHandler._t)("Securely cache encrypted messages locally for them " + "to appear in search results, using %(size)s to store messages from %(rooms)s rooms.", {
        size: (0, _FormattingUtils.formatBytes)(this.state.eventIndexSize, 0),
        // This drives the singular / plural string
        // selection for "room" / "rooms" only.
        count: this.state.roomCount,
        rooms: (0, _FormattingUtils.formatCountLong)(this.state.roomCount)
      })), /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        kind: "primary",
        onClick: this.onManage
      }, (0, _languageHandler._t)("Manage"))));
    } else if (!this.state.eventIndexingEnabled && _EventIndexPeg.default.supportIsInstalled()) {
      eventIndexingSettings = /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_SettingsTab_subsectionText"
      }, (0, _languageHandler._t)("Securely cache encrypted messages locally for them to " + "appear in search results.")), /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        kind: "primary",
        disabled: this.state.enabling,
        onClick: this.onEnable
      }, (0, _languageHandler._t)("Enable")), this.state.enabling ? /*#__PURE__*/_react.default.createElement(_InlineSpinner.default, null) : /*#__PURE__*/_react.default.createElement("div", null)));
    } else if (_EventIndexPeg.default.platformHasSupport() && !_EventIndexPeg.default.supportIsInstalled()) {
      const nativeLink = "https://github.com/vector-im/element-desktop/blob/develop/" + "docs/native-node-modules.md#" + "adding-seshat-for-search-in-e2e-encrypted-rooms";
      eventIndexingSettings = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_SettingsTab_subsectionText"
      }, (0, _languageHandler._t)("%(brand)s is missing some components required for securely " + "caching encrypted messages locally. If you'd like to " + "experiment with this feature, build a custom %(brand)s Desktop " + "with <nativeLink>search components added</nativeLink>.", {
        brand
      }, {
        nativeLink: sub => /*#__PURE__*/_react.default.createElement("a", {
          href: nativeLink,
          target: "_blank",
          rel: "noreferrer noopener"
        }, sub)
      }));
    } else if (!_EventIndexPeg.default.platformHasSupport()) {
      eventIndexingSettings = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_SettingsTab_subsectionText"
      }, (0, _languageHandler._t)("%(brand)s can't securely cache encrypted messages locally " + "while running in a web browser. Use <desktopLink>%(brand)s Desktop</desktopLink> " + "for encrypted messages to appear in search results.", {
        brand
      }, {
        desktopLink: sub => /*#__PURE__*/_react.default.createElement("a", {
          href: "https://element.io/get-started",
          target: "_blank",
          rel: "noreferrer noopener"
        }, sub)
      }));
    } else {
      eventIndexingSettings = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_SettingsTab_subsectionText"
      }, /*#__PURE__*/_react.default.createElement("p", null, this.state.enabling ? /*#__PURE__*/_react.default.createElement(_InlineSpinner.default, null) : (0, _languageHandler._t)("Message search initialisation failed")), _EventIndexPeg.default.error && /*#__PURE__*/_react.default.createElement("details", null, /*#__PURE__*/_react.default.createElement("summary", null, (0, _languageHandler._t)("Advanced")), /*#__PURE__*/_react.default.createElement("code", null, _EventIndexPeg.default.error.message), /*#__PURE__*/_react.default.createElement("p", null, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        key: "delete",
        kind: "danger",
        onClick: this.confirmEventStoreReset
      }, (0, _languageHandler._t)("Reset")))));
    }

    return eventIndexingSettings;
  }

}) || _class);
exports.default = EventIndexPanel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3NldHRpbmdzL0V2ZW50SW5kZXhQYW5lbC50c3giXSwibmFtZXMiOlsiRXZlbnRJbmRleFBhbmVsIiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwicm9vbSIsImV2ZW50SW5kZXgiLCJFdmVudEluZGV4UGVnIiwiZ2V0Iiwic3RhdHMiLCJnZXRTdGF0cyIsInNldFN0YXRlIiwiZXZlbnRJbmRleFNpemUiLCJzaXplIiwicm9vbUNvdW50IiwiTW9kYWwiLCJjcmVhdGVUcmFja2VkRGlhbG9nQXN5bmMiLCJvbkZpbmlzaGVkIiwiZW5hYmxpbmciLCJpbml0RXZlbnRJbmRleCIsImFkZEluaXRpYWxDaGVja3BvaW50cyIsInN0YXJ0Q3Jhd2xlciIsIlNldHRpbmdzU3RvcmUiLCJzZXRWYWx1ZSIsIlNldHRpbmdMZXZlbCIsIkRFVklDRSIsInVwZGF0ZVN0YXRlIiwiY2xvc2UiLCJjcmVhdGVEaWFsb2ciLCJTZXNoYXRSZXNldERpYWxvZyIsInN1Y2Nlc3MiLCJkZWxldGVFdmVudEluZGV4Iiwib25FbmFibGUiLCJzdGF0ZSIsImV2ZW50SW5kZXhpbmdFbmFibGVkIiwiZ2V0VmFsdWVBdCIsImNvbXBvbmVudFdpbGxVbm1vdW50IiwicmVtb3ZlTGlzdGVuZXIiLCJ1cGRhdGVDdXJyZW50Um9vbSIsImNvbXBvbmVudERpZE1vdW50Iiwib24iLCJyZW5kZXIiLCJldmVudEluZGV4aW5nU2V0dGluZ3MiLCJicmFuZCIsIlNka0NvbmZpZyIsImNvdW50Iiwicm9vbXMiLCJvbk1hbmFnZSIsInN1cHBvcnRJc0luc3RhbGxlZCIsInBsYXRmb3JtSGFzU3VwcG9ydCIsIm5hdGl2ZUxpbmsiLCJzdWIiLCJkZXNrdG9wTGluayIsImVycm9yIiwibWVzc2FnZSIsImNvbmZpcm1FdmVudFN0b3JlUmVzZXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUVBOztBQUNBOztB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dGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMjAtMjAyMSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5cbmltcG9ydCB7IF90IH0gZnJvbSAnLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyJztcbmltcG9ydCBTZGtDb25maWcgZnJvbSBcIi4uLy4uLy4uL1Nka0NvbmZpZ1wiO1xuaW1wb3J0IE1vZGFsIGZyb20gJy4uLy4uLy4uL01vZGFsJztcbmltcG9ydCBTZXR0aW5nc1N0b3JlIGZyb20gXCIuLi8uLi8uLi9zZXR0aW5ncy9TZXR0aW5nc1N0b3JlXCI7XG5pbXBvcnQgQWNjZXNzaWJsZUJ1dHRvbiBmcm9tIFwiLi4vZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvblwiO1xuaW1wb3J0IHsgZm9ybWF0Qnl0ZXMsIGZvcm1hdENvdW50TG9uZyB9IGZyb20gXCIuLi8uLi8uLi91dGlscy9Gb3JtYXR0aW5nVXRpbHNcIjtcbmltcG9ydCBFdmVudEluZGV4UGVnIGZyb20gXCIuLi8uLi8uLi9pbmRleGluZy9FdmVudEluZGV4UGVnXCI7XG5pbXBvcnQgeyBTZXR0aW5nTGV2ZWwgfSBmcm9tIFwiLi4vLi4vLi4vc2V0dGluZ3MvU2V0dGluZ0xldmVsXCI7XG5pbXBvcnQgeyByZXBsYWNlYWJsZUNvbXBvbmVudCB9IGZyb20gXCIuLi8uLi8uLi91dGlscy9yZXBsYWNlYWJsZUNvbXBvbmVudFwiO1xuaW1wb3J0IFNlc2hhdFJlc2V0RGlhbG9nIGZyb20gJy4uL2RpYWxvZ3MvU2VzaGF0UmVzZXREaWFsb2cnO1xuaW1wb3J0IElubGluZVNwaW5uZXIgZnJvbSAnLi4vZWxlbWVudHMvSW5saW5lU3Bpbm5lcic7XG5cbmludGVyZmFjZSBJU3RhdGUge1xuICAgIGVuYWJsaW5nOiBib29sZWFuO1xuICAgIGV2ZW50SW5kZXhTaXplOiBudW1iZXI7XG4gICAgcm9vbUNvdW50OiBudW1iZXI7XG4gICAgZXZlbnRJbmRleGluZ0VuYWJsZWQ6IGJvb2xlYW47XG59XG5cbkByZXBsYWNlYWJsZUNvbXBvbmVudChcInZpZXdzLnNldHRpbmdzLkV2ZW50SW5kZXhQYW5lbFwiKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRXZlbnRJbmRleFBhbmVsIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PHt9LCBJU3RhdGU+IHtcbiAgICBjb25zdHJ1Y3Rvcihwcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG5cbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIGVuYWJsaW5nOiBmYWxzZSxcbiAgICAgICAgICAgIGV2ZW50SW5kZXhTaXplOiAwLFxuICAgICAgICAgICAgcm9vbUNvdW50OiAwLFxuICAgICAgICAgICAgZXZlbnRJbmRleGluZ0VuYWJsZWQ6XG4gICAgICAgICAgICAgICAgU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZUF0KFNldHRpbmdMZXZlbC5ERVZJQ0UsICdlbmFibGVFdmVudEluZGV4aW5nJyksXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgdXBkYXRlQ3VycmVudFJvb20gPSBhc3luYyAocm9vbSkgPT4ge1xuICAgICAgICBjb25zdCBldmVudEluZGV4ID0gRXZlbnRJbmRleFBlZy5nZXQoKTtcbiAgICAgICAgbGV0IHN0YXRzO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBzdGF0cyA9IGF3YWl0IGV2ZW50SW5kZXguZ2V0U3RhdHMoKTtcbiAgICAgICAgfSBjYXRjaCB7XG4gICAgICAgICAgICAvLyBUaGlzIGNhbGwgbWF5IGZhaWwgaWYgc3BvcmFkaWNhbGx5LCBub3QgYSBodWdlIGlzc3VlIGFzIHdlIHdpbGxcbiAgICAgICAgICAgIC8vIHRyeSBsYXRlciBhZ2FpbiBhbmQgcHJvYmFibHkgc3VjY2VlZC5cbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgZXZlbnRJbmRleFNpemU6IHN0YXRzLnNpemUsXG4gICAgICAgICAgICByb29tQ291bnQ6IHN0YXRzLnJvb21Db3VudCxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50KCk6IHZvaWQge1xuICAgICAgICBjb25zdCBldmVudEluZGV4ID0gRXZlbnRJbmRleFBlZy5nZXQoKTtcblxuICAgICAgICBpZiAoZXZlbnRJbmRleCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgZXZlbnRJbmRleC5yZW1vdmVMaXN0ZW5lcihcImNoYW5nZWRDaGVja3BvaW50XCIsIHRoaXMudXBkYXRlQ3VycmVudFJvb20pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29tcG9uZW50RGlkTW91bnQoKTogdm9pZCB7XG4gICAgICAgIHRoaXMudXBkYXRlU3RhdGUoKTtcbiAgICB9XG5cbiAgICBhc3luYyB1cGRhdGVTdGF0ZSgpIHtcbiAgICAgICAgY29uc3QgZXZlbnRJbmRleCA9IEV2ZW50SW5kZXhQZWcuZ2V0KCk7XG4gICAgICAgIGNvbnN0IGV2ZW50SW5kZXhpbmdFbmFibGVkID0gU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZUF0KFNldHRpbmdMZXZlbC5ERVZJQ0UsICdlbmFibGVFdmVudEluZGV4aW5nJyk7XG4gICAgICAgIGNvbnN0IGVuYWJsaW5nID0gZmFsc2U7XG5cbiAgICAgICAgbGV0IGV2ZW50SW5kZXhTaXplID0gMDtcbiAgICAgICAgbGV0IHJvb21Db3VudCA9IDA7XG5cbiAgICAgICAgaWYgKGV2ZW50SW5kZXggIT09IG51bGwpIHtcbiAgICAgICAgICAgIGV2ZW50SW5kZXgub24oXCJjaGFuZ2VkQ2hlY2twb2ludFwiLCB0aGlzLnVwZGF0ZUN1cnJlbnRSb29tKTtcblxuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb25zdCBzdGF0cyA9IGF3YWl0IGV2ZW50SW5kZXguZ2V0U3RhdHMoKTtcbiAgICAgICAgICAgICAgICBldmVudEluZGV4U2l6ZSA9IHN0YXRzLnNpemU7XG4gICAgICAgICAgICAgICAgcm9vbUNvdW50ID0gc3RhdHMucm9vbUNvdW50O1xuICAgICAgICAgICAgfSBjYXRjaCB7XG4gICAgICAgICAgICAgICAgLy8gVGhpcyBjYWxsIG1heSBmYWlsIGlmIHNwb3JhZGljYWxseSwgbm90IGEgaHVnZSBpc3N1ZSBhcyB3ZVxuICAgICAgICAgICAgICAgIC8vIHdpbGwgdHJ5IGxhdGVyIGFnYWluIGluIHRoZSB1cGRhdGVDdXJyZW50Um9vbSBjYWxsIGFuZFxuICAgICAgICAgICAgICAgIC8vIHByb2JhYmx5IHN1Y2NlZWQuXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIGVuYWJsaW5nLFxuICAgICAgICAgICAgZXZlbnRJbmRleFNpemUsXG4gICAgICAgICAgICByb29tQ291bnQsXG4gICAgICAgICAgICBldmVudEluZGV4aW5nRW5hYmxlZCxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbk1hbmFnZSA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZ0FzeW5jKCdNZXNzYWdlIHNlYXJjaCcsICdNZXNzYWdlIHNlYXJjaCcsXG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlOiBUUyBkb2Vzbid0IHNlZW0gdG8gbGlrZSB0aGUgdHlwZSBvZiB0aGlzIG5vdyB0aGF0IGl0XG4gICAgICAgICAgICAvLyBoYXMgYWxzbyBiZWVuIGNvbnZlcnRlZCB0byBUUyBhcyB3ZWxsLCBidXQgSSBjYW4ndCBmaWd1cmUgb3V0IHdoeS4uLlxuICAgICAgICAgICAgaW1wb3J0KCcuLi8uLi8uLi9hc3luYy1jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvZXZlbnRpbmRleC9NYW5hZ2VFdmVudEluZGV4RGlhbG9nJyksXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgb25GaW5pc2hlZDogKCkgPT4ge30sXG4gICAgICAgICAgICB9LCBudWxsLCAvKiBwcmlvcml0eSA9ICovIGZhbHNlLCAvKiBzdGF0aWMgPSAqLyB0cnVlLFxuICAgICAgICApO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uRW5hYmxlID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIGVuYWJsaW5nOiB0cnVlLFxuICAgICAgICB9KTtcblxuICAgICAgICBhd2FpdCBFdmVudEluZGV4UGVnLmluaXRFdmVudEluZGV4KCk7XG4gICAgICAgIGF3YWl0IEV2ZW50SW5kZXhQZWcuZ2V0KCkuYWRkSW5pdGlhbENoZWNrcG9pbnRzKCk7XG4gICAgICAgIGF3YWl0IEV2ZW50SW5kZXhQZWcuZ2V0KCkuc3RhcnRDcmF3bGVyKCk7XG4gICAgICAgIGF3YWl0IFNldHRpbmdzU3RvcmUuc2V0VmFsdWUoJ2VuYWJsZUV2ZW50SW5kZXhpbmcnLCBudWxsLCBTZXR0aW5nTGV2ZWwuREVWSUNFLCB0cnVlKTtcbiAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVTdGF0ZSgpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIGNvbmZpcm1FdmVudFN0b3JlUmVzZXQgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHsgY2xvc2UgfSA9IE1vZGFsLmNyZWF0ZURpYWxvZyhTZXNoYXRSZXNldERpYWxvZywge1xuICAgICAgICAgICAgb25GaW5pc2hlZDogYXN5bmMgKHN1Y2Nlc3MpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoc3VjY2Vzcykge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBTZXR0aW5nc1N0b3JlLnNldFZhbHVlKCdlbmFibGVFdmVudEluZGV4aW5nJywgbnVsbCwgU2V0dGluZ0xldmVsLkRFVklDRSwgZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBFdmVudEluZGV4UGVnLmRlbGV0ZUV2ZW50SW5kZXgoKTtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5vbkVuYWJsZSgpO1xuICAgICAgICAgICAgICAgICAgICBjbG9zZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIGxldCBldmVudEluZGV4aW5nU2V0dGluZ3MgPSBudWxsO1xuICAgICAgICBjb25zdCBicmFuZCA9IFNka0NvbmZpZy5nZXQoKS5icmFuZDtcblxuICAgICAgICBpZiAoRXZlbnRJbmRleFBlZy5nZXQoKSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgZXZlbnRJbmRleGluZ1NldHRpbmdzID0gKFxuICAgICAgICAgICAgICAgIDxkaXY+XG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdteF9TZXR0aW5nc1RhYl9zdWJzZWN0aW9uVGV4dCc+eyBfdChcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiU2VjdXJlbHkgY2FjaGUgZW5jcnlwdGVkIG1lc3NhZ2VzIGxvY2FsbHkgZm9yIHRoZW0gXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJ0byBhcHBlYXIgaW4gc2VhcmNoIHJlc3VsdHMsIHVzaW5nICUoc2l6ZSlzIHRvIHN0b3JlIG1lc3NhZ2VzIGZyb20gJShyb29tcylzIHJvb21zLlwiLFxuICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpemU6IGZvcm1hdEJ5dGVzKHRoaXMuc3RhdGUuZXZlbnRJbmRleFNpemUsIDApLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgZHJpdmVzIHRoZSBzaW5ndWxhciAvIHBsdXJhbCBzdHJpbmdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzZWxlY3Rpb24gZm9yIFwicm9vbVwiIC8gXCJyb29tc1wiIG9ubHkuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY291bnQ6IHRoaXMuc3RhdGUucm9vbUNvdW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvb21zOiBmb3JtYXRDb3VudExvbmcodGhpcy5zdGF0ZS5yb29tQ291bnQpLFxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgKSB9PC9kaXY+XG4gICAgICAgICAgICAgICAgICAgIDxkaXY+XG4gICAgICAgICAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvbiBraW5kPVwicHJpbWFyeVwiIG9uQ2xpY2s9e3RoaXMub25NYW5hZ2V9PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCJNYW5hZ2VcIikgfVxuICAgICAgICAgICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSBpZiAoIXRoaXMuc3RhdGUuZXZlbnRJbmRleGluZ0VuYWJsZWQgJiYgRXZlbnRJbmRleFBlZy5zdXBwb3J0SXNJbnN0YWxsZWQoKSkge1xuICAgICAgICAgICAgZXZlbnRJbmRleGluZ1NldHRpbmdzID0gKFxuICAgICAgICAgICAgICAgIDxkaXY+XG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdteF9TZXR0aW5nc1RhYl9zdWJzZWN0aW9uVGV4dCc+eyBfdChcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiU2VjdXJlbHkgY2FjaGUgZW5jcnlwdGVkIG1lc3NhZ2VzIGxvY2FsbHkgZm9yIHRoZW0gdG8gXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJhcHBlYXIgaW4gc2VhcmNoIHJlc3VsdHMuXCIsXG4gICAgICAgICAgICAgICAgICAgICkgfTwvZGl2PlxuICAgICAgICAgICAgICAgICAgICA8ZGl2PlxuICAgICAgICAgICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b25cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBraW5kPVwicHJpbWFyeVwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWQ9e3RoaXMuc3RhdGUuZW5hYmxpbmd9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5vbkVuYWJsZX1cbiAgICAgICAgICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IF90KFwiRW5hYmxlXCIpIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgdGhpcy5zdGF0ZS5lbmFibGluZyA/IDxJbmxpbmVTcGlubmVyIC8+IDogPGRpdiAvPiB9XG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIGlmIChFdmVudEluZGV4UGVnLnBsYXRmb3JtSGFzU3VwcG9ydCgpICYmICFFdmVudEluZGV4UGVnLnN1cHBvcnRJc0luc3RhbGxlZCgpKSB7XG4gICAgICAgICAgICBjb25zdCBuYXRpdmVMaW5rID0gKFxuICAgICAgICAgICAgICAgIFwiaHR0cHM6Ly9naXRodWIuY29tL3ZlY3Rvci1pbS9lbGVtZW50LWRlc2t0b3AvYmxvYi9kZXZlbG9wL1wiICtcbiAgICAgICAgICAgICAgICBcImRvY3MvbmF0aXZlLW5vZGUtbW9kdWxlcy5tZCNcIiArXG4gICAgICAgICAgICAgICAgXCJhZGRpbmctc2VzaGF0LWZvci1zZWFyY2gtaW4tZTJlLWVuY3J5cHRlZC1yb29tc1wiXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBldmVudEluZGV4aW5nU2V0dGluZ3MgPSAoXG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J214X1NldHRpbmdzVGFiX3N1YnNlY3Rpb25UZXh0Jz57IF90KFxuICAgICAgICAgICAgICAgICAgICBcIiUoYnJhbmQpcyBpcyBtaXNzaW5nIHNvbWUgY29tcG9uZW50cyByZXF1aXJlZCBmb3Igc2VjdXJlbHkgXCIgK1xuICAgICAgICAgICAgICAgICAgICBcImNhY2hpbmcgZW5jcnlwdGVkIG1lc3NhZ2VzIGxvY2FsbHkuIElmIHlvdSdkIGxpa2UgdG8gXCIgK1xuICAgICAgICAgICAgICAgICAgICBcImV4cGVyaW1lbnQgd2l0aCB0aGlzIGZlYXR1cmUsIGJ1aWxkIGEgY3VzdG9tICUoYnJhbmQpcyBEZXNrdG9wIFwiICtcbiAgICAgICAgICAgICAgICAgICAgXCJ3aXRoIDxuYXRpdmVMaW5rPnNlYXJjaCBjb21wb25lbnRzIGFkZGVkPC9uYXRpdmVMaW5rPi5cIixcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJhbmQsXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hdGl2ZUxpbms6IHN1YiA9PiA8YVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhyZWY9e25hdGl2ZUxpbmt9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0PVwiX2JsYW5rXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWw9XCJub3JlZmVycmVyIG5vb3BlbmVyXCJcbiAgICAgICAgICAgICAgICAgICAgICAgID57IHN1YiB9PC9hPixcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICApIH08L2Rpdj5cbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSBpZiAoIUV2ZW50SW5kZXhQZWcucGxhdGZvcm1IYXNTdXBwb3J0KCkpIHtcbiAgICAgICAgICAgIGV2ZW50SW5kZXhpbmdTZXR0aW5ncyA9IChcbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nbXhfU2V0dGluZ3NUYWJfc3Vic2VjdGlvblRleHQnPnsgX3QoXG4gICAgICAgICAgICAgICAgICAgIFwiJShicmFuZClzIGNhbid0IHNlY3VyZWx5IGNhY2hlIGVuY3J5cHRlZCBtZXNzYWdlcyBsb2NhbGx5IFwiICtcbiAgICAgICAgICAgICAgICAgICAgXCJ3aGlsZSBydW5uaW5nIGluIGEgd2ViIGJyb3dzZXIuIFVzZSA8ZGVza3RvcExpbms+JShicmFuZClzIERlc2t0b3A8L2Rlc2t0b3BMaW5rPiBcIiArXG4gICAgICAgICAgICAgICAgICAgIFwiZm9yIGVuY3J5cHRlZCBtZXNzYWdlcyB0byBhcHBlYXIgaW4gc2VhcmNoIHJlc3VsdHMuXCIsXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyYW5kLFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkZXNrdG9wTGluazogc3ViID0+IDxhXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaHJlZj1cImh0dHBzOi8vZWxlbWVudC5pby9nZXQtc3RhcnRlZFwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0PVwiX2JsYW5rXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWw9XCJub3JlZmVycmVyIG5vb3BlbmVyXCJcbiAgICAgICAgICAgICAgICAgICAgICAgID57IHN1YiB9PC9hPixcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICApIH08L2Rpdj5cbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBldmVudEluZGV4aW5nU2V0dGluZ3MgPSAoXG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J214X1NldHRpbmdzVGFiX3N1YnNlY3Rpb25UZXh0Jz5cbiAgICAgICAgICAgICAgICAgICAgPHA+XG4gICAgICAgICAgICAgICAgICAgICAgICB7IHRoaXMuc3RhdGUuZW5hYmxpbmdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IDxJbmxpbmVTcGlubmVyIC8+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBfdChcIk1lc3NhZ2Ugc2VhcmNoIGluaXRpYWxpc2F0aW9uIGZhaWxlZFwiKVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICA8L3A+XG4gICAgICAgICAgICAgICAgICAgIHsgRXZlbnRJbmRleFBlZy5lcnJvciAmJiAoXG4gICAgICAgICAgICAgICAgICAgICAgICA8ZGV0YWlscz5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3VtbWFyeT57IF90KFwiQWR2YW5jZWRcIikgfTwvc3VtbWFyeT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8Y29kZT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBFdmVudEluZGV4UGVnLmVycm9yLm1lc3NhZ2UgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvY29kZT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8cD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b24ga2V5PVwiZGVsZXRlXCIga2luZD1cImRhbmdlclwiIG9uQ2xpY2s9e3RoaXMuY29uZmlybUV2ZW50U3RvcmVSZXNldH0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IF90KFwiUmVzZXRcIikgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9wPlxuICAgICAgICAgICAgICAgICAgICAgICAgPC9kZXRhaWxzPlxuICAgICAgICAgICAgICAgICAgICApIH1cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZXZlbnRJbmRleGluZ1NldHRpbmdzO1xuICAgIH1cbn1cbiJdfQ==