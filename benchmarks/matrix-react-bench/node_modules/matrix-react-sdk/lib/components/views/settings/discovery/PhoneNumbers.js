"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.PhoneNumber = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _languageHandler = require("../../../../languageHandler");

var _MatrixClientPeg = require("../../../../MatrixClientPeg");

var _Modal = _interopRequireDefault(require("../../../../Modal"));

var _AddThreepid = _interopRequireDefault(require("../../../../AddThreepid"));

var _replaceableComponent = require("../../../../utils/replaceableComponent");

var _ErrorDialog = _interopRequireDefault(require("../../dialogs/ErrorDialog"));

var _Field = _interopRequireDefault(require("../../elements/Field"));

var _AccessibleButton = _interopRequireDefault(require("../../elements/AccessibleButton"));

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class;

class PhoneNumber extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onRevokeClick", e => {
      e.stopPropagation();
      e.preventDefault();
      this.changeBinding({
        bind: false,
        label: "revoke",
        errorTitle: (0, _languageHandler._t)("Unable to revoke sharing for phone number")
      });
    });
    (0, _defineProperty2.default)(this, "onShareClick", e => {
      e.stopPropagation();
      e.preventDefault();
      this.changeBinding({
        bind: true,
        label: "share",
        errorTitle: (0, _languageHandler._t)("Unable to share phone number")
      });
    });
    (0, _defineProperty2.default)(this, "onVerificationCodeChange", e => {
      this.setState({
        verificationCode: e.target.value
      });
    });
    (0, _defineProperty2.default)(this, "onContinueClick", async e => {
      e.stopPropagation();
      e.preventDefault();
      this.setState({
        continueDisabled: true
      });
      const token = this.state.verificationCode;

      try {
        await this.state.addTask.haveMsisdnToken(token);
        this.setState({
          addTask: null,
          continueDisabled: false,
          verifying: false,
          verifyError: null,
          verificationCode: ""
        });
      } catch (err) {
        this.setState({
          continueDisabled: false
        });

        if (err.errcode !== 'M_THREEPID_AUTH_FAILED') {
          _logger.logger.error("Unable to verify phone number: " + err);

          _Modal.default.createTrackedDialog('Unable to verify phone number', '', _ErrorDialog.default, {
            title: (0, _languageHandler._t)("Unable to verify phone number."),
            description: err && err.message ? err.message : (0, _languageHandler._t)("Operation failed")
          });
        } else {
          this.setState({
            verifyError: (0, _languageHandler._t)("Incorrect verification code")
          });
        }
      }
    });
    const {
      bound
    } = props.msisdn;
    this.state = {
      verifying: false,
      verificationCode: "",
      addTask: null,
      continueDisabled: false,
      bound,
      verifyError: null
    };
  } // TODO: [REACT-WARNING] Replace with appropriate lifecycle event
  // eslint-disable-next-line @typescript-eslint/naming-convention, camelcase


  UNSAFE_componentWillReceiveProps(nextProps) {
    const {
      bound
    } = nextProps.msisdn;
    this.setState({
      bound
    });
  }

  async changeBinding({
    bind,
    label,
    errorTitle
  }) {
    if (!(await _MatrixClientPeg.MatrixClientPeg.get().doesServerSupportSeparateAddAndBind())) {
      return this.changeBindingTangledAddBind({
        bind,
        label,
        errorTitle
      });
    }

    const {
      medium,
      address
    } = this.props.msisdn;

    try {
      if (bind) {
        const task = new _AddThreepid.default();
        this.setState({
          verifying: true,
          continueDisabled: true,
          addTask: task
        }); // XXX: Sydent will accept a number without country code if you add
        // a leading plus sign to a number in E.164 format (which the 3PID
        // address is), but this goes against the spec.
        // See https://github.com/matrix-org/matrix-doc/issues/2222

        await task.bindMsisdn(null, `+${address}`);
        this.setState({
          continueDisabled: false
        });
      } else {
        await _MatrixClientPeg.MatrixClientPeg.get().unbindThreePid(medium, address);
      }

      this.setState({
        bound: bind
      });
    } catch (err) {
      _logger.logger.error(`Unable to ${label} phone number ${address} ${err}`);

      this.setState({
        verifying: false,
        continueDisabled: false,
        addTask: null
      });

      _Modal.default.createTrackedDialog(`Unable to ${label} phone number`, '', _ErrorDialog.default, {
        title: errorTitle,
        description: err && err.message ? err.message : (0, _languageHandler._t)("Operation failed")
      });
    }
  }

  async changeBindingTangledAddBind({
    bind,
    label,
    errorTitle
  }) {
    const {
      medium,
      address
    } = this.props.msisdn;
    const task = new _AddThreepid.default();
    this.setState({
      verifying: true,
      continueDisabled: true,
      addTask: task
    });

    try {
      await _MatrixClientPeg.MatrixClientPeg.get().deleteThreePid(medium, address); // XXX: Sydent will accept a number without country code if you add
      // a leading plus sign to a number in E.164 format (which the 3PID
      // address is), but this goes against the spec.
      // See https://github.com/matrix-org/matrix-doc/issues/2222

      if (bind) {
        await task.bindMsisdn(null, `+${address}`);
      } else {
        await task.addMsisdn(null, `+${address}`);
      }

      this.setState({
        continueDisabled: false,
        bound: bind
      });
    } catch (err) {
      _logger.logger.error(`Unable to ${label} phone number ${address} ${err}`);

      this.setState({
        verifying: false,
        continueDisabled: false,
        addTask: null
      });

      _Modal.default.createTrackedDialog(`Unable to ${label} phone number`, '', _ErrorDialog.default, {
        title: errorTitle,
        description: err && err.message ? err.message : (0, _languageHandler._t)("Operation failed")
      });
    }
  }

  render() {
    const {
      address
    } = this.props.msisdn;
    const {
      verifying,
      bound
    } = this.state;
    let status;

    if (verifying) {
      status = /*#__PURE__*/_react.default.createElement("span", {
        className: "mx_ExistingPhoneNumber_verification"
      }, /*#__PURE__*/_react.default.createElement("span", null, (0, _languageHandler._t)("Please enter verification code sent via text."), /*#__PURE__*/_react.default.createElement("br", null), this.state.verifyError), /*#__PURE__*/_react.default.createElement("form", {
        onSubmit: this.onContinueClick,
        autoComplete: "off",
        noValidate: true
      }, /*#__PURE__*/_react.default.createElement(_Field.default, {
        type: "text",
        label: (0, _languageHandler._t)("Verification code"),
        autoComplete: "off",
        disabled: this.state.continueDisabled,
        value: this.state.verificationCode,
        onChange: this.onVerificationCodeChange
      })));
    } else if (bound) {
      status = /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        className: "mx_ExistingPhoneNumber_confirmBtn",
        kind: "danger_sm",
        onClick: this.onRevokeClick
      }, (0, _languageHandler._t)("Revoke"));
    } else {
      status = /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        className: "mx_ExistingPhoneNumber_confirmBtn",
        kind: "primary_sm",
        onClick: this.onShareClick
      }, (0, _languageHandler._t)("Share"));
    }

    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_ExistingPhoneNumber"
    }, /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_ExistingPhoneNumber_address"
    }, "+", address), status);
  }

}

exports.PhoneNumber = PhoneNumber;
let PhoneNumbers = (_dec = (0, _replaceableComponent.replaceableComponent)("views.settings.discovery.PhoneNumbers"), _dec(_class = class PhoneNumbers extends _react.default.Component {
  render() {
    let content;

    if (this.props.msisdns.length > 0) {
      content = this.props.msisdns.map(e => {
        return /*#__PURE__*/_react.default.createElement(PhoneNumber, {
          msisdn: e,
          key: e.address
        });
      });
    } else {
      content = /*#__PURE__*/_react.default.createElement("span", {
        className: "mx_SettingsTab_subsectionText"
      }, (0, _languageHandler._t)("Discovery options will appear once you have added a phone number above."));
    }

    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_PhoneNumbers"
    }, content);
  }

}) || _class);
exports.default = PhoneNumbers;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3NldHRpbmdzL2Rpc2NvdmVyeS9QaG9uZU51bWJlcnMudHN4Il0sIm5hbWVzIjpbIlBob25lTnVtYmVyIiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwiZSIsInN0b3BQcm9wYWdhdGlvbiIsInByZXZlbnREZWZhdWx0IiwiY2hhbmdlQmluZGluZyIsImJpbmQiLCJsYWJlbCIsImVycm9yVGl0bGUiLCJzZXRTdGF0ZSIsInZlcmlmaWNhdGlvbkNvZGUiLCJ0YXJnZXQiLCJ2YWx1ZSIsImNvbnRpbnVlRGlzYWJsZWQiLCJ0b2tlbiIsInN0YXRlIiwiYWRkVGFzayIsImhhdmVNc2lzZG5Ub2tlbiIsInZlcmlmeWluZyIsInZlcmlmeUVycm9yIiwiZXJyIiwiZXJyY29kZSIsImxvZ2dlciIsImVycm9yIiwiTW9kYWwiLCJjcmVhdGVUcmFja2VkRGlhbG9nIiwiRXJyb3JEaWFsb2ciLCJ0aXRsZSIsImRlc2NyaXB0aW9uIiwibWVzc2FnZSIsImJvdW5kIiwibXNpc2RuIiwiVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMiLCJuZXh0UHJvcHMiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJkb2VzU2VydmVyU3VwcG9ydFNlcGFyYXRlQWRkQW5kQmluZCIsImNoYW5nZUJpbmRpbmdUYW5nbGVkQWRkQmluZCIsIm1lZGl1bSIsImFkZHJlc3MiLCJ0YXNrIiwiQWRkVGhyZWVwaWQiLCJiaW5kTXNpc2RuIiwidW5iaW5kVGhyZWVQaWQiLCJkZWxldGVUaHJlZVBpZCIsImFkZE1zaXNkbiIsInJlbmRlciIsInN0YXR1cyIsIm9uQ29udGludWVDbGljayIsIm9uVmVyaWZpY2F0aW9uQ29kZUNoYW5nZSIsIm9uUmV2b2tlQ2xpY2siLCJvblNoYXJlQ2xpY2siLCJQaG9uZU51bWJlcnMiLCJjb250ZW50IiwibXNpc2RucyIsImxlbmd0aCIsIm1hcCJdLCJtYXBwaW5n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QUFDO0FBQWYsb0JBQ0k7QUFBTSxNQUFBLFNBQVMsRUFBQztBQUFoQixZQUFvRFosT0FBcEQsQ0FESixFQUVNUSxNQUZOLENBREo7QUFNSDs7QUE3TWtGOzs7SUFxTmxFSyxZLFdBRHBCLGdEQUFxQix1Q0FBckIsQyxnQkFBRCxNQUNxQkEsWUFEckIsU0FDMEN0RCxlQUFNQyxTQURoRCxDQUNrRTtBQUN2RCtDLEVBQUFBLE1BQU0sR0FBZ0I7QUFDekIsUUFBSU8sT0FBSjs7QUFDQSxRQUFJLEtBQUtwRCxLQUFMLENBQVdxRCxPQUFYLENBQW1CQyxNQUFuQixHQUE0QixDQUFoQyxFQUFtQztBQUMvQkYsTUFBQUEsT0FBTyxHQUFHLEtBQUtwRCxLQUFMLENBQVdxRCxPQUFYLENBQW1CRSxHQUFuQixDQUF3QnRELENBQUQsSUFBTztBQUNwQyw0QkFBTyw2QkFBQyxXQUFEO0FBQWEsVUFBQSxNQUFNLEVBQUVBLENBQXJCO0FBQXdCLFVBQUEsR0FBRyxFQUFFQSxDQUFDLENBQUNxQztBQUEvQixVQUFQO0FBQ0gsT0FGUyxDQUFWO0FBR0gsS0FKRCxNQUlPO0FBQ0hjLE1BQUFBLE9BQU8sZ0JBQUc7QUFBTSxRQUFBLFNBQVMsRUFBQztBQUFoQixTQUNKLHlCQUFHLHlFQUFILENBREksQ0FBVjtBQUdIOztBQUVELHdCQUNJO0FBQUssTUFBQSxTQUFTLEVBQUM7QUFBZixPQUNNQSxPQUROLENBREo7QUFLSDs7QUFsQjZELEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTkgTmV3IFZlY3RvciBMdGRcbkNvcHlyaWdodCAyMDE5IFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcblxuaW1wb3J0IHsgX3QgfSBmcm9tIFwiLi4vLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyXCI7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tIFwiLi4vLi4vLi4vLi4vTWF0cml4Q2xpZW50UGVnXCI7XG5pbXBvcnQgTW9kYWwgZnJvbSAnLi4vLi4vLi4vLi4vTW9kYWwnO1xuaW1wb3J0IEFkZFRocmVlcGlkIGZyb20gJy4uLy4uLy4uLy4uL0FkZFRocmVlcGlkJztcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5pbXBvcnQgeyBJVGhyZWVwaWQgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvQHR5cGVzL3RocmVlcGlkc1wiO1xuaW1wb3J0IEVycm9yRGlhbG9nIGZyb20gXCIuLi8uLi9kaWFsb2dzL0Vycm9yRGlhbG9nXCI7XG5pbXBvcnQgRmllbGQgZnJvbSBcIi4uLy4uL2VsZW1lbnRzL0ZpZWxkXCI7XG5pbXBvcnQgQWNjZXNzaWJsZUJ1dHRvbiBmcm9tIFwiLi4vLi4vZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvblwiO1xuXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbG9nZ2VyXCI7XG5cbi8qXG5UT0RPOiBJbXByb3ZlIHRoZSBVWCBmb3IgZXZlcnl0aGluZyBpbiBoZXJlLlxuVGhpcyBpcyBhIGNvcHkvcGFzdGUgb2YgRW1haWxBZGRyZXNzZXMsIG1vc3RseS5cbiAqL1xuXG4vLyBUT0RPOiBDb21iaW5lIEVtYWlsQWRkcmVzc2VzIGFuZCBQaG9uZU51bWJlcnMgdG8gYmUgM3BpZCBhZ25vc3RpY1xuXG5pbnRlcmZhY2UgSVBob25lTnVtYmVyUHJvcHMge1xuICAgIG1zaXNkbjogSVRocmVlcGlkO1xufVxuXG5pbnRlcmZhY2UgSVBob25lTnVtYmVyU3RhdGUge1xuICAgIHZlcmlmeWluZzogYm9vbGVhbjtcbiAgICB2ZXJpZmljYXRpb25Db2RlOiBzdHJpbmc7XG4gICAgYWRkVGFzazogYW55OyAvLyBGSVhNRTogV2hlbiBBZGRUaHJlZXBpZCBpcyBUU2ZpZWRcbiAgICBjb250aW51ZURpc2FibGVkOiBib29sZWFuO1xuICAgIGJvdW5kOiBib29sZWFuO1xuICAgIHZlcmlmeUVycm9yOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjbGFzcyBQaG9uZU51bWJlciBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxJUGhvbmVOdW1iZXJQcm9wcywgSVBob25lTnVtYmVyU3RhdGU+IHtcbiAgICBjb25zdHJ1Y3Rvcihwcm9wczogSVBob25lTnVtYmVyUHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuXG4gICAgICAgIGNvbnN0IHsgYm91bmQgfSA9IHByb3BzLm1zaXNkbjtcblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgdmVyaWZ5aW5nOiBmYWxzZSxcbiAgICAgICAgICAgIHZlcmlmaWNhdGlvbkNvZGU6IFwiXCIsXG4gICAgICAgICAgICBhZGRUYXNrOiBudWxsLFxuICAgICAgICAgICAgY29udGludWVEaXNhYmxlZDogZmFsc2UsXG4gICAgICAgICAgICBib3VuZCxcbiAgICAgICAgICAgIHZlcmlmeUVycm9yOiBudWxsLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIC8vIFRPRE86IFtSRUFDVC1XQVJOSU5HXSBSZXBsYWNlIHdpdGggYXBwcm9wcmlhdGUgbGlmZWN5Y2xlIGV2ZW50XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uYW1pbmctY29udmVudGlvbiwgY2FtZWxjYXNlXG4gICAgcHVibGljIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5leHRQcm9wczogSVBob25lTnVtYmVyUHJvcHMpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgeyBib3VuZCB9ID0gbmV4dFByb3BzLm1zaXNkbjtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGJvdW5kIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgY2hhbmdlQmluZGluZyh7IGJpbmQsIGxhYmVsLCBlcnJvclRpdGxlIH0pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgaWYgKCEoYXdhaXQgTWF0cml4Q2xpZW50UGVnLmdldCgpLmRvZXNTZXJ2ZXJTdXBwb3J0U2VwYXJhdGVBZGRBbmRCaW5kKCkpKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jaGFuZ2VCaW5kaW5nVGFuZ2xlZEFkZEJpbmQoeyBiaW5kLCBsYWJlbCwgZXJyb3JUaXRsZSB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHsgbWVkaXVtLCBhZGRyZXNzIH0gPSB0aGlzLnByb3BzLm1zaXNkbjtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgaWYgKGJpbmQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB0YXNrID0gbmV3IEFkZFRocmVlcGlkKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgICAgIHZlcmlmeWluZzogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgY29udGludWVEaXNhYmxlZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgYWRkVGFzazogdGFzayxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAvLyBYWFg6IFN5ZGVudCB3aWxsIGFjY2VwdCBhIG51bWJlciB3aXRob3V0IGNvdW50cnkgY29kZSBpZiB5b3UgYWRkXG4gICAgICAgICAgICAgICAgLy8gYSBsZWFkaW5nIHBsdXMgc2lnbiB0byBhIG51bWJlciBpbiBFLjE2NCBmb3JtYXQgKHdoaWNoIHRoZSAzUElEXG4gICAgICAgICAgICAgICAgLy8gYWRkcmVzcyBpcyksIGJ1dCB0aGlzIGdvZXMgYWdhaW5zdCB0aGUgc3BlYy5cbiAgICAgICAgICAgICAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL21hdHJpeC1vcmcvbWF0cml4LWRvYy9pc3N1ZXMvMjIyMlxuICAgICAgICAgICAgICAgIGF3YWl0IHRhc2suYmluZE1zaXNkbihudWxsLCBgKyR7YWRkcmVzc31gKTtcbiAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWVEaXNhYmxlZDogZmFsc2UsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGF3YWl0IE1hdHJpeENsaWVudFBlZy5nZXQoKS51bmJpbmRUaHJlZVBpZChtZWRpdW0sIGFkZHJlc3MpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGJvdW5kOiBiaW5kIH0pO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihgVW5hYmxlIHRvICR7bGFiZWx9IHBob25lIG51bWJlciAke2FkZHJlc3N9ICR7ZXJyfWApO1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgdmVyaWZ5aW5nOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBjb250aW51ZURpc2FibGVkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBhZGRUYXNrOiBudWxsLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nKGBVbmFibGUgdG8gJHtsYWJlbH0gcGhvbmUgbnVtYmVyYCwgJycsIEVycm9yRGlhbG9nLCB7XG4gICAgICAgICAgICAgICAgdGl0bGU6IGVycm9yVGl0bGUsXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICgoZXJyICYmIGVyci5tZXNzYWdlKSA/IGVyci5tZXNzYWdlIDogX3QoXCJPcGVyYXRpb24gZmFpbGVkXCIpKSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBjaGFuZ2VCaW5kaW5nVGFuZ2xlZEFkZEJpbmQoeyBiaW5kLCBsYWJlbCwgZXJyb3JUaXRsZSB9KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IHsgbWVkaXVtLCBhZGRyZXNzIH0gPSB0aGlzLnByb3BzLm1zaXNkbjtcblxuICAgICAgICBjb25zdCB0YXNrID0gbmV3IEFkZFRocmVlcGlkKCk7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgdmVyaWZ5aW5nOiB0cnVlLFxuICAgICAgICAgICAgY29udGludWVEaXNhYmxlZDogdHJ1ZSxcbiAgICAgICAgICAgIGFkZFRhc2s6IHRhc2ssXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZGVsZXRlVGhyZWVQaWQobWVkaXVtLCBhZGRyZXNzKTtcbiAgICAgICAgICAgIC8vIFhYWDogU3lkZW50IHdpbGwgYWNjZXB0IGEgbnVtYmVyIHdpdGhvdXQgY291bnRyeSBjb2RlIGlmIHlvdSBhZGRcbiAgICAgICAgICAgIC8vIGEgbGVhZGluZyBwbHVzIHNpZ24gdG8gYSBudW1iZXIgaW4gRS4xNjQgZm9ybWF0ICh3aGljaCB0aGUgM1BJRFxuICAgICAgICAgICAgLy8gYWRkcmVzcyBpcyksIGJ1dCB0aGlzIGdvZXMgYWdhaW5zdCB0aGUgc3BlYy5cbiAgICAgICAgICAgIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vbWF0cml4LW9yZy9tYXRyaXgtZG9jL2lzc3Vlcy8yMjIyXG4gICAgICAgICAgICBpZiAoYmluZCkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRhc2suYmluZE1zaXNkbihudWxsLCBgKyR7YWRkcmVzc31gKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGFzay5hZGRNc2lzZG4obnVsbCwgYCske2FkZHJlc3N9YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICBjb250aW51ZURpc2FibGVkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBib3VuZDogYmluZCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihgVW5hYmxlIHRvICR7bGFiZWx9IHBob25lIG51bWJlciAke2FkZHJlc3N9ICR7ZXJyfWApO1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgdmVyaWZ5aW5nOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBjb250aW51ZURpc2FibGVkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBhZGRUYXNrOiBudWxsLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nKGBVbmFibGUgdG8gJHtsYWJlbH0gcGhvbmUgbnVtYmVyYCwgJycsIEVycm9yRGlhbG9nLCB7XG4gICAgICAgICAgICAgICAgdGl0bGU6IGVycm9yVGl0bGUsXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICgoZXJyICYmIGVyci5tZXNzYWdlKSA/IGVyci5tZXNzYWdlIDogX3QoXCJPcGVyYXRpb24gZmFpbGVkXCIpKSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvblJldm9rZUNsaWNrID0gKGU6IFJlYWN0Lk1vdXNlRXZlbnQpOiB2b2lkID0+IHtcbiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICB0aGlzLmNoYW5nZUJpbmRpbmcoe1xuICAgICAgICAgICAgYmluZDogZmFsc2UsXG4gICAgICAgICAgICBsYWJlbDogXCJyZXZva2VcIixcbiAgICAgICAgICAgIGVycm9yVGl0bGU6IF90KFwiVW5hYmxlIHRvIHJldm9rZSBzaGFyaW5nIGZvciBwaG9uZSBudW1iZXJcIiksXG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uU2hhcmVDbGljayA9IChlOiBSZWFjdC5Nb3VzZUV2ZW50KTogdm9pZCA9PiB7XG4gICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgdGhpcy5jaGFuZ2VCaW5kaW5nKHtcbiAgICAgICAgICAgIGJpbmQ6IHRydWUsXG4gICAgICAgICAgICBsYWJlbDogXCJzaGFyZVwiLFxuICAgICAgICAgICAgZXJyb3JUaXRsZTogX3QoXCJVbmFibGUgdG8gc2hhcmUgcGhvbmUgbnVtYmVyXCIpLFxuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvblZlcmlmaWNhdGlvbkNvZGVDaGFuZ2UgPSAoZTogUmVhY3QuQ2hhbmdlRXZlbnQ8SFRNTElucHV0RWxlbWVudD4pOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICB2ZXJpZmljYXRpb25Db2RlOiBlLnRhcmdldC52YWx1ZSxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25Db250aW51ZUNsaWNrID0gYXN5bmMgKGU6IFJlYWN0Lk1vdXNlRXZlbnQgfCBSZWFjdC5Gb3JtRXZlbnQpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBjb250aW51ZURpc2FibGVkOiB0cnVlIH0pO1xuICAgICAgICBjb25zdCB0b2tlbiA9IHRoaXMuc3RhdGUudmVyaWZpY2F0aW9uQ29kZTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc3RhdGUuYWRkVGFzay5oYXZlTXNpc2RuVG9rZW4odG9rZW4pO1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgYWRkVGFzazogbnVsbCxcbiAgICAgICAgICAgICAgICBjb250aW51ZURpc2FibGVkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICB2ZXJpZnlpbmc6IGZhbHNlLFxuICAgICAgICAgICAgICAgIHZlcmlmeUVycm9yOiBudWxsLFxuICAgICAgICAgICAgICAgIHZlcmlmaWNhdGlvbkNvZGU6IFwiXCIsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgY29udGludWVEaXNhYmxlZDogZmFsc2UgfSk7XG4gICAgICAgICAgICBpZiAoZXJyLmVycmNvZGUgIT09ICdNX1RIUkVFUElEX0FVVEhfRkFJTEVEJykge1xuICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihcIlVuYWJsZSB0byB2ZXJpZnkgcGhvbmUgbnVtYmVyOiBcIiArIGVycik7XG4gICAgICAgICAgICAgICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZygnVW5hYmxlIHRvIHZlcmlmeSBwaG9uZSBudW1iZXInLCAnJywgRXJyb3JEaWFsb2csIHtcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6IF90KFwiVW5hYmxlIHRvIHZlcmlmeSBwaG9uZSBudW1iZXIuXCIpLFxuICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogKChlcnIgJiYgZXJyLm1lc3NhZ2UpID8gZXJyLm1lc3NhZ2UgOiBfdChcIk9wZXJhdGlvbiBmYWlsZWRcIikpLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgdmVyaWZ5RXJyb3I6IF90KFwiSW5jb3JyZWN0IHZlcmlmaWNhdGlvbiBjb2RlXCIpIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfTtcblxuICAgIHB1YmxpYyByZW5kZXIoKTogSlNYLkVsZW1lbnQge1xuICAgICAgICBjb25zdCB7IGFkZHJlc3MgfSA9IHRoaXMucHJvcHMubXNpc2RuO1xuICAgICAgICBjb25zdCB7IHZlcmlmeWluZywgYm91bmQgfSA9IHRoaXMuc3RhdGU7XG5cbiAgICAgICAgbGV0IHN0YXR1cztcbiAgICAgICAgaWYgKHZlcmlmeWluZykge1xuICAgICAgICAgICAgc3RhdHVzID0gPHNwYW4gY2xhc3NOYW1lPVwibXhfRXhpc3RpbmdQaG9uZU51bWJlcl92ZXJpZmljYXRpb25cIj5cbiAgICAgICAgICAgICAgICA8c3Bhbj5cbiAgICAgICAgICAgICAgICAgICAgeyBfdChcIlBsZWFzZSBlbnRlciB2ZXJpZmljYXRpb24gY29kZSBzZW50IHZpYSB0ZXh0LlwiKSB9XG4gICAgICAgICAgICAgICAgICAgIDxiciAvPlxuICAgICAgICAgICAgICAgICAgICB7IHRoaXMuc3RhdGUudmVyaWZ5RXJyb3IgfVxuICAgICAgICAgICAgICAgIDwvc3Bhbj5cbiAgICAgICAgICAgICAgICA8Zm9ybSBvblN1Ym1pdD17dGhpcy5vbkNvbnRpbnVlQ2xpY2t9IGF1dG9Db21wbGV0ZT1cIm9mZlwiIG5vVmFsaWRhdGU9e3RydWV9PlxuICAgICAgICAgICAgICAgICAgICA8RmllbGRcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU9XCJ0ZXh0XCJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsPXtfdChcIlZlcmlmaWNhdGlvbiBjb2RlXCIpfVxuICAgICAgICAgICAgICAgICAgICAgICAgYXV0b0NvbXBsZXRlPVwib2ZmXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVkPXt0aGlzLnN0YXRlLmNvbnRpbnVlRGlzYWJsZWR9XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZT17dGhpcy5zdGF0ZS52ZXJpZmljYXRpb25Db2RlfVxuICAgICAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2U9e3RoaXMub25WZXJpZmljYXRpb25Db2RlQ2hhbmdlfVxuICAgICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgIDwvZm9ybT5cbiAgICAgICAgICAgIDwvc3Bhbj47XG4gICAgICAgIH0gZWxzZSBpZiAoYm91bmQpIHtcbiAgICAgICAgICAgIHN0YXR1cyA9IDxBY2Nlc3NpYmxlQnV0dG9uXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfRXhpc3RpbmdQaG9uZU51bWJlcl9jb25maXJtQnRuXCJcbiAgICAgICAgICAgICAgICBraW5kPVwiZGFuZ2VyX3NtXCJcbiAgICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLm9uUmV2b2tlQ2xpY2t9XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgeyBfdChcIlJldm9rZVwiKSB9XG4gICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3RhdHVzID0gPEFjY2Vzc2libGVCdXR0b25cbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9FeGlzdGluZ1Bob25lTnVtYmVyX2NvbmZpcm1CdG5cIlxuICAgICAgICAgICAgICAgIGtpbmQ9XCJwcmltYXJ5X3NtXCJcbiAgICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLm9uU2hhcmVDbGlja31cbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICB7IF90KFwiU2hhcmVcIikgfVxuICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPjtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0V4aXN0aW5nUGhvbmVOdW1iZXJcIj5cbiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9XCJteF9FeGlzdGluZ1Bob25lTnVtYmVyX2FkZHJlc3NcIj4reyBhZGRyZXNzIH08L3NwYW4+XG4gICAgICAgICAgICAgICAgeyBzdGF0dXMgfVxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICk7XG4gICAgfVxufVxuXG5pbnRlcmZhY2UgSVByb3BzIHtcbiAgICBtc2lzZG5zOiBJVGhyZWVwaWRbXTtcbn1cblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3Muc2V0dGluZ3MuZGlzY292ZXJ5LlBob25lTnVtYmVyc1wiKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUGhvbmVOdW1iZXJzIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PElQcm9wcz4ge1xuICAgIHB1YmxpYyByZW5kZXIoKTogSlNYLkVsZW1lbnQge1xuICAgICAgICBsZXQgY29udGVudDtcbiAgICAgICAgaWYgKHRoaXMucHJvcHMubXNpc2Rucy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjb250ZW50ID0gdGhpcy5wcm9wcy5tc2lzZG5zLm1hcCgoZSkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiA8UGhvbmVOdW1iZXIgbXNpc2RuPXtlfSBrZXk9e2UuYWRkcmVzc30gLz47XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnRlbnQgPSA8c3BhbiBjbGFzc05hbWU9XCJteF9TZXR0aW5nc1RhYl9zdWJzZWN0aW9uVGV4dFwiPlxuICAgICAgICAgICAgICAgIHsgX3QoXCJEaXNjb3Zlcnkgb3B0aW9ucyB3aWxsIGFwcGVhciBvbmNlIHlvdSBoYXZlIGFkZGVkIGEgcGhvbmUgbnVtYmVyIGFib3ZlLlwiKSB9XG4gICAgICAgICAgICA8L3NwYW4+O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfUGhvbmVOdW1iZXJzXCI+XG4gICAgICAgICAgICAgICAgeyBjb250ZW50IH1cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICApO1xuICAgIH1cbn1cbiJdfQ==