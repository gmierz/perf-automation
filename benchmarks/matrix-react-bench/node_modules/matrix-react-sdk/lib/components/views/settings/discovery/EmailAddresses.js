"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.EmailAddress = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _languageHandler = require("../../../../languageHandler");

var _MatrixClientPeg = require("../../../../MatrixClientPeg");

var _Modal = _interopRequireDefault(require("../../../../Modal"));

var _AddThreepid = _interopRequireDefault(require("../../../../AddThreepid"));

var _replaceableComponent = require("../../../../utils/replaceableComponent");

var _ErrorDialog = _interopRequireDefault(require("../../dialogs/ErrorDialog"));

var _AccessibleButton = _interopRequireDefault(require("../../elements/AccessibleButton"));

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class;

class EmailAddress extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onRevokeClick", e => {
      e.stopPropagation();
      e.preventDefault();
      this.changeBinding({
        bind: false,
        label: "revoke",
        errorTitle: (0, _languageHandler._t)("Unable to revoke sharing for email address")
      });
    });
    (0, _defineProperty2.default)(this, "onShareClick", e => {
      e.stopPropagation();
      e.preventDefault();
      this.changeBinding({
        bind: true,
        label: "share",
        errorTitle: (0, _languageHandler._t)("Unable to share email address")
      });
    });
    (0, _defineProperty2.default)(this, "onContinueClick", async e => {
      e.stopPropagation();
      e.preventDefault();
      this.setState({
        continueDisabled: true
      });

      try {
        await this.state.addTask.checkEmailLinkClicked();
        this.setState({
          addTask: null,
          continueDisabled: false,
          verifying: false
        });
      } catch (err) {
        this.setState({
          continueDisabled: false
        });

        if (err.errcode === 'M_THREEPID_AUTH_FAILED') {
          _Modal.default.createTrackedDialog("E-mail hasn't been verified yet", "", _ErrorDialog.default, {
            title: (0, _languageHandler._t)("Your email address hasn't been verified yet"),
            description: (0, _languageHandler._t)("Click the link in the email you received to verify " + "and then click continue again.")
          });
        } else {
          _logger.logger.error("Unable to verify email address: " + err);

          _Modal.default.createTrackedDialog('Unable to verify email address', '', _ErrorDialog.default, {
            title: (0, _languageHandler._t)("Unable to verify email address."),
            description: err && err.message ? err.message : (0, _languageHandler._t)("Operation failed")
          });
        }
      }
    });
    const {
      bound
    } = props.email;
    this.state = {
      verifying: false,
      addTask: null,
      continueDisabled: false,
      bound
    };
  } // TODO: [REACT-WARNING] Replace with appropriate lifecycle event
  // eslint-disable-next-line @typescript-eslint/naming-convention, camelcase


  UNSAFE_componentWillReceiveProps(nextProps) {
    const {
      bound
    } = nextProps.email;
    this.setState({
      bound
    });
  }

  async changeBinding({
    bind,
    label,
    errorTitle
  }) {
    if (!(await _MatrixClientPeg.MatrixClientPeg.get().doesServerSupportSeparateAddAndBind())) {
      return this.changeBindingTangledAddBind({
        bind,
        label,
        errorTitle
      });
    }

    const {
      medium,
      address
    } = this.props.email;

    try {
      if (bind) {
        const task = new _AddThreepid.default();
        this.setState({
          verifying: true,
          continueDisabled: true,
          addTask: task
        });
        await task.bindEmailAddress(address);
        this.setState({
          continueDisabled: false
        });
      } else {
        await _MatrixClientPeg.MatrixClientPeg.get().unbindThreePid(medium, address);
      }

      this.setState({
        bound: bind
      });
    } catch (err) {
      _logger.logger.error(`Unable to ${label} email address ${address} ${err}`);

      this.setState({
        verifying: false,
        continueDisabled: false,
        addTask: null
      });

      _Modal.default.createTrackedDialog(`Unable to ${label} email address`, '', _ErrorDialog.default, {
        title: errorTitle,
        description: err && err.message ? err.message : (0, _languageHandler._t)("Operation failed")
      });
    }
  }

  async changeBindingTangledAddBind({
    bind,
    label,
    errorTitle
  }) {
    const {
      medium,
      address
    } = this.props.email;
    const task = new _AddThreepid.default();
    this.setState({
      verifying: true,
      continueDisabled: true,
      addTask: task
    });

    try {
      await _MatrixClientPeg.MatrixClientPeg.get().deleteThreePid(medium, address);

      if (bind) {
        await task.bindEmailAddress(address);
      } else {
        await task.addEmailAddress(address);
      }

      this.setState({
        continueDisabled: false,
        bound: bind
      });
    } catch (err) {
      _logger.logger.error(`Unable to ${label} email address ${address} ${err}`);

      this.setState({
        verifying: false,
        continueDisabled: false,
        addTask: null
      });

      _Modal.default.createTrackedDialog(`Unable to ${label} email address`, '', _ErrorDialog.default, {
        title: errorTitle,
        description: err && err.message ? err.message : (0, _languageHandler._t)("Operation failed")
      });
    }
  }

  render() {
    const {
      address
    } = this.props.email;
    const {
      verifying,
      bound
    } = this.state;
    let status;

    if (verifying) {
      status = /*#__PURE__*/_react.default.createElement("span", null, (0, _languageHandler._t)("Verify the link in your inbox"), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        className: "mx_ExistingEmailAddress_confirmBtn",
        kind: "primary_sm",
        onClick: this.onContinueClick,
        disabled: this.state.continueDisabled
      }, (0, _languageHandler._t)("Complete")));
    } else if (bound) {
      status = /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        className: "mx_ExistingEmailAddress_confirmBtn",
        kind: "danger_sm",
        onClick: this.onRevokeClick
      }, (0, _languageHandler._t)("Revoke"));
    } else {
      status = /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        className: "mx_ExistingEmailAddress_confirmBtn",
        kind: "primary_sm",
        onClick: this.onShareClick
      }, (0, _languageHandler._t)("Share"));
    }

    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_ExistingEmailAddress"
    }, /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_ExistingEmailAddress_email"
    }, address), status);
  }

}

exports.EmailAddress = EmailAddress;
let EmailAddresses = (_dec = (0, _replaceableComponent.replaceableComponent)("views.settings.discovery.EmailAddresses"), _dec(_class = class EmailAddresses extends _react.default.Component {
  render() {
    let content;

    if (this.props.emails.length > 0) {
      content = this.props.emails.map(e => {
        return /*#__PURE__*/_react.default.createElement(EmailAddress, {
          email: e,
          key: e.address
        });
      });
    } else {
      content = /*#__PURE__*/_react.default.createElement("span", {
        className: "mx_SettingsTab_subsectionText"
      }, (0, _languageHandler._t)("Discovery options will appear once you have added an email above."));
    }

    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_EmailAddresses"
    }, content);
  }

}) || _class);
exports.default = EmailAddresses;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3NldHRpbmdzL2Rpc2NvdmVyeS9FbWFpbEFkZHJlc3Nlcy50c3giXSwibmFtZXMiOlsiRW1haWxBZGRyZXNzIiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwiZSIsInN0b3BQcm9wYWdhdGlvbiIsInByZXZlbnREZWZhdWx0IiwiY2hhbmdlQmluZGluZyIsImJpbmQiLCJsYWJlbCIsImVycm9yVGl0bGUiLCJzZXRTdGF0ZSIsImNvbnRpbnVlRGlzYWJsZWQiLCJzdGF0ZSIsImFkZFRhc2siLCJjaGVja0VtYWlsTGlua0NsaWNrZWQiLCJ2ZXJpZnlpbmciLCJlcnIiLCJlcnJjb2RlIiwiTW9kYWwiLCJjcmVhdGVUcmFja2VkRGlhbG9nIiwiRXJyb3JEaWFsb2ciLCJ0aXRsZSIsImRlc2NyaXB0aW9uIiwibG9nZ2VyIiwiZXJyb3IiLCJtZXNzYWdlIiwiYm91bmQiLCJlbWFpbCIsIlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIiwibmV4dFByb3BzIiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0IiwiZG9lc1NlcnZlclN1cHBvcnRTZXBhcmF0ZUFkZEFuZEJpbmQiLCJjaGFuZ2VCaW5kaW5nVGFuZ2xlZEFkZEJpbmQiLCJtZWRpdW0iLCJhZGRyZXNzIiwidGFzayIsIkFkZFRocmVlcGlkIiwiYmluZEVtYWlsQWRkcmVzcyIsInVuYmluZFRocmVlUGlkIiwiZGVsZXRlVGhyZWVQaWQiLCJhZGRFbWFpbEFkZHJlc3MiLCJyZW5kZXIiLCJzdGF0dXMiLCJvbkNvbnRpbnVlQ2xpY2siLCJvblJldm9rZUNsaWNrIiwib25TaGFyZUNsaWNrIiwiRW1haWxBZGRyZXNzZXMiLCJjb250ZW50IiwiZW1haWxzIiwibGVuZ3RoIiwibWFwIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWlCQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7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Iiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE5IE5ldyBWZWN0b3IgTHRkXG5Db3B5cmlnaHQgMjAxOSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5cbmltcG9ydCB7IF90IH0gZnJvbSBcIi4uLy4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlclwiO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSBcIi4uLy4uLy4uLy4uL01hdHJpeENsaWVudFBlZ1wiO1xuaW1wb3J0IE1vZGFsIGZyb20gJy4uLy4uLy4uLy4uL01vZGFsJztcbmltcG9ydCBBZGRUaHJlZXBpZCBmcm9tICcuLi8uLi8uLi8uLi9BZGRUaHJlZXBpZCc7XG5pbXBvcnQgeyByZXBsYWNlYWJsZUNvbXBvbmVudCB9IGZyb20gXCIuLi8uLi8uLi8uLi91dGlscy9yZXBsYWNlYWJsZUNvbXBvbmVudFwiO1xuaW1wb3J0IHsgSVRocmVlcGlkIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL0B0eXBlcy90aHJlZXBpZHNcIjtcbmltcG9ydCBFcnJvckRpYWxvZyBmcm9tIFwiLi4vLi4vZGlhbG9ncy9FcnJvckRpYWxvZ1wiO1xuaW1wb3J0IEFjY2Vzc2libGVCdXR0b24gZnJvbSBcIi4uLy4uL2VsZW1lbnRzL0FjY2Vzc2libGVCdXR0b25cIjtcblxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2xvZ2dlclwiO1xuXG4vKlxuVE9ETzogSW1wcm92ZSB0aGUgVVggZm9yIGV2ZXJ5dGhpbmcgaW4gaGVyZS5cbkl0J3MgdmVyeSBtdWNoIHBsYWNlaG9sZGVyLCBidXQgaXQgZ2V0cyB0aGUgam9iIGRvbmUuIFRoZSBvbGQgd2F5IG9mIGhhbmRsaW5nXG5lbWFpbCBhZGRyZXNzZXMgaW4gdXNlciBzZXR0aW5ncyB3YXMgdG8gdXNlIGRpYWxvZ3MgdG8gY29tbXVuaWNhdGUgc3RhdGUsIGhvd2V2ZXJcbmR1ZSB0byBvdXIgZGlhbG9nIHN5c3RlbSBvdmVycmlkaW5nIGRpYWxvZ3MgKGNhdXNpbmcgdW5tb3VudHMpIHRoaXMgY3JlYXRlcyBwcm9ibGVtc1xuZm9yIGEgc2FuZSBVWC4gRm9yIGluc3RhbmNlLCB0aGUgdXNlciBjb3VsZCBlYXNpbHkgZW5kIHVwIGVudGVyaW5nIGFuIGVtYWlsIGFkZHJlc3NcbmFuZCByZWNlaXZlIGEgZGlhbG9nIHRvIHZlcmlmeSB0aGUgYWRkcmVzcywgd2hpY2ggdGhlbiBjYXVzZXMgdGhlIGNvbXBvbmVudCBoZXJlXG50byBmb3JnZXQgd2hhdCBpdCB3YXMgZG9pbmcgYW5kIHVsdGltYXRlbHkgZmFpbC4gRGlhbG9ncyBhcmUgc3RpbGwgdXNlZCBpbiBzb21lXG5wbGFjZXMgdG8gY29tbXVuaWNhdGUgZXJyb3JzIC0gdGhlc2Ugc2hvdWxkIGJlIHJlcGxhY2VkIHdpdGggaW5saW5lIHZhbGlkYXRpb24gd2hlblxudGhhdCBpcyBhdmFpbGFibGUuXG4qL1xuXG4vKlxuVE9ETzogUmVkdWNlIGFsbCB0aGUgY29weWluZyBiZXR3ZWVuIGFjY291bnQgdnMuIGRpc2NvdmVyeSBjb21wb25lbnRzLlxuKi9cblxuaW50ZXJmYWNlIElFbWFpbEFkZHJlc3NQcm9wcyB7XG4gICAgZW1haWw6IElUaHJlZXBpZDtcbn1cblxuaW50ZXJmYWNlIElFbWFpbEFkZHJlc3NTdGF0ZSB7XG4gICAgdmVyaWZ5aW5nOiBib29sZWFuO1xuICAgIGFkZFRhc2s6IGFueTsgLy8gRklYTUU6IFdoZW4gQWRkVGhyZWVwaWQgaXMgVFNmaWVkXG4gICAgY29udGludWVEaXNhYmxlZDogYm9vbGVhbjtcbiAgICBib3VuZDogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGNsYXNzIEVtYWlsQWRkcmVzcyBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxJRW1haWxBZGRyZXNzUHJvcHMsIElFbWFpbEFkZHJlc3NTdGF0ZT4ge1xuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBJRW1haWxBZGRyZXNzUHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuXG4gICAgICAgIGNvbnN0IHsgYm91bmQgfSA9IHByb3BzLmVtYWlsO1xuXG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICB2ZXJpZnlpbmc6IGZhbHNlLFxuICAgICAgICAgICAgYWRkVGFzazogbnVsbCxcbiAgICAgICAgICAgIGNvbnRpbnVlRGlzYWJsZWQ6IGZhbHNlLFxuICAgICAgICAgICAgYm91bmQsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gVE9ETzogW1JFQUNULVdBUk5JTkddIFJlcGxhY2Ugd2l0aCBhcHByb3ByaWF0ZSBsaWZlY3ljbGUgZXZlbnRcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25hbWluZy1jb252ZW50aW9uLCBjYW1lbGNhc2VcbiAgICBwdWJsaWMgVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV4dFByb3BzOiBJRW1haWxBZGRyZXNzUHJvcHMpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgeyBib3VuZCB9ID0gbmV4dFByb3BzLmVtYWlsO1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgYm91bmQgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBjaGFuZ2VCaW5kaW5nKHsgYmluZCwgbGFiZWwsIGVycm9yVGl0bGUgfSk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBpZiAoIShhd2FpdCBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZG9lc1NlcnZlclN1cHBvcnRTZXBhcmF0ZUFkZEFuZEJpbmQoKSkpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNoYW5nZUJpbmRpbmdUYW5nbGVkQWRkQmluZCh7IGJpbmQsIGxhYmVsLCBlcnJvclRpdGxlIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgeyBtZWRpdW0sIGFkZHJlc3MgfSA9IHRoaXMucHJvcHMuZW1haWw7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGlmIChiaW5kKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdGFzayA9IG5ldyBBZGRUaHJlZXBpZCgpO1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgICAgICB2ZXJpZnlpbmc6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlRGlzYWJsZWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGFkZFRhc2s6IHRhc2ssXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGFzay5iaW5kRW1haWxBZGRyZXNzKGFkZHJlc3MpO1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgICAgICBjb250aW51ZURpc2FibGVkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgTWF0cml4Q2xpZW50UGVnLmdldCgpLnVuYmluZFRocmVlUGlkKG1lZGl1bSwgYWRkcmVzcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgYm91bmQ6IGJpbmQgfSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGBVbmFibGUgdG8gJHtsYWJlbH0gZW1haWwgYWRkcmVzcyAke2FkZHJlc3N9ICR7ZXJyfWApO1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgdmVyaWZ5aW5nOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBjb250aW51ZURpc2FibGVkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBhZGRUYXNrOiBudWxsLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nKGBVbmFibGUgdG8gJHtsYWJlbH0gZW1haWwgYWRkcmVzc2AsICcnLCBFcnJvckRpYWxvZywge1xuICAgICAgICAgICAgICAgIHRpdGxlOiBlcnJvclRpdGxlLFxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAoKGVyciAmJiBlcnIubWVzc2FnZSkgPyBlcnIubWVzc2FnZSA6IF90KFwiT3BlcmF0aW9uIGZhaWxlZFwiKSksXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgY2hhbmdlQmluZGluZ1RhbmdsZWRBZGRCaW5kKHsgYmluZCwgbGFiZWwsIGVycm9yVGl0bGUgfSk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBjb25zdCB7IG1lZGl1bSwgYWRkcmVzcyB9ID0gdGhpcy5wcm9wcy5lbWFpbDtcblxuICAgICAgICBjb25zdCB0YXNrID0gbmV3IEFkZFRocmVlcGlkKCk7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgdmVyaWZ5aW5nOiB0cnVlLFxuICAgICAgICAgICAgY29udGludWVEaXNhYmxlZDogdHJ1ZSxcbiAgICAgICAgICAgIGFkZFRhc2s6IHRhc2ssXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZGVsZXRlVGhyZWVQaWQobWVkaXVtLCBhZGRyZXNzKTtcbiAgICAgICAgICAgIGlmIChiaW5kKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGFzay5iaW5kRW1haWxBZGRyZXNzKGFkZHJlc3MpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0YXNrLmFkZEVtYWlsQWRkcmVzcyhhZGRyZXNzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlRGlzYWJsZWQ6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGJvdW5kOiBiaW5kLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGBVbmFibGUgdG8gJHtsYWJlbH0gZW1haWwgYWRkcmVzcyAke2FkZHJlc3N9ICR7ZXJyfWApO1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgdmVyaWZ5aW5nOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBjb250aW51ZURpc2FibGVkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBhZGRUYXNrOiBudWxsLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nKGBVbmFibGUgdG8gJHtsYWJlbH0gZW1haWwgYWRkcmVzc2AsICcnLCBFcnJvckRpYWxvZywge1xuICAgICAgICAgICAgICAgIHRpdGxlOiBlcnJvclRpdGxlLFxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAoKGVyciAmJiBlcnIubWVzc2FnZSkgPyBlcnIubWVzc2FnZSA6IF90KFwiT3BlcmF0aW9uIGZhaWxlZFwiKSksXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgb25SZXZva2VDbGljayA9IChlOiBSZWFjdC5Nb3VzZUV2ZW50KTogdm9pZCA9PiB7XG4gICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgdGhpcy5jaGFuZ2VCaW5kaW5nKHtcbiAgICAgICAgICAgIGJpbmQ6IGZhbHNlLFxuICAgICAgICAgICAgbGFiZWw6IFwicmV2b2tlXCIsXG4gICAgICAgICAgICBlcnJvclRpdGxlOiBfdChcIlVuYWJsZSB0byByZXZva2Ugc2hhcmluZyBmb3IgZW1haWwgYWRkcmVzc1wiKSxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25TaGFyZUNsaWNrID0gKGU6IFJlYWN0Lk1vdXNlRXZlbnQpOiB2b2lkID0+IHtcbiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICB0aGlzLmNoYW5nZUJpbmRpbmcoe1xuICAgICAgICAgICAgYmluZDogdHJ1ZSxcbiAgICAgICAgICAgIGxhYmVsOiBcInNoYXJlXCIsXG4gICAgICAgICAgICBlcnJvclRpdGxlOiBfdChcIlVuYWJsZSB0byBzaGFyZSBlbWFpbCBhZGRyZXNzXCIpLFxuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkNvbnRpbnVlQ2xpY2sgPSBhc3luYyAoZTogUmVhY3QuTW91c2VFdmVudCk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGNvbnRpbnVlRGlzYWJsZWQ6IHRydWUgfSk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnN0YXRlLmFkZFRhc2suY2hlY2tFbWFpbExpbmtDbGlja2VkKCk7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICBhZGRUYXNrOiBudWxsLFxuICAgICAgICAgICAgICAgIGNvbnRpbnVlRGlzYWJsZWQ6IGZhbHNlLFxuICAgICAgICAgICAgICAgIHZlcmlmeWluZzogZmFsc2UsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgY29udGludWVEaXNhYmxlZDogZmFsc2UgfSk7XG4gICAgICAgICAgICBpZiAoZXJyLmVycmNvZGUgPT09ICdNX1RIUkVFUElEX0FVVEhfRkFJTEVEJykge1xuICAgICAgICAgICAgICAgIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coXCJFLW1haWwgaGFzbid0IGJlZW4gdmVyaWZpZWQgeWV0XCIsIFwiXCIsIEVycm9yRGlhbG9nLCB7XG4gICAgICAgICAgICAgICAgICAgIHRpdGxlOiBfdChcIllvdXIgZW1haWwgYWRkcmVzcyBoYXNuJ3QgYmVlbiB2ZXJpZmllZCB5ZXRcIiksXG4gICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBfdChcIkNsaWNrIHRoZSBsaW5rIGluIHRoZSBlbWFpbCB5b3UgcmVjZWl2ZWQgdG8gdmVyaWZ5IFwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiYW5kIHRoZW4gY2xpY2sgY29udGludWUgYWdhaW4uXCIpLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoXCJVbmFibGUgdG8gdmVyaWZ5IGVtYWlsIGFkZHJlc3M6IFwiICsgZXJyKTtcbiAgICAgICAgICAgICAgICBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nKCdVbmFibGUgdG8gdmVyaWZ5IGVtYWlsIGFkZHJlc3MnLCAnJywgRXJyb3JEaWFsb2csIHtcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6IF90KFwiVW5hYmxlIHRvIHZlcmlmeSBlbWFpbCBhZGRyZXNzLlwiKSxcbiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICgoZXJyICYmIGVyci5tZXNzYWdlKSA/IGVyci5tZXNzYWdlIDogX3QoXCJPcGVyYXRpb24gZmFpbGVkXCIpKSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwdWJsaWMgcmVuZGVyKCk6IEpTWC5FbGVtZW50IHtcbiAgICAgICAgY29uc3QgeyBhZGRyZXNzIH0gPSB0aGlzLnByb3BzLmVtYWlsO1xuICAgICAgICBjb25zdCB7IHZlcmlmeWluZywgYm91bmQgfSA9IHRoaXMuc3RhdGU7XG5cbiAgICAgICAgbGV0IHN0YXR1cztcbiAgICAgICAgaWYgKHZlcmlmeWluZykge1xuICAgICAgICAgICAgc3RhdHVzID0gPHNwYW4+XG4gICAgICAgICAgICAgICAgeyBfdChcIlZlcmlmeSB0aGUgbGluayBpbiB5b3VyIGluYm94XCIpIH1cbiAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvblxuICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9FeGlzdGluZ0VtYWlsQWRkcmVzc19jb25maXJtQnRuXCJcbiAgICAgICAgICAgICAgICAgICAga2luZD1cInByaW1hcnlfc21cIlxuICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLm9uQ29udGludWVDbGlja31cbiAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWQ9e3RoaXMuc3RhdGUuY29udGludWVEaXNhYmxlZH1cbiAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICAgIHsgX3QoXCJDb21wbGV0ZVwiKSB9XG4gICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgPC9zcGFuPjtcbiAgICAgICAgfSBlbHNlIGlmIChib3VuZCkge1xuICAgICAgICAgICAgc3RhdHVzID0gPEFjY2Vzc2libGVCdXR0b25cbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9FeGlzdGluZ0VtYWlsQWRkcmVzc19jb25maXJtQnRuXCJcbiAgICAgICAgICAgICAgICBraW5kPVwiZGFuZ2VyX3NtXCJcbiAgICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLm9uUmV2b2tlQ2xpY2t9XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgeyBfdChcIlJldm9rZVwiKSB9XG4gICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3RhdHVzID0gPEFjY2Vzc2libGVCdXR0b25cbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9FeGlzdGluZ0VtYWlsQWRkcmVzc19jb25maXJtQnRuXCJcbiAgICAgICAgICAgICAgICBraW5kPVwicHJpbWFyeV9zbVwiXG4gICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5vblNoYXJlQ2xpY2t9XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgeyBfdChcIlNoYXJlXCIpIH1cbiAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj47XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9FeGlzdGluZ0VtYWlsQWRkcmVzc1wiPlxuICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT1cIm14X0V4aXN0aW5nRW1haWxBZGRyZXNzX2VtYWlsXCI+eyBhZGRyZXNzIH08L3NwYW4+XG4gICAgICAgICAgICAgICAgeyBzdGF0dXMgfVxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICk7XG4gICAgfVxufVxuaW50ZXJmYWNlIElQcm9wcyB7XG4gICAgZW1haWxzOiBJVGhyZWVwaWRbXTtcbn1cblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3Muc2V0dGluZ3MuZGlzY292ZXJ5LkVtYWlsQWRkcmVzc2VzXCIpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBFbWFpbEFkZHJlc3NlcyBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxJUHJvcHM+IHtcbiAgICBwdWJsaWMgcmVuZGVyKCk6IEpTWC5FbGVtZW50IHtcbiAgICAgICAgbGV0IGNvbnRlbnQ7XG4gICAgICAgIGlmICh0aGlzLnByb3BzLmVtYWlscy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjb250ZW50ID0gdGhpcy5wcm9wcy5lbWFpbHMubWFwKChlKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDxFbWFpbEFkZHJlc3MgZW1haWw9e2V9IGtleT17ZS5hZGRyZXNzfSAvPjtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29udGVudCA9IDxzcGFuIGNsYXNzTmFtZT1cIm14X1NldHRpbmdzVGFiX3N1YnNlY3Rpb25UZXh0XCI+XG4gICAgICAgICAgICAgICAgeyBfdChcIkRpc2NvdmVyeSBvcHRpb25zIHdpbGwgYXBwZWFyIG9uY2UgeW91IGhhdmUgYWRkZWQgYW4gZW1haWwgYWJvdmUuXCIpIH1cbiAgICAgICAgICAgIDwvc3Bhbj47XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9FbWFpbEFkZHJlc3Nlc1wiPlxuICAgICAgICAgICAgICAgIHsgY29udGVudCB9XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=