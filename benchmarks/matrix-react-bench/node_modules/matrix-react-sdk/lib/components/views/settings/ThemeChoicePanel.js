"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _languageHandler = require("../../../languageHandler");

var _SettingsStore = _interopRequireDefault(require("../../../settings/SettingsStore"));

var _theme = require("../../../theme");

var _ThemeWatcher = _interopRequireDefault(require("../../../settings/watchers/ThemeWatcher"));

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var _actions = require("../../../dispatcher/actions");

var _StyledCheckbox = _interopRequireDefault(require("../elements/StyledCheckbox"));

var _Field = _interopRequireDefault(require("../elements/Field"));

var _StyledRadioGroup = _interopRequireDefault(require("../elements/StyledRadioGroup"));

var _SettingLevel = require("../../../settings/SettingLevel");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class;

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

let ThemeChoicePanel = (_dec = (0, _replaceableComponent.replaceableComponent)("views.settings.tabs.user.ThemeChoicePanel"), _dec(_class = class ThemeChoicePanel extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "themeTimer", void 0);
    (0, _defineProperty2.default)(this, "onThemeChange", newTheme => {
      if (this.state.theme === newTheme) return; // doing getValue in the .catch will still return the value we failed to set,
      // so remember what the value was before we tried to set it so we can revert

      const oldTheme = _SettingsStore.default.getValue('theme');

      _SettingsStore.default.setValue("theme", null, _SettingLevel.SettingLevel.DEVICE, newTheme).catch(() => {
        _dispatcher.default.dispatch({
          action: _actions.Action.RecheckTheme
        });

        this.setState({
          theme: oldTheme
        });
      });

      this.setState({
        theme: newTheme
      }); // The settings watcher doesn't fire until the echo comes back from the
      // server, so to make the theme change immediately we need to manually
      // do the dispatch now
      // XXX: The local echoed value appears to be unreliable, in particular
      // when settings custom themes(!) so adding forceTheme to override
      // the value from settings.

      _dispatcher.default.dispatch({
        action: _actions.Action.RecheckTheme,
        forceTheme: newTheme
      });
    });
    (0, _defineProperty2.default)(this, "onUseSystemThemeChanged", checked => {
      this.setState({
        useSystemTheme: checked
      });

      _SettingsStore.default.setValue("use_system_theme", null, _SettingLevel.SettingLevel.DEVICE, checked);

      _dispatcher.default.dispatch({
        action: _actions.Action.RecheckTheme
      });
    });
    (0, _defineProperty2.default)(this, "onAddCustomTheme", async () => {
      let currentThemes = _SettingsStore.default.getValue("custom_themes");

      if (!currentThemes) currentThemes = [];
      currentThemes = currentThemes.map(c => c); // cheap clone

      if (this.themeTimer) {
        clearTimeout(this.themeTimer);
      }

      try {
        const r = await fetch(this.state.customThemeUrl); // XXX: need some schema for this

        const themeInfo = await r.json();

        if (!themeInfo || typeof themeInfo['name'] !== 'string' || typeof themeInfo['colors'] !== 'object') {
          this.setState({
            customThemeMessage: {
              text: (0, _languageHandler._t)("Invalid theme schema."),
              isError: true
            }
          });
          return;
        }

        currentThemes.push(themeInfo);
      } catch (e) {
        _logger.logger.error(e);

        this.setState({
          customThemeMessage: {
            text: (0, _languageHandler._t)("Error downloading theme information."),
            isError: true
          }
        });
        return; // Don't continue on error
      }

      await _SettingsStore.default.setValue("custom_themes", null, _SettingLevel.SettingLevel.ACCOUNT, currentThemes);
      this.setState({
        customThemeUrl: "",
        customThemeMessage: {
          text: (0, _languageHandler._t)("Theme added!"),
          isError: false
        }
      });
      this.themeTimer = setTimeout(() => {
        this.setState({
          customThemeMessage: {
            text: "",
            isError: false
          }
        });
      }, 3000);
    });
    (0, _defineProperty2.default)(this, "onCustomThemeChange", e => {
      this.setState({
        customThemeUrl: e.target.value
      });
    });
    this.state = _objectSpread(_objectSpread({}, ThemeChoicePanel.calculateThemeState()), {}, {
      customThemeUrl: "",
      customThemeMessage: {
        isError: false,
        text: ""
      }
    });
  }

  static calculateThemeState() {
    // We have to mirror the logic from ThemeWatcher.getEffectiveTheme so we
    // show the right values for things.
    const themeChoice = _SettingsStore.default.getValue("theme");

    const systemThemeExplicit = _SettingsStore.default.getValueAt(_SettingLevel.SettingLevel.DEVICE, "use_system_theme", null, false, true);

    const themeExplicit = _SettingsStore.default.getValueAt(_SettingLevel.SettingLevel.DEVICE, "theme", null, false, true); // If the user has enabled system theme matching, use that.


    if (systemThemeExplicit) {
      return {
        theme: themeChoice,
        useSystemTheme: true
      };
    } // If the user has set a theme explicitly, use that (no system theme matching)


    if (themeExplicit) {
      return {
        theme: themeChoice,
        useSystemTheme: false
      };
    } // Otherwise assume the defaults for the settings


    return {
      theme: themeChoice,
      useSystemTheme: _SettingsStore.default.getValueAt(_SettingLevel.SettingLevel.DEVICE, "use_system_theme")
    };
  }

  renderHighContrastCheckbox() {
    if (!this.state.useSystemTheme && ((0, _theme.findHighContrastTheme)(this.state.theme) || (0, _theme.isHighContrastTheme)(this.state.theme))) {
      return /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement(_StyledCheckbox.default, {
        checked: (0, _theme.isHighContrastTheme)(this.state.theme),
        onChange: e => this.highContrastThemeChanged(e.target.checked)
      }, (0, _languageHandler._t)("Use high contrast")));
    }
  }

  highContrastThemeChanged(checked) {
    let newTheme;

    if (checked) {
      newTheme = (0, _theme.findHighContrastTheme)(this.state.theme);
    } else {
      newTheme = (0, _theme.findNonHighContrastTheme)(this.state.theme);
    }

    if (newTheme) {
      this.onThemeChange(newTheme);
    }
  }

  render() {
    const themeWatcher = new _ThemeWatcher.default();
    let systemThemeSection;

    if (themeWatcher.isSystemThemeSupported()) {
      systemThemeSection = /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement(_StyledCheckbox.default, {
        checked: this.state.useSystemTheme,
        onChange: e => this.onUseSystemThemeChanged(e.target.checked)
      }, _SettingsStore.default.getDisplayName("use_system_theme")));
    }

    let customThemeForm;

    if (_SettingsStore.default.getValue("feature_custom_themes")) {
      let messageElement = null;

      if (this.state.customThemeMessage.text) {
        if (this.state.customThemeMessage.isError) {
          messageElement = /*#__PURE__*/_react.default.createElement("div", {
            className: "text-error"
          }, this.state.customThemeMessage.text);
        } else {
          messageElement = /*#__PURE__*/_react.default.createElement("div", {
            className: "text-success"
          }, this.state.customThemeMessage.text);
        }
      }

      customThemeForm = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_SettingsTab_section"
      }, /*#__PURE__*/_react.default.createElement("form", {
        onSubmit: this.onAddCustomTheme
      }, /*#__PURE__*/_react.default.createElement(_Field.default, {
        label: (0, _languageHandler._t)("Custom theme URL"),
        type: "text",
        id: "mx_GeneralUserSettingsTab_customThemeInput",
        autoComplete: "off",
        onChange: this.onCustomThemeChange,
        value: this.state.customThemeUrl
      }), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        onClick: this.onAddCustomTheme,
        type: "submit",
        kind: "primary_sm",
        disabled: !this.state.customThemeUrl.trim()
      }, (0, _languageHandler._t)("Add theme")), messageElement));
    }

    const orderedThemes = (0, _theme.getOrderedThemes)();
    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_SettingsTab_section mx_ThemeChoicePanel"
    }, /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_SettingsTab_subheading"
    }, (0, _languageHandler._t)("Theme")), systemThemeSection, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_ThemeSelectors"
    }, /*#__PURE__*/_react.default.createElement(_StyledRadioGroup.default, {
      name: "theme",
      definitions: orderedThemes.map(t => ({
        value: t.id,
        label: t.name,
        disabled: this.state.useSystemTheme,
        className: "mx_ThemeSelector_" + t.id
      })),
      onChange: this.onThemeChange,
      value: this.apparentSelectedThemeId(),
      outlined: true
    })), this.renderHighContrastCheckbox(), customThemeForm);
  }

  apparentSelectedThemeId() {
    if (this.state.useSystemTheme) {
      return undefined;
    }

    const nonHighContrast = (0, _theme.findNonHighContrastTheme)(this.state.theme);
    return nonHighContrast ? nonHighContrast : this.state.theme;
  }

}) || _class);
exports.default = ThemeChoicePanel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3NldHRpbmdzL1RoZW1lQ2hvaWNlUGFuZWwudHN4Il0sIm5hbWVzIjpbIlRoZW1lQ2hvaWNlUGFuZWwiLCJSZWFjdCIsIkNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJuZXdUaGVtZSIsInN0YXRlIiwidGhlbWUiLCJvbGRUaGVtZSIsIlNldHRpbmdzU3RvcmUiLCJnZXRWYWx1ZSIsInNldFZhbHVlIiwiU2V0dGluZ0xldmVsIiwiREVWSUNFIiwiY2F0Y2giLCJkaXMiLCJkaXNwYXRjaCIsImFjdGlvbiIsIkFjdGlvbiIsIlJlY2hlY2tUaGVtZSIsInNldFN0YXRlIiwiZm9yY2VUaGVtZSIsImNoZWNrZWQiLCJ1c2VTeXN0ZW1UaGVtZSIsImN1cnJlbnRUaGVtZXMiLCJtYXAiLCJjIiwidGhlbWVUaW1lciIsImNsZWFyVGltZW91dCIsInIiLCJmZXRjaCIsImN1c3RvbVRoZW1lVXJsIiwidGhlbWVJbmZvIiwianNvbiIsImN1c3RvbVRoZW1lTWVzc2FnZSIsInRleHQiLCJpc0Vycm9yIiwicHVzaCIsImUiLCJsb2dnZXIiLCJlcnJvciIsIkFDQ09VTlQiLCJzZXRUaW1lb3V0IiwidGFyZ2V0IiwidmFsdWUiLCJjYWxjdWxhdGVUaGVtZVN0YXRlIiwidGhlbWVDaG9pY2UiLCJzeXN0ZW1UaGVtZUV4cGxpY2l0IiwiZ2V0VmFsdWVBdCIsInRoZW1lRXhwbGljaXQiLCJyZW5kZXJIaWdoQ29udHJhc3RDaGVja2JveCIsImhpZ2hDb250cmFzdFRoZW1lQ2hhbmdlZCIsIm9uVGhlbWVDaGFuZ2UiLCJyZW5kZXIiLCJ0aGVtZVdhdGNoZXIiLCJUaGVtZVdhdGNoZXIiLCJzeXN0ZW1UaGVtZVNlY3Rpb24iLCJpc1N5c3RlbVRoZW1lU3VwcG9ydGVkIiwib25Vc2VTeXN0ZW1UaGVtZUNoYW5nZWQiLCJnZXREaXNwbGF5TmFtZSIsImN1c3RvbVRoZW1lRm9ybSIsIm1lc3NhZ2VFbGVtZW50Iiwib25BZGRDdXN0b21UaGVtZSIsIm9uQ3VzdG9tVGhlbWVDaGFuZ2UiLCJ0cmltIiwib3JkZXJlZFRoZW1lcyIsInQiLCJpZCIsImxhYmVsIiwibmFtZSIsImRpc2FibGVkIiwiY2xhc3NOYW1lIiwiYXBwYXJlbnRTZWxlY3RlZFRoZW1lSWQiLCJ1bmRlZmluZWQiLCJub25IaWdoQ29udHJhc3QiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOzs7Ozs7OztJQXFCcUJBLGdCLFdBRHBCLGdEQUFxQiwyQ0FBckIsQyxnQkFBRCxNQUNxQkEsZ0JBRHJCLFNBQzhDQyxlQUFNQyxTQURwRCxDQUM4RTtBQUcxRUMsRUFBQUEsV0FBVyxDQUFDQyxLQUFELEVBQWdCO0FBQ3ZCLFVBQU1BLEtBQU47QUFEdUI7QUFBQSx5REEyQ0ZDLFFBQUQsSUFBNEI7QUFDaEQsVUFBSSxLQUFLQyxLQUFMLENBQVdDLEtBQVgsS0FBcUJGLFFBQXpCLEVBQW1DLE9BRGEsQ0FHaEQ7QUFDQTs7QUFDQSxZQUFNRyxRQUFnQixHQUFHQyx1QkFBY0MsUUFBZCxDQUF1QixPQUF2QixDQUF6Qjs7QUFDQUQsNkJBQWNFLFFBQWQsQ0FBdUIsT0FBdkIsRUFBZ0MsSUFBaEMsRUFBc0NDLDJCQUFhQyxNQUFuRCxFQUEyRFIsUUFBM0QsRUFBcUVTLEtBQXJFLENBQTJFLE1BQU07QUFDN0VDLDRCQUFJQyxRQUFKLENBQWtDO0FBQUVDLFVBQUFBLE1BQU0sRUFBRUMsZ0JBQU9DO0FBQWpCLFNBQWxDOztBQUNBLGFBQUtDLFFBQUwsQ0FBYztBQUFFYixVQUFBQSxLQUFLLEVBQUVDO0FBQVQsU0FBZDtBQUNILE9BSEQ7O0FBSUEsV0FBS1ksUUFBTCxDQUFjO0FBQUViLFFBQUFBLEtBQUssRUFBRUY7QUFBVCxPQUFkLEVBVmdELENBV2hEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFDQVUsMEJBQUlD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QUwsQ0FBV0MsS0FBdEQ7QUFDSDs7QUExTnlFLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMjEgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgX3QgfSBmcm9tIFwiLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyXCI7XG5pbXBvcnQgU2V0dGluZ3NTdG9yZSBmcm9tIFwiLi4vLi4vLi4vc2V0dGluZ3MvU2V0dGluZ3NTdG9yZVwiO1xuaW1wb3J0IHsgZmluZEhpZ2hDb250cmFzdFRoZW1lLCBmaW5kTm9uSGlnaENvbnRyYXN0VGhlbWUsIGdldE9yZGVyZWRUaGVtZXMsIGlzSGlnaENvbnRyYXN0VGhlbWUgfSBmcm9tIFwiLi4vLi4vLi4vdGhlbWVcIjtcbmltcG9ydCBUaGVtZVdhdGNoZXIgZnJvbSBcIi4uLy4uLy4uL3NldHRpbmdzL3dhdGNoZXJzL1RoZW1lV2F0Y2hlclwiO1xuaW1wb3J0IEFjY2Vzc2libGVCdXR0b24gZnJvbSBcIi4uL2VsZW1lbnRzL0FjY2Vzc2libGVCdXR0b25cIjtcbmltcG9ydCBkaXMgZnJvbSBcIi4uLy4uLy4uL2Rpc3BhdGNoZXIvZGlzcGF0Y2hlclwiO1xuaW1wb3J0IHsgUmVjaGVja1RoZW1lUGF5bG9hZCB9IGZyb20gJy4uLy4uLy4uL2Rpc3BhdGNoZXIvcGF5bG9hZHMvUmVjaGVja1RoZW1lUGF5bG9hZCc7XG5pbXBvcnQgeyBBY3Rpb24gfSBmcm9tICcuLi8uLi8uLi9kaXNwYXRjaGVyL2FjdGlvbnMnO1xuaW1wb3J0IFN0eWxlZENoZWNrYm94IGZyb20gJy4uL2VsZW1lbnRzL1N0eWxlZENoZWNrYm94JztcbmltcG9ydCBGaWVsZCBmcm9tICcuLi9lbGVtZW50cy9GaWVsZCc7XG5pbXBvcnQgU3R5bGVkUmFkaW9Hcm91cCBmcm9tIFwiLi4vZWxlbWVudHMvU3R5bGVkUmFkaW9Hcm91cFwiO1xuaW1wb3J0IHsgU2V0dGluZ0xldmVsIH0gZnJvbSBcIi4uLy4uLy4uL3NldHRpbmdzL1NldHRpbmdMZXZlbFwiO1xuaW1wb3J0IHsgcmVwbGFjZWFibGVDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvcmVwbGFjZWFibGVDb21wb25lbnRcIjtcblxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2xvZ2dlclwiO1xuXG5pbnRlcmZhY2UgSVByb3BzIHtcbn1cblxuaW50ZXJmYWNlIElUaGVtZVN0YXRlIHtcbiAgICB0aGVtZTogc3RyaW5nO1xuICAgIHVzZVN5c3RlbVRoZW1lOiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEN1c3RvbVRoZW1lTWVzc2FnZSB7XG4gICAgaXNFcnJvcjogYm9vbGVhbjtcbiAgICB0ZXh0OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBJU3RhdGUgZXh0ZW5kcyBJVGhlbWVTdGF0ZSB7XG4gICAgY3VzdG9tVGhlbWVVcmw6IHN0cmluZztcbiAgICBjdXN0b21UaGVtZU1lc3NhZ2U6IEN1c3RvbVRoZW1lTWVzc2FnZTtcbn1cblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3Muc2V0dGluZ3MudGFicy51c2VyLlRoZW1lQ2hvaWNlUGFuZWxcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFRoZW1lQ2hvaWNlUGFuZWwgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8SVByb3BzLCBJU3RhdGU+IHtcbiAgICBwcml2YXRlIHRoZW1lVGltZXI6IG51bWJlcjtcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBJUHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuXG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICAuLi5UaGVtZUNob2ljZVBhbmVsLmNhbGN1bGF0ZVRoZW1lU3RhdGUoKSxcbiAgICAgICAgICAgIGN1c3RvbVRoZW1lVXJsOiBcIlwiLFxuICAgICAgICAgICAgY3VzdG9tVGhlbWVNZXNzYWdlOiB7IGlzRXJyb3I6IGZhbHNlLCB0ZXh0OiBcIlwiIH0sXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBjYWxjdWxhdGVUaGVtZVN0YXRlKCk6IElUaGVtZVN0YXRlIHtcbiAgICAgICAgLy8gV2UgaGF2ZSB0byBtaXJyb3IgdGhlIGxvZ2ljIGZyb20gVGhlbWVXYXRjaGVyLmdldEVmZmVjdGl2ZVRoZW1lIHNvIHdlXG4gICAgICAgIC8vIHNob3cgdGhlIHJpZ2h0IHZhbHVlcyBmb3IgdGhpbmdzLlxuXG4gICAgICAgIGNvbnN0IHRoZW1lQ2hvaWNlOiBzdHJpbmcgPSBTZXR0aW5nc1N0b3JlLmdldFZhbHVlKFwidGhlbWVcIik7XG4gICAgICAgIGNvbnN0IHN5c3RlbVRoZW1lRXhwbGljaXQ6IGJvb2xlYW4gPSBTZXR0aW5nc1N0b3JlLmdldFZhbHVlQXQoXG4gICAgICAgICAgICBTZXR0aW5nTGV2ZWwuREVWSUNFLCBcInVzZV9zeXN0ZW1fdGhlbWVcIiwgbnVsbCwgZmFsc2UsIHRydWUpO1xuICAgICAgICBjb25zdCB0aGVtZUV4cGxpY2l0OiBzdHJpbmcgPSBTZXR0aW5nc1N0b3JlLmdldFZhbHVlQXQoXG4gICAgICAgICAgICBTZXR0aW5nTGV2ZWwuREVWSUNFLCBcInRoZW1lXCIsIG51bGwsIGZhbHNlLCB0cnVlKTtcblxuICAgICAgICAvLyBJZiB0aGUgdXNlciBoYXMgZW5hYmxlZCBzeXN0ZW0gdGhlbWUgbWF0Y2hpbmcsIHVzZSB0aGF0LlxuICAgICAgICBpZiAoc3lzdGVtVGhlbWVFeHBsaWNpdCkge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICB0aGVtZTogdGhlbWVDaG9pY2UsXG4gICAgICAgICAgICAgICAgdXNlU3lzdGVtVGhlbWU6IHRydWUsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gSWYgdGhlIHVzZXIgaGFzIHNldCBhIHRoZW1lIGV4cGxpY2l0bHksIHVzZSB0aGF0IChubyBzeXN0ZW0gdGhlbWUgbWF0Y2hpbmcpXG4gICAgICAgIGlmICh0aGVtZUV4cGxpY2l0KSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHRoZW1lOiB0aGVtZUNob2ljZSxcbiAgICAgICAgICAgICAgICB1c2VTeXN0ZW1UaGVtZTogZmFsc2UsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gT3RoZXJ3aXNlIGFzc3VtZSB0aGUgZGVmYXVsdHMgZm9yIHRoZSBzZXR0aW5nc1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdGhlbWU6IHRoZW1lQ2hvaWNlLFxuICAgICAgICAgICAgdXNlU3lzdGVtVGhlbWU6IFNldHRpbmdzU3RvcmUuZ2V0VmFsdWVBdChTZXR0aW5nTGV2ZWwuREVWSUNFLCBcInVzZV9zeXN0ZW1fdGhlbWVcIiksXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvblRoZW1lQ2hhbmdlID0gKG5ld1RoZW1lOiBzdHJpbmcpOiB2b2lkID0+IHtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUudGhlbWUgPT09IG5ld1RoZW1lKSByZXR1cm47XG5cbiAgICAgICAgLy8gZG9pbmcgZ2V0VmFsdWUgaW4gdGhlIC5jYXRjaCB3aWxsIHN0aWxsIHJldHVybiB0aGUgdmFsdWUgd2UgZmFpbGVkIHRvIHNldCxcbiAgICAgICAgLy8gc28gcmVtZW1iZXIgd2hhdCB0aGUgdmFsdWUgd2FzIGJlZm9yZSB3ZSB0cmllZCB0byBzZXQgaXQgc28gd2UgY2FuIHJldmVydFxuICAgICAgICBjb25zdCBvbGRUaGVtZTogc3RyaW5nID0gU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZSgndGhlbWUnKTtcbiAgICAgICAgU2V0dGluZ3NTdG9yZS5zZXRWYWx1ZShcInRoZW1lXCIsIG51bGwsIFNldHRpbmdMZXZlbC5ERVZJQ0UsIG5ld1RoZW1lKS5jYXRjaCgoKSA9PiB7XG4gICAgICAgICAgICBkaXMuZGlzcGF0Y2g8UmVjaGVja1RoZW1lUGF5bG9hZD4oeyBhY3Rpb246IEFjdGlvbi5SZWNoZWNrVGhlbWUgfSk7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgdGhlbWU6IG9sZFRoZW1lIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IHRoZW1lOiBuZXdUaGVtZSB9KTtcbiAgICAgICAgLy8gVGhlIHNldHRpbmdzIHdhdGNoZXIgZG9lc24ndCBmaXJlIHVudGlsIHRoZSBlY2hvIGNvbWVzIGJhY2sgZnJvbSB0aGVcbiAgICAgICAgLy8gc2VydmVyLCBzbyB0byBtYWtlIHRoZSB0aGVtZSBjaGFuZ2UgaW1tZWRpYXRlbHkgd2UgbmVlZCB0byBtYW51YWxseVxuICAgICAgICAvLyBkbyB0aGUgZGlzcGF0Y2ggbm93XG4gICAgICAgIC8vIFhYWDogVGhlIGxvY2FsIGVjaG9lZCB2YWx1ZSBhcHBlYXJzIHRvIGJlIHVucmVsaWFibGUsIGluIHBhcnRpY3VsYXJcbiAgICAgICAgLy8gd2hlbiBzZXR0aW5ncyBjdXN0b20gdGhlbWVzKCEpIHNvIGFkZGluZyBmb3JjZVRoZW1lIHRvIG92ZXJyaWRlXG4gICAgICAgIC8vIHRoZSB2YWx1ZSBmcm9tIHNldHRpbmdzLlxuICAgICAgICBkaXMuZGlzcGF0Y2g8UmVjaGVja1RoZW1lUGF5bG9hZD4oeyBhY3Rpb246IEFjdGlvbi5SZWNoZWNrVGhlbWUsIGZvcmNlVGhlbWU6IG5ld1RoZW1lIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uVXNlU3lzdGVtVGhlbWVDaGFuZ2VkID0gKGNoZWNrZWQ6IGJvb2xlYW4pOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IHVzZVN5c3RlbVRoZW1lOiBjaGVja2VkIH0pO1xuICAgICAgICBTZXR0aW5nc1N0b3JlLnNldFZhbHVlKFwidXNlX3N5c3RlbV90aGVtZVwiLCBudWxsLCBTZXR0aW5nTGV2ZWwuREVWSUNFLCBjaGVja2VkKTtcbiAgICAgICAgZGlzLmRpc3BhdGNoPFJlY2hlY2tUaGVtZVBheWxvYWQ+KHsgYWN0aW9uOiBBY3Rpb24uUmVjaGVja1RoZW1lIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uQWRkQ3VzdG9tVGhlbWUgPSBhc3luYyAoKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgICAgIGxldCBjdXJyZW50VGhlbWVzOiBzdHJpbmdbXSA9IFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJjdXN0b21fdGhlbWVzXCIpO1xuICAgICAgICBpZiAoIWN1cnJlbnRUaGVtZXMpIGN1cnJlbnRUaGVtZXMgPSBbXTtcbiAgICAgICAgY3VycmVudFRoZW1lcyA9IGN1cnJlbnRUaGVtZXMubWFwKGMgPT4gYyk7IC8vIGNoZWFwIGNsb25lXG5cbiAgICAgICAgaWYgKHRoaXMudGhlbWVUaW1lcikge1xuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGhlbWVUaW1lcik7XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgciA9IGF3YWl0IGZldGNoKHRoaXMuc3RhdGUuY3VzdG9tVGhlbWVVcmwpO1xuICAgICAgICAgICAgLy8gWFhYOiBuZWVkIHNvbWUgc2NoZW1hIGZvciB0aGlzXG4gICAgICAgICAgICBjb25zdCB0aGVtZUluZm8gPSBhd2FpdCByLmpzb24oKTtcbiAgICAgICAgICAgIGlmICghdGhlbWVJbmZvIHx8IHR5cGVvZih0aGVtZUluZm9bJ25hbWUnXSkgIT09ICdzdHJpbmcnIHx8IHR5cGVvZih0aGVtZUluZm9bJ2NvbG9ycyddKSAhPT0gJ29iamVjdCcpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgY3VzdG9tVGhlbWVNZXNzYWdlOiB7IHRleHQ6IF90KFwiSW52YWxpZCB0aGVtZSBzY2hlbWEuXCIpLCBpc0Vycm9yOiB0cnVlIH0gfSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY3VycmVudFRoZW1lcy5wdXNoKHRoZW1lSW5mbyk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihlKTtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBjdXN0b21UaGVtZU1lc3NhZ2U6IHsgdGV4dDogX3QoXCJFcnJvciBkb3dubG9hZGluZyB0aGVtZSBpbmZvcm1hdGlvbi5cIiksIGlzRXJyb3I6IHRydWUgfSB9KTtcbiAgICAgICAgICAgIHJldHVybjsgLy8gRG9uJ3QgY29udGludWUgb24gZXJyb3JcbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IFNldHRpbmdzU3RvcmUuc2V0VmFsdWUoXCJjdXN0b21fdGhlbWVzXCIsIG51bGwsIFNldHRpbmdMZXZlbC5BQ0NPVU5ULCBjdXJyZW50VGhlbWVzKTtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGN1c3RvbVRoZW1lVXJsOiBcIlwiLCBjdXN0b21UaGVtZU1lc3NhZ2U6IHsgdGV4dDogX3QoXCJUaGVtZSBhZGRlZCFcIiksIGlzRXJyb3I6IGZhbHNlIH0gfSk7XG5cbiAgICAgICAgdGhpcy50aGVtZVRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgY3VzdG9tVGhlbWVNZXNzYWdlOiB7IHRleHQ6IFwiXCIsIGlzRXJyb3I6IGZhbHNlIH0gfSk7XG4gICAgICAgIH0sIDMwMDApO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uQ3VzdG9tVGhlbWVDaGFuZ2UgPSAoZTogUmVhY3QuQ2hhbmdlRXZlbnQ8SFRNTFNlbGVjdEVsZW1lbnQgfCBIVE1MSW5wdXRFbGVtZW50Pik6IHZvaWQgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgY3VzdG9tVGhlbWVVcmw6IGUudGFyZ2V0LnZhbHVlIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIHJlbmRlckhpZ2hDb250cmFzdENoZWNrYm94KCk6IFJlYWN0LlJlYWN0RWxlbWVudDxIVE1MRGl2RWxlbWVudD4ge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgICAhdGhpcy5zdGF0ZS51c2VTeXN0ZW1UaGVtZSAmJiAoXG4gICAgICAgICAgICAgICAgZmluZEhpZ2hDb250cmFzdFRoZW1lKHRoaXMuc3RhdGUudGhlbWUpIHx8XG4gICAgICAgICAgICAgICAgaXNIaWdoQ29udHJhc3RUaGVtZSh0aGlzLnN0YXRlLnRoZW1lKVxuICAgICAgICAgICAgKVxuICAgICAgICApIHtcbiAgICAgICAgICAgIHJldHVybiA8ZGl2PlxuICAgICAgICAgICAgICAgIDxTdHlsZWRDaGVja2JveFxuICAgICAgICAgICAgICAgICAgICBjaGVja2VkPXtpc0hpZ2hDb250cmFzdFRoZW1lKHRoaXMuc3RhdGUudGhlbWUpfVxuICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZT17KGUpID0+IHRoaXMuaGlnaENvbnRyYXN0VGhlbWVDaGFuZ2VkKGUudGFyZ2V0LmNoZWNrZWQpfVxuICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICAgICAgeyBfdCggXCJVc2UgaGlnaCBjb250cmFzdFwiICkgfVxuICAgICAgICAgICAgICAgIDwvU3R5bGVkQ2hlY2tib3g+XG4gICAgICAgICAgICA8L2Rpdj47XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGhpZ2hDb250cmFzdFRoZW1lQ2hhbmdlZChjaGVja2VkOiBib29sZWFuKTogdm9pZCB7XG4gICAgICAgIGxldCBuZXdUaGVtZTogc3RyaW5nO1xuICAgICAgICBpZiAoY2hlY2tlZCkge1xuICAgICAgICAgICAgbmV3VGhlbWUgPSBmaW5kSGlnaENvbnRyYXN0VGhlbWUodGhpcy5zdGF0ZS50aGVtZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBuZXdUaGVtZSA9IGZpbmROb25IaWdoQ29udHJhc3RUaGVtZSh0aGlzLnN0YXRlLnRoZW1lKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobmV3VGhlbWUpIHtcbiAgICAgICAgICAgIHRoaXMub25UaGVtZUNoYW5nZShuZXdUaGVtZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgcmVuZGVyKCk6IFJlYWN0LlJlYWN0RWxlbWVudDxIVE1MRGl2RWxlbWVudD4ge1xuICAgICAgICBjb25zdCB0aGVtZVdhdGNoZXIgPSBuZXcgVGhlbWVXYXRjaGVyKCk7XG4gICAgICAgIGxldCBzeXN0ZW1UaGVtZVNlY3Rpb246IEpTWC5FbGVtZW50O1xuICAgICAgICBpZiAodGhlbWVXYXRjaGVyLmlzU3lzdGVtVGhlbWVTdXBwb3J0ZWQoKSkge1xuICAgICAgICAgICAgc3lzdGVtVGhlbWVTZWN0aW9uID0gPGRpdj5cbiAgICAgICAgICAgICAgICA8U3R5bGVkQ2hlY2tib3hcbiAgICAgICAgICAgICAgICAgICAgY2hlY2tlZD17dGhpcy5zdGF0ZS51c2VTeXN0ZW1UaGVtZX1cbiAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2U9eyhlKSA9PiB0aGlzLm9uVXNlU3lzdGVtVGhlbWVDaGFuZ2VkKGUudGFyZ2V0LmNoZWNrZWQpfVxuICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICAgICAgeyBTZXR0aW5nc1N0b3JlLmdldERpc3BsYXlOYW1lKFwidXNlX3N5c3RlbV90aGVtZVwiKSB9XG4gICAgICAgICAgICAgICAgPC9TdHlsZWRDaGVja2JveD5cbiAgICAgICAgICAgIDwvZGl2PjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBjdXN0b21UaGVtZUZvcm06IEpTWC5FbGVtZW50O1xuICAgICAgICBpZiAoU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcImZlYXR1cmVfY3VzdG9tX3RoZW1lc1wiKSkge1xuICAgICAgICAgICAgbGV0IG1lc3NhZ2VFbGVtZW50ID0gbnVsbDtcbiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlLmN1c3RvbVRoZW1lTWVzc2FnZS50ZXh0KSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUuY3VzdG9tVGhlbWVNZXNzYWdlLmlzRXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZUVsZW1lbnQgPSA8ZGl2IGNsYXNzTmFtZT0ndGV4dC1lcnJvcic+eyB0aGlzLnN0YXRlLmN1c3RvbVRoZW1lTWVzc2FnZS50ZXh0IH08L2Rpdj47XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZUVsZW1lbnQgPSA8ZGl2IGNsYXNzTmFtZT0ndGV4dC1zdWNjZXNzJz57IHRoaXMuc3RhdGUuY3VzdG9tVGhlbWVNZXNzYWdlLnRleHQgfTwvZGl2PjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjdXN0b21UaGVtZUZvcm0gPSAoXG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J214X1NldHRpbmdzVGFiX3NlY3Rpb24nPlxuICAgICAgICAgICAgICAgICAgICA8Zm9ybSBvblN1Ym1pdD17dGhpcy5vbkFkZEN1c3RvbVRoZW1lfT5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxGaWVsZFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsPXtfdChcIkN1c3RvbSB0aGVtZSBVUkxcIil9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZT0ndGV4dCdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZD0nbXhfR2VuZXJhbFVzZXJTZXR0aW5nc1RhYl9jdXN0b21UaGVtZUlucHV0J1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1dG9Db21wbGV0ZT1cIm9mZlwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2U9e3RoaXMub25DdXN0b21UaGVtZUNoYW5nZX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZT17dGhpcy5zdGF0ZS5jdXN0b21UaGVtZVVybH1cbiAgICAgICAgICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s9e3RoaXMub25BZGRDdXN0b21UaGVtZX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlPVwic3VibWl0XCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBraW5kPVwicHJpbWFyeV9zbVwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWQ9eyF0aGlzLnN0YXRlLmN1c3RvbVRoZW1lVXJsLnRyaW0oKX1cbiAgICAgICAgICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IF90KFwiQWRkIHRoZW1lXCIpIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgbWVzc2FnZUVsZW1lbnQgfVxuICAgICAgICAgICAgICAgICAgICA8L2Zvcm0+XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgb3JkZXJlZFRoZW1lcyA9IGdldE9yZGVyZWRUaGVtZXMoKTtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfU2V0dGluZ3NUYWJfc2VjdGlvbiBteF9UaGVtZUNob2ljZVBhbmVsXCI+XG4gICAgICAgICAgICAgICAgPHNwYW4gY2xhc3NOYW1lPVwibXhfU2V0dGluZ3NUYWJfc3ViaGVhZGluZ1wiPnsgX3QoXCJUaGVtZVwiKSB9PC9zcGFuPlxuICAgICAgICAgICAgICAgIHsgc3lzdGVtVGhlbWVTZWN0aW9uIH1cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X1RoZW1lU2VsZWN0b3JzXCI+XG4gICAgICAgICAgICAgICAgICAgIDxTdHlsZWRSYWRpb0dyb3VwXG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lPVwidGhlbWVcIlxuICAgICAgICAgICAgICAgICAgICAgICAgZGVmaW5pdGlvbnM9e29yZGVyZWRUaGVtZXMubWFwKHQgPT4gKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdC5pZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogdC5uYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVkOiB0aGlzLnN0YXRlLnVzZVN5c3RlbVRoZW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZTogXCJteF9UaGVtZVNlbGVjdG9yX1wiICsgdC5pZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pKX1cbiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2hhbmdlPXt0aGlzLm9uVGhlbWVDaGFuZ2V9XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZT17dGhpcy5hcHBhcmVudFNlbGVjdGVkVGhlbWVJZCgpfVxuICAgICAgICAgICAgICAgICAgICAgICAgb3V0bGluZWRcbiAgICAgICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICB7IHRoaXMucmVuZGVySGlnaENvbnRyYXN0Q2hlY2tib3goKSB9XG4gICAgICAgICAgICAgICAgeyBjdXN0b21UaGVtZUZvcm0gfVxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgYXBwYXJlbnRTZWxlY3RlZFRoZW1lSWQoKSB7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnVzZVN5c3RlbVRoZW1lKSB7XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IG5vbkhpZ2hDb250cmFzdCA9IGZpbmROb25IaWdoQ29udHJhc3RUaGVtZSh0aGlzLnN0YXRlLnRoZW1lKTtcbiAgICAgICAgcmV0dXJuIG5vbkhpZ2hDb250cmFzdCA/IG5vbkhpZ2hDb250cmFzdCA6IHRoaXMuc3RhdGUudGhlbWU7XG4gICAgfVxufVxuIl19