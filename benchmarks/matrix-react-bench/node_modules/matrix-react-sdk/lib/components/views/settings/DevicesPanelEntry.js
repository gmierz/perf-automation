"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _languageHandler = require("../../../languageHandler");

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _DateUtils = require("../../../DateUtils");

var _StyledCheckbox = _interopRequireWildcard(require("../elements/StyledCheckbox"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _Field = _interopRequireDefault(require("../elements/Field"));

var _TextWithTooltip = _interopRequireDefault(require("../elements/TextWithTooltip"));

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _SetupEncryptionDialog = _interopRequireDefault(require("../dialogs/security/SetupEncryptionDialog"));

var _VerificationRequestDialog = _interopRequireDefault(require("../../views/dialogs/VerificationRequestDialog"));

var _LogoutDialog = _interopRequireDefault(require("../dialogs/LogoutDialog"));

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

let DevicesPanelEntry = (_dec = (0, _replaceableComponent.replaceableComponent)("views.settings.DevicesPanelEntry"), _dec(_class = class DevicesPanelEntry extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onDeviceToggled", () => {
      this.props.onDeviceToggled(this.props.device);
    });
    (0, _defineProperty2.default)(this, "onRename", () => {
      this.setState({
        renaming: true
      });
    });
    (0, _defineProperty2.default)(this, "onChangeDisplayName", ev => {
      this.setState({
        displayName: ev.target.value
      });
    });
    (0, _defineProperty2.default)(this, "onRenameSubmit", async () => {
      this.setState({
        renaming: false
      });
      await _MatrixClientPeg.MatrixClientPeg.get().setDeviceDetails(this.props.device.device_id, {
        display_name: this.state.displayName
      }).catch(e => {
        _logger.logger.error("Error setting session display name", e);

        throw new Error((0, _languageHandler._t)("Failed to set display name"));
      });
      this.props.onDeviceChange();
    });
    (0, _defineProperty2.default)(this, "onRenameCancel", () => {
      this.setState({
        renaming: false
      });
    });
    (0, _defineProperty2.default)(this, "onOwnDeviceSignOut", () => {
      _Modal.default.createTrackedDialog('Logout from device list', '', _LogoutDialog.default,
      /* props= */
      {},
      /* className= */
      null,
      /* isPriority= */
      false,
      /* isStatic= */
      true);
    });
    (0, _defineProperty2.default)(this, "verify", async () => {
      if (this.props.isOwnDevice) {
        _Modal.default.createTrackedDialog("Verify session", "Verify session", _SetupEncryptionDialog.default, {
          onFinished: this.props.onDeviceChange
        });
      } else {
        const cli = _MatrixClientPeg.MatrixClientPeg.get();

        const userId = cli.getUserId();
        const verificationRequestPromise = cli.requestVerification(userId, [this.props.device.device_id]);

        _Modal.default.createTrackedDialog('New Session Verification', 'Starting dialog', _VerificationRequestDialog.default, {
          verificationRequestPromise,
          member: cli.getUser(userId),
          onFinished: async () => {
            const request = await verificationRequestPromise;
            request.cancel();
            this.props.onDeviceChange();
          }
        });
      }
    });
    this.state = {
      renaming: false,
      displayName: props.device.display_name
    };
  }

  render() {
    const device = this.props.device;
    let lastSeen = "";

    if (device.last_seen_ts) {
      const lastSeenDate = new Date(device.last_seen_ts);
      lastSeen = (0, _languageHandler._t)("Last seen %(date)s at %(ip)s", {
        date: (0, _DateUtils.formatDate)(lastSeenDate),
        ip: device.last_seen_ip
      });
    }

    const myDeviceClass = this.props.isOwnDevice ? " mx_DevicesPanel_myDevice" : '';
    let iconClass = '';
    let verifyButton;

    if (this.props.verified !== null) {
      iconClass = this.props.verified ? "mx_E2EIcon_verified" : "mx_E2EIcon_warning";

      if (!this.props.verified && this.props.canBeVerified) {
        verifyButton = /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
          kind: "primary",
          onClick: this.verify
        }, (0, _languageHandler._t)("Verify"));
      }
    }

    let signOutButton;

    if (this.props.isOwnDevice) {
      signOutButton = /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        kind: "danger_outline",
        onClick: this.onOwnDeviceSignOut
      }, (0, _languageHandler._t)("Sign Out"));
    }

    const left = this.props.isOwnDevice ? /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_DevicesPanel_deviceTrust"
    }, /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_DevicesPanel_icon mx_E2EIcon " + iconClass
    })) : /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_DevicesPanel_checkbox"
    }, /*#__PURE__*/_react.default.createElement(_StyledCheckbox.default, {
      kind: _StyledCheckbox.CheckboxStyle.Outline,
      onChange: this.onDeviceToggled,
      checked: this.props.selected
    }));
    const deviceName = device.display_name ? /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement(_TextWithTooltip.default, {
      tooltip: device.display_name + " (" + device.device_id + ")"
    }, device.display_name)) : /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, device.device_id);
    const buttons = this.state.renaming ? /*#__PURE__*/_react.default.createElement("form", {
      className: "mx_DevicesPanel_renameForm",
      onSubmit: this.onRenameSubmit
    }, /*#__PURE__*/_react.default.createElement(_Field.default, {
      label: (0, _languageHandler._t)("Display Name"),
      type: "text",
      value: this.state.displayName,
      autoComplete: "off",
      onChange: this.onChangeDisplayName
    }), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      onClick: this.onRenameSubmit,
      kind: "confirm_sm"
    }), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      onClick: this.onRenameCancel,
      kind: "cancel_sm"
    })) : /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, signOutButton, verifyButton, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      kind: "primary_outline",
      onClick: this.onRename
    }, (0, _languageHandler._t)("Rename")));
    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_DevicesPanel_device" + myDeviceClass
    }, left, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_DevicesPanel_deviceInfo"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_DevicesPanel_deviceName"
    }, deviceName), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_DevicesPanel_lastSeen"
    }, lastSeen)), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_DevicesPanel_deviceButtons"
    }, buttons));
  }

}) || _class);
exports.default = DevicesPanelEntry;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3NldHRpbmdzL0RldmljZXNQYW5lbEVudHJ5LnRzeCJdLCJuYW1lcyI6WyJEZXZpY2VzUGFuZWxFbnRyeSIsIlJlYWN0IiwiQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsIm9uRGV2aWNlVG9nZ2xlZCIsImRldmljZSIsInNldFN0YXRlIiwicmVuYW1pbmciLCJldiIsImRpc3BsYXlOYW1lIiwidGFyZ2V0IiwidmFsdWUiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJzZXREZXZpY2VEZXRhaWxzIiwiZGV2aWNlX2lkIiwiZGlzcGxheV9uYW1lIiwic3RhdGUiLCJjYXRjaCIsImUiLCJsb2dnZXIiLCJlcnJvciIsIkVycm9yIiwib25EZXZpY2VDaGFuZ2UiLCJNb2RhbCIsImNyZWF0ZVRyYWNrZWREaWFsb2ciLCJMb2dvdXREaWFsb2ciLCJpc093bkRldmljZSIsIlNldHVwRW5jcnlwdGlvbkRpYWxvZyIsIm9uRmluaXNoZWQiLCJjbGkiLCJ1c2VySWQiLCJnZXRVc2VySWQiLCJ2ZXJpZmljYXRpb25SZXF1ZXN0UHJvbWlzZSIsInJlcXVlc3RWZXJpZmljYXRpb24iLCJWZXJpZmljYXRpb25SZXF1ZXN0RGlhbG9nIiwibWVtYmVyIiwiZ2V0VXNlciIsInJlcXVlc3QiLCJjYW5jZWwiLCJyZW5kZXIiLCJsYXN0U2VlbiIsImxhc3Rfc2Vlbl90cyIsImxhc3RTZWVuRGF0ZSIsIkRhdGUiLCJkYXRlIiwiaXAiLCJsYXN0X3NlZW5faXAiLCJteURldmljZUNsYXNzIiwiaWNvbkNsYXNzIiwidmVyaWZ5QnV0dG9uIiwidmVyaWZpZWQiLCJjYW5CZVZlcmlmaWVkIiwidmVyaWZ5Iiwic2lnbk91dEJ1dHRvbiIsIm9uT3duRGV2aWNlU2lnbk91dCIsImxlZnQiLCJDaGVja2JveFN0eWxlIiwiT3V0bGluZSIsInNlbGVjdGVkIiwiZGV2aWNlTmFtZSIsImJ1dHRvbnMiLCJvblJlbmFtZVN1Ym1pdCIsIm9uQ2hhbmdlRGlzcGxheU5hbWUiLCJvblJlbmFtZUNhbmNlbCIsIm9uUmVuYW1lIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWdCQTs7QUFHQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7Ozs7Ozs7SUFrQnFCQSxpQixXQURwQixnREFBcUIsa0NBQXJCLEMsZ0JBQUQsTUFDcUJBLGlCQURyQixTQUMrQ0MsZUFBTUMsU0FEckQsQ0FDK0U7QUFDM0VDLEVBQUFBLFdBQVcsQ0FBQ0MsS0FBRCxFQUFnQjtBQUN2QixVQUFNQSxLQUFOO0FBRHVCLDJEQVFELE1BQVk7QUFDbEMsV0FBS0EsS0FBTCxDQUFXQyxlQUFYLENBQTJCLEtBQUtELEtBQUwsQ0FBV0UsTUFBdEM7QUFDSCxLQVYwQjtBQUFBLG9EQVlSLE1BQVk7QUFDM0IsV0FBS0MsUUFBTCxDQUFjO0FBQUVDLFFBQUFBLFFBQVEsRUFBRTtBQUFaLE9BQWQ7QUFDSCxLQWQwQjtBQUFBLCtEQWdCSUMsRUFBRCxJQUFtRDtBQUM3RSxXQUFLRixRQUFMLENBQWM7QUFDVkcsUUFBQUEsV0FBVyxFQUFFRCxFQUFFLENBQUNFLE1BQUgsQ0FBVUM7QUFEYixPQUFkO0FBR0gsS0FwQjBCO0FBQUEsMERBc0JGLFlBQVk7QUFDakMsV0FBS0wsUUFBTCxDQUFjO0FBQUVDLFFBQUFBLFFBQVEsRUFBRTtBQUFaLE9BQWQ7QUFDQSxZQUFNSyxpQ0FBZ0JDLEdBQWhCLEdBQXNCQyxnQkFBdEIsQ0FBdUMsS0FBS1gsS0FBTCxDQUFXRSxNQUFYLENBQWtCVSxTQUF6RCxFQUFvRTtBQUN0RUMsUUFBQUEsWUFBWSxFQUFFLEtBQUtDLEtBQUwsQ0FBV1I7QUFENkMsT0FBcEUsRUFFSFMsS0FGRyxDQUVJQyxDQUFELElBQU87QUFDWkMsdUJBQU9DLEtBQVAsQ0FBYSxvQ0FBYixFQUFtREYsQ0FBbkQ7O0FBQ0EsY0FBTSxJQUFJRyxLQUFKLENBQVUseUJBQUcsNEJBQUgsQ0FBVixDQUFOO0FBQ0gsT0FMSyxDQUFOO0FBTUEsV0FBS25CLEtBQUwsQ0FBV29CLGNBQVg7QUFDSCxLQS9CMEI7QUFBQSwwREFpQ0YsTUFBWTtBQUNqQyxXQUFLakIsUUFBTCxDQUFjO0FBQUVDLFFBQUFBLFFBQVEsRUFBRTtBQUFaLE9BQWQ7QUFDSCxLQW5DMEI7QUFBQSw4REFxQ0UsTUFBWTtBQUNyQ2lCLHFCQUFNQyxtQkFBTixDQUEwQix5QkFBMUIsRUFBcUQsRUFBckQsRUFBeURDLHFCQUF6RDtBQUNJO0FBQVksUUFEaEI7QUFDb0I7QUFBZ0IsVUFEcEM7QUFFSTtBQUFpQixXQUZyQjtBQUU0QjtBQUFlLFVBRjNDO0FBR0gsS0F6QzBCO0FBQUEsa0RBMkNWLFlBQVk7QUFDekIsVUFBSSxLQUFLdkIsS0FBTCxDQUFXd0IsV0FBZixFQUE0QjtBQUN4QkgsdUJBQU1DLG1CQUFOLENBQTBCLGdCQUExQixFQUE0QyxnQkFBNUMsRUFBOERHLDhCQUE5RCxFQUFxRjtBQUNqRkMsVUFBQUEsVUFBVSxFQUFFLEtBQUsxQixLQUFMLENBQVdvQjtBQUQwRCxTQUFyRjtBQUdILE9BSkQsTUFJTztBQUNILGNBQU1PLEdBQUcsR0FBR2xCLGlDQUFnQkMsR0FBaEIsRUFBWjs7QUFDQSxjQUFNa0IsTUFBTSxHQUFHRCxHQUFHLENBQUNFLFNBQUosRUFBZjtBQUNBLGNBQU1DLDBCQUEwQixHQUFHSCxHQUFHLENBQUNJLG1CQUFKLENBQy9CSCxNQUQrQixFQUUvQixDQUFDLEtBQUs1QixLQUFMLENBQVdFLE1BQVgsQ0FBa0JVLFNBQW5CLENBRitCLENBQW5DOztBQUlBUyx1QkFBTUMsbUJBQU4sQ0FBMEIsMEJBQTFCLEVBQXNELGlCQUF0RCxFQUF5RVUsa0NBQXpFLEVBQW9HO0FBQ2hHRixVQUFBQSwwQkFEZ0c7QUFFaEdHLFVBQUFBLE1BQU0sRUFBRU4sR0FBRyxDQUFDTyxPQUFKLENBQVlOLE1BQVosQ0FGd0Y7QUFHaEdGLFVBQUFBLFVBQVUsRUFBRSxZQUFZO0FBQ3BCLGtCQUFNUyxPQUFPLEdBQUcsTUFBTUwsMEJBQXRCO0FBQ0FLLFlBQUFBLE9BQU8sQ0FBQ0MsTUFBUjtBQUNBLGlCQUFLcEMsS0FBTCxDQUFXb0IsY0FBWDtBQUNIO0FBUCtGLFNBQXBHO0FBU0g7QUFDSixLQWpFMEI7QUFFdkIsU0FBS04sS0FBTCxHQUFhO0FBQ1RWLE1BQUFBLFFBQVEsRUFBRSxLQUREO0FBRVRFLE1BQUFBLFdBQVcsRUFBRU4sS0FBSyxDQUFDRSxNQUFOLENBQWFXO0FBRmpCLEtBQWI7QUFJSDs7QUE2RE13QixFQUFBQSxNQUFNLEdBQWdCO0FBQ3pCLFVBQU1uQyxNQUFNLEdBQUcsS0FBS0YsS0FBTCxDQUFXRSxNQUExQjtBQUVBLFFBQUlvQyxRQUFRLEdBQUcsRUFBZjs7QUFDQSxRQUFJcEMsTUFBTSxDQUFDcUMsWUFBWCxFQUF5QjtBQUNyQixZQUFNQyxZQUFZLEdBQUcsSUFBSUMsSUFBSixDQUFTdkMsTUFBTSxDQUFDcUMsWUFBaEIsQ0FBckI7QUFDQUQsTUFBQUEsUUFBUSxHQUFHLHlCQUFHLDhCQUFILEVBQW1DO0FBQzFDSSxRQUFBQSxJQUFJLEVBQUUsMkJBQVdGLFlBQVgsQ0FEb0M7QUFFMUNHLFFBQUFBLEVBQUUsRUFBRXpDLE1BQU0sQ0FBQzBDO0FBRitCLE9BQW5DLENBQVg7QUFJSDs7QUFFRCxVQUFNQyxhQUFhLEdBQUcsS0FBSzdDLEtBQUwsQ0FBV3dCLFdBQVgsR0FBeUIsMkJBQXpCLEdBQXVELEVBQTdFO0FBRUEsUUFBSXNCLFNBQVMsR0FBRyxFQUFoQjtBQUNBLFFBQUlDLFlBQUo7O0FBQ0EsUUFBSSxLQUFLL0MsS0FBTCxDQUFXZ0QsUUFBWCxLQUF3QixJQUE1QixFQUFrQztBQUM5QkYsTUFBQUEsU0FBUyxHQUFHLEtBQUs5QyxLQUFMLENBQVdnRCxRQUFYLEdBQXNCLHFCQUF0QixHQUE4QyxvQkFBMUQ7O0FBQ0EsVUFBSSxDQUFDLEtBQUtoRCxLQUFMLENBQVdnRCxRQUFaLElBQXdCLEtBQUtoRCxLQUFMLENBQVdpRCxhQUF2QyxFQUFzRDtBQUNsREYsUUFBQUEsWUFBWSxnQkFBRyw2QkFBQyx5QkFBRDtBQUFrQixVQUFBLElBQUksRUFBQyxTQUF2QjtBQUFpQyxVQUFBLE9BQU8sRUFBRSxLQUFLRztBQUEvQyxXQUNULHlCQUFHLFFBQUgsQ0FEUyxDQUFmO0FBR0g7QUFDSjs7QUFFRCxRQUFJQyxhQUFKOztBQUNBLFFBQUksS0FBS25ELEtBQUwsQ0FBV3dCLFdBQWYsRUFBNEI7QUFDeEIyQixNQUFBQSxhQUFhLGdCQUFHLDZCQUFDLHlCQUFEO0FBQWtCLFFBQUEsSUFBSSxFQUFDLGdCQUF2QjtBQUF3QyxRQUFBLE9BQU8sRUFBRSxLQUFLQztBQUF0RCxTQUNWLHlCQUFHLFVBQUgsQ0FEVSxDQUFoQjtBQUdIOztBQUVELFVBQU1DLElBQUksR0FBRyxLQUFLckQsS0FBTCxDQUFXd0IsV0FBWCxnQkFDVDtBQUFLLE1BQUEsU0FBUyxFQUFDO0FBQWYsb0JBQ0k7QUFBTSxNQUFBLFNBQVMsRUFBRSxxQ0FBcUNzQjtBQUF0RCxNQURKLENBRFMsZ0JBSVQ7QUFBSyxNQUFBLFNBQVMsRUFBQztBQUFmLG9CQUNJLDZCQUFDLHVCQUFEO0FBQWdCLE1BQUEsSUFBSSxFQUFFUSw4QkFBY0MsT0FBcEM7QUFBNkMsTUFBQSxRQUFRLEVBQUUsS0FBS3RELGVBQTVEO0FBQTZFLE1BQUEsT0FBTyxFQUFFLEtBQUtELEtBQUwsQ0FBV3dEO0FBQWpHLE1BREosQ0FKSjtBQVFBLFVBQU1DLFVBQVUsR0FBR3ZELE1BQU0sQ0FBQ1csWUFBUCxnQkFDZiw2QkFBQyxjQUFELENBQU8sUUFBUCxxQkFDSSw2QkFBQyx3QkFBRDtBQUFpQixNQUFBLE9BQU8sRUFBRVgsTUFBTSxDQUFDVyxZQUFQLEdBQXNCLElBQXRCLEdBQTZCWCxNQUFNLENBQUNVLFNBQXBDLEdBQWdEO0FBQTFFLE9BQ01WLE1BQU0sQ0FBQ1csWUFEYixDQURKLENBRGUsZ0JBTWYsNkJBQUMsY0FBRCxDQUFPLFFBQVAsUUFDTVgsTUFBTSxDQUFDVSxTQURiLENBTko7QUFVQSxVQUFNOEMsT0FBTyxHQUFHLEtBQUs1QyxLQUFMLENBQVdWLFFBQVgsZ0JBQ1o7QUFBTSxNQUFBLFNBQVMsRUFBQyw0QkFBaEI7QUFBNkMsTUFBQSxRQUFRLEVBQUUsS0FBS3VEO0FBQTVELG9CQUNJLDZCQUFDLGNBQUQ7QUFDSSxNQUFBLEtBQUssRUFBRSx5QkFBRyxjQUFILENBRFg7QUFFSSxNQUFBLElBQUksRUFBQyxNQUZUO0FBR0ksTUFBQSxLQUFLLEVBQUUsS0FBSzdDLEtBQUwsQ0FBV1IsV0FIdEI7QUFJSSxNQUFBLFlBQVksRUFBQyxLQUpqQjtBQUtJLE1BQUEsUUFBUSxFQUFFLEtBQUtzRDtBQUxuQixNQURKLGVBUUksNkJBQUMseUJBQUQ7QUFBa0IsTUFBQSxPQUFPLEVBQUUsS0FBS0QsY0FBaEM7QUFBZ0QsTUFBQSxJQUFJLEVBQUM7QUFBckQsTUFSSixlQVNJLDZCQUFDLHlCQUFEO0FBQWtCLE1BQUEsT0FBTyxFQUFFLEtBQUtFLGNBQWhDO0FBQWdELE1BQUEsSUFBSSxFQUFDO0FBQXJELE1BVEosQ0FEWSxnQkFZWiw2QkFBQyxjQUFELENBQU8sUUFBUCxRQUNNVixhQUROLEVBRU1KLFlBRk4sZUFHSSw2QkFBQyx5QkFBRDtBQUFrQixNQUFBLElBQUksRUFBQyxpQkFBdkI7QUFBeUMsTUFBQSxPQUFPLEVBQUUsS0FBS2U7QUFBdkQsT0FDTSx5QkFBRyxRQUFILENBRE4sQ0FISixDQVpKO0FBb0JBLHdCQUNJO0FBQUssTUFBQSxTQUFTLEVBQUUsMkJBQTJCakI7QUFBM0MsT0FDTVEsSUFETixlQUVJO0FBQUssTUFBQSxTQUFTLEVBQUM7QUFBZixvQkFDSTtBQUFLLE1BQUEsU0FBUyxFQUFDO0FBQWYsT0FDTUksVUFETixDQURKLGVBSUk7QUFBSyxNQUFBLFNBQVMsRUFBQztBQUFmLE9BQ01uQixRQUROLENBSkosQ0FGSixlQVVJO0FBQUssTUFBQSxTQUFTLEVBQUM7QUFBZixPQUNNb0IsT0FETixDQVZKLENBREo7QUFnQkg7O0FBMUowRSxDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE2IC0gMjAyMSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBJTXlEZXZpY2UgfSBmcm9tICdtYXRyaXgtanMtc2RrL3NyYy9jbGllbnQnO1xuXG5pbXBvcnQgeyBfdCB9IGZyb20gJy4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlcic7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tICcuLi8uLi8uLi9NYXRyaXhDbGllbnRQZWcnO1xuaW1wb3J0IHsgZm9ybWF0RGF0ZSB9IGZyb20gJy4uLy4uLy4uL0RhdGVVdGlscyc7XG5pbXBvcnQgU3R5bGVkQ2hlY2tib3ggZnJvbSAnLi4vZWxlbWVudHMvU3R5bGVkQ2hlY2tib3gnO1xuaW1wb3J0IHsgQ2hlY2tib3hTdHlsZSB9IGZyb20gJy4uL2VsZW1lbnRzL1N0eWxlZENoZWNrYm94JztcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5pbXBvcnQgQWNjZXNzaWJsZUJ1dHRvbiBmcm9tIFwiLi4vZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvblwiO1xuaW1wb3J0IEZpZWxkIGZyb20gXCIuLi9lbGVtZW50cy9GaWVsZFwiO1xuaW1wb3J0IFRleHRXaXRoVG9vbHRpcCBmcm9tIFwiLi4vZWxlbWVudHMvVGV4dFdpdGhUb29sdGlwXCI7XG5pbXBvcnQgTW9kYWwgZnJvbSBcIi4uLy4uLy4uL01vZGFsXCI7XG5pbXBvcnQgU2V0dXBFbmNyeXB0aW9uRGlhbG9nIGZyb20gJy4uL2RpYWxvZ3Mvc2VjdXJpdHkvU2V0dXBFbmNyeXB0aW9uRGlhbG9nJztcbmltcG9ydCBWZXJpZmljYXRpb25SZXF1ZXN0RGlhbG9nIGZyb20gJy4uLy4uL3ZpZXdzL2RpYWxvZ3MvVmVyaWZpY2F0aW9uUmVxdWVzdERpYWxvZyc7XG5pbXBvcnQgTG9nb3V0RGlhbG9nIGZyb20gJy4uL2RpYWxvZ3MvTG9nb3V0RGlhbG9nJztcblxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2xvZ2dlclwiO1xuXG5pbnRlcmZhY2UgSVByb3BzIHtcbiAgICBkZXZpY2U6IElNeURldmljZTtcbiAgICBpc093bkRldmljZTogYm9vbGVhbjtcbiAgICB2ZXJpZmllZDogYm9vbGVhbiB8IG51bGw7XG4gICAgY2FuQmVWZXJpZmllZDogYm9vbGVhbjtcbiAgICBvbkRldmljZUNoYW5nZTogKCkgPT4gdm9pZDtcbiAgICBvbkRldmljZVRvZ2dsZWQ6IChkZXZpY2U6IElNeURldmljZSkgPT4gdm9pZDtcbiAgICBzZWxlY3RlZDogYm9vbGVhbjtcbn1cblxuaW50ZXJmYWNlIElTdGF0ZSB7XG4gICAgcmVuYW1pbmc6IGJvb2xlYW47XG4gICAgZGlzcGxheU5hbWU6IHN0cmluZztcbn1cblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3Muc2V0dGluZ3MuRGV2aWNlc1BhbmVsRW50cnlcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIERldmljZXNQYW5lbEVudHJ5IGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PElQcm9wcywgSVN0YXRlPiB7XG4gICAgY29uc3RydWN0b3IocHJvcHM6IElQcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICByZW5hbWluZzogZmFsc2UsXG4gICAgICAgICAgICBkaXNwbGF5TmFtZTogcHJvcHMuZGV2aWNlLmRpc3BsYXlfbmFtZSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uRGV2aWNlVG9nZ2xlZCA9ICgpOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5wcm9wcy5vbkRldmljZVRvZ2dsZWQodGhpcy5wcm9wcy5kZXZpY2UpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uUmVuYW1lID0gKCk6IHZvaWQgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgcmVuYW1pbmc6IHRydWUgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25DaGFuZ2VEaXNwbGF5TmFtZSA9IChldjogUmVhY3QuQ2hhbmdlRXZlbnQ8SFRNTElucHV0RWxlbWVudD4pOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBkaXNwbGF5TmFtZTogZXYudGFyZ2V0LnZhbHVlLFxuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvblJlbmFtZVN1Ym1pdCA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IHJlbmFtaW5nOiBmYWxzZSB9KTtcbiAgICAgICAgYXdhaXQgTWF0cml4Q2xpZW50UGVnLmdldCgpLnNldERldmljZURldGFpbHModGhpcy5wcm9wcy5kZXZpY2UuZGV2aWNlX2lkLCB7XG4gICAgICAgICAgICBkaXNwbGF5X25hbWU6IHRoaXMuc3RhdGUuZGlzcGxheU5hbWUsXG4gICAgICAgIH0pLmNhdGNoKChlKSA9PiB7XG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoXCJFcnJvciBzZXR0aW5nIHNlc3Npb24gZGlzcGxheSBuYW1lXCIsIGUpO1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKF90KFwiRmFpbGVkIHRvIHNldCBkaXNwbGF5IG5hbWVcIikpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5wcm9wcy5vbkRldmljZUNoYW5nZSgpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uUmVuYW1lQ2FuY2VsID0gKCk6IHZvaWQgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgcmVuYW1pbmc6IGZhbHNlIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uT3duRGV2aWNlU2lnbk91dCA9ICgpOiB2b2lkID0+IHtcbiAgICAgICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZygnTG9nb3V0IGZyb20gZGV2aWNlIGxpc3QnLCAnJywgTG9nb3V0RGlhbG9nLFxuICAgICAgICAgICAgLyogcHJvcHM9ICove30sIC8qIGNsYXNzTmFtZT0gKi9udWxsLFxuICAgICAgICAgICAgLyogaXNQcmlvcml0eT0gKi9mYWxzZSwgLyogaXNTdGF0aWM9ICovdHJ1ZSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgdmVyaWZ5ID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICBpZiAodGhpcy5wcm9wcy5pc093bkRldmljZSkge1xuICAgICAgICAgICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZyhcIlZlcmlmeSBzZXNzaW9uXCIsIFwiVmVyaWZ5IHNlc3Npb25cIiwgU2V0dXBFbmNyeXB0aW9uRGlhbG9nLCB7XG4gICAgICAgICAgICAgICAgb25GaW5pc2hlZDogdGhpcy5wcm9wcy5vbkRldmljZUNoYW5nZSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgY2xpID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuICAgICAgICAgICAgY29uc3QgdXNlcklkID0gY2xpLmdldFVzZXJJZCgpO1xuICAgICAgICAgICAgY29uc3QgdmVyaWZpY2F0aW9uUmVxdWVzdFByb21pc2UgPSBjbGkucmVxdWVzdFZlcmlmaWNhdGlvbihcbiAgICAgICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICAgICAgW3RoaXMucHJvcHMuZGV2aWNlLmRldmljZV9pZF0sXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZygnTmV3IFNlc3Npb24gVmVyaWZpY2F0aW9uJywgJ1N0YXJ0aW5nIGRpYWxvZycsIFZlcmlmaWNhdGlvblJlcXVlc3REaWFsb2csIHtcbiAgICAgICAgICAgICAgICB2ZXJpZmljYXRpb25SZXF1ZXN0UHJvbWlzZSxcbiAgICAgICAgICAgICAgICBtZW1iZXI6IGNsaS5nZXRVc2VyKHVzZXJJZCksXG4gICAgICAgICAgICAgICAgb25GaW5pc2hlZDogYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCByZXF1ZXN0ID0gYXdhaXQgdmVyaWZpY2F0aW9uUmVxdWVzdFByb21pc2U7XG4gICAgICAgICAgICAgICAgICAgIHJlcXVlc3QuY2FuY2VsKCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucHJvcHMub25EZXZpY2VDaGFuZ2UoKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHVibGljIHJlbmRlcigpOiBKU1guRWxlbWVudCB7XG4gICAgICAgIGNvbnN0IGRldmljZSA9IHRoaXMucHJvcHMuZGV2aWNlO1xuXG4gICAgICAgIGxldCBsYXN0U2VlbiA9IFwiXCI7XG4gICAgICAgIGlmIChkZXZpY2UubGFzdF9zZWVuX3RzKSB7XG4gICAgICAgICAgICBjb25zdCBsYXN0U2VlbkRhdGUgPSBuZXcgRGF0ZShkZXZpY2UubGFzdF9zZWVuX3RzKTtcbiAgICAgICAgICAgIGxhc3RTZWVuID0gX3QoXCJMYXN0IHNlZW4gJShkYXRlKXMgYXQgJShpcClzXCIsIHtcbiAgICAgICAgICAgICAgICBkYXRlOiBmb3JtYXREYXRlKGxhc3RTZWVuRGF0ZSksXG4gICAgICAgICAgICAgICAgaXA6IGRldmljZS5sYXN0X3NlZW5faXAsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG15RGV2aWNlQ2xhc3MgPSB0aGlzLnByb3BzLmlzT3duRGV2aWNlID8gXCIgbXhfRGV2aWNlc1BhbmVsX215RGV2aWNlXCIgOiAnJztcblxuICAgICAgICBsZXQgaWNvbkNsYXNzID0gJyc7XG4gICAgICAgIGxldCB2ZXJpZnlCdXR0b246IEpTWC5FbGVtZW50O1xuICAgICAgICBpZiAodGhpcy5wcm9wcy52ZXJpZmllZCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgaWNvbkNsYXNzID0gdGhpcy5wcm9wcy52ZXJpZmllZCA/IFwibXhfRTJFSWNvbl92ZXJpZmllZFwiIDogXCJteF9FMkVJY29uX3dhcm5pbmdcIjtcbiAgICAgICAgICAgIGlmICghdGhpcy5wcm9wcy52ZXJpZmllZCAmJiB0aGlzLnByb3BzLmNhbkJlVmVyaWZpZWQpIHtcbiAgICAgICAgICAgICAgICB2ZXJpZnlCdXR0b24gPSA8QWNjZXNzaWJsZUJ1dHRvbiBraW5kPVwicHJpbWFyeVwiIG9uQ2xpY2s9e3RoaXMudmVyaWZ5fT5cbiAgICAgICAgICAgICAgICAgICAgeyBfdChcIlZlcmlmeVwiKSB9XG4gICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBzaWduT3V0QnV0dG9uOiBKU1guRWxlbWVudDtcbiAgICAgICAgaWYgKHRoaXMucHJvcHMuaXNPd25EZXZpY2UpIHtcbiAgICAgICAgICAgIHNpZ25PdXRCdXR0b24gPSA8QWNjZXNzaWJsZUJ1dHRvbiBraW5kPVwiZGFuZ2VyX291dGxpbmVcIiBvbkNsaWNrPXt0aGlzLm9uT3duRGV2aWNlU2lnbk91dH0+XG4gICAgICAgICAgICAgICAgeyBfdChcIlNpZ24gT3V0XCIpIH1cbiAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBsZWZ0ID0gdGhpcy5wcm9wcy5pc093bkRldmljZSA/XG4gICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0RldmljZXNQYW5lbF9kZXZpY2VUcnVzdFwiPlxuICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT17XCJteF9EZXZpY2VzUGFuZWxfaWNvbiBteF9FMkVJY29uIFwiICsgaWNvbkNsYXNzfSAvPlxuICAgICAgICAgICAgPC9kaXY+IDpcbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfRGV2aWNlc1BhbmVsX2NoZWNrYm94XCI+XG4gICAgICAgICAgICAgICAgPFN0eWxlZENoZWNrYm94IGtpbmQ9e0NoZWNrYm94U3R5bGUuT3V0bGluZX0gb25DaGFuZ2U9e3RoaXMub25EZXZpY2VUb2dnbGVkfSBjaGVja2VkPXt0aGlzLnByb3BzLnNlbGVjdGVkfSAvPlxuICAgICAgICAgICAgPC9kaXY+O1xuXG4gICAgICAgIGNvbnN0IGRldmljZU5hbWUgPSBkZXZpY2UuZGlzcGxheV9uYW1lID9cbiAgICAgICAgICAgIDxSZWFjdC5GcmFnbWVudD5cbiAgICAgICAgICAgICAgICA8VGV4dFdpdGhUb29sdGlwIHRvb2x0aXA9e2RldmljZS5kaXNwbGF5X25hbWUgKyBcIiAoXCIgKyBkZXZpY2UuZGV2aWNlX2lkICsgXCIpXCJ9PlxuICAgICAgICAgICAgICAgICAgICB7IGRldmljZS5kaXNwbGF5X25hbWUgfVxuICAgICAgICAgICAgICAgIDwvVGV4dFdpdGhUb29sdGlwPlxuICAgICAgICAgICAgPC9SZWFjdC5GcmFnbWVudD4gOlxuICAgICAgICAgICAgPFJlYWN0LkZyYWdtZW50PlxuICAgICAgICAgICAgICAgIHsgZGV2aWNlLmRldmljZV9pZCB9XG4gICAgICAgICAgICA8L1JlYWN0LkZyYWdtZW50PjtcblxuICAgICAgICBjb25zdCBidXR0b25zID0gdGhpcy5zdGF0ZS5yZW5hbWluZyA/XG4gICAgICAgICAgICA8Zm9ybSBjbGFzc05hbWU9XCJteF9EZXZpY2VzUGFuZWxfcmVuYW1lRm9ybVwiIG9uU3VibWl0PXt0aGlzLm9uUmVuYW1lU3VibWl0fT5cbiAgICAgICAgICAgICAgICA8RmllbGRcbiAgICAgICAgICAgICAgICAgICAgbGFiZWw9e190KFwiRGlzcGxheSBOYW1lXCIpfVxuICAgICAgICAgICAgICAgICAgICB0eXBlPVwidGV4dFwiXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlPXt0aGlzLnN0YXRlLmRpc3BsYXlOYW1lfVxuICAgICAgICAgICAgICAgICAgICBhdXRvQ29tcGxldGU9XCJvZmZcIlxuICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZT17dGhpcy5vbkNoYW5nZURpc3BsYXlOYW1lfVxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b24gb25DbGljaz17dGhpcy5vblJlbmFtZVN1Ym1pdH0ga2luZD1cImNvbmZpcm1fc21cIiAvPlxuICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uIG9uQ2xpY2s9e3RoaXMub25SZW5hbWVDYW5jZWx9IGtpbmQ9XCJjYW5jZWxfc21cIiAvPlxuICAgICAgICAgICAgPC9mb3JtPiA6XG4gICAgICAgICAgICA8UmVhY3QuRnJhZ21lbnQ+XG4gICAgICAgICAgICAgICAgeyBzaWduT3V0QnV0dG9uIH1cbiAgICAgICAgICAgICAgICB7IHZlcmlmeUJ1dHRvbiB9XG4gICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b24ga2luZD1cInByaW1hcnlfb3V0bGluZVwiIG9uQ2xpY2s9e3RoaXMub25SZW5hbWV9PlxuICAgICAgICAgICAgICAgICAgICB7IF90KFwiUmVuYW1lXCIpIH1cbiAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICA8L1JlYWN0LkZyYWdtZW50PjtcblxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9e1wibXhfRGV2aWNlc1BhbmVsX2RldmljZVwiICsgbXlEZXZpY2VDbGFzc30+XG4gICAgICAgICAgICAgICAgeyBsZWZ0IH1cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0RldmljZXNQYW5lbF9kZXZpY2VJbmZvXCI+XG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfRGV2aWNlc1BhbmVsX2RldmljZU5hbWVcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgZGV2aWNlTmFtZSB9XG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0RldmljZXNQYW5lbF9sYXN0U2VlblwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBsYXN0U2VlbiB9XG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfRGV2aWNlc1BhbmVsX2RldmljZUJ1dHRvbnNcIj5cbiAgICAgICAgICAgICAgICAgICAgeyBidXR0b25zIH1cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICApO1xuICAgIH1cbn1cbiJdfQ==