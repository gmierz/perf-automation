"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _classnames = _interopRequireDefault(require("classnames"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _languageHandler = require("../../../languageHandler");

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _InteractiveAuthEntryComponents = require("../auth/InteractiveAuthEntryComponents");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _InteractiveAuthDialog = _interopRequireDefault(require("../dialogs/InteractiveAuthDialog"));

var _DevicesPanelEntry = _interopRequireDefault(require("./DevicesPanelEntry"));

var _Spinner = _interopRequireDefault(require("../elements/Spinner"));

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class;

let DevicesPanel = (_dec = (0, _replaceableComponent.replaceableComponent)("views.settings.DevicesPanel"), _dec(_class = class DevicesPanel extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "unmounted", false);
    (0, _defineProperty2.default)(this, "onDeviceSelectionToggled", device => {
      if (this.unmounted) {
        return;
      }

      const deviceId = device.device_id;
      this.setState((state, props) => {
        // Make a copy of the selected devices, then add or remove the device
        const selectedDevices = state.selectedDevices.slice();
        const i = selectedDevices.indexOf(deviceId);

        if (i === -1) {
          selectedDevices.push(deviceId);
        } else {
          selectedDevices.splice(i, 1);
        }

        return {
          selectedDevices
        };
      });
    });
    (0, _defineProperty2.default)(this, "selectAll", devices => {
      this.setState((state, props) => {
        const selectedDevices = state.selectedDevices.slice();

        for (const device of devices) {
          const deviceId = device.device_id;

          if (!selectedDevices.includes(deviceId)) {
            selectedDevices.push(deviceId);
          }
        }

        return {
          selectedDevices
        };
      });
    });
    (0, _defineProperty2.default)(this, "deselectAll", devices => {
      this.setState((state, props) => {
        const selectedDevices = state.selectedDevices.slice();

        for (const device of devices) {
          const deviceId = device.device_id;
          const i = selectedDevices.indexOf(deviceId);

          if (i !== -1) {
            selectedDevices.splice(i, 1);
          }
        }

        return {
          selectedDevices
        };
      });
    });
    (0, _defineProperty2.default)(this, "onDeleteClick", () => {
      if (this.state.selectedDevices.length === 0) {
        return;
      }

      this.setState({
        deleting: true
      });
      this.makeDeleteRequest(null).catch(error => {
        if (this.unmounted) {
          return;
        }

        if (error.httpStatus !== 401 || !error.data || !error.data.flows) {
          // doesn't look like an interactive-auth failure
          throw error;
        } // pop up an interactive auth dialog


        const numDevices = this.state.selectedDevices.length;
        const dialogAesthetics = {
          [_InteractiveAuthEntryComponents.SSOAuthEntry.PHASE_PREAUTH]: {
            title: (0, _languageHandler._t)("Use Single Sign On to continue"),
            body: (0, _languageHandler._t)("Confirm logging out these devices by using Single Sign On to prove your identity.", {
              count: numDevices
            }),
            continueText: (0, _languageHandler._t)("Single Sign On"),
            continueKind: "primary"
          },
          [_InteractiveAuthEntryComponents.SSOAuthEntry.PHASE_POSTAUTH]: {
            title: (0, _languageHandler._t)("Confirm signing out these devices"),
            body: (0, _languageHandler._t)("Click the button below to confirm signing out these devices.", {
              count: numDevices
            }),
            continueText: (0, _languageHandler._t)("Sign out devices", {
              count: numDevices
            }),
            continueKind: "danger"
          }
        };

        _Modal.default.createTrackedDialog('Delete Device Dialog', '', _InteractiveAuthDialog.default, {
          title: (0, _languageHandler._t)("Authentication"),
          matrixClient: _MatrixClientPeg.MatrixClientPeg.get(),
          authData: error.data,
          makeRequest: this.makeDeleteRequest.bind(this),
          aestheticsForStagePhases: {
            [_InteractiveAuthEntryComponents.SSOAuthEntry.LOGIN_TYPE]: dialogAesthetics,
            [_InteractiveAuthEntryComponents.SSOAuthEntry.UNSTABLE_LOGIN_TYPE]: dialogAesthetics
          }
        });
      }).catch(e => {
        _logger.logger.error("Error deleting sessions", e);

        if (this.unmounted) {
          return;
        }
      }).finally(() => {
        this.setState({
          deleting: false
        });
      });
    });
    (0, _defineProperty2.default)(this, "renderDevice", device => {
      const myDeviceId = _MatrixClientPeg.MatrixClientPeg.get().getDeviceId();

      const myDevice = this.state.devices.find(device => device.device_id === myDeviceId);
      const isOwnDevice = device.device_id === myDeviceId; // If our own device is unverified, it can't verify other
      // devices, it can only request verification for itself

      const canBeVerified = myDevice && this.isDeviceVerified(myDevice) || isOwnDevice;
      return /*#__PURE__*/_react.default.createElement(_DevicesPanelEntry.default, {
        key: device.device_id,
        device: device,
        selected: this.state.selectedDevices.includes(device.device_id),
        isOwnDevice: isOwnDevice,
        verified: this.isDeviceVerified(device),
        canBeVerified: canBeVerified,
        onDeviceChange: this.loadDevices,
        onDeviceToggled: this.onDeviceSelectionToggled
      });
    });
    this.state = {
      devices: [],
      selectedDevices: []
    };
    this.loadDevices = this.loadDevices.bind(this);
  }

  componentDidMount() {
    this.loadDevices();
  }

  componentWillUnmount() {
    this.unmounted = true;
  }

  loadDevices() {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    cli.getDevices().then(resp => {
      if (this.unmounted) {
        return;
      }

      const crossSigningInfo = cli.getStoredCrossSigningForUser(cli.getUserId());
      this.setState((state, props) => {
        const deviceIds = resp.devices.map(device => device.device_id);
        const selectedDevices = state.selectedDevices.filter(deviceId => deviceIds.includes(deviceId));
        return {
          devices: resp.devices || [],
          selectedDevices,
          crossSigningInfo: crossSigningInfo
        };
      });
      console.log(this.state);
    }, error => {
      if (this.unmounted) {
        return;
      }

      let errtxt;

      if (error.httpStatus == 404) {
        // 404 probably means the HS doesn't yet support the API.
        errtxt = (0, _languageHandler._t)("Your homeserver does not support device management.");
      } else {
        _logger.logger.error("Error loading sessions:", error);

        errtxt = (0, _languageHandler._t)("Unable to load device list");
      }

      this.setState({
        deviceLoadError: errtxt
      });
    });
  }
  /*
   * compare two devices, sorting from most-recently-seen to least-recently-seen
   * (and then, for stability, by device id)
   */


  deviceCompare(a, b) {
    // return < 0 if a comes before b, > 0 if a comes after b.
    const lastSeenDelta = (b.last_seen_ts || 0) - (a.last_seen_ts || 0);

    if (lastSeenDelta !== 0) {
      return lastSeenDelta;
    }

    const idA = a.device_id;
    const idB = b.device_id;
    return idA < idB ? -1 : idA > idB ? 1 : 0;
  }

  isDeviceVerified(device) {
    try {
      const cli = _MatrixClientPeg.MatrixClientPeg.get();

      const deviceInfo = cli.getStoredDevice(cli.getUserId(), device.device_id);
      return this.state.crossSigningInfo.checkDeviceTrust(this.state.crossSigningInfo, deviceInfo, false, true).isCrossSigningVerified();
    } catch (e) {
      console.error("Error getting device cross-signing info", e);
      return null;
    }
  }

  // TODO: proper typing for auth
  makeDeleteRequest(auth) {
    return _MatrixClientPeg.MatrixClientPeg.get().deleteMultipleDevices(this.state.selectedDevices, auth).then(() => {
      // Reset selection to [], update device list
      this.setState({
        selectedDevices: []
      });
      this.loadDevices();
    });
  }

  render() {
    const loadError = /*#__PURE__*/_react.default.createElement("div", {
      className: (0, _classnames.default)(this.props.className, "error")
    }, this.state.deviceLoadError);

    if (this.state.deviceLoadError !== undefined) {
      return loadError;
    }

    const devices = this.state.devices;

    if (devices === undefined) {
      // still loading
      return /*#__PURE__*/_react.default.createElement(_Spinner.default, null);
    }

    const myDeviceId = _MatrixClientPeg.MatrixClientPeg.get().getDeviceId();

    const myDevice = devices.find(device => device.device_id === myDeviceId);

    if (!myDevice) {
      return loadError;
    }

    const otherDevices = devices.filter(device => device.device_id !== myDeviceId);
    otherDevices.sort(this.deviceCompare);
    const verifiedDevices = [];
    const unverifiedDevices = [];
    const nonCryptoDevices = [];

    for (const device of otherDevices) {
      const verified = this.isDeviceVerified(device);

      if (verified === true) {
        verifiedDevices.push(device);
      } else if (verified === false) {
        unverifiedDevices.push(device);
      } else {
        nonCryptoDevices.push(device);
      }
    }

    const section = (trustIcon, title, deviceList) => {
      if (deviceList.length === 0) {
        return /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null);
      }

      let selectButton;

      if (deviceList.length > 1) {
        const anySelected = deviceList.some(device => this.state.selectedDevices.includes(device.device_id));
        const buttonAction = anySelected ? () => {
          this.deselectAll(deviceList);
        } : () => {
          this.selectAll(deviceList);
        };
        const buttonText = anySelected ? (0, _languageHandler._t)("Deselect all") : (0, _languageHandler._t)("Select all");
        selectButton = /*#__PURE__*/_react.default.createElement("div", {
          className: "mx_DevicesPanel_header_button"
        }, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
          className: "mx_DevicesPanel_selectButton",
          kind: "secondary",
          onClick: buttonAction
        }, buttonText));
      }

      return /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement("hr", null), /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_DevicesPanel_header"
      }, /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_DevicesPanel_header_trust"
      }, trustIcon), /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_DevicesPanel_header_title"
      }, title), selectButton), deviceList.map(this.renderDevice));
    };

    const verifiedDevicesSection = section( /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_DevicesPanel_header_icon mx_E2EIcon mx_E2EIcon_verified"
    }), (0, _languageHandler._t)("Verified devices"), verifiedDevices);
    const unverifiedDevicesSection = section( /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_DevicesPanel_header_icon mx_E2EIcon mx_E2EIcon_warning"
    }), (0, _languageHandler._t)("Unverified devices"), unverifiedDevices);
    const nonCryptoDevicesSection = section( /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null), (0, _languageHandler._t)("Devices without encryption support"), nonCryptoDevices);
    const deleteButton = this.state.deleting ? /*#__PURE__*/_react.default.createElement(_Spinner.default, {
      w: 22,
      h: 22
    }) : /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      className: "mx_DevicesPanel_deleteButton",
      onClick: this.onDeleteClick,
      kind: "danger_outline",
      disabled: this.state.selectedDevices.length === 0
    }, (0, _languageHandler._t)("Sign out %(count)s selected devices", {
      count: this.state.selectedDevices.length
    }));
    const otherDevicesSection = otherDevices.length > 0 ? /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, verifiedDevicesSection, unverifiedDevicesSection, nonCryptoDevicesSection, deleteButton) : /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement("hr", null), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_DevicesPanel_noOtherDevices"
    }, (0, _languageHandler._t)("You aren't signed into any other devices.")));
    const classes = (0, _classnames.default)(this.props.className, "mx_DevicesPanel");
    return /*#__PURE__*/_react.default.createElement("div", {
      className: classes
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_DevicesPanel_header"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_DevicesPanel_header_title"
    }, (0, _languageHandler._t)("This device"))), this.renderDevice(myDevice), otherDevicesSection);
  }

}) || _class);
exports.default = DevicesPanel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3NldHRpbmdzL0RldmljZXNQYW5lbC50c3giXSwibmFtZXMiOlsiRGV2aWNlc1BhbmVsIiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwiZGV2aWNlIiwidW5tb3VudGVkIiwiZGV2aWNlSWQiLCJkZXZpY2VfaWQiLCJzZXRTdGF0ZSIsInN0YXRlIiwic2VsZWN0ZWREZXZpY2VzIiwic2xpY2UiLCJpIiwiaW5kZXhPZiIsInB1c2giLCJzcGxpY2UiLCJkZXZpY2VzIiwiaW5jbHVkZXMiLCJsZW5ndGgiLCJkZWxldGluZyIsIm1ha2VEZWxldGVSZXF1ZXN0IiwiY2F0Y2giLCJlcnJvciIsImh0dHBTdGF0dXMiLCJkYXRhIiwiZmxvd3MiLCJudW1EZXZpY2VzIiwiZGlhbG9nQWVzdGhldGljcyIsIlNTT0F1dGhFbnRyeSIsIlBIQVNFX1BSRUFVVEgiLCJ0aXRsZSIsImJvZHkiLCJjb3VudCIsImNvbnRpbnVlVGV4dCIsImNvbnRpbnVlS2luZCIsIlBIQVNFX1BPU1RBVVRIIiwiTW9kYWwiLCJjcmVhdGVUcmFja2VkRGlhbG9nIiwiSW50ZXJhY3RpdmVBdXRoRGlhbG9nIiwibWF0cml4Q2xpZW50IiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0IiwiYXV0aERhdGEiLCJtYWtlUmVxdWVzdCIsImJpbmQiLCJhZXN0aGV0aWNzRm9yU3RhZ2VQaGFzZXMiLCJMT0dJTl9UWVBFIiwiVU5TVEFCTEVfTE9HSU5fVFlQRSIsImUiLCJsb2dnZXIiLCJmaW5hbGx5IiwibXlEZXZpY2VJZCIsImdldERldmljZUlkIiwibXlEZXZpY2UiLCJmaW5kIiwiaXNPd25EZXZpY2UiLCJjYW5CZVZlcmlmaWVkIiwiaXNEZXZpY2VWZXJpZmllZCIsImxvYWREZXZpY2VzIiwib25EZXZpY2VTZWxlY3Rpb25Ub2dnbGVkIiwiY29tcG9uZW50RGlkTW91bnQiLCJjb21wb25lbnRXaWxsVW5tb3VudCIsImNsaSIsImdldERldmljZXMiLCJ0aGVuIiwicmVzcCIsImNyb3NzU2lnbmluZ0luZm8iLCJnZXRTdG9yZWRDcm9zc1NpZ25pbmdGb3JVc2VyIiwiZ2V0VXNlcklkIiwiZGV2aWNlSWRzIiwibWFwIiwiZmlsdGVyIiwiY29uc29sZSIsImxvZyIsImVycnR4dCIsImRldmljZUxvYWRFcnJvciIsImRldmljZUNvbXBhcmUiLCJhIiwiYiIsImxhc3RTZWVuRGVsdGEiLCJsYXN0X3NlZW5fdHMiLCJpZEEiLCJpZEIiLCJkZXZpY2VJbmZvIiwiZ2V0U3RvcmVkRGV2aWNlIiwiY2hlY2tEZXZpY2VUcnVzdCIsImlzQ3Jvc3NTaWduaW5nVmVyaWZpZWQiLCJhdXRoIiwiZGVsZXRlTXVsdGlwbGVEZXZpY2VzIiwicmVuZGVyIiwibG9hZEVycm9yIiwiY2xhc3NOYW1lIiwidW5kZWZpbmVkIiwib3RoZXJEZXZpY2VzIiwic29ydCIsInZlcmlmaWVkRGV2aWNlcyIsInVudmVyaWZpZWREZXZpY2VzIiwibm9uQ3J5cHRvRGV2aWNlcyIsInZlcmlmaWVkIiwic2VjdGlvbiIsInRydXN0SWNvbiIsImRldmljZUxpc3QiLCJzZWxlY3RCdXR0b24iLCJhbnlTZWxlY3RlZCIsInNvbWUiLCJidXR0b25BY3Rpb24iLCJkZXNlbGVjdEFsbCIsInNlbGVjdEFsbCIsImJ1dHRvblRleHQiLCJyZW5kZXJEZXZpY2UiLCJ2ZXJpZmllZERldmljZXNTZWN0aW9uIiwidW52ZXJpZmllZERldmljZXNTZWN0aW9uIiwibm9uQ3J5cHRvRGV2aWNlc1NlY3Rpb24iLCJkZWxldGVCdXR0b24iLCJvbkRlbGV0ZUNsaWNrIiwib3RoZXJEZXZpY2VzU2VjdGlvbiIsImNsYXNzZXMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUNBOztBQUdBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBOzs7O0lBZXFCQSxZLFdBRHBCLGdEQUFxQiw2QkFBckIsQyxnQkFBRCxNQUNxQkEsWUFEckIsU0FDMENDLGVBQU1DLFNBRGhELENBQzBFO0FBR3RFQyxFQUFBQSxXQUFXLENBQUNDLEtBQUQsRUFBZ0I7QUFDdkIsVUFBTUEsS0FBTjtBQUR1QixxREFGUCxLQUVPO0FBQUEsb0VBb0ZTQyxNQUFELElBQTZCO0FBQzVELFVBQUksS0FBS0MsU0FBVCxFQUFvQjtBQUFFO0FBQVM7O0FBRS9CLFlBQU1DLFFBQVEsR0FBR0YsTUFBTSxDQUFDRyxTQUF4QjtBQUNBLFdBQUtDLFFBQUwsQ0FBYyxDQUFDQyxLQUFELEVBQVFOLEtBQVIsS0FBa0I7QUFDNUI7QUFDQSxjQUFNTyxlQUFlLEdBQUdELEtBQUssQ0FBQ0MsZUFBTixDQUFzQkMsS0FBdEIsRUFBeEI7QUFFQSxjQUFNQyxDQUFDLEdBQUdGLGVBQWUsQ0FBQ0csT0FBaEIsQ0FBd0JQLFFBQXhCLENBQVY7O0FBQ0EsWUFBSU0sQ0FBQyxLQUFLLENBQUMsQ0FBWCxFQUFjO0FBQ1ZGLFVBQUFBLGVBQWUsQ0FBQ0ksSUFBaEIsQ0FBcUJSLFFBQXJCO0FBQ0gsU0FGRCxNQUVPO0FBQ0hJLFVBQUFBLGVBQWUsQ0FBQ0ssTUFBaEIsQ0FBdUJILENBQXZCLEVBQTBCLENBQTFCO0FBQ0g7O0FBRUQsZUFBTztBQUFFRixVQUFBQTtBQUFGLFNBQVA7QUFDSCxPQVpEO0FBYUgsS0FyRzBCO0FBQUEscURBdUdOTSxPQUFELElBQWdDO0FBQ2hELFdBQUtSLFFBQUwsQ0FBYyxDQUFDQyxLQUFELEVBQVFOLEtBQVIsS0FBa0I7QUFDNUIsY0FBTU8sZUFBZSxHQUFHRCxLQUFLLENBQUNDLGVBQU4sQ0FBc0JDLEtBQXRCLEVBQXhCOztBQUVBLGFBQUssTUFBTVAsTUFBWCxJQUFxQlksT0FBckIsRUFBOEI7QUFDMUIsZ0JBQU1WLFFBQVEsR0FBR0YsTUFBTSxDQUFDRyxTQUF4Qjs7QUFDQSxjQUFJLENBQUNHLGVBQWUsQ0FBQ08sUUFBaEIsQ0FBeUJYLFFBQXpCLENBQUwsRUFBeUM7QUFDckNJLFlBQUFBLGVBQWUsQ0FBQ0ksSUFBaEIsQ0FBcUJSLFFBQXJCO0FBQ0g7QUFDSjs7QUFFRCxlQUFPO0FBQUVJLFVBQUFBO0FBQUYsU0FBUDtBQUNILE9BWEQ7QUFZSCxLQXBIMEI7QUFBQSx1REFzSEpNLE9BQUQsSUFBZ0M7QUFDbEQsV0FBS1IsUUFBTCxDQUFjLENBQUNDLEtBQUQsRUFBUU4sS0FBUixLQUFrQjtBQUM1QixjQUFNTyxlQUFlLEdBQUdELEtBQUssQ0FBQ0MsZUFBTixDQUFzQkMsS0FBdEIsRUFBeEI7O0FBRUEsYUFBSyxNQUFNUCxNQUFYLElBQXFCWSxPQUFyQixFQUE4QjtBQUMxQixnQkFBTVYsUUFBUSxHQUFHRixNQUFNLENBQUNHLFNBQXhCO0FBQ0EsZ0JBQU1LLENBQUMsR0FBR0YsZUFBZSxDQUFDRyxPQUFoQixDQUF3QlAsUUFBeEIsQ0FBVjs7QUFDQSxjQUFJTSxDQUFDLEtBQUssQ0FBQyxDQUFYLEVBQWM7QUFDVkYsWUFBQUEsZUFBZSxDQUFDSyxNQUFoQixDQUF1QkgsQ0FBdkIsRUFBMEIsQ0FBMUI7QUFDSDtBQUNKOztBQUVELGVBQU87QUFBRUYsVUFBQUE7QUFBRixTQUFQO0FBQ0gsT0FaRDtBQWFILEtBcEkwQjtBQUFBLHlEQXNJSCxNQUFZO0FBQ2hDLFVBQUksS0FBS0QsS0FBTCxDQUFXQyxlQUFYLENBQTJCUSxNQUEzQixLQUFzQyxDQUExQyxFQUE2QztBQUFFO0FBQVM7O0FBRXhELFdBQUtWLFFBQUwsQ0FBYztBQUNWVyxRQUFBQSxRQUFRLEVBQUU7QUFEQSxPQUFkO0FBSUEsV0FBS0MsaUJBQUwsQ0FBdUIsSUFBdkIsRUFBNkJDLEtBQTdCLENBQW9DQyxLQUFELElBQVc7QUFDMUMsWUFBSSxLQUFLakIsU0FBVCxFQUFvQjtBQUFFO0FBQVM7O0FBQy9CLFlBQUlpQixLQUFLLENBQUNDLFVBQU4sS0FBcUIsR0FBckIsSUFBNEIsQ0FBQ0QsS0FBSyxDQUFDRSxJQUFuQyxJQUEyQyxDQUFDRixLQUFLLENBQUNFLElBQU4sQ0FBV0MsS0FBM0QsRUFBa0U7QUFDOUQ7QUFDQSxnQkFBTUgsS0FBTjtBQUNILFNBTHlDLENBTzFDOzs7QUFFQSxjQUFNSSxVQUFVLEdBQUcsS0FBS2pCLEtBQUwsQ0FBV0MsZUFBWCxDQUEyQlEsTUFBOUM7QUFDQSxjQUFNUyxnQkFBZ0IsR0FBRztBQUNyQixXQUFDQyw2Q0FBYUMsYUFBZCxHQUE4QjtBQUMxQkMsWUFBQUEsS0FBSyxFQUFFLHlCQUFHLGdDQUFILENBRG1CO0FBRTFCQyxZQUFBQSxJQUFJLEVBQUUseUJBQUcsbUZBQUgsRUFBd0Y7QUFDMUZDLGNBQUFBLEtBQUssRUFBRU47QUFEbUYsYUFBeEYsQ0FGb0I7QUFLMUJPLFlBQUFBLFlBQVksRUFBRSx5QkFBRyxnQkFBSCxDQUxZO0FBTTFCQyxZQUFBQSxZQUFZLEVBQUU7QUFOWSxXQURUO0FBU3JCLFdBQUNOLDZDQUFhTyxjQUFkLEdBQStCO0FBQzNCTCxZQUFBQSxLQUFLLEVBQUUseUJBQUcsbUNBQUgsQ0FEb0I7QUFFM0JDLFlBQUFBLElBQUksRUFBRSx5QkFBRyw4REFBSCxFQUFtRTtBQUNyRUMsY0FBQUEsS0FBSyxFQUFFTjtBQUQ4RCxhQUFuRSxDQUZxQjtBQUszQk8sWUFBQUEsWUFBWSxFQUFFLHlCQUFHLGtCQUFILEVBQXVCO0FBQUVELGNBQUFBLEtBQUssRUFBRU47QUFBVCxhQUF2QixDQUxhO0FBTTNCUSxZQUFBQSxZQUFZLEVBQUU7QUFOYTtBQVRWLFNBQXpCOztBQWtCQUUsdUJBQU1DLG1CQUFOLENBQTBCLHNCQUExQixFQUFrRCxFQUFsRCxFQUFzREMsOEJBQXRELEVBQTZFO0FBQ3pFUixVQUFBQSxLQUFLLEVBQUUseUJBQUcsZ0JBQUgsQ0FEa0U7QUFFekVTLFVBQUFBLFlBQVksRUFBRUMsaUNBQWdCQyxHQUFoQixFQUYyRDtBQUd6RUMsVUFBQUEsUUFBUSxFQUFFcEIsS0FBSyxDQUFDRSxJQUh5RDtBQUl6RW1CLFVBQUFBLFdBQVcsRUFBRSxLQUFLdkIsaUJBQUwsQ0FBdUJ3QixJQUF2QixDQUE0QixJQUE1QixDQUo0RDtBQUt6RUMsVUFBQUEsd0JBQXdCLEVBQUU7QUFDdEIsYUFBQ2pCLDZDQUFha0IsVUFBZCxHQUEyQm5CLGdCQURMO0FBRXRCLGFBQUNDLDZDQUFhbUIsbUJBQWQsR0FBb0NwQjtBQUZkO0FBTCtDLFNBQTdFO0FBVUgsT0F0Q0QsRUFzQ0dOLEtBdENILENBc0NVMkIsQ0FBRCxJQUFPO0FBQ1pDLHVCQUFPM0IsS0FBUCxDQUFhLHlCQUFiLEVBQXdDMEIsQ0FBeEM7O0FBQ0EsWUFBSSxLQUFLM0MsU0FBVCxFQUFvQjtBQUFFO0FBQVM7QUFDbEMsT0F6Q0QsRUF5Q0c2QyxPQXpDSCxDQXlDVyxNQUFNO0FBQ2IsYUFBSzFDLFFBQUwsQ0FBYztBQUNWVyxVQUFBQSxRQUFRLEVBQUU7QUFEQSxTQUFkO0FBR0gsT0E3Q0Q7QUE4Q0gsS0EzTDBCO0FBQUEsd0RBME1IZixNQUFELElBQW9DO0FBQ3ZELFlBQU0rQyxVQUFVLEdBQUdYLGlDQUFnQkMsR0FBaEIsR0FBc0JXLFdBQXRCLEVBQW5COztBQUNBLFlBQU1DLFFBQVEsR0FBRyxLQUFLNUMsS0FBTCxDQUFXTyxPQUFYLENBQW1Cc0MsSUFBbkIsQ0FBeUJsRCxNQUFELElBQWFBLE1BQU0sQ0FBQ0csU0FBUCxLQUFxQjRDLFVBQTFELENBQWpCO0FBRUEsWUFBTUksV0FBVyxHQUFHbkQsTUFBTSxDQUFDRyxTQUFQLEtBQXFCNEMsVUFBekMsQ0FKdUQsQ0FNdkQ7QUFDQTs7QUFDQSxZQUFNSyxhQUFhLEdBQUlILFFBQVEsSUFBSSxLQUFLSSxnQkFBTCxDQUFzQkosUUFBdEIsQ0FBYixJQUFpREUsV0FBdkU7QUFFQSwwQkFBTyw2QkFBQywwQkFBRDtBQUNILFFBQUEsR0FBRyxFQUFFbkQsTUFBTSxDQUFDRyxTQURUO0FBRUgsUUFBQSxNQUFNLEVBQUVILE1BRkw7QUFHSCxRQUFBLFFBQVEsRUFBRSxLQUFLSyxLQUFMLENBQVdDLGVBQVgsQ0FBMkJPLFFBQTNCLENBQW9DYixNQUFNLENBQUNHLFNBQTNDLENBSFA7QUFJSCxRQUFBLFdBQVcsRUFBRWdELFdBSlY7QUFLSCxRQUFBLFFBQVEsRUFBRSxLQUFLRSxnQkFBTCxDQUFzQnJELE1BQXRCLENBTFA7QUFNSCxRQUFBLGFBQWEsRUFBRW9ELGFBTlo7QUFPSCxRQUFBLGNBQWMsRUFBRSxLQUFLRSxXQVBsQjtBQVFILFFBQUEsZUFBZSxFQUFFLEtBQUtDO0FBUm5CLFFBQVA7QUFVSCxLQTlOMEI7QUFFdkIsU0FBS2xELEtBQUwsR0FBYTtBQUNUTyxNQUFBQSxPQUFPLEVBQUUsRUFEQTtBQUVUTixNQUFBQSxlQUFlLEVBQUU7QUFGUixLQUFiO0FBSUEsU0FBS2dELFdBQUwsR0FBbUIsS0FBS0EsV0FBTCxDQUFpQmQsSUFBakIsQ0FBc0IsSUFBdEIsQ0FBbkI7QUFDSDs7QUFFTWdCLEVBQUFBLGlCQUFpQixHQUFTO0FBQzdCLFNBQUtGLFdBQUw7QUFDSDs7QUFFTUcsRUFBQUEsb0JBQW9CLEdBQVM7QUFDaEMsU0FBS3hELFNBQUwsR0FBaUIsSUFBakI7QUFDSDs7QUFFT3FELEVBQUFBLFdBQVcsR0FBUztBQUN4QixVQUFNSSxHQUFHLEdBQUd0QixpQ0FBZ0JDLEdBQWhCLEVBQVo7O0FBQ0FxQixJQUFBQSxHQUFHLENBQUNDLFVBQUosR0FBaUJDLElBQWpCLENBQ0tDLElBQUQsSUFBVTtBQUNOLFVBQUksS0FBSzVELFNBQVQsRUFBb0I7QUFBRTtBQUFTOztBQUUvQixZQUFNNkQsZ0JBQWdCLEdBQUdKLEdBQUcsQ0FBQ0ssNEJBQUosQ0FBaUNMLEdBQUcsQ0FBQ00sU0FBSixFQUFqQyxDQUF6QjtBQUNBLFdBQUs1RCxRQUFMLENBQWMsQ0FBQ0MsS0FBRCxFQUFRTixLQUFSLEtBQWtCO0FBQzVCLGNBQU1rRSxTQUFTLEdBQUdKLElBQUksQ0FBQ2pELE9BQUwsQ0FBYXNELEdBQWIsQ0FBa0JsRSxNQUFELElBQVlBLE1BQU0sQ0FBQ0csU0FBcEMsQ0FBbEI7QUFDQSxjQUFNRyxlQUFlLEdBQUdELEtBQUssQ0FBQ0MsZUFBTixDQUFzQjZELE1BQXRCLENBQ25CakUsUUFBRCxJQUFjK0QsU0FBUyxDQUFDcEQsUUFBVixDQUFtQlgsUUFBbkIsQ0FETSxDQUF4QjtBQUdBLGVBQU87QUFDSFUsVUFBQUEsT0FBTyxFQUFFaUQsSUFBSSxDQUFDakQsT0FBTCxJQUFnQixFQUR0QjtBQUVITixVQUFBQSxlQUZHO0FBR0h3RCxVQUFBQSxnQkFBZ0IsRUFBRUE7QUFIZixTQUFQO0FBS0gsT0FWRDtBQVdBTSxNQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSxLQUFLaEUsS0FBakI7QUFDSCxLQWpCTCxFQWtCS2EsS0FBRCxJQUFXO0FBQ1AsVUFBSSxLQUFLakIsU0FBVCxFQUFvQjtBQUFFO0FBQVM7O0FBQy9CLFVBQUlxRSxNQUFKOztBQUNBLFVBQUlwRCxLQUFLLENBQUNDLFVBQU4sSUFBb0IsR0FBeEIsRUFBNkI7QUFDekI7QUFDQW1ELFFBQUFBLE1BQU0sR0FBRyx5QkFBRyxxREFBSCxDQUFUO0FBQ0gsT0FIRCxNQUdPO0FBQ0h6Qix1QkFBTzNCLEtBQVAsQ0FBYSx5QkFBYixFQUF3Q0EsS0FBeEM7O0FBQ0FvRCxRQUFBQSxNQUFNLEdBQUcseUJBQUcsNEJBQUgsQ0FBVDtBQUNIOztBQUNELFdBQUtsRSxRQUFMLENBQWM7QUFBRW1FLFFBQUFBLGVBQWUsRUFBRUQ7QUFBbkIsT0FBZDtBQUNILEtBN0JMO0FBK0JIO0FBRUQ7QUFDSjtBQUNBO0FBQ0E7OztBQUNZRSxFQUFBQSxhQUFhLENBQUNDLENBQUQsRUFBZUMsQ0FBZixFQUFxQztBQUN0RDtBQUNBLFVBQU1DLGFBQWEsR0FDYixDQUFDRCxDQUFDLENBQUNFLFlBQUYsSUFBa0IsQ0FBbkIsS0FBeUJILENBQUMsQ0FBQ0csWUFBRixJQUFrQixDQUEzQyxDQUROOztBQUdBLFFBQUlELGFBQWEsS0FBSyxDQUF0QixFQUF5QjtBQUFFLGFBQU9BLGFBQVA7QUFBdUI7O0FBRWxELFVBQU1FLEdBQUcsR0FBR0osQ0FBQyxDQUFDdEUsU0FBZDtBQUNBLFVBQU0yRSxHQUFHLEdBQUdKLENBQUMsQ0FBQ3ZFLFNBQWQ7QUFDQSxXQUFRMEUsR0FBRyxHQUFHQyxHQUFQLEdBQWMsQ0FBQyxDQUFmLEdBQW9CRCxHQUFHLEdBQUdDLEdBQVAsR0FBYyxDQUFkLEdBQWtCLENBQTVDO0FBQ0g7O0FBRU96QixFQUFBQSxnQkFBZ0IsQ0FBQ3JELE1BQUQsRUFBb0M7QUFDeEQsUUFBSTtBQUNBLFlBQU0wRCxHQUFHLEdBQUd0QixpQ0FBZ0JDLEdBQWhCLEVBQVo7O0FBQ0EsWUFBTTBDLFVBQVUsR0FBR3JCLEdBQUcsQ0FBQ3NCLGVBQUosQ0FBb0J0QixHQUFHLENBQUNNLFNBQUosRUFBcEIsRUFBcUNoRSxNQUFNLENBQUNHLFNBQTVDLENBQW5CO0FBQ0EsYUFBTyxLQUFLRSxLQUFMLENBQVd5RCxnQkFBWCxDQUE0Qm1CLGdCQUE1QixDQUNILEtBQUs1RSxLQUFMLENBQVd5RCxnQkFEUixFQUVIaUIsVUFGRyxFQUdILEtBSEcsRUFJSCxJQUpHLEVBS0xHLHNCQUxLLEVBQVA7QUFNSCxLQVRELENBU0UsT0FBT3RDLENBQVAsRUFBVTtBQUNSd0IsTUFBQUEsT0FBTyxDQUFDbEQsS0FBUixDQUFjLHlDQUFkLEVBQXlEMEIsQ0FBekQ7QUFDQSxhQUFPLElBQVA7QUFDSDtBQUNKOztBQTJHRDtBQUNRNUIsRUFBQUEsaUJBQWlCLENBQUNtRSxJQUFELEVBQTJCO0FBQ2hELFdBQU8vQyxpQ0FBZ0JDLEdBQWhCLEdBQXNCK0MscUJBQXRCLENBQTRDLEtBQUsvRSxLQUFMLENBQVdDLGVBQXZELEVBQXdFNkUsSUFBeEUsRUFBOEV2QixJQUE5RSxDQUNILE1BQU07QUFDRjtBQUNBLFdBQUt4RCxRQUFMLENBQWM7QUFDVkUsUUFBQUEsZUFBZSxFQUFFO0FBRFAsT0FBZDtBQUdBLFdBQUtnRCxXQUFMO0FBQ0gsS0FQRSxDQUFQO0FBU0g7O0FBd0JNK0IsRUFBQUEsTUFBTSxHQUFnQjtBQUN6QixVQUFNQyxTQUFTLGdCQUNYO0FBQUssTUFBQSxTQUFTLEVBQUUseUJBQVcsS0FBS3ZGLEtBQUwsQ0FBV3dGLFNBQXRCLEVBQWlDLE9BQWpDO0FBQWhCLE9BQ00sS0FBS2xGLEtBQUwsQ0FBV2tFLGVBRGpCLENBREo7O0FBTUEsUUFBSSxLQUFLbEUsS0FBTCxDQUFXa0UsZUFBWCxLQUErQmlCLFNBQW5DLEVBQThDO0FBQzFDLGFBQU9GLFNBQVA7QUFDSDs7QUFFRCxVQUFNMUUsT0FBTyxHQUFHLEtBQUtQLEtBQUwsQ0FBV08sT0FBM0I7O0FBQ0EsUUFBSUEsT0FBTyxLQUFLNEUsU0FBaEIsRUFBMkI7QUFDdkI7QUFDQSwwQkFBTyw2QkFBQyxnQkFBRCxPQUFQO0FBQ0g7O0FBRUQsVUFBTXpDLFVBQVUsR0FBR1gsaUNBQWdCQyxHQUFoQixHQUFzQlcsV0FBdEIsRUFBbkI7O0FBQ0EsVUFBTUMsUUFBUSxHQUFHckMsT0FBTyxDQUFDc0MsSUFBUixDQUFjbEQsTUFBRCxJQUFhQSxNQUFNLENBQUNHLFNBQVAsS0FBcUI0QyxVQUEvQyxDQUFqQjs7QUFDQSxRQUFJLENBQUNFLFFBQUwsRUFBZTtBQUNYLGFBQU9xQyxTQUFQO0FBQ0g7O0FBRUQsVUFBTUcsWUFBWSxHQUFHN0UsT0FBTyxDQUFDdUQsTUFBUixDQUFnQm5FLE1BQUQsSUFBYUEsTUFBTSxDQUFDRyxTQUFQLEtBQXFCNEMsVUFBakQsQ0FBckI7QUFDQTBDLElBQUFBLFlBQVksQ0FBQ0MsSUFBYixDQUFrQixLQUFLbEIsYUFBdkI7QUFFQSxVQUFNbUIsZUFBZSxHQUFHLEVBQXhCO0FBQ0EsVUFBTUMsaUJBQWlCLEdBQUcsRUFBMUI7QUFDQSxVQUFNQyxnQkFBZ0IsR0FBRyxFQUF6Qjs7QUFDQSxTQUFLLE1BQU03RixNQUFYLElBQXFCeUYsWUFBckIsRUFBbUM7QUFDL0IsWUFBTUssUUFBUSxHQUFHLEtBQUt6QyxnQkFBTCxDQUFzQnJELE1BQXRCLENBQWpCOztBQUNBLFVBQUk4RixRQUFRLEtBQUssSUFBakIsRUFBdUI7QUFDbkJILFFBQUFBLGVBQWUsQ0FBQ2pGLElBQWhCLENBQXFCVixNQUFyQjtBQUNILE9BRkQsTUFFTyxJQUFJOEYsUUFBUSxLQUFLLEtBQWpCLEVBQXdCO0FBQzNCRixRQUFBQSxpQkFBaUIsQ0FBQ2xGLElBQWxCLENBQXVCVixNQUF2QjtBQUNILE9BRk0sTUFFQTtBQUNINkYsUUFBQUEsZ0JBQWdCLENBQUNuRixJQUFqQixDQUFzQlYsTUFBdEI7QUFDSDtBQUNKOztBQUVELFVBQU0rRixPQUFPLEdBQUcsQ0FBQ0MsU0FBRCxFQUF5QnRFLEtBQXpCLEVBQXdDdUUsVUFBeEMsS0FBaUY7QUFDN0YsVUFBSUEsVUFBVSxDQUFDbkYsTUFBWCxLQUFzQixDQUExQixFQUE2QjtBQUN6Qiw0QkFBTyw2QkFBQyxjQUFELENBQU8sUUFBUCxPQUFQO0FBQ0g7O0FBRUQsVUFBSW9GLFlBQUo7O0FBQ0EsVUFBSUQsVUFBVSxDQUFDbkYsTUFBWCxHQUFvQixDQUF4QixFQUEyQjtBQUN2QixjQUFNcUYsV0FBVyxHQUFHRixVQUFVLENBQUNHLElBQVgsQ0FBaUJwRyxNQUFELElBQVksS0FBS0ssS0FBTCxDQUFXQyxlQUFYLENBQTJCTyxRQUEzQixDQUFvQ2IsTUFBTSxDQUFDRyxTQUEzQyxDQUE1QixDQUFwQjtBQUNBLGNBQU1rRyxZQUFZLEdBQUdGLFdBQVcsR0FDNUIsTUFBTTtBQUFFLGVBQUtHLFdBQUwsQ0FBaUJMLFVBQWpCO0FBQStCLFNBRFgsR0FFNUIsTUFBTTtBQUFFLGVBQUtNLFNBQUwsQ0FBZU4sVUFBZjtBQUE2QixTQUZ6QztBQUdBLGNBQU1PLFVBQVUsR0FBR0wsV0FBVyxHQUFHLHlCQUFHLGNBQUgsQ0FBSCxHQUF3Qix5QkFBRyxZQUFILENBQXREO0FBQ0FELFFBQUFBLFlBQVksZ0JBQUc7QUFBSyxVQUFBLFNBQVMsRUFBQztBQUFmLHdCQUNYLDZCQUFDLHlCQUFEO0FBQ0ksVUFBQSxTQUFTLEVBQUMsOEJBRGQ7QUFFSSxVQUFBLElBQUksRUFBQyxXQUZUO0FBR0ksVUFBQSxPQUFPLEVBQUVHO0FBSGIsV0FLTUcsVUFMTixDQURXLENBQWY7QUFTSDs7QUFFRCwwQkFBTyw2QkFBQyxjQUFELENBQU8sUUFBUCxxQkFDSCx3Q0FERyxlQUVIO0FBQUssUUFBQSxTQUFTLEVBQUM7QUFBZixzQkFDSTtBQUFLLFFBQUEsU0FBUyxFQUFDO0FBQWYsU0FDTVIsU0FETixDQURKLGVBSUk7QUFBSyxRQUFBLFNBQVMsRUFBQztBQUFmLFNBQ010RSxLQUROLENBSkosRUFPTXdFLFlBUE4sQ0FGRyxFQVdERCxVQUFVLENBQUMvQixHQUFYLENBQWUsS0FBS3VDLFlBQXBCLENBWEMsQ0FBUDtBQWFILEtBcENEOztBQXNDQSxVQUFNQyxzQkFBc0IsR0FBR1gsT0FBTyxlQUNsQztBQUFNLE1BQUEsU0FBUyxFQUFDO0FBQWhCLE1BRGtDLEVBRWxDLHlCQUFHLGtCQUFILENBRmtDLEVBR2xDSixlQUhrQyxDQUF0QztBQU1BLFVBQU1nQix3QkFBd0IsR0FBR1osT0FBTyxlQUNwQztBQUFNLE1BQUEsU0FBUyxFQUFDO0FBQWhCLE1BRG9DLEVBRXBDLHlCQUFHLG9CQUFILENBRm9DLEVBR3BDSCxpQkFIb0MsQ0FBeEM7QUFNQSxVQUFNZ0IsdUJBQXVCLEdBQUdiLE9BQU8sZUFDbkMsNkJBQUMsY0FBRCxDQUFPLFFBQVAsT0FEbUMsRUFFbkMseUJBQUcsb0NBQUgsQ0FGbUMsRUFHbkNGLGdCQUhtQyxDQUF2QztBQU1BLFVBQU1nQixZQUFZLEdBQUcsS0FBS3hHLEtBQUwsQ0FBV1UsUUFBWCxnQkFDakIsNkJBQUMsZ0JBQUQ7QUFBUyxNQUFBLENBQUMsRUFBRSxFQUFaO0FBQWdCLE1BQUEsQ0FBQyxFQUFFO0FBQW5CLE1BRGlCLGdCQUVqQiw2QkFBQyx5QkFBRDtBQUNJLE1BQUEsU0FBUyxFQUFDLDhCQURkO0FBRUksTUFBQSxPQUFPLEVBQUUsS0FBSytGLGFBRmxCO0FBR0ksTUFBQSxJQUFJLEVBQUMsZ0JBSFQ7QUFJSSxNQUFBLFFBQVEsRUFBRSxLQUFLekcsS0FBTCxDQUFXQyxlQUFYLENBQTJCUSxNQUEzQixLQUFzQztBQUpwRCxPQU1NLHlCQUFHLHFDQUFILEVBQTBDO0FBQUVjLE1BQUFBLEtBQUssRUFBRSxLQUFLdkIsS0FBTCxDQUFXQyxlQUFYLENBQTJCUTtBQUFwQyxLQUExQyxDQU5OLENBRko7QUFXQSxVQUFNaUcsbUJBQW1CLEdBQUl0QixZQUFZLENBQUMzRSxNQUFiLEdBQXNCLENBQXZCLGdCQUN4Qiw2QkFBQyxjQUFELENBQU8sUUFBUCxRQUNNNEYsc0JBRE4sRUFFTUMsd0JBRk4sRUFHTUMsdUJBSE4sRUFJTUMsWUFKTixDQUR3QixnQkFPeEIsNkJBQUMsY0FBRCxDQUFPLFFBQVAscUJBQ0ksd0NBREosZUFFSTtBQUFLLE1BQUEsU0FBUyxFQUFDO0FBQWYsT0FDTSx5QkFBRywyQ0FBSCxDQUROLENBRkosQ0FQSjtBQWNBLFVBQU1HLE9BQU8sR0FBRyx5QkFBVyxLQUFLakgsS0FBTCxDQUFXd0YsU0FBdEIsRUFBaUMsaUJBQWpDLENBQWhCO0FBQ0Esd0JBQ0k7QUFBSyxNQUFBLFNBQVMsRUFBRXlCO0FBQWhCLG9CQUNJO0FBQUssTUFBQSxTQUFTLEVBQUM7QUFBZixvQkFDSTtBQUFLLE1BQUEsU0FBUyxFQUFDO0FBQWYsT0FDTSx5QkFBRyxhQUFILENBRE4sQ0FESixDQURKLEVBTU0sS0FBS1AsWUFBTCxDQUFrQnhELFFBQWxCLENBTk4sRUFPTThELG1CQVBOLENBREo7QUFXSDs7QUF4V3FFLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTYgLSAyMDIxIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCBjbGFzc05hbWVzIGZyb20gJ2NsYXNzbmFtZXMnO1xuaW1wb3J0IHsgSU15RGV2aWNlIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2NsaWVudFwiO1xuXG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tICcuLi8uLi8uLi9NYXRyaXhDbGllbnRQZWcnO1xuaW1wb3J0IHsgX3QgfSBmcm9tICcuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXInO1xuaW1wb3J0IE1vZGFsIGZyb20gJy4uLy4uLy4uL01vZGFsJztcbmltcG9ydCB7IFNTT0F1dGhFbnRyeSB9IGZyb20gXCIuLi9hdXRoL0ludGVyYWN0aXZlQXV0aEVudHJ5Q29tcG9uZW50c1wiO1xuaW1wb3J0IHsgcmVwbGFjZWFibGVDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvcmVwbGFjZWFibGVDb21wb25lbnRcIjtcbmltcG9ydCBJbnRlcmFjdGl2ZUF1dGhEaWFsb2cgZnJvbSBcIi4uL2RpYWxvZ3MvSW50ZXJhY3RpdmVBdXRoRGlhbG9nXCI7XG5pbXBvcnQgRGV2aWNlc1BhbmVsRW50cnkgZnJvbSBcIi4vRGV2aWNlc1BhbmVsRW50cnlcIjtcbmltcG9ydCBTcGlubmVyIGZyb20gXCIuLi9lbGVtZW50cy9TcGlubmVyXCI7XG5pbXBvcnQgQWNjZXNzaWJsZUJ1dHRvbiBmcm9tIFwiLi4vZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvblwiO1xuaW1wb3J0IHsgQ3Jvc3NTaWduaW5nSW5mbyB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9jcnlwdG8vQ3Jvc3NTaWduaW5nXCI7XG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcblxuaW50ZXJmYWNlIElQcm9wcyB7XG4gICAgY2xhc3NOYW1lPzogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBkZXZpY2VzOiBJTXlEZXZpY2VbXTtcbiAgICBjcm9zc1NpZ25pbmdJbmZvPzogQ3Jvc3NTaWduaW5nSW5mbztcbiAgICBkZXZpY2VMb2FkRXJyb3I/OiBzdHJpbmc7XG4gICAgc2VsZWN0ZWREZXZpY2VzOiBzdHJpbmdbXTtcbiAgICBkZWxldGluZz86IGJvb2xlYW47XG59XG5cbkByZXBsYWNlYWJsZUNvbXBvbmVudChcInZpZXdzLnNldHRpbmdzLkRldmljZXNQYW5lbFwiKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRGV2aWNlc1BhbmVsIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PElQcm9wcywgSVN0YXRlPiB7XG4gICAgcHJpdmF0ZSB1bm1vdW50ZWQgPSBmYWxzZTtcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBJUHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgZGV2aWNlczogW10sXG4gICAgICAgICAgICBzZWxlY3RlZERldmljZXM6IFtdLFxuICAgICAgICB9O1xuICAgICAgICB0aGlzLmxvYWREZXZpY2VzID0gdGhpcy5sb2FkRGV2aWNlcy5iaW5kKHRoaXMpO1xuICAgIH1cblxuICAgIHB1YmxpYyBjb21wb25lbnREaWRNb3VudCgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5sb2FkRGV2aWNlcygpO1xuICAgIH1cblxuICAgIHB1YmxpYyBjb21wb25lbnRXaWxsVW5tb3VudCgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy51bm1vdW50ZWQgPSB0cnVlO1xuICAgIH1cblxuICAgIHByaXZhdGUgbG9hZERldmljZXMoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICAgICAgY2xpLmdldERldmljZXMoKS50aGVuKFxuICAgICAgICAgICAgKHJlc3ApID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy51bm1vdW50ZWQpIHsgcmV0dXJuOyB9XG5cbiAgICAgICAgICAgICAgICBjb25zdCBjcm9zc1NpZ25pbmdJbmZvID0gY2xpLmdldFN0b3JlZENyb3NzU2lnbmluZ0ZvclVzZXIoY2xpLmdldFVzZXJJZCgpKTtcbiAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKChzdGF0ZSwgcHJvcHMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGV2aWNlSWRzID0gcmVzcC5kZXZpY2VzLm1hcCgoZGV2aWNlKSA9PiBkZXZpY2UuZGV2aWNlX2lkKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWREZXZpY2VzID0gc3RhdGUuc2VsZWN0ZWREZXZpY2VzLmZpbHRlcihcbiAgICAgICAgICAgICAgICAgICAgICAgIChkZXZpY2VJZCkgPT4gZGV2aWNlSWRzLmluY2x1ZGVzKGRldmljZUlkKSxcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRldmljZXM6IHJlc3AuZGV2aWNlcyB8fCBbXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkRGV2aWNlcyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNyb3NzU2lnbmluZ0luZm86IGNyb3NzU2lnbmluZ0luZm8sXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2codGhpcy5zdGF0ZSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMudW5tb3VudGVkKSB7IHJldHVybjsgfVxuICAgICAgICAgICAgICAgIGxldCBlcnJ0eHQ7XG4gICAgICAgICAgICAgICAgaWYgKGVycm9yLmh0dHBTdGF0dXMgPT0gNDA0KSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIDQwNCBwcm9iYWJseSBtZWFucyB0aGUgSFMgZG9lc24ndCB5ZXQgc3VwcG9ydCB0aGUgQVBJLlxuICAgICAgICAgICAgICAgICAgICBlcnJ0eHQgPSBfdChcIllvdXIgaG9tZXNlcnZlciBkb2VzIG5vdCBzdXBwb3J0IGRldmljZSBtYW5hZ2VtZW50LlwiKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoXCJFcnJvciBsb2FkaW5nIHNlc3Npb25zOlwiLCBlcnJvcik7XG4gICAgICAgICAgICAgICAgICAgIGVycnR4dCA9IF90KFwiVW5hYmxlIHRvIGxvYWQgZGV2aWNlIGxpc3RcIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBkZXZpY2VMb2FkRXJyb3I6IGVycnR4dCB9KTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLypcbiAgICAgKiBjb21wYXJlIHR3byBkZXZpY2VzLCBzb3J0aW5nIGZyb20gbW9zdC1yZWNlbnRseS1zZWVuIHRvIGxlYXN0LXJlY2VudGx5LXNlZW5cbiAgICAgKiAoYW5kIHRoZW4sIGZvciBzdGFiaWxpdHksIGJ5IGRldmljZSBpZClcbiAgICAgKi9cbiAgICBwcml2YXRlIGRldmljZUNvbXBhcmUoYTogSU15RGV2aWNlLCBiOiBJTXlEZXZpY2UpOiBudW1iZXIge1xuICAgICAgICAvLyByZXR1cm4gPCAwIGlmIGEgY29tZXMgYmVmb3JlIGIsID4gMCBpZiBhIGNvbWVzIGFmdGVyIGIuXG4gICAgICAgIGNvbnN0IGxhc3RTZWVuRGVsdGEgPVxuICAgICAgICAgICAgICAoYi5sYXN0X3NlZW5fdHMgfHwgMCkgLSAoYS5sYXN0X3NlZW5fdHMgfHwgMCk7XG5cbiAgICAgICAgaWYgKGxhc3RTZWVuRGVsdGEgIT09IDApIHsgcmV0dXJuIGxhc3RTZWVuRGVsdGE7IH1cblxuICAgICAgICBjb25zdCBpZEEgPSBhLmRldmljZV9pZDtcbiAgICAgICAgY29uc3QgaWRCID0gYi5kZXZpY2VfaWQ7XG4gICAgICAgIHJldHVybiAoaWRBIDwgaWRCKSA/IC0xIDogKGlkQSA+IGlkQikgPyAxIDogMDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzRGV2aWNlVmVyaWZpZWQoZGV2aWNlOiBJTXlEZXZpY2UpOiBib29sZWFuIHwgbnVsbCB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBjbGkgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgICAgICBjb25zdCBkZXZpY2VJbmZvID0gY2xpLmdldFN0b3JlZERldmljZShjbGkuZ2V0VXNlcklkKCksIGRldmljZS5kZXZpY2VfaWQpO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGUuY3Jvc3NTaWduaW5nSW5mby5jaGVja0RldmljZVRydXN0KFxuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUuY3Jvc3NTaWduaW5nSW5mbyxcbiAgICAgICAgICAgICAgICBkZXZpY2VJbmZvLFxuICAgICAgICAgICAgICAgIGZhbHNlLFxuICAgICAgICAgICAgICAgIHRydWUsXG4gICAgICAgICAgICApLmlzQ3Jvc3NTaWduaW5nVmVyaWZpZWQoKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIkVycm9yIGdldHRpbmcgZGV2aWNlIGNyb3NzLXNpZ25pbmcgaW5mb1wiLCBlKTtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkRldmljZVNlbGVjdGlvblRvZ2dsZWQgPSAoZGV2aWNlOiBJTXlEZXZpY2UpOiB2b2lkID0+IHtcbiAgICAgICAgaWYgKHRoaXMudW5tb3VudGVkKSB7IHJldHVybjsgfVxuXG4gICAgICAgIGNvbnN0IGRldmljZUlkID0gZGV2aWNlLmRldmljZV9pZDtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSgoc3RhdGUsIHByb3BzKSA9PiB7XG4gICAgICAgICAgICAvLyBNYWtlIGEgY29weSBvZiB0aGUgc2VsZWN0ZWQgZGV2aWNlcywgdGhlbiBhZGQgb3IgcmVtb3ZlIHRoZSBkZXZpY2VcbiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkRGV2aWNlcyA9IHN0YXRlLnNlbGVjdGVkRGV2aWNlcy5zbGljZSgpO1xuXG4gICAgICAgICAgICBjb25zdCBpID0gc2VsZWN0ZWREZXZpY2VzLmluZGV4T2YoZGV2aWNlSWQpO1xuICAgICAgICAgICAgaWYgKGkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgc2VsZWN0ZWREZXZpY2VzLnB1c2goZGV2aWNlSWQpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzZWxlY3RlZERldmljZXMuc3BsaWNlKGksIDEpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4geyBzZWxlY3RlZERldmljZXMgfTtcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgc2VsZWN0QWxsID0gKGRldmljZXM6IElNeURldmljZVtdKTogdm9pZCA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoKHN0YXRlLCBwcm9wcykgPT4ge1xuICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWREZXZpY2VzID0gc3RhdGUuc2VsZWN0ZWREZXZpY2VzLnNsaWNlKCk7XG5cbiAgICAgICAgICAgIGZvciAoY29uc3QgZGV2aWNlIG9mIGRldmljZXMpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBkZXZpY2VJZCA9IGRldmljZS5kZXZpY2VfaWQ7XG4gICAgICAgICAgICAgICAgaWYgKCFzZWxlY3RlZERldmljZXMuaW5jbHVkZXMoZGV2aWNlSWQpKSB7XG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkRGV2aWNlcy5wdXNoKGRldmljZUlkKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB7IHNlbGVjdGVkRGV2aWNlcyB9O1xuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBkZXNlbGVjdEFsbCA9IChkZXZpY2VzOiBJTXlEZXZpY2VbXSk6IHZvaWQgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKChzdGF0ZSwgcHJvcHMpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkRGV2aWNlcyA9IHN0YXRlLnNlbGVjdGVkRGV2aWNlcy5zbGljZSgpO1xuXG4gICAgICAgICAgICBmb3IgKGNvbnN0IGRldmljZSBvZiBkZXZpY2VzKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZGV2aWNlSWQgPSBkZXZpY2UuZGV2aWNlX2lkO1xuICAgICAgICAgICAgICAgIGNvbnN0IGkgPSBzZWxlY3RlZERldmljZXMuaW5kZXhPZihkZXZpY2VJZCk7XG4gICAgICAgICAgICAgICAgaWYgKGkgIT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkRGV2aWNlcy5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4geyBzZWxlY3RlZERldmljZXMgfTtcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25EZWxldGVDbGljayA9ICgpOiB2b2lkID0+IHtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuc2VsZWN0ZWREZXZpY2VzLmxlbmd0aCA9PT0gMCkgeyByZXR1cm47IH1cblxuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIGRlbGV0aW5nOiB0cnVlLFxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLm1ha2VEZWxldGVSZXF1ZXN0KG51bGwpLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMudW5tb3VudGVkKSB7IHJldHVybjsgfVxuICAgICAgICAgICAgaWYgKGVycm9yLmh0dHBTdGF0dXMgIT09IDQwMSB8fCAhZXJyb3IuZGF0YSB8fCAhZXJyb3IuZGF0YS5mbG93cykge1xuICAgICAgICAgICAgICAgIC8vIGRvZXNuJ3QgbG9vayBsaWtlIGFuIGludGVyYWN0aXZlLWF1dGggZmFpbHVyZVxuICAgICAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBwb3AgdXAgYW4gaW50ZXJhY3RpdmUgYXV0aCBkaWFsb2dcblxuICAgICAgICAgICAgY29uc3QgbnVtRGV2aWNlcyA9IHRoaXMuc3RhdGUuc2VsZWN0ZWREZXZpY2VzLmxlbmd0aDtcbiAgICAgICAgICAgIGNvbnN0IGRpYWxvZ0Flc3RoZXRpY3MgPSB7XG4gICAgICAgICAgICAgICAgW1NTT0F1dGhFbnRyeS5QSEFTRV9QUkVBVVRIXToge1xuICAgICAgICAgICAgICAgICAgICB0aXRsZTogX3QoXCJVc2UgU2luZ2xlIFNpZ24gT24gdG8gY29udGludWVcIiksXG4gICAgICAgICAgICAgICAgICAgIGJvZHk6IF90KFwiQ29uZmlybSBsb2dnaW5nIG91dCB0aGVzZSBkZXZpY2VzIGJ5IHVzaW5nIFNpbmdsZSBTaWduIE9uIHRvIHByb3ZlIHlvdXIgaWRlbnRpdHkuXCIsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50OiBudW1EZXZpY2VzLFxuICAgICAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICAgICAgY29udGludWVUZXh0OiBfdChcIlNpbmdsZSBTaWduIE9uXCIpLFxuICAgICAgICAgICAgICAgICAgICBjb250aW51ZUtpbmQ6IFwicHJpbWFyeVwiLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgW1NTT0F1dGhFbnRyeS5QSEFTRV9QT1NUQVVUSF06IHtcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6IF90KFwiQ29uZmlybSBzaWduaW5nIG91dCB0aGVzZSBkZXZpY2VzXCIpLFxuICAgICAgICAgICAgICAgICAgICBib2R5OiBfdChcIkNsaWNrIHRoZSBidXR0b24gYmVsb3cgdG8gY29uZmlybSBzaWduaW5nIG91dCB0aGVzZSBkZXZpY2VzLlwiLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb3VudDogbnVtRGV2aWNlcyxcbiAgICAgICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlVGV4dDogX3QoXCJTaWduIG91dCBkZXZpY2VzXCIsIHsgY291bnQ6IG51bURldmljZXMgfSksXG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlS2luZDogXCJkYW5nZXJcIixcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coJ0RlbGV0ZSBEZXZpY2UgRGlhbG9nJywgJycsIEludGVyYWN0aXZlQXV0aERpYWxvZywge1xuICAgICAgICAgICAgICAgIHRpdGxlOiBfdChcIkF1dGhlbnRpY2F0aW9uXCIpLFxuICAgICAgICAgICAgICAgIG1hdHJpeENsaWVudDogTWF0cml4Q2xpZW50UGVnLmdldCgpLFxuICAgICAgICAgICAgICAgIGF1dGhEYXRhOiBlcnJvci5kYXRhLFxuICAgICAgICAgICAgICAgIG1ha2VSZXF1ZXN0OiB0aGlzLm1ha2VEZWxldGVSZXF1ZXN0LmJpbmQodGhpcyksXG4gICAgICAgICAgICAgICAgYWVzdGhldGljc0ZvclN0YWdlUGhhc2VzOiB7XG4gICAgICAgICAgICAgICAgICAgIFtTU09BdXRoRW50cnkuTE9HSU5fVFlQRV06IGRpYWxvZ0Flc3RoZXRpY3MsXG4gICAgICAgICAgICAgICAgICAgIFtTU09BdXRoRW50cnkuVU5TVEFCTEVfTE9HSU5fVFlQRV06IGRpYWxvZ0Flc3RoZXRpY3MsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KS5jYXRjaCgoZSkgPT4ge1xuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKFwiRXJyb3IgZGVsZXRpbmcgc2Vzc2lvbnNcIiwgZSk7XG4gICAgICAgICAgICBpZiAodGhpcy51bm1vdW50ZWQpIHsgcmV0dXJuOyB9XG4gICAgICAgIH0pLmZpbmFsbHkoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgZGVsZXRpbmc6IGZhbHNlLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICAvLyBUT0RPOiBwcm9wZXIgdHlwaW5nIGZvciBhdXRoXG4gICAgcHJpdmF0ZSBtYWtlRGVsZXRlUmVxdWVzdChhdXRoPzogYW55KTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIE1hdHJpeENsaWVudFBlZy5nZXQoKS5kZWxldGVNdWx0aXBsZURldmljZXModGhpcy5zdGF0ZS5zZWxlY3RlZERldmljZXMsIGF1dGgpLnRoZW4oXG4gICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgLy8gUmVzZXQgc2VsZWN0aW9uIHRvIFtdLCB1cGRhdGUgZGV2aWNlIGxpc3RcbiAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWREZXZpY2VzOiBbXSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB0aGlzLmxvYWREZXZpY2VzKCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVuZGVyRGV2aWNlID0gKGRldmljZTogSU15RGV2aWNlKTogSlNYLkVsZW1lbnQgPT4ge1xuICAgICAgICBjb25zdCBteURldmljZUlkID0gTWF0cml4Q2xpZW50UGVnLmdldCgpLmdldERldmljZUlkKCk7XG4gICAgICAgIGNvbnN0IG15RGV2aWNlID0gdGhpcy5zdGF0ZS5kZXZpY2VzLmZpbmQoKGRldmljZSkgPT4gKGRldmljZS5kZXZpY2VfaWQgPT09IG15RGV2aWNlSWQpKTtcblxuICAgICAgICBjb25zdCBpc093bkRldmljZSA9IGRldmljZS5kZXZpY2VfaWQgPT09IG15RGV2aWNlSWQ7XG5cbiAgICAgICAgLy8gSWYgb3VyIG93biBkZXZpY2UgaXMgdW52ZXJpZmllZCwgaXQgY2FuJ3QgdmVyaWZ5IG90aGVyXG4gICAgICAgIC8vIGRldmljZXMsIGl0IGNhbiBvbmx5IHJlcXVlc3QgdmVyaWZpY2F0aW9uIGZvciBpdHNlbGZcbiAgICAgICAgY29uc3QgY2FuQmVWZXJpZmllZCA9IChteURldmljZSAmJiB0aGlzLmlzRGV2aWNlVmVyaWZpZWQobXlEZXZpY2UpKSB8fCBpc093bkRldmljZTtcblxuICAgICAgICByZXR1cm4gPERldmljZXNQYW5lbEVudHJ5XG4gICAgICAgICAgICBrZXk9e2RldmljZS5kZXZpY2VfaWR9XG4gICAgICAgICAgICBkZXZpY2U9e2RldmljZX1cbiAgICAgICAgICAgIHNlbGVjdGVkPXt0aGlzLnN0YXRlLnNlbGVjdGVkRGV2aWNlcy5pbmNsdWRlcyhkZXZpY2UuZGV2aWNlX2lkKX1cbiAgICAgICAgICAgIGlzT3duRGV2aWNlPXtpc093bkRldmljZX1cbiAgICAgICAgICAgIHZlcmlmaWVkPXt0aGlzLmlzRGV2aWNlVmVyaWZpZWQoZGV2aWNlKX1cbiAgICAgICAgICAgIGNhbkJlVmVyaWZpZWQ9e2NhbkJlVmVyaWZpZWR9XG4gICAgICAgICAgICBvbkRldmljZUNoYW5nZT17dGhpcy5sb2FkRGV2aWNlc31cbiAgICAgICAgICAgIG9uRGV2aWNlVG9nZ2xlZD17dGhpcy5vbkRldmljZVNlbGVjdGlvblRvZ2dsZWR9XG4gICAgICAgIC8+O1xuICAgIH07XG5cbiAgICBwdWJsaWMgcmVuZGVyKCk6IEpTWC5FbGVtZW50IHtcbiAgICAgICAgY29uc3QgbG9hZEVycm9yID0gKFxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9e2NsYXNzTmFtZXModGhpcy5wcm9wcy5jbGFzc05hbWUsIFwiZXJyb3JcIil9PlxuICAgICAgICAgICAgICAgIHsgdGhpcy5zdGF0ZS5kZXZpY2VMb2FkRXJyb3IgfVxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuZGV2aWNlTG9hZEVycm9yICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHJldHVybiBsb2FkRXJyb3I7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBkZXZpY2VzID0gdGhpcy5zdGF0ZS5kZXZpY2VzO1xuICAgICAgICBpZiAoZGV2aWNlcyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAvLyBzdGlsbCBsb2FkaW5nXG4gICAgICAgICAgICByZXR1cm4gPFNwaW5uZXIgLz47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBteURldmljZUlkID0gTWF0cml4Q2xpZW50UGVnLmdldCgpLmdldERldmljZUlkKCk7XG4gICAgICAgIGNvbnN0IG15RGV2aWNlID0gZGV2aWNlcy5maW5kKChkZXZpY2UpID0+IChkZXZpY2UuZGV2aWNlX2lkID09PSBteURldmljZUlkKSk7XG4gICAgICAgIGlmICghbXlEZXZpY2UpIHtcbiAgICAgICAgICAgIHJldHVybiBsb2FkRXJyb3I7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBvdGhlckRldmljZXMgPSBkZXZpY2VzLmZpbHRlcigoZGV2aWNlKSA9PiAoZGV2aWNlLmRldmljZV9pZCAhPT0gbXlEZXZpY2VJZCkpO1xuICAgICAgICBvdGhlckRldmljZXMuc29ydCh0aGlzLmRldmljZUNvbXBhcmUpO1xuXG4gICAgICAgIGNvbnN0IHZlcmlmaWVkRGV2aWNlcyA9IFtdO1xuICAgICAgICBjb25zdCB1bnZlcmlmaWVkRGV2aWNlcyA9IFtdO1xuICAgICAgICBjb25zdCBub25DcnlwdG9EZXZpY2VzID0gW107XG4gICAgICAgIGZvciAoY29uc3QgZGV2aWNlIG9mIG90aGVyRGV2aWNlcykge1xuICAgICAgICAgICAgY29uc3QgdmVyaWZpZWQgPSB0aGlzLmlzRGV2aWNlVmVyaWZpZWQoZGV2aWNlKTtcbiAgICAgICAgICAgIGlmICh2ZXJpZmllZCA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgIHZlcmlmaWVkRGV2aWNlcy5wdXNoKGRldmljZSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHZlcmlmaWVkID09PSBmYWxzZSkge1xuICAgICAgICAgICAgICAgIHVudmVyaWZpZWREZXZpY2VzLnB1c2goZGV2aWNlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbm9uQ3J5cHRvRGV2aWNlcy5wdXNoKGRldmljZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzZWN0aW9uID0gKHRydXN0SWNvbjogSlNYLkVsZW1lbnQsIHRpdGxlOiBzdHJpbmcsIGRldmljZUxpc3Q6IElNeURldmljZVtdKTogSlNYLkVsZW1lbnQgPT4ge1xuICAgICAgICAgICAgaWYgKGRldmljZUxpc3QubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDxSZWFjdC5GcmFnbWVudCAvPjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IHNlbGVjdEJ1dHRvbjogSlNYLkVsZW1lbnQ7XG4gICAgICAgICAgICBpZiAoZGV2aWNlTGlzdC5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgYW55U2VsZWN0ZWQgPSBkZXZpY2VMaXN0LnNvbWUoKGRldmljZSkgPT4gdGhpcy5zdGF0ZS5zZWxlY3RlZERldmljZXMuaW5jbHVkZXMoZGV2aWNlLmRldmljZV9pZCkpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGJ1dHRvbkFjdGlvbiA9IGFueVNlbGVjdGVkID9cbiAgICAgICAgICAgICAgICAgICAgKCkgPT4geyB0aGlzLmRlc2VsZWN0QWxsKGRldmljZUxpc3QpOyB9IDpcbiAgICAgICAgICAgICAgICAgICAgKCkgPT4geyB0aGlzLnNlbGVjdEFsbChkZXZpY2VMaXN0KTsgfTtcbiAgICAgICAgICAgICAgICBjb25zdCBidXR0b25UZXh0ID0gYW55U2VsZWN0ZWQgPyBfdChcIkRlc2VsZWN0IGFsbFwiKSA6IF90KFwiU2VsZWN0IGFsbFwiKTtcbiAgICAgICAgICAgICAgICBzZWxlY3RCdXR0b24gPSA8ZGl2IGNsYXNzTmFtZT1cIm14X0RldmljZXNQYW5lbF9oZWFkZXJfYnV0dG9uXCI+XG4gICAgICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uXG4gICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9EZXZpY2VzUGFuZWxfc2VsZWN0QnV0dG9uXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIGtpbmQ9XCJzZWNvbmRhcnlcIlxuICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17YnV0dG9uQWN0aW9ufVxuICAgICAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICAgICAgICB7IGJ1dHRvblRleHQgfVxuICAgICAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICAgICAgPC9kaXY+O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gPFJlYWN0LkZyYWdtZW50PlxuICAgICAgICAgICAgICAgIDxociAvPlxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfRGV2aWNlc1BhbmVsX2hlYWRlclwiPlxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0RldmljZXNQYW5lbF9oZWFkZXJfdHJ1c3RcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgdHJ1c3RJY29uIH1cbiAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfRGV2aWNlc1BhbmVsX2hlYWRlcl90aXRsZVwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgeyB0aXRsZSB9XG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICB7IHNlbGVjdEJ1dHRvbiB9XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgeyBkZXZpY2VMaXN0Lm1hcCh0aGlzLnJlbmRlckRldmljZSkgfVxuICAgICAgICAgICAgPC9SZWFjdC5GcmFnbWVudD47XG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgdmVyaWZpZWREZXZpY2VzU2VjdGlvbiA9IHNlY3Rpb24oXG4gICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9XCJteF9EZXZpY2VzUGFuZWxfaGVhZGVyX2ljb24gbXhfRTJFSWNvbiBteF9FMkVJY29uX3ZlcmlmaWVkXCIgLz4sXG4gICAgICAgICAgICBfdChcIlZlcmlmaWVkIGRldmljZXNcIiksXG4gICAgICAgICAgICB2ZXJpZmllZERldmljZXMsXG4gICAgICAgICk7XG5cbiAgICAgICAgY29uc3QgdW52ZXJpZmllZERldmljZXNTZWN0aW9uID0gc2VjdGlvbihcbiAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT1cIm14X0RldmljZXNQYW5lbF9oZWFkZXJfaWNvbiBteF9FMkVJY29uIG14X0UyRUljb25fd2FybmluZ1wiIC8+LFxuICAgICAgICAgICAgX3QoXCJVbnZlcmlmaWVkIGRldmljZXNcIiksXG4gICAgICAgICAgICB1bnZlcmlmaWVkRGV2aWNlcyxcbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCBub25DcnlwdG9EZXZpY2VzU2VjdGlvbiA9IHNlY3Rpb24oXG4gICAgICAgICAgICA8UmVhY3QuRnJhZ21lbnQgLz4sXG4gICAgICAgICAgICBfdChcIkRldmljZXMgd2l0aG91dCBlbmNyeXB0aW9uIHN1cHBvcnRcIiksXG4gICAgICAgICAgICBub25DcnlwdG9EZXZpY2VzLFxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IGRlbGV0ZUJ1dHRvbiA9IHRoaXMuc3RhdGUuZGVsZXRpbmcgP1xuICAgICAgICAgICAgPFNwaW5uZXIgdz17MjJ9IGg9ezIyfSAvPiA6XG4gICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvblxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X0RldmljZXNQYW5lbF9kZWxldGVCdXR0b25cIlxuICAgICAgICAgICAgICAgIG9uQ2xpY2s9e3RoaXMub25EZWxldGVDbGlja31cbiAgICAgICAgICAgICAgICBraW5kPVwiZGFuZ2VyX291dGxpbmVcIlxuICAgICAgICAgICAgICAgIGRpc2FibGVkPXt0aGlzLnN0YXRlLnNlbGVjdGVkRGV2aWNlcy5sZW5ndGggPT09IDB9XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgeyBfdChcIlNpZ24gb3V0ICUoY291bnQpcyBzZWxlY3RlZCBkZXZpY2VzXCIsIHsgY291bnQ6IHRoaXMuc3RhdGUuc2VsZWN0ZWREZXZpY2VzLmxlbmd0aCB9KSB9XG4gICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+O1xuXG4gICAgICAgIGNvbnN0IG90aGVyRGV2aWNlc1NlY3Rpb24gPSAob3RoZXJEZXZpY2VzLmxlbmd0aCA+IDApID9cbiAgICAgICAgICAgIDxSZWFjdC5GcmFnbWVudD5cbiAgICAgICAgICAgICAgICB7IHZlcmlmaWVkRGV2aWNlc1NlY3Rpb24gfVxuICAgICAgICAgICAgICAgIHsgdW52ZXJpZmllZERldmljZXNTZWN0aW9uIH1cbiAgICAgICAgICAgICAgICB7IG5vbkNyeXB0b0RldmljZXNTZWN0aW9uIH1cbiAgICAgICAgICAgICAgICB7IGRlbGV0ZUJ1dHRvbiB9XG4gICAgICAgICAgICA8L1JlYWN0LkZyYWdtZW50PiA6XG4gICAgICAgICAgICA8UmVhY3QuRnJhZ21lbnQ+XG4gICAgICAgICAgICAgICAgPGhyIC8+XG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9EZXZpY2VzUGFuZWxfbm9PdGhlckRldmljZXNcIj5cbiAgICAgICAgICAgICAgICAgICAgeyBfdChcIllvdSBhcmVuJ3Qgc2lnbmVkIGludG8gYW55IG90aGVyIGRldmljZXMuXCIpIH1cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgIDwvUmVhY3QuRnJhZ21lbnQ+O1xuXG4gICAgICAgIGNvbnN0IGNsYXNzZXMgPSBjbGFzc05hbWVzKHRoaXMucHJvcHMuY2xhc3NOYW1lLCBcIm14X0RldmljZXNQYW5lbFwiKTtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPXtjbGFzc2VzfT5cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0RldmljZXNQYW5lbF9oZWFkZXJcIj5cbiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9EZXZpY2VzUGFuZWxfaGVhZGVyX3RpdGxlXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICB7IF90KFwiVGhpcyBkZXZpY2VcIikgfVxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICB7IHRoaXMucmVuZGVyRGV2aWNlKG15RGV2aWNlKSB9XG4gICAgICAgICAgICAgICAgeyBvdGhlckRldmljZXNTZWN0aW9uIH1cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICApO1xuICAgIH1cbn1cbiJdfQ==