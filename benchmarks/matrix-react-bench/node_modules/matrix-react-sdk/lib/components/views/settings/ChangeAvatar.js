"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _languageHandler = require("../../../languageHandler");

var _Spinner = _interopRequireDefault(require("../elements/Spinner"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _Media = require("../../../customisations/Media");

var _RoomAvatar = _interopRequireDefault(require("../avatars/RoomAvatar"));

var _BaseAvatar = _interopRequireDefault(require("../avatars/BaseAvatar"));

var _dec, _class, _class2, _temp;

var Phases;

(function (Phases) {
  Phases["Display"] = "display";
  Phases["Uploading"] = "uploading";
  Phases["Error"] = "error";
})(Phases || (Phases = {}));

let ChangeAvatar = (_dec = (0, _replaceableComponent.replaceableComponent)("views.settings.ChangeAvatar"), _dec(_class = (_temp = _class2 = class ChangeAvatar extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "avatarSet", false);
    (0, _defineProperty2.default)(this, "onRoomStateEvents", ev => {
      if (!this.props.room) {
        return;
      }

      if (ev.getRoomId() !== this.props.room.roomId || ev.getType() !== 'm.room.avatar' || ev.getSender() !== _MatrixClientPeg.MatrixClientPeg.get().getUserId()) {
        return;
      }

      if (!ev.getContent().url) {
        this.avatarSet = false;
        this.setState({}); // force update
      }
    });
    (0, _defineProperty2.default)(this, "onFileSelected", ev => {
      this.avatarSet = true;
      return this.setAvatarFromFile(ev.target.files[0]);
    });
    (0, _defineProperty2.default)(this, "onError", () => {
      this.setState({
        errorText: (0, _languageHandler._t)("Failed to upload profile picture!")
      });
    });
    this.state = {
      avatarUrl: this.props.initialAvatarUrl,
      phase: Phases.Display
    };
  }

  componentDidMount() {
    _MatrixClientPeg.MatrixClientPeg.get().on("RoomState.events", this.onRoomStateEvents);
  } // TODO: [REACT-WARNING] Replace with appropriate lifecycle event
  // eslint-disable-next-line


  UNSAFE_componentWillReceiveProps(newProps) {
    if (this.avatarSet) {
      // don't clobber what the user has just set
      return;
    }

    this.setState({
      avatarUrl: newProps.initialAvatarUrl
    });
  }

  componentWillUnmount() {
    if (_MatrixClientPeg.MatrixClientPeg.get()) {
      _MatrixClientPeg.MatrixClientPeg.get().removeListener("RoomState.events", this.onRoomStateEvents);
    }
  }

  setAvatarFromFile(file) {
    let newUrl = null;
    this.setState({
      phase: Phases.Uploading
    });

    const httpPromise = _MatrixClientPeg.MatrixClientPeg.get().uploadContent(file).then(url => {
      newUrl = url;

      if (this.props.room) {
        return _MatrixClientPeg.MatrixClientPeg.get().sendStateEvent(this.props.room.roomId, 'm.room.avatar', {
          url: url
        }, '');
      } else {
        return _MatrixClientPeg.MatrixClientPeg.get().setAvatarUrl(url);
      }
    });

    httpPromise.then(() => {
      this.setState({
        phase: Phases.Display,
        avatarUrl: (0, _Media.mediaFromMxc)(newUrl).srcHttp
      });
    }, () => {
      this.setState({
        phase: Phases.Error
      });
      this.onError();
    });
    return httpPromise;
  }

  render() {
    let avatarImg; // Having just set an avatar we just display that since it will take a little
    // time to propagate through to the RoomAvatar.

    if (this.props.room && !this.avatarSet) {
      avatarImg = /*#__PURE__*/_react.default.createElement(_RoomAvatar.default, {
        room: this.props.room,
        width: this.props.width,
        height: this.props.height,
        resizeMethod: "crop"
      });
    } else {
      // XXX: FIXME: once we track in the JS what our own displayname is(!) then use it here rather than ?
      avatarImg = /*#__PURE__*/_react.default.createElement(_BaseAvatar.default, {
        width: this.props.width,
        height: this.props.height,
        resizeMethod: "crop",
        name: "?",
        idName: _MatrixClientPeg.MatrixClientPeg.get().getUserIdLocalpart(),
        url: this.state.avatarUrl
      });
    }

    let uploadSection;

    if (this.props.showUploadSection) {
      uploadSection = /*#__PURE__*/_react.default.createElement("div", {
        className: this.props.className
      }, (0, _languageHandler._t)("Upload new:"), /*#__PURE__*/_react.default.createElement("input", {
        type: "file",
        accept: "image/*",
        onChange: this.onFileSelected
      }), this.state.errorText);
    }

    switch (this.state.phase) {
      case Phases.Display:
      case Phases.Error:
        return /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("div", {
          className: this.props.className
        }, avatarImg), uploadSection);

      case Phases.Uploading:
        return /*#__PURE__*/_react.default.createElement(_Spinner.default, null);
    }
  }

}, (0, _defineProperty2.default)(_class2, "defaultProps", {
  showUploadSection: true,
  className: "",
  width: 80,
  height: 80
}), _temp)) || _class);
exports.default = ChangeAvatar;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3NldHRpbmdzL0NoYW5nZUF2YXRhci50c3giXSwibmFtZXMiOlsiUGhhc2VzIiwiQ2hhbmdlQXZhdGFyIiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwiZXYiLCJyb29tIiwiZ2V0Um9vbUlkIiwicm9vbUlkIiwiZ2V0VHlwZSIsImdldFNlbmRlciIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsImdldFVzZXJJZCIsImdldENvbnRlbnQiLCJ1cmwiLCJhdmF0YXJTZXQiLCJzZXRTdGF0ZSIsInNldEF2YXRhckZyb21GaWxlIiwidGFyZ2V0IiwiZmlsZXMiLCJlcnJvclRleHQiLCJzdGF0ZSIsImF2YXRhclVybCIsImluaXRpYWxBdmF0YXJVcmwiLCJwaGFzZSIsIkRpc3BsYXkiLCJjb21wb25lbnREaWRNb3VudCIsIm9uIiwib25Sb29tU3RhdGVFdmVudHMiLCJVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyIsIm5ld1Byb3BzIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJyZW1vdmVMaXN0ZW5lciIsImZpbGUiLCJuZXdVcmwiLCJVcGxvYWRpbmciLCJodHRwUHJvbWlzZSIsInVwbG9hZENvbnRlbnQiLCJ0aGVuIiwic2VuZFN0YXRlRXZlbnQiLCJzZXRBdmF0YXJVcmwiLCJzcmNIdHRwIiwiRXJyb3IiLCJvbkVycm9yIiwicmVuZGVyIiwiYXZhdGFySW1nIiwid2lkdGgiLCJoZWlnaHQiLCJnZXRVc2VySWRMb2NhbHBhcnQiLCJ1cGxvYWRTZWN0aW9uIiwic2hvd1VwbG9hZFNlY3Rpb24iLCJjbGFzc05hbWUiLCJvbkZpbGVTZWxlY3RlZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFnQkE7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7SUFrQktBLE07O1dBQUFBLE07QUFBQUEsRUFBQUEsTTtBQUFBQSxFQUFBQSxN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RUFBRXJDLGlDQUFnQkMsR0FBaEIsR0FBc0JxQyxrQkFBdEIsRUFMQTtBQU1SLFFBQUEsR0FBRyxFQUFFLEtBQUszQixLQUFMLENBQVdDO0FBTlIsUUFBWjtBQVFIOztBQUVELFFBQUkyQixhQUFKOztBQUNBLFFBQUksS0FBSzlDLEtBQUwsQ0FBVytDLGlCQUFmLEVBQWtDO0FBQzlCRCxNQUFBQSxhQUFhLGdCQUNUO0FBQUssUUFBQSxTQUFTLEVBQUUsS0FBSzlDLEtBQUwsQ0FBV2dEO0FBQTNCLFNBQ00seUJBQUcsYUFBSCxDQUROLGVBRUk7QUFBTyxRQUFBLElBQUksRUFBQyxNQUFaO0FBQW1CLFFBQUEsTUFBTSxFQUFDLFNBQTFCO0FBQW9DLFFBQUEsUUFBUSxFQUFFLEtBQUtDO0FBQW5ELFFBRkosRUFHTSxLQUFLL0IsS0FBTCxDQUFXRCxTQUhqQixDQURKO0FBT0g7O0FBRUQsWUFBUSxLQUFLQyxLQUFMLENBQVdHLEtBQW5CO0FBQ0ksV0FBSzFCLE1BQU0sQ0FBQzJCLE9BQVo7QUFDQSxXQUFLM0IsTUFBTSxDQUFDNEMsS0FBWjtBQUNJLDRCQUNJLHVEQUNJO0FBQUssVUFBQSxTQUFTLEVBQUUsS0FBS3ZDLEtBQUwsQ0FBV2dEO0FBQTNCLFdBQ01OLFNBRE4sQ0FESixFQUlNSSxhQUpOLENBREo7O0FBUUosV0FBS25ELE1BQU0sQ0FBQ3FDLFNBQVo7QUFDSSw0QkFDSSw2QkFBQyxnQkFBRCxPQURKO0FBWlI7QUFnQkg7O0FBekpxRSxDLHlEQUN6QztBQUN6QmUsRUFBQUEsaUJBQWlCLEVBQUUsSUFETTtBQUV6QkMsRUFBQUEsU0FBUyxFQUFFLEVBRmM7QUFHekJMLEVBQUFBLEtBQUssRUFBRSxFQUhrQjtBQUl6QkMsRUFBQUEsTUFBTSxFQUFFO0FBSmlCLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTUtMjAyMSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBNYXRyaXhFdmVudCB9IGZyb20gJ21hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9ldmVudCc7XG5pbXBvcnQgeyBSb29tIH0gZnJvbSAnbWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3Jvb20nO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSBcIi4uLy4uLy4uL01hdHJpeENsaWVudFBlZ1wiO1xuaW1wb3J0IHsgX3QgfSBmcm9tICcuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXInO1xuaW1wb3J0IFNwaW5uZXIgZnJvbSAnLi4vZWxlbWVudHMvU3Bpbm5lcic7XG5pbXBvcnQgeyByZXBsYWNlYWJsZUNvbXBvbmVudCB9IGZyb20gXCIuLi8uLi8uLi91dGlscy9yZXBsYWNlYWJsZUNvbXBvbmVudFwiO1xuaW1wb3J0IHsgbWVkaWFGcm9tTXhjIH0gZnJvbSBcIi4uLy4uLy4uL2N1c3RvbWlzYXRpb25zL01lZGlhXCI7XG5pbXBvcnQgUm9vbUF2YXRhciBmcm9tICcuLi9hdmF0YXJzL1Jvb21BdmF0YXInO1xuaW1wb3J0IEJhc2VBdmF0YXIgZnJvbSAnLi4vYXZhdGFycy9CYXNlQXZhdGFyJztcblxuaW50ZXJmYWNlIElQcm9wcyB7XG4gICAgaW5pdGlhbEF2YXRhclVybD86IHN0cmluZztcbiAgICByb29tPzogUm9vbTtcbiAgICAvLyBpZiBmYWxzZSwgeW91IG5lZWQgdG8gY2FsbCBjaGFuZ2VBdmF0YXIub25GaWxlU2VsZWN0ZWQgeW91cnNlbGYuXG4gICAgc2hvd1VwbG9hZFNlY3Rpb24/OiBib29sZWFuO1xuICAgIHdpZHRoPzogbnVtYmVyO1xuICAgIGhlaWdodD86IG51bWJlcjtcbiAgICBjbGFzc05hbWU/OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBJU3RhdGUge1xuICAgIGF2YXRhclVybD86IHN0cmluZztcbiAgICBlcnJvclRleHQ/OiBzdHJpbmc7XG4gICAgcGhhc2U/OiBQaGFzZXM7XG59XG5cbmVudW0gUGhhc2VzIHtcbiAgICBEaXNwbGF5ID0gXCJkaXNwbGF5XCIsXG4gICAgVXBsb2FkaW5nID0gXCJ1cGxvYWRpbmdcIixcbiAgICBFcnJvciA9IFwiZXJyb3JcIixcbn1cblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3Muc2V0dGluZ3MuQ2hhbmdlQXZhdGFyXCIpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDaGFuZ2VBdmF0YXIgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8SVByb3BzLCBJU3RhdGU+IHtcbiAgICBwdWJsaWMgc3RhdGljIGRlZmF1bHRQcm9wcyA9IHtcbiAgICAgICAgc2hvd1VwbG9hZFNlY3Rpb246IHRydWUsXG4gICAgICAgIGNsYXNzTmFtZTogXCJcIixcbiAgICAgICAgd2lkdGg6IDgwLFxuICAgICAgICBoZWlnaHQ6IDgwLFxuICAgIH07XG5cbiAgICBwcml2YXRlIGF2YXRhclNldCA9IGZhbHNlO1xuXG4gICAgY29uc3RydWN0b3IocHJvcHM6IElQcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG5cbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIGF2YXRhclVybDogdGhpcy5wcm9wcy5pbml0aWFsQXZhdGFyVXJsLFxuICAgICAgICAgICAgcGhhc2U6IFBoYXNlcy5EaXNwbGF5LFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHB1YmxpYyBjb21wb25lbnREaWRNb3VudCgpOiB2b2lkIHtcbiAgICAgICAgTWF0cml4Q2xpZW50UGVnLmdldCgpLm9uKFwiUm9vbVN0YXRlLmV2ZW50c1wiLCB0aGlzLm9uUm9vbVN0YXRlRXZlbnRzKTtcbiAgICB9XG5cbiAgICAvLyBUT0RPOiBbUkVBQ1QtV0FSTklOR10gUmVwbGFjZSB3aXRoIGFwcHJvcHJpYXRlIGxpZmVjeWNsZSBldmVudFxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZVxuICAgIHB1YmxpYyBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXdQcm9wczogSVByb3BzKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmF2YXRhclNldCkge1xuICAgICAgICAgICAgLy8gZG9uJ3QgY2xvYmJlciB3aGF0IHRoZSB1c2VyIGhhcyBqdXN0IHNldFxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgYXZhdGFyVXJsOiBuZXdQcm9wcy5pbml0aWFsQXZhdGFyVXJsLFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY29tcG9uZW50V2lsbFVubW91bnQoKTogdm9pZCB7XG4gICAgICAgIGlmIChNYXRyaXhDbGllbnRQZWcuZ2V0KCkpIHtcbiAgICAgICAgICAgIE1hdHJpeENsaWVudFBlZy5nZXQoKS5yZW1vdmVMaXN0ZW5lcihcIlJvb21TdGF0ZS5ldmVudHNcIiwgdGhpcy5vblJvb21TdGF0ZUV2ZW50cyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIG9uUm9vbVN0YXRlRXZlbnRzID0gKGV2OiBNYXRyaXhFdmVudCkgPT4ge1xuICAgICAgICBpZiAoIXRoaXMucHJvcHMucm9vbSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGV2LmdldFJvb21JZCgpICE9PSB0aGlzLnByb3BzLnJvb20ucm9vbUlkIHx8IGV2LmdldFR5cGUoKSAhPT0gJ20ucm9vbS5hdmF0YXInXG4gICAgICAgICAgICB8fCBldi5nZXRTZW5kZXIoKSAhPT0gTWF0cml4Q2xpZW50UGVnLmdldCgpLmdldFVzZXJJZCgpKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWV2LmdldENvbnRlbnQoKS51cmwpIHtcbiAgICAgICAgICAgIHRoaXMuYXZhdGFyU2V0ID0gZmFsc2U7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHt9KTsgLy8gZm9yY2UgdXBkYXRlXG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBzZXRBdmF0YXJGcm9tRmlsZShmaWxlOiBGaWxlKTogUHJvbWlzZTx7fT4ge1xuICAgICAgICBsZXQgbmV3VXJsID0gbnVsbDtcblxuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIHBoYXNlOiBQaGFzZXMuVXBsb2FkaW5nLFxuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgaHR0cFByb21pc2UgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCkudXBsb2FkQ29udGVudChmaWxlKS50aGVuKCh1cmwpID0+IHtcbiAgICAgICAgICAgIG5ld1VybCA9IHVybDtcbiAgICAgICAgICAgIGlmICh0aGlzLnByb3BzLnJvb20pIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gTWF0cml4Q2xpZW50UGVnLmdldCgpLnNlbmRTdGF0ZUV2ZW50KFxuICAgICAgICAgICAgICAgICAgICB0aGlzLnByb3BzLnJvb20ucm9vbUlkLFxuICAgICAgICAgICAgICAgICAgICAnbS5yb29tLmF2YXRhcicsXG4gICAgICAgICAgICAgICAgICAgIHsgdXJsOiB1cmwgfSxcbiAgICAgICAgICAgICAgICAgICAgJycsXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIE1hdHJpeENsaWVudFBlZy5nZXQoKS5zZXRBdmF0YXJVcmwodXJsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgaHR0cFByb21pc2UudGhlbigoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICBwaGFzZTogUGhhc2VzLkRpc3BsYXksXG4gICAgICAgICAgICAgICAgYXZhdGFyVXJsOiBtZWRpYUZyb21NeGMobmV3VXJsKS5zcmNIdHRwLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0sICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgIHBoYXNlOiBQaGFzZXMuRXJyb3IsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHRoaXMub25FcnJvcigpO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gaHR0cFByb21pc2U7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkZpbGVTZWxlY3RlZCA9IChldjogUmVhY3QuQ2hhbmdlRXZlbnQ8SFRNTElucHV0RWxlbWVudD4pID0+IHtcbiAgICAgICAgdGhpcy5hdmF0YXJTZXQgPSB0cnVlO1xuICAgICAgICByZXR1cm4gdGhpcy5zZXRBdmF0YXJGcm9tRmlsZShldi50YXJnZXQuZmlsZXNbMF0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uRXJyb3IgPSAoKTogdm9pZCA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgZXJyb3JUZXh0OiBfdChcIkZhaWxlZCB0byB1cGxvYWQgcHJvZmlsZSBwaWN0dXJlIVwiKSxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHB1YmxpYyByZW5kZXIoKTogSlNYLkVsZW1lbnQge1xuICAgICAgICBsZXQgYXZhdGFySW1nO1xuICAgICAgICAvLyBIYXZpbmcganVzdCBzZXQgYW4gYXZhdGFyIHdlIGp1c3QgZGlzcGxheSB0aGF0IHNpbmNlIGl0IHdpbGwgdGFrZSBhIGxpdHRsZVxuICAgICAgICAvLyB0aW1lIHRvIHByb3BhZ2F0ZSB0aHJvdWdoIHRvIHRoZSBSb29tQXZhdGFyLlxuICAgICAgICBpZiAodGhpcy5wcm9wcy5yb29tICYmICF0aGlzLmF2YXRhclNldCkge1xuICAgICAgICAgICAgYXZhdGFySW1nID0gPFJvb21BdmF0YXJcbiAgICAgICAgICAgICAgICByb29tPXt0aGlzLnByb3BzLnJvb219XG4gICAgICAgICAgICAgICAgd2lkdGg9e3RoaXMucHJvcHMud2lkdGh9XG4gICAgICAgICAgICAgICAgaGVpZ2h0PXt0aGlzLnByb3BzLmhlaWdodH1cbiAgICAgICAgICAgICAgICByZXNpemVNZXRob2Q9J2Nyb3AnXG4gICAgICAgICAgICAvPjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIFhYWDogRklYTUU6IG9uY2Ugd2UgdHJhY2sgaW4gdGhlIEpTIHdoYXQgb3VyIG93biBkaXNwbGF5bmFtZSBpcyghKSB0aGVuIHVzZSBpdCBoZXJlIHJhdGhlciB0aGFuID9cbiAgICAgICAgICAgIGF2YXRhckltZyA9IDxCYXNlQXZhdGFyXG4gICAgICAgICAgICAgICAgd2lkdGg9e3RoaXMucHJvcHMud2lkdGh9XG4gICAgICAgICAgICAgICAgaGVpZ2h0PXt0aGlzLnByb3BzLmhlaWdodH1cbiAgICAgICAgICAgICAgICByZXNpemVNZXRob2Q9J2Nyb3AnXG4gICAgICAgICAgICAgICAgbmFtZT0nPydcbiAgICAgICAgICAgICAgICBpZE5hbWU9e01hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRVc2VySWRMb2NhbHBhcnQoKX1cbiAgICAgICAgICAgICAgICB1cmw9e3RoaXMuc3RhdGUuYXZhdGFyVXJsfVxuICAgICAgICAgICAgLz47XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgdXBsb2FkU2VjdGlvbjtcbiAgICAgICAgaWYgKHRoaXMucHJvcHMuc2hvd1VwbG9hZFNlY3Rpb24pIHtcbiAgICAgICAgICAgIHVwbG9hZFNlY3Rpb24gPSAoXG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9e3RoaXMucHJvcHMuY2xhc3NOYW1lfT5cbiAgICAgICAgICAgICAgICAgICAgeyBfdChcIlVwbG9hZCBuZXc6XCIpIH1cbiAgICAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9XCJmaWxlXCIgYWNjZXB0PVwiaW1hZ2UvKlwiIG9uQ2hhbmdlPXt0aGlzLm9uRmlsZVNlbGVjdGVkfSAvPlxuICAgICAgICAgICAgICAgICAgICB7IHRoaXMuc3RhdGUuZXJyb3JUZXh0IH1cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICBzd2l0Y2ggKHRoaXMuc3RhdGUucGhhc2UpIHtcbiAgICAgICAgICAgIGNhc2UgUGhhc2VzLkRpc3BsYXk6XG4gICAgICAgICAgICBjYXNlIFBoYXNlcy5FcnJvcjpcbiAgICAgICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgICAgICA8ZGl2PlxuICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9e3RoaXMucHJvcHMuY2xhc3NOYW1lfT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IGF2YXRhckltZyB9XG4gICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgdXBsb2FkU2VjdGlvbiB9XG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICBjYXNlIFBoYXNlcy5VcGxvYWRpbmc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICAgICAgPFNwaW5uZXIgLz5cbiAgICAgICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgfVxufVxuIl19