"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireDefault(require("react"));

var _partials = require("matrix-js-sdk/src/@types/partials");

var _event = require("matrix-js-sdk/src/@types/event");

var _StyledRadioGroup = _interopRequireDefault(require("../elements/StyledRadioGroup"));

var _languageHandler = require("../../../languageHandler");

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _RoomAvatar = _interopRequireDefault(require("../avatars/RoomAvatar"));

var _SpaceStore = _interopRequireDefault(require("../../../stores/spaces/SpaceStore"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _ManageRestrictedJoinRuleDialog = _interopRequireDefault(require("../dialogs/ManageRestrictedJoinRuleDialog"));

var _RoomUpgradeWarningDialog = _interopRequireDefault(require("../dialogs/RoomUpgradeWarningDialog"));

var _RoomUpgrade = require("../../../utils/RoomUpgrade");

var _arrays = require("../../../utils/arrays");

var _useLocalEcho = require("../../../hooks/useLocalEcho");

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var _RoomSettingsDialog = require("../dialogs/RoomSettingsDialog");

/*
Copyright 2021 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const JoinRuleSettings = ({
  room,
  promptUpgrade,
  onError,
  beforeChange,
  closeSettingsFn
}) => {
  const cli = room.client;
  const restrictedRoomCapabilities = _SpaceStore.default.instance.restrictedJoinRuleSupport;
  const roomSupportsRestricted = Array.isArray(restrictedRoomCapabilities === null || restrictedRoomCapabilities === void 0 ? void 0 : restrictedRoomCapabilities.support) && restrictedRoomCapabilities.support.includes(room.getVersion());
  const preferredRestrictionVersion = !roomSupportsRestricted && promptUpgrade ? restrictedRoomCapabilities === null || restrictedRoomCapabilities === void 0 ? void 0 : restrictedRoomCapabilities.preferred : undefined;
  const disabled = !room.currentState.mayClientSendStateEvent(_event.EventType.RoomJoinRules, cli);
  const [content, setContent] = (0, _useLocalEcho.useLocalEcho)(() => {
    var _room$currentState$ge;

    return (_room$currentState$ge = room.currentState.getStateEvents(_event.EventType.RoomJoinRules, "")) === null || _room$currentState$ge === void 0 ? void 0 : _room$currentState$ge.getContent();
  }, content => cli.sendStateEvent(room.roomId, _event.EventType.RoomJoinRules, content, ""), onError);
  const {
    join_rule: joinRule
  } = content;
  const restrictedAllowRoomIds = joinRule === _partials.JoinRule.Restricted ? content.allow.filter(o => o.type === _partials.RestrictedAllowType.RoomMembership).map(o => o.room_id) : undefined;

  const editRestrictedRoomIds = async () => {
    var _selected;

    let selected = restrictedAllowRoomIds;

    if (!((_selected = selected) !== null && _selected !== void 0 && _selected.length) && _SpaceStore.default.instance.activeSpaceRoom) {
      selected = [_SpaceStore.default.instance.activeSpaceRoom.roomId];
    }

    const matrixClient = _MatrixClientPeg.MatrixClientPeg.get();

    const {
      finished
    } = _Modal.default.createTrackedDialog('Edit restricted', '', _ManageRestrictedJoinRuleDialog.default, {
      matrixClient,
      room,
      selected
    }, "mx_ManageRestrictedJoinRuleDialog_wrapper");

    const [roomIds] = await finished;
    return roomIds;
  };

  const definitions = [{
    value: _partials.JoinRule.Invite,
    label: (0, _languageHandler._t)("Private (invite only)"),
    description: (0, _languageHandler._t)("Only invited people can join."),
    checked: joinRule === _partials.JoinRule.Invite || joinRule === _partials.JoinRule.Restricted && !(restrictedAllowRoomIds !== null && restrictedAllowRoomIds !== void 0 && restrictedAllowRoomIds.length)
  }, {
    value: _partials.JoinRule.Public,
    label: (0, _languageHandler._t)("Public"),
    description: (0, _languageHandler._t)("Anyone can find and join.")
  }];

  if (roomSupportsRestricted || preferredRestrictionVersion || joinRule === _partials.JoinRule.Restricted) {
    let upgradeRequiredPill;

    if (preferredRestrictionVersion) {
      upgradeRequiredPill = /*#__PURE__*/_react.default.createElement("span", {
        className: "mx_JoinRuleSettings_upgradeRequired"
      }, (0, _languageHandler._t)("Upgrade required"));
    }

    let description;

    if (joinRule === _partials.JoinRule.Restricted && restrictedAllowRoomIds !== null && restrictedAllowRoomIds !== void 0 && restrictedAllowRoomIds.length) {
      // only show the first 4 spaces we know about, so that the UI doesn't grow out of proportion there are lots.
      const shownSpaces = restrictedAllowRoomIds.map(roomId => cli.getRoom(roomId)).filter(room => room === null || room === void 0 ? void 0 : room.isSpaceRoom()).slice(0, 4);
      let moreText;

      if (shownSpaces.length < restrictedAllowRoomIds.length) {
        if (shownSpaces.length > 0) {
          moreText = (0, _languageHandler._t)("& %(count)s more", {
            count: restrictedAllowRoomIds.length - shownSpaces.length
          });
        } else {
          moreText = (0, _languageHandler._t)("Currently, %(count)s spaces have access", {
            count: restrictedAllowRoomIds.length
          });
        }
      }

      const onRestrictedRoomIdsChange = newAllowRoomIds => {
        if (!(0, _arrays.arrayHasDiff)(restrictedAllowRoomIds || [], newAllowRoomIds)) return;

        if (!newAllowRoomIds.length) {
          setContent({
            join_rule: _partials.JoinRule.Invite
          });
          return;
        }

        setContent({
          join_rule: _partials.JoinRule.Restricted,
          allow: newAllowRoomIds.map(roomId => ({
            "type": _partials.RestrictedAllowType.RoomMembership,
            "room_id": roomId
          }))
        });
      };

      const onEditRestrictedClick = async () => {
        const restrictedAllowRoomIds = await editRestrictedRoomIds();
        if (!Array.isArray(restrictedAllowRoomIds)) return;

        if (restrictedAllowRoomIds.length > 0) {
          onRestrictedRoomIdsChange(restrictedAllowRoomIds);
        } else {
          onChange(_partials.JoinRule.Invite);
        }
      };

      description = /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("span", null, (0, _languageHandler._t)("Anyone in a space can find and join. <a>Edit which spaces can access here.</a>", {}, {
        a: sub => /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
          disabled: disabled,
          onClick: onEditRestrictedClick,
          kind: "link",
          className: "mx_JoinRuleSettings_linkButton"
        }, sub)
      })), /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_JoinRuleSettings_spacesWithAccess"
      }, /*#__PURE__*/_react.default.createElement("h4", null, (0, _languageHandler._t)("Spaces with access")), shownSpaces.map(room => {
        return /*#__PURE__*/_react.default.createElement("span", {
          key: room.roomId
        }, /*#__PURE__*/_react.default.createElement(_RoomAvatar.default, {
          room: room,
          height: 32,
          width: 32
        }), room.name);
      }), moreText && /*#__PURE__*/_react.default.createElement("span", null, moreText)));
    } else if (_SpaceStore.default.instance.activeSpaceRoom) {
      description = (0, _languageHandler._t)("Anyone in <spaceName/> can find and join. You can select other spaces too.", {}, {
        spaceName: () => /*#__PURE__*/_react.default.createElement("b", null, _SpaceStore.default.instance.activeSpaceRoom.name)
      });
    } else {
      description = (0, _languageHandler._t)("Anyone in a space can find and join. You can select multiple spaces.");
    }

    definitions.splice(1, 0, {
      value: _partials.JoinRule.Restricted,
      label: /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, (0, _languageHandler._t)("Space members"), upgradeRequiredPill),
      description,
      // if there are 0 allowed spaces then render it as invite only instead
      checked: joinRule === _partials.JoinRule.Restricted && !!(restrictedAllowRoomIds !== null && restrictedAllowRoomIds !== void 0 && restrictedAllowRoomIds.length)
    });
  }

  const onChange = async joinRule => {
    const beforeJoinRule = content.join_rule;
    let restrictedAllowRoomIds;

    if (joinRule === _partials.JoinRule.Restricted) {
      if (beforeJoinRule === _partials.JoinRule.Restricted || roomSupportsRestricted) {
        // Have the user pick which spaces to allow joins from
        restrictedAllowRoomIds = await editRestrictedRoomIds();
        if (!Array.isArray(restrictedAllowRoomIds)) return;
      } else if (preferredRestrictionVersion) {
        // Block this action on a room upgrade otherwise it'd make their room unjoinable
        const targetVersion = preferredRestrictionVersion;
        let warning;
        const userId = cli.getUserId();
        const unableToUpdateSomeParents = Array.from(_SpaceStore.default.instance.getKnownParents(room.roomId)).some(roomId => {
          var _cli$getRoom;

          return !((_cli$getRoom = cli.getRoom(roomId)) !== null && _cli$getRoom !== void 0 && _cli$getRoom.currentState.maySendStateEvent(_event.EventType.SpaceChild, userId));
        });

        if (unableToUpdateSomeParents) {
          warning = /*#__PURE__*/_react.default.createElement("b", null, (0, _languageHandler._t)("This room is in some spaces you're not an admin of. " + "In those spaces, the old room will still be shown, " + "but people will be prompted to join the new one."));
        }

        _Modal.default.createTrackedDialog('Restricted join rule upgrade', '', _RoomUpgradeWarningDialog.default, {
          roomId: room.roomId,
          targetVersion,
          description: /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, (0, _languageHandler._t)("This upgrade will allow members of selected spaces " + "access to this room without an invite."), warning),
          doUpgrade: async (opts, fn) => {
            const roomId = await (0, _RoomUpgrade.upgradeRoom)(room, targetVersion, opts.invite, true, true, true, progress => {
              const total = 2 + progress.updateSpacesTotal + progress.inviteUsersTotal;

              if (!progress.roomUpgraded) {
                fn((0, _languageHandler._t)("Upgrading room"), 0, total);
              } else if (!progress.roomSynced) {
                fn((0, _languageHandler._t)("Loading new room"), 1, total);
              } else if (progress.inviteUsersProgress < progress.inviteUsersTotal) {
                fn((0, _languageHandler._t)("Sending invites... (%(progress)s out of %(count)s)", {
                  progress: progress.inviteUsersProgress,
                  count: progress.inviteUsersTotal
                }), 2 + progress.inviteUsersProgress, total);
              } else if (progress.updateSpacesProgress < progress.updateSpacesTotal) {
                fn((0, _languageHandler._t)("Updating spaces... (%(progress)s out of %(count)s)", {
                  progress: progress.updateSpacesProgress,
                  count: progress.updateSpacesTotal
                }), 2 + progress.inviteUsersProgress + progress.updateSpacesProgress, total);
              }
            });
            closeSettingsFn(); // switch to the new room in the background

            _dispatcher.default.dispatch({
              action: "view_room",
              room_id: roomId
            }); // open new settings on this tab


            _dispatcher.default.dispatch({
              action: "open_room_settings",
              initial_tab_id: _RoomSettingsDialog.ROOM_SECURITY_TAB
            });
          }
        });

        return;
      } // when setting to 0 allowed rooms/spaces set to invite only instead as per the note


      if (!restrictedAllowRoomIds.length) {
        joinRule = _partials.JoinRule.Invite;
      }
    }

    if (beforeJoinRule === joinRule && !restrictedAllowRoomIds) return;
    if (beforeChange && !(await beforeChange(joinRule))) return;
    const newContent = {
      join_rule: joinRule
    }; // pre-set the accepted spaces with the currently viewed one as per the microcopy

    if (joinRule === _partials.JoinRule.Restricted) {
      newContent.allow = restrictedAllowRoomIds.map(roomId => ({
        "type": _partials.RestrictedAllowType.RoomMembership,
        "room_id": roomId
      }));
    }

    setContent(newContent);
  };

  return /*#__PURE__*/_react.default.createElement(_StyledRadioGroup.default, {
    name: "joinRule",
    value: joinRule,
    onChange: onChange,
    definitions: definitions,
    disabled: disabled,
    className: "mx_JoinRuleSettings_radioButton"
  });
};

var _default = JoinRuleSettings;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3NldHRpbmdzL0pvaW5SdWxlU2V0dGluZ3MudHN4Il0sIm5hbWVzIjpbIkpvaW5SdWxlU2V0dGluZ3MiLCJyb29tIiwicHJvbXB0VXBncmFkZSIsIm9uRXJyb3IiLCJiZWZvcmVDaGFuZ2UiLCJjbG9zZVNldHRpbmdzRm4iLCJjbGkiLCJjbGllbnQiLCJyZXN0cmljdGVkUm9vbUNhcGFiaWxpdGllcyIsIlNwYWNlU3RvcmUiLCJpbnN0YW5jZSIsInJlc3RyaWN0ZWRKb2luUnVsZVN1cHBvcnQiLCJyb29tU3VwcG9ydHNSZXN0cmljdGVkIiwiQXJyYXkiLCJpc0FycmF5Iiwic3VwcG9ydCIsImluY2x1ZGVzIiwiZ2V0VmVyc2lvbiIsInByZWZlcnJlZFJlc3RyaWN0aW9uVmVyc2lvbiIsInByZWZlcnJlZCIsInVuZGVmaW5lZCIsImRpc2FibGVkIiwiY3VycmVudFN0YXRlIiwibWF5Q2xpZW50U2VuZFN0YXRlRXZlbnQiLCJFdmVudFR5cGUiLCJSb29tSm9pblJ1bGVzIiwiY29udGVudCIsInNldENvbnRlbnQiLCJnZXRTdGF0ZUV2ZW50cyIsImdldENvbnRlbnQiLCJzZW5kU3RhdGVFdmVudCIsInJvb21JZCIsImpvaW5fcnVsZSIsImpvaW5SdWxlIiwicmVzdHJpY3RlZEFsbG93Um9vbUlkcyIsIkpvaW5SdWxlIiwiUmVzdHJpY3RlZCIsImFsbG93IiwiZmlsdGVyIiwibyIsInR5cGUiLCJSZXN0cmljdGVkQWxsb3dUeXBlIiwiUm9vbU1lbWJlcnNoaXAiLCJtYXAiLCJyb29tX2lkIiwiZWRpdFJlc3RyaWN0ZWRSb29tSWRzIiwic2VsZWN0ZWQiLCJsZW5ndGgiLCJhY3RpdmVTcGFjZVJvb20iLCJtYXRyaXhDbGllbnQiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJmaW5pc2hlZCIsIk1vZGFsIiwiY3JlYXRlVHJhY2tlZERpYWxvZyIsIk1hbmFnZVJlc3RyaWN0ZWRKb2luUnVsZURpYWxvZyIsInJvb21JZHMiLCJkZWZpbml0aW9ucyIsInZhbHVlIiwiSW52aXRlIiwibGFiZWwiLCJkZXNjcmlwdGlvbiIsImNoZWNrZWQiLCJQdWJsaWMiLCJ1cGdyYWRlUmVxdWlyZWRQaWxsIiwic2hvd25TcGFjZXMiLCJnZXRSb29tIiwiaXNTcGFjZVJvb20iLCJzbGljZSIsIm1vcmVUZXh0IiwiY291bnQiLCJvblJlc3RyaWN0ZWRSb29tSWRzQ2hhbmdlIiwibmV3QWxsb3dSb29tSWRzIiwib25FZGl0UmVzdHJpY3RlZENsaWNrIiwib25DaGFuZ2UiLCJhIiwic3ViIiwibmFtZSIsInNwYWNlTmFtZSIsInNwbGljZSIsImJlZm9yZUpvaW5SdWxlIiwidGFyZ2V0VmVyc2lvbiIsIndhcm5pbmciLCJ1c2VySWQiLCJnZXRVc2VySWQiLCJ1bmFibGVUb1VwZGF0ZVNvbWVQYXJlbnRzIiwiZnJvbSIsImdldEtub3duUGFyZW50cyIsInNvbWUiLCJtYXlTZW5kU3RhdGVFdmVudCIsIlNwYWNlQ2hpbGQiLCJSb29tVXBncmFkZVdhcm5pbmdEaWFsb2ciLCJkb1VwZ3JhZGUiLCJvcHRzIiwiZm4iLCJpbnZpdGUiLCJwcm9ncmVzcyIsInRvdGFsIiwidXBkYXRlU3BhY2VzVG90YWwiLCJpbnZpdGVVc2Vyc1RvdGFsIiwicm9vbVVwZ3JhZGVkIiwicm9vbVN5bmNlZCIsImludml0ZVVzZXJzUHJvZ3Jlc3MiLCJ1cGRhdGVTcGFjZXNQcm9ncmVzcyIsImRpcyIsImRpc3BhdGNoIiwiYWN0aW9uIiwiaW5pdGlhbF90YWJfaWQiLCJST09NX1NFQ1VSSVRZX1RBQiIsIm5ld0NvbnRlbnQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQWdCQTs7QUFDQTs7QUFFQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFsQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FB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bkRtRixTQUF4Rjs7QUFzREE7QUFDSCxPQTVFaUMsQ0E4RWxDOzs7QUFDQSxVQUFJLENBQUMxRSxzQkFBc0IsQ0FBQ2EsTUFBNUIsRUFBb0M7QUFDaENkLFFBQUFBLFFBQVEsR0FBR0UsbUJBQVN3QixNQUFwQjtBQUNIO0FBQ0o7O0FBRUQsUUFBSXFCLGNBQWMsS0FBSy9DLFFBQW5CLElBQStCLENBQUNDLHNCQUFwQyxFQUE0RDtBQUM1RCxRQUFJOUIsWUFBWSxJQUFJLEVBQUUsTUFBTUEsWUFBWSxDQUFDNkIsUUFBRCxDQUFwQixDQUFwQixFQUFxRDtBQUVyRCxVQUFNNEUsVUFBaUMsR0FBRztBQUN0QzdFLE1BQUFBLFNBQVMsRUFBRUM7QUFEMkIsS0FBMUMsQ0EzRjJDLENBK0YzQzs7QUFDQSxRQUFJQSxRQUFRLEtBQUtFLG1CQUFTQyxVQUExQixFQUFzQztBQUNsQ3lFLE1BQUFBLFVBQVUsQ0FBQ3hFLEtBQVgsR0FBbUJILHNCQUFzQixDQUFDUyxHQUF2QixDQUEyQlosTUFBTSxLQUFLO0FBQ3JELGdCQUFRVSw4QkFBb0JDLGNBRHlCO0FBRXJELG1CQUFXWDtBQUYwQyxPQUFMLENBQWpDLENBQW5CO0FBSUg7O0FBRURKLElBQUFBLFVBQVUsQ0FBQ2tGLFVBQUQsQ0FBVjtBQUNILEdBeEdEOztBQTBHQSxzQkFDSSw2QkFBQyx5QkFBRDtBQUNJLElBQUEsSUFBSSxFQUFDLFVBRFQ7QUFFSSxJQUFBLEtBQUssRUFBRTVFLFFBRlg7QUFHSSxJQUFBLFFBQVEsRUFBRXlDLFFBSGQ7QUFJSSxJQUFBLFdBQVcsRUFBRWpCLFdBSmpCO0FBS0ksSUFBQSxRQUFRLEVBQUVwQyxRQUxkO0FBTUksSUFBQSxTQUFTLEVBQUM7QUFOZCxJQURKO0FBVUgsQ0E5UUQ7O2VBZ1JlckIsZ0IiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMjEgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSBcInJlYWN0XCI7XG5pbXBvcnQgeyBJSm9pblJ1bGVFdmVudENvbnRlbnQsIEpvaW5SdWxlLCBSZXN0cmljdGVkQWxsb3dUeXBlIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL0B0eXBlcy9wYXJ0aWFsc1wiO1xuaW1wb3J0IHsgUm9vbSB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvcm9vbVwiO1xuaW1wb3J0IHsgRXZlbnRUeXBlIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL0B0eXBlcy9ldmVudFwiO1xuXG5pbXBvcnQgU3R5bGVkUmFkaW9Hcm91cCwgeyBJRGVmaW5pdGlvbiB9IGZyb20gXCIuLi9lbGVtZW50cy9TdHlsZWRSYWRpb0dyb3VwXCI7XG5pbXBvcnQgeyBfdCB9IGZyb20gXCIuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXJcIjtcbmltcG9ydCBBY2Nlc3NpYmxlQnV0dG9uIGZyb20gXCIuLi9lbGVtZW50cy9BY2Nlc3NpYmxlQnV0dG9uXCI7XG5pbXBvcnQgUm9vbUF2YXRhciBmcm9tIFwiLi4vYXZhdGFycy9Sb29tQXZhdGFyXCI7XG5pbXBvcnQgU3BhY2VTdG9yZSBmcm9tIFwiLi4vLi4vLi4vc3RvcmVzL3NwYWNlcy9TcGFjZVN0b3JlXCI7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tIFwiLi4vLi4vLi4vTWF0cml4Q2xpZW50UGVnXCI7XG5pbXBvcnQgTW9kYWwgZnJvbSBcIi4uLy4uLy4uL01vZGFsXCI7XG5pbXBvcnQgTWFuYWdlUmVzdHJpY3RlZEpvaW5SdWxlRGlhbG9nIGZyb20gXCIuLi9kaWFsb2dzL01hbmFnZVJlc3RyaWN0ZWRKb2luUnVsZURpYWxvZ1wiO1xuaW1wb3J0IFJvb21VcGdyYWRlV2FybmluZ0RpYWxvZywgeyBJRmluaXNoZWRPcHRzIH0gZnJvbSBcIi4uL2RpYWxvZ3MvUm9vbVVwZ3JhZGVXYXJuaW5nRGlhbG9nXCI7XG5pbXBvcnQgeyB1cGdyYWRlUm9vbSB9IGZyb20gXCIuLi8uLi8uLi91dGlscy9Sb29tVXBncmFkZVwiO1xuaW1wb3J0IHsgYXJyYXlIYXNEaWZmIH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL2FycmF5c1wiO1xuaW1wb3J0IHsgdXNlTG9jYWxFY2hvIH0gZnJvbSBcIi4uLy4uLy4uL2hvb2tzL3VzZUxvY2FsRWNob1wiO1xuaW1wb3J0IGRpcyBmcm9tIFwiLi4vLi4vLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyXCI7XG5pbXBvcnQgeyBST09NX1NFQ1VSSVRZX1RBQiB9IGZyb20gXCIuLi9kaWFsb2dzL1Jvb21TZXR0aW5nc0RpYWxvZ1wiO1xuXG5pbnRlcmZhY2UgSVByb3BzIHtcbiAgICByb29tOiBSb29tO1xuICAgIHByb21wdFVwZ3JhZGU/OiBib29sZWFuO1xuICAgIGNsb3NlU2V0dGluZ3NGbigpOiB2b2lkO1xuICAgIG9uRXJyb3IoZXJyb3I6IEVycm9yKTogdm9pZDtcbiAgICBiZWZvcmVDaGFuZ2U/KGpvaW5SdWxlOiBKb2luUnVsZSk6IFByb21pc2U8Ym9vbGVhbj47IC8vIGlmIHJldHVybnMgZmFsc2UgdGhlbiBhYm9ydHMgdGhlIGNoYW5nZVxufVxuXG5jb25zdCBKb2luUnVsZVNldHRpbmdzID0gKHsgcm9vbSwgcHJvbXB0VXBncmFkZSwgb25FcnJvciwgYmVmb3JlQ2hhbmdlLCBjbG9zZVNldHRpbmdzRm4gfTogSVByb3BzKSA9PiB7XG4gICAgY29uc3QgY2xpID0gcm9vbS5jbGllbnQ7XG5cbiAgICBjb25zdCByZXN0cmljdGVkUm9vbUNhcGFiaWxpdGllcyA9IFNwYWNlU3RvcmUuaW5zdGFuY2UucmVzdHJpY3RlZEpvaW5SdWxlU3VwcG9ydDtcbiAgICBjb25zdCByb29tU3VwcG9ydHNSZXN0cmljdGVkID0gQXJyYXkuaXNBcnJheShyZXN0cmljdGVkUm9vbUNhcGFiaWxpdGllcz8uc3VwcG9ydClcbiAgICAgICAgJiYgcmVzdHJpY3RlZFJvb21DYXBhYmlsaXRpZXMuc3VwcG9ydC5pbmNsdWRlcyhyb29tLmdldFZlcnNpb24oKSk7XG4gICAgY29uc3QgcHJlZmVycmVkUmVzdHJpY3Rpb25WZXJzaW9uID0gIXJvb21TdXBwb3J0c1Jlc3RyaWN0ZWQgJiYgcHJvbXB0VXBncmFkZVxuICAgICAgICA/IHJlc3RyaWN0ZWRSb29tQ2FwYWJpbGl0aWVzPy5wcmVmZXJyZWRcbiAgICAgICAgOiB1bmRlZmluZWQ7XG5cbiAgICBjb25zdCBkaXNhYmxlZCA9ICFyb29tLmN1cnJlbnRTdGF0ZS5tYXlDbGllbnRTZW5kU3RhdGVFdmVudChFdmVudFR5cGUuUm9vbUpvaW5SdWxlcywgY2xpKTtcblxuICAgIGNvbnN0IFtjb250ZW50LCBzZXRDb250ZW50XSA9IHVzZUxvY2FsRWNobzxJSm9pblJ1bGVFdmVudENvbnRlbnQ+KFxuICAgICAgICAoKSA9PiByb29tLmN1cnJlbnRTdGF0ZS5nZXRTdGF0ZUV2ZW50cyhFdmVudFR5cGUuUm9vbUpvaW5SdWxlcywgXCJcIik/LmdldENvbnRlbnQoKSxcbiAgICAgICAgY29udGVudCA9PiBjbGkuc2VuZFN0YXRlRXZlbnQocm9vbS5yb29tSWQsIEV2ZW50VHlwZS5Sb29tSm9pblJ1bGVzLCBjb250ZW50LCBcIlwiKSxcbiAgICAgICAgb25FcnJvcixcbiAgICApO1xuXG4gICAgY29uc3QgeyBqb2luX3J1bGU6IGpvaW5SdWxlIH0gPSBjb250ZW50O1xuICAgIGNvbnN0IHJlc3RyaWN0ZWRBbGxvd1Jvb21JZHMgPSBqb2luUnVsZSA9PT0gSm9pblJ1bGUuUmVzdHJpY3RlZFxuICAgICAgICA/IGNvbnRlbnQuYWxsb3cuZmlsdGVyKG8gPT4gby50eXBlID09PSBSZXN0cmljdGVkQWxsb3dUeXBlLlJvb21NZW1iZXJzaGlwKS5tYXAobyA9PiBvLnJvb21faWQpXG4gICAgICAgIDogdW5kZWZpbmVkO1xuXG4gICAgY29uc3QgZWRpdFJlc3RyaWN0ZWRSb29tSWRzID0gYXN5bmMgKCk6IFByb21pc2U8c3RyaW5nW10gfCB1bmRlZmluZWQ+ID0+IHtcbiAgICAgICAgbGV0IHNlbGVjdGVkID0gcmVzdHJpY3RlZEFsbG93Um9vbUlkcztcbiAgICAgICAgaWYgKCFzZWxlY3RlZD8ubGVuZ3RoICYmIFNwYWNlU3RvcmUuaW5zdGFuY2UuYWN0aXZlU3BhY2VSb29tKSB7XG4gICAgICAgICAgICBzZWxlY3RlZCA9IFtTcGFjZVN0b3JlLmluc3RhbmNlLmFjdGl2ZVNwYWNlUm9vbS5yb29tSWRdO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgbWF0cml4Q2xpZW50ID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuICAgICAgICBjb25zdCB7IGZpbmlzaGVkIH0gPSBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nKCdFZGl0IHJlc3RyaWN0ZWQnLCAnJywgTWFuYWdlUmVzdHJpY3RlZEpvaW5SdWxlRGlhbG9nLCB7XG4gICAgICAgICAgICBtYXRyaXhDbGllbnQsXG4gICAgICAgICAgICByb29tLFxuICAgICAgICAgICAgc2VsZWN0ZWQsXG4gICAgICAgIH0sIFwibXhfTWFuYWdlUmVzdHJpY3RlZEpvaW5SdWxlRGlhbG9nX3dyYXBwZXJcIik7XG5cbiAgICAgICAgY29uc3QgW3Jvb21JZHNdID0gYXdhaXQgZmluaXNoZWQ7XG4gICAgICAgIHJldHVybiByb29tSWRzO1xuICAgIH07XG5cbiAgICBjb25zdCBkZWZpbml0aW9uczogSURlZmluaXRpb248Sm9pblJ1bGU+W10gPSBbe1xuICAgICAgICB2YWx1ZTogSm9pblJ1bGUuSW52aXRlLFxuICAgICAgICBsYWJlbDogX3QoXCJQcml2YXRlIChpbnZpdGUgb25seSlcIiksXG4gICAgICAgIGRlc2NyaXB0aW9uOiBfdChcIk9ubHkgaW52aXRlZCBwZW9wbGUgY2FuIGpvaW4uXCIpLFxuICAgICAgICBjaGVja2VkOiBqb2luUnVsZSA9PT0gSm9pblJ1bGUuSW52aXRlIHx8IChqb2luUnVsZSA9PT0gSm9pblJ1bGUuUmVzdHJpY3RlZCAmJiAhcmVzdHJpY3RlZEFsbG93Um9vbUlkcz8ubGVuZ3RoKSxcbiAgICB9LCB7XG4gICAgICAgIHZhbHVlOiBKb2luUnVsZS5QdWJsaWMsXG4gICAgICAgIGxhYmVsOiBfdChcIlB1YmxpY1wiKSxcbiAgICAgICAgZGVzY3JpcHRpb246IF90KFwiQW55b25lIGNhbiBmaW5kIGFuZCBqb2luLlwiKSxcbiAgICB9XTtcblxuICAgIGlmIChyb29tU3VwcG9ydHNSZXN0cmljdGVkIHx8IHByZWZlcnJlZFJlc3RyaWN0aW9uVmVyc2lvbiB8fCBqb2luUnVsZSA9PT0gSm9pblJ1bGUuUmVzdHJpY3RlZCkge1xuICAgICAgICBsZXQgdXBncmFkZVJlcXVpcmVkUGlsbDtcbiAgICAgICAgaWYgKHByZWZlcnJlZFJlc3RyaWN0aW9uVmVyc2lvbikge1xuICAgICAgICAgICAgdXBncmFkZVJlcXVpcmVkUGlsbCA9IDxzcGFuIGNsYXNzTmFtZT1cIm14X0pvaW5SdWxlU2V0dGluZ3NfdXBncmFkZVJlcXVpcmVkXCI+XG4gICAgICAgICAgICAgICAgeyBfdChcIlVwZ3JhZGUgcmVxdWlyZWRcIikgfVxuICAgICAgICAgICAgPC9zcGFuPjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBkZXNjcmlwdGlvbjtcbiAgICAgICAgaWYgKGpvaW5SdWxlID09PSBKb2luUnVsZS5SZXN0cmljdGVkICYmIHJlc3RyaWN0ZWRBbGxvd1Jvb21JZHM/Lmxlbmd0aCkge1xuICAgICAgICAgICAgLy8gb25seSBzaG93IHRoZSBmaXJzdCA0IHNwYWNlcyB3ZSBrbm93IGFib3V0LCBzbyB0aGF0IHRoZSBVSSBkb2Vzbid0IGdyb3cgb3V0IG9mIHByb3BvcnRpb24gdGhlcmUgYXJlIGxvdHMuXG4gICAgICAgICAgICBjb25zdCBzaG93blNwYWNlcyA9IHJlc3RyaWN0ZWRBbGxvd1Jvb21JZHNcbiAgICAgICAgICAgICAgICAubWFwKHJvb21JZCA9PiBjbGkuZ2V0Um9vbShyb29tSWQpKVxuICAgICAgICAgICAgICAgIC5maWx0ZXIocm9vbSA9PiByb29tPy5pc1NwYWNlUm9vbSgpKVxuICAgICAgICAgICAgICAgIC5zbGljZSgwLCA0KTtcblxuICAgICAgICAgICAgbGV0IG1vcmVUZXh0O1xuICAgICAgICAgICAgaWYgKHNob3duU3BhY2VzLmxlbmd0aCA8IHJlc3RyaWN0ZWRBbGxvd1Jvb21JZHMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgaWYgKHNob3duU3BhY2VzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgbW9yZVRleHQgPSBfdChcIiYgJShjb3VudClzIG1vcmVcIiwge1xuICAgICAgICAgICAgICAgICAgICAgICAgY291bnQ6IHJlc3RyaWN0ZWRBbGxvd1Jvb21JZHMubGVuZ3RoIC0gc2hvd25TcGFjZXMubGVuZ3RoLFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBtb3JlVGV4dCA9IF90KFwiQ3VycmVudGx5LCAlKGNvdW50KXMgc3BhY2VzIGhhdmUgYWNjZXNzXCIsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50OiByZXN0cmljdGVkQWxsb3dSb29tSWRzLmxlbmd0aCxcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBvblJlc3RyaWN0ZWRSb29tSWRzQ2hhbmdlID0gKG5ld0FsbG93Um9vbUlkczogc3RyaW5nW10pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIWFycmF5SGFzRGlmZihyZXN0cmljdGVkQWxsb3dSb29tSWRzIHx8IFtdLCBuZXdBbGxvd1Jvb21JZHMpKSByZXR1cm47XG5cbiAgICAgICAgICAgICAgICBpZiAoIW5ld0FsbG93Um9vbUlkcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgc2V0Q29udGVudCh7XG4gICAgICAgICAgICAgICAgICAgICAgICBqb2luX3J1bGU6IEpvaW5SdWxlLkludml0ZSxcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBzZXRDb250ZW50KHtcbiAgICAgICAgICAgICAgICAgICAgam9pbl9ydWxlOiBKb2luUnVsZS5SZXN0cmljdGVkLFxuICAgICAgICAgICAgICAgICAgICBhbGxvdzogbmV3QWxsb3dSb29tSWRzLm1hcChyb29tSWQgPT4gKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwidHlwZVwiOiBSZXN0cmljdGVkQWxsb3dUeXBlLlJvb21NZW1iZXJzaGlwLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJyb29tX2lkXCI6IHJvb21JZCxcbiAgICAgICAgICAgICAgICAgICAgfSkpLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgY29uc3Qgb25FZGl0UmVzdHJpY3RlZENsaWNrID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3RyaWN0ZWRBbGxvd1Jvb21JZHMgPSBhd2FpdCBlZGl0UmVzdHJpY3RlZFJvb21JZHMoKTtcbiAgICAgICAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkocmVzdHJpY3RlZEFsbG93Um9vbUlkcykpIHJldHVybjtcbiAgICAgICAgICAgICAgICBpZiAocmVzdHJpY3RlZEFsbG93Um9vbUlkcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIG9uUmVzdHJpY3RlZFJvb21JZHNDaGFuZ2UocmVzdHJpY3RlZEFsbG93Um9vbUlkcyk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2UoSm9pblJ1bGUuSW52aXRlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBkZXNjcmlwdGlvbiA9IDxkaXY+XG4gICAgICAgICAgICAgICAgPHNwYW4+XG4gICAgICAgICAgICAgICAgICAgIHsgX3QoXCJBbnlvbmUgaW4gYSBzcGFjZSBjYW4gZmluZCBhbmQgam9pbi4gPGE+RWRpdCB3aGljaCBzcGFjZXMgY2FuIGFjY2VzcyBoZXJlLjwvYT5cIiwge30sIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGE6IHN1YiA9PiA8QWNjZXNzaWJsZUJ1dHRvblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVkPXtkaXNhYmxlZH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXtvbkVkaXRSZXN0cmljdGVkQ2xpY2t9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAga2luZD1cImxpbmtcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X0pvaW5SdWxlU2V0dGluZ3NfbGlua0J1dHRvblwiXG4gICAgICAgICAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBzdWIgfVxuICAgICAgICAgICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPixcbiAgICAgICAgICAgICAgICAgICAgfSkgfVxuICAgICAgICAgICAgICAgIDwvc3Bhbj5cblxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfSm9pblJ1bGVTZXR0aW5nc19zcGFjZXNXaXRoQWNjZXNzXCI+XG4gICAgICAgICAgICAgICAgICAgIDxoND57IF90KFwiU3BhY2VzIHdpdGggYWNjZXNzXCIpIH08L2g0PlxuICAgICAgICAgICAgICAgICAgICB7IHNob3duU3BhY2VzLm1hcChyb29tID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiA8c3BhbiBrZXk9e3Jvb20ucm9vbUlkfT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8Um9vbUF2YXRhciByb29tPXtyb29tfSBoZWlnaHQ9ezMyfSB3aWR0aD17MzJ9IC8+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeyByb29tLm5hbWUgfVxuICAgICAgICAgICAgICAgICAgICAgICAgPC9zcGFuPjtcbiAgICAgICAgICAgICAgICAgICAgfSkgfVxuICAgICAgICAgICAgICAgICAgICB7IG1vcmVUZXh0ICYmIDxzcGFuPnsgbW9yZVRleHQgfTwvc3Bhbj4gfVxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgPC9kaXY+O1xuICAgICAgICB9IGVsc2UgaWYgKFNwYWNlU3RvcmUuaW5zdGFuY2UuYWN0aXZlU3BhY2VSb29tKSB7XG4gICAgICAgICAgICBkZXNjcmlwdGlvbiA9IF90KFwiQW55b25lIGluIDxzcGFjZU5hbWUvPiBjYW4gZmluZCBhbmQgam9pbi4gWW91IGNhbiBzZWxlY3Qgb3RoZXIgc3BhY2VzIHRvby5cIiwge30sIHtcbiAgICAgICAgICAgICAgICBzcGFjZU5hbWU6ICgpID0+IDxiPnsgU3BhY2VTdG9yZS5pbnN0YW5jZS5hY3RpdmVTcGFjZVJvb20ubmFtZSB9PC9iPixcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZGVzY3JpcHRpb24gPSBfdChcIkFueW9uZSBpbiBhIHNwYWNlIGNhbiBmaW5kIGFuZCBqb2luLiBZb3UgY2FuIHNlbGVjdCBtdWx0aXBsZSBzcGFjZXMuXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgZGVmaW5pdGlvbnMuc3BsaWNlKDEsIDAsIHtcbiAgICAgICAgICAgIHZhbHVlOiBKb2luUnVsZS5SZXN0cmljdGVkLFxuICAgICAgICAgICAgbGFiZWw6IDw+XG4gICAgICAgICAgICAgICAgeyBfdChcIlNwYWNlIG1lbWJlcnNcIikgfVxuICAgICAgICAgICAgICAgIHsgdXBncmFkZVJlcXVpcmVkUGlsbCB9XG4gICAgICAgICAgICA8Lz4sXG4gICAgICAgICAgICBkZXNjcmlwdGlvbixcbiAgICAgICAgICAgIC8vIGlmIHRoZXJlIGFyZSAwIGFsbG93ZWQgc3BhY2VzIHRoZW4gcmVuZGVyIGl0IGFzIGludml0ZSBvbmx5IGluc3RlYWRcbiAgICAgICAgICAgIGNoZWNrZWQ6IGpvaW5SdWxlID09PSBKb2luUnVsZS5SZXN0cmljdGVkICYmICEhcmVzdHJpY3RlZEFsbG93Um9vbUlkcz8ubGVuZ3RoLFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBvbkNoYW5nZSA9IGFzeW5jIChqb2luUnVsZTogSm9pblJ1bGUpID0+IHtcbiAgICAgICAgY29uc3QgYmVmb3JlSm9pblJ1bGUgPSBjb250ZW50LmpvaW5fcnVsZTtcblxuICAgICAgICBsZXQgcmVzdHJpY3RlZEFsbG93Um9vbUlkczogc3RyaW5nW107XG4gICAgICAgIGlmIChqb2luUnVsZSA9PT0gSm9pblJ1bGUuUmVzdHJpY3RlZCkge1xuICAgICAgICAgICAgaWYgKGJlZm9yZUpvaW5SdWxlID09PSBKb2luUnVsZS5SZXN0cmljdGVkIHx8IHJvb21TdXBwb3J0c1Jlc3RyaWN0ZWQpIHtcbiAgICAgICAgICAgICAgICAvLyBIYXZlIHRoZSB1c2VyIHBpY2sgd2hpY2ggc3BhY2VzIHRvIGFsbG93IGpvaW5zIGZyb21cbiAgICAgICAgICAgICAgICByZXN0cmljdGVkQWxsb3dSb29tSWRzID0gYXdhaXQgZWRpdFJlc3RyaWN0ZWRSb29tSWRzKCk7XG4gICAgICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHJlc3RyaWN0ZWRBbGxvd1Jvb21JZHMpKSByZXR1cm47XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHByZWZlcnJlZFJlc3RyaWN0aW9uVmVyc2lvbikge1xuICAgICAgICAgICAgICAgIC8vIEJsb2NrIHRoaXMgYWN0aW9uIG9uIGEgcm9vbSB1cGdyYWRlIG90aGVyd2lzZSBpdCdkIG1ha2UgdGhlaXIgcm9vbSB1bmpvaW5hYmxlXG4gICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0VmVyc2lvbiA9IHByZWZlcnJlZFJlc3RyaWN0aW9uVmVyc2lvbjtcblxuICAgICAgICAgICAgICAgIGxldCB3YXJuaW5nOiBKU1guRWxlbWVudDtcbiAgICAgICAgICAgICAgICBjb25zdCB1c2VySWQgPSBjbGkuZ2V0VXNlcklkKCk7XG4gICAgICAgICAgICAgICAgY29uc3QgdW5hYmxlVG9VcGRhdGVTb21lUGFyZW50cyA9IEFycmF5LmZyb20oU3BhY2VTdG9yZS5pbnN0YW5jZS5nZXRLbm93blBhcmVudHMocm9vbS5yb29tSWQpKVxuICAgICAgICAgICAgICAgICAgICAuc29tZShyb29tSWQgPT4gIWNsaS5nZXRSb29tKHJvb21JZCk/LmN1cnJlbnRTdGF0ZS5tYXlTZW5kU3RhdGVFdmVudChFdmVudFR5cGUuU3BhY2VDaGlsZCwgdXNlcklkKSk7XG4gICAgICAgICAgICAgICAgaWYgKHVuYWJsZVRvVXBkYXRlU29tZVBhcmVudHMpIHtcbiAgICAgICAgICAgICAgICAgICAgd2FybmluZyA9IDxiPlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIlRoaXMgcm9vbSBpcyBpbiBzb21lIHNwYWNlcyB5b3UncmUgbm90IGFuIGFkbWluIG9mLiBcIiArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJJbiB0aG9zZSBzcGFjZXMsIHRoZSBvbGQgcm9vbSB3aWxsIHN0aWxsIGJlIHNob3duLCBcIiArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJidXQgcGVvcGxlIHdpbGwgYmUgcHJvbXB0ZWQgdG8gam9pbiB0aGUgbmV3IG9uZS5cIikgfVxuICAgICAgICAgICAgICAgICAgICA8L2I+O1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coJ1Jlc3RyaWN0ZWQgam9pbiBydWxlIHVwZ3JhZGUnLCAnJywgUm9vbVVwZ3JhZGVXYXJuaW5nRGlhbG9nLCB7XG4gICAgICAgICAgICAgICAgICAgIHJvb21JZDogcm9vbS5yb29tSWQsXG4gICAgICAgICAgICAgICAgICAgIHRhcmdldFZlcnNpb24sXG4gICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiA8PlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIlRoaXMgdXBncmFkZSB3aWxsIGFsbG93IG1lbWJlcnMgb2Ygc2VsZWN0ZWQgc3BhY2VzIFwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcImFjY2VzcyB0byB0aGlzIHJvb20gd2l0aG91dCBhbiBpbnZpdGUuXCIpIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgd2FybmluZyB9XG4gICAgICAgICAgICAgICAgICAgIDwvPixcbiAgICAgICAgICAgICAgICAgICAgZG9VcGdyYWRlOiBhc3luYyAoXG4gICAgICAgICAgICAgICAgICAgICAgICBvcHRzOiBJRmluaXNoZWRPcHRzLFxuICAgICAgICAgICAgICAgICAgICAgICAgZm46IChwcm9ncmVzc1RleHQ6IHN0cmluZywgcHJvZ3Jlc3M6IG51bWJlciwgdG90YWw6IG51bWJlcikgPT4gdm9pZCxcbiAgICAgICAgICAgICAgICAgICAgKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByb29tSWQgPSBhd2FpdCB1cGdyYWRlUm9vbShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByb29tLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFZlcnNpb24sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0cy5pbnZpdGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3MgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0b3RhbCA9IDIgKyBwcm9ncmVzcy51cGRhdGVTcGFjZXNUb3RhbCArIHByb2dyZXNzLmludml0ZVVzZXJzVG90YWw7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcHJvZ3Jlc3Mucm9vbVVwZ3JhZGVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbihfdChcIlVwZ3JhZGluZyByb29tXCIpLCAwLCB0b3RhbCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXByb2dyZXNzLnJvb21TeW5jZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuKF90KFwiTG9hZGluZyBuZXcgcm9vbVwiKSwgMSwgdG90YWwpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHByb2dyZXNzLmludml0ZVVzZXJzUHJvZ3Jlc3MgPCBwcm9ncmVzcy5pbnZpdGVVc2Vyc1RvdGFsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbihfdChcIlNlbmRpbmcgaW52aXRlcy4uLiAoJShwcm9ncmVzcylzIG91dCBvZiAlKGNvdW50KXMpXCIsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9ncmVzczogcHJvZ3Jlc3MuaW52aXRlVXNlcnNQcm9ncmVzcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3VudDogcHJvZ3Jlc3MuaW52aXRlVXNlcnNUb3RhbCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLCAyICsgcHJvZ3Jlc3MuaW52aXRlVXNlcnNQcm9ncmVzcywgdG90YWwpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHByb2dyZXNzLnVwZGF0ZVNwYWNlc1Byb2dyZXNzIDwgcHJvZ3Jlc3MudXBkYXRlU3BhY2VzVG90YWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuKF90KFwiVXBkYXRpbmcgc3BhY2VzLi4uICglKHByb2dyZXNzKXMgb3V0IG9mICUoY291bnQpcylcIiwge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2dyZXNzOiBwcm9ncmVzcy51cGRhdGVTcGFjZXNQcm9ncmVzcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3VudDogcHJvZ3Jlc3MudXBkYXRlU3BhY2VzVG90YWwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSwgMiArIHByb2dyZXNzLmludml0ZVVzZXJzUHJvZ3Jlc3MgKyBwcm9ncmVzcy51cGRhdGVTcGFjZXNQcm9ncmVzcywgdG90YWwpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjbG9zZVNldHRpbmdzRm4oKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3dpdGNoIHRvIHRoZSBuZXcgcm9vbSBpbiB0aGUgYmFja2dyb3VuZFxuICAgICAgICAgICAgICAgICAgICAgICAgZGlzLmRpc3BhdGNoKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb246IFwidmlld19yb29tXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcm9vbV9pZDogcm9vbUlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG9wZW4gbmV3IHNldHRpbmdzIG9uIHRoaXMgdGFiXG4gICAgICAgICAgICAgICAgICAgICAgICBkaXMuZGlzcGF0Y2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbjogXCJvcGVuX3Jvb21fc2V0dGluZ3NcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbml0aWFsX3RhYl9pZDogUk9PTV9TRUNVUklUWV9UQUIsXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gd2hlbiBzZXR0aW5nIHRvIDAgYWxsb3dlZCByb29tcy9zcGFjZXMgc2V0IHRvIGludml0ZSBvbmx5IGluc3RlYWQgYXMgcGVyIHRoZSBub3RlXG4gICAgICAgICAgICBpZiAoIXJlc3RyaWN0ZWRBbGxvd1Jvb21JZHMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgam9pblJ1bGUgPSBKb2luUnVsZS5JbnZpdGU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYmVmb3JlSm9pblJ1bGUgPT09IGpvaW5SdWxlICYmICFyZXN0cmljdGVkQWxsb3dSb29tSWRzKSByZXR1cm47XG4gICAgICAgIGlmIChiZWZvcmVDaGFuZ2UgJiYgIShhd2FpdCBiZWZvcmVDaGFuZ2Uoam9pblJ1bGUpKSkgcmV0dXJuO1xuXG4gICAgICAgIGNvbnN0IG5ld0NvbnRlbnQ6IElKb2luUnVsZUV2ZW50Q29udGVudCA9IHtcbiAgICAgICAgICAgIGpvaW5fcnVsZTogam9pblJ1bGUsXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gcHJlLXNldCB0aGUgYWNjZXB0ZWQgc3BhY2VzIHdpdGggdGhlIGN1cnJlbnRseSB2aWV3ZWQgb25lIGFzIHBlciB0aGUgbWljcm9jb3B5XG4gICAgICAgIGlmIChqb2luUnVsZSA9PT0gSm9pblJ1bGUuUmVzdHJpY3RlZCkge1xuICAgICAgICAgICAgbmV3Q29udGVudC5hbGxvdyA9IHJlc3RyaWN0ZWRBbGxvd1Jvb21JZHMubWFwKHJvb21JZCA9PiAoe1xuICAgICAgICAgICAgICAgIFwidHlwZVwiOiBSZXN0cmljdGVkQWxsb3dUeXBlLlJvb21NZW1iZXJzaGlwLFxuICAgICAgICAgICAgICAgIFwicm9vbV9pZFwiOiByb29tSWQsXG4gICAgICAgICAgICB9KSk7XG4gICAgICAgIH1cblxuICAgICAgICBzZXRDb250ZW50KG5ld0NvbnRlbnQpO1xuICAgIH07XG5cbiAgICByZXR1cm4gKFxuICAgICAgICA8U3R5bGVkUmFkaW9Hcm91cFxuICAgICAgICAgICAgbmFtZT1cImpvaW5SdWxlXCJcbiAgICAgICAgICAgIHZhbHVlPXtqb2luUnVsZX1cbiAgICAgICAgICAgIG9uQ2hhbmdlPXtvbkNoYW5nZX1cbiAgICAgICAgICAgIGRlZmluaXRpb25zPXtkZWZpbml0aW9uc31cbiAgICAgICAgICAgIGRpc2FibGVkPXtkaXNhYmxlZH1cbiAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X0pvaW5SdWxlU2V0dGluZ3NfcmFkaW9CdXR0b25cIlxuICAgICAgICAvPlxuICAgICk7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBKb2luUnVsZVNldHRpbmdzO1xuIl19