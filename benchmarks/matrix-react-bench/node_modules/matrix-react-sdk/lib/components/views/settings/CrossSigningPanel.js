"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _languageHandler = require("../../../languageHandler");

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _Spinner = _interopRequireDefault(require("../elements/Spinner"));

var _InteractiveAuthDialog = _interopRequireDefault(require("../dialogs/InteractiveAuthDialog"));

var _ConfirmDestroyCrossSigningDialog = _interopRequireDefault(require("../dialogs/security/ConfirmDestroyCrossSigningDialog"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _SetupEncryptionDialog = _interopRequireDefault(require("../dialogs/security/SetupEncryptionDialog"));

var _SecurityManager = require("../../../SecurityManager");

var _logger = require("matrix-js-sdk/src/logger");

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _dec, _class;

let CrossSigningPanel = (_dec = (0, _replaceableComponent.replaceableComponent)("views.settings.CrossSigningPanel"), _dec(_class = class CrossSigningPanel extends _react.default.PureComponent {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "unmounted", false);
    (0, _defineProperty2.default)(this, "onAccountData", event => {
      const type = event.getType();

      if (type.startsWith("m.cross_signing") || type.startsWith("m.secret_storage")) {
        this.getUpdatedStatus();
      }
    });
    (0, _defineProperty2.default)(this, "onBootstrapClick", () => {
      if (this.state.crossSigningPrivateKeysInStorage) {
        _Modal.default.createTrackedDialog("Verify session", "Verify session", _SetupEncryptionDialog.default, {}, null,
        /* priority = */
        false,
        /* static = */
        true);
      } else {
        // Trigger the flow to set up secure backup, which is what this will do when in
        // the appropriate state.
        (0, _SecurityManager.accessSecretStorage)();
      }
    });
    (0, _defineProperty2.default)(this, "onStatusChanged", () => {
      this.getUpdatedStatus();
    });
    (0, _defineProperty2.default)(this, "bootstrapCrossSigning", async ({
      forceReset = false
    }) => {
      this.setState({
        error: undefined
      });

      try {
        const cli = _MatrixClientPeg.MatrixClientPeg.get();

        await cli.bootstrapCrossSigning({
          authUploadDeviceSigningKeys: async makeRequest => {
            const {
              finished
            } = _Modal.default.createTrackedDialog('Cross-signing keys dialog', '', _InteractiveAuthDialog.default, {
              title: (0, _languageHandler._t)("Setting up keys"),
              matrixClient: cli,
              makeRequest
            });

            const [confirmed] = await finished;

            if (!confirmed) {
              throw new Error("Cross-signing key upload auth canceled");
            }
          },
          setupNewCrossSigning: forceReset
        });
      } catch (e) {
        this.setState({
          error: e
        });

        _logger.logger.error("Error bootstrapping cross-signing", e);
      }

      if (this.unmounted) return;
      this.getUpdatedStatus();
    });
    (0, _defineProperty2.default)(this, "resetCrossSigning", () => {
      _Modal.default.createDialog(_ConfirmDestroyCrossSigningDialog.default, {
        onFinished: act => {
          if (!act) return;
          this.bootstrapCrossSigning({
            forceReset: true
          });
        }
      });
    });
    this.state = {};
  }

  componentDidMount() {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    cli.on("accountData", this.onAccountData);
    cli.on("userTrustStatusChanged", this.onStatusChanged);
    cli.on("crossSigning.keysChanged", this.onStatusChanged);
    this.getUpdatedStatus();
  }

  componentWillUnmount() {
    this.unmounted = true;

    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    if (!cli) return;
    cli.removeListener("accountData", this.onAccountData);
    cli.removeListener("userTrustStatusChanged", this.onStatusChanged);
    cli.removeListener("crossSigning.keysChanged", this.onStatusChanged);
  }

  async getUpdatedStatus() {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    const pkCache = cli.getCrossSigningCacheCallbacks();
    const crossSigning = cli.crypto.crossSigningInfo;
    const secretStorage = cli.crypto.secretStorage;
    const crossSigningPublicKeysOnDevice = Boolean(crossSigning.getId());
    const crossSigningPrivateKeysInStorage = Boolean(await crossSigning.isStoredInSecretStorage(secretStorage));
    const masterPrivateKeyCached = !!(pkCache && (await pkCache.getCrossSigningKeyCache("master")));
    const selfSigningPrivateKeyCached = !!(pkCache && (await pkCache.getCrossSigningKeyCache("self_signing")));
    const userSigningPrivateKeyCached = !!(pkCache && (await pkCache.getCrossSigningKeyCache("user_signing")));
    const homeserverSupportsCrossSigning = await cli.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing");
    const crossSigningReady = await cli.isCrossSigningReady();
    this.setState({
      crossSigningPublicKeysOnDevice,
      crossSigningPrivateKeysInStorage,
      masterPrivateKeyCached,
      selfSigningPrivateKeyCached,
      userSigningPrivateKeyCached,
      homeserverSupportsCrossSigning,
      crossSigningReady
    });
  }
  /**
   * Bootstrapping cross-signing take one of these paths:
   * 1. Create cross-signing keys locally and store in secret storage (if it
   *    already exists on the account).
   * 2. Access existing secret storage by requesting passphrase and accessing
   *    cross-signing keys as needed.
   * 3. All keys are loaded and there's nothing to do.
   * @param {bool} [forceReset] Bootstrap again even if keys already present
   */


  render() {
    const {
      error,
      crossSigningPublicKeysOnDevice,
      crossSigningPrivateKeysInStorage,
      masterPrivateKeyCached,
      selfSigningPrivateKeyCached,
      userSigningPrivateKeyCached,
      homeserverSupportsCrossSigning,
      crossSigningReady
    } = this.state;
    let errorSection;

    if (error) {
      errorSection = /*#__PURE__*/_react.default.createElement("div", {
        className: "error"
      }, error.toString());
    }

    let summarisedStatus;

    if (homeserverSupportsCrossSigning === undefined) {
      summarisedStatus = /*#__PURE__*/_react.default.createElement(_Spinner.default, null);
    } else if (!homeserverSupportsCrossSigning) {
      summarisedStatus = /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Your homeserver does not support cross-signing."));
    } else if (crossSigningReady && crossSigningPrivateKeysInStorage) {
      summarisedStatus = /*#__PURE__*/_react.default.createElement("p", null, "\u2705 ", (0, _languageHandler._t)("Cross-signing is ready for use."));
    } else if (crossSigningReady && !crossSigningPrivateKeysInStorage) {
      summarisedStatus = /*#__PURE__*/_react.default.createElement("p", null, "\u26A0\uFE0F ", (0, _languageHandler._t)("Cross-signing is ready but keys are not backed up."));
    } else if (crossSigningPrivateKeysInStorage) {
      summarisedStatus = /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Your account has a cross-signing identity in secret storage, " + "but it is not yet trusted by this session."));
    } else {
      summarisedStatus = /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Cross-signing is not set up."));
    }

    const keysExistAnywhere = crossSigningPublicKeysOnDevice || crossSigningPrivateKeysInStorage || masterPrivateKeyCached || selfSigningPrivateKeyCached || userSigningPrivateKeyCached;
    const keysExistEverywhere = crossSigningPublicKeysOnDevice && crossSigningPrivateKeysInStorage && masterPrivateKeyCached && selfSigningPrivateKeyCached && userSigningPrivateKeyCached;
    const actions = []; // TODO: determine how better to expose this to users in addition to prompts at login/toast

    if (!keysExistEverywhere && homeserverSupportsCrossSigning) {
      let buttonCaption = (0, _languageHandler._t)("Set up Secure Backup");

      if (crossSigningPrivateKeysInStorage) {
        buttonCaption = (0, _languageHandler._t)("Verify this session");
      }

      actions.push( /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        key: "setup",
        kind: "primary",
        onClick: this.onBootstrapClick
      }, buttonCaption));
    }

    if (keysExistAnywhere) {
      actions.push( /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        key: "reset",
        kind: "danger",
        onClick: this.resetCrossSigning
      }, (0, _languageHandler._t)("Reset")));
    }

    let actionRow;

    if (actions.length) {
      actionRow = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_CrossSigningPanel_buttonRow"
      }, actions);
    }

    return /*#__PURE__*/_react.default.createElement("div", null, summarisedStatus, /*#__PURE__*/_react.default.createElement("details", null, /*#__PURE__*/_react.default.createElement("summary", null, (0, _languageHandler._t)("Advanced")), /*#__PURE__*/_react.default.createElement("table", {
      className: "mx_CrossSigningPanel_statusList"
    }, /*#__PURE__*/_react.default.createElement("tbody", null, /*#__PURE__*/_react.default.createElement("tr", null, /*#__PURE__*/_react.default.createElement("td", null, (0, _languageHandler._t)("Cross-signing public keys:")), /*#__PURE__*/_react.default.createElement("td", null, crossSigningPublicKeysOnDevice ? (0, _languageHandler._t)("in memory") : (0, _languageHandler._t)("not found"))), /*#__PURE__*/_react.default.createElement("tr", null, /*#__PURE__*/_react.default.createElement("td", null, (0, _languageHandler._t)("Cross-signing private keys:")), /*#__PURE__*/_react.default.createElement("td", null, crossSigningPrivateKeysInStorage ? (0, _languageHandler._t)("in secret storage") : (0, _languageHandler._t)("not found in storage"))), /*#__PURE__*/_react.default.createElement("tr", null, /*#__PURE__*/_react.default.createElement("td", null, (0, _languageHandler._t)("Master private key:")), /*#__PURE__*/_react.default.createElement("td", null, masterPrivateKeyCached ? (0, _languageHandler._t)("cached locally") : (0, _languageHandler._t)("not found locally"))), /*#__PURE__*/_react.default.createElement("tr", null, /*#__PURE__*/_react.default.createElement("td", null, (0, _languageHandler._t)("Self signing private key:")), /*#__PURE__*/_react.default.createElement("td", null, selfSigningPrivateKeyCached ? (0, _languageHandler._t)("cached locally") : (0, _languageHandler._t)("not found locally"))), /*#__PURE__*/_react.default.createElement("tr", null, /*#__PURE__*/_react.default.createElement("td", null, (0, _languageHandler._t)("User signing private key:")), /*#__PURE__*/_react.default.createElement("td", null, userSigningPrivateKeyCached ? (0, _languageHandler._t)("cached locally") : (0, _languageHandler._t)("not found locally"))), /*#__PURE__*/_react.default.createElement("tr", null, /*#__PURE__*/_react.default.createElement("td", null, (0, _languageHandler._t)("Homeserver feature support:")), /*#__PURE__*/_react.default.createElement("td", null, homeserverSupportsCrossSigning ? (0, _languageHandler._t)("exists") : (0, _languageHandler._t)("not found")))))), errorSection, actionRow);
  }

}) || _class);
exports.default = CrossSigningPanel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3NldHRpbmdzL0Nyb3NzU2lnbmluZ1BhbmVsLnRzeCJdLCJuYW1lcyI6WyJDcm9zc1NpZ25pbmdQYW5lbCIsIlJlYWN0IiwiUHVyZUNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJldmVudCIsInR5cGUiLCJnZXRUeXBlIiwic3RhcnRzV2l0aCIsImdldFVwZGF0ZWRTdGF0dXMiLCJzdGF0ZSIsImNyb3NzU2lnbmluZ1ByaXZhdGVLZXlzSW5TdG9yYWdlIiwiTW9kYWwiLCJjcmVhdGVUcmFja2VkRGlhbG9nIiwiU2V0dXBFbmNyeXB0aW9uRGlhbG9nIiwiZm9yY2VSZXNldCIsInNldFN0YXRlIiwiZXJyb3IiLCJ1bmRlZmluZWQiLCJjbGkiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJib290c3RyYXBDcm9zc1NpZ25pbmciLCJhdXRoVXBsb2FkRGV2aWNlU2lnbmluZ0tleXMiLCJtYWtlUmVxdWVzdCIsImZpbmlzaGVkIiwiSW50ZXJhY3RpdmVBdXRoRGlhbG9nIiwidGl0bGUiLCJtYXRyaXhDbGllbnQiLCJjb25maXJtZWQiLCJFcnJvciIsInNldHVwTmV3Q3Jvc3NTaWduaW5nIiwiZSIsImxvZ2dlciIsInVubW91bnRlZCIsImNyZWF0ZURpYWxvZyIsIkNvbmZpcm1EZXN0cm95Q3Jvc3NTaWduaW5nRGlhbG9nIiwib25GaW5pc2hlZCIsImFjdCIsImNvbXBvbmVudERpZE1vdW50Iiwib24iLCJvbkFjY291bnREYXRhIiwib25TdGF0dXNDaGFuZ2VkIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJyZW1vdmVMaXN0ZW5lciIsInBrQ2FjaGUiLCJnZXRDcm9zc1NpZ25pbmdDYWNoZUNhbGxiYWNrcyIsImNyb3NzU2lnbmluZyIsImNyeXB0byIsImNyb3NzU2lnbmluZ0luZm8iLCJzZWNyZXRTdG9yYWdlIiwiY3Jvc3NTaWduaW5nUHVibGljS2V5c09uRGV2aWNlIiwiQm9vbGVhbiIsImdldElkIiwiaXNTdG9yZWRJblNlY3JldFN0b3JhZ2UiLCJtYXN0ZXJQcml2YXRlS2V5Q2FjaGVkIiwiZ2V0Q3Jvc3NTaWduaW5nS2V5Q2FjaGUiLCJzZWxmU2lnbmluZ1ByaXZhdGVLZXlDYWNoZWQiLCJ1c2VyU2lnbmluZ1ByaXZhdGVLZXlDYWNoZWQiLCJob21lc2VydmVyU3VwcG9ydHNDcm9zc1NpZ25pbmciLCJkb2VzU2VydmVyU3VwcG9ydFVuc3RhYmxlRmVhdHVyZSIsImNyb3NzU2lnbmluZ1JlYWR5IiwiaXNDcm9zc1NpZ25pbmdSZWFkeSIsInJlbmRlciIsImVycm9yU2VjdGlvbiIsInRvU3RyaW5nIiwic3VtbWFyaXNlZFN0YXR1cyIsImtleXNFeGlzdEFueXdoZXJlIiwia2V5c0V4aXN0RXZlcnl3aGVyZSIsImFjdGlvbnMiLCJidXR0b25DYXB0aW9uIiwicHVzaCIsIm9uQm9vdHN0cmFwQ2xpY2siLCJyZXNldENyb3NzU2lnbmluZyIsImFjdGlvblJvdyIsImxlbmd0aCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFnQkE7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBRUE7O0FBQ0E7Ozs7SUFjcUJBLGlCLFdBRHBCLGdEQUFxQixrQ0FBckIsQyxnQkFBRCxNQUNxQkEsaUJBRHJCLFNBQytDQyxlQUFNQyxhQURyRCxDQUMrRTtBQUczRUMsRUFBQUEsV0FBVyxDQUFDQyxLQUFELEVBQVE7QUFDZixVQUFNQSxLQUFOO0FBRGUscURBRkMsS0FFRDtBQUFBLHlEQXVCTUMsS0FBRCxJQUE4QjtBQUNsRCxZQUFNQyxJQUFJLEdBQUdELEtBQUssQ0FBQ0UsT0FBTixFQUFiOztBQUNBLFVBQUlELElBQUksQ0FBQ0UsVUFBTCxDQUFnQixpQkFBaEIsS0FBc0NGLElBQUksQ0FBQ0UsVUFBTCxDQUFnQixrQkFBaEIsQ0FBMUMsRUFBK0U7QUFDM0UsYUFBS0MsZ0JBQUw7QUFDSDtBQUNKLEtBNUJrQjtBQUFBLDREQThCUSxNQUFNO0FBQzdC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TVUsU0FoQ04sQ0FESjtBQW9DSDs7QUF0UDBFLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTksIDIwMjAgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuXG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tICcuLi8uLi8uLi9NYXRyaXhDbGllbnRQZWcnO1xuaW1wb3J0IHsgX3QgfSBmcm9tICcuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXInO1xuaW1wb3J0IE1vZGFsIGZyb20gJy4uLy4uLy4uL01vZGFsJztcbmltcG9ydCBTcGlubmVyIGZyb20gJy4uL2VsZW1lbnRzL1NwaW5uZXInO1xuaW1wb3J0IEludGVyYWN0aXZlQXV0aERpYWxvZyBmcm9tICcuLi9kaWFsb2dzL0ludGVyYWN0aXZlQXV0aERpYWxvZyc7XG5pbXBvcnQgQ29uZmlybURlc3Ryb3lDcm9zc1NpZ25pbmdEaWFsb2cgZnJvbSAnLi4vZGlhbG9ncy9zZWN1cml0eS9Db25maXJtRGVzdHJveUNyb3NzU2lnbmluZ0RpYWxvZyc7XG5pbXBvcnQgeyByZXBsYWNlYWJsZUNvbXBvbmVudCB9IGZyb20gXCIuLi8uLi8uLi91dGlscy9yZXBsYWNlYWJsZUNvbXBvbmVudFwiO1xuaW1wb3J0IHsgTWF0cml4RXZlbnQgfSBmcm9tICdtYXRyaXgtanMtc2RrL3NyYyc7XG5pbXBvcnQgU2V0dXBFbmNyeXB0aW9uRGlhbG9nIGZyb20gJy4uL2RpYWxvZ3Mvc2VjdXJpdHkvU2V0dXBFbmNyeXB0aW9uRGlhbG9nJztcbmltcG9ydCB7IGFjY2Vzc1NlY3JldFN0b3JhZ2UgfSBmcm9tICcuLi8uLi8uLi9TZWN1cml0eU1hbmFnZXInO1xuXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbG9nZ2VyXCI7XG5pbXBvcnQgQWNjZXNzaWJsZUJ1dHRvbiBmcm9tIFwiLi4vZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvblwiO1xuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBlcnJvcj86IEVycm9yO1xuICAgIGNyb3NzU2lnbmluZ1B1YmxpY0tleXNPbkRldmljZT86IGJvb2xlYW47XG4gICAgY3Jvc3NTaWduaW5nUHJpdmF0ZUtleXNJblN0b3JhZ2U/OiBib29sZWFuO1xuICAgIG1hc3RlclByaXZhdGVLZXlDYWNoZWQ/OiBib29sZWFuO1xuICAgIHNlbGZTaWduaW5nUHJpdmF0ZUtleUNhY2hlZD86IGJvb2xlYW47XG4gICAgdXNlclNpZ25pbmdQcml2YXRlS2V5Q2FjaGVkPzogYm9vbGVhbjtcbiAgICBob21lc2VydmVyU3VwcG9ydHNDcm9zc1NpZ25pbmc/OiBib29sZWFuO1xuICAgIGNyb3NzU2lnbmluZ1JlYWR5PzogYm9vbGVhbjtcbn1cblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3Muc2V0dGluZ3MuQ3Jvc3NTaWduaW5nUGFuZWxcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIENyb3NzU2lnbmluZ1BhbmVsIGV4dGVuZHMgUmVhY3QuUHVyZUNvbXBvbmVudDx7fSwgSVN0YXRlPiB7XG4gICAgcHJpdmF0ZSB1bm1vdW50ZWQgPSBmYWxzZTtcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcblxuICAgICAgICB0aGlzLnN0YXRlID0ge307XG4gICAgfVxuXG4gICAgcHVibGljIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgICAgICBjb25zdCBjbGkgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIGNsaS5vbihcImFjY291bnREYXRhXCIsIHRoaXMub25BY2NvdW50RGF0YSk7XG4gICAgICAgIGNsaS5vbihcInVzZXJUcnVzdFN0YXR1c0NoYW5nZWRcIiwgdGhpcy5vblN0YXR1c0NoYW5nZWQpO1xuICAgICAgICBjbGkub24oXCJjcm9zc1NpZ25pbmcua2V5c0NoYW5nZWRcIiwgdGhpcy5vblN0YXR1c0NoYW5nZWQpO1xuICAgICAgICB0aGlzLmdldFVwZGF0ZWRTdGF0dXMoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgICAgIHRoaXMudW5tb3VudGVkID0gdHJ1ZTtcbiAgICAgICAgY29uc3QgY2xpID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuICAgICAgICBpZiAoIWNsaSkgcmV0dXJuO1xuICAgICAgICBjbGkucmVtb3ZlTGlzdGVuZXIoXCJhY2NvdW50RGF0YVwiLCB0aGlzLm9uQWNjb3VudERhdGEpO1xuICAgICAgICBjbGkucmVtb3ZlTGlzdGVuZXIoXCJ1c2VyVHJ1c3RTdGF0dXNDaGFuZ2VkXCIsIHRoaXMub25TdGF0dXNDaGFuZ2VkKTtcbiAgICAgICAgY2xpLnJlbW92ZUxpc3RlbmVyKFwiY3Jvc3NTaWduaW5nLmtleXNDaGFuZ2VkXCIsIHRoaXMub25TdGF0dXNDaGFuZ2VkKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uQWNjb3VudERhdGEgPSAoZXZlbnQ6IE1hdHJpeEV2ZW50KTogdm9pZCA9PiB7XG4gICAgICAgIGNvbnN0IHR5cGUgPSBldmVudC5nZXRUeXBlKCk7XG4gICAgICAgIGlmICh0eXBlLnN0YXJ0c1dpdGgoXCJtLmNyb3NzX3NpZ25pbmdcIikgfHwgdHlwZS5zdGFydHNXaXRoKFwibS5zZWNyZXRfc3RvcmFnZVwiKSkge1xuICAgICAgICAgICAgdGhpcy5nZXRVcGRhdGVkU3RhdHVzKCk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkJvb3RzdHJhcENsaWNrID0gKCkgPT4ge1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5jcm9zc1NpZ25pbmdQcml2YXRlS2V5c0luU3RvcmFnZSkge1xuICAgICAgICAgICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZyhcbiAgICAgICAgICAgICAgICBcIlZlcmlmeSBzZXNzaW9uXCIsIFwiVmVyaWZ5IHNlc3Npb25cIiwgU2V0dXBFbmNyeXB0aW9uRGlhbG9nLFxuICAgICAgICAgICAgICAgIHt9LCBudWxsLCAvKiBwcmlvcml0eSA9ICovIGZhbHNlLCAvKiBzdGF0aWMgPSAqLyB0cnVlLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIFRyaWdnZXIgdGhlIGZsb3cgdG8gc2V0IHVwIHNlY3VyZSBiYWNrdXAsIHdoaWNoIGlzIHdoYXQgdGhpcyB3aWxsIGRvIHdoZW4gaW5cbiAgICAgICAgICAgIC8vIHRoZSBhcHByb3ByaWF0ZSBzdGF0ZS5cbiAgICAgICAgICAgIGFjY2Vzc1NlY3JldFN0b3JhZ2UoKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwcml2YXRlIG9uU3RhdHVzQ2hhbmdlZCA9ICgpID0+IHtcbiAgICAgICAgdGhpcy5nZXRVcGRhdGVkU3RhdHVzKCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgYXN5bmMgZ2V0VXBkYXRlZFN0YXR1cygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgY29uc3QgY2xpID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuICAgICAgICBjb25zdCBwa0NhY2hlID0gY2xpLmdldENyb3NzU2lnbmluZ0NhY2hlQ2FsbGJhY2tzKCk7XG4gICAgICAgIGNvbnN0IGNyb3NzU2lnbmluZyA9IGNsaS5jcnlwdG8uY3Jvc3NTaWduaW5nSW5mbztcbiAgICAgICAgY29uc3Qgc2VjcmV0U3RvcmFnZSA9IGNsaS5jcnlwdG8uc2VjcmV0U3RvcmFnZTtcbiAgICAgICAgY29uc3QgY3Jvc3NTaWduaW5nUHVibGljS2V5c09uRGV2aWNlID0gQm9vbGVhbihjcm9zc1NpZ25pbmcuZ2V0SWQoKSk7XG4gICAgICAgIGNvbnN0IGNyb3NzU2lnbmluZ1ByaXZhdGVLZXlzSW5TdG9yYWdlID0gQm9vbGVhbihhd2FpdCBjcm9zc1NpZ25pbmcuaXNTdG9yZWRJblNlY3JldFN0b3JhZ2Uoc2VjcmV0U3RvcmFnZSkpO1xuICAgICAgICBjb25zdCBtYXN0ZXJQcml2YXRlS2V5Q2FjaGVkID0gISEocGtDYWNoZSAmJiAoYXdhaXQgcGtDYWNoZS5nZXRDcm9zc1NpZ25pbmdLZXlDYWNoZShcIm1hc3RlclwiKSkpO1xuICAgICAgICBjb25zdCBzZWxmU2lnbmluZ1ByaXZhdGVLZXlDYWNoZWQgPSAhIShwa0NhY2hlICYmIChhd2FpdCBwa0NhY2hlLmdldENyb3NzU2lnbmluZ0tleUNhY2hlKFwic2VsZl9zaWduaW5nXCIpKSk7XG4gICAgICAgIGNvbnN0IHVzZXJTaWduaW5nUHJpdmF0ZUtleUNhY2hlZCA9ICEhKHBrQ2FjaGUgJiYgKGF3YWl0IHBrQ2FjaGUuZ2V0Q3Jvc3NTaWduaW5nS2V5Q2FjaGUoXCJ1c2VyX3NpZ25pbmdcIikpKTtcbiAgICAgICAgY29uc3QgaG9tZXNlcnZlclN1cHBvcnRzQ3Jvc3NTaWduaW5nID1cbiAgICAgICAgICAgIGF3YWl0IGNsaS5kb2VzU2VydmVyU3VwcG9ydFVuc3RhYmxlRmVhdHVyZShcIm9yZy5tYXRyaXguZTJlX2Nyb3NzX3NpZ25pbmdcIik7XG4gICAgICAgIGNvbnN0IGNyb3NzU2lnbmluZ1JlYWR5ID0gYXdhaXQgY2xpLmlzQ3Jvc3NTaWduaW5nUmVhZHkoKTtcblxuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIGNyb3NzU2lnbmluZ1B1YmxpY0tleXNPbkRldmljZSxcbiAgICAgICAgICAgIGNyb3NzU2lnbmluZ1ByaXZhdGVLZXlzSW5TdG9yYWdlLFxuICAgICAgICAgICAgbWFzdGVyUHJpdmF0ZUtleUNhY2hlZCxcbiAgICAgICAgICAgIHNlbGZTaWduaW5nUHJpdmF0ZUtleUNhY2hlZCxcbiAgICAgICAgICAgIHVzZXJTaWduaW5nUHJpdmF0ZUtleUNhY2hlZCxcbiAgICAgICAgICAgIGhvbWVzZXJ2ZXJTdXBwb3J0c0Nyb3NzU2lnbmluZyxcbiAgICAgICAgICAgIGNyb3NzU2lnbmluZ1JlYWR5LFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBCb290c3RyYXBwaW5nIGNyb3NzLXNpZ25pbmcgdGFrZSBvbmUgb2YgdGhlc2UgcGF0aHM6XG4gICAgICogMS4gQ3JlYXRlIGNyb3NzLXNpZ25pbmcga2V5cyBsb2NhbGx5IGFuZCBzdG9yZSBpbiBzZWNyZXQgc3RvcmFnZSAoaWYgaXRcbiAgICAgKiAgICBhbHJlYWR5IGV4aXN0cyBvbiB0aGUgYWNjb3VudCkuXG4gICAgICogMi4gQWNjZXNzIGV4aXN0aW5nIHNlY3JldCBzdG9yYWdlIGJ5IHJlcXVlc3RpbmcgcGFzc3BocmFzZSBhbmQgYWNjZXNzaW5nXG4gICAgICogICAgY3Jvc3Mtc2lnbmluZyBrZXlzIGFzIG5lZWRlZC5cbiAgICAgKiAzLiBBbGwga2V5cyBhcmUgbG9hZGVkIGFuZCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uXG4gICAgICogQHBhcmFtIHtib29sfSBbZm9yY2VSZXNldF0gQm9vdHN0cmFwIGFnYWluIGV2ZW4gaWYga2V5cyBhbHJlYWR5IHByZXNlbnRcbiAgICAgKi9cbiAgICBwcml2YXRlIGJvb3RzdHJhcENyb3NzU2lnbmluZyA9IGFzeW5jICh7IGZvcmNlUmVzZXQgPSBmYWxzZSB9KTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBlcnJvcjogdW5kZWZpbmVkIH0pO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgY2xpID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuICAgICAgICAgICAgYXdhaXQgY2xpLmJvb3RzdHJhcENyb3NzU2lnbmluZyh7XG4gICAgICAgICAgICAgICAgYXV0aFVwbG9hZERldmljZVNpZ25pbmdLZXlzOiBhc3luYyAobWFrZVJlcXVlc3QpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgeyBmaW5pc2hlZCB9ID0gTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZyhcbiAgICAgICAgICAgICAgICAgICAgICAgICdDcm9zcy1zaWduaW5nIGtleXMgZGlhbG9nJywgJycsIEludGVyYWN0aXZlQXV0aERpYWxvZyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogX3QoXCJTZXR0aW5nIHVwIGtleXNcIiksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0cml4Q2xpZW50OiBjbGksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFrZVJlcXVlc3QsXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBbY29uZmlybWVkXSA9IGF3YWl0IGZpbmlzaGVkO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbmZpcm1lZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ3Jvc3Mtc2lnbmluZyBrZXkgdXBsb2FkIGF1dGggY2FuY2VsZWRcIik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHNldHVwTmV3Q3Jvc3NTaWduaW5nOiBmb3JjZVJlc2V0LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBlcnJvcjogZSB9KTtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihcIkVycm9yIGJvb3RzdHJhcHBpbmcgY3Jvc3Mtc2lnbmluZ1wiLCBlKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy51bm1vdW50ZWQpIHJldHVybjtcbiAgICAgICAgdGhpcy5nZXRVcGRhdGVkU3RhdHVzKCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgcmVzZXRDcm9zc1NpZ25pbmcgPSAoKTogdm9pZCA9PiB7XG4gICAgICAgIE1vZGFsLmNyZWF0ZURpYWxvZyhDb25maXJtRGVzdHJveUNyb3NzU2lnbmluZ0RpYWxvZywge1xuICAgICAgICAgICAgb25GaW5pc2hlZDogKGFjdCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICghYWN0KSByZXR1cm47XG4gICAgICAgICAgICAgICAgdGhpcy5ib290c3RyYXBDcm9zc1NpZ25pbmcoeyBmb3JjZVJlc2V0OiB0cnVlIH0pO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHB1YmxpYyByZW5kZXIoKSB7XG4gICAgICAgIGNvbnN0IHtcbiAgICAgICAgICAgIGVycm9yLFxuICAgICAgICAgICAgY3Jvc3NTaWduaW5nUHVibGljS2V5c09uRGV2aWNlLFxuICAgICAgICAgICAgY3Jvc3NTaWduaW5nUHJpdmF0ZUtleXNJblN0b3JhZ2UsXG4gICAgICAgICAgICBtYXN0ZXJQcml2YXRlS2V5Q2FjaGVkLFxuICAgICAgICAgICAgc2VsZlNpZ25pbmdQcml2YXRlS2V5Q2FjaGVkLFxuICAgICAgICAgICAgdXNlclNpZ25pbmdQcml2YXRlS2V5Q2FjaGVkLFxuICAgICAgICAgICAgaG9tZXNlcnZlclN1cHBvcnRzQ3Jvc3NTaWduaW5nLFxuICAgICAgICAgICAgY3Jvc3NTaWduaW5nUmVhZHksXG4gICAgICAgIH0gPSB0aGlzLnN0YXRlO1xuXG4gICAgICAgIGxldCBlcnJvclNlY3Rpb247XG4gICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgICAgZXJyb3JTZWN0aW9uID0gPGRpdiBjbGFzc05hbWU9XCJlcnJvclwiPnsgZXJyb3IudG9TdHJpbmcoKSB9PC9kaXY+O1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHN1bW1hcmlzZWRTdGF0dXM7XG4gICAgICAgIGlmIChob21lc2VydmVyU3VwcG9ydHNDcm9zc1NpZ25pbmcgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgc3VtbWFyaXNlZFN0YXR1cyA9IDxTcGlubmVyIC8+O1xuICAgICAgICB9IGVsc2UgaWYgKCFob21lc2VydmVyU3VwcG9ydHNDcm9zc1NpZ25pbmcpIHtcbiAgICAgICAgICAgIHN1bW1hcmlzZWRTdGF0dXMgPSA8cD57IF90KFxuICAgICAgICAgICAgICAgIFwiWW91ciBob21lc2VydmVyIGRvZXMgbm90IHN1cHBvcnQgY3Jvc3Mtc2lnbmluZy5cIixcbiAgICAgICAgICAgICkgfTwvcD47XG4gICAgICAgIH0gZWxzZSBpZiAoY3Jvc3NTaWduaW5nUmVhZHkgJiYgY3Jvc3NTaWduaW5nUHJpdmF0ZUtleXNJblN0b3JhZ2UpIHtcbiAgICAgICAgICAgIHN1bW1hcmlzZWRTdGF0dXMgPSA8cD7inIUgeyBfdChcbiAgICAgICAgICAgICAgICBcIkNyb3NzLXNpZ25pbmcgaXMgcmVhZHkgZm9yIHVzZS5cIixcbiAgICAgICAgICAgICkgfTwvcD47XG4gICAgICAgIH0gZWxzZSBpZiAoY3Jvc3NTaWduaW5nUmVhZHkgJiYgIWNyb3NzU2lnbmluZ1ByaXZhdGVLZXlzSW5TdG9yYWdlKSB7XG4gICAgICAgICAgICBzdW1tYXJpc2VkU3RhdHVzID0gPHA+4pqg77iPIHsgX3QoXG4gICAgICAgICAgICAgICAgXCJDcm9zcy1zaWduaW5nIGlzIHJlYWR5IGJ1dCBrZXlzIGFyZSBub3QgYmFja2VkIHVwLlwiLFxuICAgICAgICAgICAgKSB9PC9wPjtcbiAgICAgICAgfSBlbHNlIGlmIChjcm9zc1NpZ25pbmdQcml2YXRlS2V5c0luU3RvcmFnZSkge1xuICAgICAgICAgICAgc3VtbWFyaXNlZFN0YXR1cyA9IDxwPnsgX3QoXG4gICAgICAgICAgICAgICAgXCJZb3VyIGFjY291bnQgaGFzIGEgY3Jvc3Mtc2lnbmluZyBpZGVudGl0eSBpbiBzZWNyZXQgc3RvcmFnZSwgXCIgK1xuICAgICAgICAgICAgICAgIFwiYnV0IGl0IGlzIG5vdCB5ZXQgdHJ1c3RlZCBieSB0aGlzIHNlc3Npb24uXCIsXG4gICAgICAgICAgICApIH08L3A+O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3VtbWFyaXNlZFN0YXR1cyA9IDxwPnsgX3QoXG4gICAgICAgICAgICAgICAgXCJDcm9zcy1zaWduaW5nIGlzIG5vdCBzZXQgdXAuXCIsXG4gICAgICAgICAgICApIH08L3A+O1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qga2V5c0V4aXN0QW55d2hlcmUgPSAoXG4gICAgICAgICAgICBjcm9zc1NpZ25pbmdQdWJsaWNLZXlzT25EZXZpY2UgfHxcbiAgICAgICAgICAgIGNyb3NzU2lnbmluZ1ByaXZhdGVLZXlzSW5TdG9yYWdlIHx8XG4gICAgICAgICAgICBtYXN0ZXJQcml2YXRlS2V5Q2FjaGVkIHx8XG4gICAgICAgICAgICBzZWxmU2lnbmluZ1ByaXZhdGVLZXlDYWNoZWQgfHxcbiAgICAgICAgICAgIHVzZXJTaWduaW5nUHJpdmF0ZUtleUNhY2hlZFxuICAgICAgICApO1xuICAgICAgICBjb25zdCBrZXlzRXhpc3RFdmVyeXdoZXJlID0gKFxuICAgICAgICAgICAgY3Jvc3NTaWduaW5nUHVibGljS2V5c09uRGV2aWNlICYmXG4gICAgICAgICAgICBjcm9zc1NpZ25pbmdQcml2YXRlS2V5c0luU3RvcmFnZSAmJlxuICAgICAgICAgICAgbWFzdGVyUHJpdmF0ZUtleUNhY2hlZCAmJlxuICAgICAgICAgICAgc2VsZlNpZ25pbmdQcml2YXRlS2V5Q2FjaGVkICYmXG4gICAgICAgICAgICB1c2VyU2lnbmluZ1ByaXZhdGVLZXlDYWNoZWRcbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCBhY3Rpb25zID0gW107XG5cbiAgICAgICAgLy8gVE9ETzogZGV0ZXJtaW5lIGhvdyBiZXR0ZXIgdG8gZXhwb3NlIHRoaXMgdG8gdXNlcnMgaW4gYWRkaXRpb24gdG8gcHJvbXB0cyBhdCBsb2dpbi90b2FzdFxuICAgICAgICBpZiAoIWtleXNFeGlzdEV2ZXJ5d2hlcmUgJiYgaG9tZXNlcnZlclN1cHBvcnRzQ3Jvc3NTaWduaW5nKSB7XG4gICAgICAgICAgICBsZXQgYnV0dG9uQ2FwdGlvbiA9IF90KFwiU2V0IHVwIFNlY3VyZSBCYWNrdXBcIik7XG4gICAgICAgICAgICBpZiAoY3Jvc3NTaWduaW5nUHJpdmF0ZUtleXNJblN0b3JhZ2UpIHtcbiAgICAgICAgICAgICAgICBidXR0b25DYXB0aW9uID0gX3QoXCJWZXJpZnkgdGhpcyBzZXNzaW9uXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYWN0aW9ucy5wdXNoKFxuICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uIGtleT1cInNldHVwXCIga2luZD1cInByaW1hcnlcIiBvbkNsaWNrPXt0aGlzLm9uQm9vdHN0cmFwQ2xpY2t9PlxuICAgICAgICAgICAgICAgICAgICB7IGJ1dHRvbkNhcHRpb24gfVxuICAgICAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj4sXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGtleXNFeGlzdEFueXdoZXJlKSB7XG4gICAgICAgICAgICBhY3Rpb25zLnB1c2goXG4gICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b24ga2V5PVwicmVzZXRcIiBraW5kPVwiZGFuZ2VyXCIgb25DbGljaz17dGhpcy5yZXNldENyb3NzU2lnbmluZ30+XG4gICAgICAgICAgICAgICAgICAgIHsgX3QoXCJSZXNldFwiKSB9XG4gICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPixcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgYWN0aW9uUm93O1xuICAgICAgICBpZiAoYWN0aW9ucy5sZW5ndGgpIHtcbiAgICAgICAgICAgIGFjdGlvblJvdyA9IDxkaXYgY2xhc3NOYW1lPVwibXhfQ3Jvc3NTaWduaW5nUGFuZWxfYnV0dG9uUm93XCI+XG4gICAgICAgICAgICAgICAgeyBhY3Rpb25zIH1cbiAgICAgICAgICAgIDwvZGl2PjtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8ZGl2PlxuICAgICAgICAgICAgICAgIHsgc3VtbWFyaXNlZFN0YXR1cyB9XG4gICAgICAgICAgICAgICAgPGRldGFpbHM+XG4gICAgICAgICAgICAgICAgICAgIDxzdW1tYXJ5PnsgX3QoXCJBZHZhbmNlZFwiKSB9PC9zdW1tYXJ5PlxuICAgICAgICAgICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPVwibXhfQ3Jvc3NTaWduaW5nUGFuZWxfc3RhdHVzTGlzdFwiPjx0Ym9keT5cbiAgICAgICAgICAgICAgICAgICAgICAgIDx0cj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+eyBfdChcIkNyb3NzLXNpZ25pbmcgcHVibGljIGtleXM6XCIpIH08L3RkPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57IGNyb3NzU2lnbmluZ1B1YmxpY0tleXNPbkRldmljZSA/IF90KFwiaW4gbWVtb3J5XCIpIDogX3QoXCJub3QgZm91bmRcIikgfTwvdGQ+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L3RyPlxuICAgICAgICAgICAgICAgICAgICAgICAgPHRyPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57IF90KFwiQ3Jvc3Mtc2lnbmluZyBwcml2YXRlIGtleXM6XCIpIH08L3RkPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57IGNyb3NzU2lnbmluZ1ByaXZhdGVLZXlzSW5TdG9yYWdlID8gX3QoXCJpbiBzZWNyZXQgc3RvcmFnZVwiKSA6IF90KFwibm90IGZvdW5kIGluIHN0b3JhZ2VcIikgfTwvdGQ+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L3RyPlxuICAgICAgICAgICAgICAgICAgICAgICAgPHRyPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57IF90KFwiTWFzdGVyIHByaXZhdGUga2V5OlwiKSB9PC90ZD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+eyBtYXN0ZXJQcml2YXRlS2V5Q2FjaGVkID8gX3QoXCJjYWNoZWQgbG9jYWxseVwiKSA6IF90KFwibm90IGZvdW5kIGxvY2FsbHlcIikgfTwvdGQ+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L3RyPlxuICAgICAgICAgICAgICAgICAgICAgICAgPHRyPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57IF90KFwiU2VsZiBzaWduaW5nIHByaXZhdGUga2V5OlwiKSB9PC90ZD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+eyBzZWxmU2lnbmluZ1ByaXZhdGVLZXlDYWNoZWQgPyBfdChcImNhY2hlZCBsb2NhbGx5XCIpIDogX3QoXCJub3QgZm91bmQgbG9jYWxseVwiKSB9PC90ZD5cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvdHI+XG4gICAgICAgICAgICAgICAgICAgICAgICA8dHI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPnsgX3QoXCJVc2VyIHNpZ25pbmcgcHJpdmF0ZSBrZXk6XCIpIH08L3RkPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57IHVzZXJTaWduaW5nUHJpdmF0ZUtleUNhY2hlZCA/IF90KFwiY2FjaGVkIGxvY2FsbHlcIikgOiBfdChcIm5vdCBmb3VuZCBsb2NhbGx5XCIpIH08L3RkPlxuICAgICAgICAgICAgICAgICAgICAgICAgPC90cj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDx0cj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+eyBfdChcIkhvbWVzZXJ2ZXIgZmVhdHVyZSBzdXBwb3J0OlwiKSB9PC90ZD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+eyBob21lc2VydmVyU3VwcG9ydHNDcm9zc1NpZ25pbmcgPyBfdChcImV4aXN0c1wiKSA6IF90KFwibm90IGZvdW5kXCIpIH08L3RkPlxuICAgICAgICAgICAgICAgICAgICAgICAgPC90cj5cbiAgICAgICAgICAgICAgICAgICAgPC90Ym9keT48L3RhYmxlPlxuICAgICAgICAgICAgICAgIDwvZGV0YWlscz5cbiAgICAgICAgICAgICAgICB7IGVycm9yU2VjdGlvbiB9XG4gICAgICAgICAgICAgICAgeyBhY3Rpb25Sb3cgfVxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICk7XG4gICAgfVxufVxuIl19