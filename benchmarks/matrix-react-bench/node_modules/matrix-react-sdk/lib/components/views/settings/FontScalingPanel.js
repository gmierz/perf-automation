"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _EventTilePreview = _interopRequireDefault(require("../elements/EventTilePreview"));

var _Field = _interopRequireDefault(require("../elements/Field"));

var _react = _interopRequireDefault(require("react"));

var _SettingsFlag = _interopRequireDefault(require("../elements/SettingsFlag"));

var _SettingsStore = _interopRequireDefault(require("../../../settings/SettingsStore"));

var _Slider = _interopRequireDefault(require("../elements/Slider"));

var _FontWatcher = require("../../../settings/watchers/FontWatcher");

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _SettingLevel = require("../../../settings/SettingLevel");

var _languageHandler = require("../../../languageHandler");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _dec, _class;

let FontScalingPanel = (_dec = (0, _replaceableComponent.replaceableComponent)("views.settings.tabs.user.FontScalingPanel"), _dec(_class = class FontScalingPanel extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "MESSAGE_PREVIEW_TEXT", (0, _languageHandler._t)("Hey you. You're the best!"));
    (0, _defineProperty2.default)(this, "unmounted", false);
    (0, _defineProperty2.default)(this, "onFontSizeChanged", size => {
      this.setState({
        fontSize: size.toString()
      });

      _SettingsStore.default.setValue("baseFontSize", null, _SettingLevel.SettingLevel.DEVICE, size - _FontWatcher.FontWatcher.SIZE_DIFF);
    });
    (0, _defineProperty2.default)(this, "onValidateFontSize", async ({
      value
    }) => {
      const parsedSize = parseFloat(value);
      const min = _FontWatcher.FontWatcher.MIN_SIZE + _FontWatcher.FontWatcher.SIZE_DIFF;
      const max = _FontWatcher.FontWatcher.MAX_SIZE + _FontWatcher.FontWatcher.SIZE_DIFF;

      if (isNaN(parsedSize)) {
        return {
          valid: false,
          feedback: (0, _languageHandler._t)("Size must be a number")
        };
      }

      if (!(min <= parsedSize && parsedSize <= max)) {
        return {
          valid: false,
          feedback: (0, _languageHandler._t)('Custom font size can only be between %(min)s pt and %(max)s pt', {
            min,
            max
          })
        };
      }

      _SettingsStore.default.setValue("baseFontSize", null, _SettingLevel.SettingLevel.DEVICE, parseInt(value, 10) - _FontWatcher.FontWatcher.SIZE_DIFF);

      return {
        valid: true,
        feedback: (0, _languageHandler._t)('Use between %(min)s pt and %(max)s pt', {
          min,
          max
        })
      };
    });
    this.state = {
      fontSize: (_SettingsStore.default.getValue("baseFontSize", null) + _FontWatcher.FontWatcher.SIZE_DIFF).toString(),
      useCustomFontSize: _SettingsStore.default.getValue("useCustomFontSize"),
      layout: _SettingsStore.default.getValue("layout"),
      userId: null,
      displayName: null,
      avatarUrl: null
    };
  }

  async componentDidMount() {
    // Fetch the current user profile for the message preview
    const client = _MatrixClientPeg.MatrixClientPeg.get();

    const userId = client.getUserId();
    const profileInfo = await client.getProfileInfo(userId);
    if (this.unmounted) return;
    this.setState({
      userId,
      displayName: profileInfo.displayname,
      avatarUrl: profileInfo.avatar_url
    });
  }

  componentWillUnmount() {
    this.unmounted = true;
  }

  render() {
    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_SettingsTab_section mx_FontScalingPanel"
    }, /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_SettingsTab_subheading"
    }, (0, _languageHandler._t)("Font size")), /*#__PURE__*/_react.default.createElement(_EventTilePreview.default, {
      className: "mx_FontScalingPanel_fontSlider_preview",
      message: this.MESSAGE_PREVIEW_TEXT,
      layout: this.state.layout,
      userId: this.state.userId,
      displayName: this.state.displayName,
      avatarUrl: this.state.avatarUrl
    }), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_FontScalingPanel_fontSlider"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_FontScalingPanel_fontSlider_smallText"
    }, "Aa"), /*#__PURE__*/_react.default.createElement(_Slider.default, {
      values: [13, 14, 15, 16, 18],
      value: parseInt(this.state.fontSize, 10),
      onSelectionChange: this.onFontSizeChanged,
      displayFunc: _ => "",
      disabled: this.state.useCustomFontSize
    }), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_FontScalingPanel_fontSlider_largeText"
    }, "Aa")), /*#__PURE__*/_react.default.createElement(_SettingsFlag.default, {
      name: "useCustomFontSize",
      level: _SettingLevel.SettingLevel.ACCOUNT,
      onChange: checked => this.setState({
        useCustomFontSize: checked
      }),
      useCheckbox: true
    }), /*#__PURE__*/_react.default.createElement(_Field.default, {
      type: "number",
      label: (0, _languageHandler._t)("Font size"),
      autoComplete: "off",
      placeholder: this.state.fontSize.toString(),
      value: this.state.fontSize.toString(),
      id: "font_size_field",
      onValidate: this.onValidateFontSize,
      onChange: value => this.setState({
        fontSize: value.target.value
      }),
      disabled: !this.state.useCustomFontSize,
      className: "mx_FontScalingPanel_customFontSizeField"
    }));
  }

}) || _class);
exports.default = FontScalingPanel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3NldHRpbmdzL0ZvbnRTY2FsaW5nUGFuZWwudHN4Il0sIm5hbWVzIjpbIkZvbnRTY2FsaW5nUGFuZWwiLCJSZWFjdCIsIkNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJzaXplIiwic2V0U3RhdGUiLCJmb250U2l6ZSIsInRvU3RyaW5nIiwiU2V0dGluZ3NTdG9yZSIsInNldFZhbHVlIiwiU2V0dGluZ0xldmVsIiwiREVWSUNFIiwiRm9udFdhdGNoZXIiLCJTSVpFX0RJRkYiLCJ2YWx1ZSIsInBhcnNlZFNpemUiLCJwYXJzZUZsb2F0IiwibWluIiwiTUlOX1NJWkUiLCJtYXgiLCJNQVhfU0laRSIsImlzTmFOIiwidmFsaWQiLCJmZWVkYmFjayIsInBhcnNlSW50Iiwic3RhdGUiLCJnZXRWYWx1ZSIsInVzZUN1c3RvbUZvbnRTaXplIiwibGF5b3V0IiwidXNlcklkIiwiZGlzcGxheU5hbWUiLCJhdmF0YXJVcmwiLCJjb21wb25lbnREaWRNb3VudCIsImNsaWVudCIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsImdldFVzZXJJZCIsInByb2ZpbGVJbmZvIiwiZ2V0UHJvZmlsZUluZm8iLCJ1bm1vdW50ZWQiLCJkaXNwbGF5bmFtZSIsImF2YXRhcl91cmwiLCJjb21wb25lbnRXaWxsVW5tb3VudCIsInJlbmRlciIsIk1FU1NBR0VfUFJFVklFV19URVhUIiwib25Gb250U2l6ZUNoYW5nZWQiLCJfIiwiQUNDT1VOVCIsImNoZWNrZWQiLCJvblZhbGlkYXRlRm9udFNpemUiLCJ0YXJnZXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBOztBQUNBOztBQUNBOztBQUNBOzs7O0lBbUJxQkEsZ0IsV0FEcEIsZ0RBQXFCLDJDQUFyQixDLGdCQUFELE1BQ3FCQSxnQkFEckIsU0FDOENDLGVBQU1DLFNBRHBELENBQzhF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QUFBRXNCLFFBQUFBLGlCQUFpQixFQUFFcUI7QUFBckIsT0FBZCxDQUgzQjtBQUlJLE1BQUEsV0FBVyxFQUFFO0FBSmpCLE1BdkJHLGVBOEJILDZCQUFDLGNBQUQ7QUFDSSxNQUFBLElBQUksRUFBQyxRQURUO0FBRUksTUFBQSxLQUFLLEVBQUUseUJBQUcsV0FBSCxDQUZYO0FBR0ksTUFBQSxZQUFZLEVBQUMsS0FIakI7QUFJSSxNQUFBLFdBQVcsRUFBRSxLQUFLdkIsS0FBTCxDQUFXbkIsUUFBWCxDQUFvQkMsUUFBcEIsRUFKakI7QUFLSSxNQUFBLEtBQUssRUFBRSxLQUFLa0IsS0FBTCxDQUFXbkIsUUFBWCxDQUFvQkMsUUFBcEIsRUFMWDtBQU1JLE1BQUEsRUFBRSxFQUFDLGlCQU5QO0FBT0ksTUFBQSxVQUFVLEVBQUUsS0FBSzBDLGtCQVByQjtBQVFJLE1BQUEsUUFBUSxFQUNIbkMsS0FBRCxJQUNJLEtBQUtULFFBQUwsQ0FBYztBQUFFQyxRQUFBQSxRQUFRLEVBQUVRLEtBQUssQ0FBQ29DLE1BQU4sQ0FBYXBDO0FBQXpCLE9BQWQsQ0FWWjtBQVlJLE1BQUEsUUFBUSxFQUFFLENBQUMsS0FBS1csS0FBTCxDQUFXRSxpQkFaMUI7QUFhSSxNQUFBLFNBQVMsRUFBQztBQWJkLE1BOUJHLENBQVA7QUE4Q0g7O0FBbEh5RSxDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDIxIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IEV2ZW50VGlsZVByZXZpZXcgZnJvbSAnLi4vZWxlbWVudHMvRXZlbnRUaWxlUHJldmlldyc7XG5pbXBvcnQgRmllbGQgZnJvbSAnLi4vZWxlbWVudHMvRmllbGQnO1xuaW1wb3J0IFJlYWN0LCB7IENoYW5nZUV2ZW50IH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IFNldHRpbmdzRmxhZyBmcm9tICcuLi9lbGVtZW50cy9TZXR0aW5nc0ZsYWcnO1xuaW1wb3J0IFNldHRpbmdzU3RvcmUgZnJvbSBcIi4uLy4uLy4uL3NldHRpbmdzL1NldHRpbmdzU3RvcmVcIjtcbmltcG9ydCBTbGlkZXIgZnJvbSBcIi4uL2VsZW1lbnRzL1NsaWRlclwiO1xuaW1wb3J0IHsgRm9udFdhdGNoZXIgfSBmcm9tIFwiLi4vLi4vLi4vc2V0dGluZ3Mvd2F0Y2hlcnMvRm9udFdhdGNoZXJcIjtcbmltcG9ydCB7IElWYWxpZGF0aW9uUmVzdWx0LCBJRmllbGRTdGF0ZSB9IGZyb20gJy4uL2VsZW1lbnRzL1ZhbGlkYXRpb24nO1xuaW1wb3J0IHsgTGF5b3V0IH0gZnJvbSBcIi4uLy4uLy4uL3NldHRpbmdzL2VudW1zL0xheW91dFwiO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSAnLi4vLi4vLi4vTWF0cml4Q2xpZW50UGVnJztcbmltcG9ydCB7IFNldHRpbmdMZXZlbCB9IGZyb20gXCIuLi8uLi8uLi9zZXR0aW5ncy9TZXR0aW5nTGV2ZWxcIjtcbmltcG9ydCB7IF90IH0gZnJvbSBcIi4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlclwiO1xuaW1wb3J0IHsgcmVwbGFjZWFibGVDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvcmVwbGFjZWFibGVDb21wb25lbnRcIjtcblxuaW50ZXJmYWNlIElQcm9wcyB7XG59XG5cbmludGVyZmFjZSBJU3RhdGUge1xuICAgIC8vIFN0cmluZyBkaXNwbGF5aW5nIHRoZSBjdXJyZW50IHNlbGVjdGVkIGZvbnRTaXplLlxuICAgIC8vIE5lZWRzIHRvIGJlIHN0cmluZyBmb3IgdGhpbmdzIGxpa2UgJzE3Licgd2l0aG91dFxuICAgIC8vIHRyYWlsaW5nIDBzLlxuICAgIGZvbnRTaXplOiBzdHJpbmc7XG4gICAgdXNlQ3VzdG9tRm9udFNpemU6IGJvb2xlYW47XG4gICAgbGF5b3V0OiBMYXlvdXQ7XG4gICAgLy8gVXNlciBwcm9maWxlIGRhdGEgZm9yIHRoZSBtZXNzYWdlIHByZXZpZXdcbiAgICB1c2VySWQ/OiBzdHJpbmc7XG4gICAgZGlzcGxheU5hbWU6IHN0cmluZztcbiAgICBhdmF0YXJVcmw6IHN0cmluZztcbn1cblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3Muc2V0dGluZ3MudGFicy51c2VyLkZvbnRTY2FsaW5nUGFuZWxcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEZvbnRTY2FsaW5nUGFuZWwgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8SVByb3BzLCBJU3RhdGU+IHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IE1FU1NBR0VfUFJFVklFV19URVhUID0gX3QoXCJIZXkgeW91LiBZb3UncmUgdGhlIGJlc3QhXCIpO1xuXG4gICAgcHJpdmF0ZSB1bm1vdW50ZWQgPSBmYWxzZTtcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBJUHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuXG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICBmb250U2l6ZTogKFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJiYXNlRm9udFNpemVcIiwgbnVsbCkgKyBGb250V2F0Y2hlci5TSVpFX0RJRkYpLnRvU3RyaW5nKCksXG4gICAgICAgICAgICB1c2VDdXN0b21Gb250U2l6ZTogU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcInVzZUN1c3RvbUZvbnRTaXplXCIpLFxuICAgICAgICAgICAgbGF5b3V0OiBTZXR0aW5nc1N0b3JlLmdldFZhbHVlKFwibGF5b3V0XCIpLFxuICAgICAgICAgICAgdXNlcklkOiBudWxsLFxuICAgICAgICAgICAgZGlzcGxheU5hbWU6IG51bGwsXG4gICAgICAgICAgICBhdmF0YXJVcmw6IG51bGwsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgYXN5bmMgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgICAgIC8vIEZldGNoIHRoZSBjdXJyZW50IHVzZXIgcHJvZmlsZSBmb3IgdGhlIG1lc3NhZ2UgcHJldmlld1xuICAgICAgICBjb25zdCBjbGllbnQgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIGNvbnN0IHVzZXJJZCA9IGNsaWVudC5nZXRVc2VySWQoKTtcbiAgICAgICAgY29uc3QgcHJvZmlsZUluZm8gPSBhd2FpdCBjbGllbnQuZ2V0UHJvZmlsZUluZm8odXNlcklkKTtcbiAgICAgICAgaWYgKHRoaXMudW5tb3VudGVkKSByZXR1cm47XG5cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICBkaXNwbGF5TmFtZTogcHJvZmlsZUluZm8uZGlzcGxheW5hbWUsXG4gICAgICAgICAgICBhdmF0YXJVcmw6IHByb2ZpbGVJbmZvLmF2YXRhcl91cmwsXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgICB0aGlzLnVubW91bnRlZCA9IHRydWU7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkZvbnRTaXplQ2hhbmdlZCA9IChzaXplOiBudW1iZXIpOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGZvbnRTaXplOiBzaXplLnRvU3RyaW5nKCkgfSk7XG4gICAgICAgIFNldHRpbmdzU3RvcmUuc2V0VmFsdWUoXCJiYXNlRm9udFNpemVcIiwgbnVsbCwgU2V0dGluZ0xldmVsLkRFVklDRSwgc2l6ZSAtIEZvbnRXYXRjaGVyLlNJWkVfRElGRik7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25WYWxpZGF0ZUZvbnRTaXplID0gYXN5bmMgKHsgdmFsdWUgfTogUGljazxJRmllbGRTdGF0ZSwgXCJ2YWx1ZVwiPik6IFByb21pc2U8SVZhbGlkYXRpb25SZXN1bHQ+ID0+IHtcbiAgICAgICAgY29uc3QgcGFyc2VkU2l6ZSA9IHBhcnNlRmxvYXQodmFsdWUpO1xuICAgICAgICBjb25zdCBtaW4gPSBGb250V2F0Y2hlci5NSU5fU0laRSArIEZvbnRXYXRjaGVyLlNJWkVfRElGRjtcbiAgICAgICAgY29uc3QgbWF4ID0gRm9udFdhdGNoZXIuTUFYX1NJWkUgKyBGb250V2F0Y2hlci5TSVpFX0RJRkY7XG5cbiAgICAgICAgaWYgKGlzTmFOKHBhcnNlZFNpemUpKSB7XG4gICAgICAgICAgICByZXR1cm4geyB2YWxpZDogZmFsc2UsIGZlZWRiYWNrOiBfdChcIlNpemUgbXVzdCBiZSBhIG51bWJlclwiKSB9O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCEobWluIDw9IHBhcnNlZFNpemUgJiYgcGFyc2VkU2l6ZSA8PSBtYXgpKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHZhbGlkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBmZWVkYmFjazogX3QoJ0N1c3RvbSBmb250IHNpemUgY2FuIG9ubHkgYmUgYmV0d2VlbiAlKG1pbilzIHB0IGFuZCAlKG1heClzIHB0JywgeyBtaW4sIG1heCB9KSxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICBTZXR0aW5nc1N0b3JlLnNldFZhbHVlKFxuICAgICAgICAgICAgXCJiYXNlRm9udFNpemVcIixcbiAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICBTZXR0aW5nTGV2ZWwuREVWSUNFLFxuICAgICAgICAgICAgcGFyc2VJbnQodmFsdWUsIDEwKSAtIEZvbnRXYXRjaGVyLlNJWkVfRElGRixcbiAgICAgICAgKTtcblxuICAgICAgICByZXR1cm4geyB2YWxpZDogdHJ1ZSwgZmVlZGJhY2s6IF90KCdVc2UgYmV0d2VlbiAlKG1pbilzIHB0IGFuZCAlKG1heClzIHB0JywgeyBtaW4sIG1heCB9KSB9O1xuICAgIH07XG5cbiAgICBwdWJsaWMgcmVuZGVyKCkge1xuICAgICAgICByZXR1cm4gPGRpdiBjbGFzc05hbWU9XCJteF9TZXR0aW5nc1RhYl9zZWN0aW9uIG14X0ZvbnRTY2FsaW5nUGFuZWxcIj5cblxuICAgICAgICAgICAgPHNwYW4gY2xhc3NOYW1lPVwibXhfU2V0dGluZ3NUYWJfc3ViaGVhZGluZ1wiPnsgX3QoXCJGb250IHNpemVcIikgfTwvc3Bhbj5cbiAgICAgICAgICAgIDxFdmVudFRpbGVQcmV2aWV3XG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfRm9udFNjYWxpbmdQYW5lbF9mb250U2xpZGVyX3ByZXZpZXdcIlxuICAgICAgICAgICAgICAgIG1lc3NhZ2U9e3RoaXMuTUVTU0FHRV9QUkVWSUVXX1RFWFR9XG4gICAgICAgICAgICAgICAgbGF5b3V0PXt0aGlzLnN0YXRlLmxheW91dH1cbiAgICAgICAgICAgICAgICB1c2VySWQ9e3RoaXMuc3RhdGUudXNlcklkfVxuICAgICAgICAgICAgICAgIGRpc3BsYXlOYW1lPXt0aGlzLnN0YXRlLmRpc3BsYXlOYW1lfVxuICAgICAgICAgICAgICAgIGF2YXRhclVybD17dGhpcy5zdGF0ZS5hdmF0YXJVcmx9XG4gICAgICAgICAgICAvPlxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9Gb250U2NhbGluZ1BhbmVsX2ZvbnRTbGlkZXJcIj5cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0ZvbnRTY2FsaW5nUGFuZWxfZm9udFNsaWRlcl9zbWFsbFRleHRcIj5BYTwvZGl2PlxuICAgICAgICAgICAgICAgIDxTbGlkZXJcbiAgICAgICAgICAgICAgICAgICAgdmFsdWVzPXtbMTMsIDE0LCAxNSwgMTYsIDE4XX1cbiAgICAgICAgICAgICAgICAgICAgdmFsdWU9e3BhcnNlSW50KHRoaXMuc3RhdGUuZm9udFNpemUsIDEwKX1cbiAgICAgICAgICAgICAgICAgICAgb25TZWxlY3Rpb25DaGFuZ2U9e3RoaXMub25Gb250U2l6ZUNoYW5nZWR9XG4gICAgICAgICAgICAgICAgICAgIGRpc3BsYXlGdW5jPXtfID0+IFwiXCJ9XG4gICAgICAgICAgICAgICAgICAgIGRpc2FibGVkPXt0aGlzLnN0YXRlLnVzZUN1c3RvbUZvbnRTaXplfVxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9Gb250U2NhbGluZ1BhbmVsX2ZvbnRTbGlkZXJfbGFyZ2VUZXh0XCI+QWE8L2Rpdj5cbiAgICAgICAgICAgIDwvZGl2PlxuXG4gICAgICAgICAgICA8U2V0dGluZ3NGbGFnXG4gICAgICAgICAgICAgICAgbmFtZT1cInVzZUN1c3RvbUZvbnRTaXplXCJcbiAgICAgICAgICAgICAgICBsZXZlbD17U2V0dGluZ0xldmVsLkFDQ09VTlR9XG4gICAgICAgICAgICAgICAgb25DaGFuZ2U9eyhjaGVja2VkKSA9PiB0aGlzLnNldFN0YXRlKHsgdXNlQ3VzdG9tRm9udFNpemU6IGNoZWNrZWQgfSl9XG4gICAgICAgICAgICAgICAgdXNlQ2hlY2tib3g9e3RydWV9XG4gICAgICAgICAgICAvPlxuXG4gICAgICAgICAgICA8RmllbGRcbiAgICAgICAgICAgICAgICB0eXBlPVwibnVtYmVyXCJcbiAgICAgICAgICAgICAgICBsYWJlbD17X3QoXCJGb250IHNpemVcIil9XG4gICAgICAgICAgICAgICAgYXV0b0NvbXBsZXRlPVwib2ZmXCJcbiAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcj17dGhpcy5zdGF0ZS5mb250U2l6ZS50b1N0cmluZygpfVxuICAgICAgICAgICAgICAgIHZhbHVlPXt0aGlzLnN0YXRlLmZvbnRTaXplLnRvU3RyaW5nKCl9XG4gICAgICAgICAgICAgICAgaWQ9XCJmb250X3NpemVfZmllbGRcIlxuICAgICAgICAgICAgICAgIG9uVmFsaWRhdGU9e3RoaXMub25WYWxpZGF0ZUZvbnRTaXplfVxuICAgICAgICAgICAgICAgIG9uQ2hhbmdlPXtcbiAgICAgICAgICAgICAgICAgICAgKHZhbHVlOiBDaGFuZ2VFdmVudDxIVE1MSW5wdXRFbGVtZW50PikgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBmb250U2l6ZTogdmFsdWUudGFyZ2V0LnZhbHVlIH0pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGRpc2FibGVkPXshdGhpcy5zdGF0ZS51c2VDdXN0b21Gb250U2l6ZX1cbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9Gb250U2NhbGluZ1BhbmVsX2N1c3RvbUZvbnRTaXplRmllbGRcIlxuICAgICAgICAgICAgLz5cbiAgICAgICAgPC9kaXY+O1xuICAgIH1cbn1cbiJdfQ==