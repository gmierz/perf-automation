"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.ExistingPhoneNumber = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _languageHandler = require("../../../../languageHandler");

var _MatrixClientPeg = require("../../../../MatrixClientPeg");

var _Field = _interopRequireDefault(require("../../elements/Field"));

var _AccessibleButton = _interopRequireDefault(require("../../elements/AccessibleButton"));

var _AddThreepid = _interopRequireDefault(require("../../../../AddThreepid"));

var _CountryDropdown = _interopRequireDefault(require("../../auth/CountryDropdown"));

var _Modal = _interopRequireDefault(require("../../../../Modal"));

var _replaceableComponent = require("../../../../utils/replaceableComponent");

var _threepids = require("matrix-js-sdk/src/@types/threepids");

var _ErrorDialog = _interopRequireDefault(require("../../dialogs/ErrorDialog"));

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class;

class ExistingPhoneNumber extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onRemove", e => {
      e.stopPropagation();
      e.preventDefault();
      this.setState({
        verifyRemove: true
      });
    });
    (0, _defineProperty2.default)(this, "onDontRemove", e => {
      e.stopPropagation();
      e.preventDefault();
      this.setState({
        verifyRemove: false
      });
    });
    (0, _defineProperty2.default)(this, "onActuallyRemove", e => {
      e.stopPropagation();
      e.preventDefault();

      _MatrixClientPeg.MatrixClientPeg.get().deleteThreePid(this.props.msisdn.medium, this.props.msisdn.address).then(() => {
        return this.props.onRemoved(this.props.msisdn);
      }).catch(err => {
        _logger.logger.error("Unable to remove contact information: " + err);

        _Modal.default.createTrackedDialog('Remove 3pid failed', '', _ErrorDialog.default, {
          title: (0, _languageHandler._t)("Unable to remove contact information"),
          description: err && err.message ? err.message : (0, _languageHandler._t)("Operation failed")
        });
      });
    });
    this.state = {
      verifyRemove: false
    };
  }

  render() {
    if (this.state.verifyRemove) {
      return /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_ExistingPhoneNumber"
      }, /*#__PURE__*/_react.default.createElement("span", {
        className: "mx_ExistingPhoneNumber_promptText"
      }, (0, _languageHandler._t)("Remove %(phone)s?", {
        phone: this.props.msisdn.address
      })), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        onClick: this.onActuallyRemove,
        kind: "danger_sm",
        className: "mx_ExistingPhoneNumber_confirmBtn"
      }, (0, _languageHandler._t)("Remove")), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        onClick: this.onDontRemove,
        kind: "link_sm",
        className: "mx_ExistingPhoneNumber_confirmBtn"
      }, (0, _languageHandler._t)("Cancel")));
    }

    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_ExistingPhoneNumber"
    }, /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_ExistingPhoneNumber_address"
    }, "+", this.props.msisdn.address), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      onClick: this.onRemove,
      kind: "danger_sm"
    }, (0, _languageHandler._t)("Remove")));
  }

}

exports.ExistingPhoneNumber = ExistingPhoneNumber;
let PhoneNumbers = (_dec = (0, _replaceableComponent.replaceableComponent)("views.settings.account.PhoneNumbers"), _dec(_class = class PhoneNumbers extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onRemoved", address => {
      const msisdns = this.props.msisdns.filter(e => e !== address);
      this.props.onMsisdnsChange(msisdns);
    });
    (0, _defineProperty2.default)(this, "onChangeNewPhoneNumber", e => {
      this.setState({
        newPhoneNumber: e.target.value
      });
    });
    (0, _defineProperty2.default)(this, "onChangeNewPhoneNumberCode", e => {
      this.setState({
        newPhoneNumberCode: e.target.value
      });
    });
    (0, _defineProperty2.default)(this, "onAddClick", e => {
      e.stopPropagation();
      e.preventDefault();
      if (!this.state.newPhoneNumber) return;
      const phoneNumber = this.state.newPhoneNumber;
      const phoneCountry = this.state.phoneCountry;
      const task = new _AddThreepid.default();
      this.setState({
        verifying: true,
        continueDisabled: true,
        addTask: task
      });
      task.addMsisdn(phoneCountry, phoneNumber).then(response => {
        this.setState({
          continueDisabled: false,
          verifyMsisdn: response.msisdn
        });
      }).catch(err => {
        _logger.logger.error("Unable to add phone number " + phoneNumber + " " + err);

        this.setState({
          verifying: false,
          continueDisabled: false,
          addTask: null
        });

        _Modal.default.createTrackedDialog('Add Phone Number Error', '', _ErrorDialog.default, {
          title: (0, _languageHandler._t)("Error"),
          description: err && err.message ? err.message : (0, _languageHandler._t)("Operation failed")
        });
      });
    });
    (0, _defineProperty2.default)(this, "onContinueClick", e => {
      e.stopPropagation();
      e.preventDefault();
      this.setState({
        continueDisabled: true
      });
      const token = this.state.newPhoneNumberCode;
      const address = this.state.verifyMsisdn;
      this.state.addTask.haveMsisdnToken(token).then(([finished]) => {
        let newPhoneNumber = this.state.newPhoneNumber;

        if (finished) {
          const msisdns = [...this.props.msisdns, {
            address,
            medium: _threepids.ThreepidMedium.Phone
          }];
          this.props.onMsisdnsChange(msisdns);
          newPhoneNumber = "";
        }

        this.setState({
          addTask: null,
          continueDisabled: false,
          verifying: false,
          verifyMsisdn: "",
          verifyError: null,
          newPhoneNumber,
          newPhoneNumberCode: ""
        });
      }).catch(err => {
        this.setState({
          continueDisabled: false
        });

        if (err.errcode !== 'M_THREEPID_AUTH_FAILED') {
          _logger.logger.error("Unable to verify phone number: " + err);

          _Modal.default.createTrackedDialog('Unable to verify phone number', '', _ErrorDialog.default, {
            title: (0, _languageHandler._t)("Unable to verify phone number."),
            description: err && err.message ? err.message : (0, _languageHandler._t)("Operation failed")
          });
        } else {
          this.setState({
            verifyError: (0, _languageHandler._t)("Incorrect verification code")
          });
        }
      });
    });
    (0, _defineProperty2.default)(this, "onCountryChanged", country => {
      this.setState({
        phoneCountry: country.iso2
      });
    });
    this.state = {
      verifying: false,
      verifyError: null,
      verifyMsisdn: "",
      addTask: null,
      continueDisabled: false,
      phoneCountry: "",
      newPhoneNumber: "",
      newPhoneNumberCode: ""
    };
  }

  render() {
    const existingPhoneElements = this.props.msisdns.map(p => {
      return /*#__PURE__*/_react.default.createElement(ExistingPhoneNumber, {
        msisdn: p,
        onRemoved: this.onRemoved,
        key: p.address
      });
    });

    let addVerifySection = /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      onClick: this.onAddClick,
      kind: "primary"
    }, (0, _languageHandler._t)("Add"));

    if (this.state.verifying) {
      const msisdn = this.state.verifyMsisdn;
      addVerifySection = /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("div", null, (0, _languageHandler._t)("A text message has been sent to +%(msisdn)s. " + "Please enter the verification code it contains.", {
        msisdn: msisdn
      }), /*#__PURE__*/_react.default.createElement("br", null), this.state.verifyError), /*#__PURE__*/_react.default.createElement("form", {
        onSubmit: this.onContinueClick,
        autoComplete: "off",
        noValidate: true
      }, /*#__PURE__*/_react.default.createElement(_Field.default, {
        type: "text",
        label: (0, _languageHandler._t)("Verification code"),
        autoComplete: "off",
        disabled: this.state.continueDisabled,
        value: this.state.newPhoneNumberCode,
        onChange: this.onChangeNewPhoneNumberCode
      }), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        onClick: this.onContinueClick,
        kind: "primary",
        disabled: this.state.continueDisabled || this.state.newPhoneNumberCode.length === 0
      }, (0, _languageHandler._t)("Continue"))));
    }

    const phoneCountry = /*#__PURE__*/_react.default.createElement(_CountryDropdown.default, {
      onOptionChange: this.onCountryChanged,
      className: "mx_PhoneNumbers_country",
      value: this.state.phoneCountry,
      disabled: this.state.verifying,
      isSmall: true,
      showPrefix: true
    });

    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_PhoneNumbers"
    }, existingPhoneElements, /*#__PURE__*/_react.default.createElement("form", {
      onSubmit: this.onAddClick,
      autoComplete: "off",
      noValidate: true,
      className: "mx_PhoneNumbers_new"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_PhoneNumbers_input"
    }, /*#__PURE__*/_react.default.createElement(_Field.default, {
      type: "text",
      label: (0, _languageHandler._t)("Phone Number"),
      autoComplete: "off",
      disabled: this.state.verifying,
      prefixComponent: phoneCountry,
      value: this.state.newPhoneNumber,
      onChange: this.onChangeNewPhoneNumber
    }))), addVerifySection);
  }

}) || _class);
exports.default = PhoneNumbers;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3NldHRpbmdzL2FjY291bnQvUGhvbmVOdW1iZXJzLnRzeCJdLCJuYW1lcyI6WyJFeGlzdGluZ1Bob25lTnVtYmVyIiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwiZSIsInN0b3BQcm9wYWdhdGlvbiIsInByZXZlbnREZWZhdWx0Iiwic2V0U3RhdGUiLCJ2ZXJpZnlSZW1vdmUiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJkZWxldGVUaHJlZVBpZCIsIm1zaXNkbiIsIm1lZGl1bSIsImFkZHJlc3MiLCJ0aGVuIiwib25SZW1vdmVkIiwiY2F0Y2giLCJlcnIiLCJsb2dnZXIiLCJlcnJvciIsIk1vZGFsIiwiY3JlYXRlVHJhY2tlZERpYWxvZyIsIkVycm9yRGlhbG9nIiwidGl0bGUiLCJkZXNjcmlwdGlvbiIsIm1lc3NhZ2UiLCJzdGF0ZSIsInJlbmRlciIsInBob25lIiwib25BY3R1YWxseVJlbW92ZSIsIm9uRG9udFJlbW92ZSIsIm9uUmVtb3ZlIiwiUGhvbmVOdW1iZXJzIiwibXNpc2RucyIsImZpbHRlciIsIm9uTXNpc2Ruc0NoYW5nZSIsIm5ld1Bob25lTnVtYmVyIiwidGFyZ2V0IiwidmFsdWUiLCJuZXdQaG9uZU51bWJlckNvZGUiLCJwaG9uZU51bWJlciIsInBob25lQ291bnRyeSIsInRhc2siLCJBZGRUaHJlZXBpZCIsInZlcmlmeWluZyIsImNvbnRpbnVlRGlzYWJsZWQiLCJhZGRUYXNrIiwiYWRkTXNpc2RuIiwicmVzcG9uc2UiLCJ2ZXJpZnlNc2lzZG4iLCJ0b2tlbiIsImhhdmVNc2lzZG5Ub2tlbiIsImZpbmlzaGVkIiwiVGhyZWVwaWRNZWRpdW0iLCJQaG9uZSIsInZlcmlmeUVycm9yIiwiZXJyY29kZSIsImNvdW50cnkiLCJpc28yIiwiZXhpc3RpbmdQaG9uZUVsZW1lbnRzIiwibWFwIiwicCIsImFkZFZlcmlmeVNlY3Rpb24iLCJvbkFkZENsaWNrIiwib25Db250aW51ZUNsaWNrIiwib25DaGFuZ2VOZXdQaG9uZU51bWJlckNvZGUiLCJsZW5ndGgiLCJvbkNvdW50cnlDaGFuZ2VkIiwib25DaGFuZ2VOZXdQaG9uZU51bWJlciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFpQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0E7Ozs7QUFrQk8sTUFBTUEsbUJBQU4sU0FBa0NDLGVBQU1DLFNBQXhDLENBQXdHO0FBQzNHQyxFQUFBQSxXQUFXLENBQUNDLEtBQUQsRUFBbUM7QUFDMUMsVUFBTUEsS0FBTjtBQUQwQyxvREFRMUJDLENBQUQsSUFBK0I7QUFDOUNBLE1BQUFBLENBQUMsQ0FBQ0MsZUFBRjtBQUNBRCxNQUFBQSxDQUFDLENBQUNFLGNBQUY7QUFFQSxXQUFLQyxRQUFMLENBQWM7QUFBRUMsUUFBQUEsWUFBWSxFQUFFO0FBQWhCLE9BQWQ7QUFDSCxLQWI2QztBQUFBLHdEQWV0QkosQ0FBRCxJQUErQjtBQUNsREEsTUFBQUEsQ0FBQyxDQUFDQyxlQUFGO0FBQ0FELE1BQUFBLENBQUMsQ0FBQ0UsY0FBRjtBQUVBLFdBQUtDLFFBQUwsQ0FBYztBQUFFQyxRQUFBQSxZQUFZLEVBQUU7QUFBaEIsT0FBZDtBQUNILEtBcEI2QztBQUFBLDREQXNCbEJKLENBQUQsSUFBK0I7QUFDdERBLE1BQUFBLENBQUMsQ0FBQ0MsZUFBRjtBQUNBRCxNQUFBQSxDQUFDLENBQUNFLGNBQUY7O0FBRUFHLHVDQUFnQkMsR0FBaEIsR0FBc0JDLGNBQXRCLENBQXFDLEtBQUtSLEtBQUwsQ0FBV1MsTUFBWCxDQUFrQkMsTUFBdkQsRUFBK0QsS0FBS1YsS0FBTCxDQUFXUyxNQUFYLENBQWtCRSxPQUFqRixFQUEwRkMsSUFBMUYsQ0FBK0YsTUFBTTtBQUNqRyxlQUFPLEtBQUtaLEtBQUwsQ0FBV2EsU0FBWCxDQUFxQixLQUFLYixLQUFMLENBQVdTLE1BQWhDLENBQVA7QUFDSCxPQUZELEVBRUdLLEtB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LGtCQUFYLENBQThCMkIsTUFBOUIsS0FBeUM7QUFIdEYsU0FLTSx5QkFBRyxVQUFILENBTE4sQ0FUSixDQVBKLENBREo7QUEyQkg7O0FBRUQsVUFBTXpCLFlBQVksZ0JBQUcsNkJBQUMsd0JBQUQ7QUFBaUIsTUFBQSxjQUFjLEVBQUUsS0FBSzBCLGdCQUF0QztBQUNqQixNQUFBLFNBQVMsRUFBQyx5QkFETztBQUVqQixNQUFBLEtBQUssRUFBRSxLQUFLekMsS0FBTCxDQUFXZSxZQUZEO0FBR2pCLE1BQUEsUUFBUSxFQUFFLEtBQUtmLEtBQUwsQ0FBV2tCLFNBSEo7QUFJakIsTUFBQSxPQUFPLEVBQUUsSUFKUTtBQUtqQixNQUFBLFVBQVUsRUFBRTtBQUxLLE1BQXJCOztBQVFBLHdCQUNJO0FBQUssTUFBQSxTQUFTLEVBQUM7QUFBZixPQUNNZSxxQkFETixlQUVJO0FBQU0sTUFBQSxRQUFRLEVBQUUsS0FBS0ksVUFBckI7QUFBaUMsTUFBQSxZQUFZLEVBQUMsS0FBOUM7QUFBb0QsTUFBQSxVQUFVLEVBQUUsSUFBaEU7QUFBc0UsTUFBQSxTQUFTLEVBQUM7QUFBaEYsb0JBQ0k7QUFBSyxNQUFBLFNBQVMsRUFBQztBQUFmLG9CQUNJLDZCQUFDLGNBQUQ7QUFDSSxNQUFBLElBQUksRUFBQyxNQURUO0FBRUksTUFBQSxLQUFLLEVBQUUseUJBQUcsY0FBSCxDQUZYO0FBR0ksTUFBQSxZQUFZLEVBQUMsS0FIakI7QUFJSSxNQUFBLFFBQVEsRUFBRSxLQUFLckMsS0FBTCxDQUFXa0IsU0FKekI7QUFLSSxNQUFBLGVBQWUsRUFBRUgsWUFMckI7QUFNSSxNQUFBLEtBQUssRUFBRSxLQUFLZixLQUFMLENBQVdVLGNBTnRCO0FBT0ksTUFBQSxRQUFRLEVBQUUsS0FBS2dDO0FBUG5CLE1BREosQ0FESixDQUZKLEVBZU1OLGdCQWZOLENBREo7QUFtQkg7O0FBektxRSxDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE5IE5ldyBWZWN0b3IgTHRkXG5Db3B5cmlnaHQgMjAxOSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBfdCB9IGZyb20gXCIuLi8uLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXJcIjtcbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gXCIuLi8uLi8uLi8uLi9NYXRyaXhDbGllbnRQZWdcIjtcbmltcG9ydCBGaWVsZCBmcm9tIFwiLi4vLi4vZWxlbWVudHMvRmllbGRcIjtcbmltcG9ydCBBY2Nlc3NpYmxlQnV0dG9uIGZyb20gXCIuLi8uLi9lbGVtZW50cy9BY2Nlc3NpYmxlQnV0dG9uXCI7XG5pbXBvcnQgQWRkVGhyZWVwaWQgZnJvbSBcIi4uLy4uLy4uLy4uL0FkZFRocmVlcGlkXCI7XG5pbXBvcnQgQ291bnRyeURyb3Bkb3duIGZyb20gXCIuLi8uLi9hdXRoL0NvdW50cnlEcm9wZG93blwiO1xuaW1wb3J0IE1vZGFsIGZyb20gJy4uLy4uLy4uLy4uL01vZGFsJztcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5pbXBvcnQgeyBJVGhyZWVwaWQsIFRocmVlcGlkTWVkaXVtIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL0B0eXBlcy90aHJlZXBpZHNcIjtcbmltcG9ydCBFcnJvckRpYWxvZyBmcm9tIFwiLi4vLi4vZGlhbG9ncy9FcnJvckRpYWxvZ1wiO1xuaW1wb3J0IHsgUGhvbmVOdW1iZXJDb3VudHJ5RGVmaW5pdGlvbiB9IGZyb20gXCIuLi8uLi8uLi8uLi9waG9uZW51bWJlclwiO1xuXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbG9nZ2VyXCI7XG5cbi8qXG5UT0RPOiBJbXByb3ZlIHRoZSBVWCBmb3IgZXZlcnl0aGluZyBpbiBoZXJlLlxuVGhpcyBpcyBhIGNvcHkvcGFzdGUgb2YgRW1haWxBZGRyZXNzZXMsIG1vc3RseS5cbiAqL1xuXG4vLyBUT0RPOiBDb21iaW5lIEVtYWlsQWRkcmVzc2VzIGFuZCBQaG9uZU51bWJlcnMgdG8gYmUgM3BpZCBhZ25vc3RpY1xuXG5pbnRlcmZhY2UgSUV4aXN0aW5nUGhvbmVOdW1iZXJQcm9wcyB7XG4gICAgbXNpc2RuOiBJVGhyZWVwaWQ7XG4gICAgb25SZW1vdmVkOiAocGhvbmVOdW1iZXI6IElUaHJlZXBpZCkgPT4gdm9pZDtcbn1cblxuaW50ZXJmYWNlIElFeGlzdGluZ1Bob25lTnVtYmVyU3RhdGUge1xuICAgIHZlcmlmeVJlbW92ZTogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGNsYXNzIEV4aXN0aW5nUGhvbmVOdW1iZXIgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8SUV4aXN0aW5nUGhvbmVOdW1iZXJQcm9wcywgSUV4aXN0aW5nUGhvbmVOdW1iZXJTdGF0ZT4ge1xuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBJRXhpc3RpbmdQaG9uZU51bWJlclByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgdmVyaWZ5UmVtb3ZlOiBmYWxzZSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uUmVtb3ZlID0gKGU6IFJlYWN0Lk1vdXNlRXZlbnQpOiB2b2lkID0+IHtcbiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyB2ZXJpZnlSZW1vdmU6IHRydWUgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25Eb250UmVtb3ZlID0gKGU6IFJlYWN0Lk1vdXNlRXZlbnQpOiB2b2lkID0+IHtcbiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyB2ZXJpZnlSZW1vdmU6IGZhbHNlIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uQWN0dWFsbHlSZW1vdmUgPSAoZTogUmVhY3QuTW91c2VFdmVudCk6IHZvaWQgPT4ge1xuICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICAgICAgTWF0cml4Q2xpZW50UGVnLmdldCgpLmRlbGV0ZVRocmVlUGlkKHRoaXMucHJvcHMubXNpc2RuLm1lZGl1bSwgdGhpcy5wcm9wcy5tc2lzZG4uYWRkcmVzcykudGhlbigoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5wcm9wcy5vblJlbW92ZWQodGhpcy5wcm9wcy5tc2lzZG4pO1xuICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoXCJVbmFibGUgdG8gcmVtb3ZlIGNvbnRhY3QgaW5mb3JtYXRpb246IFwiICsgZXJyKTtcbiAgICAgICAgICAgIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coJ1JlbW92ZSAzcGlkIGZhaWxlZCcsICcnLCBFcnJvckRpYWxvZywge1xuICAgICAgICAgICAgICAgIHRpdGxlOiBfdChcIlVuYWJsZSB0byByZW1vdmUgY29udGFjdCBpbmZvcm1hdGlvblwiKSxcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogKChlcnIgJiYgZXJyLm1lc3NhZ2UpID8gZXJyLm1lc3NhZ2UgOiBfdChcIk9wZXJhdGlvbiBmYWlsZWRcIikpLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBwdWJsaWMgcmVuZGVyKCk6IEpTWC5FbGVtZW50IHtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUudmVyaWZ5UmVtb3ZlKSB7XG4gICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfRXhpc3RpbmdQaG9uZU51bWJlclwiPlxuICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9XCJteF9FeGlzdGluZ1Bob25lTnVtYmVyX3Byb21wdFRleHRcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCJSZW1vdmUgJShwaG9uZSlzP1wiLCB7IHBob25lOiB0aGlzLnByb3BzLm1zaXNkbi5hZGRyZXNzIH0pIH1cbiAgICAgICAgICAgICAgICAgICAgPC9zcGFuPlxuICAgICAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvblxuICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5vbkFjdHVhbGx5UmVtb3ZlfVxuICAgICAgICAgICAgICAgICAgICAgICAga2luZD1cImRhbmdlcl9zbVwiXG4gICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9FeGlzdGluZ1Bob25lTnVtYmVyX2NvbmZpcm1CdG5cIlxuICAgICAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICAgICAgICB7IF90KFwiUmVtb3ZlXCIpIH1cbiAgICAgICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvblxuICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5vbkRvbnRSZW1vdmV9XG4gICAgICAgICAgICAgICAgICAgICAgICBraW5kPVwibGlua19zbVwiXG4gICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9FeGlzdGluZ1Bob25lTnVtYmVyX2NvbmZpcm1CdG5cIlxuICAgICAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICAgICAgICB7IF90KFwiQ2FuY2VsXCIpIH1cbiAgICAgICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0V4aXN0aW5nUGhvbmVOdW1iZXJcIj5cbiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9XCJteF9FeGlzdGluZ1Bob25lTnVtYmVyX2FkZHJlc3NcIj4reyB0aGlzLnByb3BzLm1zaXNkbi5hZGRyZXNzIH08L3NwYW4+XG4gICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b24gb25DbGljaz17dGhpcy5vblJlbW92ZX0ga2luZD1cImRhbmdlcl9zbVwiPlxuICAgICAgICAgICAgICAgICAgICB7IF90KFwiUmVtb3ZlXCIpIH1cbiAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKTtcbiAgICB9XG59XG5cbmludGVyZmFjZSBJUHJvcHMge1xuICAgIG1zaXNkbnM6IElUaHJlZXBpZFtdO1xuICAgIG9uTXNpc2Ruc0NoYW5nZTogKHBob25lTnVtYmVyczogUGFydGlhbDxJVGhyZWVwaWQ+W10pID0+IHZvaWQ7XG59XG5cbmludGVyZmFjZSBJU3RhdGUge1xuICAgIHZlcmlmeWluZzogYm9vbGVhbjtcbiAgICB2ZXJpZnlFcnJvcjogc3RyaW5nO1xuICAgIHZlcmlmeU1zaXNkbjogc3RyaW5nO1xuICAgIGFkZFRhc2s6IGFueTsgLy8gRklYTUU6IFdoZW4gQWRkVGhyZWVwaWQgaXMgVFNmaWVkXG4gICAgY29udGludWVEaXNhYmxlZDogYm9vbGVhbjtcbiAgICBwaG9uZUNvdW50cnk6IHN0cmluZztcbiAgICBuZXdQaG9uZU51bWJlcjogc3RyaW5nO1xuICAgIG5ld1Bob25lTnVtYmVyQ29kZTogc3RyaW5nO1xufVxuXG5AcmVwbGFjZWFibGVDb21wb25lbnQoXCJ2aWV3cy5zZXR0aW5ncy5hY2NvdW50LlBob25lTnVtYmVyc1wiKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUGhvbmVOdW1iZXJzIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PElQcm9wcywgSVN0YXRlPiB7XG4gICAgY29uc3RydWN0b3IocHJvcHM6IElQcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG5cbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIHZlcmlmeWluZzogZmFsc2UsXG4gICAgICAgICAgICB2ZXJpZnlFcnJvcjogbnVsbCxcbiAgICAgICAgICAgIHZlcmlmeU1zaXNkbjogXCJcIixcbiAgICAgICAgICAgIGFkZFRhc2s6IG51bGwsXG4gICAgICAgICAgICBjb250aW51ZURpc2FibGVkOiBmYWxzZSxcbiAgICAgICAgICAgIHBob25lQ291bnRyeTogXCJcIixcbiAgICAgICAgICAgIG5ld1Bob25lTnVtYmVyOiBcIlwiLFxuICAgICAgICAgICAgbmV3UGhvbmVOdW1iZXJDb2RlOiBcIlwiLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgb25SZW1vdmVkID0gKGFkZHJlc3M6IElUaHJlZXBpZCk6IHZvaWQgPT4ge1xuICAgICAgICBjb25zdCBtc2lzZG5zID0gdGhpcy5wcm9wcy5tc2lzZG5zLmZpbHRlcigoZSkgPT4gZSAhPT0gYWRkcmVzcyk7XG4gICAgICAgIHRoaXMucHJvcHMub25Nc2lzZG5zQ2hhbmdlKG1zaXNkbnMpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uQ2hhbmdlTmV3UGhvbmVOdW1iZXIgPSAoZTogUmVhY3QuQ2hhbmdlRXZlbnQ8SFRNTElucHV0RWxlbWVudD4pOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBuZXdQaG9uZU51bWJlcjogZS50YXJnZXQudmFsdWUsXG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uQ2hhbmdlTmV3UGhvbmVOdW1iZXJDb2RlID0gKGU6IFJlYWN0LkNoYW5nZUV2ZW50PEhUTUxJbnB1dEVsZW1lbnQ+KTogdm9pZCA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgbmV3UGhvbmVOdW1iZXJDb2RlOiBlLnRhcmdldC52YWx1ZSxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25BZGRDbGljayA9IChlOiBSZWFjdC5Nb3VzZUV2ZW50IHwgUmVhY3QuRm9ybUV2ZW50KTogdm9pZCA9PiB7XG4gICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgICBpZiAoIXRoaXMuc3RhdGUubmV3UGhvbmVOdW1iZXIpIHJldHVybjtcblxuICAgICAgICBjb25zdCBwaG9uZU51bWJlciA9IHRoaXMuc3RhdGUubmV3UGhvbmVOdW1iZXI7XG4gICAgICAgIGNvbnN0IHBob25lQ291bnRyeSA9IHRoaXMuc3RhdGUucGhvbmVDb3VudHJ5O1xuXG4gICAgICAgIGNvbnN0IHRhc2sgPSBuZXcgQWRkVGhyZWVwaWQoKTtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IHZlcmlmeWluZzogdHJ1ZSwgY29udGludWVEaXNhYmxlZDogdHJ1ZSwgYWRkVGFzazogdGFzayB9KTtcblxuICAgICAgICB0YXNrLmFkZE1zaXNkbihwaG9uZUNvdW50cnksIHBob25lTnVtYmVyKS50aGVuKChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGNvbnRpbnVlRGlzYWJsZWQ6IGZhbHNlLCB2ZXJpZnlNc2lzZG46IHJlc3BvbnNlLm1zaXNkbiB9KTtcbiAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKFwiVW5hYmxlIHRvIGFkZCBwaG9uZSBudW1iZXIgXCIgKyBwaG9uZU51bWJlciArIFwiIFwiICsgZXJyKTtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyB2ZXJpZnlpbmc6IGZhbHNlLCBjb250aW51ZURpc2FibGVkOiBmYWxzZSwgYWRkVGFzazogbnVsbCB9KTtcbiAgICAgICAgICAgIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coJ0FkZCBQaG9uZSBOdW1iZXIgRXJyb3InLCAnJywgRXJyb3JEaWFsb2csIHtcbiAgICAgICAgICAgICAgICB0aXRsZTogX3QoXCJFcnJvclwiKSxcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogKChlcnIgJiYgZXJyLm1lc3NhZ2UpID8gZXJyLm1lc3NhZ2UgOiBfdChcIk9wZXJhdGlvbiBmYWlsZWRcIikpLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uQ29udGludWVDbGljayA9IChlOiBSZWFjdC5Nb3VzZUV2ZW50IHwgUmVhY3QuRm9ybUV2ZW50KTogdm9pZCA9PiB7XG4gICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgICB0aGlzLnNldFN0YXRlKHsgY29udGludWVEaXNhYmxlZDogdHJ1ZSB9KTtcbiAgICAgICAgY29uc3QgdG9rZW4gPSB0aGlzLnN0YXRlLm5ld1Bob25lTnVtYmVyQ29kZTtcbiAgICAgICAgY29uc3QgYWRkcmVzcyA9IHRoaXMuc3RhdGUudmVyaWZ5TXNpc2RuO1xuICAgICAgICB0aGlzLnN0YXRlLmFkZFRhc2suaGF2ZU1zaXNkblRva2VuKHRva2VuKS50aGVuKChbZmluaXNoZWRdKSA9PiB7XG4gICAgICAgICAgICBsZXQgbmV3UGhvbmVOdW1iZXIgPSB0aGlzLnN0YXRlLm5ld1Bob25lTnVtYmVyO1xuICAgICAgICAgICAgaWYgKGZpbmlzaGVkKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbXNpc2RucyA9IFtcbiAgICAgICAgICAgICAgICAgICAgLi4udGhpcy5wcm9wcy5tc2lzZG5zLFxuICAgICAgICAgICAgICAgICAgICB7IGFkZHJlc3MsIG1lZGl1bTogVGhyZWVwaWRNZWRpdW0uUGhvbmUgfSxcbiAgICAgICAgICAgICAgICBdO1xuICAgICAgICAgICAgICAgIHRoaXMucHJvcHMub25Nc2lzZG5zQ2hhbmdlKG1zaXNkbnMpO1xuICAgICAgICAgICAgICAgIG5ld1Bob25lTnVtYmVyID0gXCJcIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgIGFkZFRhc2s6IG51bGwsXG4gICAgICAgICAgICAgICAgY29udGludWVEaXNhYmxlZDogZmFsc2UsXG4gICAgICAgICAgICAgICAgdmVyaWZ5aW5nOiBmYWxzZSxcbiAgICAgICAgICAgICAgICB2ZXJpZnlNc2lzZG46IFwiXCIsXG4gICAgICAgICAgICAgICAgdmVyaWZ5RXJyb3I6IG51bGwsXG4gICAgICAgICAgICAgICAgbmV3UGhvbmVOdW1iZXIsXG4gICAgICAgICAgICAgICAgbmV3UGhvbmVOdW1iZXJDb2RlOiBcIlwiLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBjb250aW51ZURpc2FibGVkOiBmYWxzZSB9KTtcbiAgICAgICAgICAgIGlmIChlcnIuZXJyY29kZSAhPT0gJ01fVEhSRUVQSURfQVVUSF9GQUlMRUQnKSB7XG4gICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKFwiVW5hYmxlIHRvIHZlcmlmeSBwaG9uZSBudW1iZXI6IFwiICsgZXJyKTtcbiAgICAgICAgICAgICAgICBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nKCdVbmFibGUgdG8gdmVyaWZ5IHBob25lIG51bWJlcicsICcnLCBFcnJvckRpYWxvZywge1xuICAgICAgICAgICAgICAgICAgICB0aXRsZTogX3QoXCJVbmFibGUgdG8gdmVyaWZ5IHBob25lIG51bWJlci5cIiksXG4gICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAoKGVyciAmJiBlcnIubWVzc2FnZSkgPyBlcnIubWVzc2FnZSA6IF90KFwiT3BlcmF0aW9uIGZhaWxlZFwiKSksXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyB2ZXJpZnlFcnJvcjogX3QoXCJJbmNvcnJlY3QgdmVyaWZpY2F0aW9uIGNvZGVcIikgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uQ291bnRyeUNoYW5nZWQgPSAoY291bnRyeTogUGhvbmVOdW1iZXJDb3VudHJ5RGVmaW5pdGlvbik6IHZvaWQgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgcGhvbmVDb3VudHJ5OiBjb3VudHJ5LmlzbzIgfSk7XG4gICAgfTtcblxuICAgIHB1YmxpYyByZW5kZXIoKTogSlNYLkVsZW1lbnQge1xuICAgICAgICBjb25zdCBleGlzdGluZ1Bob25lRWxlbWVudHMgPSB0aGlzLnByb3BzLm1zaXNkbnMubWFwKChwKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gPEV4aXN0aW5nUGhvbmVOdW1iZXIgbXNpc2RuPXtwfSBvblJlbW92ZWQ9e3RoaXMub25SZW1vdmVkfSBrZXk9e3AuYWRkcmVzc30gLz47XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGxldCBhZGRWZXJpZnlTZWN0aW9uID0gKFxuICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b24gb25DbGljaz17dGhpcy5vbkFkZENsaWNrfSBraW5kPVwicHJpbWFyeVwiPlxuICAgICAgICAgICAgICAgIHsgX3QoXCJBZGRcIikgfVxuICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICApO1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS52ZXJpZnlpbmcpIHtcbiAgICAgICAgICAgIGNvbnN0IG1zaXNkbiA9IHRoaXMuc3RhdGUudmVyaWZ5TXNpc2RuO1xuICAgICAgICAgICAgYWRkVmVyaWZ5U2VjdGlvbiA9IChcbiAgICAgICAgICAgICAgICA8ZGl2PlxuICAgICAgICAgICAgICAgICAgICA8ZGl2PlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIkEgdGV4dCBtZXNzYWdlIGhhcyBiZWVuIHNlbnQgdG8gKyUobXNpc2RuKXMuIFwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIlBsZWFzZSBlbnRlciB0aGUgdmVyaWZpY2F0aW9uIGNvZGUgaXQgY29udGFpbnMuXCIsIHsgbXNpc2RuOiBtc2lzZG4gfSkgfVxuICAgICAgICAgICAgICAgICAgICAgICAgPGJyIC8+XG4gICAgICAgICAgICAgICAgICAgICAgICB7IHRoaXMuc3RhdGUudmVyaWZ5RXJyb3IgfVxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgPGZvcm0gb25TdWJtaXQ9e3RoaXMub25Db250aW51ZUNsaWNrfSBhdXRvQ29tcGxldGU9XCJvZmZcIiBub1ZhbGlkYXRlPXt0cnVlfT5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxGaWVsZFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU9XCJ0ZXh0XCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbD17X3QoXCJWZXJpZmljYXRpb24gY29kZVwiKX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdXRvQ29tcGxldGU9XCJvZmZcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVkPXt0aGlzLnN0YXRlLmNvbnRpbnVlRGlzYWJsZWR9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU9e3RoaXMuc3RhdGUubmV3UGhvbmVOdW1iZXJDb2RlfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2hhbmdlPXt0aGlzLm9uQ2hhbmdlTmV3UGhvbmVOdW1iZXJDb2RlfVxuICAgICAgICAgICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5vbkNvbnRpbnVlQ2xpY2t9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAga2luZD1cInByaW1hcnlcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVkPXt0aGlzLnN0YXRlLmNvbnRpbnVlRGlzYWJsZWQgfHwgdGhpcy5zdGF0ZS5uZXdQaG9uZU51bWJlckNvZGUubGVuZ3RoID09PSAwfVxuICAgICAgICAgICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCJDb250aW51ZVwiKSB9XG4gICAgICAgICAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICAgICAgICAgIDwvZm9ybT5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwaG9uZUNvdW50cnkgPSA8Q291bnRyeURyb3Bkb3duIG9uT3B0aW9uQ2hhbmdlPXt0aGlzLm9uQ291bnRyeUNoYW5nZWR9XG4gICAgICAgICAgICBjbGFzc05hbWU9XCJteF9QaG9uZU51bWJlcnNfY291bnRyeVwiXG4gICAgICAgICAgICB2YWx1ZT17dGhpcy5zdGF0ZS5waG9uZUNvdW50cnl9XG4gICAgICAgICAgICBkaXNhYmxlZD17dGhpcy5zdGF0ZS52ZXJpZnlpbmd9XG4gICAgICAgICAgICBpc1NtYWxsPXt0cnVlfVxuICAgICAgICAgICAgc2hvd1ByZWZpeD17dHJ1ZX1cbiAgICAgICAgLz47XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfUGhvbmVOdW1iZXJzXCI+XG4gICAgICAgICAgICAgICAgeyBleGlzdGluZ1Bob25lRWxlbWVudHMgfVxuICAgICAgICAgICAgICAgIDxmb3JtIG9uU3VibWl0PXt0aGlzLm9uQWRkQ2xpY2t9IGF1dG9Db21wbGV0ZT1cIm9mZlwiIG5vVmFsaWRhdGU9e3RydWV9IGNsYXNzTmFtZT1cIm14X1Bob25lTnVtYmVyc19uZXdcIj5cbiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9QaG9uZU51bWJlcnNfaW5wdXRcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxGaWVsZFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU9XCJ0ZXh0XCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbD17X3QoXCJQaG9uZSBOdW1iZXJcIil9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXV0b0NvbXBsZXRlPVwib2ZmXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZD17dGhpcy5zdGF0ZS52ZXJpZnlpbmd9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlZml4Q29tcG9uZW50PXtwaG9uZUNvdW50cnl9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU9e3RoaXMuc3RhdGUubmV3UGhvbmVOdW1iZXJ9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2U9e3RoaXMub25DaGFuZ2VOZXdQaG9uZU51bWJlcn1cbiAgICAgICAgICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgIDwvZm9ybT5cbiAgICAgICAgICAgICAgICB7IGFkZFZlcmlmeVNlY3Rpb24gfVxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICk7XG4gICAgfVxufVxuIl19