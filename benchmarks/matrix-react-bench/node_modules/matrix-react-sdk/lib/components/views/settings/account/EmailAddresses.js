"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.ExistingEmailAddress = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _languageHandler = require("../../../../languageHandler");

var _MatrixClientPeg = require("../../../../MatrixClientPeg");

var _Field = _interopRequireDefault(require("../../elements/Field"));

var _AccessibleButton = _interopRequireDefault(require("../../elements/AccessibleButton"));

var Email = _interopRequireWildcard(require("../../../../email"));

var _AddThreepid = _interopRequireDefault(require("../../../../AddThreepid"));

var _Modal = _interopRequireDefault(require("../../../../Modal"));

var _replaceableComponent = require("../../../../utils/replaceableComponent");

var _ErrorDialog = _interopRequireDefault(require("../../dialogs/ErrorDialog"));

var _threepids = require("matrix-js-sdk/src/@types/threepids");

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

class ExistingEmailAddress extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onRemove", e => {
      e.stopPropagation();
      e.preventDefault();
      this.setState({
        verifyRemove: true
      });
    });
    (0, _defineProperty2.default)(this, "onDontRemove", e => {
      e.stopPropagation();
      e.preventDefault();
      this.setState({
        verifyRemove: false
      });
    });
    (0, _defineProperty2.default)(this, "onActuallyRemove", e => {
      e.stopPropagation();
      e.preventDefault();

      _MatrixClientPeg.MatrixClientPeg.get().deleteThreePid(this.props.email.medium, this.props.email.address).then(() => {
        return this.props.onRemoved(this.props.email);
      }).catch(err => {
        _logger.logger.error("Unable to remove contact information: " + err);

        _Modal.default.createTrackedDialog('Remove 3pid failed', '', _ErrorDialog.default, {
          title: (0, _languageHandler._t)("Unable to remove contact information"),
          description: err && err.message ? err.message : (0, _languageHandler._t)("Operation failed")
        });
      });
    });
    this.state = {
      verifyRemove: false
    };
  }

  render() {
    if (this.state.verifyRemove) {
      return /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_ExistingEmailAddress"
      }, /*#__PURE__*/_react.default.createElement("span", {
        className: "mx_ExistingEmailAddress_promptText"
      }, (0, _languageHandler._t)("Remove %(email)s?", {
        email: this.props.email.address
      })), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        onClick: this.onActuallyRemove,
        kind: "danger_sm",
        className: "mx_ExistingEmailAddress_confirmBtn"
      }, (0, _languageHandler._t)("Remove")), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        onClick: this.onDontRemove,
        kind: "link_sm",
        className: "mx_ExistingEmailAddress_confirmBtn"
      }, (0, _languageHandler._t)("Cancel")));
    }

    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_ExistingEmailAddress"
    }, /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_ExistingEmailAddress_email"
    }, this.props.email.address), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      onClick: this.onRemove,
      kind: "danger_sm"
    }, (0, _languageHandler._t)("Remove")));
  }

}

exports.ExistingEmailAddress = ExistingEmailAddress;
let EmailAddresses = (_dec = (0, _replaceableComponent.replaceableComponent)("views.settings.account.EmailAddresses"), _dec(_class = class EmailAddresses extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onRemoved", address => {
      const emails = this.props.emails.filter(e => e !== address);
      this.props.onEmailsChange(emails);
    });
    (0, _defineProperty2.default)(this, "onChangeNewEmailAddress", e => {
      this.setState({
        newEmailAddress: e.target.value
      });
    });
    (0, _defineProperty2.default)(this, "onAddClick", e => {
      e.stopPropagation();
      e.preventDefault();
      if (!this.state.newEmailAddress) return;
      const email = this.state.newEmailAddress; // TODO: Inline field validation

      if (!Email.looksValid(email)) {
        _Modal.default.createTrackedDialog('Invalid email address', '', _ErrorDialog.default, {
          title: (0, _languageHandler._t)("Invalid Email Address"),
          description: (0, _languageHandler._t)("This doesn't appear to be a valid email address")
        });

        return;
      }

      const task = new _AddThreepid.default();
      this.setState({
        verifying: true,
        continueDisabled: true,
        addTask: task
      });
      task.addEmailAddress(email).then(() => {
        this.setState({
          continueDisabled: false
        });
      }).catch(err => {
        _logger.logger.error("Unable to add email address " + email + " " + err);

        this.setState({
          verifying: false,
          continueDisabled: false,
          addTask: null
        });

        _Modal.default.createTrackedDialog('Unable to add email address', '', _ErrorDialog.default, {
          title: (0, _languageHandler._t)("Unable to add email address"),
          description: err && err.message ? err.message : (0, _languageHandler._t)("Operation failed")
        });
      });
    });
    (0, _defineProperty2.default)(this, "onContinueClick", e => {
      e.stopPropagation();
      e.preventDefault();
      this.setState({
        continueDisabled: true
      });
      this.state.addTask.checkEmailLinkClicked().then(([finished]) => {
        let newEmailAddress = this.state.newEmailAddress;

        if (finished) {
          const email = this.state.newEmailAddress;
          const emails = [...this.props.emails, {
            address: email,
            medium: _threepids.ThreepidMedium.Email
          }];
          this.props.onEmailsChange(emails);
          newEmailAddress = "";
        }

        this.setState({
          addTask: null,
          continueDisabled: false,
          verifying: false,
          newEmailAddress
        });
      }).catch(err => {
        this.setState({
          continueDisabled: false
        });

        if (err.errcode === 'M_THREEPID_AUTH_FAILED') {
          _Modal.default.createTrackedDialog("Email hasn't been verified yet", "", _ErrorDialog.default, {
            title: (0, _languageHandler._t)("Your email address hasn't been verified yet"),
            description: (0, _languageHandler._t)("Click the link in the email you received to verify " + "and then click continue again.")
          });
        } else {
          _logger.logger.error("Unable to verify email address: ", err);

          _Modal.default.createTrackedDialog('Unable to verify email address', '', _ErrorDialog.default, {
            title: (0, _languageHandler._t)("Unable to verify email address."),
            description: err && err.message ? err.message : (0, _languageHandler._t)("Operation failed")
          });
        }
      });
    });
    this.state = {
      verifying: false,
      addTask: null,
      continueDisabled: false,
      newEmailAddress: ""
    };
  }

  render() {
    const existingEmailElements = this.props.emails.map(e => {
      return /*#__PURE__*/_react.default.createElement(ExistingEmailAddress, {
        email: e,
        onRemoved: this.onRemoved,
        key: e.address
      });
    });

    let addButton = /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      onClick: this.onAddClick,
      kind: "primary"
    }, (0, _languageHandler._t)("Add"));

    if (this.state.verifying) {
      addButton = /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("div", null, (0, _languageHandler._t)("We've sent you an email to verify your address. Please follow the instructions there and then click the button below.")), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        onClick: this.onContinueClick,
        kind: "primary",
        disabled: this.state.continueDisabled
      }, (0, _languageHandler._t)("Continue")));
    }

    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_EmailAddresses"
    }, existingEmailElements, /*#__PURE__*/_react.default.createElement("form", {
      onSubmit: this.onAddClick,
      autoComplete: "off",
      noValidate: true,
      className: "mx_EmailAddresses_new"
    }, /*#__PURE__*/_react.default.createElement(_Field.default, {
      type: "text",
      label: (0, _languageHandler._t)("Email Address"),
      autoComplete: "off",
      disabled: this.state.verifying,
      value: this.state.newEmailAddress,
      onChange: this.onChangeNewEmailAddress
    }), addButton));
  }

}) || _class);
exports.default = EmailAddresses;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3NldHRpbmdzL2FjY291bnQvRW1haWxBZGRyZXNzZXMudHN4Il0sIm5hbWVzIjpbIkV4aXN0aW5nRW1haWxBZGRyZXNzIiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwiZSIsInN0b3BQcm9wYWdhdGlvbiIsInByZXZlbnREZWZhdWx0Iiwic2V0U3RhdGUiLCJ2ZXJpZnlSZW1vdmUiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJkZWxldGVUaHJlZVBpZCIsImVtYWlsIiwibWVkaXVtIiwiYWRkcmVzcyIsInRoZW4iLCJvblJlbW92ZWQiLCJjYXRjaCIsImVyciIsImxvZ2dlciIsImVycm9yIiwiTW9kYWwiLCJjcmVhdGVUcmFja2VkRGlhbG9nIiwiRXJyb3JEaWFsb2ciLCJ0aXRsZSIsImRlc2NyaXB0aW9uIiwibWVzc2FnZSIsInN0YXRlIiwicmVuZGVyIiwib25BY3R1YWxseVJlbW92ZSIsIm9uRG9udFJlbW92ZSIsIm9uUmVtb3ZlIiwiRW1haWxBZGRyZXNzZXMiLCJlbWFpbHMiLCJmaWx0ZXIiLCJvbkVtYWlsc0NoYW5nZSIsIm5ld0VtYWlsQWRkcmVzcyIsInRhcmdldCIsInZhbHVlIiwiRW1haWwiLCJsb29rc1ZhbGlkIiwidGFzayIsIkFkZFRocmVlcGlkIiwidmVyaWZ5aW5nIiwiY29udGludWVEaXNhYmxlZCIsImFkZFRhc2siLCJhZGRFbWFpbEFkZHJlc3MiLCJjaGVja0VtYWlsTGlua0NsaWNrZWQiLCJmaW5pc2hlZCIsIlRocmVlcGlkTWVkaXVtIiwiZXJyY29kZSIsImV4aXN0aW5nRW1haWxFbGVtZW50cyIsIm1hcCIsImFkZEJ1dHRvbiIsIm9uQWRkQ2xpY2siLCJvbkNvbnRpbnVlQ2xpY2siLCJvbkNoYW5nZU5ld0VtYWlsQWRkcmVzcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFpQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FB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QjtBQUh6QixTQUtNLHlCQUFHLFVBQUgsQ0FMTixDQUZKLENBREo7QUFZSDs7QUFFRCx3QkFDSTtBQUFLLE1BQUEsU0FBUyxFQUFDO0FBQWYsT0FDTU8scUJBRE4sZUFFSTtBQUNJLE1BQUEsUUFBUSxFQUFFLEtBQUtHLFVBRG5CO0FBRUksTUFBQSxZQUFZLEVBQUMsS0FGakI7QUFHSSxNQUFBLFVBQVUsRUFBRSxJQUhoQjtBQUlJLE1BQUEsU0FBUyxFQUFDO0FBSmQsb0JBTUksNkJBQUMsY0FBRDtBQUNJLE1BQUEsSUFBSSxFQUFDLE1BRFQ7QUFFSSxNQUFBLEtBQUssRUFBRSx5QkFBRyxlQUFILENBRlg7QUFHSSxNQUFBLFlBQVksRUFBQyxLQUhqQjtBQUlJLE1BQUEsUUFBUSxFQUFFLEtBQUszQixLQUFMLENBQVdnQixTQUp6QjtBQUtJLE1BQUEsS0FBSyxFQUFFLEtBQUtoQixLQUFMLENBQVdTLGVBTHRCO0FBTUksTUFBQSxRQUFRLEVBQUUsS0FBS29CO0FBTm5CLE1BTkosRUFjTUgsU0FkTixDQUZKLENBREo7QUFxQkg7O0FBN0l1RSxDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE5IE5ldyBWZWN0b3IgTHRkXG5Db3B5cmlnaHQgMjAxOSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBfdCB9IGZyb20gXCIuLi8uLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXJcIjtcbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gXCIuLi8uLi8uLi8uLi9NYXRyaXhDbGllbnRQZWdcIjtcbmltcG9ydCBGaWVsZCBmcm9tIFwiLi4vLi4vZWxlbWVudHMvRmllbGRcIjtcbmltcG9ydCBBY2Nlc3NpYmxlQnV0dG9uIGZyb20gXCIuLi8uLi9lbGVtZW50cy9BY2Nlc3NpYmxlQnV0dG9uXCI7XG5pbXBvcnQgKiBhcyBFbWFpbCBmcm9tIFwiLi4vLi4vLi4vLi4vZW1haWxcIjtcbmltcG9ydCBBZGRUaHJlZXBpZCBmcm9tIFwiLi4vLi4vLi4vLi4vQWRkVGhyZWVwaWRcIjtcbmltcG9ydCBNb2RhbCBmcm9tICcuLi8uLi8uLi8uLi9Nb2RhbCc7XG5pbXBvcnQgeyByZXBsYWNlYWJsZUNvbXBvbmVudCB9IGZyb20gXCIuLi8uLi8uLi8uLi91dGlscy9yZXBsYWNlYWJsZUNvbXBvbmVudFwiO1xuaW1wb3J0IEVycm9yRGlhbG9nIGZyb20gXCIuLi8uLi9kaWFsb2dzL0Vycm9yRGlhbG9nXCI7XG5pbXBvcnQgeyBJVGhyZWVwaWQsIFRocmVlcGlkTWVkaXVtIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL0B0eXBlcy90aHJlZXBpZHNcIjtcblxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2xvZ2dlclwiO1xuXG4vKlxuVE9ETzogSW1wcm92ZSB0aGUgVVggZm9yIGV2ZXJ5dGhpbmcgaW4gaGVyZS5cbkl0J3MgdmVyeSBtdWNoIHBsYWNlaG9sZGVyLCBidXQgaXQgZ2V0cyB0aGUgam9iIGRvbmUuIFRoZSBvbGQgd2F5IG9mIGhhbmRsaW5nXG5lbWFpbCBhZGRyZXNzZXMgaW4gdXNlciBzZXR0aW5ncyB3YXMgdG8gdXNlIGRpYWxvZ3MgdG8gY29tbXVuaWNhdGUgc3RhdGUsIGhvd2V2ZXJcbmR1ZSB0byBvdXIgZGlhbG9nIHN5c3RlbSBvdmVycmlkaW5nIGRpYWxvZ3MgKGNhdXNpbmcgdW5tb3VudHMpIHRoaXMgY3JlYXRlcyBwcm9ibGVtc1xuZm9yIGEgc2FuZSBVWC4gRm9yIGluc3RhbmNlLCB0aGUgdXNlciBjb3VsZCBlYXNpbHkgZW5kIHVwIGVudGVyaW5nIGFuIGVtYWlsIGFkZHJlc3NcbmFuZCByZWNlaXZlIGEgZGlhbG9nIHRvIHZlcmlmeSB0aGUgYWRkcmVzcywgd2hpY2ggdGhlbiBjYXVzZXMgdGhlIGNvbXBvbmVudCBoZXJlXG50byBmb3JnZXQgd2hhdCBpdCB3YXMgZG9pbmcgYW5kIHVsdGltYXRlbHkgZmFpbC4gRGlhbG9ncyBhcmUgc3RpbGwgdXNlZCBpbiBzb21lXG5wbGFjZXMgdG8gY29tbXVuaWNhdGUgZXJyb3JzIC0gdGhlc2Ugc2hvdWxkIGJlIHJlcGxhY2VkIHdpdGggaW5saW5lIHZhbGlkYXRpb24gd2hlblxudGhhdCBpcyBhdmFpbGFibGUuXG4gKi9cblxuaW50ZXJmYWNlIElFeGlzdGluZ0VtYWlsQWRkcmVzc1Byb3BzIHtcbiAgICBlbWFpbDogSVRocmVlcGlkO1xuICAgIG9uUmVtb3ZlZDogKGVtYWlsczogSVRocmVlcGlkKSA9PiB2b2lkO1xufVxuXG5pbnRlcmZhY2UgSUV4aXN0aW5nRW1haWxBZGRyZXNzU3RhdGUge1xuICAgIHZlcmlmeVJlbW92ZTogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGNsYXNzIEV4aXN0aW5nRW1haWxBZGRyZXNzIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PElFeGlzdGluZ0VtYWlsQWRkcmVzc1Byb3BzLCBJRXhpc3RpbmdFbWFpbEFkZHJlc3NTdGF0ZT4ge1xuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBJRXhpc3RpbmdFbWFpbEFkZHJlc3NQcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG5cbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIHZlcmlmeVJlbW92ZTogZmFsc2UsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvblJlbW92ZSA9IChlOiBSZWFjdC5Nb3VzZUV2ZW50KTogdm9pZCA9PiB7XG4gICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgICB0aGlzLnNldFN0YXRlKHsgdmVyaWZ5UmVtb3ZlOiB0cnVlIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uRG9udFJlbW92ZSA9IChlOiBSZWFjdC5Nb3VzZUV2ZW50KTogdm9pZCA9PiB7XG4gICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgICB0aGlzLnNldFN0YXRlKHsgdmVyaWZ5UmVtb3ZlOiBmYWxzZSB9KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkFjdHVhbGx5UmVtb3ZlID0gKGU6IFJlYWN0Lk1vdXNlRXZlbnQpOiB2b2lkID0+IHtcbiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAgIE1hdHJpeENsaWVudFBlZy5nZXQoKS5kZWxldGVUaHJlZVBpZCh0aGlzLnByb3BzLmVtYWlsLm1lZGl1bSwgdGhpcy5wcm9wcy5lbWFpbC5hZGRyZXNzKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnByb3BzLm9uUmVtb3ZlZCh0aGlzLnByb3BzLmVtYWlsKTtcbiAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKFwiVW5hYmxlIHRvIHJlbW92ZSBjb250YWN0IGluZm9ybWF0aW9uOiBcIiArIGVycik7XG4gICAgICAgICAgICBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nKCdSZW1vdmUgM3BpZCBmYWlsZWQnLCAnJywgRXJyb3JEaWFsb2csIHtcbiAgICAgICAgICAgICAgICB0aXRsZTogX3QoXCJVbmFibGUgdG8gcmVtb3ZlIGNvbnRhY3QgaW5mb3JtYXRpb25cIiksXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICgoZXJyICYmIGVyci5tZXNzYWdlKSA/IGVyci5tZXNzYWdlIDogX3QoXCJPcGVyYXRpb24gZmFpbGVkXCIpKSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgcHVibGljIHJlbmRlcigpOiBKU1guRWxlbWVudCB7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnZlcmlmeVJlbW92ZSkge1xuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0V4aXN0aW5nRW1haWxBZGRyZXNzXCI+XG4gICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT1cIm14X0V4aXN0aW5nRW1haWxBZGRyZXNzX3Byb21wdFRleHRcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCJSZW1vdmUgJShlbWFpbClzP1wiLCB7IGVtYWlsOiB0aGlzLnByb3BzLmVtYWlsLmFkZHJlc3MgfSApIH1cbiAgICAgICAgICAgICAgICAgICAgPC9zcGFuPlxuICAgICAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvblxuICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5vbkFjdHVhbGx5UmVtb3ZlfVxuICAgICAgICAgICAgICAgICAgICAgICAga2luZD1cImRhbmdlcl9zbVwiXG4gICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9FeGlzdGluZ0VtYWlsQWRkcmVzc19jb25maXJtQnRuXCJcbiAgICAgICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIlJlbW92ZVwiKSB9XG4gICAgICAgICAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj5cbiAgICAgICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b25cbiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s9e3RoaXMub25Eb250UmVtb3ZlfVxuICAgICAgICAgICAgICAgICAgICAgICAga2luZD1cImxpbmtfc21cIlxuICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfRXhpc3RpbmdFbWFpbEFkZHJlc3NfY29uZmlybUJ0blwiXG4gICAgICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCJDYW5jZWxcIikgfVxuICAgICAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfRXhpc3RpbmdFbWFpbEFkZHJlc3NcIj5cbiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9XCJteF9FeGlzdGluZ0VtYWlsQWRkcmVzc19lbWFpbFwiPnsgdGhpcy5wcm9wcy5lbWFpbC5hZGRyZXNzIH08L3NwYW4+XG4gICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b24gb25DbGljaz17dGhpcy5vblJlbW92ZX0ga2luZD1cImRhbmdlcl9zbVwiPlxuICAgICAgICAgICAgICAgICAgICB7IF90KFwiUmVtb3ZlXCIpIH1cbiAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKTtcbiAgICB9XG59XG5cbmludGVyZmFjZSBJUHJvcHMge1xuICAgIGVtYWlsczogSVRocmVlcGlkW107XG4gICAgb25FbWFpbHNDaGFuZ2U6IChlbWFpbHM6IFBhcnRpYWw8SVRocmVlcGlkPltdKSA9PiB2b2lkO1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICB2ZXJpZnlpbmc6IGJvb2xlYW47XG4gICAgYWRkVGFzazogYW55OyAvLyBGSVhNRTogV2hlbiBBZGRUaHJlZXBpZCBpcyBUU2ZpZWRcbiAgICBjb250aW51ZURpc2FibGVkOiBib29sZWFuO1xuICAgIG5ld0VtYWlsQWRkcmVzczogc3RyaW5nO1xufVxuXG5AcmVwbGFjZWFibGVDb21wb25lbnQoXCJ2aWV3cy5zZXR0aW5ncy5hY2NvdW50LkVtYWlsQWRkcmVzc2VzXCIpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBFbWFpbEFkZHJlc3NlcyBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxJUHJvcHMsIElTdGF0ZT4ge1xuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBJUHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuXG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICB2ZXJpZnlpbmc6IGZhbHNlLFxuICAgICAgICAgICAgYWRkVGFzazogbnVsbCxcbiAgICAgICAgICAgIGNvbnRpbnVlRGlzYWJsZWQ6IGZhbHNlLFxuICAgICAgICAgICAgbmV3RW1haWxBZGRyZXNzOiBcIlwiLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgb25SZW1vdmVkID0gKGFkZHJlc3MpOiB2b2lkID0+IHtcbiAgICAgICAgY29uc3QgZW1haWxzID0gdGhpcy5wcm9wcy5lbWFpbHMuZmlsdGVyKChlKSA9PiBlICE9PSBhZGRyZXNzKTtcbiAgICAgICAgdGhpcy5wcm9wcy5vbkVtYWlsc0NoYW5nZShlbWFpbHMpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uQ2hhbmdlTmV3RW1haWxBZGRyZXNzID0gKGU6IFJlYWN0LkNoYW5nZUV2ZW50PEhUTUxJbnB1dEVsZW1lbnQ+KTogdm9pZCA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgbmV3RW1haWxBZGRyZXNzOiBlLnRhcmdldC52YWx1ZSxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25BZGRDbGljayA9IChlOiBSZWFjdC5Gb3JtRXZlbnQpOiB2b2lkID0+IHtcbiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAgIGlmICghdGhpcy5zdGF0ZS5uZXdFbWFpbEFkZHJlc3MpIHJldHVybjtcblxuICAgICAgICBjb25zdCBlbWFpbCA9IHRoaXMuc3RhdGUubmV3RW1haWxBZGRyZXNzO1xuXG4gICAgICAgIC8vIFRPRE86IElubGluZSBmaWVsZCB2YWxpZGF0aW9uXG4gICAgICAgIGlmICghRW1haWwubG9va3NWYWxpZChlbWFpbCkpIHtcbiAgICAgICAgICAgIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coJ0ludmFsaWQgZW1haWwgYWRkcmVzcycsICcnLCBFcnJvckRpYWxvZywge1xuICAgICAgICAgICAgICAgIHRpdGxlOiBfdChcIkludmFsaWQgRW1haWwgQWRkcmVzc1wiKSxcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogX3QoXCJUaGlzIGRvZXNuJ3QgYXBwZWFyIHRvIGJlIGEgdmFsaWQgZW1haWwgYWRkcmVzc1wiKSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdGFzayA9IG5ldyBBZGRUaHJlZXBpZCgpO1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgdmVyaWZ5aW5nOiB0cnVlLCBjb250aW51ZURpc2FibGVkOiB0cnVlLCBhZGRUYXNrOiB0YXNrIH0pO1xuXG4gICAgICAgIHRhc2suYWRkRW1haWxBZGRyZXNzKGVtYWlsKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBjb250aW51ZURpc2FibGVkOiBmYWxzZSB9KTtcbiAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKFwiVW5hYmxlIHRvIGFkZCBlbWFpbCBhZGRyZXNzIFwiICsgZW1haWwgKyBcIiBcIiArIGVycik7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgdmVyaWZ5aW5nOiBmYWxzZSwgY29udGludWVEaXNhYmxlZDogZmFsc2UsIGFkZFRhc2s6IG51bGwgfSk7XG4gICAgICAgICAgICBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nKCdVbmFibGUgdG8gYWRkIGVtYWlsIGFkZHJlc3MnLCAnJywgRXJyb3JEaWFsb2csIHtcbiAgICAgICAgICAgICAgICB0aXRsZTogX3QoXCJVbmFibGUgdG8gYWRkIGVtYWlsIGFkZHJlc3NcIiksXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICgoZXJyICYmIGVyci5tZXNzYWdlKSA/IGVyci5tZXNzYWdlIDogX3QoXCJPcGVyYXRpb24gZmFpbGVkXCIpKSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkNvbnRpbnVlQ2xpY2sgPSAoZTogUmVhY3QuTW91c2VFdmVudCk6IHZvaWQgPT4ge1xuICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGNvbnRpbnVlRGlzYWJsZWQ6IHRydWUgfSk7XG4gICAgICAgIHRoaXMuc3RhdGUuYWRkVGFzay5jaGVja0VtYWlsTGlua0NsaWNrZWQoKS50aGVuKChbZmluaXNoZWRdKSA9PiB7XG4gICAgICAgICAgICBsZXQgbmV3RW1haWxBZGRyZXNzID0gdGhpcy5zdGF0ZS5uZXdFbWFpbEFkZHJlc3M7XG4gICAgICAgICAgICBpZiAoZmluaXNoZWQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBlbWFpbCA9IHRoaXMuc3RhdGUubmV3RW1haWxBZGRyZXNzO1xuICAgICAgICAgICAgICAgIGNvbnN0IGVtYWlscyA9IFtcbiAgICAgICAgICAgICAgICAgICAgLi4udGhpcy5wcm9wcy5lbWFpbHMsXG4gICAgICAgICAgICAgICAgICAgIHsgYWRkcmVzczogZW1haWwsIG1lZGl1bTogVGhyZWVwaWRNZWRpdW0uRW1haWwgfSxcbiAgICAgICAgICAgICAgICBdO1xuICAgICAgICAgICAgICAgIHRoaXMucHJvcHMub25FbWFpbHNDaGFuZ2UoZW1haWxzKTtcbiAgICAgICAgICAgICAgICBuZXdFbWFpbEFkZHJlc3MgPSBcIlwiO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgYWRkVGFzazogbnVsbCxcbiAgICAgICAgICAgICAgICBjb250aW51ZURpc2FibGVkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICB2ZXJpZnlpbmc6IGZhbHNlLFxuICAgICAgICAgICAgICAgIG5ld0VtYWlsQWRkcmVzcyxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgY29udGludWVEaXNhYmxlZDogZmFsc2UgfSk7XG4gICAgICAgICAgICBpZiAoZXJyLmVycmNvZGUgPT09ICdNX1RIUkVFUElEX0FVVEhfRkFJTEVEJykge1xuICAgICAgICAgICAgICAgIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coXCJFbWFpbCBoYXNuJ3QgYmVlbiB2ZXJpZmllZCB5ZXRcIiwgXCJcIiwgRXJyb3JEaWFsb2csIHtcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6IF90KFwiWW91ciBlbWFpbCBhZGRyZXNzIGhhc24ndCBiZWVuIHZlcmlmaWVkIHlldFwiKSxcbiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IF90KFwiQ2xpY2sgdGhlIGxpbmsgaW4gdGhlIGVtYWlsIHlvdSByZWNlaXZlZCB0byB2ZXJpZnkgXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJhbmQgdGhlbiBjbGljayBjb250aW51ZSBhZ2Fpbi5cIiksXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihcIlVuYWJsZSB0byB2ZXJpZnkgZW1haWwgYWRkcmVzczogXCIsIGVycik7XG4gICAgICAgICAgICAgICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZygnVW5hYmxlIHRvIHZlcmlmeSBlbWFpbCBhZGRyZXNzJywgJycsIEVycm9yRGlhbG9nLCB7XG4gICAgICAgICAgICAgICAgICAgIHRpdGxlOiBfdChcIlVuYWJsZSB0byB2ZXJpZnkgZW1haWwgYWRkcmVzcy5cIiksXG4gICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAoKGVyciAmJiBlcnIubWVzc2FnZSkgPyBlcnIubWVzc2FnZSA6IF90KFwiT3BlcmF0aW9uIGZhaWxlZFwiKSksXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBwdWJsaWMgcmVuZGVyKCk6IEpTWC5FbGVtZW50IHtcbiAgICAgICAgY29uc3QgZXhpc3RpbmdFbWFpbEVsZW1lbnRzID0gdGhpcy5wcm9wcy5lbWFpbHMubWFwKChlKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gPEV4aXN0aW5nRW1haWxBZGRyZXNzIGVtYWlsPXtlfSBvblJlbW92ZWQ9e3RoaXMub25SZW1vdmVkfSBrZXk9e2UuYWRkcmVzc30gLz47XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGxldCBhZGRCdXR0b24gPSAoXG4gICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvbiBvbkNsaWNrPXt0aGlzLm9uQWRkQ2xpY2t9IGtpbmQ9XCJwcmltYXJ5XCI+XG4gICAgICAgICAgICAgICAgeyBfdChcIkFkZFwiKSB9XG4gICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICk7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnZlcmlmeWluZykge1xuICAgICAgICAgICAgYWRkQnV0dG9uID0gKFxuICAgICAgICAgICAgICAgIDxkaXY+XG4gICAgICAgICAgICAgICAgICAgIDxkaXY+eyBfdChcIldlJ3ZlIHNlbnQgeW91IGFuIGVtYWlsIHRvIHZlcmlmeSB5b3VyIGFkZHJlc3MuIFBsZWFzZSBmb2xsb3cgdGhlIGluc3RydWN0aW9ucyB0aGVyZSBhbmQgdGhlbiBjbGljayB0aGUgYnV0dG9uIGJlbG93LlwiKSB9PC9kaXY+XG4gICAgICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uXG4gICAgICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLm9uQ29udGludWVDbGlja31cbiAgICAgICAgICAgICAgICAgICAgICAgIGtpbmQ9XCJwcmltYXJ5XCJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVkPXt0aGlzLnN0YXRlLmNvbnRpbnVlRGlzYWJsZWR9XG4gICAgICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCJDb250aW51ZVwiKSB9XG4gICAgICAgICAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9FbWFpbEFkZHJlc3Nlc1wiPlxuICAgICAgICAgICAgICAgIHsgZXhpc3RpbmdFbWFpbEVsZW1lbnRzIH1cbiAgICAgICAgICAgICAgICA8Zm9ybVxuICAgICAgICAgICAgICAgICAgICBvblN1Ym1pdD17dGhpcy5vbkFkZENsaWNrfVxuICAgICAgICAgICAgICAgICAgICBhdXRvQ29tcGxldGU9XCJvZmZcIlxuICAgICAgICAgICAgICAgICAgICBub1ZhbGlkYXRlPXt0cnVlfVxuICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9FbWFpbEFkZHJlc3Nlc19uZXdcIlxuICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICAgICAgPEZpZWxkXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlPVwidGV4dFwiXG4gICAgICAgICAgICAgICAgICAgICAgICBsYWJlbD17X3QoXCJFbWFpbCBBZGRyZXNzXCIpfVxuICAgICAgICAgICAgICAgICAgICAgICAgYXV0b0NvbXBsZXRlPVwib2ZmXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVkPXt0aGlzLnN0YXRlLnZlcmlmeWluZ31cbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlPXt0aGlzLnN0YXRlLm5ld0VtYWlsQWRkcmVzc31cbiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2hhbmdlPXt0aGlzLm9uQ2hhbmdlTmV3RW1haWxBZGRyZXNzfVxuICAgICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgICAgICB7IGFkZEJ1dHRvbiB9XG4gICAgICAgICAgICAgICAgPC9mb3JtPlxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICk7XG4gICAgfVxufVxuIl19