"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _languageHandler = require("../../../../../languageHandler");

var _SdkConfig = _interopRequireDefault(require("../../../../../SdkConfig"));

var _MediaDeviceHandler = _interopRequireWildcard(require("../../../../../MediaDeviceHandler"));

var _Field = _interopRequireDefault(require("../../../elements/Field"));

var _AccessibleButton = _interopRequireDefault(require("../../../elements/AccessibleButton"));

var _MatrixClientPeg = require("../../../../../MatrixClientPeg");

var _Modal = _interopRequireDefault(require("../../../../../Modal"));

var _SettingLevel = require("../../../../../settings/SettingLevel");

var _replaceableComponent = require("../../../../../utils/replaceableComponent");

var _SettingsFlag = _interopRequireDefault(require("../../../elements/SettingsFlag"));

var _ErrorDialog = _interopRequireDefault(require("../../../dialogs/ErrorDialog"));

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

const getDefaultDevice = devices => {
  // Note we're looking for a device with deviceId 'default' but adding a device
  // with deviceId == the empty string: this is because Chrome gives us a device
  // with deviceId 'default', so we're looking for this, not the one we are adding.
  if (!devices.some(i => i.deviceId === 'default')) {
    devices.unshift({
      deviceId: '',
      label: (0, _languageHandler._t)('Default Device')
    });
    return '';
  } else {
    return 'default';
  }
};

let VoiceUserSettingsTab = (_dec = (0, _replaceableComponent.replaceableComponent)("views.settings.tabs.user.VoiceUserSettingsTab"), _dec(_class = class VoiceUserSettingsTab extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "refreshMediaDevices", async stream => {
      this.setState({
        mediaDevices: await _MediaDeviceHandler.default.getDevices(),
        [_MediaDeviceHandler.MediaDeviceKindEnum.AudioOutput]: _MediaDeviceHandler.default.getAudioOutput(),
        [_MediaDeviceHandler.MediaDeviceKindEnum.AudioInput]: _MediaDeviceHandler.default.getAudioInput(),
        [_MediaDeviceHandler.MediaDeviceKindEnum.VideoInput]: _MediaDeviceHandler.default.getVideoInput()
      });

      if (stream) {
        // kill stream (after we've enumerated the devices, otherwise we'd get empty labels again)
        // so that we don't leave it lingering around with webcam enabled etc
        // as here we called gUM to ask user for permission to their device names only
        stream.getTracks().forEach(track => track.stop());
      }
    });
    (0, _defineProperty2.default)(this, "requestMediaPermissions", async () => {
      let constraints;
      let stream;
      let error;

      try {
        constraints = {
          video: true,
          audio: true
        };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
      } catch (err) {
        // user likely doesn't have a webcam,
        // we should still allow to select a microphone
        if (err.name === "NotFoundError") {
          constraints = {
            audio: true
          };

          try {
            stream = await navigator.mediaDevices.getUserMedia(constraints);
          } catch (err) {
            error = err;
          }
        } else {
          error = err;
        }
      }

      if (error) {
        _logger.logger.log("Failed to list userMedia devices", error);

        const brand = _SdkConfig.default.get().brand;

        _Modal.default.createTrackedDialog('No media permissions', '', _ErrorDialog.default, {
          title: (0, _languageHandler._t)('No media permissions'),
          description: (0, _languageHandler._t)('You may need to manually permit %(brand)s to access your microphone/webcam', {
            brand
          })
        });
      } else {
        this.refreshMediaDevices(stream);
      }
    });
    (0, _defineProperty2.default)(this, "setDevice", (deviceId, kind) => {
      _MediaDeviceHandler.default.instance.setDevice(deviceId, kind);

      this.setState({
        [kind]: deviceId
      });
    });
    (0, _defineProperty2.default)(this, "changeWebRtcMethod", p2p => {
      _MatrixClientPeg.MatrixClientPeg.get().setForceTURN(!p2p);
    });
    (0, _defineProperty2.default)(this, "changeFallbackICEServerAllowed", allow => {
      _MatrixClientPeg.MatrixClientPeg.get().setFallbackICEServerAllowed(allow);
    });
    this.state = {
      mediaDevices: null,
      [_MediaDeviceHandler.MediaDeviceKindEnum.AudioOutput]: null,
      [_MediaDeviceHandler.MediaDeviceKindEnum.AudioInput]: null,
      [_MediaDeviceHandler.MediaDeviceKindEnum.VideoInput]: null
    };
  }

  async componentDidMount() {
    const canSeeDeviceLabels = await _MediaDeviceHandler.default.hasAnyLabeledDevices();

    if (canSeeDeviceLabels) {
      this.refreshMediaDevices();
    }
  }

  renderDeviceOptions(devices, category) {
    return devices.map(d => {
      return /*#__PURE__*/_react.default.createElement("option", {
        key: `${category}-${d.deviceId}`,
        value: d.deviceId
      }, d.label);
    });
  }

  renderDropdown(kind, label) {
    const devices = this.state.mediaDevices[kind].slice(0);
    if (devices.length === 0) return null;
    const defaultDevice = getDefaultDevice(devices);
    return /*#__PURE__*/_react.default.createElement(_Field.default, {
      element: "select",
      label: label,
      value: this.state[kind] || defaultDevice,
      onChange: e => this.setDevice(e.target.value, kind)
    }, this.renderDeviceOptions(devices, kind));
  }

  render() {
    let requestButton = null;
    let speakerDropdown = null;
    let microphoneDropdown = null;
    let webcamDropdown = null;

    if (!this.state.mediaDevices) {
      requestButton = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_VoiceUserSettingsTab_missingMediaPermissions"
      }, /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Missing media permissions, click the button below to request.")), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        onClick: this.requestMediaPermissions,
        kind: "primary"
      }, (0, _languageHandler._t)("Request media permissions")));
    } else if (this.state.mediaDevices) {
      speakerDropdown = this.renderDropdown(_MediaDeviceHandler.MediaDeviceKindEnum.AudioOutput, (0, _languageHandler._t)("Audio Output")) || /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)('No Audio Outputs detected'));
      microphoneDropdown = this.renderDropdown(_MediaDeviceHandler.MediaDeviceKindEnum.AudioInput, (0, _languageHandler._t)("Microphone")) || /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)('No Microphones detected'));
      webcamDropdown = this.renderDropdown(_MediaDeviceHandler.MediaDeviceKindEnum.VideoInput, (0, _languageHandler._t)("Camera")) || /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)('No Webcams detected'));
    }

    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_SettingsTab mx_VoiceUserSettingsTab"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_SettingsTab_heading"
    }, (0, _languageHandler._t)("Voice & Video")), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_SettingsTab_section"
    }, requestButton, speakerDropdown, microphoneDropdown, webcamDropdown, /*#__PURE__*/_react.default.createElement(_SettingsFlag.default, {
      name: "VideoView.flipVideoHorizontally",
      level: _SettingLevel.SettingLevel.ACCOUNT
    }), /*#__PURE__*/_react.default.createElement(_SettingsFlag.default, {
      name: "webRtcAllowPeerToPeer",
      level: _SettingLevel.SettingLevel.DEVICE,
      onChange: this.changeWebRtcMethod
    }), /*#__PURE__*/_react.default.createElement(_SettingsFlag.default, {
      name: "fallbackICEServerAllowed",
      level: _SettingLevel.SettingLevel.DEVICE,
      onChange: this.changeFallbackICEServerAllowed
    })));
  }

}) || _class);
exports.default = VoiceUserSettingsTab;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3NldHRpbmdzL3RhYnMvdXNlci9Wb2ljZVVzZXJTZXR0aW5nc1RhYi50c3giXSwibmFtZXMiOlsiZ2V0RGVmYXVsdERldmljZSIsImRldmljZXMiLCJzb21lIiwiaSIsImRldmljZUlkIiwidW5zaGlmdCIsImxhYmVsIiwiVm9pY2VVc2VyU2V0dGluZ3NUYWIiLCJSZWFjdCIsIkNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJzdHJlYW0iLCJzZXRTdGF0ZSIsIm1lZGlhRGV2aWNlcyIsIk1lZGlhRGV2aWNlSGFuZGxlciIsImdldERldmljZXMiLCJNZWRpYURldmljZUtpbmRFbnVtIiwiQXVkaW9PdXRwdXQiLCJnZXRBdWRpb091dHB1dCIsIkF1ZGlvSW5wdXQiLCJnZXRBdWRpb0lucHV0IiwiVmlkZW9JbnB1dCIsImdldFZpZGVvSW5wdXQiLCJnZXRUcmFja3MiLCJmb3JFYWNoIiwidHJhY2siLCJzdG9wIiwiY29uc3RyYWludHMiLCJlcnJvciIsInZpZGVvIiwiYXVkaW8iLCJuYXZpZ2F0b3IiLCJnZXRVc2VyTWVkaWEiLCJlcnIiLCJuYW1lIiwibG9nZ2VyIiwibG9nIiwiYnJhbmQiLCJTZGtDb25maWciLCJnZXQiLCJNb2RhbCIsImNyZWF0ZVRyYWNrZWREaWFsb2ciLCJFcnJvckRpYWxvZyIsInRpdGxlIiwiZGVzY3JpcHRpb24iLCJyZWZyZXNoTWVkaWFEZXZpY2VzIiwia2luZCIsImluc3RhbmNlIiwic2V0RGV2aWNlIiwicDJwIiwiTWF0cml4Q2xpZW50UGVnIiwic2V0Rm9yY2VUVVJOIiwiYWxsb3ciLCJzZXRGYWxsYmFja0lDRVNlcnZlckFsbG93ZWQiLCJzdGF0ZSIsImNvbXBvbmVudERpZE1vdW50IiwiY2FuU2VlRGV2aWNlTGFiZWxzIiwiaGFzQW55TGFiZWxlZERldmljZXMiLCJyZW5kZXJEZXZpY2VPcHRpb25zIiwiY2F0ZWdvcnkiLCJtYXAiLCJkIiwicmVuZGVyRHJvcGRvd24iLCJzbGljZSIsImxlbmd0aCIsImRlZmF1bHREZXZpY2UiLCJlIiwidGFyZ2V0IiwidmFsdWUiLCJyZW5kZXIiLCJyZXF1ZXN0QnV0dG9uIiwic3BlYWtlckRyb3Bkb3duIiwibWljcm9waG9uZURyb3Bkb3duIiwid2ViY2FtRHJvcGRvd24iLCJyZXF1ZXN0TWVkaWFQZXJtaXNzaW9ucyIsIlNldHRpbmdMZXZlbCIsIkFDQ09VTlQiLCJERVZJQ0UiLCJjaGFuZ2VXZWJSdGNNZXRob2QiLCJjaGFuZ2VGYWxsYmFja0lDRVNlcnZlckFsbG93ZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBaUJBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOzs7Ozs7OztBQUVBLE1BQU1BLGdCQUFnQixHQUFJQyxPQUFELElBQThDO0FBQ25FO0FBQ0E7QUFDQTtBQUNBLE1BQUksQ0FBQ0EsT0FBTyxDQUFDQyxJQUFSLENBQWNDLENBQUQsSUFBT0EsQ0FBQyxDQUFDQyxRQUFGLEtBQWUsU0FBbkMsQ0FBTCxFQUFvRDtBQUNoREgsSUFBQUEsT0FBTyxDQUFDSSxPQUFSLENBQWdCO0FBQUVELE1BQUFBLFFBQVEsRUFBRSxFQUFaO0FBQWdCRSxNQUFBQSxLQUFLLEVBQUUseUJBQUcsZ0JBQUg7QUFBdkIsS0FBaEI7QUFDQSxXQUFPLEVBQVA7QUFDSCxHQUhELE1BR087QUFDSCxXQUFPLFNBQVA7QUFDSDtBQUNKLENBVkQ7O0lBaUJxQkMsb0IsV0FEcEIsZ0RBQXFCLCtDQUFyQixDLGdCQUFELE1BQ3FCQSxvQkFEckIsU0FDa0RDLGVBQU1DLFNBRHhELENBQzhFO0FBQzFFQyxFQUFBQSxXQUFXLENBQUNDLEtBQUQsRUFBWTtBQUNuQixVQUFNQSxLQUFOO0FBRG1CLCtEQWtCTyxNQUFPQyxNQUFQLElBQStDO0FBQ3pFLFdBQUtDLFFBQUwsQ0FBYztBQUNWQyxRQUFBQSxZQUFZLEVBQUUsTUFBTUMsNEJBQW1CQyxV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LE9BQ01pRCxhQUROLEVBRU1DLGVBRk4sRUFHTUMsa0JBSE4sRUFJTUMsY0FKTixlQUtJLDZCQUFDLHFCQUFEO0FBQWMsTUFBQSxJQUFJLEVBQUMsaUNBQW5CO0FBQXFELE1BQUEsS0FBSyxFQUFFRSwyQkFBYUM7QUFBekUsTUFMSixlQU1JLDZCQUFDLHFCQUFEO0FBQ0ksTUFBQSxJQUFJLEVBQUMsdUJBRFQ7QUFFSSxNQUFBLEtBQUssRUFBRUQsMkJBQWFFLE1BRnhCO0FBR0ksTUFBQSxRQUFRLEVBQUUsS0FBS0M7QUFIbkIsTUFOSixlQVdJLDZCQUFDLHFCQUFEO0FBQ0ksTUFBQSxJQUFJLEVBQUMsMEJBRFQ7QUFFSSxNQUFBLEtBQUssRUFBRUgsMkJBQWFFLE1BRnhCO0FBR0ksTUFBQSxRQUFRLEVBQUUsS0FBS0U7QUFIbkIsTUFYSixDQUZKLENBREo7QUFzQkg7O0FBN0p5RSxDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE5IE5ldyBWZWN0b3IgTHRkXG5Db3B5cmlnaHQgMjAyMCBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBfdCB9IGZyb20gXCIuLi8uLi8uLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXJcIjtcbmltcG9ydCBTZGtDb25maWcgZnJvbSBcIi4uLy4uLy4uLy4uLy4uL1Nka0NvbmZpZ1wiO1xuaW1wb3J0IE1lZGlhRGV2aWNlSGFuZGxlciwgeyBJTWVkaWFEZXZpY2VzLCBNZWRpYURldmljZUtpbmRFbnVtIH0gZnJvbSBcIi4uLy4uLy4uLy4uLy4uL01lZGlhRGV2aWNlSGFuZGxlclwiO1xuaW1wb3J0IEZpZWxkIGZyb20gXCIuLi8uLi8uLi9lbGVtZW50cy9GaWVsZFwiO1xuaW1wb3J0IEFjY2Vzc2libGVCdXR0b24gZnJvbSBcIi4uLy4uLy4uL2VsZW1lbnRzL0FjY2Vzc2libGVCdXR0b25cIjtcbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gXCIuLi8uLi8uLi8uLi8uLi9NYXRyaXhDbGllbnRQZWdcIjtcbmltcG9ydCBNb2RhbCBmcm9tIFwiLi4vLi4vLi4vLi4vLi4vTW9kYWxcIjtcbmltcG9ydCB7IFNldHRpbmdMZXZlbCB9IGZyb20gXCIuLi8uLi8uLi8uLi8uLi9zZXR0aW5ncy9TZXR0aW5nTGV2ZWxcIjtcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uLy4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5pbXBvcnQgU2V0dGluZ3NGbGFnIGZyb20gJy4uLy4uLy4uL2VsZW1lbnRzL1NldHRpbmdzRmxhZyc7XG5pbXBvcnQgRXJyb3JEaWFsb2cgZnJvbSAnLi4vLi4vLi4vZGlhbG9ncy9FcnJvckRpYWxvZyc7XG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcblxuY29uc3QgZ2V0RGVmYXVsdERldmljZSA9IChkZXZpY2VzOiBBcnJheTxQYXJ0aWFsPE1lZGlhRGV2aWNlSW5mbz4+KSA9PiB7XG4gICAgLy8gTm90ZSB3ZSdyZSBsb29raW5nIGZvciBhIGRldmljZSB3aXRoIGRldmljZUlkICdkZWZhdWx0JyBidXQgYWRkaW5nIGEgZGV2aWNlXG4gICAgLy8gd2l0aCBkZXZpY2VJZCA9PSB0aGUgZW1wdHkgc3RyaW5nOiB0aGlzIGlzIGJlY2F1c2UgQ2hyb21lIGdpdmVzIHVzIGEgZGV2aWNlXG4gICAgLy8gd2l0aCBkZXZpY2VJZCAnZGVmYXVsdCcsIHNvIHdlJ3JlIGxvb2tpbmcgZm9yIHRoaXMsIG5vdCB0aGUgb25lIHdlIGFyZSBhZGRpbmcuXG4gICAgaWYgKCFkZXZpY2VzLnNvbWUoKGkpID0+IGkuZGV2aWNlSWQgPT09ICdkZWZhdWx0JykpIHtcbiAgICAgICAgZGV2aWNlcy51bnNoaWZ0KHsgZGV2aWNlSWQ6ICcnLCBsYWJlbDogX3QoJ0RlZmF1bHQgRGV2aWNlJykgfSk7XG4gICAgICAgIHJldHVybiAnJztcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gJ2RlZmF1bHQnO1xuICAgIH1cbn07XG5cbmludGVyZmFjZSBJU3RhdGUgZXh0ZW5kcyBSZWNvcmQ8TWVkaWFEZXZpY2VLaW5kRW51bSwgc3RyaW5nPiB7XG4gICAgbWVkaWFEZXZpY2VzOiBJTWVkaWFEZXZpY2VzO1xufVxuXG5AcmVwbGFjZWFibGVDb21wb25lbnQoXCJ2aWV3cy5zZXR0aW5ncy50YWJzLnVzZXIuVm9pY2VVc2VyU2V0dGluZ3NUYWJcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFZvaWNlVXNlclNldHRpbmdzVGFiIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PHt9LCBJU3RhdGU+IHtcbiAgICBjb25zdHJ1Y3Rvcihwcm9wczoge30pIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuXG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICBtZWRpYURldmljZXM6IG51bGwsXG4gICAgICAgICAgICBbTWVkaWFEZXZpY2VLaW5kRW51bS5BdWRpb091dHB1dF06IG51bGwsXG4gICAgICAgICAgICBbTWVkaWFEZXZpY2VLaW5kRW51bS5BdWRpb0lucHV0XTogbnVsbCxcbiAgICAgICAgICAgIFtNZWRpYURldmljZUtpbmRFbnVtLlZpZGVvSW5wdXRdOiBudWxsLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIGFzeW5jIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgICAgICBjb25zdCBjYW5TZWVEZXZpY2VMYWJlbHMgPSBhd2FpdCBNZWRpYURldmljZUhhbmRsZXIuaGFzQW55TGFiZWxlZERldmljZXMoKTtcbiAgICAgICAgaWYgKGNhblNlZURldmljZUxhYmVscykge1xuICAgICAgICAgICAgdGhpcy5yZWZyZXNoTWVkaWFEZXZpY2VzKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHJlZnJlc2hNZWRpYURldmljZXMgPSBhc3luYyAoc3RyZWFtPzogTWVkaWFTdHJlYW0pOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBtZWRpYURldmljZXM6IGF3YWl0IE1lZGlhRGV2aWNlSGFuZGxlci5nZXREZXZpY2VzKCksXG4gICAgICAgICAgICBbTWVkaWFEZXZpY2VLaW5kRW51bS5BdWRpb091dHB1dF06IE1lZGlhRGV2aWNlSGFuZGxlci5nZXRBdWRpb091dHB1dCgpLFxuICAgICAgICAgICAgW01lZGlhRGV2aWNlS2luZEVudW0uQXVkaW9JbnB1dF06IE1lZGlhRGV2aWNlSGFuZGxlci5nZXRBdWRpb0lucHV0KCksXG4gICAgICAgICAgICBbTWVkaWFEZXZpY2VLaW5kRW51bS5WaWRlb0lucHV0XTogTWVkaWFEZXZpY2VIYW5kbGVyLmdldFZpZGVvSW5wdXQoKSxcbiAgICAgICAgfSk7XG4gICAgICAgIGlmIChzdHJlYW0pIHtcbiAgICAgICAgICAgIC8vIGtpbGwgc3RyZWFtIChhZnRlciB3ZSd2ZSBlbnVtZXJhdGVkIHRoZSBkZXZpY2VzLCBvdGhlcndpc2Ugd2UnZCBnZXQgZW1wdHkgbGFiZWxzIGFnYWluKVxuICAgICAgICAgICAgLy8gc28gdGhhdCB3ZSBkb24ndCBsZWF2ZSBpdCBsaW5nZXJpbmcgYXJvdW5kIHdpdGggd2ViY2FtIGVuYWJsZWQgZXRjXG4gICAgICAgICAgICAvLyBhcyBoZXJlIHdlIGNhbGxlZCBnVU0gdG8gYXNrIHVzZXIgZm9yIHBlcm1pc3Npb24gdG8gdGhlaXIgZGV2aWNlIG5hbWVzIG9ubHlcbiAgICAgICAgICAgIHN0cmVhbS5nZXRUcmFja3MoKS5mb3JFYWNoKCh0cmFjaykgPT4gdHJhY2suc3RvcCgpKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwcml2YXRlIHJlcXVlc3RNZWRpYVBlcm1pc3Npb25zID0gYXN5bmMgKCk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgICAgICBsZXQgY29uc3RyYWludHM7XG4gICAgICAgIGxldCBzdHJlYW07XG4gICAgICAgIGxldCBlcnJvcjtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0cmFpbnRzID0geyB2aWRlbzogdHJ1ZSwgYXVkaW86IHRydWUgfTtcbiAgICAgICAgICAgIHN0cmVhbSA9IGF3YWl0IG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKGNvbnN0cmFpbnRzKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAvLyB1c2VyIGxpa2VseSBkb2Vzbid0IGhhdmUgYSB3ZWJjYW0sXG4gICAgICAgICAgICAvLyB3ZSBzaG91bGQgc3RpbGwgYWxsb3cgdG8gc2VsZWN0IGEgbWljcm9waG9uZVxuICAgICAgICAgICAgaWYgKGVyci5uYW1lID09PSBcIk5vdEZvdW5kRXJyb3JcIikge1xuICAgICAgICAgICAgICAgIGNvbnN0cmFpbnRzID0geyBhdWRpbzogdHJ1ZSB9O1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIHN0cmVhbSA9IGF3YWl0IG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKGNvbnN0cmFpbnRzKTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgZXJyb3IgPSBlcnI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBlcnJvciA9IGVycjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgIGxvZ2dlci5sb2coXCJGYWlsZWQgdG8gbGlzdCB1c2VyTWVkaWEgZGV2aWNlc1wiLCBlcnJvcik7XG4gICAgICAgICAgICBjb25zdCBicmFuZCA9IFNka0NvbmZpZy5nZXQoKS5icmFuZDtcbiAgICAgICAgICAgIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coJ05vIG1lZGlhIHBlcm1pc3Npb25zJywgJycsIEVycm9yRGlhbG9nLCB7XG4gICAgICAgICAgICAgICAgdGl0bGU6IF90KCdObyBtZWRpYSBwZXJtaXNzaW9ucycpLFxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBfdChcbiAgICAgICAgICAgICAgICAgICAgJ1lvdSBtYXkgbmVlZCB0byBtYW51YWxseSBwZXJtaXQgJShicmFuZClzIHRvIGFjY2VzcyB5b3VyIG1pY3JvcGhvbmUvd2ViY2FtJyxcbiAgICAgICAgICAgICAgICAgICAgeyBicmFuZCB9LFxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucmVmcmVzaE1lZGlhRGV2aWNlcyhzdHJlYW0pO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIHByaXZhdGUgc2V0RGV2aWNlID0gKGRldmljZUlkOiBzdHJpbmcsIGtpbmQ6IE1lZGlhRGV2aWNlS2luZEVudW0pOiB2b2lkID0+IHtcbiAgICAgICAgTWVkaWFEZXZpY2VIYW5kbGVyLmluc3RhbmNlLnNldERldmljZShkZXZpY2VJZCwga2luZCk7XG4gICAgICAgIHRoaXMuc2V0U3RhdGU8bnVsbD4oeyBba2luZF06IGRldmljZUlkIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIGNoYW5nZVdlYlJ0Y01ldGhvZCA9IChwMnA6IGJvb2xlYW4pOiB2b2lkID0+IHtcbiAgICAgICAgTWF0cml4Q2xpZW50UGVnLmdldCgpLnNldEZvcmNlVFVSTighcDJwKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBjaGFuZ2VGYWxsYmFja0lDRVNlcnZlckFsbG93ZWQgPSAoYWxsb3c6IGJvb2xlYW4pOiB2b2lkID0+IHtcbiAgICAgICAgTWF0cml4Q2xpZW50UGVnLmdldCgpLnNldEZhbGxiYWNrSUNFU2VydmVyQWxsb3dlZChhbGxvdyk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgcmVuZGVyRGV2aWNlT3B0aW9ucyhkZXZpY2VzOiBBcnJheTxNZWRpYURldmljZUluZm8+LCBjYXRlZ29yeTogTWVkaWFEZXZpY2VLaW5kRW51bSk6IEFycmF5PEpTWC5FbGVtZW50PiB7XG4gICAgICAgIHJldHVybiBkZXZpY2VzLm1hcCgoZCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuICg8b3B0aW9uIGtleT17YCR7Y2F0ZWdvcnl9LSR7ZC5kZXZpY2VJZH1gfSB2YWx1ZT17ZC5kZXZpY2VJZH0+eyBkLmxhYmVsIH08L29wdGlvbj4pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlbmRlckRyb3Bkb3duKGtpbmQ6IE1lZGlhRGV2aWNlS2luZEVudW0sIGxhYmVsOiBzdHJpbmcpOiBKU1guRWxlbWVudCB7XG4gICAgICAgIGNvbnN0IGRldmljZXMgPSB0aGlzLnN0YXRlLm1lZGlhRGV2aWNlc1traW5kXS5zbGljZSgwKTtcbiAgICAgICAgaWYgKGRldmljZXMubGVuZ3RoID09PSAwKSByZXR1cm4gbnVsbDtcblxuICAgICAgICBjb25zdCBkZWZhdWx0RGV2aWNlID0gZ2V0RGVmYXVsdERldmljZShkZXZpY2VzKTtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxGaWVsZFxuICAgICAgICAgICAgICAgIGVsZW1lbnQ9XCJzZWxlY3RcIlxuICAgICAgICAgICAgICAgIGxhYmVsPXtsYWJlbH1cbiAgICAgICAgICAgICAgICB2YWx1ZT17dGhpcy5zdGF0ZVtraW5kXSB8fCBkZWZhdWx0RGV2aWNlfVxuICAgICAgICAgICAgICAgIG9uQ2hhbmdlPXsoZSkgPT4gdGhpcy5zZXREZXZpY2UoZS50YXJnZXQudmFsdWUsIGtpbmQpfVxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgIHsgdGhpcy5yZW5kZXJEZXZpY2VPcHRpb25zKGRldmljZXMsIGtpbmQpIH1cbiAgICAgICAgICAgIDwvRmllbGQ+XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcmVuZGVyKCkge1xuICAgICAgICBsZXQgcmVxdWVzdEJ1dHRvbiA9IG51bGw7XG4gICAgICAgIGxldCBzcGVha2VyRHJvcGRvd24gPSBudWxsO1xuICAgICAgICBsZXQgbWljcm9waG9uZURyb3Bkb3duID0gbnVsbDtcbiAgICAgICAgbGV0IHdlYmNhbURyb3Bkb3duID0gbnVsbDtcbiAgICAgICAgaWYgKCF0aGlzLnN0YXRlLm1lZGlhRGV2aWNlcykge1xuICAgICAgICAgICAgcmVxdWVzdEJ1dHRvbiA9IChcbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nbXhfVm9pY2VVc2VyU2V0dGluZ3NUYWJfbWlzc2luZ01lZGlhUGVybWlzc2lvbnMnPlxuICAgICAgICAgICAgICAgICAgICA8cD57IF90KFwiTWlzc2luZyBtZWRpYSBwZXJtaXNzaW9ucywgY2xpY2sgdGhlIGJ1dHRvbiBiZWxvdyB0byByZXF1ZXN0LlwiKSB9PC9wPlxuICAgICAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvbiBvbkNsaWNrPXt0aGlzLnJlcXVlc3RNZWRpYVBlcm1pc3Npb25zfSBraW5kPVwicHJpbWFyeVwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIlJlcXVlc3QgbWVkaWEgcGVybWlzc2lvbnNcIikgfVxuICAgICAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuc3RhdGUubWVkaWFEZXZpY2VzKSB7XG4gICAgICAgICAgICBzcGVha2VyRHJvcGRvd24gPSAoXG4gICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJEcm9wZG93bihNZWRpYURldmljZUtpbmRFbnVtLkF1ZGlvT3V0cHV0LCBfdChcIkF1ZGlvIE91dHB1dFwiKSkgfHxcbiAgICAgICAgICAgICAgICA8cD57IF90KCdObyBBdWRpbyBPdXRwdXRzIGRldGVjdGVkJykgfTwvcD5cbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBtaWNyb3Bob25lRHJvcGRvd24gPSAoXG4gICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJEcm9wZG93bihNZWRpYURldmljZUtpbmRFbnVtLkF1ZGlvSW5wdXQsIF90KFwiTWljcm9waG9uZVwiKSkgfHxcbiAgICAgICAgICAgICAgICA8cD57IF90KCdObyBNaWNyb3Bob25lcyBkZXRlY3RlZCcpIH08L3A+XG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgd2ViY2FtRHJvcGRvd24gPSAoXG4gICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJEcm9wZG93bihNZWRpYURldmljZUtpbmRFbnVtLlZpZGVvSW5wdXQsIF90KFwiQ2FtZXJhXCIpKSB8fFxuICAgICAgICAgICAgICAgIDxwPnsgX3QoJ05vIFdlYmNhbXMgZGV0ZWN0ZWQnKSB9PC9wPlxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X1NldHRpbmdzVGFiIG14X1ZvaWNlVXNlclNldHRpbmdzVGFiXCI+XG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9TZXR0aW5nc1RhYl9oZWFkaW5nXCI+eyBfdChcIlZvaWNlICYgVmlkZW9cIikgfTwvZGl2PlxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfU2V0dGluZ3NUYWJfc2VjdGlvblwiPlxuICAgICAgICAgICAgICAgICAgICB7IHJlcXVlc3RCdXR0b24gfVxuICAgICAgICAgICAgICAgICAgICB7IHNwZWFrZXJEcm9wZG93biB9XG4gICAgICAgICAgICAgICAgICAgIHsgbWljcm9waG9uZURyb3Bkb3duIH1cbiAgICAgICAgICAgICAgICAgICAgeyB3ZWJjYW1Ecm9wZG93biB9XG4gICAgICAgICAgICAgICAgICAgIDxTZXR0aW5nc0ZsYWcgbmFtZT0nVmlkZW9WaWV3LmZsaXBWaWRlb0hvcml6b250YWxseScgbGV2ZWw9e1NldHRpbmdMZXZlbC5BQ0NPVU5UfSAvPlxuICAgICAgICAgICAgICAgICAgICA8U2V0dGluZ3NGbGFnXG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lPSd3ZWJSdGNBbGxvd1BlZXJUb1BlZXInXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXZlbD17U2V0dGluZ0xldmVsLkRFVklDRX1cbiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2hhbmdlPXt0aGlzLmNoYW5nZVdlYlJ0Y01ldGhvZH1cbiAgICAgICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgICAgICAgPFNldHRpbmdzRmxhZ1xuICAgICAgICAgICAgICAgICAgICAgICAgbmFtZT0nZmFsbGJhY2tJQ0VTZXJ2ZXJBbGxvd2VkJ1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV2ZWw9e1NldHRpbmdMZXZlbC5ERVZJQ0V9XG4gICAgICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZT17dGhpcy5jaGFuZ2VGYWxsYmFja0lDRVNlcnZlckFsbG93ZWR9XG4gICAgICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=