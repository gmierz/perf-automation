"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.LabsSettingToggle = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _lodash = require("lodash");

var _languageHandler = require("../../../../../languageHandler");

var _SettingsStore = _interopRequireDefault(require("../../../../../settings/SettingsStore"));

var _LabelledToggleSwitch = _interopRequireDefault(require("../../../elements/LabelledToggleSwitch"));

var _SettingLevel = require("../../../../../settings/SettingLevel");

var _replaceableComponent = require("../../../../../utils/replaceableComponent");

var _SdkConfig = _interopRequireDefault(require("../../../../../SdkConfig"));

var _BetaCard = _interopRequireDefault(require("../../../beta/BetaCard"));

var _SettingsFlag = _interopRequireDefault(require("../../../elements/SettingsFlag"));

var _MatrixClientPeg = require("../../../../../MatrixClientPeg");

var _Settings = require("../../../../../settings/Settings");

var _maps = require("../../../../../utils/maps");

var _dec, _class;

class LabsSettingToggle extends _react.default.Component {
  constructor(...args) {
    super(...args);
    (0, _defineProperty2.default)(this, "onChange", async checked => {
      await _SettingsStore.default.setValue(this.props.featureId, null, _SettingLevel.SettingLevel.DEVICE, checked);
      this.forceUpdate();
    });
  }

  render() {
    const label = _SettingsStore.default.getDisplayName(this.props.featureId);

    const value = _SettingsStore.default.getValue(this.props.featureId);

    const canChange = _SettingsStore.default.canSetValue(this.props.featureId, null, _SettingLevel.SettingLevel.DEVICE);

    return /*#__PURE__*/_react.default.createElement(_LabelledToggleSwitch.default, {
      value: value,
      label: label,
      onChange: this.onChange,
      disabled: !canChange
    });
  }

}

exports.LabsSettingToggle = LabsSettingToggle;
let LabsUserSettingsTab = (_dec = (0, _replaceableComponent.replaceableComponent)("views.settings.tabs.user.LabsUserSettingsTab"), _dec(_class = class LabsUserSettingsTab extends _react.default.Component {
  constructor(props) {
    super(props);

    _MatrixClientPeg.MatrixClientPeg.get().doesServerSupportUnstableFeature("org.matrix.msc2285").then(showHiddenReadReceipts => {
      this.setState({
        showHiddenReadReceipts
      });
    });

    this.state = {
      showHiddenReadReceipts: false
    };
  }

  render() {
    const features = _SettingsStore.default.getFeatureSettingNames();

    const [labs, betas] = features.reduce((arr, f) => {
      arr[_SettingsStore.default.getBetaInfo(f) ? 1 : 0].push(f);
      return arr;
    }, [[], []]);
    let betaSection;

    if (betas.length) {
      betaSection = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_SettingsTab_section"
      }, betas.map(f => /*#__PURE__*/_react.default.createElement(_BetaCard.default, {
        key: f,
        featureId: f
      })));
    }

    let labsSection;

    if (_SdkConfig.default.get()['showLabsSettings']) {
      const groups = new _maps.EnhancedMap();
      labs.forEach(f => {
        groups.getOrCreate(_SettingsStore.default.getLabGroup(f), []).push( /*#__PURE__*/_react.default.createElement(LabsSettingToggle, {
          featureId: f,
          key: f
        }));
      });
      groups.get(_Settings.LabGroup.Widgets).push( /*#__PURE__*/_react.default.createElement(_SettingsFlag.default, {
        name: "enableWidgetScreenshots",
        level: _SettingLevel.SettingLevel.ACCOUNT
      }));
      groups.get(_Settings.LabGroup.Experimental).push( /*#__PURE__*/_react.default.createElement(_SettingsFlag.default, {
        name: "lowBandwidth",
        level: _SettingLevel.SettingLevel.DEVICE
      }));
      groups.getOrCreate(_Settings.LabGroup.Developer, []).push( /*#__PURE__*/_react.default.createElement(_SettingsFlag.default, {
        name: "developerMode",
        level: _SettingLevel.SettingLevel.ACCOUNT
      }), /*#__PURE__*/_react.default.createElement(_SettingsFlag.default, {
        name: "showHiddenEventsInTimeline",
        level: _SettingLevel.SettingLevel.DEVICE
      }));
      groups.get(_Settings.LabGroup.Analytics).push( /*#__PURE__*/_react.default.createElement(_SettingsFlag.default, {
        name: "automaticErrorReporting",
        level: _SettingLevel.SettingLevel.DEVICE
      }));

      if (this.state.showHiddenReadReceipts) {
        groups.get(_Settings.LabGroup.Messaging).push( /*#__PURE__*/_react.default.createElement(_SettingsFlag.default, {
          name: "feature_hidden_read_receipts",
          level: _SettingLevel.SettingLevel.DEVICE
        }));
      }

      labsSection = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_SettingsTab_section"
      }, (0, _lodash.sortBy)(Array.from(groups.entries()), "0").map(([group, flags]) => /*#__PURE__*/_react.default.createElement("div", {
        key: group
      }, /*#__PURE__*/_react.default.createElement("span", {
        className: "mx_SettingsTab_subheading"
      }, (0, _languageHandler._t)(_Settings.labGroupNames[group])), flags)));
    }

    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_SettingsTab mx_LabsUserSettingsTab"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_SettingsTab_heading"
    }, (0, _languageHandler._t)("Labs")), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_SettingsTab_subsectionText"
    }, (0, _languageHandler._t)('Feeling experimental? Labs are the best way to get things early, ' + 'test out new features and help shape them before they actually launch. ' + '<a>Learn more</a>.', {}, {
      'a': sub => {
        return /*#__PURE__*/_react.default.createElement("a", {
          href: "https://github.com/vector-im/element-web/blob/develop/docs/labs.md",
          rel: "noreferrer noopener",
          target: "_blank"
        }, sub);
      }
    })), betaSection, labsSection);
  }

}) || _class);
exports.default = LabsUserSettingsTab;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3NldHRpbmdzL3RhYnMvdXNlci9MYWJzVXNlclNldHRpbmdzVGFiLnRzeCJdLCJuYW1lcyI6WyJMYWJzU2V0dGluZ1RvZ2dsZSIsIlJlYWN0IiwiQ29tcG9uZW50IiwiY2hlY2tlZCIsIlNldHRpbmdzU3RvcmUiLCJzZXRWYWx1ZSIsInByb3BzIiwiZmVhdHVyZUlkIiwiU2V0dGluZ0xldmVsIiwiREVWSUNFIiwiZm9yY2VVcGRhdGUiLCJyZW5kZXIiLCJsYWJlbCIsImdldERpc3BsYXlOYW1lIiwidmFsdWUiLCJnZXRWYWx1ZSIsImNhbkNoYW5nZSIsImNhblNldFZhbHVlIiwib25DaGFuZ2UiLCJMYWJzVXNlclNldHRpbmdzVGFiIiwiY29uc3RydWN0b3IiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJkb2VzU2VydmVyU3VwcG9ydFVuc3RhYmxlRmVhdHVyZSIsInRoZW4iLCJzaG93SGlkZGVuUmVhZFJlY2VpcHRzIiwic2V0U3RhdGUiLCJzdGF0ZSIsImZlYXR1cmVzIiwiZ2V0RmVhdHVyZVNldHRpbmdOYW1lcyIsImxhYnMiLCJiZXRhcyIsInJlZHVjZSIsImFyciIsImYiLCJnZXRCZXRhSW5mbyIsInB1c2giLCJiZXRhU2VjdGlvbiIsImxlbmd0aCIsIm1hcCIsImxhYnNTZWN0aW9uIiwiU2RrQ29uZmlnIiwiZ3JvdXBzIiwiRW5oYW5jZWRNYXAiLCJmb3JFYWNoIiwiZ2V0T3JDcmVhdGUiLCJnZXRMYWJHcm91cCIsIkxhYkdyb3VwIiwiV2lkZ2V0cyIsIkFDQ09VTlQiLCJFeHBlcmltZW50YWwiLCJEZXZlbG9wZXIiLCJBbmFseXRpY3MiLCJNZXNzYWdpbmciLCJBcnJheSIsImZyb20iLCJlbnRyaWVzIiwiZ3JvdXAiLCJmbGFncyIsImxhYkdyb3VwTmFtZXMiLCJzdWIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNB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QkFBQyxxQkFBRDtBQUFjLFVBQUEsSUFBSSxFQUFDLDhCQUFuQjtBQUFrRCxVQUFBLEtBQUssRUFBRTVCLDJCQUFhQztBQUF0RSxVQURKO0FBR0g7O0FBRUQrQixNQUFBQSxXQUFXLGdCQUFHO0FBQUssUUFBQSxTQUFTLEVBQUM7QUFBZixTQUNSLG9CQUFPYyxLQUFLLENBQUNDLElBQU4sQ0FBV2IsTUFBTSxDQUFDYyxPQUFQLEVBQVgsQ0FBUCxFQUFxQyxHQUFyQyxFQUEwQ2pCLEdBQTFDLENBQThDLENBQUMsQ0FBQ2tCLEtBQUQsRUFBUUMsS0FBUixDQUFELGtCQUM1QztBQUFLLFFBQUEsR0FBRyxFQUFFRDtBQUFWLHNCQUNJO0FBQU0sUUFBQSxTQUFTLEVBQUM7QUFBaEIsU0FBOEMseUJBQUdFLHdCQUFjRixLQUFkLENBQUgsQ0FBOUMsQ0FESixFQUVNQyxLQUZOLENBREYsQ0FEUSxDQUFkO0FBUUg7O0FBRUQsd0JBQ0k7QUFBSyxNQUFBLFNBQVMsRUFBQztBQUFmLG9CQUNJO0FBQUssTUFBQSxTQUFTLEVBQUM7QUFBZixPQUEwQyx5QkFBRyxNQUFILENBQTFDLENBREosZUFFSTtBQUFLLE1BQUEsU0FBUyxFQUFDO0FBQWYsT0FFUSx5QkFBRyxzRUFDQyx5RUFERCxHQUVDLG9CQUZKLEVBRTBCLEVBRjFCLEVBRThCO0FBQzFCLFdBQU1FLEdBQUQsSUFBUztBQUNWLDRCQUFPO0FBQ0gsVUFBQSxJQUFJLEVBQUMsb0VBREY7QUFFSCxVQUFBLEdBQUcsRUFBQyxxQkFGRDtBQUdILFVBQUEsTUFBTSxFQUFDO0FBSEosV0FJSkEsR0FKSSxDQUFQO0FBS0g7QUFQeUIsS0FGOUIsQ0FGUixDQUZKLEVBaUJNdkIsV0FqQk4sRUFrQk1HLFdBbEJOLENBREo7QUFzQkg7O0FBM0Z3RSxDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE5IE5ldyBWZWN0b3IgTHRkXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IHNvcnRCeSB9IGZyb20gXCJsb2Rhc2hcIjtcblxuaW1wb3J0IHsgX3QgfSBmcm9tIFwiLi4vLi4vLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyXCI7XG5pbXBvcnQgU2V0dGluZ3NTdG9yZSBmcm9tIFwiLi4vLi4vLi4vLi4vLi4vc2V0dGluZ3MvU2V0dGluZ3NTdG9yZVwiO1xuaW1wb3J0IExhYmVsbGVkVG9nZ2xlU3dpdGNoIGZyb20gXCIuLi8uLi8uLi9lbGVtZW50cy9MYWJlbGxlZFRvZ2dsZVN3aXRjaFwiO1xuaW1wb3J0IHsgU2V0dGluZ0xldmVsIH0gZnJvbSBcIi4uLy4uLy4uLy4uLy4uL3NldHRpbmdzL1NldHRpbmdMZXZlbFwiO1xuaW1wb3J0IHsgcmVwbGFjZWFibGVDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vLi4vLi4vdXRpbHMvcmVwbGFjZWFibGVDb21wb25lbnRcIjtcbmltcG9ydCBTZGtDb25maWcgZnJvbSBcIi4uLy4uLy4uLy4uLy4uL1Nka0NvbmZpZ1wiO1xuaW1wb3J0IEJldGFDYXJkIGZyb20gXCIuLi8uLi8uLi9iZXRhL0JldGFDYXJkXCI7XG5pbXBvcnQgU2V0dGluZ3NGbGFnIGZyb20gJy4uLy4uLy4uL2VsZW1lbnRzL1NldHRpbmdzRmxhZyc7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9NYXRyaXhDbGllbnRQZWcnO1xuaW1wb3J0IHsgTGFiR3JvdXAsIGxhYkdyb3VwTmFtZXMgfSBmcm9tIFwiLi4vLi4vLi4vLi4vLi4vc2V0dGluZ3MvU2V0dGluZ3NcIjtcbmltcG9ydCB7IEVuaGFuY2VkTWFwIH0gZnJvbSBcIi4uLy4uLy4uLy4uLy4uL3V0aWxzL21hcHNcIjtcblxuaW50ZXJmYWNlIElMYWJzU2V0dGluZ1RvZ2dsZVByb3BzIHtcbiAgICBmZWF0dXJlSWQ6IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIExhYnNTZXR0aW5nVG9nZ2xlIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PElMYWJzU2V0dGluZ1RvZ2dsZVByb3BzPiB7XG4gICAgcHJpdmF0ZSBvbkNoYW5nZSA9IGFzeW5jIChjaGVja2VkOiBib29sZWFuKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgICAgIGF3YWl0IFNldHRpbmdzU3RvcmUuc2V0VmFsdWUodGhpcy5wcm9wcy5mZWF0dXJlSWQsIG51bGwsIFNldHRpbmdMZXZlbC5ERVZJQ0UsIGNoZWNrZWQpO1xuICAgICAgICB0aGlzLmZvcmNlVXBkYXRlKCk7XG4gICAgfTtcblxuICAgIHB1YmxpYyByZW5kZXIoKTogSlNYLkVsZW1lbnQge1xuICAgICAgICBjb25zdCBsYWJlbCA9IFNldHRpbmdzU3RvcmUuZ2V0RGlzcGxheU5hbWUodGhpcy5wcm9wcy5mZWF0dXJlSWQpO1xuICAgICAgICBjb25zdCB2YWx1ZSA9IFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUodGhpcy5wcm9wcy5mZWF0dXJlSWQpO1xuICAgICAgICBjb25zdCBjYW5DaGFuZ2UgPSBTZXR0aW5nc1N0b3JlLmNhblNldFZhbHVlKHRoaXMucHJvcHMuZmVhdHVyZUlkLCBudWxsLCBTZXR0aW5nTGV2ZWwuREVWSUNFKTtcbiAgICAgICAgcmV0dXJuIDxMYWJlbGxlZFRvZ2dsZVN3aXRjaCB2YWx1ZT17dmFsdWV9IGxhYmVsPXtsYWJlbH0gb25DaGFuZ2U9e3RoaXMub25DaGFuZ2V9IGRpc2FibGVkPXshY2FuQ2hhbmdlfSAvPjtcbiAgICB9XG59XG5cbmludGVyZmFjZSBJU3RhdGUge1xuICAgIHNob3dIaWRkZW5SZWFkUmVjZWlwdHM6IGJvb2xlYW47XG59XG5cbkByZXBsYWNlYWJsZUNvbXBvbmVudChcInZpZXdzLnNldHRpbmdzLnRhYnMudXNlci5MYWJzVXNlclNldHRpbmdzVGFiXCIpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBMYWJzVXNlclNldHRpbmdzVGFiIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PHt9LCBJU3RhdGU+IHtcbiAgICBjb25zdHJ1Y3Rvcihwcm9wczoge30pIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuXG4gICAgICAgIE1hdHJpeENsaWVudFBlZy5nZXQoKS5kb2VzU2VydmVyU3VwcG9ydFVuc3RhYmxlRmVhdHVyZShcIm9yZy5tYXRyaXgubXNjMjI4NVwiKS50aGVuKChzaG93SGlkZGVuUmVhZFJlY2VpcHRzKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgc2hvd0hpZGRlblJlYWRSZWNlaXB0cyB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIHNob3dIaWRkZW5SZWFkUmVjZWlwdHM6IGZhbHNlLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHB1YmxpYyByZW5kZXIoKTogSlNYLkVsZW1lbnQge1xuICAgICAgICBjb25zdCBmZWF0dXJlcyA9IFNldHRpbmdzU3RvcmUuZ2V0RmVhdHVyZVNldHRpbmdOYW1lcygpO1xuICAgICAgICBjb25zdCBbbGFicywgYmV0YXNdID0gZmVhdHVyZXMucmVkdWNlKChhcnIsIGYpID0+IHtcbiAgICAgICAgICAgIGFycltTZXR0aW5nc1N0b3JlLmdldEJldGFJbmZvKGYpID8gMSA6IDBdLnB1c2goZik7XG4gICAgICAgICAgICByZXR1cm4gYXJyO1xuICAgICAgICB9LCBbW10sIFtdXSBhcyBbc3RyaW5nW10sIHN0cmluZ1tdXSk7XG5cbiAgICAgICAgbGV0IGJldGFTZWN0aW9uO1xuICAgICAgICBpZiAoYmV0YXMubGVuZ3RoKSB7XG4gICAgICAgICAgICBiZXRhU2VjdGlvbiA9IDxkaXYgY2xhc3NOYW1lPVwibXhfU2V0dGluZ3NUYWJfc2VjdGlvblwiPlxuICAgICAgICAgICAgICAgIHsgYmV0YXMubWFwKGYgPT4gPEJldGFDYXJkIGtleT17Zn0gZmVhdHVyZUlkPXtmfSAvPiApIH1cbiAgICAgICAgICAgIDwvZGl2PjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBsYWJzU2VjdGlvbjtcbiAgICAgICAgaWYgKFNka0NvbmZpZy5nZXQoKVsnc2hvd0xhYnNTZXR0aW5ncyddKSB7XG4gICAgICAgICAgICBjb25zdCBncm91cHMgPSBuZXcgRW5oYW5jZWRNYXA8TGFiR3JvdXAsIEpTWC5FbGVtZW50W10+KCk7XG4gICAgICAgICAgICBsYWJzLmZvckVhY2goZiA9PiB7XG4gICAgICAgICAgICAgICAgZ3JvdXBzLmdldE9yQ3JlYXRlKFNldHRpbmdzU3RvcmUuZ2V0TGFiR3JvdXAoZiksIFtdKS5wdXNoKFxuICAgICAgICAgICAgICAgICAgICA8TGFic1NldHRpbmdUb2dnbGUgZmVhdHVyZUlkPXtmfSBrZXk9e2Z9IC8+LFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgZ3JvdXBzLmdldChMYWJHcm91cC5XaWRnZXRzKS5wdXNoKFxuICAgICAgICAgICAgICAgIDxTZXR0aW5nc0ZsYWcgbmFtZT1cImVuYWJsZVdpZGdldFNjcmVlbnNob3RzXCIgbGV2ZWw9e1NldHRpbmdMZXZlbC5BQ0NPVU5UfSAvPixcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGdyb3Vwcy5nZXQoTGFiR3JvdXAuRXhwZXJpbWVudGFsKS5wdXNoKFxuICAgICAgICAgICAgICAgIDxTZXR0aW5nc0ZsYWcgbmFtZT1cImxvd0JhbmR3aWR0aFwiIGxldmVsPXtTZXR0aW5nTGV2ZWwuREVWSUNFfSAvPixcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGdyb3Vwcy5nZXRPckNyZWF0ZShMYWJHcm91cC5EZXZlbG9wZXIsIFtdKS5wdXNoKFxuICAgICAgICAgICAgICAgIDxTZXR0aW5nc0ZsYWcgbmFtZT1cImRldmVsb3Blck1vZGVcIiBsZXZlbD17U2V0dGluZ0xldmVsLkFDQ09VTlR9IC8+LFxuICAgICAgICAgICAgICAgIDxTZXR0aW5nc0ZsYWcgbmFtZT1cInNob3dIaWRkZW5FdmVudHNJblRpbWVsaW5lXCIgbGV2ZWw9e1NldHRpbmdMZXZlbC5ERVZJQ0V9IC8+LFxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgZ3JvdXBzLmdldChMYWJHcm91cC5BbmFseXRpY3MpLnB1c2goXG4gICAgICAgICAgICAgICAgPFNldHRpbmdzRmxhZyBuYW1lPVwiYXV0b21hdGljRXJyb3JSZXBvcnRpbmdcIiBsZXZlbD17U2V0dGluZ0xldmVsLkRFVklDRX0gLz4sXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5zdGF0ZS5zaG93SGlkZGVuUmVhZFJlY2VpcHRzKSB7XG4gICAgICAgICAgICAgICAgZ3JvdXBzLmdldChMYWJHcm91cC5NZXNzYWdpbmcpLnB1c2goXG4gICAgICAgICAgICAgICAgICAgIDxTZXR0aW5nc0ZsYWcgbmFtZT1cImZlYXR1cmVfaGlkZGVuX3JlYWRfcmVjZWlwdHNcIiBsZXZlbD17U2V0dGluZ0xldmVsLkRFVklDRX0gLz4sXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGFic1NlY3Rpb24gPSA8ZGl2IGNsYXNzTmFtZT1cIm14X1NldHRpbmdzVGFiX3NlY3Rpb25cIj5cbiAgICAgICAgICAgICAgICB7IHNvcnRCeShBcnJheS5mcm9tKGdyb3Vwcy5lbnRyaWVzKCkpLCBcIjBcIikubWFwKChbZ3JvdXAsIGZsYWdzXSkgPT4gKFxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGtleT17Z3JvdXB9PlxuICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3NOYW1lPVwibXhfU2V0dGluZ3NUYWJfc3ViaGVhZGluZ1wiPnsgX3QobGFiR3JvdXBOYW1lc1tncm91cF0pIH08L3NwYW4+XG4gICAgICAgICAgICAgICAgICAgICAgICB7IGZsYWdzIH1cbiAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgKSkgfVxuICAgICAgICAgICAgPC9kaXY+O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfU2V0dGluZ3NUYWIgbXhfTGFic1VzZXJTZXR0aW5nc1RhYlwiPlxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfU2V0dGluZ3NUYWJfaGVhZGluZ1wiPnsgX3QoXCJMYWJzXCIpIH08L2Rpdj5cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nbXhfU2V0dGluZ3NUYWJfc3Vic2VjdGlvblRleHQnPlxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICBfdCgnRmVlbGluZyBleHBlcmltZW50YWw/IExhYnMgYXJlIHRoZSBiZXN0IHdheSB0byBnZXQgdGhpbmdzIGVhcmx5LCAnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAndGVzdCBvdXQgbmV3IGZlYXR1cmVzIGFuZCBoZWxwIHNoYXBlIHRoZW0gYmVmb3JlIHRoZXkgYWN0dWFsbHkgbGF1bmNoLiAnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGE+TGVhcm4gbW9yZTwvYT4uJywge30sIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYSc6IChzdWIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDxhXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBocmVmPVwiaHR0cHM6Ly9naXRodWIuY29tL3ZlY3Rvci1pbS9lbGVtZW50LXdlYi9ibG9iL2RldmVsb3AvZG9jcy9sYWJzLm1kXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbD0nbm9yZWZlcnJlciBub29wZW5lcidcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldD0nX2JsYW5rJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA+eyBzdWIgfTwvYT47XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICB7IGJldGFTZWN0aW9uIH1cbiAgICAgICAgICAgICAgICB7IGxhYnNTZWN0aW9uIH1cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICApO1xuICAgIH1cbn1cbiJdfQ==