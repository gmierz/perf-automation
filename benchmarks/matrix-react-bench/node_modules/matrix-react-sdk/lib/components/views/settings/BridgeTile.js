"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _languageHandler = require("../../../languageHandler");

var _Pill = _interopRequireDefault(require("../elements/Pill"));

var _Permalinks = require("../../../utils/permalinks/Permalinks");

var _BaseAvatar = _interopRequireDefault(require("../avatars/BaseAvatar"));

var _SettingsStore = _interopRequireDefault(require("../../../settings/SettingsStore"));

var _HtmlUtils = require("../../../HtmlUtils");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _Media = require("../../../customisations/Media");

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class, _class2, _temp;

let BridgeTile = (_dec = (0, _replaceableComponent.replaceableComponent)("views.settings.BridgeTile"), _dec(_class = (_temp = _class2 = class BridgeTile extends _react.default.PureComponent {
  render() {
    var _content$channel, _content$protocol;

    const content = this.props.ev.getContent(); // Validate

    if (!((_content$channel = content.channel) !== null && _content$channel !== void 0 && _content$channel.id) || !((_content$protocol = content.protocol) !== null && _content$protocol !== void 0 && _content$protocol.id)) {
      _logger.logger.warn(`Bridge info event ${this.props.ev.getId()} has missing content. Tile will not render`);

      return null;
    }

    if (!content.bridgebot) {
      // Bridgebot was not required previously, so in order to not break rooms we are allowing
      // the sender to be used in place. When the proposal is merged, this should be removed.
      _logger.logger.warn(`Bridge info event ${this.props.ev.getId()} does not provide a 'bridgebot' key which` + "is deprecated behaviour. Using sender for now.");

      content.bridgebot = this.props.ev.getSender();
    }

    const {
      channel,
      network,
      protocol
    } = content;
    const protocolName = protocol.displayname || protocol.id;
    const channelName = channel.displayname || channel.id;
    let creator = null;

    if (content.creator) {
      creator = /*#__PURE__*/_react.default.createElement("li", null, (0, _languageHandler._t)("This bridge was provisioned by <user />.", {}, {
        user: () => /*#__PURE__*/_react.default.createElement(_Pill.default, {
          type: _Pill.default.TYPE_USER_MENTION,
          room: this.props.room,
          url: (0, _Permalinks.makeUserPermalink)(content.creator),
          shouldShowPillAvatar: _SettingsStore.default.getValue("Pill.shouldShowPillAvatar")
        })
      }));
    }

    const bot = /*#__PURE__*/_react.default.createElement("li", null, (0, _languageHandler._t)("This bridge is managed by <user />.", {}, {
      user: () => /*#__PURE__*/_react.default.createElement(_Pill.default, {
        type: _Pill.default.TYPE_USER_MENTION,
        room: this.props.room,
        url: (0, _Permalinks.makeUserPermalink)(content.bridgebot),
        shouldShowPillAvatar: _SettingsStore.default.getValue("Pill.shouldShowPillAvatar")
      })
    }));

    let networkIcon;

    if (protocol.avatar_url) {
      const avatarUrl = (0, _Media.mediaFromMxc)(protocol.avatar_url).getSquareThumbnailHttp(64);
      networkIcon = /*#__PURE__*/_react.default.createElement(_BaseAvatar.default, {
        className: "protocol-icon",
        width: 48,
        height: 48,
        resizeMethod: "crop",
        name: protocolName,
        idName: protocolName,
        url: avatarUrl
      });
    } else {
      networkIcon = /*#__PURE__*/_react.default.createElement("div", {
        className: "noProtocolIcon"
      });
    }

    let networkItem = null;

    if (network) {
      const networkName = network.displayname || network.id;

      let networkLink = /*#__PURE__*/_react.default.createElement("span", null, networkName);

      if (typeof network.external_url === "string" && (0, _HtmlUtils.isUrlPermitted)(network.external_url)) {
        networkLink = /*#__PURE__*/_react.default.createElement("a", {
          href: network.external_url,
          target: "_blank",
          rel: "noreferrer noopener"
        }, networkName);
      }

      networkItem = (0, _languageHandler._t)("Workspace: <networkLink/>", {}, {
        networkLink: () => networkLink
      });
    }

    let channelLink = /*#__PURE__*/_react.default.createElement("span", null, channelName);

    if (typeof channel.external_url === "string" && (0, _HtmlUtils.isUrlPermitted)(channel.external_url)) {
      channelLink = /*#__PURE__*/_react.default.createElement("a", {
        href: channel.external_url,
        target: "_blank",
        rel: "noreferrer noopener"
      }, channelName);
    }

    const id = this.props.ev.getId();
    return /*#__PURE__*/_react.default.createElement("li", {
      key: id
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "column-icon"
    }, networkIcon), /*#__PURE__*/_react.default.createElement("div", {
      className: "column-data"
    }, /*#__PURE__*/_react.default.createElement("h3", null, protocolName), /*#__PURE__*/_react.default.createElement("p", {
      className: "workspace-channel-details"
    }, networkItem, /*#__PURE__*/_react.default.createElement("span", {
      className: "channel"
    }, (0, _languageHandler._t)("Channel: <channelLink/>", {}, {
      channelLink: () => channelLink
    }))), /*#__PURE__*/_react.default.createElement("ul", {
      className: "metadata"
    }, creator, " ", bot)));
  }

}, (0, _defineProperty2.default)(_class2, "propTypes", {
  ev: _propTypes.default.object.isRequired,
  room: _propTypes.default.object.isRequired
}), _temp)) || _class);
exports.default = BridgeTile;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3NldHRpbmdzL0JyaWRnZVRpbGUudHN4Il0sIm5hbWVzIjpbIkJyaWRnZVRpbGUiLCJSZWFjdCIsIlB1cmVDb21wb25lbnQiLCJyZW5kZXIiLCJjb250ZW50IiwicHJvcHMiLCJldiIsImdldENvbnRlbnQiLCJjaGFubmVsIiwiaWQiLCJwcm90b2NvbCIsImxvZ2dlciIsIndhcm4iLCJnZXRJZCIsImJyaWRnZWJvdCIsImdldFNlbmRlciIsIm5ldHdvcmsiLCJwcm90b2NvbE5hbWUiLCJkaXNwbGF5bmFtZSIsImNoYW5uZWxOYW1lIiwiY3JlYXRvciIsInVzZXIiLCJQaWxsIiwiVFlQRV9VU0VSX01FTlRJT04iLCJyb29tIiwiU2V0dGluZ3NTdG9yZSIsImdldFZhbHVlIiwiYm90IiwibmV0d29ya0ljb24iLCJhdmF0YXJfdXJsIiwiYXZhdGFyVXJsIiwiZ2V0U3F1YXJlVGh1bWJuYWlsSHR0cCIsIm5ldHdvcmtJdGVtIiwibmV0d29ya05hbWUiLCJuZXR3b3JrTGluayIsImV4dGVybmFsX3VybCIsImNoYW5uZWxMaW5rIiwiUHJvcFR5cGVzIiwib2JqZWN0IiwiaXNSZXF1aXJlZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFnQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBRUE7Ozs7SUF3Q3FCQSxVLFdBRHBCLGdEQUFxQiwyQkFBckIsQyxtQ0FBRCxNQUNxQkEsVUFEckIsU0FDd0NDLGVBQU1DLGFBRDlDLENBQ29FO0FBTWhFQyxFQUFBQSxNQUFNLEdBQUc7QUFBQTs7QUFDTCxVQUFNQyxPQUEwQixHQUFHLEtBQUtDLEtBQUwsQ0FBV0MsRUFBWCxDQUFjQyxVQUFkLEVBQW5DLENBREssQ0FFTDs7QUFDQSxRQUFJLHNCQUFDSCxPQUFPLENBQUNJLE9BQVQsNkNBQUMsaUJBQWlCQyxFQUFsQixLQUF3Qix1QkFBQ0wsT0FBTyxDQUFD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LHlCQUFILEVBQThCLEVBQTlCLEVBQWtDO0FBQzFESSxNQUFBQSxXQUFXLEVBQUUsTUFBTUE7QUFEdUMsS0FBbEMsQ0FBNUIsQ0FGSixDQUZKLGVBUUk7QUFBSSxNQUFBLFNBQVMsRUFBQztBQUFkLE9BQ01oQixPQUROLE9BQ2tCTyxHQURsQixDQVJKLENBSkksQ0FBUjtBQWlCSDs7QUFsRytELEMsc0RBQzdDO0FBQ2ZyQixFQUFBQSxFQUFFLEVBQUUrQixtQkFBVUMsTUFBVixDQUFpQkMsVUFETjtBQUVmZixFQUFBQSxJQUFJLEVBQUVhLG1CQUFVQyxNQUFWLENBQWlCQztBQUZSLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMjAgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcbmltcG9ydCB7IF90IH0gZnJvbSBcIi4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlclwiO1xuaW1wb3J0IFBpbGwgZnJvbSBcIi4uL2VsZW1lbnRzL1BpbGxcIjtcbmltcG9ydCB7IG1ha2VVc2VyUGVybWFsaW5rIH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3Blcm1hbGlua3MvUGVybWFsaW5rc1wiO1xuaW1wb3J0IEJhc2VBdmF0YXIgZnJvbSBcIi4uL2F2YXRhcnMvQmFzZUF2YXRhclwiO1xuaW1wb3J0IFNldHRpbmdzU3RvcmUgZnJvbSBcIi4uLy4uLy4uL3NldHRpbmdzL1NldHRpbmdzU3RvcmVcIjtcbmltcG9ydCB7IE1hdHJpeEV2ZW50IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9ldmVudFwiO1xuaW1wb3J0IHsgUm9vbSB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvcm9vbVwiO1xuaW1wb3J0IHsgaXNVcmxQZXJtaXR0ZWQgfSBmcm9tICcuLi8uLi8uLi9IdG1sVXRpbHMnO1xuaW1wb3J0IHsgcmVwbGFjZWFibGVDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvcmVwbGFjZWFibGVDb21wb25lbnRcIjtcbmltcG9ydCB7IG1lZGlhRnJvbU14YyB9IGZyb20gXCIuLi8uLi8uLi9jdXN0b21pc2F0aW9ucy9NZWRpYVwiO1xuXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbG9nZ2VyXCI7XG5cbmludGVyZmFjZSBJUHJvcHMge1xuICAgIGV2OiBNYXRyaXhFdmVudDtcbiAgICByb29tOiBSb29tO1xufVxuXG4vKipcbiAqIFRoaXMgc2hvdWxkIG1hdGNoIGh0dHBzOi8vZ2l0aHViLmNvbS9tYXRyaXgtb3JnL21hdHJpeC1kb2MvYmxvYi9ocy9tc2MtYnJpZGdlLWluZi9wcm9wb3NhbHMvMjM0Ni1icmlkZ2UtaW5mby1zdGF0ZS1ldmVudC5tZCNtYnJpZGdlXG4gKi9cbmludGVyZmFjZSBJQnJpZGdlU3RhdGVFdmVudCB7XG4gICAgYnJpZGdlYm90OiBzdHJpbmc7XG4gICAgY3JlYXRvcj86IHN0cmluZztcbiAgICBwcm90b2NvbDoge1xuICAgICAgICBpZDogc3RyaW5nO1xuICAgICAgICBkaXNwbGF5bmFtZT86IHN0cmluZztcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNhbWVsY2FzZVxuICAgICAgICBhdmF0YXJfdXJsPzogc3RyaW5nO1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgY2FtZWxjYXNlXG4gICAgICAgIGV4dGVybmFsX3VybD86IHN0cmluZztcbiAgICB9O1xuICAgIG5ldHdvcms/OiB7XG4gICAgICAgIGlkOiBzdHJpbmc7XG4gICAgICAgIGRpc3BsYXluYW1lPzogc3RyaW5nO1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgY2FtZWxjYXNlXG4gICAgICAgIGF2YXRhcl91cmw/OiBzdHJpbmc7XG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBjYW1lbGNhc2VcbiAgICAgICAgZXh0ZXJuYWxfdXJsPzogc3RyaW5nO1xuICAgIH07XG4gICAgY2hhbm5lbDoge1xuICAgICAgICBpZDogc3RyaW5nO1xuICAgICAgICBkaXNwbGF5bmFtZT86IHN0cmluZztcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNhbWVsY2FzZVxuICAgICAgICBhdmF0YXJfdXJsPzogc3RyaW5nO1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgY2FtZWxjYXNlXG4gICAgICAgIGV4dGVybmFsX3VybD86IHN0cmluZztcbiAgICB9O1xufVxuXG5AcmVwbGFjZWFibGVDb21wb25lbnQoXCJ2aWV3cy5zZXR0aW5ncy5CcmlkZ2VUaWxlXCIpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBCcmlkZ2VUaWxlIGV4dGVuZHMgUmVhY3QuUHVyZUNvbXBvbmVudDxJUHJvcHM+IHtcbiAgICBzdGF0aWMgcHJvcFR5cGVzID0ge1xuICAgICAgICBldjogUHJvcFR5cGVzLm9iamVjdC5pc1JlcXVpcmVkLFxuICAgICAgICByb29tOiBQcm9wVHlwZXMub2JqZWN0LmlzUmVxdWlyZWQsXG4gICAgfTtcblxuICAgIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3QgY29udGVudDogSUJyaWRnZVN0YXRlRXZlbnQgPSB0aGlzLnByb3BzLmV2LmdldENvbnRlbnQoKTtcbiAgICAgICAgLy8gVmFsaWRhdGVcbiAgICAgICAgaWYgKCFjb250ZW50LmNoYW5uZWw/LmlkIHx8ICFjb250ZW50LnByb3RvY29sPy5pZCkge1xuICAgICAgICAgICAgbG9nZ2VyLndhcm4oYEJyaWRnZSBpbmZvIGV2ZW50ICR7dGhpcy5wcm9wcy5ldi5nZXRJZCgpfSBoYXMgbWlzc2luZyBjb250ZW50LiBUaWxlIHdpbGwgbm90IHJlbmRlcmApO1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFjb250ZW50LmJyaWRnZWJvdCkge1xuICAgICAgICAgICAgLy8gQnJpZGdlYm90IHdhcyBub3QgcmVxdWlyZWQgcHJldmlvdXNseSwgc28gaW4gb3JkZXIgdG8gbm90IGJyZWFrIHJvb21zIHdlIGFyZSBhbGxvd2luZ1xuICAgICAgICAgICAgLy8gdGhlIHNlbmRlciB0byBiZSB1c2VkIGluIHBsYWNlLiBXaGVuIHRoZSBwcm9wb3NhbCBpcyBtZXJnZWQsIHRoaXMgc2hvdWxkIGJlIHJlbW92ZWQuXG4gICAgICAgICAgICBsb2dnZXIud2FybihgQnJpZGdlIGluZm8gZXZlbnQgJHt0aGlzLnByb3BzLmV2LmdldElkKCl9IGRvZXMgbm90IHByb3ZpZGUgYSAnYnJpZGdlYm90JyBrZXkgd2hpY2hgXG4gICAgICAgICAgICAgKyBcImlzIGRlcHJlY2F0ZWQgYmVoYXZpb3VyLiBVc2luZyBzZW5kZXIgZm9yIG5vdy5cIik7XG4gICAgICAgICAgICBjb250ZW50LmJyaWRnZWJvdCA9IHRoaXMucHJvcHMuZXYuZ2V0U2VuZGVyKCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgeyBjaGFubmVsLCBuZXR3b3JrLCBwcm90b2NvbCB9ID0gY29udGVudDtcbiAgICAgICAgY29uc3QgcHJvdG9jb2xOYW1lID0gcHJvdG9jb2wuZGlzcGxheW5hbWUgfHwgcHJvdG9jb2wuaWQ7XG4gICAgICAgIGNvbnN0IGNoYW5uZWxOYW1lID0gY2hhbm5lbC5kaXNwbGF5bmFtZSB8fCBjaGFubmVsLmlkO1xuXG4gICAgICAgIGxldCBjcmVhdG9yID0gbnVsbDtcbiAgICAgICAgaWYgKGNvbnRlbnQuY3JlYXRvcikge1xuICAgICAgICAgICAgY3JlYXRvciA9IDxsaT57IF90KFwiVGhpcyBicmlkZ2Ugd2FzIHByb3Zpc2lvbmVkIGJ5IDx1c2VyIC8+LlwiLCB7fSwge1xuICAgICAgICAgICAgICAgIHVzZXI6ICgpID0+IDxQaWxsXG4gICAgICAgICAgICAgICAgICAgIHR5cGU9e1BpbGwuVFlQRV9VU0VSX01FTlRJT059XG4gICAgICAgICAgICAgICAgICAgIHJvb209e3RoaXMucHJvcHMucm9vbX1cbiAgICAgICAgICAgICAgICAgICAgdXJsPXttYWtlVXNlclBlcm1hbGluayhjb250ZW50LmNyZWF0b3IpfVxuICAgICAgICAgICAgICAgICAgICBzaG91bGRTaG93UGlsbEF2YXRhcj17U2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcIlBpbGwuc2hvdWxkU2hvd1BpbGxBdmF0YXJcIil9XG4gICAgICAgICAgICAgICAgLz4sXG4gICAgICAgICAgICB9KSB9PC9saT47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBib3QgPSA8bGk+eyBfdChcIlRoaXMgYnJpZGdlIGlzIG1hbmFnZWQgYnkgPHVzZXIgLz4uXCIsIHt9LCB7XG4gICAgICAgICAgICB1c2VyOiAoKSA9PiA8UGlsbFxuICAgICAgICAgICAgICAgIHR5cGU9e1BpbGwuVFlQRV9VU0VSX01FTlRJT059XG4gICAgICAgICAgICAgICAgcm9vbT17dGhpcy5wcm9wcy5yb29tfVxuICAgICAgICAgICAgICAgIHVybD17bWFrZVVzZXJQZXJtYWxpbmsoY29udGVudC5icmlkZ2Vib3QpfVxuICAgICAgICAgICAgICAgIHNob3VsZFNob3dQaWxsQXZhdGFyPXtTZXR0aW5nc1N0b3JlLmdldFZhbHVlKFwiUGlsbC5zaG91bGRTaG93UGlsbEF2YXRhclwiKX1cbiAgICAgICAgICAgIC8+LFxuICAgICAgICB9KSB9PC9saT47XG5cbiAgICAgICAgbGV0IG5ldHdvcmtJY29uO1xuXG4gICAgICAgIGlmIChwcm90b2NvbC5hdmF0YXJfdXJsKSB7XG4gICAgICAgICAgICBjb25zdCBhdmF0YXJVcmwgPSBtZWRpYUZyb21NeGMocHJvdG9jb2wuYXZhdGFyX3VybCkuZ2V0U3F1YXJlVGh1bWJuYWlsSHR0cCg2NCk7XG5cbiAgICAgICAgICAgIG5ldHdvcmtJY29uID0gPEJhc2VBdmF0YXIgY2xhc3NOYW1lPVwicHJvdG9jb2wtaWNvblwiXG4gICAgICAgICAgICAgICAgd2lkdGg9ezQ4fVxuICAgICAgICAgICAgICAgIGhlaWdodD17NDh9XG4gICAgICAgICAgICAgICAgcmVzaXplTWV0aG9kPSdjcm9wJ1xuICAgICAgICAgICAgICAgIG5hbWU9e3Byb3RvY29sTmFtZX1cbiAgICAgICAgICAgICAgICBpZE5hbWU9e3Byb3RvY29sTmFtZX1cbiAgICAgICAgICAgICAgICB1cmw9e2F2YXRhclVybH1cbiAgICAgICAgICAgIC8+O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbmV0d29ya0ljb24gPSA8ZGl2IGNsYXNzTmFtZT1cIm5vUHJvdG9jb2xJY29uXCIgLz47XG4gICAgICAgIH1cbiAgICAgICAgbGV0IG5ldHdvcmtJdGVtID0gbnVsbDtcbiAgICAgICAgaWYgKG5ldHdvcmspIHtcbiAgICAgICAgICAgIGNvbnN0IG5ldHdvcmtOYW1lID0gbmV0d29yay5kaXNwbGF5bmFtZSB8fCBuZXR3b3JrLmlkO1xuICAgICAgICAgICAgbGV0IG5ldHdvcmtMaW5rID0gPHNwYW4+eyBuZXR3b3JrTmFtZSB9PC9zcGFuPjtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV0d29yay5leHRlcm5hbF91cmwgPT09IFwic3RyaW5nXCIgJiYgaXNVcmxQZXJtaXR0ZWQobmV0d29yay5leHRlcm5hbF91cmwpKSB7XG4gICAgICAgICAgICAgICAgbmV0d29ya0xpbmsgPSAoXG4gICAgICAgICAgICAgICAgICAgIDxhIGhyZWY9e25ldHdvcmsuZXh0ZXJuYWxfdXJsfSB0YXJnZXQ9XCJfYmxhbmtcIiByZWw9XCJub3JlZmVycmVyIG5vb3BlbmVyXCI+eyBuZXR3b3JrTmFtZSB9PC9hPlxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBuZXR3b3JrSXRlbSA9IF90KFwiV29ya3NwYWNlOiA8bmV0d29ya0xpbmsvPlwiLCB7fSwge1xuICAgICAgICAgICAgICAgIG5ldHdvcmtMaW5rOiAoKSA9PiBuZXR3b3JrTGluayxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGNoYW5uZWxMaW5rID0gPHNwYW4+eyBjaGFubmVsTmFtZSB9PC9zcGFuPjtcbiAgICAgICAgaWYgKHR5cGVvZiBjaGFubmVsLmV4dGVybmFsX3VybCA9PT0gXCJzdHJpbmdcIiAmJiBpc1VybFBlcm1pdHRlZChjaGFubmVsLmV4dGVybmFsX3VybCkpIHtcbiAgICAgICAgICAgIGNoYW5uZWxMaW5rID0gPGEgaHJlZj17Y2hhbm5lbC5leHRlcm5hbF91cmx9IHRhcmdldD1cIl9ibGFua1wiIHJlbD1cIm5vcmVmZXJyZXIgbm9vcGVuZXJcIj57IGNoYW5uZWxOYW1lIH08L2E+O1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgaWQgPSB0aGlzLnByb3BzLmV2LmdldElkKCk7XG4gICAgICAgIHJldHVybiAoPGxpIGtleT17aWR9PlxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJjb2x1bW4taWNvblwiPlxuICAgICAgICAgICAgICAgIHsgbmV0d29ya0ljb24gfVxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cImNvbHVtbi1kYXRhXCI+XG4gICAgICAgICAgICAgICAgPGgzPnsgcHJvdG9jb2xOYW1lIH08L2gzPlxuICAgICAgICAgICAgICAgIDxwIGNsYXNzTmFtZT1cIndvcmtzcGFjZS1jaGFubmVsLWRldGFpbHNcIj5cbiAgICAgICAgICAgICAgICAgICAgeyBuZXR3b3JrSXRlbSB9XG4gICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT1cImNoYW5uZWxcIj57IF90KFwiQ2hhbm5lbDogPGNoYW5uZWxMaW5rLz5cIiwge30sIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5uZWxMaW5rOiAoKSA9PiBjaGFubmVsTGluayxcbiAgICAgICAgICAgICAgICAgICAgfSkgfTwvc3Bhbj5cbiAgICAgICAgICAgICAgICA8L3A+XG4gICAgICAgICAgICAgICAgPHVsIGNsYXNzTmFtZT1cIm1ldGFkYXRhXCI+XG4gICAgICAgICAgICAgICAgICAgIHsgY3JlYXRvciB9IHsgYm90IH1cbiAgICAgICAgICAgICAgICA8L3VsPlxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgIDwvbGk+KTtcbiAgICB9XG59XG4iXX0=