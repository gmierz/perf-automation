"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _event = require("matrix-js-sdk/src/@types/event");

var _languageHandler = require("../../../../../languageHandler");

var _MatrixClientPeg = require("../../../../../MatrixClientPeg");

var _AccessibleButton = _interopRequireDefault(require("../../../elements/AccessibleButton"));

var _RoomUpgradeDialog = _interopRequireDefault(require("../../../dialogs/RoomUpgradeDialog"));

var _DevtoolsDialog = _interopRequireDefault(require("../../../dialogs/DevtoolsDialog"));

var _Modal = _interopRequireDefault(require("../../../../../Modal"));

var _dispatcher = _interopRequireDefault(require("../../../../../dispatcher/dispatcher"));

var _actions = require("../../../../../dispatcher/actions");

var _replaceableComponent = require("../../../../../utils/replaceableComponent");

var _dec, _class;

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

let AdvancedRoomSettingsTab = (_dec = (0, _replaceableComponent.replaceableComponent)("views.settings.tabs.room.AdvancedRoomSettingsTab"), _dec(_class = class AdvancedRoomSettingsTab extends _react.default.Component {
  constructor(props, context) {
    super(props, context);
    (0, _defineProperty2.default)(this, "upgradeRoom", e => {
      const room = _MatrixClientPeg.MatrixClientPeg.get().getRoom(this.props.roomId);

      _Modal.default.createTrackedDialog('Upgrade Room Version', '', _RoomUpgradeDialog.default, {
        room
      });
    });
    (0, _defineProperty2.default)(this, "openDevtools", e => {
      _Modal.default.createDialog(_DevtoolsDialog.default, {
        roomId: this.props.roomId
      });
    });
    (0, _defineProperty2.default)(this, "onOldRoomClicked", e => {
      e.preventDefault();
      e.stopPropagation();

      _dispatcher.default.dispatch({
        action: _actions.Action.ViewRoom,
        room_id: this.state.oldRoomId,
        event_id: this.state.oldEventId
      });

      this.props.closeSettingsFn();
    });
    this.state = {
      // This is eventually set to the value of room.getRecommendedVersion()
      upgradeRecommendation: null
    }; // we handle lack of this object gracefully later, so don't worry about it failing here.

    const _room = _MatrixClientPeg.MatrixClientPeg.get().getRoom(this.props.roomId);

    _room.getRecommendedVersion().then(v => {
      const tombstone = _room.currentState.getStateEvents(_event.EventType.RoomTombstone, "");

      const additionalStateChanges = {};

      const createEvent = _room.currentState.getStateEvents(_event.EventType.RoomCreate, "");

      const predecessor = createEvent ? createEvent.getContent().predecessor : null;

      if (predecessor && predecessor.room_id) {
        additionalStateChanges.oldRoomId = predecessor.room_id;
        additionalStateChanges.oldEventId = predecessor.event_id;
      }

      this.setState(_objectSpread({
        upgraded: !!(tombstone !== null && tombstone !== void 0 && tombstone.getContent().replacement_room),
        upgradeRecommendation: v
      }, additionalStateChanges));
    });
  }

  render() {
    const client = _MatrixClientPeg.MatrixClientPeg.get();

    const room = client.getRoom(this.props.roomId);
    let unfederatableSection;
    const createEvent = room.currentState.getStateEvents(_event.EventType.RoomCreate, '');

    if (createEvent && createEvent.getContent()['m.federate'] === false) {
      unfederatableSection = /*#__PURE__*/_react.default.createElement("div", null, (0, _languageHandler._t)('This room is not accessible by remote Matrix servers'));
    }

    let roomUpgradeButton;

    if (this.state.upgradeRecommendation && this.state.upgradeRecommendation.needsUpgrade && !this.state.upgraded) {
      roomUpgradeButton = /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("p", {
        className: "mx_SettingsTab_warningText"
      }, (0, _languageHandler._t)("<b>Warning</b>: Upgrading a room will <i>not automatically migrate room members " + "to the new version of the room.</i> We'll post a link to the new room in the old " + "version of the room - room members will have to click this link to join the new room.", {}, {
        "b": sub => /*#__PURE__*/_react.default.createElement("b", null, sub),
        "i": sub => /*#__PURE__*/_react.default.createElement("i", null, sub)
      })), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        onClick: this.upgradeRoom,
        kind: "primary"
      }, (0, _languageHandler._t)("Upgrade this room to the recommended room version")));
    }

    let oldRoomLink;

    if (this.state.oldRoomId) {
      let name = (0, _languageHandler._t)("this room");

      const room = _MatrixClientPeg.MatrixClientPeg.get().getRoom(this.props.roomId);

      if (room && room.name) name = room.name;
      oldRoomLink = /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        element: "a",
        onClick: this.onOldRoomClicked
      }, (0, _languageHandler._t)("View older messages in %(roomName)s.", {
        roomName: name
      }));
    }

    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_SettingsTab"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_SettingsTab_heading"
    }, (0, _languageHandler._t)("Advanced")), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_SettingsTab_section mx_SettingsTab_subsectionText"
    }, /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_SettingsTab_subheading"
    }, room !== null && room !== void 0 && room.isSpaceRoom() ? (0, _languageHandler._t)("Space information") : (0, _languageHandler._t)("Room information")), /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("span", null, (0, _languageHandler._t)("Internal room ID:")), "\xA0", this.props.roomId), unfederatableSection), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_SettingsTab_section mx_SettingsTab_subsectionText"
    }, /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_SettingsTab_subheading"
    }, (0, _languageHandler._t)("Room version")), /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("span", null, (0, _languageHandler._t)("Room version:")), "\xA0", room.getVersion()), oldRoomLink, roomUpgradeButton), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_SettingsTab_section mx_SettingsTab_subsectionText"
    }, /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_SettingsTab_subheading"
    }, (0, _languageHandler._t)("Developer options")), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      onClick: this.openDevtools,
      kind: "primary"
    }, (0, _languageHandler._t)("Open Devtools"))));
  }

}) || _class);
exports.default = AdvancedRoomSettingsTab;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3NldHRpbmdzL3RhYnMvcm9vbS9BZHZhbmNlZFJvb21TZXR0aW5nc1RhYi50c3giXSwibmFtZXMiOlsiQWR2YW5jZWRSb29tU2V0dGluZ3NUYWIiLCJSZWFjdCIsIkNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJjb250ZXh0IiwiZSIsInJvb20iLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJnZXRSb29tIiwicm9vbUlkIiwiTW9kYWwiLCJjcmVhdGVUcmFja2VkRGlhbG9nIiwiUm9vbVVwZ3JhZGVEaWFsb2ciLCJjcmVhdGVEaWFsb2ciLCJEZXZ0b29sc0RpYWxvZyIsInByZXZlbnREZWZhdWx0Iiwic3RvcFByb3BhZ2F0aW9uIiwiZGlzIiwiZGlzcGF0Y2giLCJhY3Rpb24iLCJBY3Rpb24iLCJWaWV3Um9vbSIsInJvb21faWQiLCJzdGF0ZSIsIm9sZFJvb21JZCIsImV2ZW50X2lkIiwib2xkRXZlbnRJZCIsImNsb3NlU2V0dGluZ3NGbiIsInVwZ3JhZGVSZWNvbW1lbmRhdGlvbiIsImdldFJlY29tbWVuZGVkVmVyc2lvbiIsInRoZW4iLCJ2IiwidG9tYnN0b25lIiwiY3VycmVudFN0YXRlIiwiZ2V0U3RhdGVFdmVudHMiLCJFdmVudFR5cGUiLCJSb29tVG9tYnN0b25lIiwiYWRkaXRpb25hbFN0YXRlQ2hhbmdlcyIsImNyZWF0ZUV2ZW50IiwiUm9vbUNyZWF0ZSIsInByZWRlY2Vzc29yIiwiZ2V0Q29udGVudCIsInNldFN0YXRlIiwidXBncmFkZWQiLCJyZXBsYWNlbWVudF9yb29tIiwicmVuZGVyIiwiY2xpZW50IiwidW5mZWRlcmF0YWJsZVNlY3Rpb24iLCJyb29tVXBncmFkZUJ1dHRvbiIsIm5lZWRzVXBncmFkZSIsInN1YiIsInVwZ3JhZGVSb29tIiwib2xkUm9vbUxpbmsiLCJuYW1lIiwib25PbGRSb29tQ2xpY2tlZCIsInJvb21OYW1lIiwiaXNTcGFjZVJvb20i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eUJBQUcsbUJBQUgsQ0FBOUMsQ0FESixlQUVJLDZCQUFDLHlCQUFEO0FBQWtCLE1BQUEsT0FBTyxFQUFFLEtBQUtVLFlBQWhDO0FBQThDLE1BQUEsSUFBSSxFQUFDO0FBQW5ELE9BQ00seUJBQUcsZUFBSCxDQUROLENBRkosQ0FyQkosQ0FESjtBQThCSDs7QUE3SGdGLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTkgLSAyMDIxIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IEV2ZW50VHlwZSB9IGZyb20gJ21hdHJpeC1qcy1zZGsvc3JjL0B0eXBlcy9ldmVudCc7XG5cbmltcG9ydCB7IF90IH0gZnJvbSBcIi4uLy4uLy4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlclwiO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSBcIi4uLy4uLy4uLy4uLy4uL01hdHJpeENsaWVudFBlZ1wiO1xuaW1wb3J0IEFjY2Vzc2libGVCdXR0b24gZnJvbSBcIi4uLy4uLy4uL2VsZW1lbnRzL0FjY2Vzc2libGVCdXR0b25cIjtcbmltcG9ydCBSb29tVXBncmFkZURpYWxvZyBmcm9tIFwiLi4vLi4vLi4vZGlhbG9ncy9Sb29tVXBncmFkZURpYWxvZ1wiO1xuaW1wb3J0IERldnRvb2xzRGlhbG9nIGZyb20gXCIuLi8uLi8uLi9kaWFsb2dzL0RldnRvb2xzRGlhbG9nXCI7XG5pbXBvcnQgTW9kYWwgZnJvbSBcIi4uLy4uLy4uLy4uLy4uL01vZGFsXCI7XG5pbXBvcnQgZGlzIGZyb20gXCIuLi8uLi8uLi8uLi8uLi9kaXNwYXRjaGVyL2Rpc3BhdGNoZXJcIjtcbmltcG9ydCB7IEFjdGlvbiB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL2Rpc3BhdGNoZXIvYWN0aW9ucyc7XG5pbXBvcnQgeyByZXBsYWNlYWJsZUNvbXBvbmVudCB9IGZyb20gXCIuLi8uLi8uLi8uLi8uLi91dGlscy9yZXBsYWNlYWJsZUNvbXBvbmVudFwiO1xuXG5pbnRlcmZhY2UgSVByb3BzIHtcbiAgICByb29tSWQ6IHN0cmluZztcbiAgICBjbG9zZVNldHRpbmdzRm4oKTogdm9pZDtcbn1cblxuaW50ZXJmYWNlIElSZWNvbW1lbmRlZFZlcnNpb24ge1xuICAgIHZlcnNpb246IHN0cmluZztcbiAgICBuZWVkc1VwZ3JhZGU6IGJvb2xlYW47XG4gICAgdXJnZW50OiBib29sZWFuO1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICB1cGdyYWRlUmVjb21tZW5kYXRpb24/OiBJUmVjb21tZW5kZWRWZXJzaW9uO1xuICAgIG9sZFJvb21JZD86IHN0cmluZztcbiAgICBvbGRFdmVudElkPzogc3RyaW5nO1xuICAgIHVwZ3JhZGVkPzogYm9vbGVhbjtcbn1cblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3Muc2V0dGluZ3MudGFicy5yb29tLkFkdmFuY2VkUm9vbVNldHRpbmdzVGFiXCIpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBZHZhbmNlZFJvb21TZXR0aW5nc1RhYiBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxJUHJvcHMsIElTdGF0ZT4ge1xuICAgIGNvbnN0cnVjdG9yKHByb3BzLCBjb250ZXh0KSB7XG4gICAgICAgIHN1cGVyKHByb3BzLCBjb250ZXh0KTtcblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgLy8gVGhpcyBpcyBldmVudHVhbGx5IHNldCB0byB0aGUgdmFsdWUgb2Ygcm9vbS5nZXRSZWNvbW1lbmRlZFZlcnNpb24oKVxuICAgICAgICAgICAgdXBncmFkZVJlY29tbWVuZGF0aW9uOiBudWxsLFxuICAgICAgICB9O1xuXG4gICAgICAgIC8vIHdlIGhhbmRsZSBsYWNrIG9mIHRoaXMgb2JqZWN0IGdyYWNlZnVsbHkgbGF0ZXIsIHNvIGRvbid0IHdvcnJ5IGFib3V0IGl0IGZhaWxpbmcgaGVyZS5cbiAgICAgICAgY29uc3Qgcm9vbSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRSb29tKHRoaXMucHJvcHMucm9vbUlkKTtcbiAgICAgICAgcm9vbS5nZXRSZWNvbW1lbmRlZFZlcnNpb24oKS50aGVuKCh2KSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0b21ic3RvbmUgPSByb29tLmN1cnJlbnRTdGF0ZS5nZXRTdGF0ZUV2ZW50cyhFdmVudFR5cGUuUm9vbVRvbWJzdG9uZSwgXCJcIik7XG5cbiAgICAgICAgICAgIGNvbnN0IGFkZGl0aW9uYWxTdGF0ZUNoYW5nZXM6IFBhcnRpYWw8SVN0YXRlPiA9IHt9O1xuICAgICAgICAgICAgY29uc3QgY3JlYXRlRXZlbnQgPSByb29tLmN1cnJlbnRTdGF0ZS5nZXRTdGF0ZUV2ZW50cyhFdmVudFR5cGUuUm9vbUNyZWF0ZSwgXCJcIik7XG4gICAgICAgICAgICBjb25zdCBwcmVkZWNlc3NvciA9IGNyZWF0ZUV2ZW50ID8gY3JlYXRlRXZlbnQuZ2V0Q29udGVudCgpLnByZWRlY2Vzc29yIDogbnVsbDtcbiAgICAgICAgICAgIGlmIChwcmVkZWNlc3NvciAmJiBwcmVkZWNlc3Nvci5yb29tX2lkKSB7XG4gICAgICAgICAgICAgICAgYWRkaXRpb25hbFN0YXRlQ2hhbmdlcy5vbGRSb29tSWQgPSBwcmVkZWNlc3Nvci5yb29tX2lkO1xuICAgICAgICAgICAgICAgIGFkZGl0aW9uYWxTdGF0ZUNoYW5nZXMub2xkRXZlbnRJZCA9IHByZWRlY2Vzc29yLmV2ZW50X2lkO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICB1cGdyYWRlZDogISF0b21ic3RvbmU/LmdldENvbnRlbnQoKS5yZXBsYWNlbWVudF9yb29tLFxuICAgICAgICAgICAgICAgIHVwZ3JhZGVSZWNvbW1lbmRhdGlvbjogdixcbiAgICAgICAgICAgICAgICAuLi5hZGRpdGlvbmFsU3RhdGVDaGFuZ2VzLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgdXBncmFkZVJvb20gPSAoZSkgPT4ge1xuICAgICAgICBjb25zdCByb29tID0gTWF0cml4Q2xpZW50UGVnLmdldCgpLmdldFJvb20odGhpcy5wcm9wcy5yb29tSWQpO1xuICAgICAgICBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nKCdVcGdyYWRlIFJvb20gVmVyc2lvbicsICcnLCBSb29tVXBncmFkZURpYWxvZywgeyByb29tIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9wZW5EZXZ0b29scyA9IChlKSA9PiB7XG4gICAgICAgIE1vZGFsLmNyZWF0ZURpYWxvZyhEZXZ0b29sc0RpYWxvZywgeyByb29tSWQ6IHRoaXMucHJvcHMucm9vbUlkIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uT2xkUm9vbUNsaWNrZWQgPSAoZSkgPT4ge1xuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG5cbiAgICAgICAgZGlzLmRpc3BhdGNoKHtcbiAgICAgICAgICAgIGFjdGlvbjogQWN0aW9uLlZpZXdSb29tLFxuICAgICAgICAgICAgcm9vbV9pZDogdGhpcy5zdGF0ZS5vbGRSb29tSWQsXG4gICAgICAgICAgICBldmVudF9pZDogdGhpcy5zdGF0ZS5vbGRFdmVudElkLFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5wcm9wcy5jbG9zZVNldHRpbmdzRm4oKTtcbiAgICB9O1xuXG4gICAgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCBjbGllbnQgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIGNvbnN0IHJvb20gPSBjbGllbnQuZ2V0Um9vbSh0aGlzLnByb3BzLnJvb21JZCk7XG5cbiAgICAgICAgbGV0IHVuZmVkZXJhdGFibGVTZWN0aW9uO1xuICAgICAgICBjb25zdCBjcmVhdGVFdmVudCA9IHJvb20uY3VycmVudFN0YXRlLmdldFN0YXRlRXZlbnRzKEV2ZW50VHlwZS5Sb29tQ3JlYXRlLCAnJyk7XG4gICAgICAgIGlmIChjcmVhdGVFdmVudCAmJiBjcmVhdGVFdmVudC5nZXRDb250ZW50KClbJ20uZmVkZXJhdGUnXSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgIHVuZmVkZXJhdGFibGVTZWN0aW9uID0gPGRpdj57IF90KCdUaGlzIHJvb20gaXMgbm90IGFjY2Vzc2libGUgYnkgcmVtb3RlIE1hdHJpeCBzZXJ2ZXJzJykgfTwvZGl2PjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCByb29tVXBncmFkZUJ1dHRvbjtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUudXBncmFkZVJlY29tbWVuZGF0aW9uICYmIHRoaXMuc3RhdGUudXBncmFkZVJlY29tbWVuZGF0aW9uLm5lZWRzVXBncmFkZSAmJiAhdGhpcy5zdGF0ZS51cGdyYWRlZCkge1xuICAgICAgICAgICAgcm9vbVVwZ3JhZGVCdXR0b24gPSAoXG4gICAgICAgICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgICAgICAgICAgPHAgY2xhc3NOYW1lPSdteF9TZXR0aW5nc1RhYl93YXJuaW5nVGV4dCc+XG4gICAgICAgICAgICAgICAgICAgICAgICB7IF90KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiPGI+V2FybmluZzwvYj46IFVwZ3JhZGluZyBhIHJvb20gd2lsbCA8aT5ub3QgYXV0b21hdGljYWxseSBtaWdyYXRlIHJvb20gbWVtYmVycyBcIiArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJ0byB0aGUgbmV3IHZlcnNpb24gb2YgdGhlIHJvb20uPC9pPiBXZSdsbCBwb3N0IGEgbGluayB0byB0aGUgbmV3IHJvb20gaW4gdGhlIG9sZCBcIiArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJ2ZXJzaW9uIG9mIHRoZSByb29tIC0gcm9vbSBtZW1iZXJzIHdpbGwgaGF2ZSB0byBjbGljayB0aGlzIGxpbmsgdG8gam9pbiB0aGUgbmV3IHJvb20uXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge30sIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJiXCI6IChzdWIpID0+IDxiPnsgc3ViIH08L2I+LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcImlcIjogKHN1YikgPT4gPGk+eyBzdWIgfTwvaT4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICkgfVxuICAgICAgICAgICAgICAgICAgICA8L3A+XG4gICAgICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uIG9uQ2xpY2s9e3RoaXMudXBncmFkZVJvb219IGtpbmQ9J3ByaW1hcnknPlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIlVwZ3JhZGUgdGhpcyByb29tIHRvIHRoZSByZWNvbW1lbmRlZCByb29tIHZlcnNpb25cIikgfVxuICAgICAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IG9sZFJvb21MaW5rO1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5vbGRSb29tSWQpIHtcbiAgICAgICAgICAgIGxldCBuYW1lID0gX3QoXCJ0aGlzIHJvb21cIik7XG4gICAgICAgICAgICBjb25zdCByb29tID0gTWF0cml4Q2xpZW50UGVnLmdldCgpLmdldFJvb20odGhpcy5wcm9wcy5yb29tSWQpO1xuICAgICAgICAgICAgaWYgKHJvb20gJiYgcm9vbS5uYW1lKSBuYW1lID0gcm9vbS5uYW1lO1xuICAgICAgICAgICAgb2xkUm9vbUxpbmsgPSAoXG4gICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b24gZWxlbWVudD0nYScgb25DbGljaz17dGhpcy5vbk9sZFJvb21DbGlja2VkfT5cbiAgICAgICAgICAgICAgICAgICAgeyBfdChcIlZpZXcgb2xkZXIgbWVzc2FnZXMgaW4gJShyb29tTmFtZSlzLlwiLCB7IHJvb21OYW1lOiBuYW1lIH0pIH1cbiAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfU2V0dGluZ3NUYWJcIj5cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X1NldHRpbmdzVGFiX2hlYWRpbmdcIj57IF90KFwiQWR2YW5jZWRcIikgfTwvZGl2PlxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdteF9TZXR0aW5nc1RhYl9zZWN0aW9uIG14X1NldHRpbmdzVGFiX3N1YnNlY3Rpb25UZXh0Jz5cbiAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3NOYW1lPSdteF9TZXR0aW5nc1RhYl9zdWJoZWFkaW5nJz5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgcm9vbT8uaXNTcGFjZVJvb20oKSA/IF90KFwiU3BhY2UgaW5mb3JtYXRpb25cIikgOiBfdChcIlJvb20gaW5mb3JtYXRpb25cIikgfVxuICAgICAgICAgICAgICAgICAgICA8L3NwYW4+XG4gICAgICAgICAgICAgICAgICAgIDxkaXY+XG4gICAgICAgICAgICAgICAgICAgICAgICA8c3Bhbj57IF90KFwiSW50ZXJuYWwgcm9vbSBJRDpcIikgfTwvc3Bhbj4mbmJzcDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHsgdGhpcy5wcm9wcy5yb29tSWQgfVxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgeyB1bmZlZGVyYXRhYmxlU2VjdGlvbiB9XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J214X1NldHRpbmdzVGFiX3NlY3Rpb24gbXhfU2V0dGluZ3NUYWJfc3Vic2VjdGlvblRleHQnPlxuICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9J214X1NldHRpbmdzVGFiX3N1YmhlYWRpbmcnPnsgX3QoXCJSb29tIHZlcnNpb25cIikgfTwvc3Bhbj5cbiAgICAgICAgICAgICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuPnsgX3QoXCJSb29tIHZlcnNpb246XCIpIH08L3NwYW4+Jm5ic3A7XG4gICAgICAgICAgICAgICAgICAgICAgICB7IHJvb20uZ2V0VmVyc2lvbigpIH1cbiAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgIHsgb2xkUm9vbUxpbmsgfVxuICAgICAgICAgICAgICAgICAgICB7IHJvb21VcGdyYWRlQnV0dG9uIH1cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nbXhfU2V0dGluZ3NUYWJfc2VjdGlvbiBteF9TZXR0aW5nc1RhYl9zdWJzZWN0aW9uVGV4dCc+XG4gICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT0nbXhfU2V0dGluZ3NUYWJfc3ViaGVhZGluZyc+eyBfdChcIkRldmVsb3BlciBvcHRpb25zXCIpIH08L3NwYW4+XG4gICAgICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uIG9uQ2xpY2s9e3RoaXMub3BlbkRldnRvb2xzfSBraW5kPSdwcmltYXJ5Jz5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCJPcGVuIERldnRvb2xzXCIpIH1cbiAgICAgICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICk7XG4gICAgfVxufVxuIl19