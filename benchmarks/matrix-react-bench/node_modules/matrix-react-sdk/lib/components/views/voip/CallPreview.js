"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _CallView = _interopRequireDefault(require("./CallView"));

var _RoomViewStore = _interopRequireDefault(require("../../../stores/RoomViewStore"));

var _CallHandler = _interopRequireWildcard(require("../../../CallHandler"));

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var _PersistentApp = _interopRequireDefault(require("../elements/PersistentApp"));

var _SettingsStore = _interopRequireDefault(require("../../../settings/SettingsStore"));

var _call = require("matrix-js-sdk/src/webrtc/call");

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _PictureInPictureDragger = _interopRequireDefault(require("./PictureInPictureDragger"));

var _logger = require("matrix-js-sdk/src/logger");

var _WidgetLayoutStore = require("../../../stores/widgets/WidgetLayoutStore");

var _dec, _class;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

const SHOW_CALL_IN_STATES = [_call.CallState.Connected, _call.CallState.InviteSent, _call.CallState.Connecting, _call.CallState.CreateAnswer, _call.CallState.CreateOffer, _call.CallState.WaitLocalMedia];

// Splits a list of calls into one 'primary' one and a list
// (which should be a single element) of other calls.
// The primary will be the one not on hold, or an arbitrary one
// if they're all on hold)
function getPrimarySecondaryCallsForPip(roomId) {
  const calls = _CallHandler.default.sharedInstance().getAllActiveCallsForPip(roomId);

  let primary = null;
  let secondaries = [];

  for (const call of calls) {
    if (!SHOW_CALL_IN_STATES.includes(call.state)) continue;

    if (!call.isRemoteOnHold() && primary === null) {
      primary = call;
    } else {
      secondaries.push(call);
    }
  }

  if (primary === null && secondaries.length > 0) {
    primary = secondaries[0];
    secondaries = secondaries.slice(1);
  }

  if (secondaries.length > 1) {
    // We should never be in more than two calls so this shouldn't happen
    _logger.logger.log("Found more than 1 secondary call! Other calls will not be shown.");
  }

  return [primary, secondaries];
}
/**
 * CallPreview shows a small version of CallView hovering over the UI in 'picture-in-picture'
 * (PiP mode). It displays the call(s) which is *not* in the room the user is currently viewing.
 */


let CallPreview = (_dec = (0, _replaceableComponent.replaceableComponent)("views.voip.CallPreview"), _dec(_class = class CallPreview extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "roomStoreToken", void 0);
    (0, _defineProperty2.default)(this, "dispatcherRef", void 0);
    (0, _defineProperty2.default)(this, "settingsWatcherRef", void 0);
    (0, _defineProperty2.default)(this, "onRoomViewStoreUpdate", () => {
      var _MatrixClientPeg$get, _MatrixClientPeg$get2;

      const newRoomId = _RoomViewStore.default.getRoomId();

      const oldRoomId = this.state.roomId;
      if (newRoomId === oldRoomId) return; // The WidgetLayoutStore observer always tracks the currently viewed Room,
      // so we don't end up with multiple observers and know what observer to remove on unmount

      const oldRoom = (_MatrixClientPeg$get = _MatrixClientPeg.MatrixClientPeg.get()) === null || _MatrixClientPeg$get === void 0 ? void 0 : _MatrixClientPeg$get.getRoom(oldRoomId);

      if (oldRoom) {
        _WidgetLayoutStore.WidgetLayoutStore.instance.off(_WidgetLayoutStore.WidgetLayoutStore.emissionForRoom(oldRoom), this.updateCalls);
      }

      const newRoom = (_MatrixClientPeg$get2 = _MatrixClientPeg.MatrixClientPeg.get()) === null || _MatrixClientPeg$get2 === void 0 ? void 0 : _MatrixClientPeg$get2.getRoom(newRoomId);

      if (newRoom) {
        _WidgetLayoutStore.WidgetLayoutStore.instance.on(_WidgetLayoutStore.WidgetLayoutStore.emissionForRoom(newRoom), this.updateCalls);
      }

      if (!newRoomId) return;
      const [primaryCall, secondaryCalls] = getPrimarySecondaryCallsForPip(newRoomId);
      this.setState({
        roomId: newRoomId,
        primaryCall: primaryCall,
        secondaryCall: secondaryCalls[0]
      });
    });
    (0, _defineProperty2.default)(this, "onAction", payload => {
      switch (payload.action) {
        case 'call_state':
          {
            // listen for call state changes to prod the render method, which
            // may hide the global CallView if the call it is tracking is dead
            this.updateCalls();
            break;
          }
      }
    });
    (0, _defineProperty2.default)(this, "updateCalls", () => {
      if (!this.state.roomId) return;
      const [primaryCall, secondaryCalls] = getPrimarySecondaryCallsForPip(this.state.roomId);
      this.setState({
        primaryCall: primaryCall,
        secondaryCall: secondaryCalls[0]
      });
    });
    (0, _defineProperty2.default)(this, "onCallRemoteHold", () => {
      if (!this.state.roomId) return;
      const [primaryCall, secondaryCalls] = getPrimarySecondaryCallsForPip(this.state.roomId);
      this.setState({
        primaryCall: primaryCall,
        secondaryCall: secondaryCalls[0]
      });
    });
    (0, _defineProperty2.default)(this, "onDoubleClick", () => {
      _dispatcher.default.dispatch({
        action: "view_room",
        room_id: this.state.primaryCall.roomId
      });
    });

    const roomId = _RoomViewStore.default.getRoomId();

    const [_primaryCall, _secondaryCalls] = getPrimarySecondaryCallsForPip(roomId);
    this.state = {
      roomId,
      primaryCall: _primaryCall,
      secondaryCall: _secondaryCalls[0]
    };
  }

  componentDidMount() {
    var _MatrixClientPeg$get3;

    _CallHandler.default.sharedInstance().addListener(_CallHandler.CallHandlerEvent.CallChangeRoom, this.updateCalls);

    this.roomStoreToken = _RoomViewStore.default.addListener(this.onRoomViewStoreUpdate);
    this.dispatcherRef = _dispatcher.default.register(this.onAction);

    _MatrixClientPeg.MatrixClientPeg.get().on(_call.CallEvent.RemoteHoldUnhold, this.onCallRemoteHold);

    const room = (_MatrixClientPeg$get3 = _MatrixClientPeg.MatrixClientPeg.get()) === null || _MatrixClientPeg$get3 === void 0 ? void 0 : _MatrixClientPeg$get3.getRoom(this.state.roomId);

    if (room) {
      _WidgetLayoutStore.WidgetLayoutStore.instance.on(_WidgetLayoutStore.WidgetLayoutStore.emissionForRoom(room), this.updateCalls);
    }
  }

  componentWillUnmount() {
    _CallHandler.default.sharedInstance().removeListener(_CallHandler.CallHandlerEvent.CallChangeRoom, this.updateCalls);

    _MatrixClientPeg.MatrixClientPeg.get().removeListener(_call.CallEvent.RemoteHoldUnhold, this.onCallRemoteHold);

    if (this.roomStoreToken) {
      this.roomStoreToken.remove();
    }

    _dispatcher.default.unregister(this.dispatcherRef);

    _SettingsStore.default.unwatchSetting(this.settingsWatcherRef);

    const room = _MatrixClientPeg.MatrixClientPeg.get().getRoom(this.state.roomId);

    _WidgetLayoutStore.WidgetLayoutStore.instance.off(_WidgetLayoutStore.WidgetLayoutStore.emissionForRoom(room), this.updateCalls);
  }

  render() {
    const pipMode = true;

    if (this.state.primaryCall) {
      return /*#__PURE__*/_react.default.createElement(_PictureInPictureDragger.default, {
        className: "mx_CallPreview",
        draggable: pipMode,
        onDoubleClick: this.onDoubleClick
      }, ({
        onStartMoving,
        onResize
      }) => /*#__PURE__*/_react.default.createElement(_CallView.default, {
        onMouseDownOnHeader: onStartMoving,
        call: this.state.primaryCall,
        secondaryCall: this.state.secondaryCall,
        pipMode: pipMode,
        onResize: onResize
      }));
    }

    return /*#__PURE__*/_react.default.createElement(_PersistentApp.default, null);
  }

}) || _class);
exports.default = CallPreview;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3ZvaXAvQ2FsbFByZXZpZXcudHN4Il0sIm5hbWVzIjpbIlNIT1dfQ0FMTF9JTl9TVEFURVMiLCJDYWxsU3RhdGUiLCJDb25uZWN0ZWQiLCJJbnZpdGVTZW50IiwiQ29ubmVjdGluZyIsIkNyZWF0ZUFuc3dlciIsIkNyZWF0ZU9mZmVyIiwiV2FpdExvY2FsTWVkaWEiLCJnZXRQcmltYXJ5U2Vjb25kYXJ5Q2FsbHNGb3JQaXAiLCJyb29tSWQiLCJjYWxscyIsIkNhbGxIYW5kbGVyIiwic2hhcmVkSW5zdGFuY2UiLCJnZXRBbGxBY3RpdmVDYWxsc0ZvclBpcCIsInByaW1hcnkiLCJzZWNvbmRhcmllcyIsImNhbGwiLCJpbmNsdWRlcyIsInN0YXRlIiwiaXNSZW1vdGVPbkhvbGQiLCJwdXNoIiwibGVuZ3RoIiwic2xpY2UiLCJsb2dnZXIiLCJsb2ciLCJDYWxsUHJldmlldyIsIlJlYWN0IiwiQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsIm5ld1Jvb21JZCIsIlJvb21WaWV3U3RvcmUiLCJnZXRSb29tSWQiLCJvbGRSb29tSWQiLCJvbGRSb29tIiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0IiwiZ2V0Um9vbSIsIldpZGdldExheW91dFN0b3JlIiwiaW5zdGFuY2UiLCJvZmYiLCJlbWlzc2lvbkZvclJvb20iLCJ1cGRhdGVDYWxscyIsIm5ld1Jvb20iLCJvbiIsInByaW1hcnlDYWxsIiwic2Vjb25kYXJ5Q2FsbHMiLCJzZXRTdGF0ZSIsInNlY29uZGFyeUNhbGwiLCJwYXlsb2FkIiwiYWN0aW9uIiwiZGlzIiwiZGlzcGF0Y2giLCJyb29tX2lkIiwiY29tcG9uZW50RGlkTW91bnQiLCJhZGRMaXN0ZW5lciIsIkNhbGxIYW5kbGVyRXZlbnQiLCJDYWxsQ2hhbmdlUm9vbSIsInJvb21TdG9yZVRva2VuIiwib25Sb29tVmlld1N0b3JlVXBkYXRlIiwiZGlzcGF0Y2hlclJlZiIsInJlZ2lzdGVyIiwib25BY3Rpb24iLCJDYWxsRXZlbnQiLCJSZW1vdGVIb2xkVW5ob2xkIiwib25DYWxsUmVtb3RlSG9sZCIsInJvb20iLCJjb21wb25lbnRXaWxsVW5tb3VudCIsInJlbW92ZUxpc3RlbmVyIiwicmVtb3ZlIiwidW5yZWdpc3RlciIsIlNldHRpbmdzU3RvcmUiLCJ1bndhdGNoU2V0dGluZyIsInNldHRpbmdzV2F0Y2hlclJlZiIsInJlbmRlciIsInBpcE1vZGUiLCJvbkRvdWJsZUNsaWNrIiwib25TdGFydE1vdmluZyIsIm9uUmVzaXplIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWlCQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFFQTs7QUFDQTs7Ozs7Ozs7QUFFQSxNQUFNQSxtQkFBbUIsR0FBRyxDQUN4QkMsZ0JBQVVDLFNBRGMsRUFFeEJELGdCQUFVRSxVQUZjLEVBR3hCRixnQkFBVUcsVUFIYyxFQUl4QkgsZ0JBQVVJLFlBSmMsRUFLeEJKLGdCQUFVSyxXQUxjLEVBTXhCTCxnQkFBVU0sY0FOYyxDQUE1Qjs7QUF1QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTQyw4QkFBVCxDQUF3Q0MsTUFBeEMsRUFBb0Y7QUFDaEYsUUFBTUMsS0FBSyxHQUFHQyxxQkFBWUMsY0FBWixHQUE2QkMsdUJBQTdCLENBQXFESixNQUFyRCxDQUFkOztBQUVBLE1BQUlLLE9BQW1CLEdBQUcsSUFBMUI7QUFDQSxNQUFJQyxXQUF5QixHQUFHLEVBQWhDOztBQUVBLE9BQUssTUFBTUMsSUFBWCxJQUFtQk4sS0FBbkIsRUFBMEI7QUFDdEIsUUFBSSxDQUFDVixtQkFBbUIsQ0FBQ2lCLFFBQXBCLENBQTZCRCxJQUFJLENBQUNFLEtBQWxDLENBQUwsRUFBK0M7O0FBRS9DLFFBQUksQ0FBQ0YsSUFBSSxDQUFDRyxjQUFMLEVBQUQsSUFBMEJMLE9BQU8sS0FBSyxJQUExQyxFQUFnRDtBQUM1Q0EsTUFBQUEsT0FBTyxHQUFHRSxJQUFWO0FBQ0gsS0FGRCxN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QUFBakIsT0FBRCxrQkFBaUMsNkJBQUMsaUJBQUQ7QUFDL0IsUUFBQSxtQkFBbUIsRUFBRUQsYUFEVTtBQUUvQixRQUFBLElBQUksRUFBRSxLQUFLM0QsS0FBTCxDQUFXMkIsV0FGYztBQUcvQixRQUFBLGFBQWEsRUFBRSxLQUFLM0IsS0FBTCxDQUFXOEIsYUFISztBQUkvQixRQUFBLE9BQU8sRUFBRTJCLE9BSnNCO0FBSy9CLFFBQUEsUUFBUSxFQUFFRztBQUxxQixRQUx2QyxDQURKO0FBZ0JIOztBQUVELHdCQUFPLDZCQUFDLHNCQUFELE9BQVA7QUFDSDs7QUEvSG9FLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTcsIDIwMTggTmV3IFZlY3RvciBMdGRcbkNvcHlyaWdodCAyMDE5LCAyMDIwIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcblxuaW1wb3J0IENhbGxWaWV3IGZyb20gXCIuL0NhbGxWaWV3XCI7XG5pbXBvcnQgUm9vbVZpZXdTdG9yZSBmcm9tICcuLi8uLi8uLi9zdG9yZXMvUm9vbVZpZXdTdG9yZSc7XG5pbXBvcnQgQ2FsbEhhbmRsZXIsIHsgQ2FsbEhhbmRsZXJFdmVudCB9IGZyb20gJy4uLy4uLy4uL0NhbGxIYW5kbGVyJztcbmltcG9ydCBkaXMgZnJvbSAnLi4vLi4vLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyJztcbmltcG9ydCB7IEFjdGlvblBheWxvYWQgfSBmcm9tICcuLi8uLi8uLi9kaXNwYXRjaGVyL3BheWxvYWRzJztcbmltcG9ydCBQZXJzaXN0ZW50QXBwIGZyb20gXCIuLi9lbGVtZW50cy9QZXJzaXN0ZW50QXBwXCI7XG5pbXBvcnQgU2V0dGluZ3NTdG9yZSBmcm9tIFwiLi4vLi4vLi4vc2V0dGluZ3MvU2V0dGluZ3NTdG9yZVwiO1xuaW1wb3J0IHsgQ2FsbEV2ZW50LCBDYWxsU3RhdGUsIE1hdHJpeENhbGwgfSBmcm9tICdtYXRyaXgtanMtc2RrL3NyYy93ZWJydGMvY2FsbCc7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tICcuLi8uLi8uLi9NYXRyaXhDbGllbnRQZWcnO1xuaW1wb3J0IHsgcmVwbGFjZWFibGVDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvcmVwbGFjZWFibGVDb21wb25lbnRcIjtcbmltcG9ydCB7IEV2ZW50U3Vic2NyaXB0aW9uIH0gZnJvbSAnZmJlbWl0dGVyJztcbmltcG9ydCBQaWN0dXJlSW5QaWN0dXJlRHJhZ2dlciBmcm9tICcuL1BpY3R1cmVJblBpY3R1cmVEcmFnZ2VyJztcblxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2xvZ2dlclwiO1xuaW1wb3J0IHsgV2lkZ2V0TGF5b3V0U3RvcmUgfSBmcm9tICcuLi8uLi8uLi9zdG9yZXMvd2lkZ2V0cy9XaWRnZXRMYXlvdXRTdG9yZSc7XG5cbmNvbnN0IFNIT1dfQ0FMTF9JTl9TVEFURVMgPSBbXG4gICAgQ2FsbFN0YXRlLkNvbm5lY3RlZCxcbiAgICBDYWxsU3RhdGUuSW52aXRlU2VudCxcbiAgICBDYWxsU3RhdGUuQ29ubmVjdGluZyxcbiAgICBDYWxsU3RhdGUuQ3JlYXRlQW5zd2VyLFxuICAgIENhbGxTdGF0ZS5DcmVhdGVPZmZlcixcbiAgICBDYWxsU3RhdGUuV2FpdExvY2FsTWVkaWEsXG5dO1xuXG5pbnRlcmZhY2UgSVByb3BzIHtcbn1cblxuaW50ZXJmYWNlIElTdGF0ZSB7XG4gICAgcm9vbUlkOiBzdHJpbmc7XG5cbiAgICAvLyBUaGUgbWFpbiBjYWxsIHRoYXQgd2UgYXJlIGRpc3BsYXlpbmcgKGllLiBub3QgaW5jbHVkaW5nIHRoZSBjYWxsIGluIHRoZSByb29tIGJlaW5nIHZpZXdlZCwgaWYgYW55KVxuICAgIHByaW1hcnlDYWxsOiBNYXRyaXhDYWxsO1xuXG4gICAgLy8gQW55IG90aGVyIGNhbGwgd2UncmUgZGlzcGxheWluZzogb25seSBpZiB0aGUgdXNlciBpcyBvbiB0d28gY2FsbHMgYW5kIG5vdCB2aWV3aW5nIGVpdGhlciBvZiB0aGUgcm9vbXNcbiAgICAvLyB0aGV5IGJlbG9uZyB0b1xuICAgIHNlY29uZGFyeUNhbGw6IE1hdHJpeENhbGw7XG59XG5cbi8vIFNwbGl0cyBhIGxpc3Qgb2YgY2FsbHMgaW50byBvbmUgJ3ByaW1hcnknIG9uZSBhbmQgYSBsaXN0XG4vLyAod2hpY2ggc2hvdWxkIGJlIGEgc2luZ2xlIGVsZW1lbnQpIG9mIG90aGVyIGNhbGxzLlxuLy8gVGhlIHByaW1hcnkgd2lsbCBiZSB0aGUgb25lIG5vdCBvbiBob2xkLCBvciBhbiBhcmJpdHJhcnkgb25lXG4vLyBpZiB0aGV5J3JlIGFsbCBvbiBob2xkKVxuZnVuY3Rpb24gZ2V0UHJpbWFyeVNlY29uZGFyeUNhbGxzRm9yUGlwKHJvb21JZDogc3RyaW5nKTogW01hdHJpeENhbGwsIE1hdHJpeENhbGxbXV0ge1xuICAgIGNvbnN0IGNhbGxzID0gQ2FsbEhhbmRsZXIuc2hhcmVkSW5zdGFuY2UoKS5nZXRBbGxBY3RpdmVDYWxsc0ZvclBpcChyb29tSWQpO1xuXG4gICAgbGV0IHByaW1hcnk6IE1hdHJpeENhbGwgPSBudWxsO1xuICAgIGxldCBzZWNvbmRhcmllczogTWF0cml4Q2FsbFtdID0gW107XG5cbiAgICBmb3IgKGNvbnN0IGNhbGwgb2YgY2FsbHMpIHtcbiAgICAgICAgaWYgKCFTSE9XX0NBTExfSU5fU1RBVEVTLmluY2x1ZGVzKGNhbGwuc3RhdGUpKSBjb250aW51ZTtcblxuICAgICAgICBpZiAoIWNhbGwuaXNSZW1vdGVPbkhvbGQoKSAmJiBwcmltYXJ5ID09PSBudWxsKSB7XG4gICAgICAgICAgICBwcmltYXJ5ID0gY2FsbDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHNlY29uZGFyaWVzLnB1c2goY2FsbCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAocHJpbWFyeSA9PT0gbnVsbCAmJiBzZWNvbmRhcmllcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHByaW1hcnkgPSBzZWNvbmRhcmllc1swXTtcbiAgICAgICAgc2Vjb25kYXJpZXMgPSBzZWNvbmRhcmllcy5zbGljZSgxKTtcbiAgICB9XG5cbiAgICBpZiAoc2Vjb25kYXJpZXMubGVuZ3RoID4gMSkge1xuICAgICAgICAvLyBXZSBzaG91bGQgbmV2ZXIgYmUgaW4gbW9yZSB0aGFuIHR3byBjYWxscyBzbyB0aGlzIHNob3VsZG4ndCBoYXBwZW5cbiAgICAgICAgbG9nZ2VyLmxvZyhcIkZvdW5kIG1vcmUgdGhhbiAxIHNlY29uZGFyeSBjYWxsISBPdGhlciBjYWxscyB3aWxsIG5vdCBiZSBzaG93bi5cIik7XG4gICAgfVxuXG4gICAgcmV0dXJuIFtwcmltYXJ5LCBzZWNvbmRhcmllc107XG59XG5cbi8qKlxuICogQ2FsbFByZXZpZXcgc2hvd3MgYSBzbWFsbCB2ZXJzaW9uIG9mIENhbGxWaWV3IGhvdmVyaW5nIG92ZXIgdGhlIFVJIGluICdwaWN0dXJlLWluLXBpY3R1cmUnXG4gKiAoUGlQIG1vZGUpLiBJdCBkaXNwbGF5cyB0aGUgY2FsbChzKSB3aGljaCBpcyAqbm90KiBpbiB0aGUgcm9vbSB0aGUgdXNlciBpcyBjdXJyZW50bHkgdmlld2luZy5cbiAqL1xuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3Mudm9pcC5DYWxsUHJldmlld1wiKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ2FsbFByZXZpZXcgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8SVByb3BzLCBJU3RhdGU+IHtcbiAgICBwcml2YXRlIHJvb21TdG9yZVRva2VuOiBFdmVudFN1YnNjcmlwdGlvbjtcbiAgICBwcml2YXRlIGRpc3BhdGNoZXJSZWY6IHN0cmluZztcbiAgICBwcml2YXRlIHNldHRpbmdzV2F0Y2hlclJlZjogc3RyaW5nO1xuXG4gICAgY29uc3RydWN0b3IocHJvcHM6IElQcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG5cbiAgICAgICAgY29uc3Qgcm9vbUlkID0gUm9vbVZpZXdTdG9yZS5nZXRSb29tSWQoKTtcblxuICAgICAgICBjb25zdCBbcHJpbWFyeUNhbGwsIHNlY29uZGFyeUNhbGxzXSA9IGdldFByaW1hcnlTZWNvbmRhcnlDYWxsc0ZvclBpcChyb29tSWQpO1xuXG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICByb29tSWQsXG4gICAgICAgICAgICBwcmltYXJ5Q2FsbDogcHJpbWFyeUNhbGwsXG4gICAgICAgICAgICBzZWNvbmRhcnlDYWxsOiBzZWNvbmRhcnlDYWxsc1swXSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgICAgIENhbGxIYW5kbGVyLnNoYXJlZEluc3RhbmNlKCkuYWRkTGlzdGVuZXIoQ2FsbEhhbmRsZXJFdmVudC5DYWxsQ2hhbmdlUm9vbSwgdGhpcy51cGRhdGVDYWxscyk7XG4gICAgICAgIHRoaXMucm9vbVN0b3JlVG9rZW4gPSBSb29tVmlld1N0b3JlLmFkZExpc3RlbmVyKHRoaXMub25Sb29tVmlld1N0b3JlVXBkYXRlKTtcbiAgICAgICAgdGhpcy5kaXNwYXRjaGVyUmVmID0gZGlzLnJlZ2lzdGVyKHRoaXMub25BY3Rpb24pO1xuICAgICAgICBNYXRyaXhDbGllbnRQZWcuZ2V0KCkub24oQ2FsbEV2ZW50LlJlbW90ZUhvbGRVbmhvbGQsIHRoaXMub25DYWxsUmVtb3RlSG9sZCk7XG4gICAgICAgIGNvbnN0IHJvb20gPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk/LmdldFJvb20odGhpcy5zdGF0ZS5yb29tSWQpO1xuICAgICAgICBpZiAocm9vbSkge1xuICAgICAgICAgICAgV2lkZ2V0TGF5b3V0U3RvcmUuaW5zdGFuY2Uub24oV2lkZ2V0TGF5b3V0U3RvcmUuZW1pc3Npb25Gb3JSb29tKHJvb20pLCB0aGlzLnVwZGF0ZUNhbGxzKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICAgICAgQ2FsbEhhbmRsZXIuc2hhcmVkSW5zdGFuY2UoKS5yZW1vdmVMaXN0ZW5lcihDYWxsSGFuZGxlckV2ZW50LkNhbGxDaGFuZ2VSb29tLCB0aGlzLnVwZGF0ZUNhbGxzKTtcbiAgICAgICAgTWF0cml4Q2xpZW50UGVnLmdldCgpLnJlbW92ZUxpc3RlbmVyKENhbGxFdmVudC5SZW1vdGVIb2xkVW5ob2xkLCB0aGlzLm9uQ2FsbFJlbW90ZUhvbGQpO1xuICAgICAgICBpZiAodGhpcy5yb29tU3RvcmVUb2tlbikge1xuICAgICAgICAgICAgdGhpcy5yb29tU3RvcmVUb2tlbi5yZW1vdmUoKTtcbiAgICAgICAgfVxuICAgICAgICBkaXMudW5yZWdpc3Rlcih0aGlzLmRpc3BhdGNoZXJSZWYpO1xuICAgICAgICBTZXR0aW5nc1N0b3JlLnVud2F0Y2hTZXR0aW5nKHRoaXMuc2V0dGluZ3NXYXRjaGVyUmVmKTtcbiAgICAgICAgY29uc3Qgcm9vbSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRSb29tKHRoaXMuc3RhdGUucm9vbUlkKTtcbiAgICAgICAgV2lkZ2V0TGF5b3V0U3RvcmUuaW5zdGFuY2Uub2ZmKFdpZGdldExheW91dFN0b3JlLmVtaXNzaW9uRm9yUm9vbShyb29tKSwgdGhpcy51cGRhdGVDYWxscyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvblJvb21WaWV3U3RvcmVVcGRhdGUgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IG5ld1Jvb21JZCA9IFJvb21WaWV3U3RvcmUuZ2V0Um9vbUlkKCk7XG4gICAgICAgIGNvbnN0IG9sZFJvb21JZCA9IHRoaXMuc3RhdGUucm9vbUlkO1xuICAgICAgICBpZiAobmV3Um9vbUlkID09PSBvbGRSb29tSWQpIHJldHVybjtcbiAgICAgICAgLy8gVGhlIFdpZGdldExheW91dFN0b3JlIG9ic2VydmVyIGFsd2F5cyB0cmFja3MgdGhlIGN1cnJlbnRseSB2aWV3ZWQgUm9vbSxcbiAgICAgICAgLy8gc28gd2UgZG9uJ3QgZW5kIHVwIHdpdGggbXVsdGlwbGUgb2JzZXJ2ZXJzIGFuZCBrbm93IHdoYXQgb2JzZXJ2ZXIgdG8gcmVtb3ZlIG9uIHVubW91bnRcbiAgICAgICAgY29uc3Qgb2xkUm9vbSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKT8uZ2V0Um9vbShvbGRSb29tSWQpO1xuICAgICAgICBpZiAob2xkUm9vbSkge1xuICAgICAgICAgICAgV2lkZ2V0TGF5b3V0U3RvcmUuaW5zdGFuY2Uub2ZmKFdpZGdldExheW91dFN0b3JlLmVtaXNzaW9uRm9yUm9vbShvbGRSb29tKSwgdGhpcy51cGRhdGVDYWxscyk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgbmV3Um9vbSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKT8uZ2V0Um9vbShuZXdSb29tSWQpO1xuICAgICAgICBpZiAobmV3Um9vbSkge1xuICAgICAgICAgICAgV2lkZ2V0TGF5b3V0U3RvcmUuaW5zdGFuY2Uub24oV2lkZ2V0TGF5b3V0U3RvcmUuZW1pc3Npb25Gb3JSb29tKG5ld1Jvb20pLCB0aGlzLnVwZGF0ZUNhbGxzKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIW5ld1Jvb21JZCkgcmV0dXJuO1xuXG4gICAgICAgIGNvbnN0IFtwcmltYXJ5Q2FsbCwgc2Vjb25kYXJ5Q2FsbHNdID0gZ2V0UHJpbWFyeVNlY29uZGFyeUNhbGxzRm9yUGlwKG5ld1Jvb21JZCk7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgcm9vbUlkOiBuZXdSb29tSWQsXG4gICAgICAgICAgICBwcmltYXJ5Q2FsbDogcHJpbWFyeUNhbGwsXG4gICAgICAgICAgICBzZWNvbmRhcnlDYWxsOiBzZWNvbmRhcnlDYWxsc1swXSxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25BY3Rpb24gPSAocGF5bG9hZDogQWN0aW9uUGF5bG9hZCkgPT4ge1xuICAgICAgICBzd2l0Y2ggKHBheWxvYWQuYWN0aW9uKSB7XG4gICAgICAgICAgICBjYXNlICdjYWxsX3N0YXRlJzoge1xuICAgICAgICAgICAgICAgIC8vIGxpc3RlbiBmb3IgY2FsbCBzdGF0ZSBjaGFuZ2VzIHRvIHByb2QgdGhlIHJlbmRlciBtZXRob2QsIHdoaWNoXG4gICAgICAgICAgICAgICAgLy8gbWF5IGhpZGUgdGhlIGdsb2JhbCBDYWxsVmlldyBpZiB0aGUgY2FsbCBpdCBpcyB0cmFja2luZyBpcyBkZWFkXG5cbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUNhbGxzKCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSB1cGRhdGVDYWxscyA9ICgpID0+IHtcbiAgICAgICAgaWYgKCF0aGlzLnN0YXRlLnJvb21JZCkgcmV0dXJuO1xuICAgICAgICBjb25zdCBbcHJpbWFyeUNhbGwsIHNlY29uZGFyeUNhbGxzXSA9IGdldFByaW1hcnlTZWNvbmRhcnlDYWxsc0ZvclBpcCh0aGlzLnN0YXRlLnJvb21JZCk7XG5cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBwcmltYXJ5Q2FsbDogcHJpbWFyeUNhbGwsXG4gICAgICAgICAgICBzZWNvbmRhcnlDYWxsOiBzZWNvbmRhcnlDYWxsc1swXSxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25DYWxsUmVtb3RlSG9sZCA9ICgpID0+IHtcbiAgICAgICAgaWYgKCF0aGlzLnN0YXRlLnJvb21JZCkgcmV0dXJuO1xuICAgICAgICBjb25zdCBbcHJpbWFyeUNhbGwsIHNlY29uZGFyeUNhbGxzXSA9IGdldFByaW1hcnlTZWNvbmRhcnlDYWxsc0ZvclBpcCh0aGlzLnN0YXRlLnJvb21JZCk7XG5cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBwcmltYXJ5Q2FsbDogcHJpbWFyeUNhbGwsXG4gICAgICAgICAgICBzZWNvbmRhcnlDYWxsOiBzZWNvbmRhcnlDYWxsc1swXSxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25Eb3VibGVDbGljayA9ICgpOiB2b2lkID0+IHtcbiAgICAgICAgZGlzLmRpc3BhdGNoKHtcbiAgICAgICAgICAgIGFjdGlvbjogXCJ2aWV3X3Jvb21cIixcbiAgICAgICAgICAgIHJvb21faWQ6IHRoaXMuc3RhdGUucHJpbWFyeUNhbGwucm9vbUlkLFxuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgcHVibGljIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3QgcGlwTW9kZSA9IHRydWU7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnByaW1hcnlDYWxsKSB7XG4gICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgIDxQaWN0dXJlSW5QaWN0dXJlRHJhZ2dlclxuICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9DYWxsUHJldmlld1wiXG4gICAgICAgICAgICAgICAgICAgIGRyYWdnYWJsZT17cGlwTW9kZX1cbiAgICAgICAgICAgICAgICAgICAgb25Eb3VibGVDbGljaz17dGhpcy5vbkRvdWJsZUNsaWNrfVxuICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICAgICAgeyAoeyBvblN0YXJ0TW92aW5nLCBvblJlc2l6ZSB9KSA9PiA8Q2FsbFZpZXdcbiAgICAgICAgICAgICAgICAgICAgICAgIG9uTW91c2VEb3duT25IZWFkZXI9e29uU3RhcnRNb3Zpbmd9XG4gICAgICAgICAgICAgICAgICAgICAgICBjYWxsPXt0aGlzLnN0YXRlLnByaW1hcnlDYWxsfVxuICAgICAgICAgICAgICAgICAgICAgICAgc2Vjb25kYXJ5Q2FsbD17dGhpcy5zdGF0ZS5zZWNvbmRhcnlDYWxsfVxuICAgICAgICAgICAgICAgICAgICAgICAgcGlwTW9kZT17cGlwTW9kZX1cbiAgICAgICAgICAgICAgICAgICAgICAgIG9uUmVzaXplPXtvblJlc2l6ZX1cbiAgICAgICAgICAgICAgICAgICAgLz4gfVxuICAgICAgICAgICAgICAgIDwvUGljdHVyZUluUGljdHVyZURyYWdnZXI+XG5cbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gPFBlcnNpc3RlbnRBcHAgLz47XG4gICAgfVxufVxuIl19