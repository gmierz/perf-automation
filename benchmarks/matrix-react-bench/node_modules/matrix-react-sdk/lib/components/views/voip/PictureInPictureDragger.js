"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var _UIStore = _interopRequireDefault(require("../../../stores/UIStore"));

var _AnimationUtils = require("../../../utils/AnimationUtils");

var _MarkedExecution = require("../../../utils/MarkedExecution");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _dec, _class;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

const PIP_VIEW_WIDTH = 336;
const PIP_VIEW_HEIGHT = 232;
const MOVING_AMT = 0.2;
const SNAPPING_AMT = 0.1;
const PADDING = {
  top: 58,
  bottom: 58,
  left: 76,
  right: 8
};
let PictureInPictureDragger = (
/**
 * PictureInPictureDragger shows a small version of CallView hovering over the UI in 'picture-in-picture'
 * (PiP mode). It displays the call(s) which is *not* in the room the user is currently viewing.
 */
_dec = (0, _replaceableComponent.replaceableComponent)("views.voip.PictureInPictureDragger"), _dec(_class = class PictureInPictureDragger extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "callViewWrapper", /*#__PURE__*/(0, _react.createRef)());
    (0, _defineProperty2.default)(this, "initX", 0);
    (0, _defineProperty2.default)(this, "initY", 0);
    (0, _defineProperty2.default)(this, "desiredTranslationX", _UIStore.default.instance.windowWidth - PADDING.right - PIP_VIEW_WIDTH);
    (0, _defineProperty2.default)(this, "desiredTranslationY", _UIStore.default.instance.windowHeight - PADDING.bottom - PIP_VIEW_HEIGHT);
    (0, _defineProperty2.default)(this, "moving", false);
    (0, _defineProperty2.default)(this, "scheduledUpdate", new _MarkedExecution.MarkedExecution(() => this.animationCallback(), () => requestAnimationFrame(() => this.scheduledUpdate.trigger())));
    (0, _defineProperty2.default)(this, "animationCallback", () => {
      // If the PiP isn't being dragged and there is only a tiny difference in
      // the desiredTranslation and translation, quit the animationCallback
      // loop. If that is the case, it means the PiP has snapped into its
      // position and there is nothing to do. Not doing this would cause an
      // infinite loop
      if (!this.moving && Math.abs(this.state.translationX - this.desiredTranslationX) <= 1 && Math.abs(this.state.translationY - this.desiredTranslationY) <= 1) return;
      const amt = this.moving ? MOVING_AMT : SNAPPING_AMT;
      this.setState({
        translationX: (0, _AnimationUtils.lerp)(this.state.translationX, this.desiredTranslationX, amt),
        translationY: (0, _AnimationUtils.lerp)(this.state.translationY, this.desiredTranslationY, amt)
      });
      this.scheduledUpdate.mark();
    });
    (0, _defineProperty2.default)(this, "onResize", () => {
      this.snap(false);
    });
    (0, _defineProperty2.default)(this, "snap", (animate = false) => {
      var _this$callViewWrapper, _this$callViewWrapper2;

      const translationX = this.desiredTranslationX;
      const translationY = this.desiredTranslationY; // We subtract the PiP size from the window size in order to calculate
      // the position to snap to from the PiP center and not its top-left
      // corner

      const windowWidth = _UIStore.default.instance.windowWidth - (((_this$callViewWrapper = this.callViewWrapper.current) === null || _this$callViewWrapper === void 0 ? void 0 : _this$callViewWrapper.clientWidth) || PIP_VIEW_WIDTH);
      const windowHeight = _UIStore.default.instance.windowHeight - (((_this$callViewWrapper2 = this.callViewWrapper.current) === null || _this$callViewWrapper2 === void 0 ? void 0 : _this$callViewWrapper2.clientHeight) || PIP_VIEW_HEIGHT);

      if (translationX >= windowWidth / 2 && translationY >= windowHeight / 2) {
        this.desiredTranslationX = windowWidth - PADDING.right;
        this.desiredTranslationY = windowHeight - PADDING.bottom;
      } else if (translationX >= windowWidth / 2 && translationY <= windowHeight / 2) {
        this.desiredTranslationX = windowWidth - PADDING.right;
        this.desiredTranslationY = PADDING.top;
      } else if (translationX <= windowWidth / 2 && translationY >= windowHeight / 2) {
        this.desiredTranslationX = PADDING.left;
        this.desiredTranslationY = windowHeight - PADDING.bottom;
      } else {
        this.desiredTranslationX = PADDING.left;
        this.desiredTranslationY = PADDING.top;
      } // We start animating here because we want the PiP to move when we're
      // resizing the window


      this.scheduledUpdate.mark();

      if (animate) {
        // We start animating here because we want the PiP to move when we're
        // resizing the window
        this.scheduledUpdate.mark();
      } else {
        this.setState({
          translationX: this.desiredTranslationX,
          translationY: this.desiredTranslationY
        });
      }
    });
    (0, _defineProperty2.default)(this, "onStartMoving", event => {
      event.preventDefault();
      event.stopPropagation();
      this.moving = true;
      this.initX = event.pageX - this.desiredTranslationX;
      this.initY = event.pageY - this.desiredTranslationY;
      this.scheduledUpdate.mark();
    });
    (0, _defineProperty2.default)(this, "onMoving", event => {
      if (!this.moving) return;
      event.preventDefault();
      event.stopPropagation();
      this.setTranslation(event.pageX - this.initX, event.pageY - this.initY);
    });
    (0, _defineProperty2.default)(this, "onEndMoving", () => {
      this.moving = false;
      this.snap(true);
    });
    this.state = {
      translationX: _UIStore.default.instance.windowWidth - PADDING.right - PIP_VIEW_WIDTH,
      translationY: _UIStore.default.instance.windowHeight - PADDING.bottom - PIP_VIEW_HEIGHT
    };
  }

  componentDidMount() {
    document.addEventListener("mousemove", this.onMoving);
    document.addEventListener("mouseup", this.onEndMoving);
    window.addEventListener("resize", this.onResize);
  }

  componentWillUnmount() {
    document.removeEventListener("mousemove", this.onMoving);
    document.removeEventListener("mouseup", this.onEndMoving);
    window.removeEventListener("resize", this.onResize);
  }

  setTranslation(inTranslationX, inTranslationY) {
    var _this$callViewWrapper3, _this$callViewWrapper4;

    const width = ((_this$callViewWrapper3 = this.callViewWrapper.current) === null || _this$callViewWrapper3 === void 0 ? void 0 : _this$callViewWrapper3.clientWidth) || PIP_VIEW_WIDTH;
    const height = ((_this$callViewWrapper4 = this.callViewWrapper.current) === null || _this$callViewWrapper4 === void 0 ? void 0 : _this$callViewWrapper4.clientHeight) || PIP_VIEW_HEIGHT; // Avoid overflow on the x axis

    if (inTranslationX + width >= _UIStore.default.instance.windowWidth) {
      this.desiredTranslationX = _UIStore.default.instance.windowWidth - width;
    } else if (inTranslationX <= 0) {
      this.desiredTranslationX = 0;
    } else {
      this.desiredTranslationX = inTranslationX;
    } // Avoid overflow on the y axis


    if (inTranslationY + height >= _UIStore.default.instance.windowHeight) {
      this.desiredTranslationY = _UIStore.default.instance.windowHeight - height;
    } else if (inTranslationY <= 0) {
      this.desiredTranslationY = 0;
    } else {
      this.desiredTranslationY = inTranslationY;
    }
  }

  render() {
    const translatePixelsX = this.state.translationX + "px";
    const translatePixelsY = this.state.translationY + "px";
    const style = {
      transform: `translateX(${translatePixelsX})
                        translateY(${translatePixelsY})`
    };
    return /*#__PURE__*/_react.default.createElement("div", {
      className: this.props.className,
      style: this.props.draggable ? style : undefined,
      ref: this.callViewWrapper,
      onDoubleClick: this.props.onDoubleClick
    }, /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, this.props.children({
      onStartMoving: this.onStartMoving,
      onResize: this.onResize
    })));
  }

}) || _class);
exports.default = PictureInPictureDragger;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3ZvaXAvUGljdHVyZUluUGljdHVyZURyYWdnZXIudHN4Il0sIm5hbWVzIjpbIlBJUF9WSUVXX1dJRFRIIiwiUElQX1ZJRVdfSEVJR0hUIiwiTU9WSU5HX0FNVCIsIlNOQVBQSU5HX0FNVCIsIlBBRERJTkciLCJ0b3AiLCJib3R0b20iLCJsZWZ0IiwicmlnaHQiLCJQaWN0dXJlSW5QaWN0dXJlRHJhZ2dlciIsIlJlYWN0IiwiQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsIlVJU3RvcmUiLCJpbnN0YW5jZSIsIndpbmRvd1dpZHRoIiwid2luZG93SGVpZ2h0IiwiTWFya2VkRXhlY3V0aW9uIiwiYW5pbWF0aW9uQ2FsbGJhY2siLCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJzY2hlZHVsZWRVcGRhdGUiLCJ0cmlnZ2VyIiwibW92aW5nIiwiTWF0aCIsImFicyIsInN0YXRlIiwidHJhbnNsYXRpb25YIiwiZGVzaXJlZFRyYW5zbGF0aW9uWCIsInRyYW5zbGF0aW9uWSIsImRlc2lyZWRUcmFuc2xhdGlvblkiLCJhbXQiLCJzZXRTdGF0ZSIsIm1hcmsiLCJzbmFwIiwiYW5pbWF0ZSIsImNhbGxWaWV3V3JhcHBlciIsImN1cnJlbnQiLCJjbGllbnRXaWR0aCIsImNsaWVudEhlaWdodCIsImV2ZW50IiwicHJldmVudERlZmF1bHQiLCJzdG9wUHJvcGFnYXRpb24iLCJpbml0WCIsInBhZ2VYIiwiaW5pdFkiLCJwYWdlWSIsInNldFRyYW5zbGF0aW9uIiwiY29tcG9uZW50RGlkTW91bnQiLCJkb2N1bWVudCIsImFkZEV2ZW50TGlzdGVuZXIiLCJvbk1vdmluZyIsIm9uRW5kTW92aW5nIiwid2luZG93Iiwib25SZXNpemUiLCJjb21wb25lbnRXaWxsVW5tb3VudCIsInJlbW92ZUV2ZW50TGlzdGVuZXIiLCJpblRyYW5zbGF0aW9uWCIsImluVHJhbnNsYXRpb25ZIiwid2lkdGgiLCJoZWlnaHQiLCJyZW5kZXIiLCJ0cmFuc2xhdGVQaXhlbHNYIiwidHJhbnNsYXRlUGl4ZWxzWSIsInN0eWxlIiwidHJhbnNmb3JtIiwiY2xhc3NOYW1lIiwiZHJhZ2dhYmxlIiwidW5kZWZpbmVkIiwib25Eb3VibGVDbGljayIsImNoaWxkcmVuIiwib25TdGFydE1vdmluZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFnQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7O0FBRUEsTUFBTUEsY0FBYyxHQUFHLEdBQXZCO0FBQ0EsTUFBTUMsZUFBZSxHQUFHLEdBQXhCO0FBRUEsTUFBTUMsVUFBVSxHQUFHLEdBQW5CO0FBQ0EsTUFBTUMsWUFBWSxHQUFHLEdBQXJCO0FBRUEsTUFBTUMsT0FBTyxHQUFHO0FBQ1pDLEVBQUFBLEdBQUcsRUFBRSxFQURPO0FBRVpDLEVBQUFBLE1BQU0sRUFBRSxFQUZJO0FBR1pDLEVBQUFBLElBQUksRUFBRSxFQUhNO0FBSVpDLEVBQUFBLEtBQUssRUFBRTtBQUpLLENBQWhCO0lBOEJxQkMsdUI7QUFMckI7QUFDQTtBQUNBO0FBQ0E7T0FDQyxnREFBcUIsb0NBQXJCLEMsZ0JBQUQsTUFDcUJBLHVCQURyQixTQUNxREMsZUFBTUMsU0FEM0QsQ0FDcUY7QUFZakZDLEVBQUFBLFdBQVcsQ0FBQ0MsS0FBRCxFQUFnQjtBQUN2QixVQUFNQSxLQUFOO0FBRHVCLHdFQVhELHVCQVdDO0FBQUEsaURBVlgsQ0FVVztBQUFBLGlEQVRYLENBU1c7QUFBQSwrREFSR0MsaUJBQVFDLFFBQVIsQ0FBaUJDLFdBQWpCLEdBQStCWixPQUFPLENBQUNJLEtBQXZDLEdBQStDUixjQVFsRDtBQUFBLCtEQVBHYyxpQkFBUUMsUUFBUixDQUFpQkUsWUFBakIsR0FBZ0NiLE9BQU8sQ0FBQ0UsTUFBeEMsR0FBaURMLGVBT3BEO0FBQUEsa0RBTlYsS0FNVTtBQUFBLDJEQUxELElBQUlpQixnQ0FBSixDQUN0QixNQUFNLEtBQUtDLGlCQUFMLEVBRGdCLEVBRXRCLE1BQU1DLHFCQUFxQixDQUFDLE1BQU0sS0FBS0Ms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QyxpQkFBUUMsUUFBUixDQUFpQkUsWUFBaEQsRUFBOEQ7QUFDMUQsV0FBS2EsbUJBQUwsR0FBMkJoQixpQkFBUUMsUUFBUixDQUFpQkUsWUFBakIsR0FBZ0MyQyxNQUEzRDtBQUNILEtBRkQsTUFFTyxJQUFJRixjQUFjLElBQUksQ0FBdEIsRUFBeUI7QUFDNUIsV0FBSzVCLG1CQUFMLEdBQTJCLENBQTNCO0FBQ0gsS0FGTSxNQUVBO0FBQ0gsV0FBS0EsbUJBQUwsR0FBMkI0QixjQUEzQjtBQUNIO0FBQ0o7O0FBMkVNRyxFQUFBQSxNQUFNLEdBQUc7QUFDWixVQUFNQyxnQkFBZ0IsR0FBRyxLQUFLcEMsS0FBTCxDQUFXQyxZQUFYLEdBQTBCLElBQW5EO0FBQ0EsVUFBTW9DLGdCQUFnQixHQUFHLEtBQUtyQyxLQUFMLENBQVdHLFlBQVgsR0FBMEIsSUFBbkQ7QUFDQSxVQUFNbUMsS0FBSyxHQUFHO0FBQ1ZDLE1BQUFBLFNBQVMsRUFBRyxjQUFhSCxnQkFBaUI7QUFDdEQscUNBQXFDQyxnQkFBaUI7QUFGaEMsS0FBZDtBQUlBLHdCQUNJO0FBQ0ksTUFBQSxTQUFTLEVBQUUsS0FBS2xELEtBQUwsQ0FBV3FELFNBRDFCO0FBRUksTUFBQSxLQUFLLEVBQUUsS0FBS3JELEtBQUwsQ0FBV3NELFNBQVgsR0FBdUJILEtBQXZCLEdBQStCSSxTQUYxQztBQUdJLE1BQUEsR0FBRyxFQUFFLEtBQUtoQyxlQUhkO0FBSUksTUFBQSxhQUFhLEVBQUUsS0FBS3ZCLEtBQUwsQ0FBV3dEO0FBSjlCLG9CQU1JLDREQUNNLEtBQUt4RCxLQUFMLENBQVd5RCxRQUFYLENBQW9CO0FBQ2xCQyxNQUFBQSxhQUFhLEVBQUUsS0FBS0EsYUFERjtBQUVsQmpCLE1BQUFBLFFBQVEsRUFBRSxLQUFLQTtBQUZHLEtBQXBCLENBRE4sQ0FOSixDQURKO0FBZUg7O0FBM0tnRixDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDIxIE5ldyBWZWN0b3IgTHRkXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0LCB7IGNyZWF0ZVJlZiB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCBVSVN0b3JlIGZyb20gJy4uLy4uLy4uL3N0b3Jlcy9VSVN0b3JlJztcbmltcG9ydCB7IGxlcnAgfSBmcm9tICcuLi8uLi8uLi91dGlscy9BbmltYXRpb25VdGlscyc7XG5pbXBvcnQgeyBNYXJrZWRFeGVjdXRpb24gfSBmcm9tICcuLi8uLi8uLi91dGlscy9NYXJrZWRFeGVjdXRpb24nO1xuaW1wb3J0IHsgcmVwbGFjZWFibGVDb21wb25lbnQgfSBmcm9tICcuLi8uLi8uLi91dGlscy9yZXBsYWNlYWJsZUNvbXBvbmVudCc7XG5cbmNvbnN0IFBJUF9WSUVXX1dJRFRIID0gMzM2O1xuY29uc3QgUElQX1ZJRVdfSEVJR0hUID0gMjMyO1xuXG5jb25zdCBNT1ZJTkdfQU1UID0gMC4yO1xuY29uc3QgU05BUFBJTkdfQU1UID0gMC4xO1xuXG5jb25zdCBQQURESU5HID0ge1xuICAgIHRvcDogNTgsXG4gICAgYm90dG9tOiA1OCxcbiAgICBsZWZ0OiA3NixcbiAgICByaWdodDogOCxcbn07XG5cbmludGVyZmFjZSBJQ2hpbGRyZW5PcHRpb25zIHtcbiAgICBvblN0YXJ0TW92aW5nOiAoZXZlbnQ6IFJlYWN0Lk1vdXNlRXZlbnQ8RWxlbWVudCwgTW91c2VFdmVudD4pID0+IHZvaWQ7XG4gICAgb25SZXNpemU6IChldmVudDogRXZlbnQpID0+IHZvaWQ7XG59XG5cbmludGVyZmFjZSBJUHJvcHMge1xuICAgIGNsYXNzTmFtZT86IHN0cmluZztcbiAgICBjaGlsZHJlbjogKHsgb25TdGFydE1vdmluZywgb25SZXNpemUgfTogSUNoaWxkcmVuT3B0aW9ucykgPT4gUmVhY3QuUmVhY3ROb2RlO1xuICAgIGRyYWdnYWJsZTogYm9vbGVhbjtcbiAgICBvbkRvdWJsZUNsaWNrPzogKCkgPT4gdm9pZDtcbn1cblxuaW50ZXJmYWNlIElTdGF0ZSB7XG4gICAgLy8gUG9zaXRpb24gb2YgdGhlIFBpY3R1cmVJblBpY3R1cmVEcmFnZ2VyXG4gICAgdHJhbnNsYXRpb25YOiBudW1iZXI7XG4gICAgdHJhbnNsYXRpb25ZOiBudW1iZXI7XG59XG5cbi8qKlxuICogUGljdHVyZUluUGljdHVyZURyYWdnZXIgc2hvd3MgYSBzbWFsbCB2ZXJzaW9uIG9mIENhbGxWaWV3IGhvdmVyaW5nIG92ZXIgdGhlIFVJIGluICdwaWN0dXJlLWluLXBpY3R1cmUnXG4gKiAoUGlQIG1vZGUpLiBJdCBkaXNwbGF5cyB0aGUgY2FsbChzKSB3aGljaCBpcyAqbm90KiBpbiB0aGUgcm9vbSB0aGUgdXNlciBpcyBjdXJyZW50bHkgdmlld2luZy5cbiAqL1xuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3Mudm9pcC5QaWN0dXJlSW5QaWN0dXJlRHJhZ2dlclwiKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUGljdHVyZUluUGljdHVyZURyYWdnZXIgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8SVByb3BzLCBJU3RhdGU+IHtcbiAgICBwcml2YXRlIGNhbGxWaWV3V3JhcHBlciA9IGNyZWF0ZVJlZjxIVE1MRGl2RWxlbWVudD4oKTtcbiAgICBwcml2YXRlIGluaXRYID0gMDtcbiAgICBwcml2YXRlIGluaXRZID0gMDtcbiAgICBwcml2YXRlIGRlc2lyZWRUcmFuc2xhdGlvblggPSBVSVN0b3JlLmluc3RhbmNlLndpbmRvd1dpZHRoIC0gUEFERElORy5yaWdodCAtIFBJUF9WSUVXX1dJRFRIO1xuICAgIHByaXZhdGUgZGVzaXJlZFRyYW5zbGF0aW9uWSA9IFVJU3RvcmUuaW5zdGFuY2Uud2luZG93SGVpZ2h0IC0gUEFERElORy5ib3R0b20gLSBQSVBfVklFV19IRUlHSFQ7XG4gICAgcHJpdmF0ZSBtb3ZpbmcgPSBmYWxzZTtcbiAgICBwcml2YXRlIHNjaGVkdWxlZFVwZGF0ZSA9IG5ldyBNYXJrZWRFeGVjdXRpb24oXG4gICAgICAgICgpID0+IHRoaXMuYW5pbWF0aW9uQ2FsbGJhY2soKSxcbiAgICAgICAgKCkgPT4gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHRoaXMuc2NoZWR1bGVkVXBkYXRlLnRyaWdnZXIoKSksXG4gICAgKTtcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBJUHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuXG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICB0cmFuc2xhdGlvblg6IFVJU3RvcmUuaW5zdGFuY2Uud2luZG93V2lkdGggLSBQQURESU5HLnJpZ2h0IC0gUElQX1ZJRVdfV0lEVEgsXG4gICAgICAgICAgICB0cmFuc2xhdGlvblk6IFVJU3RvcmUuaW5zdGFuY2Uud2luZG93SGVpZ2h0IC0gUEFERElORy5ib3R0b20gLSBQSVBfVklFV19IRUlHSFQsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHVibGljIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKFwibW91c2Vtb3ZlXCIsIHRoaXMub25Nb3ZpbmcpO1xuICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKFwibW91c2V1cFwiLCB0aGlzLm9uRW5kTW92aW5nKTtcbiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoXCJyZXNpemVcIiwgdGhpcy5vblJlc2l6ZSk7XG4gICAgfVxuXG4gICAgcHVibGljIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKFwibW91c2Vtb3ZlXCIsIHRoaXMub25Nb3ZpbmcpO1xuICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKFwibW91c2V1cFwiLCB0aGlzLm9uRW5kTW92aW5nKTtcbiAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJyZXNpemVcIiwgdGhpcy5vblJlc2l6ZSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhbmltYXRpb25DYWxsYmFjayA9ICgpID0+IHtcbiAgICAgICAgLy8gSWYgdGhlIFBpUCBpc24ndCBiZWluZyBkcmFnZ2VkIGFuZCB0aGVyZSBpcyBvbmx5IGEgdGlueSBkaWZmZXJlbmNlIGluXG4gICAgICAgIC8vIHRoZSBkZXNpcmVkVHJhbnNsYXRpb24gYW5kIHRyYW5zbGF0aW9uLCBxdWl0IHRoZSBhbmltYXRpb25DYWxsYmFja1xuICAgICAgICAvLyBsb29wLiBJZiB0aGF0IGlzIHRoZSBjYXNlLCBpdCBtZWFucyB0aGUgUGlQIGhhcyBzbmFwcGVkIGludG8gaXRzXG4gICAgICAgIC8vIHBvc2l0aW9uIGFuZCB0aGVyZSBpcyBub3RoaW5nIHRvIGRvLiBOb3QgZG9pbmcgdGhpcyB3b3VsZCBjYXVzZSBhblxuICAgICAgICAvLyBpbmZpbml0ZSBsb29wXG4gICAgICAgIGlmIChcbiAgICAgICAgICAgICF0aGlzLm1vdmluZyAmJlxuICAgICAgICAgICAgTWF0aC5hYnModGhpcy5zdGF0ZS50cmFuc2xhdGlvblggLSB0aGlzLmRlc2lyZWRUcmFuc2xhdGlvblgpIDw9IDEgJiZcbiAgICAgICAgICAgIE1hdGguYWJzKHRoaXMuc3RhdGUudHJhbnNsYXRpb25ZIC0gdGhpcy5kZXNpcmVkVHJhbnNsYXRpb25ZKSA8PSAxXG4gICAgICAgICkgcmV0dXJuO1xuXG4gICAgICAgIGNvbnN0IGFtdCA9IHRoaXMubW92aW5nID8gTU9WSU5HX0FNVCA6IFNOQVBQSU5HX0FNVDtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICB0cmFuc2xhdGlvblg6IGxlcnAodGhpcy5zdGF0ZS50cmFuc2xhdGlvblgsIHRoaXMuZGVzaXJlZFRyYW5zbGF0aW9uWCwgYW10KSxcbiAgICAgICAgICAgIHRyYW5zbGF0aW9uWTogbGVycCh0aGlzLnN0YXRlLnRyYW5zbGF0aW9uWSwgdGhpcy5kZXNpcmVkVHJhbnNsYXRpb25ZLCBhbXQpLFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5zY2hlZHVsZWRVcGRhdGUubWFyaygpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIHNldFRyYW5zbGF0aW9uKGluVHJhbnNsYXRpb25YOiBudW1iZXIsIGluVHJhbnNsYXRpb25ZOiBudW1iZXIpIHtcbiAgICAgICAgY29uc3Qgd2lkdGggPSB0aGlzLmNhbGxWaWV3V3JhcHBlci5jdXJyZW50Py5jbGllbnRXaWR0aCB8fCBQSVBfVklFV19XSURUSDtcbiAgICAgICAgY29uc3QgaGVpZ2h0ID0gdGhpcy5jYWxsVmlld1dyYXBwZXIuY3VycmVudD8uY2xpZW50SGVpZ2h0IHx8IFBJUF9WSUVXX0hFSUdIVDtcblxuICAgICAgICAvLyBBdm9pZCBvdmVyZmxvdyBvbiB0aGUgeCBheGlzXG4gICAgICAgIGlmIChpblRyYW5zbGF0aW9uWCArIHdpZHRoID49IFVJU3RvcmUuaW5zdGFuY2Uud2luZG93V2lkdGgpIHtcbiAgICAgICAgICAgIHRoaXMuZGVzaXJlZFRyYW5zbGF0aW9uWCA9IFVJU3RvcmUuaW5zdGFuY2Uud2luZG93V2lkdGggLSB3aWR0aDtcbiAgICAgICAgfSBlbHNlIGlmIChpblRyYW5zbGF0aW9uWCA8PSAwKSB7XG4gICAgICAgICAgICB0aGlzLmRlc2lyZWRUcmFuc2xhdGlvblggPSAwO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5kZXNpcmVkVHJhbnNsYXRpb25YID0gaW5UcmFuc2xhdGlvblg7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBBdm9pZCBvdmVyZmxvdyBvbiB0aGUgeSBheGlzXG4gICAgICAgIGlmIChpblRyYW5zbGF0aW9uWSArIGhlaWdodCA+PSBVSVN0b3JlLmluc3RhbmNlLndpbmRvd0hlaWdodCkge1xuICAgICAgICAgICAgdGhpcy5kZXNpcmVkVHJhbnNsYXRpb25ZID0gVUlTdG9yZS5pbnN0YW5jZS53aW5kb3dIZWlnaHQgLSBoZWlnaHQ7XG4gICAgICAgIH0gZWxzZSBpZiAoaW5UcmFuc2xhdGlvblkgPD0gMCkge1xuICAgICAgICAgICAgdGhpcy5kZXNpcmVkVHJhbnNsYXRpb25ZID0gMDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuZGVzaXJlZFRyYW5zbGF0aW9uWSA9IGluVHJhbnNsYXRpb25ZO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvblJlc2l6ZSA9ICgpOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5zbmFwKGZhbHNlKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBzbmFwID0gKGFuaW1hdGUgPSBmYWxzZSkgPT4ge1xuICAgICAgICBjb25zdCB0cmFuc2xhdGlvblggPSB0aGlzLmRlc2lyZWRUcmFuc2xhdGlvblg7XG4gICAgICAgIGNvbnN0IHRyYW5zbGF0aW9uWSA9IHRoaXMuZGVzaXJlZFRyYW5zbGF0aW9uWTtcbiAgICAgICAgLy8gV2Ugc3VidHJhY3QgdGhlIFBpUCBzaXplIGZyb20gdGhlIHdpbmRvdyBzaXplIGluIG9yZGVyIHRvIGNhbGN1bGF0ZVxuICAgICAgICAvLyB0aGUgcG9zaXRpb24gdG8gc25hcCB0byBmcm9tIHRoZSBQaVAgY2VudGVyIGFuZCBub3QgaXRzIHRvcC1sZWZ0XG4gICAgICAgIC8vIGNvcm5lclxuICAgICAgICBjb25zdCB3aW5kb3dXaWR0aCA9IChcbiAgICAgICAgICAgIFVJU3RvcmUuaW5zdGFuY2Uud2luZG93V2lkdGggLVxuICAgICAgICAgICAgKHRoaXMuY2FsbFZpZXdXcmFwcGVyLmN1cnJlbnQ/LmNsaWVudFdpZHRoIHx8IFBJUF9WSUVXX1dJRFRIKVxuICAgICAgICApO1xuICAgICAgICBjb25zdCB3aW5kb3dIZWlnaHQgPSAoXG4gICAgICAgICAgICBVSVN0b3JlLmluc3RhbmNlLndpbmRvd0hlaWdodCAtXG4gICAgICAgICAgICAodGhpcy5jYWxsVmlld1dyYXBwZXIuY3VycmVudD8uY2xpZW50SGVpZ2h0IHx8IFBJUF9WSUVXX0hFSUdIVClcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAodHJhbnNsYXRpb25YID49IHdpbmRvd1dpZHRoIC8gMiAmJiB0cmFuc2xhdGlvblkgPj0gd2luZG93SGVpZ2h0IC8gMikge1xuICAgICAgICAgICAgdGhpcy5kZXNpcmVkVHJhbnNsYXRpb25YID0gd2luZG93V2lkdGggLSBQQURESU5HLnJpZ2h0O1xuICAgICAgICAgICAgdGhpcy5kZXNpcmVkVHJhbnNsYXRpb25ZID0gd2luZG93SGVpZ2h0IC0gUEFERElORy5ib3R0b207XG4gICAgICAgIH0gZWxzZSBpZiAodHJhbnNsYXRpb25YID49IHdpbmRvd1dpZHRoIC8gMiAmJiB0cmFuc2xhdGlvblkgPD0gd2luZG93SGVpZ2h0IC8gMikge1xuICAgICAgICAgICAgdGhpcy5kZXNpcmVkVHJhbnNsYXRpb25YID0gd2luZG93V2lkdGggLSBQQURESU5HLnJpZ2h0O1xuICAgICAgICAgICAgdGhpcy5kZXNpcmVkVHJhbnNsYXRpb25ZID0gUEFERElORy50b3A7XG4gICAgICAgIH0gZWxzZSBpZiAodHJhbnNsYXRpb25YIDw9IHdpbmRvd1dpZHRoIC8gMiAmJiB0cmFuc2xhdGlvblkgPj0gd2luZG93SGVpZ2h0IC8gMikge1xuICAgICAgICAgICAgdGhpcy5kZXNpcmVkVHJhbnNsYXRpb25YID0gUEFERElORy5sZWZ0O1xuICAgICAgICAgICAgdGhpcy5kZXNpcmVkVHJhbnNsYXRpb25ZID0gd2luZG93SGVpZ2h0IC0gUEFERElORy5ib3R0b207XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmRlc2lyZWRUcmFuc2xhdGlvblggPSBQQURESU5HLmxlZnQ7XG4gICAgICAgICAgICB0aGlzLmRlc2lyZWRUcmFuc2xhdGlvblkgPSBQQURESU5HLnRvcDtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFdlIHN0YXJ0IGFuaW1hdGluZyBoZXJlIGJlY2F1c2Ugd2Ugd2FudCB0aGUgUGlQIHRvIG1vdmUgd2hlbiB3ZSdyZVxuICAgICAgICAvLyByZXNpemluZyB0aGUgd2luZG93XG4gICAgICAgIHRoaXMuc2NoZWR1bGVkVXBkYXRlLm1hcmsoKTtcblxuICAgICAgICBpZiAoYW5pbWF0ZSkge1xuICAgICAgICAgICAgLy8gV2Ugc3RhcnQgYW5pbWF0aW5nIGhlcmUgYmVjYXVzZSB3ZSB3YW50IHRoZSBQaVAgdG8gbW92ZSB3aGVuIHdlJ3JlXG4gICAgICAgICAgICAvLyByZXNpemluZyB0aGUgd2luZG93XG4gICAgICAgICAgICB0aGlzLnNjaGVkdWxlZFVwZGF0ZS5tYXJrKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICB0cmFuc2xhdGlvblg6IHRoaXMuZGVzaXJlZFRyYW5zbGF0aW9uWCxcbiAgICAgICAgICAgICAgICB0cmFuc2xhdGlvblk6IHRoaXMuZGVzaXJlZFRyYW5zbGF0aW9uWSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25TdGFydE1vdmluZyA9IChldmVudDogUmVhY3QuTW91c2VFdmVudCB8IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG5cbiAgICAgICAgdGhpcy5tb3ZpbmcgPSB0cnVlO1xuICAgICAgICB0aGlzLmluaXRYID0gZXZlbnQucGFnZVggLSB0aGlzLmRlc2lyZWRUcmFuc2xhdGlvblg7XG4gICAgICAgIHRoaXMuaW5pdFkgPSBldmVudC5wYWdlWSAtIHRoaXMuZGVzaXJlZFRyYW5zbGF0aW9uWTtcbiAgICAgICAgdGhpcy5zY2hlZHVsZWRVcGRhdGUubWFyaygpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uTW92aW5nID0gKGV2ZW50OiBSZWFjdC5Nb3VzZUV2ZW50IHwgTW91c2VFdmVudCkgPT4ge1xuICAgICAgICBpZiAoIXRoaXMubW92aW5nKSByZXR1cm47XG5cbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG5cbiAgICAgICAgdGhpcy5zZXRUcmFuc2xhdGlvbihldmVudC5wYWdlWCAtIHRoaXMuaW5pdFgsIGV2ZW50LnBhZ2VZIC0gdGhpcy5pbml0WSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25FbmRNb3ZpbmcgPSAoKSA9PiB7XG4gICAgICAgIHRoaXMubW92aW5nID0gZmFsc2U7XG4gICAgICAgIHRoaXMuc25hcCh0cnVlKTtcbiAgICB9O1xuXG4gICAgcHVibGljIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3QgdHJhbnNsYXRlUGl4ZWxzWCA9IHRoaXMuc3RhdGUudHJhbnNsYXRpb25YICsgXCJweFwiO1xuICAgICAgICBjb25zdCB0cmFuc2xhdGVQaXhlbHNZID0gdGhpcy5zdGF0ZS50cmFuc2xhdGlvblkgKyBcInB4XCI7XG4gICAgICAgIGNvbnN0IHN0eWxlID0ge1xuICAgICAgICAgICAgdHJhbnNmb3JtOiBgdHJhbnNsYXRlWCgke3RyYW5zbGF0ZVBpeGVsc1h9KVxuICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlWSgke3RyYW5zbGF0ZVBpeGVsc1l9KWAsXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8ZGl2XG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lPXt0aGlzLnByb3BzLmNsYXNzTmFtZX1cbiAgICAgICAgICAgICAgICBzdHlsZT17dGhpcy5wcm9wcy5kcmFnZ2FibGUgPyBzdHlsZSA6IHVuZGVmaW5lZH1cbiAgICAgICAgICAgICAgICByZWY9e3RoaXMuY2FsbFZpZXdXcmFwcGVyfVxuICAgICAgICAgICAgICAgIG9uRG91YmxlQ2xpY2s9e3RoaXMucHJvcHMub25Eb3VibGVDbGlja31cbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICA8PlxuICAgICAgICAgICAgICAgICAgICB7IHRoaXMucHJvcHMuY2hpbGRyZW4oe1xuICAgICAgICAgICAgICAgICAgICAgICAgb25TdGFydE1vdmluZzogdGhpcy5vblN0YXJ0TW92aW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgb25SZXNpemU6IHRoaXMub25SZXNpemUsXG4gICAgICAgICAgICAgICAgICAgIH0pIH1cbiAgICAgICAgICAgICAgICA8Lz5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICApO1xuICAgIH1cbn1cbiJdfQ==