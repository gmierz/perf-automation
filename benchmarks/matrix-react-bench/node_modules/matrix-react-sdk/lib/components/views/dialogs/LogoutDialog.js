"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var _languageHandler = require("../../../languageHandler");

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _RestoreKeyBackupDialog = _interopRequireDefault(require("./security/RestoreKeyBackupDialog"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _logger = require("matrix-js-sdk/src/logger");

var _QuestionDialog = _interopRequireDefault(require("./QuestionDialog"));

var _BaseDialog = _interopRequireDefault(require("./BaseDialog"));

var _Spinner = _interopRequireDefault(require("../elements/Spinner"));

var _DialogButtons = _interopRequireDefault(require("../elements/DialogButtons"));

var _dec, _class, _class2, _temp;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

let LogoutDialog = (_dec = (0, _replaceableComponent.replaceableComponent)("views.dialogs.LogoutDialog"), _dec(_class = (_temp = _class2 = class LogoutDialog extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onSettingsLinkClick", () => {
      // close dialog
      this.props.onFinished(true);
    });
    (0, _defineProperty2.default)(this, "onExportE2eKeysClicked", () => {
      _Modal.default.createTrackedDialogAsync('Export E2E Keys', '', Promise.resolve().then(() => _interopRequireWildcard(require('../../../async-components/views/dialogs/security/ExportE2eKeysDialog'))), {
        matrixClient: _MatrixClientPeg.MatrixClientPeg.get()
      });
    });
    (0, _defineProperty2.default)(this, "onFinished", confirmed => {
      if (confirmed) {
        _dispatcher.default.dispatch({
          action: 'logout'
        });
      } // close dialog


      this.props.onFinished(confirmed);
    });
    (0, _defineProperty2.default)(this, "onSetRecoveryMethodClick", () => {
      if (this.state.backupInfo) {
        // A key backup exists for this account, but the creating device is not
        // verified, so restore the backup which will give us the keys from it and
        // allow us to trust it (ie. upload keys to it)
        _Modal.default.createTrackedDialog('Restore Backup', '', _RestoreKeyBackupDialog.default, null, null,
        /* priority = */
        false,
        /* static = */
        true);
      } else {
        _Modal.default.createTrackedDialogAsync("Key Backup", "Key Backup", Promise.resolve().then(() => _interopRequireWildcard(require("../../../async-components/views/dialogs/security/CreateKeyBackupDialog"))), null, null,
        /* priority = */
        false,
        /* static = */
        true);
      } // close dialog


      this.props.onFinished(true);
    });
    (0, _defineProperty2.default)(this, "onLogoutConfirm", () => {
      _dispatcher.default.dispatch({
        action: 'logout'
      }); // close dialog


      this.props.onFinished(true);
    });

    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    const shouldLoadBackupStatus = cli.isCryptoEnabled() && !cli.getKeyBackupEnabled();
    this.state = {
      shouldLoadBackupStatus: shouldLoadBackupStatus,
      loading: shouldLoadBackupStatus,
      backupInfo: null,
      error: null
    };

    if (shouldLoadBackupStatus) {
      this.loadBackupStatus();
    }
  }

  async loadBackupStatus() {
    try {
      const backupInfo = await _MatrixClientPeg.MatrixClientPeg.get().getKeyBackupVersion();
      this.setState({
        loading: false,
        backupInfo
      });
    } catch (e) {
      _logger.logger.log("Unable to fetch key backup status", e);

      this.setState({
        loading: false,
        error: e
      });
    }
  }

  render() {
    if (this.state.shouldLoadBackupStatus) {
      const description = /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Encrypted messages are secured with end-to-end encryption. " + "Only you and the recipient(s) have the keys to read these messages.")), /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Back up your keys before signing out to avoid losing them.")));

      let dialogContent;

      if (this.state.loading) {
        dialogContent = /*#__PURE__*/_react.default.createElement(_Spinner.default, null);
      } else {
        let setupButtonCaption;

        if (this.state.backupInfo) {
          setupButtonCaption = (0, _languageHandler._t)("Connect this session to Key Backup");
        } else {
          // if there's an error fetching the backup info, we'll just assume there's
          // no backup for the purpose of the button caption
          setupButtonCaption = (0, _languageHandler._t)("Start using Key Backup");
        }

        dialogContent = /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("div", {
          className: "mx_Dialog_content",
          id: "mx_Dialog_content"
        }, description), /*#__PURE__*/_react.default.createElement(_DialogButtons.default, {
          primaryButton: setupButtonCaption,
          hasCancel: false,
          onPrimaryButtonClick: this.onSetRecoveryMethodClick,
          focus: true
        }, /*#__PURE__*/_react.default.createElement("button", {
          onClick: this.onLogoutConfirm
        }, (0, _languageHandler._t)("I don't want my encrypted messages"))), /*#__PURE__*/_react.default.createElement("details", null, /*#__PURE__*/_react.default.createElement("summary", null, (0, _languageHandler._t)("Advanced")), /*#__PURE__*/_react.default.createElement("p", null, /*#__PURE__*/_react.default.createElement("button", {
          onClick: this.onExportE2eKeysClicked
        }, (0, _languageHandler._t)("Manually export keys")))));
      } // Not quite a standard question dialog as the primary button cancels
      // the action and does something else instead, whilst non-default button
      // confirms the action.


      return /*#__PURE__*/_react.default.createElement(_BaseDialog.default, {
        title: (0, _languageHandler._t)("You'll lose access to your encrypted messages"),
        contentId: "mx_Dialog_content",
        hasCancel: true,
        onFinished: this.onFinished
      }, dialogContent);
    } else {
      return /*#__PURE__*/_react.default.createElement(_QuestionDialog.default, {
        hasCancelButton: true,
        title: (0, _languageHandler._t)("Sign out"),
        description: (0, _languageHandler._t)("Are you sure you want to sign out?"),
        button: (0, _languageHandler._t)("Sign out"),
        onFinished: this.onFinished
      });
    }
  }

}, (0, _defineProperty2.default)(_class2, "defaultProps", {
  onFinished: function () {}
}), _temp)) || _class);
exports.default = LogoutDialog;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvTG9nb3V0RGlhbG9nLnRzeCJdLCJuYW1lcyI6WyJMb2dvdXREaWFsb2ciLCJSZWFjdCIsIkNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJvbkZpbmlzaGVkIiwiTW9kYWwiLCJjcmVhdGVUcmFja2VkRGlhbG9nQXN5bmMiLCJtYXRyaXhDbGllbnQiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJjb25maXJtZWQiLCJkaXMiLCJkaXNwYXRjaCIsImFjdGlvbiIsInN0YXRlIiwiYmFja3VwSW5mbyIsImNyZWF0ZVRyYWNrZWREaWFsb2ciLCJSZXN0b3JlS2V5QmFja3VwRGlhbG9nIiwiY2xpIiwic2hvdWxkTG9hZEJhY2t1cFN0YXR1cyIsImlzQ3J5cHRvRW5hYmxlZCIsImdldEtleUJhY2t1cEVuYWJsZWQiLCJsb2FkaW5nIiwiZXJyb3IiLCJsb2FkQmFja3VwU3RhdHVzIiwiZ2V0S2V5QmFja3VwVmVyc2lvbiIsInNldFN0YXRlIiwiZSIsImxvZ2dlciIsImxvZyIsInJlbmRlciIsImRlc2NyaXB0aW9uIiwiZGlhbG9nQ29udGVudCIsInNldHVwQnV0dG9uQ2FwdGlvbiIsIm9uU2V0UmVjb3ZlcnlNZXRob2RDbGljayIsIm9uTG9nb3V0Q29uZmlybSIsIm9uRXhwb3J0RTJlS2V5c0NsaWNrZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBaUJBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7OztJQWNxQkEsWSxXQURwQixnREFBcUIsNEJBQXJCLEMsbUNBQUQsTUFDcUJBLFlBRHJCLFNBQzBDQyxlQUFNQyxTQURoRCxDQUMwRTtBQUt0RUMsRUFBQUEsV0FBVyxDQUFDQyxLQUFELEVBQVE7QUFDZixVQUFNQSxLQUFOO0FBRGUsK0RBa0NXLE1BQVk7QUFDdEM7QUFDQSxXQUFLQSxLQUFM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LEVBQUUseUJBQ1Qsb0NBRFMsQ0FIVDtBQU1KLFFBQUEsTUFBTSxFQUFFLHlCQUFHLFVBQUgsQ0FOSjtBQU9KLFFBQUEsVUFBVSxFQUFFLEtBQUs1QjtBQVBiLFFBQVI7QUFTSDtBQUNKOztBQTlKcUUsQyx5REFDaEQ7QUFDbEJBLEVBQUFBLFVBQVUsRUFBRSxZQUFXLENBQUU7QUFEUCxDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE4LCAyMDE5IE5ldyBWZWN0b3IgTHRkXG5Db3B5cmlnaHQgMjAyMCBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCwgeyBDb21wb25lbnRUeXBlIH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgSUtleUJhY2t1cEluZm8gfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvY3J5cHRvL2tleWJhY2t1cFwiO1xuaW1wb3J0IE1vZGFsIGZyb20gJy4uLy4uLy4uL01vZGFsJztcbmltcG9ydCBkaXMgZnJvbSAnLi4vLi4vLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyJztcbmltcG9ydCB7IF90IH0gZnJvbSAnLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyJztcbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gJy4uLy4uLy4uL01hdHJpeENsaWVudFBlZyc7XG5pbXBvcnQgUmVzdG9yZUtleUJhY2t1cERpYWxvZyBmcm9tICcuL3NlY3VyaXR5L1Jlc3RvcmVLZXlCYWNrdXBEaWFsb2cnO1xuaW1wb3J0IHsgcmVwbGFjZWFibGVDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvcmVwbGFjZWFibGVDb21wb25lbnRcIjtcblxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2xvZ2dlclwiO1xuaW1wb3J0IFF1ZXN0aW9uRGlhbG9nIGZyb20gXCIuL1F1ZXN0aW9uRGlhbG9nXCI7XG5pbXBvcnQgQmFzZURpYWxvZyBmcm9tIFwiLi9CYXNlRGlhbG9nXCI7XG5pbXBvcnQgU3Bpbm5lciBmcm9tIFwiLi4vZWxlbWVudHMvU3Bpbm5lclwiO1xuaW1wb3J0IERpYWxvZ0J1dHRvbnMgZnJvbSBcIi4uL2VsZW1lbnRzL0RpYWxvZ0J1dHRvbnNcIjtcblxuaW50ZXJmYWNlIElQcm9wcyB7XG4gICAgb25GaW5pc2hlZDogKHN1Y2Nlc3M6IGJvb2xlYW4pID0+IHZvaWQ7XG59XG5cbmludGVyZmFjZSBJU3RhdGUge1xuICAgIHNob3VsZExvYWRCYWNrdXBTdGF0dXM6IGJvb2xlYW47XG4gICAgbG9hZGluZzogYm9vbGVhbjtcbiAgICBiYWNrdXBJbmZvOiBJS2V5QmFja3VwSW5mbztcbiAgICBlcnJvcj86IHN0cmluZztcbn1cblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3MuZGlhbG9ncy5Mb2dvdXREaWFsb2dcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIExvZ291dERpYWxvZyBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxJUHJvcHMsIElTdGF0ZT4ge1xuICAgIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgICAgIG9uRmluaXNoZWQ6IGZ1bmN0aW9uKCkge30sXG4gICAgfTtcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcblxuICAgICAgICBjb25zdCBjbGkgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIGNvbnN0IHNob3VsZExvYWRCYWNrdXBTdGF0dXMgPSBjbGkuaXNDcnlwdG9FbmFibGVkKCkgJiYgIWNsaS5nZXRLZXlCYWNrdXBFbmFibGVkKCk7XG5cbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIHNob3VsZExvYWRCYWNrdXBTdGF0dXM6IHNob3VsZExvYWRCYWNrdXBTdGF0dXMsXG4gICAgICAgICAgICBsb2FkaW5nOiBzaG91bGRMb2FkQmFja3VwU3RhdHVzLFxuICAgICAgICAgICAgYmFja3VwSW5mbzogbnVsbCxcbiAgICAgICAgICAgIGVycm9yOiBudWxsLFxuICAgICAgICB9O1xuXG4gICAgICAgIGlmIChzaG91bGRMb2FkQmFja3VwU3RhdHVzKSB7XG4gICAgICAgICAgICB0aGlzLmxvYWRCYWNrdXBTdGF0dXMoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgbG9hZEJhY2t1cFN0YXR1cygpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGJhY2t1cEluZm8gPSBhd2FpdCBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZ2V0S2V5QmFja3VwVmVyc2lvbigpO1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgbG9hZGluZzogZmFsc2UsXG4gICAgICAgICAgICAgICAgYmFja3VwSW5mbyxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBsb2dnZXIubG9nKFwiVW5hYmxlIHRvIGZldGNoIGtleSBiYWNrdXAgc3RhdHVzXCIsIGUpO1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgbG9hZGluZzogZmFsc2UsXG4gICAgICAgICAgICAgICAgZXJyb3I6IGUsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgb25TZXR0aW5nc0xpbmtDbGljayA9ICgpOiB2b2lkID0+IHtcbiAgICAgICAgLy8gY2xvc2UgZGlhbG9nXG4gICAgICAgIHRoaXMucHJvcHMub25GaW5pc2hlZCh0cnVlKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkV4cG9ydEUyZUtleXNDbGlja2VkID0gKCk6IHZvaWQgPT4ge1xuICAgICAgICBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nQXN5bmMoJ0V4cG9ydCBFMkUgS2V5cycsICcnLFxuICAgICAgICAgICAgaW1wb3J0KFxuICAgICAgICAgICAgICAgICcuLi8uLi8uLi9hc3luYy1jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3Mvc2VjdXJpdHkvRXhwb3J0RTJlS2V5c0RpYWxvZydcbiAgICAgICAgICAgICkgYXMgdW5rbm93biBhcyBQcm9taXNlPENvbXBvbmVudFR5cGU8e30+PixcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBtYXRyaXhDbGllbnQ6IE1hdHJpeENsaWVudFBlZy5nZXQoKSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25GaW5pc2hlZCA9IChjb25maXJtZWQ6IGJvb2xlYW4pOiB2b2lkID0+IHtcbiAgICAgICAgaWYgKGNvbmZpcm1lZCkge1xuICAgICAgICAgICAgZGlzLmRpc3BhdGNoKHsgYWN0aW9uOiAnbG9nb3V0JyB9KTtcbiAgICAgICAgfVxuICAgICAgICAvLyBjbG9zZSBkaWFsb2dcbiAgICAgICAgdGhpcy5wcm9wcy5vbkZpbmlzaGVkKGNvbmZpcm1lZCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25TZXRSZWNvdmVyeU1ldGhvZENsaWNrID0gKCk6IHZvaWQgPT4ge1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5iYWNrdXBJbmZvKSB7XG4gICAgICAgICAgICAvLyBBIGtleSBiYWNrdXAgZXhpc3RzIGZvciB0aGlzIGFjY291bnQsIGJ1dCB0aGUgY3JlYXRpbmcgZGV2aWNlIGlzIG5vdFxuICAgICAgICAgICAgLy8gdmVyaWZpZWQsIHNvIHJlc3RvcmUgdGhlIGJhY2t1cCB3aGljaCB3aWxsIGdpdmUgdXMgdGhlIGtleXMgZnJvbSBpdCBhbmRcbiAgICAgICAgICAgIC8vIGFsbG93IHVzIHRvIHRydXN0IGl0IChpZS4gdXBsb2FkIGtleXMgdG8gaXQpXG4gICAgICAgICAgICBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nKFxuICAgICAgICAgICAgICAgICdSZXN0b3JlIEJhY2t1cCcsICcnLCBSZXN0b3JlS2V5QmFja3VwRGlhbG9nLCBudWxsLCBudWxsLFxuICAgICAgICAgICAgICAgIC8qIHByaW9yaXR5ID0gKi8gZmFsc2UsIC8qIHN0YXRpYyA9ICovIHRydWUsXG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZ0FzeW5jKFwiS2V5IEJhY2t1cFwiLCBcIktleSBCYWNrdXBcIixcbiAgICAgICAgICAgICAgICBpbXBvcnQoXG4gICAgICAgICAgICAgICAgICAgIFwiLi4vLi4vLi4vYXN5bmMtY29tcG9uZW50cy92aWV3cy9kaWFsb2dzL3NlY3VyaXR5L0NyZWF0ZUtleUJhY2t1cERpYWxvZ1wiXG4gICAgICAgICAgICAgICAgKSBhcyB1bmtub3duIGFzIFByb21pc2U8Q29tcG9uZW50VHlwZTx7fT4+LFxuICAgICAgICAgICAgICAgIG51bGwsIG51bGwsIC8qIHByaW9yaXR5ID0gKi8gZmFsc2UsIC8qIHN0YXRpYyA9ICovIHRydWUsXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gY2xvc2UgZGlhbG9nXG4gICAgICAgIHRoaXMucHJvcHMub25GaW5pc2hlZCh0cnVlKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkxvZ291dENvbmZpcm0gPSAoKTogdm9pZCA9PiB7XG4gICAgICAgIGRpcy5kaXNwYXRjaCh7IGFjdGlvbjogJ2xvZ291dCcgfSk7XG5cbiAgICAgICAgLy8gY2xvc2UgZGlhbG9nXG4gICAgICAgIHRoaXMucHJvcHMub25GaW5pc2hlZCh0cnVlKTtcbiAgICB9O1xuXG4gICAgcmVuZGVyKCkge1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5zaG91bGRMb2FkQmFja3VwU3RhdHVzKSB7XG4gICAgICAgICAgICBjb25zdCBkZXNjcmlwdGlvbiA9IDxkaXY+XG4gICAgICAgICAgICAgICAgPHA+eyBfdChcbiAgICAgICAgICAgICAgICAgICAgXCJFbmNyeXB0ZWQgbWVzc2FnZXMgYXJlIHNlY3VyZWQgd2l0aCBlbmQtdG8tZW5kIGVuY3J5cHRpb24uIFwiICtcbiAgICAgICAgICAgICAgICAgICAgXCJPbmx5IHlvdSBhbmQgdGhlIHJlY2lwaWVudChzKSBoYXZlIHRoZSBrZXlzIHRvIHJlYWQgdGhlc2UgbWVzc2FnZXMuXCIsXG4gICAgICAgICAgICAgICAgKSB9PC9wPlxuICAgICAgICAgICAgICAgIDxwPnsgX3QoXCJCYWNrIHVwIHlvdXIga2V5cyBiZWZvcmUgc2lnbmluZyBvdXQgdG8gYXZvaWQgbG9zaW5nIHRoZW0uXCIpIH08L3A+XG4gICAgICAgICAgICA8L2Rpdj47XG5cbiAgICAgICAgICAgIGxldCBkaWFsb2dDb250ZW50O1xuICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUubG9hZGluZykge1xuICAgICAgICAgICAgICAgIGRpYWxvZ0NvbnRlbnQgPSA8U3Bpbm5lciAvPjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbGV0IHNldHVwQnV0dG9uQ2FwdGlvbjtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0ZS5iYWNrdXBJbmZvKSB7XG4gICAgICAgICAgICAgICAgICAgIHNldHVwQnV0dG9uQ2FwdGlvbiA9IF90KFwiQ29ubmVjdCB0aGlzIHNlc3Npb24gdG8gS2V5IEJhY2t1cFwiKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGVyZSdzIGFuIGVycm9yIGZldGNoaW5nIHRoZSBiYWNrdXAgaW5mbywgd2UnbGwganVzdCBhc3N1bWUgdGhlcmUnc1xuICAgICAgICAgICAgICAgICAgICAvLyBubyBiYWNrdXAgZm9yIHRoZSBwdXJwb3NlIG9mIHRoZSBidXR0b24gY2FwdGlvblxuICAgICAgICAgICAgICAgICAgICBzZXR1cEJ1dHRvbkNhcHRpb24gPSBfdChcIlN0YXJ0IHVzaW5nIEtleSBCYWNrdXBcIik7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgZGlhbG9nQ29udGVudCA9IDxkaXY+XG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfRGlhbG9nX2NvbnRlbnRcIiBpZD0nbXhfRGlhbG9nX2NvbnRlbnQnPlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBkZXNjcmlwdGlvbiB9XG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICA8RGlhbG9nQnV0dG9ucyBwcmltYXJ5QnV0dG9uPXtzZXR1cEJ1dHRvbkNhcHRpb259XG4gICAgICAgICAgICAgICAgICAgICAgICBoYXNDYW5jZWw9e2ZhbHNlfVxuICAgICAgICAgICAgICAgICAgICAgICAgb25QcmltYXJ5QnV0dG9uQ2xpY2s9e3RoaXMub25TZXRSZWNvdmVyeU1ldGhvZENsaWNrfVxuICAgICAgICAgICAgICAgICAgICAgICAgZm9jdXM9e3RydWV9XG4gICAgICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxidXR0b24gb25DbGljaz17dGhpcy5vbkxvZ291dENvbmZpcm19PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCJJIGRvbid0IHdhbnQgbXkgZW5jcnlwdGVkIG1lc3NhZ2VzXCIpIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvYnV0dG9uPlxuICAgICAgICAgICAgICAgICAgICA8L0RpYWxvZ0J1dHRvbnM+XG4gICAgICAgICAgICAgICAgICAgIDxkZXRhaWxzPlxuICAgICAgICAgICAgICAgICAgICAgICAgPHN1bW1hcnk+eyBfdChcIkFkdmFuY2VkXCIpIH08L3N1bW1hcnk+XG4gICAgICAgICAgICAgICAgICAgICAgICA8cD48YnV0dG9uIG9uQ2xpY2s9e3RoaXMub25FeHBvcnRFMmVLZXlzQ2xpY2tlZH0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIk1hbnVhbGx5IGV4cG9ydCBrZXlzXCIpIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvYnV0dG9uPjwvcD5cbiAgICAgICAgICAgICAgICAgICAgPC9kZXRhaWxzPlxuICAgICAgICAgICAgICAgIDwvZGl2PjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIE5vdCBxdWl0ZSBhIHN0YW5kYXJkIHF1ZXN0aW9uIGRpYWxvZyBhcyB0aGUgcHJpbWFyeSBidXR0b24gY2FuY2Vsc1xuICAgICAgICAgICAgLy8gdGhlIGFjdGlvbiBhbmQgZG9lcyBzb21ldGhpbmcgZWxzZSBpbnN0ZWFkLCB3aGlsc3Qgbm9uLWRlZmF1bHQgYnV0dG9uXG4gICAgICAgICAgICAvLyBjb25maXJtcyB0aGUgYWN0aW9uLlxuICAgICAgICAgICAgcmV0dXJuICg8QmFzZURpYWxvZ1xuICAgICAgICAgICAgICAgIHRpdGxlPXtfdChcIllvdSdsbCBsb3NlIGFjY2VzcyB0byB5b3VyIGVuY3J5cHRlZCBtZXNzYWdlc1wiKX1cbiAgICAgICAgICAgICAgICBjb250ZW50SWQ9J214X0RpYWxvZ19jb250ZW50J1xuICAgICAgICAgICAgICAgIGhhc0NhbmNlbD17dHJ1ZX1cbiAgICAgICAgICAgICAgICBvbkZpbmlzaGVkPXt0aGlzLm9uRmluaXNoZWR9XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgeyBkaWFsb2dDb250ZW50IH1cbiAgICAgICAgICAgIDwvQmFzZURpYWxvZz4pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuICg8UXVlc3Rpb25EaWFsb2dcbiAgICAgICAgICAgICAgICBoYXNDYW5jZWxCdXR0b249e3RydWV9XG4gICAgICAgICAgICAgICAgdGl0bGU9e190KFwiU2lnbiBvdXRcIil9XG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb249e190KFxuICAgICAgICAgICAgICAgICAgICBcIkFyZSB5b3Ugc3VyZSB5b3Ugd2FudCB0byBzaWduIG91dD9cIixcbiAgICAgICAgICAgICAgICApfVxuICAgICAgICAgICAgICAgIGJ1dHRvbj17X3QoXCJTaWduIG91dFwiKX1cbiAgICAgICAgICAgICAgICBvbkZpbmlzaGVkPXt0aGlzLm9uRmluaXNoZWR9XG4gICAgICAgICAgICAvPik7XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=