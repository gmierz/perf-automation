"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireWildcard(require("react"));

var _classnames = _interopRequireDefault(require("classnames"));

var _event = require("matrix-js-sdk/src/models/event");

var _languageHandler = require("../../../languageHandler");

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var _useSettings = require("../../../hooks/useSettings");

var _UIFeature = require("../../../settings/UIFeature");

var _Layout = require("../../../settings/enums/Layout");

var _BaseDialog = _interopRequireDefault(require("./BaseDialog"));

var _Avatar = require("../../../Avatar");

var _EventTile = _interopRequireDefault(require("../rooms/EventTile"));

var _SearchBox = _interopRequireDefault(require("../../structures/SearchBox"));

var _DecoratedRoomAvatar = _interopRequireDefault(require("../avatars/DecoratedRoomAvatar"));

var _Tooltip = require("../elements/Tooltip");

var _AccessibleTooltipButton = _interopRequireDefault(require("../elements/AccessibleTooltipButton"));

var _AutoHideScrollbar = _interopRequireDefault(require("../../structures/AutoHideScrollbar"));

var _StaticNotificationState = require("../../../stores/notifications/StaticNotificationState");

var _NotificationBadge = _interopRequireDefault(require("../rooms/NotificationBadge"));

var _RecentAlgorithm = require("../../../stores/room-list/algorithms/tag-sorting/RecentAlgorithm");

var _QueryMatcher = _interopRequireDefault(require("../../../autocomplete/QueryMatcher"));

var _TruncatedList = _interopRequireDefault(require("../elements/TruncatedList"));

var _EntityTile = _interopRequireDefault(require("../rooms/EntityTile"));

var _BaseAvatar = _interopRequireDefault(require("../avatars/BaseAvatar"));

var _SpaceStore = _interopRequireDefault(require("../../../stores/spaces/SpaceStore"));

var _Rooms = require("../../../Rooms");

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/*
Copyright 2021 Robin Townsend <robin@robin.town>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const AVATAR_SIZE = 30;
var SendState;

(function (SendState) {
  SendState[SendState["CanSend"] = 0] = "CanSend";
  SendState[SendState["Sending"] = 1] = "Sending";
  SendState[SendState["Sent"] = 2] = "Sent";
  SendState[SendState["Failed"] = 3] = "Failed";
})(SendState || (SendState = {}));

const Entry = ({
  room,
  event,
  matrixClient: cli,
  onFinished
}) => {
  const [sendState, setSendState] = (0, _react.useState)(SendState.CanSend);

  const jumpToRoom = () => {
    _dispatcher.default.dispatch({
      action: "view_room",
      room_id: room.roomId
    });

    onFinished(true);
  };

  const send = async () => {
    setSendState(SendState.Sending);

    try {
      await cli.sendEvent(room.roomId, event.getType(), event.getContent());
      setSendState(SendState.Sent);
    } catch (e) {
      setSendState(SendState.Failed);
    }
  };

  let className;
  let disabled = false;
  let title;
  let icon;

  if (sendState === SendState.CanSend) {
    className = "mx_ForwardList_canSend";

    if (room.maySendMessage()) {
      title = (0, _languageHandler._t)("Send");
    } else {
      disabled = true;
      title = (0, _languageHandler._t)("You don't have permission to do this");
    }
  } else if (sendState === SendState.Sending) {
    className = "mx_ForwardList_sending";
    disabled = true;
    title = (0, _languageHandler._t)("Sending");
    icon = /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_ForwardList_sendIcon",
      "aria-label": title
    });
  } else if (sendState === SendState.Sent) {
    className = "mx_ForwardList_sent";
    disabled = true;
    title = (0, _languageHandler._t)("Sent");
    icon = /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_ForwardList_sendIcon",
      "aria-label": title
    });
  } else {
    className = "mx_ForwardList_sendFailed";
    disabled = true;
    title = (0, _languageHandler._t)("Failed to send");
    icon = /*#__PURE__*/_react.default.createElement(_NotificationBadge.default, {
      notification: _StaticNotificationState.StaticNotificationState.RED_EXCLAMATION
    });
  }

  const detailsText = (0, _Rooms.roomContextDetailsText)(room);
  return /*#__PURE__*/_react.default.createElement("div", {
    className: "mx_ForwardList_entry"
  }, /*#__PURE__*/_react.default.createElement(_AccessibleTooltipButton.default, {
    className: "mx_ForwardList_roomButton",
    onClick: jumpToRoom,
    title: (0, _languageHandler._t)("Open link"),
    yOffset: -20,
    alignment: _Tooltip.Alignment.Top
  }, /*#__PURE__*/_react.default.createElement(_DecoratedRoomAvatar.default, {
    room: room,
    avatarSize: 32
  }), /*#__PURE__*/_react.default.createElement("span", {
    className: "mx_ForwardList_entry_name"
  }, room.name), detailsText && /*#__PURE__*/_react.default.createElement("span", {
    className: "mx_ForwardList_entry_detail"
  }, detailsText)), /*#__PURE__*/_react.default.createElement(_AccessibleTooltipButton.default, {
    kind: sendState === SendState.Failed ? "danger_outline" : "primary_outline",
    className: `mx_ForwardList_sendButton ${className}`,
    onClick: send,
    disabled: disabled,
    title: title,
    yOffset: -20,
    alignment: _Tooltip.Alignment.Top
  }, /*#__PURE__*/_react.default.createElement("div", {
    className: "mx_ForwardList_sendLabel"
  }, (0, _languageHandler._t)("Send")), icon));
};

const ForwardDialog = ({
  matrixClient: cli,
  event,
  permalinkCreator,
  onFinished
}) => {
  const userId = cli.getUserId();
  const [profileInfo, setProfileInfo] = (0, _react.useState)({});
  (0, _react.useEffect)(() => {
    cli.getProfileInfo(userId).then(info => setProfileInfo(info));
  }, [cli, userId]); // For the message preview we fake the sender as ourselves

  const mockEvent = new _event.MatrixEvent({
    type: "m.room.message",
    sender: userId,
    content: event.getContent(),
    unsigned: {
      age: 97
    },
    event_id: "$9999999999999999999999999999999999999999999",
    room_id: event.getRoomId()
  });
  mockEvent.sender = {
    name: profileInfo.displayname || userId,
    rawDisplayName: profileInfo.displayname,
    userId,
    getAvatarUrl: (..._) => {
      return (0, _Avatar.avatarUrlForUser)({
        avatarUrl: profileInfo.avatar_url
      }, AVATAR_SIZE, AVATAR_SIZE, "crop");
    },
    getMxcAvatarUrl: () => profileInfo.avatar_url
  };
  const [query, setQuery] = (0, _react.useState)("");
  const lcQuery = query.toLowerCase();
  const spacesEnabled = _SpaceStore.default.spacesEnabled;
  const flairEnabled = (0, _useSettings.useFeatureEnabled)(_UIFeature.UIFeature.Flair);
  const previewLayout = (0, _useSettings.useSettingValue)("layout");
  let rooms = (0, _react.useMemo)(() => (0, _RecentAlgorithm.sortRooms)(cli.getVisibleRooms().filter(room => room.getMyMembership() === "join" && !(spacesEnabled && room.isSpaceRoom()))), [cli, spacesEnabled]);

  if (lcQuery) {
    rooms = new _QueryMatcher.default(rooms, {
      keys: ["name"],
      funcs: [r => [r.getCanonicalAlias(), ...r.getAltAliases()].filter(Boolean)],
      shouldMatchWordsOnly: false
    }).match(lcQuery);
  }

  const [truncateAt, setTruncateAt] = (0, _react.useState)(20);

  function overflowTile(overflowCount, totalCount) {
    const text = (0, _languageHandler._t)("and %(count)s others...", {
      count: overflowCount
    });
    return /*#__PURE__*/_react.default.createElement(_EntityTile.default, {
      className: "mx_EntityTile_ellipsis",
      avatarJsx: /*#__PURE__*/_react.default.createElement(_BaseAvatar.default, {
        url: require("../../../../res/img/ellipsis.svg"),
        name: "...",
        width: 36,
        height: 36
      }),
      name: text,
      presenceState: "online",
      suppressOnHover: true,
      onClick: () => setTruncateAt(totalCount)
    });
  }

  return /*#__PURE__*/_react.default.createElement(_BaseDialog.default, {
    title: (0, _languageHandler._t)("Forward message"),
    className: "mx_ForwardDialog",
    contentId: "mx_ForwardList",
    onFinished: onFinished,
    fixedWidth: false
  }, /*#__PURE__*/_react.default.createElement("h3", null, (0, _languageHandler._t)("Message preview")), /*#__PURE__*/_react.default.createElement("div", {
    className: (0, _classnames.default)("mx_ForwardDialog_preview", {
      "mx_IRCLayout": previewLayout == _Layout.Layout.IRC,
      "mx_GroupLayout": previewLayout == _Layout.Layout.Group
    })
  }, /*#__PURE__*/_react.default.createElement(_EventTile.default, {
    mxEvent: mockEvent,
    layout: previewLayout,
    enableFlair: flairEnabled,
    permalinkCreator: permalinkCreator,
    as: "div"
  })), /*#__PURE__*/_react.default.createElement("hr", null), /*#__PURE__*/_react.default.createElement("div", {
    className: "mx_ForwardList",
    id: "mx_ForwardList"
  }, /*#__PURE__*/_react.default.createElement(_SearchBox.default, {
    className: "mx_textinput_icon mx_textinput_search",
    placeholder: (0, _languageHandler._t)("Search for rooms or people"),
    onSearch: setQuery,
    autoFocus: true
  }), /*#__PURE__*/_react.default.createElement(_AutoHideScrollbar.default, {
    className: "mx_ForwardList_content"
  }, rooms.length > 0 ? /*#__PURE__*/_react.default.createElement("div", {
    className: "mx_ForwardList_results"
  }, /*#__PURE__*/_react.default.createElement(_TruncatedList.default, {
    truncateAt: truncateAt,
    createOverflowElement: overflowTile,
    getChildren: (start, end) => rooms.slice(start, end).map(room => /*#__PURE__*/_react.default.createElement(Entry, {
      key: room.roomId,
      room: room,
      event: event,
      matrixClient: cli,
      onFinished: onFinished
    })),
    getChildCount: () => rooms.length
  })) : /*#__PURE__*/_react.default.createElement("span", {
    className: "mx_ForwardList_noResults"
  }, (0, _languageHandler._t)("No results")))));
};

var _default = ForwardDialog;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvRm9yd2FyZERpYWxvZy50c3giXSwibmFtZXMiOlsiQVZBVEFSX1NJWkUiLCJTZW5kU3RhdGUiLCJFbnRyeSIsInJvb20iLCJldmVudCIsIm1hdHJpeENsaWVudCIsImNsaSIsIm9uRmluaXNoZWQiLCJzZW5kU3RhdGUiLCJzZXRTZW5kU3RhdGUiLCJDYW5TZW5kIiwianVtcFRvUm9vbSIsImRpcyIsImRpc3BhdGNoIiwiYWN0aW9uIiwicm9vbV9pZCIsInJvb21JZCIsInNlbmQiLCJTZW5kaW5nIiwic2VuZEV2ZW50IiwiZ2V0VHlwZSIsImdldENvbnRlbnQiLCJTZW50IiwiZSIsIkZhaWxlZCIsImNsYXNzTmFtZSIsImRpc2FibGVkIiwidGl0bGUiLCJpY29uIiwibWF5U2VuZE1lc3NhZ2UiLCJTdGF0aWNOb3RpZmljYXRpb25TdGF0ZSIsIlJFRF9FWENMQU1BVElPTiIsImRldGFpbHNUZXh0IiwiQWxpZ25tZW50IiwiVG9wIiwibmFtZSIsIkZvcndhcmREaWFsb2ciLCJwZXJtYWxpbmtDcmVhdG9yIiwidXNlcklkIiwiZ2V0VXNlcklkIiwicHJvZmlsZUluZm8iLCJzZXRQcm9maWxlSW5mbyIsImdldFByb2ZpbGVJbmZvIiwidGhlbiIsImluZm8iLCJtb2NrRXZlbnQiLCJNYXRyaXhFdmVudCIsInR5cGUiLCJzZW5kZXIiLCJjb250ZW50IiwidW5zaWduZWQiLCJhZ2UiLCJldmVudF9pZCIsImdldFJvb21JZCIsImRpc3BsYXluYW1lIiwicmF3RGlzcGxheU5hbWUiLCJnZXRBdmF0YXJVcmwiLCJfIiwiYXZhdGFyVXJsIiwiYXZhdGFyX3VybCIsImdldE14Y0F2YXRhclVybCIsInF1ZXJ5Iiwic2V0UXVlcnkiLCJsY1F1ZXJ5IiwidG9Mb3dlckNhc2UiLCJzcGFjZXNFbmFibGVkIiwiU3BhY2VTdG9yZSIsImZsYWlyRW5hYmxlZCIsIlVJRmVhdHVyZSIsIkZsYWlyIiwicHJldmlld0xheW91dCIsInJvb21zIiwiZ2V0VmlzaWJsZVJvb21zIiwiZmlsdGVyIiwiZ2V0TXlNZW1iZXJzaGlwIiwiaXNTcGFjZVJvb20iLCJRdWVyeU1hdGNoZXIiLCJrZXlzIiwiZnVuY3MiLCJyIiwiZ2V0Q2Fub25pY2FsQWxpYXMiLCJnZXRBbHRBbGlhc2VzIiwiQm9vbGVhbiIsInNob3VsZE1hdGNoV29yZHNPbmx5IiwibWF0Y2giLCJ0cnVuY2F0ZUF0Iiwic2V0VHJ1bmNhdGVBdCIsIm92ZXJmbG93VGlsZSIsIm92ZXJmbG93Q291bnQiLCJ0b3RhbENvdW50IiwidGV4dCIsImNvdW50IiwicmVxdWlyZSIsIkxheW91dCIsIklSQyIsIkdyb3VwIiwibGVuZ3RoIiwic3RhcnQiLCJlbmQiLCJzbGljZSIsIm1hcCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBZ0JBOztBQUNBOztBQUNBOztBQUtBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7QUE5Q0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBa0NBLE1BQU1BLFdBQVcsR0FBRyxFQUFwQjtJQWtCS0MsUzs7V0FBQUEsUztBQUFBQSxFQUFBQSxTLENBQUFBLFM7QUFBQUEsRUFBQUEsUyxDQUFBQSxTO0FBQUFBLEVBQUFBLFMsQ0FBQUEsUztBQUFBQSxFQUFBQSxTLENBQUFBLFM7R0FBQUEsUyxLQUFBQSxTOztBQU9MLE1BQU1DLEtBQTRCLEdBQUcsQ0FBQztBQUFFQyxFQUFBQSxJQUFGO0FBQVFDLEVBQUFBLEtBQVI7QUFBZUMsRUFBQUEsWUFBWSxFQUFFQyxHQUE3QjtBQUFrQ0MsRUFBQUE7QUFBbEMsQ0FBRCxLQUFvRDtBQUNyRixRQUFNLENBQUNDLFNBQUQsRUFBWUMsWUFB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LEVBQUM7QUFBN0IsS0FDTVMsS0FBSyxDQUFDeUIsTUFBTixHQUFlLENBQWYsZ0JBQ0U7QUFBSyxJQUFBLFNBQVMsRUFBQztBQUFmLGtCQUNJLDZCQUFDLHNCQUFEO0FBQ0ksSUFBQSxVQUFVLEVBQUVYLFVBRGhCO0FBRUksSUFBQSxxQkFBcUIsRUFBRUUsWUFGM0I7QUFHSSxJQUFBLFdBQVcsRUFBRSxDQUFDVSxLQUFELEVBQVFDLEdBQVIsS0FBZ0IzQixLQUFLLENBQUM0QixLQUFOLENBQVlGLEtBQVosRUFBbUJDLEdBQW5CLEVBQXdCRSxHQUF4QixDQUE0QmpHLElBQUksaUJBQ3pELDZCQUFDLEtBQUQ7QUFDSSxNQUFBLEdBQUcsRUFBRUEsSUFBSSxDQUFDYSxNQURkO0FBRUksTUFBQSxJQUFJLEVBQUViLElBRlY7QUFHSSxNQUFBLEtBQUssRUFBRUMsS0FIWDtBQUlJLE1BQUEsWUFBWSxFQUFFRSxHQUpsQjtBQUtJLE1BQUEsVUFBVSxFQUFFQztBQUxoQixNQUR5QixDQUhqQztBQVlJLElBQUEsYUFBYSxFQUFFLE1BQU1nRSxLQUFLLENBQUN5QjtBQVovQixJQURKLENBREYsZ0JBaUJFO0FBQU0sSUFBQSxTQUFTLEVBQUM7QUFBaEIsS0FDRSx5QkFBRyxZQUFILENBREYsQ0FsQlIsQ0FQSixDQXJCRyxDQUFQO0FBb0RILENBMUhEOztlQTRIZTVELGEiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMjEgUm9iaW4gVG93bnNlbmQgPHJvYmluQHJvYmluLnRvd24+XG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0LCB7IHVzZU1lbW8sIHVzZVN0YXRlLCB1c2VFZmZlY3QgfSBmcm9tIFwicmVhY3RcIjtcbmltcG9ydCBjbGFzc25hbWVzIGZyb20gXCJjbGFzc25hbWVzXCI7XG5pbXBvcnQgeyBNYXRyaXhFdmVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvZXZlbnRcIjtcbmltcG9ydCB7IFJvb20gfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3Jvb21cIjtcbmltcG9ydCB7IE1hdHJpeENsaWVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9jbGllbnRcIjtcbmltcG9ydCB7IFJvb21NZW1iZXIgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3Jvb20tbWVtYmVyXCI7XG5cbmltcG9ydCB7IF90IH0gZnJvbSBcIi4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlclwiO1xuaW1wb3J0IGRpcyBmcm9tIFwiLi4vLi4vLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyXCI7XG5pbXBvcnQgeyB1c2VTZXR0aW5nVmFsdWUsIHVzZUZlYXR1cmVFbmFibGVkIH0gZnJvbSBcIi4uLy4uLy4uL2hvb2tzL3VzZVNldHRpbmdzXCI7XG5pbXBvcnQgeyBVSUZlYXR1cmUgfSBmcm9tIFwiLi4vLi4vLi4vc2V0dGluZ3MvVUlGZWF0dXJlXCI7XG5pbXBvcnQgeyBMYXlvdXQgfSBmcm9tIFwiLi4vLi4vLi4vc2V0dGluZ3MvZW51bXMvTGF5b3V0XCI7XG5pbXBvcnQgeyBJRGlhbG9nUHJvcHMgfSBmcm9tIFwiLi9JRGlhbG9nUHJvcHNcIjtcbmltcG9ydCBCYXNlRGlhbG9nIGZyb20gXCIuL0Jhc2VEaWFsb2dcIjtcbmltcG9ydCB7IGF2YXRhclVybEZvclVzZXIgfSBmcm9tIFwiLi4vLi4vLi4vQXZhdGFyXCI7XG5pbXBvcnQgRXZlbnRUaWxlIGZyb20gXCIuLi9yb29tcy9FdmVudFRpbGVcIjtcbmltcG9ydCBTZWFyY2hCb3ggZnJvbSBcIi4uLy4uL3N0cnVjdHVyZXMvU2VhcmNoQm94XCI7XG5pbXBvcnQgRGVjb3JhdGVkUm9vbUF2YXRhciBmcm9tIFwiLi4vYXZhdGFycy9EZWNvcmF0ZWRSb29tQXZhdGFyXCI7XG5pbXBvcnQgeyBBbGlnbm1lbnQgfSBmcm9tICcuLi9lbGVtZW50cy9Ub29sdGlwJztcbmltcG9ydCBBY2Nlc3NpYmxlVG9vbHRpcEJ1dHRvbiBmcm9tIFwiLi4vZWxlbWVudHMvQWNjZXNzaWJsZVRvb2x0aXBCdXR0b25cIjtcbmltcG9ydCBBdXRvSGlkZVNjcm9sbGJhciBmcm9tIFwiLi4vLi4vc3RydWN0dXJlcy9BdXRvSGlkZVNjcm9sbGJhclwiO1xuaW1wb3J0IHsgU3RhdGljTm90aWZpY2F0aW9uU3RhdGUgfSBmcm9tIFwiLi4vLi4vLi4vc3RvcmVzL25vdGlmaWNhdGlvbnMvU3RhdGljTm90aWZpY2F0aW9uU3RhdGVcIjtcbmltcG9ydCBOb3RpZmljYXRpb25CYWRnZSBmcm9tIFwiLi4vcm9vbXMvTm90aWZpY2F0aW9uQmFkZ2VcIjtcbmltcG9ydCB7IFJvb21QZXJtYWxpbmtDcmVhdG9yIH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3Blcm1hbGlua3MvUGVybWFsaW5rc1wiO1xuaW1wb3J0IHsgc29ydFJvb21zIH0gZnJvbSBcIi4uLy4uLy4uL3N0b3Jlcy9yb29tLWxpc3QvYWxnb3JpdGhtcy90YWctc29ydGluZy9SZWNlbnRBbGdvcml0aG1cIjtcbmltcG9ydCBRdWVyeU1hdGNoZXIgZnJvbSBcIi4uLy4uLy4uL2F1dG9jb21wbGV0ZS9RdWVyeU1hdGNoZXJcIjtcbmltcG9ydCBUcnVuY2F0ZWRMaXN0IGZyb20gXCIuLi9lbGVtZW50cy9UcnVuY2F0ZWRMaXN0XCI7XG5pbXBvcnQgRW50aXR5VGlsZSBmcm9tIFwiLi4vcm9vbXMvRW50aXR5VGlsZVwiO1xuaW1wb3J0IEJhc2VBdmF0YXIgZnJvbSBcIi4uL2F2YXRhcnMvQmFzZUF2YXRhclwiO1xuaW1wb3J0IFNwYWNlU3RvcmUgZnJvbSBcIi4uLy4uLy4uL3N0b3Jlcy9zcGFjZXMvU3BhY2VTdG9yZVwiO1xuaW1wb3J0IHsgcm9vbUNvbnRleHREZXRhaWxzVGV4dCB9IGZyb20gXCIuLi8uLi8uLi9Sb29tc1wiO1xuXG5jb25zdCBBVkFUQVJfU0laRSA9IDMwO1xuXG5pbnRlcmZhY2UgSVByb3BzIGV4dGVuZHMgSURpYWxvZ1Byb3BzIHtcbiAgICBtYXRyaXhDbGllbnQ6IE1hdHJpeENsaWVudDtcbiAgICAvLyBUaGUgZXZlbnQgdG8gZm9yd2FyZFxuICAgIGV2ZW50OiBNYXRyaXhFdmVudDtcbiAgICAvLyBXZSBuZWVkIGEgcGVybWFsaW5rIGNyZWF0b3IgZm9yIHRoZSBzb3VyY2Ugcm9vbSB0byBwYXNzIHRocm91Z2ggdG8gRXZlbnRUaWxlXG4gICAgLy8gaW4gY2FzZSB0aGUgZXZlbnQgaXMgYSByZXBseSAoZXZlbiB0aG91Z2ggdGhlIHVzZXIgY2FuJ3QgZ2V0IGF0IHRoZSBsaW5rKVxuICAgIHBlcm1hbGlua0NyZWF0b3I6IFJvb21QZXJtYWxpbmtDcmVhdG9yO1xufVxuXG5pbnRlcmZhY2UgSUVudHJ5UHJvcHMge1xuICAgIHJvb206IFJvb207XG4gICAgZXZlbnQ6IE1hdHJpeEV2ZW50O1xuICAgIG1hdHJpeENsaWVudDogTWF0cml4Q2xpZW50O1xuICAgIG9uRmluaXNoZWQoc3VjY2VzczogYm9vbGVhbik6IHZvaWQ7XG59XG5cbmVudW0gU2VuZFN0YXRlIHtcbiAgICBDYW5TZW5kLFxuICAgIFNlbmRpbmcsXG4gICAgU2VudCxcbiAgICBGYWlsZWQsXG59XG5cbmNvbnN0IEVudHJ5OiBSZWFjdC5GQzxJRW50cnlQcm9wcz4gPSAoeyByb29tLCBldmVudCwgbWF0cml4Q2xpZW50OiBjbGksIG9uRmluaXNoZWQgfSkgPT4ge1xuICAgIGNvbnN0IFtzZW5kU3RhdGUsIHNldFNlbmRTdGF0ZV0gPSB1c2VTdGF0ZTxTZW5kU3RhdGU+KFNlbmRTdGF0ZS5DYW5TZW5kKTtcblxuICAgIGNvbnN0IGp1bXBUb1Jvb20gPSAoKSA9PiB7XG4gICAgICAgIGRpcy5kaXNwYXRjaCh7XG4gICAgICAgICAgICBhY3Rpb246IFwidmlld19yb29tXCIsXG4gICAgICAgICAgICByb29tX2lkOiByb29tLnJvb21JZCxcbiAgICAgICAgfSk7XG4gICAgICAgIG9uRmluaXNoZWQodHJ1ZSk7XG4gICAgfTtcbiAgICBjb25zdCBzZW5kID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICBzZXRTZW5kU3RhdGUoU2VuZFN0YXRlLlNlbmRpbmcpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgY2xpLnNlbmRFdmVudChyb29tLnJvb21JZCwgZXZlbnQuZ2V0VHlwZSgpLCBldmVudC5nZXRDb250ZW50KCkpO1xuICAgICAgICAgICAgc2V0U2VuZFN0YXRlKFNlbmRTdGF0ZS5TZW50KTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgc2V0U2VuZFN0YXRlKFNlbmRTdGF0ZS5GYWlsZWQpO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIGxldCBjbGFzc05hbWU7XG4gICAgbGV0IGRpc2FibGVkID0gZmFsc2U7XG4gICAgbGV0IHRpdGxlO1xuICAgIGxldCBpY29uO1xuICAgIGlmIChzZW5kU3RhdGUgPT09IFNlbmRTdGF0ZS5DYW5TZW5kKSB7XG4gICAgICAgIGNsYXNzTmFtZSA9IFwibXhfRm9yd2FyZExpc3RfY2FuU2VuZFwiO1xuICAgICAgICBpZiAocm9vbS5tYXlTZW5kTWVzc2FnZSgpKSB7XG4gICAgICAgICAgICB0aXRsZSA9IF90KFwiU2VuZFwiKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGRpc2FibGVkID0gdHJ1ZTtcbiAgICAgICAgICAgIHRpdGxlID0gX3QoXCJZb3UgZG9uJ3QgaGF2ZSBwZXJtaXNzaW9uIHRvIGRvIHRoaXNcIik7XG4gICAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHNlbmRTdGF0ZSA9PT0gU2VuZFN0YXRlLlNlbmRpbmcpIHtcbiAgICAgICAgY2xhc3NOYW1lID0gXCJteF9Gb3J3YXJkTGlzdF9zZW5kaW5nXCI7XG4gICAgICAgIGRpc2FibGVkID0gdHJ1ZTtcbiAgICAgICAgdGl0bGUgPSBfdChcIlNlbmRpbmdcIik7XG4gICAgICAgIGljb24gPSA8ZGl2IGNsYXNzTmFtZT1cIm14X0ZvcndhcmRMaXN0X3NlbmRJY29uXCIgYXJpYS1sYWJlbD17dGl0bGV9IC8+O1xuICAgIH0gZWxzZSBpZiAoc2VuZFN0YXRlID09PSBTZW5kU3RhdGUuU2VudCkge1xuICAgICAgICBjbGFzc05hbWUgPSBcIm14X0ZvcndhcmRMaXN0X3NlbnRcIjtcbiAgICAgICAgZGlzYWJsZWQgPSB0cnVlO1xuICAgICAgICB0aXRsZSA9IF90KFwiU2VudFwiKTtcbiAgICAgICAgaWNvbiA9IDxkaXYgY2xhc3NOYW1lPVwibXhfRm9yd2FyZExpc3Rfc2VuZEljb25cIiBhcmlhLWxhYmVsPXt0aXRsZX0gLz47XG4gICAgfSBlbHNlIHtcbiAgICAgICAgY2xhc3NOYW1lID0gXCJteF9Gb3J3YXJkTGlzdF9zZW5kRmFpbGVkXCI7XG4gICAgICAgIGRpc2FibGVkID0gdHJ1ZTtcbiAgICAgICAgdGl0bGUgPSBfdChcIkZhaWxlZCB0byBzZW5kXCIpO1xuICAgICAgICBpY29uID0gPE5vdGlmaWNhdGlvbkJhZGdlXG4gICAgICAgICAgICBub3RpZmljYXRpb249e1N0YXRpY05vdGlmaWNhdGlvblN0YXRlLlJFRF9FWENMQU1BVElPTn1cbiAgICAgICAgLz47XG4gICAgfVxuXG4gICAgY29uc3QgZGV0YWlsc1RleHQgPSByb29tQ29udGV4dERldGFpbHNUZXh0KHJvb20pO1xuXG4gICAgcmV0dXJuIDxkaXYgY2xhc3NOYW1lPVwibXhfRm9yd2FyZExpc3RfZW50cnlcIj5cbiAgICAgICAgPEFjY2Vzc2libGVUb29sdGlwQnV0dG9uXG4gICAgICAgICAgICBjbGFzc05hbWU9XCJteF9Gb3J3YXJkTGlzdF9yb29tQnV0dG9uXCJcbiAgICAgICAgICAgIG9uQ2xpY2s9e2p1bXBUb1Jvb219XG4gICAgICAgICAgICB0aXRsZT17X3QoXCJPcGVuIGxpbmtcIil9XG4gICAgICAgICAgICB5T2Zmc2V0PXstMjB9XG4gICAgICAgICAgICBhbGlnbm1lbnQ9e0FsaWdubWVudC5Ub3B9XG4gICAgICAgID5cbiAgICAgICAgICAgIDxEZWNvcmF0ZWRSb29tQXZhdGFyIHJvb209e3Jvb219IGF2YXRhclNpemU9ezMyfSAvPlxuICAgICAgICAgICAgPHNwYW4gY2xhc3NOYW1lPVwibXhfRm9yd2FyZExpc3RfZW50cnlfbmFtZVwiPnsgcm9vbS5uYW1lIH08L3NwYW4+XG4gICAgICAgICAgICB7IGRldGFpbHNUZXh0ICYmIDxzcGFuIGNsYXNzTmFtZT1cIm14X0ZvcndhcmRMaXN0X2VudHJ5X2RldGFpbFwiPlxuICAgICAgICAgICAgICAgIHsgZGV0YWlsc1RleHQgfVxuICAgICAgICAgICAgPC9zcGFuPiB9XG4gICAgICAgIDwvQWNjZXNzaWJsZVRvb2x0aXBCdXR0b24+XG4gICAgICAgIDxBY2Nlc3NpYmxlVG9vbHRpcEJ1dHRvblxuICAgICAgICAgICAga2luZD17c2VuZFN0YXRlID09PSBTZW5kU3RhdGUuRmFpbGVkID8gXCJkYW5nZXJfb3V0bGluZVwiIDogXCJwcmltYXJ5X291dGxpbmVcIn1cbiAgICAgICAgICAgIGNsYXNzTmFtZT17YG14X0ZvcndhcmRMaXN0X3NlbmRCdXR0b24gJHtjbGFzc05hbWV9YH1cbiAgICAgICAgICAgIG9uQ2xpY2s9e3NlbmR9XG4gICAgICAgICAgICBkaXNhYmxlZD17ZGlzYWJsZWR9XG4gICAgICAgICAgICB0aXRsZT17dGl0bGV9XG4gICAgICAgICAgICB5T2Zmc2V0PXstMjB9XG4gICAgICAgICAgICBhbGlnbm1lbnQ9e0FsaWdubWVudC5Ub3B9XG4gICAgICAgID5cbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfRm9yd2FyZExpc3Rfc2VuZExhYmVsXCI+eyBfdChcIlNlbmRcIikgfTwvZGl2PlxuICAgICAgICAgICAgeyBpY29uIH1cbiAgICAgICAgPC9BY2Nlc3NpYmxlVG9vbHRpcEJ1dHRvbj5cbiAgICA8L2Rpdj47XG59O1xuXG5jb25zdCBGb3J3YXJkRGlhbG9nOiBSZWFjdC5GQzxJUHJvcHM+ID0gKHsgbWF0cml4Q2xpZW50OiBjbGksIGV2ZW50LCBwZXJtYWxpbmtDcmVhdG9yLCBvbkZpbmlzaGVkIH0pID0+IHtcbiAgICBjb25zdCB1c2VySWQgPSBjbGkuZ2V0VXNlcklkKCk7XG4gICAgY29uc3QgW3Byb2ZpbGVJbmZvLCBzZXRQcm9maWxlSW5mb10gPSB1c2VTdGF0ZTxhbnk+KHt9KTtcbiAgICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgICAgICBjbGkuZ2V0UHJvZmlsZUluZm8odXNlcklkKS50aGVuKGluZm8gPT4gc2V0UHJvZmlsZUluZm8oaW5mbykpO1xuICAgIH0sIFtjbGksIHVzZXJJZF0pO1xuXG4gICAgLy8gRm9yIHRoZSBtZXNzYWdlIHByZXZpZXcgd2UgZmFrZSB0aGUgc2VuZGVyIGFzIG91cnNlbHZlc1xuICAgIGNvbnN0IG1vY2tFdmVudCA9IG5ldyBNYXRyaXhFdmVudCh7XG4gICAgICAgIHR5cGU6IFwibS5yb29tLm1lc3NhZ2VcIixcbiAgICAgICAgc2VuZGVyOiB1c2VySWQsXG4gICAgICAgIGNvbnRlbnQ6IGV2ZW50LmdldENvbnRlbnQoKSxcbiAgICAgICAgdW5zaWduZWQ6IHtcbiAgICAgICAgICAgIGFnZTogOTcsXG4gICAgICAgIH0sXG4gICAgICAgIGV2ZW50X2lkOiBcIiQ5OTk5OTk5OTk5OTk5OTk5OTk5OTk5OTk5OTk5OTk5OTk5OTk5OTk5OTk5XCIsXG4gICAgICAgIHJvb21faWQ6IGV2ZW50LmdldFJvb21JZCgpLFxuICAgIH0pO1xuICAgIG1vY2tFdmVudC5zZW5kZXIgPSB7XG4gICAgICAgIG5hbWU6IHByb2ZpbGVJbmZvLmRpc3BsYXluYW1lIHx8IHVzZXJJZCxcbiAgICAgICAgcmF3RGlzcGxheU5hbWU6IHByb2ZpbGVJbmZvLmRpc3BsYXluYW1lLFxuICAgICAgICB1c2VySWQsXG4gICAgICAgIGdldEF2YXRhclVybDogKC4uLl8pID0+IHtcbiAgICAgICAgICAgIHJldHVybiBhdmF0YXJVcmxGb3JVc2VyKFxuICAgICAgICAgICAgICAgIHsgYXZhdGFyVXJsOiBwcm9maWxlSW5mby5hdmF0YXJfdXJsIH0sXG4gICAgICAgICAgICAgICAgQVZBVEFSX1NJWkUsIEFWQVRBUl9TSVpFLCBcImNyb3BcIixcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0sXG4gICAgICAgIGdldE14Y0F2YXRhclVybDogKCkgPT4gcHJvZmlsZUluZm8uYXZhdGFyX3VybCxcbiAgICB9IGFzIFJvb21NZW1iZXI7XG5cbiAgICBjb25zdCBbcXVlcnksIHNldFF1ZXJ5XSA9IHVzZVN0YXRlKFwiXCIpO1xuICAgIGNvbnN0IGxjUXVlcnkgPSBxdWVyeS50b0xvd2VyQ2FzZSgpO1xuXG4gICAgY29uc3Qgc3BhY2VzRW5hYmxlZCA9IFNwYWNlU3RvcmUuc3BhY2VzRW5hYmxlZDtcbiAgICBjb25zdCBmbGFpckVuYWJsZWQgPSB1c2VGZWF0dXJlRW5hYmxlZChVSUZlYXR1cmUuRmxhaXIpO1xuICAgIGNvbnN0IHByZXZpZXdMYXlvdXQgPSB1c2VTZXR0aW5nVmFsdWU8TGF5b3V0PihcImxheW91dFwiKTtcblxuICAgIGxldCByb29tcyA9IHVzZU1lbW8oKCkgPT4gc29ydFJvb21zKFxuICAgICAgICBjbGkuZ2V0VmlzaWJsZVJvb21zKCkuZmlsdGVyKFxuICAgICAgICAgICAgcm9vbSA9PiByb29tLmdldE15TWVtYmVyc2hpcCgpID09PSBcImpvaW5cIiAmJlxuICAgICAgICAgICAgICAgICEoc3BhY2VzRW5hYmxlZCAmJiByb29tLmlzU3BhY2VSb29tKCkpLFxuICAgICAgICApLFxuICAgICksIFtjbGksIHNwYWNlc0VuYWJsZWRdKTtcblxuICAgIGlmIChsY1F1ZXJ5KSB7XG4gICAgICAgIHJvb21zID0gbmV3IFF1ZXJ5TWF0Y2hlcjxSb29tPihyb29tcywge1xuICAgICAgICAgICAga2V5czogW1wibmFtZVwiXSxcbiAgICAgICAgICAgIGZ1bmNzOiBbciA9PiBbci5nZXRDYW5vbmljYWxBbGlhcygpLCAuLi5yLmdldEFsdEFsaWFzZXMoKV0uZmlsdGVyKEJvb2xlYW4pXSxcbiAgICAgICAgICAgIHNob3VsZE1hdGNoV29yZHNPbmx5OiBmYWxzZSxcbiAgICAgICAgfSkubWF0Y2gobGNRdWVyeSk7XG4gICAgfVxuXG4gICAgY29uc3QgW3RydW5jYXRlQXQsIHNldFRydW5jYXRlQXRdID0gdXNlU3RhdGUoMjApO1xuICAgIGZ1bmN0aW9uIG92ZXJmbG93VGlsZShvdmVyZmxvd0NvdW50LCB0b3RhbENvdW50KSB7XG4gICAgICAgIGNvbnN0IHRleHQgPSBfdChcImFuZCAlKGNvdW50KXMgb3RoZXJzLi4uXCIsIHsgY291bnQ6IG92ZXJmbG93Q291bnQgfSk7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8RW50aXR5VGlsZVxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X0VudGl0eVRpbGVfZWxsaXBzaXNcIlxuICAgICAgICAgICAgICAgIGF2YXRhckpzeD17XG4gICAgICAgICAgICAgICAgICAgIDxCYXNlQXZhdGFyIHVybD17cmVxdWlyZShcIi4uLy4uLy4uLy4uL3Jlcy9pbWcvZWxsaXBzaXMuc3ZnXCIpfSBuYW1lPVwiLi4uXCIgd2lkdGg9ezM2fSBoZWlnaHQ9ezM2fSAvPlxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBuYW1lPXt0ZXh0fVxuICAgICAgICAgICAgICAgIHByZXNlbmNlU3RhdGU9XCJvbmxpbmVcIlxuICAgICAgICAgICAgICAgIHN1cHByZXNzT25Ib3Zlcj17dHJ1ZX1cbiAgICAgICAgICAgICAgICBvbkNsaWNrPXsoKSA9PiBzZXRUcnVuY2F0ZUF0KHRvdGFsQ291bnQpfVxuICAgICAgICAgICAgLz5cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gPEJhc2VEaWFsb2dcbiAgICAgICAgdGl0bGU9e190KFwiRm9yd2FyZCBtZXNzYWdlXCIpfVxuICAgICAgICBjbGFzc05hbWU9XCJteF9Gb3J3YXJkRGlhbG9nXCJcbiAgICAgICAgY29udGVudElkPVwibXhfRm9yd2FyZExpc3RcIlxuICAgICAgICBvbkZpbmlzaGVkPXtvbkZpbmlzaGVkfVxuICAgICAgICBmaXhlZFdpZHRoPXtmYWxzZX1cbiAgICA+XG4gICAgICAgIDxoMz57IF90KFwiTWVzc2FnZSBwcmV2aWV3XCIpIH08L2gzPlxuICAgICAgICA8ZGl2IGNsYXNzTmFtZT17Y2xhc3NuYW1lcyhcIm14X0ZvcndhcmREaWFsb2dfcHJldmlld1wiLCB7XG4gICAgICAgICAgICBcIm14X0lSQ0xheW91dFwiOiBwcmV2aWV3TGF5b3V0ID09IExheW91dC5JUkMsXG4gICAgICAgICAgICBcIm14X0dyb3VwTGF5b3V0XCI6IHByZXZpZXdMYXlvdXQgPT0gTGF5b3V0Lkdyb3VwLFxuICAgICAgICB9KX0+XG4gICAgICAgICAgICA8RXZlbnRUaWxlXG4gICAgICAgICAgICAgICAgbXhFdmVudD17bW9ja0V2ZW50fVxuICAgICAgICAgICAgICAgIGxheW91dD17cHJldmlld0xheW91dH1cbiAgICAgICAgICAgICAgICBlbmFibGVGbGFpcj17ZmxhaXJFbmFibGVkfVxuICAgICAgICAgICAgICAgIHBlcm1hbGlua0NyZWF0b3I9e3Blcm1hbGlua0NyZWF0b3J9XG4gICAgICAgICAgICAgICAgYXM9XCJkaXZcIlxuICAgICAgICAgICAgLz5cbiAgICAgICAgPC9kaXY+XG4gICAgICAgIDxociAvPlxuICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0ZvcndhcmRMaXN0XCIgaWQ9XCJteF9Gb3J3YXJkTGlzdFwiPlxuICAgICAgICAgICAgPFNlYXJjaEJveFxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X3RleHRpbnB1dF9pY29uIG14X3RleHRpbnB1dF9zZWFyY2hcIlxuICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyPXtfdChcIlNlYXJjaCBmb3Igcm9vbXMgb3IgcGVvcGxlXCIpfVxuICAgICAgICAgICAgICAgIG9uU2VhcmNoPXtzZXRRdWVyeX1cbiAgICAgICAgICAgICAgICBhdXRvRm9jdXM9e3RydWV9XG4gICAgICAgICAgICAvPlxuICAgICAgICAgICAgPEF1dG9IaWRlU2Nyb2xsYmFyIGNsYXNzTmFtZT1cIm14X0ZvcndhcmRMaXN0X2NvbnRlbnRcIj5cbiAgICAgICAgICAgICAgICB7IHJvb21zLmxlbmd0aCA+IDAgPyAoXG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfRm9yd2FyZExpc3RfcmVzdWx0c1wiPlxuICAgICAgICAgICAgICAgICAgICAgICAgPFRydW5jYXRlZExpc3RcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnVuY2F0ZUF0PXt0cnVuY2F0ZUF0fVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZU92ZXJmbG93RWxlbWVudD17b3ZlcmZsb3dUaWxlfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldENoaWxkcmVuPXsoc3RhcnQsIGVuZCkgPT4gcm9vbXMuc2xpY2Uoc3RhcnQsIGVuZCkubWFwKHJvb20gPT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPEVudHJ5XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXk9e3Jvb20ucm9vbUlkfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcm9vbT17cm9vbX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50PXtldmVudH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdHJpeENsaWVudD17Y2xpfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25GaW5pc2hlZD17b25GaW5pc2hlZH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLz4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZXRDaGlsZENvdW50PXsoKSA9PiByb29tcy5sZW5ndGh9XG4gICAgICAgICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICApIDogPHNwYW4gY2xhc3NOYW1lPVwibXhfRm9yd2FyZExpc3Rfbm9SZXN1bHRzXCI+XG4gICAgICAgICAgICAgICAgICAgIHsgX3QoXCJObyByZXN1bHRzXCIpIH1cbiAgICAgICAgICAgICAgICA8L3NwYW4+IH1cbiAgICAgICAgICAgIDwvQXV0b0hpZGVTY3JvbGxiYXI+XG4gICAgICAgIDwvZGl2PlxuICAgIDwvQmFzZURpYWxvZz47XG59O1xuXG5leHBvcnQgZGVmYXVsdCBGb3J3YXJkRGlhbG9nO1xuIl19