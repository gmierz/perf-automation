"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _Analytics = _interopRequireDefault(require("../../../Analytics"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var Lifecycle = _interopRequireWildcard(require("../../../Lifecycle"));

var _languageHandler = require("../../../languageHandler");

var _InteractiveAuth = _interopRequireWildcard(require("../../structures/InteractiveAuth"));

var _InteractiveAuthEntryComponents = require("../auth/InteractiveAuthEntryComponents");

var _StyledCheckbox = _interopRequireDefault(require("../elements/StyledCheckbox"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _BaseDialog = _interopRequireDefault(require("./BaseDialog"));

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

let DeactivateAccountDialog = (_dec = (0, _replaceableComponent.replaceableComponent)("views.dialogs.DeactivateAccountDialog"), _dec(_class = class DeactivateAccountDialog extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onStagePhaseChange", (stage, phase) => {
      const dialogAesthetics = {
        [_InteractiveAuthEntryComponents.SSOAuthEntry.PHASE_PREAUTH]: {
          body: (0, _languageHandler._t)("Confirm your account deactivation by using Single Sign On to prove your identity."),
          continueText: (0, _languageHandler._t)("Single Sign On"),
          continueKind: "danger"
        },
        [_InteractiveAuthEntryComponents.SSOAuthEntry.PHASE_POSTAUTH]: {
          body: (0, _languageHandler._t)("Are you sure you want to deactivate your account? This is irreversible."),
          continueText: (0, _languageHandler._t)("Confirm account deactivation"),
          continueKind: "danger"
        }
      }; // This is the same as aestheticsForStagePhases in InteractiveAuthDialog minus the `title`

      const DEACTIVATE_AESTHETICS = {
        [_InteractiveAuthEntryComponents.SSOAuthEntry.LOGIN_TYPE]: dialogAesthetics,
        [_InteractiveAuthEntryComponents.SSOAuthEntry.UNSTABLE_LOGIN_TYPE]: dialogAesthetics,
        [_InteractiveAuthEntryComponents.PasswordAuthEntry.LOGIN_TYPE]: {
          [_InteractiveAuthEntryComponents.DEFAULT_PHASE]: {
            body: (0, _languageHandler._t)("To continue, please enter your password:")
          }
        }
      };
      const aesthetics = DEACTIVATE_AESTHETICS[stage];
      let bodyText = null;
      let continueText = null;
      let continueKind = null;

      if (aesthetics) {
        const phaseAesthetics = aesthetics[phase];
        if (phaseAesthetics && phaseAesthetics.body) bodyText = phaseAesthetics.body;
        if (phaseAesthetics && phaseAesthetics.continueText) continueText = phaseAesthetics.continueText;
        if (phaseAesthetics && phaseAesthetics.continueKind) continueKind = phaseAesthetics.continueKind;
      }

      this.setState({
        bodyText,
        continueText,
        continueKind
      });
    });
    (0, _defineProperty2.default)(this, "onUIAuthFinished", (success, result) => {
      if (success) return; // great! makeRequest() will be called too.

      if (result === _InteractiveAuth.ERROR_USER_CANCELLED) {
        this.onCancel();
        return;
      }

      _logger.logger.error("Error during UI Auth:", {
        result
      });

      this.setState({
        errStr: (0, _languageHandler._t)("There was a problem communicating with the server. Please try again.")
      });
    });
    (0, _defineProperty2.default)(this, "onUIAuthComplete", auth => {
      // XXX: this should be returning a promise to maintain the state inside the state machine correct
      // but given that a deactivation is followed by a local logout and all object instances being thrown away
      // this isn't done.
      _MatrixClientPeg.MatrixClientPeg.get().deactivateAccount(auth, this.state.shouldErase).then(r => {
        // Deactivation worked - logout & close this dialog
        _Analytics.default.trackEvent('Account', 'Deactivate Account');

        Lifecycle.onLoggedOut();
        this.props.onFinished(true);
      }).catch(e => {
        _logger.logger.error(e);

        this.setState({
          errStr: (0, _languageHandler._t)("There was a problem communicating with the server. Please try again.")
        });
      });
    });
    (0, _defineProperty2.default)(this, "onEraseFieldChange", ev => {
      this.setState({
        shouldErase: ev.currentTarget.checked,
        // Disable the auth form because we're going to have to reinitialize the auth
        // information. We do this because we can't modify the parameters in the UIA
        // session, and the user will have selected something which changes the request.
        // Therefore, we throw away the last auth session and try a new one.
        authEnabled: false
      }); // As mentioned above, set up for auth again to get updated UIA session info

      this.initAuth(
      /* shouldErase= */
      ev.currentTarget.checked);
    });
    this.state = {
      shouldErase: false,
      errStr: null,
      authData: null,
      // for UIA
      authEnabled: true,
      // see usages for information
      // A few strings that are passed to InteractiveAuth for design or are displayed
      // next to the InteractiveAuth component.
      bodyText: null,
      continueText: null,
      continueKind: null
    };
    this.initAuth(
    /* shouldErase= */
    false);
  }

  onCancel() {
    this.props.onFinished(false);
  }

  initAuth(shouldErase) {
    _MatrixClientPeg.MatrixClientPeg.get().deactivateAccount(null, shouldErase).then(r => {
      // If we got here, oops. The server didn't require any auth.
      // Our application lifecycle will catch the error and do the logout bits.
      // We'll try to log something in an vain attempt to record what happened (storage
      // is also obliterated on logout).
      _logger.logger.warn("User's account got deactivated without confirmation: Server had no auth");

      this.setState({
        errStr: (0, _languageHandler._t)("Server did not require any authentication")
      });
    }).catch(e => {
      if (e && e.httpStatus === 401 && e.data) {
        // Valid UIA response
        this.setState({
          authData: e.data,
          authEnabled: true
        });
      } else {
        this.setState({
          errStr: (0, _languageHandler._t)("Server did not return valid authentication information.")
        });
      }
    });
  }

  render() {
    let error = null;

    if (this.state.errStr) {
      error = /*#__PURE__*/_react.default.createElement("div", {
        className: "error"
      }, this.state.errStr);
    }

    let auth = /*#__PURE__*/_react.default.createElement("div", null, (0, _languageHandler._t)("Loading..."));

    if (this.state.authData && this.state.authEnabled) {
      auth = /*#__PURE__*/_react.default.createElement("div", null, this.state.bodyText, /*#__PURE__*/_react.default.createElement(_InteractiveAuth.default, {
        matrixClient: _MatrixClientPeg.MatrixClientPeg.get(),
        authData: this.state.authData // XXX: onUIAuthComplete breaches the expected method contract, it gets away with it because it
        // knows the entire app is about to die as a result of the account deactivation.
        ,
        makeRequest: this.onUIAuthComplete,
        onAuthFinished: this.onUIAuthFinished,
        onStagePhaseChange: this.onStagePhaseChange,
        continueText: this.state.continueText,
        continueKind: this.state.continueKind
      }));
    } // this is on purpose not a <form /> to prevent Enter triggering submission, to further prevent accidents


    return /*#__PURE__*/_react.default.createElement(_BaseDialog.default, {
      className: "mx_DeactivateAccountDialog",
      onFinished: this.props.onFinished,
      titleClass: "danger",
      title: (0, _languageHandler._t)("Deactivate Account")
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_Dialog_content"
    }, /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("This will make your account permanently unusable. " + "You will not be able to log in, and no one will be able to re-register the same " + "user ID. " + "This will cause your account to leave all rooms it is participating in, and it " + "will remove your account details from your identity server. " + "<b>This action is irreversible.</b>", {}, {
      b: sub => /*#__PURE__*/_react.default.createElement("b", null, " ", sub, " ")
    })), /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Deactivating your account <b>does not by default cause us to forget messages you " + "have sent.</b> " + "If you would like us to forget your messages, please tick the box below.", {}, {
      b: sub => /*#__PURE__*/_react.default.createElement("b", null, " ", sub, " ")
    })), /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Message visibility in Matrix is similar to email. " + "Our forgetting your messages means that messages you have sent will not be shared " + "with any new or unregistered users, but registered users who already have access " + "to these messages will still have access to their copy.")), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_DeactivateAccountDialog_input_section"
    }, /*#__PURE__*/_react.default.createElement("p", null, /*#__PURE__*/_react.default.createElement(_StyledCheckbox.default, {
      checked: this.state.shouldErase,
      onChange: this.onEraseFieldChange
    }, (0, _languageHandler._t)("Please forget all messages I have sent when my account is deactivated " + "(<b>Warning:</b> this will cause future users to see an incomplete view " + "of conversations)", {}, {
      b: sub => /*#__PURE__*/_react.default.createElement("b", null, sub)
    }))), error, auth)));
  }

}) || _class);
exports.default = DeactivateAccountDialog;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvRGVhY3RpdmF0ZUFjY291bnREaWFsb2cudHN4Il0sIm5hbWVzIjpbIkRlYWN0aXZhdGVBY2NvdW50RGlhbG9nIiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwic3RhZ2UiLCJwaGFzZSIsImRpYWxvZ0Flc3RoZXRpY3MiLCJTU09BdXRoRW50cnkiLCJQSEFTRV9QUkVBVVRIIiwiYm9keSIsImNvbnRpbnVlVGV4dCIsImNvbnRpbnVlS2luZCIsIlBIQVNFX1BPU1RBVVRIIiwiREVBQ1RJVkFURV9BRVNUSEVUSUNTIiwiTE9HSU5fVFlQRSIsIlVOU1RBQkxFX0xPR0lOX1RZUEUiLCJQYXNzd29yZEF1dGhFbnRyeSIsIkRFRkFVTFRfUEhBU0UiLCJhZXN0aGV0aWNzIiwiYm9keVRleHQiLCJwaGFzZUFlc3RoZXRpY3MiLCJzZXRTdGF0ZSIsInN1Y2Nlc3MiLCJyZXN1bHQiLCJFUlJPUl9VU0VSX0NBTkNFTExFRCIsIm9uQ2FuY2VsIiwibG9nZ2VyIiwiZXJyb3IiLCJlcnJTdHIiLCJhdXRoIiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0IiwiZGVhY3RpdmF0ZUFjY291bnQiLCJzdGF0ZSIsInNob3VsZEVyYXNlIiwidGhlbiIsInIiLCJBbmFseXRpY3MiLCJ0cmFja0V2ZW50IiwiTGlmZWN5Y2xlIiwib25Mb2dnZWRPdXQiLCJvbkZpbmlzaGVkIiwiY2F0Y2giLCJlIiwiZXYiLCJjdXJyZW50VGFyZ2V0IiwiY2hlY2tlZCIsImF1dGhFbmFibGVkIiwiaW5pdEF1dGgiLCJhdXRoRGF0YSIsIndhcm4iLCJodHRwU3RhdHVzIiwiZGF0YSIsInJlbmRlciIsIm9uVUlBdXRoQ29tcGxldGUiLCJvblVJQXV0aEZpbmlzaGVkIiwib25TdGFnZVBoYXNlQ2hhbmdlIiwiYiIsInN1YiIsIm9uRXJhc2VGaWVsZENoYW5nZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFp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Q0UsMkVBQ0EsMEVBREEsR0FFQSxtQkFIRixFQUlFLEVBSkYsRUFLRTtBQUFFRixNQUFBQSxDQUFDLEVBQUdDLEdBQUQsaUJBQVMsd0NBQUtBLEdBQUw7QUFBZCxLQUxGLENBSk4sQ0FESixDQURKLEVBZ0JNL0IsS0FoQk4sRUFpQk1FLElBakJOLENBM0JKLENBTEosQ0FESjtBQXdESDs7QUEvTWdGLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTYgT3Blbk1hcmtldCBMdGRcbkNvcHlyaWdodCAyMDE5LCAyMDIwIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IEF1dGhUeXBlLCBJQXV0aERhdGEgfSBmcm9tICdtYXRyaXgtanMtc2RrL3NyYy9pbnRlcmFjdGl2ZS1hdXRoJztcblxuaW1wb3J0IEFuYWx5dGljcyBmcm9tICcuLi8uLi8uLi9BbmFseXRpY3MnO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSAnLi4vLi4vLi4vTWF0cml4Q2xpZW50UGVnJztcbmltcG9ydCAqIGFzIExpZmVjeWNsZSBmcm9tICcuLi8uLi8uLi9MaWZlY3ljbGUnO1xuaW1wb3J0IHsgX3QgfSBmcm9tICcuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXInO1xuaW1wb3J0IEludGVyYWN0aXZlQXV0aCwgeyBFUlJPUl9VU0VSX0NBTkNFTExFRCB9IGZyb20gXCIuLi8uLi9zdHJ1Y3R1cmVzL0ludGVyYWN0aXZlQXV0aFwiO1xuaW1wb3J0IHsgREVGQVVMVF9QSEFTRSwgUGFzc3dvcmRBdXRoRW50cnksIFNTT0F1dGhFbnRyeSB9IGZyb20gXCIuLi9hdXRoL0ludGVyYWN0aXZlQXV0aEVudHJ5Q29tcG9uZW50c1wiO1xuaW1wb3J0IFN0eWxlZENoZWNrYm94IGZyb20gXCIuLi9lbGVtZW50cy9TdHlsZWRDaGVja2JveFwiO1xuaW1wb3J0IHsgcmVwbGFjZWFibGVDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvcmVwbGFjZWFibGVDb21wb25lbnRcIjtcbmltcG9ydCBCYXNlRGlhbG9nIGZyb20gXCIuL0Jhc2VEaWFsb2dcIjtcblxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2xvZ2dlclwiO1xuXG5pbnRlcmZhY2UgSVByb3BzIHtcbiAgICBvbkZpbmlzaGVkOiAoc3VjY2VzczogYm9vbGVhbikgPT4gdm9pZDtcbn1cblxuaW50ZXJmYWNlIElTdGF0ZSB7XG4gICAgc2hvdWxkRXJhc2U6IGJvb2xlYW47XG4gICAgZXJyU3RyOiBzdHJpbmc7XG4gICAgYXV0aERhdGE6IGFueTsgLy8gZm9yIFVJQVxuICAgIGF1dGhFbmFibGVkOiBib29sZWFuOyAvLyBzZWUgdXNhZ2VzIGZvciBpbmZvcm1hdGlvblxuXG4gICAgLy8gQSBmZXcgc3RyaW5ncyB0aGF0IGFyZSBwYXNzZWQgdG8gSW50ZXJhY3RpdmVBdXRoIGZvciBkZXNpZ24gb3IgYXJlIGRpc3BsYXllZFxuICAgIC8vIG5leHQgdG8gdGhlIEludGVyYWN0aXZlQXV0aCBjb21wb25lbnQuXG4gICAgYm9keVRleHQ6IHN0cmluZztcbiAgICBjb250aW51ZVRleHQ6IHN0cmluZztcbiAgICBjb250aW51ZUtpbmQ6IHN0cmluZztcbn1cblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3MuZGlhbG9ncy5EZWFjdGl2YXRlQWNjb3VudERpYWxvZ1wiKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRGVhY3RpdmF0ZUFjY291bnREaWFsb2cgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8SVByb3BzLCBJU3RhdGU+IHtcbiAgICBjb25zdHJ1Y3Rvcihwcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG5cbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIHNob3VsZEVyYXNlOiBmYWxzZSxcbiAgICAgICAgICAgIGVyclN0cjogbnVsbCxcbiAgICAgICAgICAgIGF1dGhEYXRhOiBudWxsLCAvLyBmb3IgVUlBXG4gICAgICAgICAgICBhdXRoRW5hYmxlZDogdHJ1ZSwgLy8gc2VlIHVzYWdlcyBmb3IgaW5mb3JtYXRpb25cblxuICAgICAgICAgICAgLy8gQSBmZXcgc3RyaW5ncyB0aGF0IGFyZSBwYXNzZWQgdG8gSW50ZXJhY3RpdmVBdXRoIGZvciBkZXNpZ24gb3IgYXJlIGRpc3BsYXllZFxuICAgICAgICAgICAgLy8gbmV4dCB0byB0aGUgSW50ZXJhY3RpdmVBdXRoIGNvbXBvbmVudC5cbiAgICAgICAgICAgIGJvZHlUZXh0OiBudWxsLFxuICAgICAgICAgICAgY29udGludWVUZXh0OiBudWxsLFxuICAgICAgICAgICAgY29udGludWVLaW5kOiBudWxsLFxuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMuaW5pdEF1dGgoLyogc2hvdWxkRXJhc2U9ICovZmFsc2UpO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25TdGFnZVBoYXNlQ2hhbmdlID0gKHN0YWdlOiBBdXRoVHlwZSwgcGhhc2U6IHN0cmluZyk6IHZvaWQgPT4ge1xuICAgICAgICBjb25zdCBkaWFsb2dBZXN0aGV0aWNzID0ge1xuICAgICAgICAgICAgW1NTT0F1dGhFbnRyeS5QSEFTRV9QUkVBVVRIXToge1xuICAgICAgICAgICAgICAgIGJvZHk6IF90KFwiQ29uZmlybSB5b3VyIGFjY291bnQgZGVhY3RpdmF0aW9uIGJ5IHVzaW5nIFNpbmdsZSBTaWduIE9uIHRvIHByb3ZlIHlvdXIgaWRlbnRpdHkuXCIpLFxuICAgICAgICAgICAgICAgIGNvbnRpbnVlVGV4dDogX3QoXCJTaW5nbGUgU2lnbiBPblwiKSxcbiAgICAgICAgICAgICAgICBjb250aW51ZUtpbmQ6IFwiZGFuZ2VyXCIsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgW1NTT0F1dGhFbnRyeS5QSEFTRV9QT1NUQVVUSF06IHtcbiAgICAgICAgICAgICAgICBib2R5OiBfdChcIkFyZSB5b3Ugc3VyZSB5b3Ugd2FudCB0byBkZWFjdGl2YXRlIHlvdXIgYWNjb3VudD8gVGhpcyBpcyBpcnJldmVyc2libGUuXCIpLFxuICAgICAgICAgICAgICAgIGNvbnRpbnVlVGV4dDogX3QoXCJDb25maXJtIGFjY291bnQgZGVhY3RpdmF0aW9uXCIpLFxuICAgICAgICAgICAgICAgIGNvbnRpbnVlS2luZDogXCJkYW5nZXJcIixcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gVGhpcyBpcyB0aGUgc2FtZSBhcyBhZXN0aGV0aWNzRm9yU3RhZ2VQaGFzZXMgaW4gSW50ZXJhY3RpdmVBdXRoRGlhbG9nIG1pbnVzIHRoZSBgdGl0bGVgXG4gICAgICAgIGNvbnN0IERFQUNUSVZBVEVfQUVTVEhFVElDUyA9IHtcbiAgICAgICAgICAgIFtTU09BdXRoRW50cnkuTE9HSU5fVFlQRV06IGRpYWxvZ0Flc3RoZXRpY3MsXG4gICAgICAgICAgICBbU1NPQXV0aEVudHJ5LlVOU1RBQkxFX0xPR0lOX1RZUEVdOiBkaWFsb2dBZXN0aGV0aWNzLFxuICAgICAgICAgICAgW1Bhc3N3b3JkQXV0aEVudHJ5LkxPR0lOX1RZUEVdOiB7XG4gICAgICAgICAgICAgICAgW0RFRkFVTFRfUEhBU0VdOiB7XG4gICAgICAgICAgICAgICAgICAgIGJvZHk6IF90KFwiVG8gY29udGludWUsIHBsZWFzZSBlbnRlciB5b3VyIHBhc3N3b3JkOlwiKSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBhZXN0aGV0aWNzID0gREVBQ1RJVkFURV9BRVNUSEVUSUNTW3N0YWdlXTtcbiAgICAgICAgbGV0IGJvZHlUZXh0ID0gbnVsbDtcbiAgICAgICAgbGV0IGNvbnRpbnVlVGV4dCA9IG51bGw7XG4gICAgICAgIGxldCBjb250aW51ZUtpbmQgPSBudWxsO1xuICAgICAgICBpZiAoYWVzdGhldGljcykge1xuICAgICAgICAgICAgY29uc3QgcGhhc2VBZXN0aGV0aWNzID0gYWVzdGhldGljc1twaGFzZV07XG4gICAgICAgICAgICBpZiAocGhhc2VBZXN0aGV0aWNzICYmIHBoYXNlQWVzdGhldGljcy5ib2R5KSBib2R5VGV4dCA9IHBoYXNlQWVzdGhldGljcy5ib2R5O1xuICAgICAgICAgICAgaWYgKHBoYXNlQWVzdGhldGljcyAmJiBwaGFzZUFlc3RoZXRpY3MuY29udGludWVUZXh0KSBjb250aW51ZVRleHQgPSBwaGFzZUFlc3RoZXRpY3MuY29udGludWVUZXh0O1xuICAgICAgICAgICAgaWYgKHBoYXNlQWVzdGhldGljcyAmJiBwaGFzZUFlc3RoZXRpY3MuY29udGludWVLaW5kKSBjb250aW51ZUtpbmQgPSBwaGFzZUFlc3RoZXRpY3MuY29udGludWVLaW5kO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBib2R5VGV4dCwgY29udGludWVUZXh0LCBjb250aW51ZUtpbmQgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25VSUF1dGhGaW5pc2hlZCA9IChzdWNjZXNzOiBib29sZWFuLCByZXN1bHQ6IEVycm9yKSA9PiB7XG4gICAgICAgIGlmIChzdWNjZXNzKSByZXR1cm47IC8vIGdyZWF0ISBtYWtlUmVxdWVzdCgpIHdpbGwgYmUgY2FsbGVkIHRvby5cblxuICAgICAgICBpZiAocmVzdWx0ID09PSBFUlJPUl9VU0VSX0NBTkNFTExFRCkge1xuICAgICAgICAgICAgdGhpcy5vbkNhbmNlbCgpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgbG9nZ2VyLmVycm9yKFwiRXJyb3IgZHVyaW5nIFVJIEF1dGg6XCIsIHsgcmVzdWx0IH0pO1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgZXJyU3RyOiBfdChcIlRoZXJlIHdhcyBhIHByb2JsZW0gY29tbXVuaWNhdGluZyB3aXRoIHRoZSBzZXJ2ZXIuIFBsZWFzZSB0cnkgYWdhaW4uXCIpIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uVUlBdXRoQ29tcGxldGUgPSAoYXV0aDogSUF1dGhEYXRhKTogdm9pZCA9PiB7XG4gICAgICAgIC8vIFhYWDogdGhpcyBzaG91bGQgYmUgcmV0dXJuaW5nIGEgcHJvbWlzZSB0byBtYWludGFpbiB0aGUgc3RhdGUgaW5zaWRlIHRoZSBzdGF0ZSBtYWNoaW5lIGNvcnJlY3RcbiAgICAgICAgLy8gYnV0IGdpdmVuIHRoYXQgYSBkZWFjdGl2YXRpb24gaXMgZm9sbG93ZWQgYnkgYSBsb2NhbCBsb2dvdXQgYW5kIGFsbCBvYmplY3QgaW5zdGFuY2VzIGJlaW5nIHRocm93biBhd2F5XG4gICAgICAgIC8vIHRoaXMgaXNuJ3QgZG9uZS5cbiAgICAgICAgTWF0cml4Q2xpZW50UGVnLmdldCgpLmRlYWN0aXZhdGVBY2NvdW50KGF1dGgsIHRoaXMuc3RhdGUuc2hvdWxkRXJhc2UpLnRoZW4ociA9PiB7XG4gICAgICAgICAgICAvLyBEZWFjdGl2YXRpb24gd29ya2VkIC0gbG9nb3V0ICYgY2xvc2UgdGhpcyBkaWFsb2dcbiAgICAgICAgICAgIEFuYWx5dGljcy50cmFja0V2ZW50KCdBY2NvdW50JywgJ0RlYWN0aXZhdGUgQWNjb3VudCcpO1xuICAgICAgICAgICAgTGlmZWN5Y2xlLm9uTG9nZ2VkT3V0KCk7XG4gICAgICAgICAgICB0aGlzLnByb3BzLm9uRmluaXNoZWQodHJ1ZSk7XG4gICAgICAgIH0pLmNhdGNoKGUgPT4ge1xuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGUpO1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGVyclN0cjogX3QoXCJUaGVyZSB3YXMgYSBwcm9ibGVtIGNvbW11bmljYXRpbmcgd2l0aCB0aGUgc2VydmVyLiBQbGVhc2UgdHJ5IGFnYWluLlwiKSB9KTtcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25FcmFzZUZpZWxkQ2hhbmdlID0gKGV2OiBSZWFjdC5Gb3JtRXZlbnQ8SFRNTElucHV0RWxlbWVudD4pOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBzaG91bGRFcmFzZTogZXYuY3VycmVudFRhcmdldC5jaGVja2VkLFxuXG4gICAgICAgICAgICAvLyBEaXNhYmxlIHRoZSBhdXRoIGZvcm0gYmVjYXVzZSB3ZSdyZSBnb2luZyB0byBoYXZlIHRvIHJlaW5pdGlhbGl6ZSB0aGUgYXV0aFxuICAgICAgICAgICAgLy8gaW5mb3JtYXRpb24uIFdlIGRvIHRoaXMgYmVjYXVzZSB3ZSBjYW4ndCBtb2RpZnkgdGhlIHBhcmFtZXRlcnMgaW4gdGhlIFVJQVxuICAgICAgICAgICAgLy8gc2Vzc2lvbiwgYW5kIHRoZSB1c2VyIHdpbGwgaGF2ZSBzZWxlY3RlZCBzb21ldGhpbmcgd2hpY2ggY2hhbmdlcyB0aGUgcmVxdWVzdC5cbiAgICAgICAgICAgIC8vIFRoZXJlZm9yZSwgd2UgdGhyb3cgYXdheSB0aGUgbGFzdCBhdXRoIHNlc3Npb24gYW5kIHRyeSBhIG5ldyBvbmUuXG4gICAgICAgICAgICBhdXRoRW5hYmxlZDogZmFsc2UsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIEFzIG1lbnRpb25lZCBhYm92ZSwgc2V0IHVwIGZvciBhdXRoIGFnYWluIHRvIGdldCB1cGRhdGVkIFVJQSBzZXNzaW9uIGluZm9cbiAgICAgICAgdGhpcy5pbml0QXV0aCgvKiBzaG91bGRFcmFzZT0gKi9ldi5jdXJyZW50VGFyZ2V0LmNoZWNrZWQpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uQ2FuY2VsKCk6IHZvaWQge1xuICAgICAgICB0aGlzLnByb3BzLm9uRmluaXNoZWQoZmFsc2UpO1xuICAgIH1cblxuICAgIHByaXZhdGUgaW5pdEF1dGgoc2hvdWxkRXJhc2U6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICAgICAgTWF0cml4Q2xpZW50UGVnLmdldCgpLmRlYWN0aXZhdGVBY2NvdW50KG51bGwsIHNob3VsZEVyYXNlKS50aGVuKHIgPT4ge1xuICAgICAgICAgICAgLy8gSWYgd2UgZ290IGhlcmUsIG9vcHMuIFRoZSBzZXJ2ZXIgZGlkbid0IHJlcXVpcmUgYW55IGF1dGguXG4gICAgICAgICAgICAvLyBPdXIgYXBwbGljYXRpb24gbGlmZWN5Y2xlIHdpbGwgY2F0Y2ggdGhlIGVycm9yIGFuZCBkbyB0aGUgbG9nb3V0IGJpdHMuXG4gICAgICAgICAgICAvLyBXZSdsbCB0cnkgdG8gbG9nIHNvbWV0aGluZyBpbiBhbiB2YWluIGF0dGVtcHQgdG8gcmVjb3JkIHdoYXQgaGFwcGVuZWQgKHN0b3JhZ2VcbiAgICAgICAgICAgIC8vIGlzIGFsc28gb2JsaXRlcmF0ZWQgb24gbG9nb3V0KS5cbiAgICAgICAgICAgIGxvZ2dlci53YXJuKFwiVXNlcidzIGFjY291bnQgZ290IGRlYWN0aXZhdGVkIHdpdGhvdXQgY29uZmlybWF0aW9uOiBTZXJ2ZXIgaGFkIG5vIGF1dGhcIik7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgZXJyU3RyOiBfdChcIlNlcnZlciBkaWQgbm90IHJlcXVpcmUgYW55IGF1dGhlbnRpY2F0aW9uXCIpIH0pO1xuICAgICAgICB9KS5jYXRjaChlID0+IHtcbiAgICAgICAgICAgIGlmIChlICYmIGUuaHR0cFN0YXR1cyA9PT0gNDAxICYmIGUuZGF0YSkge1xuICAgICAgICAgICAgICAgIC8vIFZhbGlkIFVJQSByZXNwb25zZVxuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBhdXRoRGF0YTogZS5kYXRhLCBhdXRoRW5hYmxlZDogdHJ1ZSB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGVyclN0cjogX3QoXCJTZXJ2ZXIgZGlkIG5vdCByZXR1cm4gdmFsaWQgYXV0aGVudGljYXRpb24gaW5mb3JtYXRpb24uXCIpIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVuZGVyKCkge1xuICAgICAgICBsZXQgZXJyb3IgPSBudWxsO1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5lcnJTdHIpIHtcbiAgICAgICAgICAgIGVycm9yID0gPGRpdiBjbGFzc05hbWU9XCJlcnJvclwiPlxuICAgICAgICAgICAgICAgIHsgdGhpcy5zdGF0ZS5lcnJTdHIgfVxuICAgICAgICAgICAgPC9kaXY+O1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGF1dGggPSA8ZGl2PnsgX3QoXCJMb2FkaW5nLi4uXCIpIH08L2Rpdj47XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLmF1dGhEYXRhICYmIHRoaXMuc3RhdGUuYXV0aEVuYWJsZWQpIHtcbiAgICAgICAgICAgIGF1dGggPSAoXG4gICAgICAgICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgICAgICAgICAgeyB0aGlzLnN0YXRlLmJvZHlUZXh0IH1cbiAgICAgICAgICAgICAgICAgICAgPEludGVyYWN0aXZlQXV0aFxuICAgICAgICAgICAgICAgICAgICAgICAgbWF0cml4Q2xpZW50PXtNYXRyaXhDbGllbnRQZWcuZ2V0KCl9XG4gICAgICAgICAgICAgICAgICAgICAgICBhdXRoRGF0YT17dGhpcy5zdGF0ZS5hdXRoRGF0YX1cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFhYWDogb25VSUF1dGhDb21wbGV0ZSBicmVhY2hlcyB0aGUgZXhwZWN0ZWQgbWV0aG9kIGNvbnRyYWN0LCBpdCBnZXRzIGF3YXkgd2l0aCBpdCBiZWNhdXNlIGl0XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBrbm93cyB0aGUgZW50aXJlIGFwcCBpcyBhYm91dCB0byBkaWUgYXMgYSByZXN1bHQgb2YgdGhlIGFjY291bnQgZGVhY3RpdmF0aW9uLlxuICAgICAgICAgICAgICAgICAgICAgICAgbWFrZVJlcXVlc3Q9e3RoaXMub25VSUF1dGhDb21wbGV0ZSBhcyBhbnl9XG4gICAgICAgICAgICAgICAgICAgICAgICBvbkF1dGhGaW5pc2hlZD17dGhpcy5vblVJQXV0aEZpbmlzaGVkfVxuICAgICAgICAgICAgICAgICAgICAgICAgb25TdGFnZVBoYXNlQ2hhbmdlPXt0aGlzLm9uU3RhZ2VQaGFzZUNoYW5nZX1cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlVGV4dD17dGhpcy5zdGF0ZS5jb250aW51ZVRleHR9XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZUtpbmQ9e3RoaXMuc3RhdGUuY29udGludWVLaW5kfVxuICAgICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHRoaXMgaXMgb24gcHVycG9zZSBub3QgYSA8Zm9ybSAvPiB0byBwcmV2ZW50IEVudGVyIHRyaWdnZXJpbmcgc3VibWlzc2lvbiwgdG8gZnVydGhlciBwcmV2ZW50IGFjY2lkZW50c1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPEJhc2VEaWFsb2cgY2xhc3NOYW1lPVwibXhfRGVhY3RpdmF0ZUFjY291bnREaWFsb2dcIlxuICAgICAgICAgICAgICAgIG9uRmluaXNoZWQ9e3RoaXMucHJvcHMub25GaW5pc2hlZH1cbiAgICAgICAgICAgICAgICB0aXRsZUNsYXNzPVwiZGFuZ2VyXCJcbiAgICAgICAgICAgICAgICB0aXRsZT17X3QoXCJEZWFjdGl2YXRlIEFjY291bnRcIil9XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9EaWFsb2dfY29udGVudFwiPlxuICAgICAgICAgICAgICAgICAgICA8cD57IF90KFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJUaGlzIHdpbGwgbWFrZSB5b3VyIGFjY291bnQgcGVybWFuZW50bHkgdW51c2FibGUuIFwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiWW91IHdpbGwgbm90IGJlIGFibGUgdG8gbG9nIGluLCBhbmQgbm8gb25lIHdpbGwgYmUgYWJsZSB0byByZS1yZWdpc3RlciB0aGUgc2FtZSBcIiArXG4gICAgICAgICAgICAgICAgICAgICAgICBcInVzZXIgSUQuIFwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiVGhpcyB3aWxsIGNhdXNlIHlvdXIgYWNjb3VudCB0byBsZWF2ZSBhbGwgcm9vbXMgaXQgaXMgcGFydGljaXBhdGluZyBpbiwgYW5kIGl0IFwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwid2lsbCByZW1vdmUgeW91ciBhY2NvdW50IGRldGFpbHMgZnJvbSB5b3VyIGlkZW50aXR5IHNlcnZlci4gXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgXCI8Yj5UaGlzIGFjdGlvbiBpcyBpcnJldmVyc2libGUuPC9iPlwiLFxuICAgICAgICAgICAgICAgICAgICAgICAge30sXG4gICAgICAgICAgICAgICAgICAgICAgICB7IGI6IChzdWIpID0+IDxiPiB7IHN1YiB9IDwvYj4gfSxcbiAgICAgICAgICAgICAgICAgICAgKSB9PC9wPlxuXG4gICAgICAgICAgICAgICAgICAgIDxwPnsgX3QoXG4gICAgICAgICAgICAgICAgICAgICAgICBcIkRlYWN0aXZhdGluZyB5b3VyIGFjY291bnQgPGI+ZG9lcyBub3QgYnkgZGVmYXVsdCBjYXVzZSB1cyB0byBmb3JnZXQgbWVzc2FnZXMgeW91IFwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiaGF2ZSBzZW50LjwvYj4gXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJJZiB5b3Ugd291bGQgbGlrZSB1cyB0byBmb3JnZXQgeW91ciBtZXNzYWdlcywgcGxlYXNlIHRpY2sgdGhlIGJveCBiZWxvdy5cIixcbiAgICAgICAgICAgICAgICAgICAgICAgIHt9LFxuICAgICAgICAgICAgICAgICAgICAgICAgeyBiOiAoc3ViKSA9PiA8Yj4geyBzdWIgfSA8L2I+IH0sXG4gICAgICAgICAgICAgICAgICAgICkgfTwvcD5cblxuICAgICAgICAgICAgICAgICAgICA8cD57IF90KFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJNZXNzYWdlIHZpc2liaWxpdHkgaW4gTWF0cml4IGlzIHNpbWlsYXIgdG8gZW1haWwuIFwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiT3VyIGZvcmdldHRpbmcgeW91ciBtZXNzYWdlcyBtZWFucyB0aGF0IG1lc3NhZ2VzIHlvdSBoYXZlIHNlbnQgd2lsbCBub3QgYmUgc2hhcmVkIFwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwid2l0aCBhbnkgbmV3IG9yIHVucmVnaXN0ZXJlZCB1c2VycywgYnV0IHJlZ2lzdGVyZWQgdXNlcnMgd2hvIGFscmVhZHkgaGF2ZSBhY2Nlc3MgXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJ0byB0aGVzZSBtZXNzYWdlcyB3aWxsIHN0aWxsIGhhdmUgYWNjZXNzIHRvIHRoZWlyIGNvcHkuXCIsXG4gICAgICAgICAgICAgICAgICAgICkgfTwvcD5cblxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0RlYWN0aXZhdGVBY2NvdW50RGlhbG9nX2lucHV0X3NlY3Rpb25cIj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxwPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxTdHlsZWRDaGVja2JveFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGVja2VkPXt0aGlzLnN0YXRlLnNob3VsZEVyYXNlfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZT17dGhpcy5vbkVyYXNlRmllbGRDaGFuZ2V9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IF90KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJQbGVhc2UgZm9yZ2V0IGFsbCBtZXNzYWdlcyBJIGhhdmUgc2VudCB3aGVuIG15IGFjY291bnQgaXMgZGVhY3RpdmF0ZWQgXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCIoPGI+V2FybmluZzo8L2I+IHRoaXMgd2lsbCBjYXVzZSBmdXR1cmUgdXNlcnMgdG8gc2VlIGFuIGluY29tcGxldGUgdmlldyBcIiArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIm9mIGNvbnZlcnNhdGlvbnMpXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7fSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgYjogKHN1YikgPT4gPGI+eyBzdWIgfTwvYj4gfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9TdHlsZWRDaGVja2JveD5cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvcD5cblxuICAgICAgICAgICAgICAgICAgICAgICAgeyBlcnJvciB9XG4gICAgICAgICAgICAgICAgICAgICAgICB7IGF1dGggfVxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cblxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgPC9CYXNlRGlhbG9nPlxuICAgICAgICApO1xuICAgIH1cbn1cbiJdfQ==