"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var React = _interopRequireWildcard(require("react"));

var _BaseDialog = _interopRequireDefault(require("./BaseDialog"));

var _languageHandler = require("../../../languageHandler");

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _matrixWidgetApi = require("matrix-widget-api");

var _StopGapWidgetDriver = require("../../../stores/widgets/StopGapWidgetDriver");

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _OwnProfileStore = require("../../../stores/OwnProfileStore");

var _arrays = require("../../../utils/arrays");

var _StopGapWidget = require("../../../stores/widgets/StopGapWidget");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _identifiers = require("../../../identifiers");

var _SettingsStore = _interopRequireDefault(require("../../../settings/SettingsStore"));

var _dec, _class;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

const MAX_BUTTONS = 3;
let ModalWidgetDialog = (_dec = (0, _replaceableComponent.replaceableComponent)("views.dialogs.ModalWidgetDialog"), _dec(_class = class ModalWidgetDialog extends React.PureComponent {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "widget", void 0);
    (0, _defineProperty2.default)(this, "possibleButtons", void 0);
    (0, _defineProperty2.default)(this, "appFrame", /*#__PURE__*/React.createRef());
    (0, _defineProperty2.default)(this, "state", {
      disabledButtonIds: (this.props.widgetDefinition.buttons || []).filter(b => b.disabled).map(b => b.id)
    });
    (0, _defineProperty2.default)(this, "onReady", () => {
      this.state.messaging.sendWidgetConfig(this.props.widgetDefinition);
    });
    (0, _defineProperty2.default)(this, "onLoad", () => {
      this.state.messaging.once("ready", this.onReady);
      this.state.messaging.on(`action:${_matrixWidgetApi.WidgetApiFromWidgetAction.CloseModalWidget}`, this.onWidgetClose);
      this.state.messaging.on(`action:${_matrixWidgetApi.WidgetApiFromWidgetAction.SetModalButtonEnabled}`, this.onButtonEnableToggle);
    });
    (0, _defineProperty2.default)(this, "onWidgetClose", ev => {
      this.props.onFinished(true, ev.detail.data);
    });
    (0, _defineProperty2.default)(this, "onButtonEnableToggle", ev => {
      ev.preventDefault();
      const isClose = ev.detail.data.button === _matrixWidgetApi.BuiltInModalButtonID.Close;

      if (isClose || !this.possibleButtons.includes(ev.detail.data.button)) {
        return this.state.messaging.transport.reply(ev.detail, {
          error: {
            message: "Invalid button"
          }
        });
      }

      let buttonIds;

      if (ev.detail.data.enabled) {
        buttonIds = (0, _arrays.arrayFastClone)(this.state.disabledButtonIds).filter(i => i !== ev.detail.data.button);
      } else {
        // use a set to swap the operation to avoid memory leaky arrays.
        const tempSet = new Set(this.state.disabledButtonIds);
        tempSet.add(ev.detail.data.button);
        buttonIds = Array.from(tempSet);
      }

      this.setState({
        disabledButtonIds: buttonIds
      });
      this.state.messaging.transport.reply(ev.detail, {});
    });
    this.widget = new _StopGapWidget.ElementWidget(_objectSpread(_objectSpread({}, this.props.widgetDefinition), {}, {
      creatorUserId: _MatrixClientPeg.MatrixClientPeg.get().getUserId(),
      id: `modal_${this.props.sourceWidgetId}`
    }));
    this.possibleButtons = (this.props.widgetDefinition.buttons || []).map(b => b.id);
  }

  componentDidMount() {
    const driver = new _StopGapWidgetDriver.StopGapWidgetDriver([], this.widget, _matrixWidgetApi.WidgetKind.Modal);
    const messaging = new _matrixWidgetApi.ClientWidgetApi(this.widget, this.appFrame.current, driver);
    this.setState({
      messaging
    });
  }

  componentWillUnmount() {
    this.state.messaging.off("ready", this.onReady);
    this.state.messaging.off(`action:${_matrixWidgetApi.WidgetApiFromWidgetAction.CloseModalWidget}`, this.onWidgetClose);
    this.state.messaging.stop();
  }

  render() {
    const templated = this.widget.getCompleteUrl({
      widgetRoomId: this.props.widgetRoomId,
      currentUserId: _MatrixClientPeg.MatrixClientPeg.get().getUserId(),
      userDisplayName: _OwnProfileStore.OwnProfileStore.instance.displayName,
      userHttpAvatarUrl: _OwnProfileStore.OwnProfileStore.instance.getHttpAvatarUrl(),
      clientId: _identifiers.ELEMENT_CLIENT_ID,
      clientTheme: _SettingsStore.default.getValue("theme"),
      clientLanguage: (0, _languageHandler.getUserLanguage)()
    });
    const parsed = new URL(templated); // Add in some legacy support sprinkles (for non-popout widgets)
    // TODO: Replace these with proper widget params
    // See https://github.com/matrix-org/matrix-doc/pull/1958/files#r405714833

    parsed.searchParams.set('widgetId', this.widget.id);
    parsed.searchParams.set('parentUrl', window.location.href.split('#', 2)[0]); // Replace the encoded dollar signs back to dollar signs. They have no special meaning
    // in HTTP, but URL parsers encode them anyways.

    const widgetUrl = parsed.toString().replace(/%24/g, '$');
    let buttons;

    if (this.props.widgetDefinition.buttons) {
      // show first button rightmost for a more natural specification
      buttons = this.props.widgetDefinition.buttons.slice(0, MAX_BUTTONS).reverse().map(def => {
        let kind = "secondary";

        switch (def.kind) {
          case _matrixWidgetApi.ModalButtonKind.Primary:
            kind = "primary";
            break;

          case _matrixWidgetApi.ModalButtonKind.Secondary:
            kind = "primary_outline";
            break;

          case _matrixWidgetApi.ModalButtonKind.Danger:
            kind = "danger";
            break;
        }

        const onClick = () => {
          this.state.messaging.notifyModalWidgetButtonClicked(def.id);
        };

        const isDisabled = this.state.disabledButtonIds.includes(def.id);
        return /*#__PURE__*/React.createElement(_AccessibleButton.default, {
          key: def.id,
          kind: kind,
          onClick: onClick,
          disabled: isDisabled
        }, def.label);
      });
    }

    return /*#__PURE__*/React.createElement(_BaseDialog.default, {
      title: this.props.widgetDefinition.name || (0, _languageHandler._t)("Modal Widget"),
      className: "mx_ModalWidgetDialog",
      contentId: "mx_Dialog_content",
      onFinished: this.props.onFinished
    }, /*#__PURE__*/React.createElement("div", {
      className: "mx_ModalWidgetDialog_warning"
    }, /*#__PURE__*/React.createElement("img", {
      src: require("../../../../res/img/element-icons/warning-badge.svg"),
      height: "16",
      width: "16",
      alt: ""
    }), (0, _languageHandler._t)("Data on this screen is shared with %(widgetDomain)s", {
      widgetDomain: parsed.hostname
    })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("iframe", {
      ref: this.appFrame,
      sandbox: "allow-forms allow-scripts allow-same-origin",
      src: widgetUrl,
      onLoad: this.onLoad
    })), /*#__PURE__*/React.createElement("div", {
      className: "mx_ModalWidgetDialog_buttons"
    }, buttons));
  }

}) || _class);
exports.default = ModalWidgetDialog;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvTW9kYWxXaWRnZXREaWFsb2cudHN4Il0sIm5hbWVzIjpbIk1BWF9CVVRUT05TIiwiTW9kYWxXaWRnZXREaWFsb2ciLCJSZWFjdCIsIlB1cmVDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwiY3JlYXRlUmVmIiwiZGlzYWJsZWRCdXR0b25JZHMiLCJ3aWRnZXREZWZpbml0aW9uIiwiYnV0dG9ucyIsImZpbHRlciIsImIiLCJkaXNhYmxlZCIsIm1hcCIsImlkIiwic3RhdGUiLCJtZXNzYWdpbmciLCJzZW5kV2lkZ2V0Q29uZmlnIiwib25jZSIsIm9uUmVhZHkiLCJvbiIsIldpZGdldEFwaUZyb21XaWRnZXRBY3Rpb24iLCJDbG9zZU1vZGFsV2lkZ2V0Iiwib25XaWRnZXRDbG9zZSIsIlNldE1vZGFsQnV0dG9uRW5hYmxlZCIsIm9uQnV0dG9uRW5hYmxlVG9nZ2xlIiwiZXYiLCJvbkZpbmlzaGVkIiwiZGV0YWlsIiwiZGF0YSIsInByZXZlbnREZWZhdWx0IiwiaXNDbG9zZSIsImJ1dHRvbiIsIkJ1aWx0SW5Nb2RhbEJ1dHRvbklEIiwiQ2xvc2UiLCJwb3NzaWJsZUJ1dHRvbnMiLCJpbmNsdWRlcyIsInRyYW5zcG9ydCIsInJlcGx5IiwiZXJyb3IiLCJtZXNzYWdlIiwiYnV0dG9uSWRzIiwiZW5hYmxlZCIsImkiLCJ0ZW1wU2V0IiwiU2V0IiwiYWRkIiwiQXJyYXkiLCJmcm9tIiwic2V0U3RhdGUiLCJ3aWRnZXQiLCJFbGVtZW50V2lkZ2V0IiwiY3JlYXRvclVzZXJJZCIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsImdldFVzZXJJZCIsInNvdXJjZVdpZGdldElkIiwiY29tcG9uZW50RGlkTW91bnQiLCJkcml2ZXIiLCJTdG9wR2FwV2lkZ2V0RHJpdmVyIiwiV2lkZ2V0S2luZCIsIk1vZGFsIiwiQ2xpZW50V2lkZ2V0QXBpIiwiYXBwRnJhbWUiLCJjdXJyZW50IiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJvZmYiLCJzdG9wIiwicmVuZGVyIiwidGVtcGxhdGVkIiwiZ2V0Q29tcGxldGVVcmwiLCJ3aWRnZXRSb29tSWQiLCJjdXJyZW50VXNlcklkIiwidXNlckRpc3BsYXlOYW1lIiwiT3duUHJvZmlsZVN0b3JlIiwiaW5zdGFuY2UiLCJkaXNwbGF5TmFtZSIsInVzZXJIdHRwQXZhdGFyVXJsIiwiZ2V0SHR0cEF2YXRhclVybCIsImNsaWVudElkIiwiRUxFTUVOVF9DTElFTlRfSUQiLCJjbGllbnRUaGVtZSIsIlNldHRpbmdzU3RvcmUiLCJnZXRWYWx1ZSIsImNsaWVudExhbmd1YWdlIiwicGFyc2VkIiwiVVJMIiwic2VhcmNoUGFyYW1zIiwic2V0Iiwid2luZG93IiwibG9jYXRpb24iLCJocmVmIiwic3BsaXQiLCJ3aWRnZXRVcmwiLCJ0b1N0cmluZyIsInJlcGxhY2UiLCJzbGljZSIsInJldmVyc2UiLCJkZWYiLCJraW5kIiwiTW9kYWxCdXR0b25LaW5kIiwiUHJpbWFyeSIsIlNlY29uZGFyeSIsIkRhbmdlciIsIm9uQ2xpY2siLCJub3RpZnlNb2RhbFdpZGdldEJ1dHRvbkNsaWNrZWQiLCJpc0Rpc2FibGVkIiwibGFiZWwiLCJuYW1lIiwicmVxdWlyZSIsIndpZGdldERvbWFpbiIsImhvc3RuYW1lIiwib25Mb2FkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWdCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFlQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7Ozs7O0FBY0EsTUFBTUEsV0FBVyxHQUFHLENBQXBCO0lBR3FCQyxpQixXQURwQixnREFBcUIsaUNBQXJCLEMsZ0JBQUQsTUFDcUJBLGlCQURyQixTQUMrQ0MsS0FBSyxDQUFDQyxhQURyRCxDQUNtRjtBQVUvRUMsRUFBQUEsV0FBVyxDQUFDQyxLQUFELEVBQVE7QUFDZixVQUFNQSxLQUFOO0FBRGU7QUFBQTtBQUFBLGlFQVBvQ0gsS0FBSyxDQUFDSSxTQUFOLEVB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R0ksTUFBQSxLQUFLLEVBQUMsSUFIVjtBQUlJLE1BQUEsR0FBRyxFQUFDO0FBSlIsTUFESixFQU9NLHlCQUFHLHFEQUFILEVBQTBEO0FBQ3hEQyxNQUFBQSxZQUFZLEVBQUV6QixNQUFNLENBQUMwQjtBQURtQyxLQUExRCxDQVBOLENBTkcsZUFpQkgsOENBQ0k7QUFDSSxNQUFBLEdBQUcsRUFBRSxLQUFLaEQsUUFEZDtBQUVJLE1BQUEsT0FBTyxFQUFDLDZDQUZaO0FBR0ksTUFBQSxHQUFHLEVBQUU4QixTQUhUO0FBSUksTUFBQSxNQUFNLEVBQUUsS0FBS21CO0FBSmpCLE1BREosQ0FqQkcsZUF5Qkg7QUFBSyxNQUFBLFNBQVMsRUFBQztBQUFmLE9BQ012RyxPQUROLENBekJHLENBQVA7QUE2Qkg7O0FBdEo4RSxDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDIwLCAyMDIxIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0ICogYXMgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IEJhc2VEaWFsb2cgZnJvbSAnLi9CYXNlRGlhbG9nJztcbmltcG9ydCB7IF90LCBnZXRVc2VyTGFuZ3VhZ2UgfSBmcm9tICcuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXInO1xuaW1wb3J0IEFjY2Vzc2libGVCdXR0b24gZnJvbSBcIi4uL2VsZW1lbnRzL0FjY2Vzc2libGVCdXR0b25cIjtcbmltcG9ydCB7XG4gICAgQ2xpZW50V2lkZ2V0QXBpLFxuICAgIElNb2RhbFdpZGdldENsb3NlUmVxdWVzdCxcbiAgICBJTW9kYWxXaWRnZXRPcGVuUmVxdWVzdERhdGEsXG4gICAgSU1vZGFsV2lkZ2V0UmV0dXJuRGF0YSxcbiAgICBJU2V0TW9kYWxCdXR0b25FbmFibGVkQWN0aW9uUmVxdWVzdCxcbiAgICBJV2lkZ2V0QXBpQWNrbm93bGVkZ2VSZXNwb25zZURhdGEsXG4gICAgSVdpZGdldEFwaUVycm9yUmVzcG9uc2VEYXRhLFxuICAgIEJ1aWx0SW5Nb2RhbEJ1dHRvbklELFxuICAgIE1vZGFsQnV0dG9uSUQsXG4gICAgTW9kYWxCdXR0b25LaW5kLFxuICAgIFdpZGdldCxcbiAgICBXaWRnZXRBcGlGcm9tV2lkZ2V0QWN0aW9uLFxuICAgIFdpZGdldEtpbmQsXG59IGZyb20gXCJtYXRyaXgtd2lkZ2V0LWFwaVwiO1xuaW1wb3J0IHsgU3RvcEdhcFdpZGdldERyaXZlciB9IGZyb20gXCIuLi8uLi8uLi9zdG9yZXMvd2lkZ2V0cy9TdG9wR2FwV2lkZ2V0RHJpdmVyXCI7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tIFwiLi4vLi4vLi4vTWF0cml4Q2xpZW50UGVnXCI7XG5pbXBvcnQgeyBPd25Qcm9maWxlU3RvcmUgfSBmcm9tIFwiLi4vLi4vLi4vc3RvcmVzL093blByb2ZpbGVTdG9yZVwiO1xuaW1wb3J0IHsgYXJyYXlGYXN0Q2xvbmUgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvYXJyYXlzXCI7XG5pbXBvcnQgeyBFbGVtZW50V2lkZ2V0IH0gZnJvbSBcIi4uLy4uLy4uL3N0b3Jlcy93aWRnZXRzL1N0b3BHYXBXaWRnZXRcIjtcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5pbXBvcnQgeyBFTEVNRU5UX0NMSUVOVF9JRCB9IGZyb20gXCIuLi8uLi8uLi9pZGVudGlmaWVyc1wiO1xuaW1wb3J0IFNldHRpbmdzU3RvcmUgZnJvbSBcIi4uLy4uLy4uL3NldHRpbmdzL1NldHRpbmdzU3RvcmVcIjtcblxuaW50ZXJmYWNlIElQcm9wcyB7XG4gICAgd2lkZ2V0RGVmaW5pdGlvbjogSU1vZGFsV2lkZ2V0T3BlblJlcXVlc3REYXRhO1xuICAgIHdpZGdldFJvb21JZD86IHN0cmluZztcbiAgICBzb3VyY2VXaWRnZXRJZDogc3RyaW5nO1xuICAgIG9uRmluaXNoZWQoc3VjY2VzczogYm9vbGVhbiwgZGF0YT86IElNb2RhbFdpZGdldFJldHVybkRhdGEpOiB2b2lkO1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBtZXNzYWdpbmc/OiBDbGllbnRXaWRnZXRBcGk7XG4gICAgZGlzYWJsZWRCdXR0b25JZHM6IE1vZGFsQnV0dG9uSURbXTtcbn1cblxuY29uc3QgTUFYX0JVVFRPTlMgPSAzO1xuXG5AcmVwbGFjZWFibGVDb21wb25lbnQoXCJ2aWV3cy5kaWFsb2dzLk1vZGFsV2lkZ2V0RGlhbG9nXCIpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBNb2RhbFdpZGdldERpYWxvZyBleHRlbmRzIFJlYWN0LlB1cmVDb21wb25lbnQ8SVByb3BzLCBJU3RhdGU+IHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHdpZGdldDogV2lkZ2V0O1xuICAgIHByaXZhdGUgcmVhZG9ubHkgcG9zc2libGVCdXR0b25zOiBNb2RhbEJ1dHRvbklEW107XG4gICAgcHJpdmF0ZSBhcHBGcmFtZTogUmVhY3QuUmVmT2JqZWN0PEhUTUxJRnJhbWVFbGVtZW50PiA9IFJlYWN0LmNyZWF0ZVJlZigpO1xuXG4gICAgc3RhdGU6IElTdGF0ZSA9IHtcbiAgICAgICAgZGlzYWJsZWRCdXR0b25JZHM6ICh0aGlzLnByb3BzLndpZGdldERlZmluaXRpb24uYnV0dG9ucyB8fCBbXSkuZmlsdGVyKGIgPT4gYi5kaXNhYmxlZClcbiAgICAgICAgICAgIC5tYXAoYiA9PiBiLmlkKSxcbiAgICB9O1xuXG4gICAgY29uc3RydWN0b3IocHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuXG4gICAgICAgIHRoaXMud2lkZ2V0ID0gbmV3IEVsZW1lbnRXaWRnZXQoe1xuICAgICAgICAgICAgLi4udGhpcy5wcm9wcy53aWRnZXREZWZpbml0aW9uLFxuICAgICAgICAgICAgY3JlYXRvclVzZXJJZDogTWF0cml4Q2xpZW50UGVnLmdldCgpLmdldFVzZXJJZCgpLFxuICAgICAgICAgICAgaWQ6IGBtb2RhbF8ke3RoaXMucHJvcHMuc291cmNlV2lkZ2V0SWR9YCxcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMucG9zc2libGVCdXR0b25zID0gKHRoaXMucHJvcHMud2lkZ2V0RGVmaW5pdGlvbi5idXR0b25zIHx8IFtdKS5tYXAoYiA9PiBiLmlkKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgICAgIGNvbnN0IGRyaXZlciA9IG5ldyBTdG9wR2FwV2lkZ2V0RHJpdmVyKCBbXSwgdGhpcy53aWRnZXQsIFdpZGdldEtpbmQuTW9kYWwpO1xuICAgICAgICBjb25zdCBtZXNzYWdpbmcgPSBuZXcgQ2xpZW50V2lkZ2V0QXBpKHRoaXMud2lkZ2V0LCB0aGlzLmFwcEZyYW1lLmN1cnJlbnQsIGRyaXZlcik7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBtZXNzYWdpbmcgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgICB0aGlzLnN0YXRlLm1lc3NhZ2luZy5vZmYoXCJyZWFkeVwiLCB0aGlzLm9uUmVhZHkpO1xuICAgICAgICB0aGlzLnN0YXRlLm1lc3NhZ2luZy5vZmYoYGFjdGlvbjoke1dpZGdldEFwaUZyb21XaWRnZXRBY3Rpb24uQ2xvc2VNb2RhbFdpZGdldH1gLCB0aGlzLm9uV2lkZ2V0Q2xvc2UpO1xuICAgICAgICB0aGlzLnN0YXRlLm1lc3NhZ2luZy5zdG9wKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvblJlYWR5ID0gKCkgPT4ge1xuICAgICAgICB0aGlzLnN0YXRlLm1lc3NhZ2luZy5zZW5kV2lkZ2V0Q29uZmlnKHRoaXMucHJvcHMud2lkZ2V0RGVmaW5pdGlvbik7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25Mb2FkID0gKCkgPT4ge1xuICAgICAgICB0aGlzLnN0YXRlLm1lc3NhZ2luZy5vbmNlKFwicmVhZHlcIiwgdGhpcy5vblJlYWR5KTtcbiAgICAgICAgdGhpcy5zdGF0ZS5tZXNzYWdpbmcub24oYGFjdGlvbjoke1dpZGdldEFwaUZyb21XaWRnZXRBY3Rpb24uQ2xvc2VNb2RhbFdpZGdldH1gLCB0aGlzLm9uV2lkZ2V0Q2xvc2UpO1xuICAgICAgICB0aGlzLnN0YXRlLm1lc3NhZ2luZy5vbihgYWN0aW9uOiR7V2lkZ2V0QXBpRnJvbVdpZGdldEFjdGlvbi5TZXRNb2RhbEJ1dHRvbkVuYWJsZWR9YCwgdGhpcy5vbkJ1dHRvbkVuYWJsZVRvZ2dsZSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25XaWRnZXRDbG9zZSA9IChldjogQ3VzdG9tRXZlbnQ8SU1vZGFsV2lkZ2V0Q2xvc2VSZXF1ZXN0PikgPT4ge1xuICAgICAgICB0aGlzLnByb3BzLm9uRmluaXNoZWQodHJ1ZSwgZXYuZGV0YWlsLmRhdGEpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uQnV0dG9uRW5hYmxlVG9nZ2xlID0gKGV2OiBDdXN0b21FdmVudDxJU2V0TW9kYWxCdXR0b25FbmFibGVkQWN0aW9uUmVxdWVzdD4pID0+IHtcbiAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgY29uc3QgaXNDbG9zZSA9IGV2LmRldGFpbC5kYXRhLmJ1dHRvbiA9PT0gQnVpbHRJbk1vZGFsQnV0dG9uSUQuQ2xvc2U7XG4gICAgICAgIGlmIChpc0Nsb3NlIHx8ICF0aGlzLnBvc3NpYmxlQnV0dG9ucy5pbmNsdWRlcyhldi5kZXRhaWwuZGF0YS5idXR0b24pKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZS5tZXNzYWdpbmcudHJhbnNwb3J0LnJlcGx5KGV2LmRldGFpbCwge1xuICAgICAgICAgICAgICAgIGVycm9yOiB7IG1lc3NhZ2U6IFwiSW52YWxpZCBidXR0b25cIiB9LFxuICAgICAgICAgICAgfSBhcyBJV2lkZ2V0QXBpRXJyb3JSZXNwb25zZURhdGEpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGJ1dHRvbklkczogTW9kYWxCdXR0b25JRFtdO1xuICAgICAgICBpZiAoZXYuZGV0YWlsLmRhdGEuZW5hYmxlZCkge1xuICAgICAgICAgICAgYnV0dG9uSWRzID0gYXJyYXlGYXN0Q2xvbmUodGhpcy5zdGF0ZS5kaXNhYmxlZEJ1dHRvbklkcykuZmlsdGVyKGkgPT4gaSAhPT0gZXYuZGV0YWlsLmRhdGEuYnV0dG9uKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIHVzZSBhIHNldCB0byBzd2FwIHRoZSBvcGVyYXRpb24gdG8gYXZvaWQgbWVtb3J5IGxlYWt5IGFycmF5cy5cbiAgICAgICAgICAgIGNvbnN0IHRlbXBTZXQgPSBuZXcgU2V0KHRoaXMuc3RhdGUuZGlzYWJsZWRCdXR0b25JZHMpO1xuICAgICAgICAgICAgdGVtcFNldC5hZGQoZXYuZGV0YWlsLmRhdGEuYnV0dG9uKTtcbiAgICAgICAgICAgIGJ1dHRvbklkcyA9IEFycmF5LmZyb20odGVtcFNldCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGRpc2FibGVkQnV0dG9uSWRzOiBidXR0b25JZHMgfSk7XG4gICAgICAgIHRoaXMuc3RhdGUubWVzc2FnaW5nLnRyYW5zcG9ydC5yZXBseShldi5kZXRhaWwsIHt9IGFzIElXaWRnZXRBcGlBY2tub3dsZWRnZVJlc3BvbnNlRGF0YSk7XG4gICAgfTtcblxuICAgIHB1YmxpYyByZW5kZXIoKSB7XG4gICAgICAgIGNvbnN0IHRlbXBsYXRlZCA9IHRoaXMud2lkZ2V0LmdldENvbXBsZXRlVXJsKHtcbiAgICAgICAgICAgIHdpZGdldFJvb21JZDogdGhpcy5wcm9wcy53aWRnZXRSb29tSWQsXG4gICAgICAgICAgICBjdXJyZW50VXNlcklkOiBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZ2V0VXNlcklkKCksXG4gICAgICAgICAgICB1c2VyRGlzcGxheU5hbWU6IE93blByb2ZpbGVTdG9yZS5pbnN0YW5jZS5kaXNwbGF5TmFtZSxcbiAgICAgICAgICAgIHVzZXJIdHRwQXZhdGFyVXJsOiBPd25Qcm9maWxlU3RvcmUuaW5zdGFuY2UuZ2V0SHR0cEF2YXRhclVybCgpLFxuICAgICAgICAgICAgY2xpZW50SWQ6IEVMRU1FTlRfQ0xJRU5UX0lELFxuICAgICAgICAgICAgY2xpZW50VGhlbWU6IFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJ0aGVtZVwiKSxcbiAgICAgICAgICAgIGNsaWVudExhbmd1YWdlOiBnZXRVc2VyTGFuZ3VhZ2UoKSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgcGFyc2VkID0gbmV3IFVSTCh0ZW1wbGF0ZWQpO1xuXG4gICAgICAgIC8vIEFkZCBpbiBzb21lIGxlZ2FjeSBzdXBwb3J0IHNwcmlua2xlcyAoZm9yIG5vbi1wb3BvdXQgd2lkZ2V0cylcbiAgICAgICAgLy8gVE9ETzogUmVwbGFjZSB0aGVzZSB3aXRoIHByb3BlciB3aWRnZXQgcGFyYW1zXG4gICAgICAgIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vbWF0cml4LW9yZy9tYXRyaXgtZG9jL3B1bGwvMTk1OC9maWxlcyNyNDA1NzE0ODMzXG4gICAgICAgIHBhcnNlZC5zZWFyY2hQYXJhbXMuc2V0KCd3aWRnZXRJZCcsIHRoaXMud2lkZ2V0LmlkKTtcbiAgICAgICAgcGFyc2VkLnNlYXJjaFBhcmFtcy5zZXQoJ3BhcmVudFVybCcsIHdpbmRvdy5sb2NhdGlvbi5ocmVmLnNwbGl0KCcjJywgMilbMF0pO1xuXG4gICAgICAgIC8vIFJlcGxhY2UgdGhlIGVuY29kZWQgZG9sbGFyIHNpZ25zIGJhY2sgdG8gZG9sbGFyIHNpZ25zLiBUaGV5IGhhdmUgbm8gc3BlY2lhbCBtZWFuaW5nXG4gICAgICAgIC8vIGluIEhUVFAsIGJ1dCBVUkwgcGFyc2VycyBlbmNvZGUgdGhlbSBhbnl3YXlzLlxuICAgICAgICBjb25zdCB3aWRnZXRVcmwgPSBwYXJzZWQudG9TdHJpbmcoKS5yZXBsYWNlKC8lMjQvZywgJyQnKTtcblxuICAgICAgICBsZXQgYnV0dG9ucztcbiAgICAgICAgaWYgKHRoaXMucHJvcHMud2lkZ2V0RGVmaW5pdGlvbi5idXR0b25zKSB7XG4gICAgICAgICAgICAvLyBzaG93IGZpcnN0IGJ1dHRvbiByaWdodG1vc3QgZm9yIGEgbW9yZSBuYXR1cmFsIHNwZWNpZmljYXRpb25cbiAgICAgICAgICAgIGJ1dHRvbnMgPSB0aGlzLnByb3BzLndpZGdldERlZmluaXRpb24uYnV0dG9ucy5zbGljZSgwLCBNQVhfQlVUVE9OUykucmV2ZXJzZSgpLm1hcChkZWYgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBraW5kID0gXCJzZWNvbmRhcnlcIjtcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKGRlZi5raW5kKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgTW9kYWxCdXR0b25LaW5kLlByaW1hcnk6XG4gICAgICAgICAgICAgICAgICAgICAgICBraW5kID0gXCJwcmltYXJ5XCI7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBNb2RhbEJ1dHRvbktpbmQuU2Vjb25kYXJ5OlxuICAgICAgICAgICAgICAgICAgICAgICAga2luZCA9IFwicHJpbWFyeV9vdXRsaW5lXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBNb2RhbEJ1dHRvbktpbmQuRGFuZ2VyOlxuICAgICAgICAgICAgICAgICAgICAgICAga2luZCA9IFwiZGFuZ2VyXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjb25zdCBvbkNsaWNrID0gKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLm1lc3NhZ2luZy5ub3RpZnlNb2RhbFdpZGdldEJ1dHRvbkNsaWNrZWQoZGVmLmlkKTtcbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgY29uc3QgaXNEaXNhYmxlZCA9IHRoaXMuc3RhdGUuZGlzYWJsZWRCdXR0b25JZHMuaW5jbHVkZXMoZGVmLmlkKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiA8QWNjZXNzaWJsZUJ1dHRvbiBrZXk9e2RlZi5pZH0ga2luZD17a2luZH0gb25DbGljaz17b25DbGlja30gZGlzYWJsZWQ9e2lzRGlzYWJsZWR9PlxuICAgICAgICAgICAgICAgICAgICB7IGRlZi5sYWJlbCB9XG4gICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPjtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIDxCYXNlRGlhbG9nXG4gICAgICAgICAgICB0aXRsZT17dGhpcy5wcm9wcy53aWRnZXREZWZpbml0aW9uLm5hbWUgfHwgX3QoXCJNb2RhbCBXaWRnZXRcIil9XG4gICAgICAgICAgICBjbGFzc05hbWU9XCJteF9Nb2RhbFdpZGdldERpYWxvZ1wiXG4gICAgICAgICAgICBjb250ZW50SWQ9XCJteF9EaWFsb2dfY29udGVudFwiXG4gICAgICAgICAgICBvbkZpbmlzaGVkPXt0aGlzLnByb3BzLm9uRmluaXNoZWR9XG4gICAgICAgID5cbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfTW9kYWxXaWRnZXREaWFsb2dfd2FybmluZ1wiPlxuICAgICAgICAgICAgICAgIDxpbWdcbiAgICAgICAgICAgICAgICAgICAgc3JjPXtyZXF1aXJlKFwiLi4vLi4vLi4vLi4vcmVzL2ltZy9lbGVtZW50LWljb25zL3dhcm5pbmctYmFkZ2Uuc3ZnXCIpfVxuICAgICAgICAgICAgICAgICAgICBoZWlnaHQ9XCIxNlwiXG4gICAgICAgICAgICAgICAgICAgIHdpZHRoPVwiMTZcIlxuICAgICAgICAgICAgICAgICAgICBhbHQ9XCJcIlxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgeyBfdChcIkRhdGEgb24gdGhpcyBzY3JlZW4gaXMgc2hhcmVkIHdpdGggJSh3aWRnZXREb21haW4pc1wiLCB7XG4gICAgICAgICAgICAgICAgICAgIHdpZGdldERvbWFpbjogcGFyc2VkLmhvc3RuYW1lLFxuICAgICAgICAgICAgICAgIH0pIH1cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgICAgICA8aWZyYW1lXG4gICAgICAgICAgICAgICAgICAgIHJlZj17dGhpcy5hcHBGcmFtZX1cbiAgICAgICAgICAgICAgICAgICAgc2FuZGJveD1cImFsbG93LWZvcm1zIGFsbG93LXNjcmlwdHMgYWxsb3ctc2FtZS1vcmlnaW5cIlxuICAgICAgICAgICAgICAgICAgICBzcmM9e3dpZGdldFVybH1cbiAgICAgICAgICAgICAgICAgICAgb25Mb2FkPXt0aGlzLm9uTG9hZH1cbiAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X01vZGFsV2lkZ2V0RGlhbG9nX2J1dHRvbnNcIj5cbiAgICAgICAgICAgICAgICB7IGJ1dHRvbnMgfVxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgIDwvQmFzZURpYWxvZz47XG4gICAgfVxufVxuIl19