"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _IntegrationManagers = require("../../../integrations/IntegrationManagers");

var _Terms = require("../../../Terms");

var _classnames = _interopRequireDefault(require("classnames"));

var ScalarMessaging = _interopRequireWildcard(require("../../../ScalarMessaging"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _IntegrationManager = _interopRequireDefault(require("../settings/IntegrationManager"));

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

let TabbedIntegrationManagerDialog = (_dec = (0, _replaceableComponent.replaceableComponent)("views.dialogs.TabbedIntegrationManagerDialog"), _dec(_class = class TabbedIntegrationManagerDialog extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "openManager", async (i, force = false) => {
      if (i === this.state.currentIndex && !force) return;
      const manager = this.state.managers[i];
      const client = manager.getScalarClient();
      this.setState({
        busy: true,
        currentIndex: i,
        currentLoading: true,
        currentConnected: false,
        currentScalarClient: client
      });
      ScalarMessaging.setOpenManagerUrl(manager.uiUrl);
      client.setTermsInteractionCallback((policyInfo, agreedUrls) => {
        // To avoid visual glitching of two modals stacking briefly, we customise the
        // terms dialog sizing when it will appear for the integration manager so that
        // it gets the same basic size as the IM's own modal.
        return (0, _Terms.dialogTermsInteractionCallback)(policyInfo, agreedUrls, 'mx_TermsDialog_forIntegrationManager');
      });

      try {
        await client.connect();

        if (!client.hasCredentials()) {
          this.setState({
            busy: false,
            currentLoading: false,
            currentConnected: false
          });
        } else {
          this.setState({
            busy: false,
            currentLoading: false,
            currentConnected: true
          });
        }
      } catch (e) {
        if (e instanceof _Terms.TermsNotSignedError) {
          return;
        }

        _logger.logger.error(e);

        this.setState({
          busy: false,
          currentLoading: false,
          currentConnected: false
        });
      }
    });
    this.state = {
      managers: _IntegrationManagers.IntegrationManagers.sharedInstance().getOrderedManagers(),
      busy: true,
      currentIndex: 0,
      currentConnected: false,
      currentLoading: true,
      currentScalarClient: null
    };
  }

  componentDidMount() {
    this.openManager(0, true);
  }

  renderTabs() {
    return this.state.managers.map((m, i) => {
      const classes = (0, _classnames.default)({
        'mx_TabbedIntegrationManagerDialog_tab': true,
        'mx_TabbedIntegrationManagerDialog_currentTab': this.state.currentIndex === i
      });
      return /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        className: classes,
        onClick: () => this.openManager(i),
        key: `tab_${i}`,
        disabled: this.state.busy
      }, m.name);
    });
  }

  renderTab() {
    let uiUrl = null;

    if (this.state.currentScalarClient) {
      uiUrl = this.state.currentScalarClient.getScalarInterfaceUrlForRoom(this.props.room, this.props.screen, this.props.integrationId);
    }

    return /*#__PURE__*/_react.default.createElement(_IntegrationManager.default, {
      loading: this.state.currentLoading,
      connected: this.state.currentConnected,
      url: uiUrl,
      onFinished: () => {
        /* no-op */
      }
    });
  }

  render() {
    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_TabbedIntegrationManagerDialog_container"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_TabbedIntegrationManagerDialog_tabs"
    }, this.renderTabs()), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_TabbedIntegrationManagerDialog_currentManager"
    }, this.renderTab()));
  }

}) || _class);
exports.default = TabbedIntegrationManagerDialog;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvVGFiYmVkSW50ZWdyYXRpb25NYW5hZ2VyRGlhbG9nLnRzeCJdLCJuYW1lcyI6WyJUYWJiZWRJbnRlZ3JhdGlvbk1hbmFnZXJEaWFsb2ciLCJSZWFjdCIsIkNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJpIiwiZm9yY2UiLCJzdGF0ZSIsImN1cnJlbnRJbmRleCIsIm1hbmFnZXIiLCJtYW5hZ2VycyIsImNsaWVudCIsImdldFNjYWxhckNsaWVudCIsInNldFN0YXRlIiwiYnVzeSIsImN1cnJlbnRMb2FkaW5nIiwiY3VycmVudENvbm5lY3RlZCIsImN1cnJlbnRTY2FsYXJDbGllbnQiLCJTY2FsYXJNZXNzYWdpbmciLCJzZXRPcGVuTWFuYWdlclVybCIsInVpVXJsIiwic2V0VGVybXNJbnRlcmFjdGlvbkNhbGxiYWNrIiwicG9saWN5SW5mbyIsImFncmVlZFVybHMiLCJjb25uZWN0IiwiaGFzQ3JlZGVudGlhbHMiLCJlIiwiVGVybXNOb3RTaWduZWRFcnJvciIsImxvZ2dlciIsImVycm9yIiwiSW50ZWdyYXRpb25NYW5hZ2VycyIsInNoYXJlZEluc3RhbmNlIiwiZ2V0T3JkZXJlZE1hbmFnZXJzIiwiY29tcG9uZW50RGlkTW91bnQiLCJvcGVuTWFuYWdlciIsInJlbmRlclRhYnMiLCJtYXAiLCJtIiwiY2xhc3NlcyIsIm5hbWUiLCJyZW5kZXJUYWIiLCJnZXRTY2FsYXJJbnRlcmZhY2VVcmxGb3JSb29tIiwicm9vbSIsInNjcmVlbiIsImludGVncmF0aW9uSWQiLCJyZW5kZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUdBOztBQUNBOztBQUdBOzs7Ozs7OztJQTZCcUJBLDhCLFdBRHBCLGdEQUFxQiw4Q0FBckIsQyxnQkFBRCxNQUNxQkEsOEJBRHJCLFNBQzREQyxlQUFNQyxTQURsRSxDQUM0RjtB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TCxDQUFpQjdCLENBQWpCLENBRm5CO0FBR0ksUUFBQSxHQUFHLEVBQUcsT0FBTUEsQ0FBRSxFQUhsQjtBQUlJLFFBQUEsUUFBUSxFQUFFLEtBQUtFLEtBQUwsQ0FBV087QUFKekIsU0FNTXVCLENBQUMsQ0FBQ0UsSUFOUixDQURKO0FBVUgsS0FmTSxDQUFQO0FBZ0JIOztBQUVNQyxFQUFBQSxTQUFTLEdBQWdCO0FBQzVCLFFBQUlwQixLQUFLLEdBQUcsSUFBWjs7QUFDQSxRQUFJLEtBQUtiLEtBQUwsQ0FBV1UsbUJBQWYsRUFBb0M7QUFDaENHLE1BQUFBLEtBQUssR0FBRyxLQUFLYixLQUFMLENBQVdVLG1CQUFYLENBQStCd0IsNEJBQS9CLENBQ0osS0FBS3JDLEtBQUwsQ0FBV3NDLElBRFAsRUFFSixLQUFLdEMsS0FBTCxDQUFXdUMsTUFGUCxFQUdKLEtBQUt2QyxLQUFMLENBQVd3QyxhQUhQLENBQVI7QUFLSDs7QUFDRCx3QkFBTyw2QkFBQywyQkFBRDtBQUNILE1BQUEsT0FBTyxFQUFFLEtBQUtyQyxLQUFMLENBQVdRLGNBRGpCO0FBRUgsTUFBQSxTQUFTLEVBQUUsS0FBS1IsS0FBTCxDQUFXUyxnQkFGbkI7QUFHSCxNQUFBLEdBQUcsRUFBRUksS0FIRjtBQUlILE1BQUEsVUFBVSxFQUFFLE1BQU07QUFBQztBQUFZO0FBSjVCLE1BQVA7QUFNSDs7QUFFTXlCLEVBQUFBLE1BQU0sR0FBZ0I7QUFDekIsd0JBQ0k7QUFBSyxNQUFBLFNBQVMsRUFBQztBQUFmLG9CQUNJO0FBQUssTUFBQSxTQUFTLEVBQUM7QUFBZixPQUNNLEtBQUtWLFVBQUwsRUFETixDQURKLGVBSUk7QUFBSyxNQUFBLFNBQVMsRUFBQztBQUFmLE9BQ00sS0FBS0ssU0FBTCxFQUROLENBSkosQ0FESjtBQVVIOztBQXRIdUYsQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxOSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBJbnRlZ3JhdGlvbk1hbmFnZXJzIH0gZnJvbSBcIi4uLy4uLy4uL2ludGVncmF0aW9ucy9JbnRlZ3JhdGlvbk1hbmFnZXJzXCI7XG5pbXBvcnQgeyBSb29tIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yb29tXCI7XG5pbXBvcnQgeyBkaWFsb2dUZXJtc0ludGVyYWN0aW9uQ2FsbGJhY2ssIFRlcm1zTm90U2lnbmVkRXJyb3IgfSBmcm9tIFwiLi4vLi4vLi4vVGVybXNcIjtcbmltcG9ydCBjbGFzc05hbWVzIGZyb20gJ2NsYXNzbmFtZXMnO1xuaW1wb3J0ICogYXMgU2NhbGFyTWVzc2FnaW5nIGZyb20gXCIuLi8uLi8uLi9TY2FsYXJNZXNzYWdpbmdcIjtcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5pbXBvcnQgeyBJbnRlZ3JhdGlvbk1hbmFnZXJJbnN0YW5jZSB9IGZyb20gXCIuLi8uLi8uLi9pbnRlZ3JhdGlvbnMvSW50ZWdyYXRpb25NYW5hZ2VySW5zdGFuY2VcIjtcbmltcG9ydCBTY2FsYXJBdXRoQ2xpZW50IGZyb20gXCIuLi8uLi8uLi9TY2FsYXJBdXRoQ2xpZW50XCI7XG5pbXBvcnQgQWNjZXNzaWJsZUJ1dHRvbiBmcm9tIFwiLi4vZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvblwiO1xuaW1wb3J0IEludGVncmF0aW9uTWFuYWdlciBmcm9tIFwiLi4vc2V0dGluZ3MvSW50ZWdyYXRpb25NYW5hZ2VyXCI7XG5pbXBvcnQgeyBJRGlhbG9nUHJvcHMgfSBmcm9tIFwiLi9JRGlhbG9nUHJvcHNcIjtcblxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2xvZ2dlclwiO1xuXG5pbnRlcmZhY2UgSVByb3BzIGV4dGVuZHMgSURpYWxvZ1Byb3BzIHtcbiAgICAvKipcbiAgICAgKiBPcHRpb25hbCByb29tIHdoZXJlIHRoZSBpbnRlZ3JhdGlvbiBtYW5hZ2VyIHNob3VsZCBiZSBvcGVuIHRvXG4gICAgICovXG4gICAgcm9vbT86IFJvb207XG5cbiAgICAvKipcbiAgICAgKiBPcHRpb25hbCBzY3JlZW4gdG8gb3BlbiBvbiB0aGUgaW50ZWdyYXRpb24gbWFuYWdlclxuICAgICAqL1xuICAgIHNjcmVlbj86IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIE9wdGlvbmFsIGludGVncmF0aW9uIElEIHRvIG9wZW4gaW4gdGhlIGludGVncmF0aW9uIG1hbmFnZXJcbiAgICAgKi9cbiAgICBpbnRlZ3JhdGlvbklkPzogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBtYW5hZ2VyczogSW50ZWdyYXRpb25NYW5hZ2VySW5zdGFuY2VbXTtcbiAgICBidXN5OiBib29sZWFuO1xuICAgIGN1cnJlbnRJbmRleDogbnVtYmVyO1xuICAgIGN1cnJlbnRDb25uZWN0ZWQ6IGJvb2xlYW47XG4gICAgY3VycmVudExvYWRpbmc6IGJvb2xlYW47XG4gICAgY3VycmVudFNjYWxhckNsaWVudDogU2NhbGFyQXV0aENsaWVudDtcbn1cblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3MuZGlhbG9ncy5UYWJiZWRJbnRlZ3JhdGlvbk1hbmFnZXJEaWFsb2dcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFRhYmJlZEludGVncmF0aW9uTWFuYWdlckRpYWxvZyBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxJUHJvcHMsIElTdGF0ZT4ge1xuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBJUHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuXG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICBtYW5hZ2VyczogSW50ZWdyYXRpb25NYW5hZ2Vycy5zaGFyZWRJbnN0YW5jZSgpLmdldE9yZGVyZWRNYW5hZ2VycygpLFxuICAgICAgICAgICAgYnVzeTogdHJ1ZSxcbiAgICAgICAgICAgIGN1cnJlbnRJbmRleDogMCxcbiAgICAgICAgICAgIGN1cnJlbnRDb25uZWN0ZWQ6IGZhbHNlLFxuICAgICAgICAgICAgY3VycmVudExvYWRpbmc6IHRydWUsXG4gICAgICAgICAgICBjdXJyZW50U2NhbGFyQ2xpZW50OiBudWxsLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHB1YmxpYyBjb21wb25lbnREaWRNb3VudCgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5vcGVuTWFuYWdlcigwLCB0cnVlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9wZW5NYW5hZ2VyID0gYXN5bmMgKGk6IG51bWJlciwgZm9yY2UgPSBmYWxzZSk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgICAgICBpZiAoaSA9PT0gdGhpcy5zdGF0ZS5jdXJyZW50SW5kZXggJiYgIWZvcmNlKSByZXR1cm47XG5cbiAgICAgICAgY29uc3QgbWFuYWdlciA9IHRoaXMuc3RhdGUubWFuYWdlcnNbaV07XG4gICAgICAgIGNvbnN0IGNsaWVudCA9IG1hbmFnZXIuZ2V0U2NhbGFyQ2xpZW50KCk7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgYnVzeTogdHJ1ZSxcbiAgICAgICAgICAgIGN1cnJlbnRJbmRleDogaSxcbiAgICAgICAgICAgIGN1cnJlbnRMb2FkaW5nOiB0cnVlLFxuICAgICAgICAgICAgY3VycmVudENvbm5lY3RlZDogZmFsc2UsXG4gICAgICAgICAgICBjdXJyZW50U2NhbGFyQ2xpZW50OiBjbGllbnQsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIFNjYWxhck1lc3NhZ2luZy5zZXRPcGVuTWFuYWdlclVybChtYW5hZ2VyLnVpVXJsKTtcblxuICAgICAgICBjbGllbnQuc2V0VGVybXNJbnRlcmFjdGlvbkNhbGxiYWNrKChwb2xpY3lJbmZvLCBhZ3JlZWRVcmxzKSA9PiB7XG4gICAgICAgICAgICAvLyBUbyBhdm9pZCB2aXN1YWwgZ2xpdGNoaW5nIG9mIHR3byBtb2RhbHMgc3RhY2tpbmcgYnJpZWZseSwgd2UgY3VzdG9taXNlIHRoZVxuICAgICAgICAgICAgLy8gdGVybXMgZGlhbG9nIHNpemluZyB3aGVuIGl0IHdpbGwgYXBwZWFyIGZvciB0aGUgaW50ZWdyYXRpb24gbWFuYWdlciBzbyB0aGF0XG4gICAgICAgICAgICAvLyBpdCBnZXRzIHRoZSBzYW1lIGJhc2ljIHNpemUgYXMgdGhlIElNJ3Mgb3duIG1vZGFsLlxuICAgICAgICAgICAgcmV0dXJuIGRpYWxvZ1Rlcm1zSW50ZXJhY3Rpb25DYWxsYmFjayhcbiAgICAgICAgICAgICAgICBwb2xpY3lJbmZvLCBhZ3JlZWRVcmxzLCAnbXhfVGVybXNEaWFsb2dfZm9ySW50ZWdyYXRpb25NYW5hZ2VyJyxcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCBjbGllbnQuY29ubmVjdCgpO1xuICAgICAgICAgICAgaWYgKCFjbGllbnQuaGFzQ3JlZGVudGlhbHMoKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgICAgICBidXN5OiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudExvYWRpbmc6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICBjdXJyZW50Q29ubmVjdGVkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgICAgIGJ1c3k6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICBjdXJyZW50TG9hZGluZzogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRDb25uZWN0ZWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGlmIChlIGluc3RhbmNlb2YgVGVybXNOb3RTaWduZWRFcnJvcikge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGUpO1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgYnVzeTogZmFsc2UsXG4gICAgICAgICAgICAgICAgY3VycmVudExvYWRpbmc6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGN1cnJlbnRDb25uZWN0ZWQ6IGZhbHNlLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSByZW5kZXJUYWJzKCk6IEpTWC5FbGVtZW50W10ge1xuICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZS5tYW5hZ2Vycy5tYXAoKG0sIGkpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNsYXNzZXMgPSBjbGFzc05hbWVzKHtcbiAgICAgICAgICAgICAgICAnbXhfVGFiYmVkSW50ZWdyYXRpb25NYW5hZ2VyRGlhbG9nX3RhYic6IHRydWUsXG4gICAgICAgICAgICAgICAgJ214X1RhYmJlZEludGVncmF0aW9uTWFuYWdlckRpYWxvZ19jdXJyZW50VGFiJzogdGhpcy5zdGF0ZS5jdXJyZW50SW5kZXggPT09IGksXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b25cbiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPXtjbGFzc2VzfVxuICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXsoKSA9PiB0aGlzLm9wZW5NYW5hZ2VyKGkpfVxuICAgICAgICAgICAgICAgICAgICBrZXk9e2B0YWJfJHtpfWB9XG4gICAgICAgICAgICAgICAgICAgIGRpc2FibGVkPXt0aGlzLnN0YXRlLmJ1c3l9XG4gICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICB7IG0ubmFtZSB9XG4gICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIHJlbmRlclRhYigpOiBKU1guRWxlbWVudCB7XG4gICAgICAgIGxldCB1aVVybCA9IG51bGw7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLmN1cnJlbnRTY2FsYXJDbGllbnQpIHtcbiAgICAgICAgICAgIHVpVXJsID0gdGhpcy5zdGF0ZS5jdXJyZW50U2NhbGFyQ2xpZW50LmdldFNjYWxhckludGVyZmFjZVVybEZvclJvb20oXG4gICAgICAgICAgICAgICAgdGhpcy5wcm9wcy5yb29tLFxuICAgICAgICAgICAgICAgIHRoaXMucHJvcHMuc2NyZWVuLFxuICAgICAgICAgICAgICAgIHRoaXMucHJvcHMuaW50ZWdyYXRpb25JZCxcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIDxJbnRlZ3JhdGlvbk1hbmFnZXJcbiAgICAgICAgICAgIGxvYWRpbmc9e3RoaXMuc3RhdGUuY3VycmVudExvYWRpbmd9XG4gICAgICAgICAgICBjb25uZWN0ZWQ9e3RoaXMuc3RhdGUuY3VycmVudENvbm5lY3RlZH1cbiAgICAgICAgICAgIHVybD17dWlVcmx9XG4gICAgICAgICAgICBvbkZpbmlzaGVkPXsoKSA9PiB7Lyogbm8tb3AgKi99fVxuICAgICAgICAvPjtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVuZGVyKCk6IEpTWC5FbGVtZW50IHtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdteF9UYWJiZWRJbnRlZ3JhdGlvbk1hbmFnZXJEaWFsb2dfY29udGFpbmVyJz5cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nbXhfVGFiYmVkSW50ZWdyYXRpb25NYW5hZ2VyRGlhbG9nX3RhYnMnPlxuICAgICAgICAgICAgICAgICAgICB7IHRoaXMucmVuZGVyVGFicygpIH1cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nbXhfVGFiYmVkSW50ZWdyYXRpb25NYW5hZ2VyRGlhbG9nX2N1cnJlbnRNYW5hZ2VyJz5cbiAgICAgICAgICAgICAgICAgICAgeyB0aGlzLnJlbmRlclRhYigpIH1cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICApO1xuICAgIH1cbn1cbiJdfQ==