"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var React = _interopRequireWildcard(require("react"));

var _BaseDialog = _interopRequireDefault(require("./BaseDialog"));

var _languageHandler = require("../../../languageHandler");

var _EchoStore = require("../../../stores/local-echo/EchoStore");

var _DateUtils = require("../../../DateUtils");

var _SettingsStore = _interopRequireDefault(require("../../../settings/SettingsStore"));

var _RoomEchoContext = require("../../../stores/local-echo/RoomEchoContext");

var _RoomAvatar = _interopRequireDefault(require("../avatars/RoomAvatar"));

var _EchoTransaction = require("../../../stores/local-echo/EchoTransaction");

var _Spinner = _interopRequireDefault(require("../elements/Spinner"));

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _AsyncStore = require("../../../stores/AsyncStore");

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _dec, _class;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

let ServerOfflineDialog = (_dec = (0, _replaceableComponent.replaceableComponent)("views.dialogs.ServerOfflineDialog"), _dec(_class = class ServerOfflineDialog extends React.PureComponent {
  constructor(...args) {
    super(...args);
    (0, _defineProperty2.default)(this, "onEchosUpdated", () => {
      this.forceUpdate(); // no state to worry about
    });
  }

  componentDidMount() {
    _EchoStore.EchoStore.instance.on(_AsyncStore.UPDATE_EVENT, this.onEchosUpdated);
  }

  componentWillUnmount() {
    _EchoStore.EchoStore.instance.off(_AsyncStore.UPDATE_EVENT, this.onEchosUpdated);
  }

  renderTimeline() {
    return _EchoStore.EchoStore.instance.contexts.map((c, i) => {
      if (!c.firstFailedTime) return null; // not useful

      if (!(c instanceof _RoomEchoContext.RoomEchoContext)) throw new Error("Cannot render unknown context: " + c);
      const header = /*#__PURE__*/React.createElement("div", {
        className: "mx_ServerOfflineDialog_content_context_timeline_header"
      }, /*#__PURE__*/React.createElement(_RoomAvatar.default, {
        width: 24,
        height: 24,
        room: c.room
      }), /*#__PURE__*/React.createElement("span", null, c.room.name));
      const entries = c.transactions.filter(t => t.status === _EchoTransaction.TransactionStatus.Error || t.didPreviouslyFail).map((t, j) => {
        let button = /*#__PURE__*/React.createElement(_Spinner.default, {
          w: 19,
          h: 19
        });

        if (t.status === _EchoTransaction.TransactionStatus.Error) {
          button = /*#__PURE__*/React.createElement(_AccessibleButton.default, {
            kind: "link",
            onClick: () => t.run()
          }, (0, _languageHandler._t)("Resend"));
        }

        return /*#__PURE__*/React.createElement("div", {
          className: "mx_ServerOfflineDialog_content_context_txn",
          key: `txn-${j}`
        }, /*#__PURE__*/React.createElement("span", {
          className: "mx_ServerOfflineDialog_content_context_txn_desc"
        }, t.auditName), button);
      });
      return /*#__PURE__*/React.createElement("div", {
        className: "mx_ServerOfflineDialog_content_context",
        key: `context-${i}`
      }, /*#__PURE__*/React.createElement("div", {
        className: "mx_ServerOfflineDialog_content_context_timestamp"
      }, (0, _DateUtils.formatTime)(c.firstFailedTime, _SettingsStore.default.getValue("showTwelveHourTimestamps"))), /*#__PURE__*/React.createElement("div", {
        className: "mx_ServerOfflineDialog_content_context_timeline"
      }, header, entries));
    });
  }

  render() {
    let timeline = this.renderTimeline().filter(c => !!c); // remove nulls for next check

    if (timeline.length === 0) {
      timeline = [/*#__PURE__*/React.createElement("div", {
        key: 1
      }, (0, _languageHandler._t)("You're all caught up."))];
    }

    const serverName = _MatrixClientPeg.MatrixClientPeg.getHomeserverName();

    return /*#__PURE__*/React.createElement(_BaseDialog.default, {
      title: (0, _languageHandler._t)("Server isn't responding"),
      className: "mx_ServerOfflineDialog",
      contentId: "mx_Dialog_content",
      onFinished: this.props.onFinished,
      hasCancel: true
    }, /*#__PURE__*/React.createElement("div", {
      className: "mx_ServerOfflineDialog_content"
    }, /*#__PURE__*/React.createElement("p", null, (0, _languageHandler._t)("Your server isn't responding to some of your requests. " + "Below are some of the most likely reasons.")), /*#__PURE__*/React.createElement("ul", null, /*#__PURE__*/React.createElement("li", null, (0, _languageHandler._t)("The server (%(serverName)s) took too long to respond.", {
      serverName
    })), /*#__PURE__*/React.createElement("li", null, (0, _languageHandler._t)("Your firewall or anti-virus is blocking the request.")), /*#__PURE__*/React.createElement("li", null, (0, _languageHandler._t)("A browser extension is preventing the request.")), /*#__PURE__*/React.createElement("li", null, (0, _languageHandler._t)("The server is offline.")), /*#__PURE__*/React.createElement("li", null, (0, _languageHandler._t)("The server has denied your request.")), /*#__PURE__*/React.createElement("li", null, (0, _languageHandler._t)("Your area is experiencing difficulties connecting to the internet.")), /*#__PURE__*/React.createElement("li", null, (0, _languageHandler._t)("A connection error occurred while trying to contact the server.")), /*#__PURE__*/React.createElement("li", null, (0, _languageHandler._t)("The server is not configured to indicate what the problem is (CORS)."))), /*#__PURE__*/React.createElement("hr", null), /*#__PURE__*/React.createElement("h2", null, (0, _languageHandler._t)("Recent changes that have not yet been received")), timeline));
  }

}) || _class);
exports.default = ServerOfflineDialog;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvU2VydmVyT2ZmbGluZURpYWxvZy50c3giXSwibmFtZXMiOlsiU2VydmVyT2ZmbGluZURpYWxvZyIsIlJlYWN0IiwiUHVyZUNvbXBvbmVudCIsImZvcmNlVXBkYXRlIiwiY29tcG9uZW50RGlkTW91bnQiLCJFY2hvU3RvcmUiLCJpbnN0YW5jZSIsIm9uIiwiVVBEQVRFX0VWRU5UIiwib25FY2hvc1VwZGF0ZWQiLCJjb21wb25lbnRXaWxsVW5tb3VudCIsIm9mZiIsInJlbmRlclRpbWVsaW5lIiwiY29udGV4dHMiLCJtYXAiLCJjIiwiaSIsImZpcnN0RmFpbGVkVGltZSIsIlJvb21FY2hvQ29udGV4dCIsIkVycm9yIiwiaGVhZGVyIiwicm9vbSIsIm5hbWUiLCJlbnRyaWVzIiwidHJhbnNhY3Rpb25zIiwiZmlsdGVyIiwidCIsInN0YXR1cyIsIlRyYW5zYWN0aW9uU3RhdHVzIiwiZGlkUHJldmlvdXNseUZhaWwiLCJqIiwiYnV0dG9uIiwicnVuIiwiYXVkaXROYW1lIiwiU2V0dGluZ3NTdG9yZSIsImdldFZhbHVlIiwicmVuZGVyIiwidGltZWxpbmUiLCJsZW5ndGgiLCJzZXJ2ZXJOYW1lIiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0SG9tZXNlcnZlck5hbWUiLCJwcm9wcyIsIm9uRmluaXNoZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOzs7Ozs7OztJQU1xQkEsbUIsV0FEcEIsZ0RBQXFCLG1DQUFyQixDLGdCQUFELE1BQ3FCQSxtQkFEckIsU0FDaURDLEtBQUssQ0FBQ0MsYUFEdkQsQ0FDNkU7QUFBQTtBQUFBO0FBQUEsMERBU2hELE1BQU07QUFDM0IsV0FBS0MsV0FBTCxHQUQyQixDQUNQO0FBQ3ZCLEtBWHdFO0FBQUE7O0FBQ2xF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OztBQUVELFVBQU1FLFVBQVUsR0FBR0MsaUNBQWdCQyxpQkFBaEIsRUFBbkI7O0FBQ0Esd0JBQU8sb0JBQUMsbUJBQUQ7QUFBWSxNQUFBLEtBQUssRUFBRSx5QkFBRyx5QkFBSCxDQUFuQjtBQUNILE1BQUEsU0FBUyxFQUFDLHdCQURQO0FBRUgsTUFBQSxTQUFTLEVBQUMsbUJBRlA7QUFHSCxNQUFBLFVBQVUsRUFBRSxLQUFLQyxLQUFMLENBQVdDLFVBSHBCO0FBSUgsTUFBQSxTQUFTLEVBQUU7QUFKUixvQkFNSDtBQUFLLE1BQUEsU0FBUyxFQUFDO0FBQWYsb0JBQ0ksK0JBQUsseUJBQ0QsNERBQ0EsNENBRkMsQ0FBTCxDQURKLGVBS0ksNkNBQ0ksZ0NBQU0seUJBQUcsdURBQUgsRUFBNEQ7QUFBRUosTUFBQUE7QUFBRixLQUE1RCxDQUFOLENBREosZUFFSSxnQ0FBTSx5QkFBRyxzREFBSCxDQUFOLENBRkosZUFHSSxnQ0FBTSx5QkFBRyxnREFBSCxDQUFOLENBSEosZUFJSSxnQ0FBTSx5QkFBRyx3QkFBSCxDQUFOLENBSkosZUFLSSxnQ0FBTSx5QkFBRyxxQ0FBSCxDQUFOLENBTEosZUFNSSxnQ0FBTSx5QkFBRyxvRUFBSCxDQUFOLENBTkosZUFPSSxnQ0FBTSx5QkFBRyxpRUFBSCxDQUFOLENBUEosZUFRSSxnQ0FBTSx5QkFBRyxzRUFBSCxDQUFOLENBUkosQ0FMSixlQWVJLCtCQWZKLGVBZ0JJLGdDQUFNLHlCQUFHLGdEQUFILENBQU4sQ0FoQkosRUFpQk1GLFFBakJOLENBTkcsQ0FBUDtBQTBCSDs7QUF4RndFLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMjAgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgQmFzZURpYWxvZyBmcm9tICcuL0Jhc2VEaWFsb2cnO1xuaW1wb3J0IHsgX3QgfSBmcm9tICcuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXInO1xuaW1wb3J0IHsgRWNob1N0b3JlIH0gZnJvbSBcIi4uLy4uLy4uL3N0b3Jlcy9sb2NhbC1lY2hvL0VjaG9TdG9yZVwiO1xuaW1wb3J0IHsgZm9ybWF0VGltZSB9IGZyb20gXCIuLi8uLi8uLi9EYXRlVXRpbHNcIjtcbmltcG9ydCBTZXR0aW5nc1N0b3JlIGZyb20gXCIuLi8uLi8uLi9zZXR0aW5ncy9TZXR0aW5nc1N0b3JlXCI7XG5pbXBvcnQgeyBSb29tRWNob0NvbnRleHQgfSBmcm9tIFwiLi4vLi4vLi4vc3RvcmVzL2xvY2FsLWVjaG8vUm9vbUVjaG9Db250ZXh0XCI7XG5pbXBvcnQgUm9vbUF2YXRhciBmcm9tIFwiLi4vYXZhdGFycy9Sb29tQXZhdGFyXCI7XG5pbXBvcnQgeyBUcmFuc2FjdGlvblN0YXR1cyB9IGZyb20gXCIuLi8uLi8uLi9zdG9yZXMvbG9jYWwtZWNoby9FY2hvVHJhbnNhY3Rpb25cIjtcbmltcG9ydCBTcGlubmVyIGZyb20gXCIuLi9lbGVtZW50cy9TcGlubmVyXCI7XG5pbXBvcnQgQWNjZXNzaWJsZUJ1dHRvbiBmcm9tIFwiLi4vZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvblwiO1xuaW1wb3J0IHsgVVBEQVRFX0VWRU5UIH0gZnJvbSBcIi4uLy4uLy4uL3N0b3Jlcy9Bc3luY1N0b3JlXCI7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tIFwiLi4vLi4vLi4vTWF0cml4Q2xpZW50UGVnXCI7XG5pbXBvcnQgeyBJRGlhbG9nUHJvcHMgfSBmcm9tIFwiLi9JRGlhbG9nUHJvcHNcIjtcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5cbmludGVyZmFjZSBJUHJvcHMgZXh0ZW5kcyBJRGlhbG9nUHJvcHMge1xufVxuXG5AcmVwbGFjZWFibGVDb21wb25lbnQoXCJ2aWV3cy5kaWFsb2dzLlNlcnZlck9mZmxpbmVEaWFsb2dcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFNlcnZlck9mZmxpbmVEaWFsb2cgZXh0ZW5kcyBSZWFjdC5QdXJlQ29tcG9uZW50PElQcm9wcz4ge1xuICAgIHB1YmxpYyBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICAgICAgRWNob1N0b3JlLmluc3RhbmNlLm9uKFVQREFURV9FVkVOVCwgdGhpcy5vbkVjaG9zVXBkYXRlZCk7XG4gICAgfVxuXG4gICAgcHVibGljIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgICBFY2hvU3RvcmUuaW5zdGFuY2Uub2ZmKFVQREFURV9FVkVOVCwgdGhpcy5vbkVjaG9zVXBkYXRlZCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkVjaG9zVXBkYXRlZCA9ICgpID0+IHtcbiAgICAgICAgdGhpcy5mb3JjZVVwZGF0ZSgpOyAvLyBubyBzdGF0ZSB0byB3b3JyeSBhYm91dFxuICAgIH07XG5cbiAgICBwcml2YXRlIHJlbmRlclRpbWVsaW5lKCk6IFJlYWN0LlJlYWN0RWxlbWVudFtdIHtcbiAgICAgICAgcmV0dXJuIEVjaG9TdG9yZS5pbnN0YW5jZS5jb250ZXh0cy5tYXAoKGMsIGkpID0+IHtcbiAgICAgICAgICAgIGlmICghYy5maXJzdEZhaWxlZFRpbWUpIHJldHVybiBudWxsOyAvLyBub3QgdXNlZnVsXG4gICAgICAgICAgICBpZiAoIShjIGluc3RhbmNlb2YgUm9vbUVjaG9Db250ZXh0KSkgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IHJlbmRlciB1bmtub3duIGNvbnRleHQ6IFwiICsgYyk7XG4gICAgICAgICAgICBjb25zdCBoZWFkZXIgPSAoXG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9TZXJ2ZXJPZmZsaW5lRGlhbG9nX2NvbnRlbnRfY29udGV4dF90aW1lbGluZV9oZWFkZXJcIj5cbiAgICAgICAgICAgICAgICAgICAgPFJvb21BdmF0YXIgd2lkdGg9ezI0fSBoZWlnaHQ9ezI0fSByb29tPXtjLnJvb219IC8+XG4gICAgICAgICAgICAgICAgICAgIDxzcGFuPnsgYy5yb29tLm5hbWUgfTwvc3Bhbj5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBjb25zdCBlbnRyaWVzID0gYy50cmFuc2FjdGlvbnNcbiAgICAgICAgICAgICAgICAuZmlsdGVyKHQgPT4gdC5zdGF0dXMgPT09IFRyYW5zYWN0aW9uU3RhdHVzLkVycm9yIHx8IHQuZGlkUHJldmlvdXNseUZhaWwpXG4gICAgICAgICAgICAgICAgLm1hcCgodCwgaikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBsZXQgYnV0dG9uID0gPFNwaW5uZXIgdz17MTl9IGg9ezE5fSAvPjtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHQuc3RhdHVzID09PSBUcmFuc2FjdGlvblN0YXR1cy5FcnJvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uID0gKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uIGtpbmQ9XCJsaW5rXCIgb25DbGljaz17KCkgPT4gdC5ydW4oKX0+eyBfdChcIlJlc2VuZFwiKSB9PC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9TZXJ2ZXJPZmZsaW5lRGlhbG9nX2NvbnRlbnRfY29udGV4dF90eG5cIiBrZXk9e2B0eG4tJHtqfWB9PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT1cIm14X1NlcnZlck9mZmxpbmVEaWFsb2dfY29udGVudF9jb250ZXh0X3R4bl9kZXNjXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgdC5hdWRpdE5hbWUgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvc3Bhbj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IGJ1dHRvbiB9XG4gICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9TZXJ2ZXJPZmZsaW5lRGlhbG9nX2NvbnRlbnRfY29udGV4dFwiIGtleT17YGNvbnRleHQtJHtpfWB9PlxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X1NlcnZlck9mZmxpbmVEaWFsb2dfY29udGVudF9jb250ZXh0X3RpbWVzdGFtcFwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBmb3JtYXRUaW1lKGMuZmlyc3RGYWlsZWRUaW1lLCBTZXR0aW5nc1N0b3JlLmdldFZhbHVlKFwic2hvd1R3ZWx2ZUhvdXJUaW1lc3RhbXBzXCIpKSB9XG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X1NlcnZlck9mZmxpbmVEaWFsb2dfY29udGVudF9jb250ZXh0X3RpbWVsaW5lXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICB7IGhlYWRlciB9XG4gICAgICAgICAgICAgICAgICAgICAgICB7IGVudHJpZXMgfVxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyByZW5kZXIoKSB7XG4gICAgICAgIGxldCB0aW1lbGluZSA9IHRoaXMucmVuZGVyVGltZWxpbmUoKS5maWx0ZXIoYyA9PiAhIWMpOyAvLyByZW1vdmUgbnVsbHMgZm9yIG5leHQgY2hlY2tcbiAgICAgICAgaWYgKHRpbWVsaW5lLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgdGltZWxpbmUgPSBbPGRpdiBrZXk9ezF9PnsgX3QoXCJZb3UncmUgYWxsIGNhdWdodCB1cC5cIikgfTwvZGl2Pl07XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzZXJ2ZXJOYW1lID0gTWF0cml4Q2xpZW50UGVnLmdldEhvbWVzZXJ2ZXJOYW1lKCk7XG4gICAgICAgIHJldHVybiA8QmFzZURpYWxvZyB0aXRsZT17X3QoXCJTZXJ2ZXIgaXNuJ3QgcmVzcG9uZGluZ1wiKX1cbiAgICAgICAgICAgIGNsYXNzTmFtZT0nbXhfU2VydmVyT2ZmbGluZURpYWxvZydcbiAgICAgICAgICAgIGNvbnRlbnRJZD0nbXhfRGlhbG9nX2NvbnRlbnQnXG4gICAgICAgICAgICBvbkZpbmlzaGVkPXt0aGlzLnByb3BzLm9uRmluaXNoZWR9XG4gICAgICAgICAgICBoYXNDYW5jZWw9e3RydWV9XG4gICAgICAgID5cbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfU2VydmVyT2ZmbGluZURpYWxvZ19jb250ZW50XCI+XG4gICAgICAgICAgICAgICAgPHA+eyBfdChcbiAgICAgICAgICAgICAgICAgICAgXCJZb3VyIHNlcnZlciBpc24ndCByZXNwb25kaW5nIHRvIHNvbWUgb2YgeW91ciByZXF1ZXN0cy4gXCIgK1xuICAgICAgICAgICAgICAgICAgICBcIkJlbG93IGFyZSBzb21lIG9mIHRoZSBtb3N0IGxpa2VseSByZWFzb25zLlwiLFxuICAgICAgICAgICAgICAgICkgfTwvcD5cbiAgICAgICAgICAgICAgICA8dWw+XG4gICAgICAgICAgICAgICAgICAgIDxsaT57IF90KFwiVGhlIHNlcnZlciAoJShzZXJ2ZXJOYW1lKXMpIHRvb2sgdG9vIGxvbmcgdG8gcmVzcG9uZC5cIiwgeyBzZXJ2ZXJOYW1lIH0pIH08L2xpPlxuICAgICAgICAgICAgICAgICAgICA8bGk+eyBfdChcIllvdXIgZmlyZXdhbGwgb3IgYW50aS12aXJ1cyBpcyBibG9ja2luZyB0aGUgcmVxdWVzdC5cIikgfTwvbGk+XG4gICAgICAgICAgICAgICAgICAgIDxsaT57IF90KFwiQSBicm93c2VyIGV4dGVuc2lvbiBpcyBwcmV2ZW50aW5nIHRoZSByZXF1ZXN0LlwiKSB9PC9saT5cbiAgICAgICAgICAgICAgICAgICAgPGxpPnsgX3QoXCJUaGUgc2VydmVyIGlzIG9mZmxpbmUuXCIpIH08L2xpPlxuICAgICAgICAgICAgICAgICAgICA8bGk+eyBfdChcIlRoZSBzZXJ2ZXIgaGFzIGRlbmllZCB5b3VyIHJlcXVlc3QuXCIpIH08L2xpPlxuICAgICAgICAgICAgICAgICAgICA8bGk+eyBfdChcIllvdXIgYXJlYSBpcyBleHBlcmllbmNpbmcgZGlmZmljdWx0aWVzIGNvbm5lY3RpbmcgdG8gdGhlIGludGVybmV0LlwiKSB9PC9saT5cbiAgICAgICAgICAgICAgICAgICAgPGxpPnsgX3QoXCJBIGNvbm5lY3Rpb24gZXJyb3Igb2NjdXJyZWQgd2hpbGUgdHJ5aW5nIHRvIGNvbnRhY3QgdGhlIHNlcnZlci5cIikgfTwvbGk+XG4gICAgICAgICAgICAgICAgICAgIDxsaT57IF90KFwiVGhlIHNlcnZlciBpcyBub3QgY29uZmlndXJlZCB0byBpbmRpY2F0ZSB3aGF0IHRoZSBwcm9ibGVtIGlzIChDT1JTKS5cIikgfTwvbGk+XG4gICAgICAgICAgICAgICAgPC91bD5cbiAgICAgICAgICAgICAgICA8aHIgLz5cbiAgICAgICAgICAgICAgICA8aDI+eyBfdChcIlJlY2VudCBjaGFuZ2VzIHRoYXQgaGF2ZSBub3QgeWV0IGJlZW4gcmVjZWl2ZWRcIikgfTwvaDI+XG4gICAgICAgICAgICAgICAgeyB0aW1lbGluZSB9XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgPC9CYXNlRGlhbG9nPjtcbiAgICB9XG59XG4iXX0=