"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _languageHandler = require("../../../languageHandler");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _RoomUpgrade = require("../../../utils/RoomUpgrade");

var _BaseDialog = _interopRequireDefault(require("./BaseDialog"));

var _ErrorDialog = _interopRequireDefault(require("./ErrorDialog"));

var _DialogButtons = _interopRequireDefault(require("../elements/DialogButtons"));

var _Spinner = _interopRequireDefault(require("../elements/Spinner"));

var _dec, _class;

let RoomUpgradeDialog = (_dec = (0, _replaceableComponent.replaceableComponent)("views.dialogs.RoomUpgradeDialog"), _dec(_class = class RoomUpgradeDialog extends _react.default.Component {
  constructor(...args) {
    super(...args);
    (0, _defineProperty2.default)(this, "targetVersion", void 0);
    (0, _defineProperty2.default)(this, "state", {
      busy: true
    });
    (0, _defineProperty2.default)(this, "onCancelClick", () => {
      this.props.onFinished(false);
    });
    (0, _defineProperty2.default)(this, "onUpgradeClick", () => {
      this.setState({
        busy: true
      });
      (0, _RoomUpgrade.upgradeRoom)(this.props.room, this.targetVersion, false, false).then(() => {
        this.props.onFinished(true);
      }).catch(err => {
        _Modal.default.createTrackedDialog('Failed to upgrade room', '', _ErrorDialog.default, {
          title: (0, _languageHandler._t)("Failed to upgrade room"),
          description: err && err.message ? err.message : (0, _languageHandler._t)("The room upgrade could not be completed")
        });
      }).finally(() => {
        this.setState({
          busy: false
        });
      });
    });
  }

  async componentDidMount() {
    const recommended = await this.props.room.getRecommendedVersion();
    this.targetVersion = recommended.version;
    this.setState({
      busy: false
    });
  }

  render() {
    let buttons;

    if (this.state.busy) {
      buttons = /*#__PURE__*/_react.default.createElement(_Spinner.default, null);
    } else {
      buttons = /*#__PURE__*/_react.default.createElement(_DialogButtons.default, {
        primaryButton: (0, _languageHandler._t)('Upgrade this room to version %(version)s', {
          version: this.targetVersion
        }),
        primaryButtonClass: "danger",
        hasCancel: true,
        onPrimaryButtonClick: this.onUpgradeClick,
        onCancel: this.onCancelClick
      });
    }

    return /*#__PURE__*/_react.default.createElement(_BaseDialog.default, {
      className: "mx_RoomUpgradeDialog",
      onFinished: this.props.onFinished,
      title: (0, _languageHandler._t)("Upgrade Room Version"),
      contentId: "mx_Dialog_content",
      hasCancel: true
    }, /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Upgrading this room requires closing down the current " + "instance of the room and creating a new room in its place. " + "To give room members the best possible experience, we will:")), /*#__PURE__*/_react.default.createElement("ol", null, /*#__PURE__*/_react.default.createElement("li", null, (0, _languageHandler._t)("Create a new room with the same name, description and avatar")), /*#__PURE__*/_react.default.createElement("li", null, (0, _languageHandler._t)("Update any local room aliases to point to the new room")), /*#__PURE__*/_react.default.createElement("li", null, (0, _languageHandler._t)("Stop users from speaking in the old version of the room, " + "and post a message advising users to move to the new room")), /*#__PURE__*/_react.default.createElement("li", null, (0, _languageHandler._t)("Put a link back to the old room at the start of the new room " + "so people can see old messages"))), buttons);
  }

}) || _class);
exports.default = RoomUpgradeDialog;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvUm9vbVVwZ3JhZGVEaWFsb2cudHN4Il0sIm5hbWVzIjpbIlJvb21VcGdyYWRlRGlhbG9nIiwiUmVhY3QiLCJDb21wb25lbnQiLCJidXN5IiwicHJvcHMiLCJvbkZpbmlzaGVkIiwic2V0U3RhdGUiLCJyb29tIiwidGFyZ2V0VmVyc2lvbiIsInRoZW4iLCJjYXRjaCIsImVyciIsIk1vZGFsIiwiY3JlYXRlVHJhY2tlZERpYWxvZyIsIkVycm9yRGlhbG9nIiwidGl0bGUiLCJkZXNjcmlwdGlvbiIsIm1lc3NhZ2UiLCJmaW5hbGx5IiwiY29tcG9uZW50RGlkTW91bnQiLCJyZWNvbW1lbmRlZCIsImdldFJlY29tbWVuZGVkVmVyc2lvbiIsInZlcnNpb24iLCJyZW5kZXIiLCJidXR0b25zIiwic3RhdGUiLCJvblVwZ3JhZGVDbGljayIsIm9uQ2FuY2VsQ2xpY2siXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUdBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOzs7O0lBV3FCQSxpQixXQURwQixnREFBcUIsaUNBQXJCLEMsZ0JBQUQsTUFDcUJBLGlCQURyQixTQUMrQ0MsZUFBTUMsU0FEckQsQ0FDK0U7QUFBQTtBQUFBO0FBQUE7QUFBQSxpREFHbkU7QUFDSkMsTUFBQUEsSUFBSSxFQUFFO0FBREYsS0FIbUU7QUFBQSx5REFhbkQsTUFBWTtBQUNoQyxXQUFLQyxLQUFMLENBQVdDLFVBQVgsQ0FBc0IsS0FBdEI7QUFDSCxLQWYwRTtBQUFBLDBEQWlCbEQsTUFBWTtBQUNqQyxXQUFLQyxRQUFMLENBQWM7QUFBRUgsUUFBQUEsSUFBSSxFQUFFO0FBQVIsT0FBZDtBQUNBLG9DQUFZLEtBQUtDLEtBQUwsQ0FBV0csSUFBdkIsRUFBNkIsS0FBS0MsYUFBbEMsRUFBaUQsS0FBakQsRUFBd0QsS0FBeEQsRUFBK0RDLElBQS9ELENBQW9FLE1BQU07QUFDdEUsYUFBS0wsS0FBTCxDQUFXQyxVQUFYLENBQXNCLElBQXRCO0FBQ0gsT0FGRCxFQUVHSyxLQUZILENBRVVDLEdBQUQsSUFBUztBQUNkQyx1QkFBTUMsbUJBQU4sQ0FBMEIsd0JBQTFCLEVBQW9ELEVBQXBELEVBQXdEQyxvQkFBeEQsRUFBcUU7QUFDakVDLFVBQUFBLEtBQUssRUFBRSx5QkFBRyx3QkFBSCxDQUQwRDtBQUVqRUMsVUFBQUEsV0FBVyxFQUFJTCxHQUFHLElBQUlBLEdBQUcsQ0FBQ00sT0FBWixHQUF1Qk4sR0FBRyxDQUFDTSxPQUEzQixHQUFxQyx5QkFBRyx5Q0FBSDtBQUZjLFNBQXJFO0FBSUgsT0FQRCxFQU9HQyxPQVBILENBT1csTUFBTTtBQUNiLGFBQUtaLFFBQUwsQ0FBYztBQUFFSCxVQUFBQSxJQUFJLEVBQUU7QUFBUixTQUFkO0FBQ0gsT0FURDtBQVVILEtBN0IwRTtBQUFBOztBQU9wRCxRQUFqQmdCLGlCQUFpQixHQUFHO0FBQ3RCLFVBQU1DLFdBQVcsR0FBRyxNQUFNLEtBQUtoQixLQUFMLENBQVdHLElBQVgsQ0FBZ0JjLHFCQUFoQixFQUExQjtBQUNBLFNBQUtiLGFBQUwsR0FBcUJZLFdBQVcsQ0FBQ0UsT0FBakM7QUFDQSxTQUFLaEIsUUFBTCxDQUFjO0FBQUVILE1BQUFBLElBQUksRUFBRTtBQUFSLEtBQWQ7QUFDSDs7QUFvQkRvQixFQUFBQSxNQUFNLEdBQUc7QUFDTCxRQUFJQyxPQUFKOztBQUNBLFFBQUksS0FBS0MsS0FBTCxDQUFXdEIsSUFBZixFQUFxQjtBQUNqQnFCLE1BQUFBLE9BQU8sZ0JBQUcsNkJBQUMsZ0JBQUQsT0FBVjtBQUNILEtBRkQsTUFFTztBQUNIQSxNQUFBQSxPQUFPLGdCQUFHLDZCQUFDLHNCQUFEO0FBQ04sUUFBQSxhQUFhLEVBQUUseUJBQUcsMENBQUgsRUFBK0M7QUFBRUYsVUFBQUEsT0FBTyxFQUFFLEtBQUtkO0FBQWhCLFNBQS9DLENBRFQ7QUFFTixRQUFBLGtCQUFrQixFQUFDLFFBRmI7QUFHTixRQUFBLFNBQVMsRUFBRSxJQUhMO0FBSU4sUUFBQSxvQkFBb0IsRUFBRSxLQUFLa0IsY0FKckI7QUFLTixRQUFBLFFBQVEsRUFBRSxLQUFLQztBQUxULFFBQVY7QUFPSDs7QUFFRCx3QkFDSSw2QkFBQyxtQkFBRDtBQUNJLE1BQUEsU0FBUyxFQUFDLHNCQURkO0FBRUksTUFBQSxVQUFVLEVBQUUsS0FBS3ZCLEtBQUwsQ0FBV0MsVUFGM0I7QUFHSSxNQUFBLEtBQUssRUFBRSx5QkFBRyxzQkFBSCxDQUhYO0FBSUksTUFBQSxTQUFTLEVBQUMsbUJBSmQ7QUFLSSxNQUFBLFNBQVMsRUFBRTtBQUxmLG9CQU9JLHdDQUNNLHlCQUNFLDJEQUNBLDZEQURBLEdBRUEsNkRBSEYsQ0FETixDQVBKLGVBY0ksc0RBQ0kseUNBQU0seUJBQUcsOERBQUgsQ0FBTixDQURKLGVBRUkseUNBQU0seUJBQUcsd0RBQUgsQ0FBTixDQUZKLGVBR0kseUNBQU0seUJBQUcsOERBQ0wsMkRBREUsQ0FBTixDQUhKLGVBS0kseUNBQU0seUJBQUcsa0VBQ0wsZ0NBREUsQ0FBTixDQUxKLENBZEosRUFzQk1tQixPQXRCTixDQURKO0FBMEJIOztBQXZFMEUsQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxOCAtIDIwMjEgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgUm9vbSB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvcm9vbVwiO1xuXG5pbXBvcnQgTW9kYWwgZnJvbSAnLi4vLi4vLi4vTW9kYWwnO1xuaW1wb3J0IHsgX3QgfSBmcm9tICcuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXInO1xuaW1wb3J0IHsgcmVwbGFjZWFibGVDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvcmVwbGFjZWFibGVDb21wb25lbnRcIjtcbmltcG9ydCB7IHVwZ3JhZGVSb29tIH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL1Jvb21VcGdyYWRlXCI7XG5pbXBvcnQgeyBJRGlhbG9nUHJvcHMgfSBmcm9tIFwiLi9JRGlhbG9nUHJvcHNcIjtcbmltcG9ydCBCYXNlRGlhbG9nIGZyb20gXCIuL0Jhc2VEaWFsb2dcIjtcbmltcG9ydCBFcnJvckRpYWxvZyBmcm9tICcuL0Vycm9yRGlhbG9nJztcbmltcG9ydCBEaWFsb2dCdXR0b25zIGZyb20gJy4uL2VsZW1lbnRzL0RpYWxvZ0J1dHRvbnMnO1xuaW1wb3J0IFNwaW5uZXIgZnJvbSBcIi4uL2VsZW1lbnRzL1NwaW5uZXJcIjtcblxuaW50ZXJmYWNlIElQcm9wcyBleHRlbmRzIElEaWFsb2dQcm9wcyB7XG4gICAgcm9vbTogUm9vbTtcbn1cblxuaW50ZXJmYWNlIElTdGF0ZSB7XG4gICAgYnVzeTogYm9vbGVhbjtcbn1cblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3MuZGlhbG9ncy5Sb29tVXBncmFkZURpYWxvZ1wiKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUm9vbVVwZ3JhZGVEaWFsb2cgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8SVByb3BzLCBJU3RhdGU+IHtcbiAgICBwcml2YXRlIHRhcmdldFZlcnNpb246IHN0cmluZztcblxuICAgIHN0YXRlID0ge1xuICAgICAgICBidXN5OiB0cnVlLFxuICAgIH07XG5cbiAgICBhc3luYyBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICAgICAgY29uc3QgcmVjb21tZW5kZWQgPSBhd2FpdCB0aGlzLnByb3BzLnJvb20uZ2V0UmVjb21tZW5kZWRWZXJzaW9uKCk7XG4gICAgICAgIHRoaXMudGFyZ2V0VmVyc2lvbiA9IHJlY29tbWVuZGVkLnZlcnNpb247XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBidXN5OiBmYWxzZSB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uQ2FuY2VsQ2xpY2sgPSAoKTogdm9pZCA9PiB7XG4gICAgICAgIHRoaXMucHJvcHMub25GaW5pc2hlZChmYWxzZSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25VcGdyYWRlQ2xpY2sgPSAoKTogdm9pZCA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBidXN5OiB0cnVlIH0pO1xuICAgICAgICB1cGdyYWRlUm9vbSh0aGlzLnByb3BzLnJvb20sIHRoaXMudGFyZ2V0VmVyc2lvbiwgZmFsc2UsIGZhbHNlKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMucHJvcHMub25GaW5pc2hlZCh0cnVlKTtcbiAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZygnRmFpbGVkIHRvIHVwZ3JhZGUgcm9vbScsICcnLCBFcnJvckRpYWxvZywge1xuICAgICAgICAgICAgICAgIHRpdGxlOiBfdChcIkZhaWxlZCB0byB1cGdyYWRlIHJvb21cIiksXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICgoZXJyICYmIGVyci5tZXNzYWdlKSA/IGVyci5tZXNzYWdlIDogX3QoXCJUaGUgcm9vbSB1cGdyYWRlIGNvdWxkIG5vdCBiZSBjb21wbGV0ZWRcIikpLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pLmZpbmFsbHkoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGJ1c3k6IGZhbHNlIH0pO1xuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgcmVuZGVyKCkge1xuICAgICAgICBsZXQgYnV0dG9ucztcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuYnVzeSkge1xuICAgICAgICAgICAgYnV0dG9ucyA9IDxTcGlubmVyIC8+O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYnV0dG9ucyA9IDxEaWFsb2dCdXR0b25zXG4gICAgICAgICAgICAgICAgcHJpbWFyeUJ1dHRvbj17X3QoJ1VwZ3JhZGUgdGhpcyByb29tIHRvIHZlcnNpb24gJSh2ZXJzaW9uKXMnLCB7IHZlcnNpb246IHRoaXMudGFyZ2V0VmVyc2lvbiB9KX1cbiAgICAgICAgICAgICAgICBwcmltYXJ5QnV0dG9uQ2xhc3M9XCJkYW5nZXJcIlxuICAgICAgICAgICAgICAgIGhhc0NhbmNlbD17dHJ1ZX1cbiAgICAgICAgICAgICAgICBvblByaW1hcnlCdXR0b25DbGljaz17dGhpcy5vblVwZ3JhZGVDbGlja31cbiAgICAgICAgICAgICAgICBvbkNhbmNlbD17dGhpcy5vbkNhbmNlbENsaWNrfVxuICAgICAgICAgICAgLz47XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPEJhc2VEaWFsb2dcbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9Sb29tVXBncmFkZURpYWxvZ1wiXG4gICAgICAgICAgICAgICAgb25GaW5pc2hlZD17dGhpcy5wcm9wcy5vbkZpbmlzaGVkfVxuICAgICAgICAgICAgICAgIHRpdGxlPXtfdChcIlVwZ3JhZGUgUm9vbSBWZXJzaW9uXCIpfVxuICAgICAgICAgICAgICAgIGNvbnRlbnRJZD0nbXhfRGlhbG9nX2NvbnRlbnQnXG4gICAgICAgICAgICAgICAgaGFzQ2FuY2VsPXt0cnVlfVxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgIDxwPlxuICAgICAgICAgICAgICAgICAgICB7IF90KFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJVcGdyYWRpbmcgdGhpcyByb29tIHJlcXVpcmVzIGNsb3NpbmcgZG93biB0aGUgY3VycmVudCBcIiArXG4gICAgICAgICAgICAgICAgICAgICAgICBcImluc3RhbmNlIG9mIHRoZSByb29tIGFuZCBjcmVhdGluZyBhIG5ldyByb29tIGluIGl0cyBwbGFjZS4gXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJUbyBnaXZlIHJvb20gbWVtYmVycyB0aGUgYmVzdCBwb3NzaWJsZSBleHBlcmllbmNlLCB3ZSB3aWxsOlwiLFxuICAgICAgICAgICAgICAgICAgICApIH1cbiAgICAgICAgICAgICAgICA8L3A+XG4gICAgICAgICAgICAgICAgPG9sPlxuICAgICAgICAgICAgICAgICAgICA8bGk+eyBfdChcIkNyZWF0ZSBhIG5ldyByb29tIHdpdGggdGhlIHNhbWUgbmFtZSwgZGVzY3JpcHRpb24gYW5kIGF2YXRhclwiKSB9PC9saT5cbiAgICAgICAgICAgICAgICAgICAgPGxpPnsgX3QoXCJVcGRhdGUgYW55IGxvY2FsIHJvb20gYWxpYXNlcyB0byBwb2ludCB0byB0aGUgbmV3IHJvb21cIikgfTwvbGk+XG4gICAgICAgICAgICAgICAgICAgIDxsaT57IF90KFwiU3RvcCB1c2VycyBmcm9tIHNwZWFraW5nIGluIHRoZSBvbGQgdmVyc2lvbiBvZiB0aGUgcm9vbSwgXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJhbmQgcG9zdCBhIG1lc3NhZ2UgYWR2aXNpbmcgdXNlcnMgdG8gbW92ZSB0byB0aGUgbmV3IHJvb21cIikgfTwvbGk+XG4gICAgICAgICAgICAgICAgICAgIDxsaT57IF90KFwiUHV0IGEgbGluayBiYWNrIHRvIHRoZSBvbGQgcm9vbSBhdCB0aGUgc3RhcnQgb2YgdGhlIG5ldyByb29tIFwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwic28gcGVvcGxlIGNhbiBzZWUgb2xkIG1lc3NhZ2VzXCIpIH08L2xpPlxuICAgICAgICAgICAgICAgIDwvb2w+XG4gICAgICAgICAgICAgICAgeyBidXR0b25zIH1cbiAgICAgICAgICAgIDwvQmFzZURpYWxvZz5cbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=