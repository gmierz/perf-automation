"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _languageHandler = require("../../../languageHandler");

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _InteractiveAuth = _interopRequireWildcard(require("../../structures/InteractiveAuth"));

var _InteractiveAuthEntryComponents = require("../auth/InteractiveAuthEntryComponents");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _BaseDialog = _interopRequireDefault(require("./BaseDialog"));

var _dec, _class;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

let InteractiveAuthDialog = (_dec = (0, _replaceableComponent.replaceableComponent)("views.dialogs.InteractiveAuthDialog"), _dec(_class = class InteractiveAuthDialog extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onAuthFinished", (success, result) => {
      if (success) {
        this.props.onFinished(true, result);
      } else {
        if (result === _InteractiveAuth.ERROR_USER_CANCELLED) {
          this.props.onFinished(false, null);
        } else {
          this.setState({
            authError: result
          });
        }
      }
    });
    (0, _defineProperty2.default)(this, "onUpdateStagePhase", (newStage, newPhase) => {
      // We copy the stage and stage phase params into state for title selection in render()
      this.setState({
        uiaStage: newStage,
        uiaStagePhase: newPhase
      });
    });
    (0, _defineProperty2.default)(this, "onDismissClick", () => {
      this.props.onFinished(false);
    });
    this.state = {
      authError: null,
      // See _onUpdateStagePhase()
      uiaStage: null,
      uiaStagePhase: null
    };
  }

  getDefaultDialogAesthetics() {
    const ssoAesthetics = {
      [_InteractiveAuthEntryComponents.SSOAuthEntry.PHASE_PREAUTH]: {
        title: (0, _languageHandler._t)("Use Single Sign On to continue"),
        body: (0, _languageHandler._t)("To continue, use Single Sign On to prove your identity."),
        continueText: (0, _languageHandler._t)("Single Sign On"),
        continueKind: "primary"
      },
      [_InteractiveAuthEntryComponents.SSOAuthEntry.PHASE_POSTAUTH]: {
        title: (0, _languageHandler._t)("Confirm to continue"),
        body: (0, _languageHandler._t)("Click the button below to confirm your identity."),
        continueText: (0, _languageHandler._t)("Confirm"),
        continueKind: "primary"
      }
    };
    return {
      [_InteractiveAuthEntryComponents.SSOAuthEntry.LOGIN_TYPE]: ssoAesthetics,
      [_InteractiveAuthEntryComponents.SSOAuthEntry.UNSTABLE_LOGIN_TYPE]: ssoAesthetics
    };
  }

  render() {
    // Let's pick a title, body, and other params text that we'll show to the user. The order
    // is most specific first, so stagePhase > our props > defaults.
    let title = this.state.authError ? 'Error' : this.props.title || (0, _languageHandler._t)('Authentication');
    let body = this.state.authError ? null : this.props.body;
    let continueText = null;
    let continueKind = null;
    const dialogAesthetics = this.props.aestheticsForStagePhases || this.getDefaultDialogAesthetics();

    if (!this.state.authError && dialogAesthetics) {
      if (dialogAesthetics[this.state.uiaStage]) {
        const aesthetics = dialogAesthetics[this.state.uiaStage][this.state.uiaStagePhase];
        if (aesthetics && aesthetics.title) title = aesthetics.title;
        if (aesthetics && aesthetics.body) body = aesthetics.body;
        if (aesthetics && aesthetics.continueText) continueText = aesthetics.continueText;
        if (aesthetics && aesthetics.continueKind) continueKind = aesthetics.continueKind;
      }
    }

    let content;

    if (this.state.authError) {
      content = /*#__PURE__*/_react.default.createElement("div", {
        id: "mx_Dialog_content"
      }, /*#__PURE__*/_react.default.createElement("div", {
        role: "alert"
      }, this.state.authError.message || this.state.authError.toString()), /*#__PURE__*/_react.default.createElement("br", null), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        onClick: this.onDismissClick,
        className: "mx_GeneralButton",
        autoFocus: true
      }, (0, _languageHandler._t)("Dismiss")));
    } else {
      content = /*#__PURE__*/_react.default.createElement("div", {
        id: "mx_Dialog_content"
      }, body, /*#__PURE__*/_react.default.createElement(_InteractiveAuth.default, {
        matrixClient: this.props.matrixClient,
        authData: this.props.authData,
        makeRequest: this.props.makeRequest,
        onAuthFinished: this.onAuthFinished,
        onStagePhaseChange: this.onUpdateStagePhase,
        continueText: continueText,
        continueKind: continueKind
      }));
    }

    return /*#__PURE__*/_react.default.createElement(_BaseDialog.default, {
      className: "mx_InteractiveAuthDialog",
      onFinished: this.props.onFinished,
      title: title,
      contentId: "mx_Dialog_content"
    }, content);
  }

}) || _class);
exports.default = InteractiveAuthDialog;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvSW50ZXJhY3RpdmVBdXRoRGlhbG9nLnRzeCJdLCJuYW1lcyI6WyJJbnRlcmFjdGl2ZUF1dGhEaWFsb2ciLCJSZWFjdCIsIkNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJzdWNjZXNzIiwicmVzdWx0Iiwib25GaW5pc2hlZCIsIkVSUk9SX1VTRVJfQ0FOQ0VMTEVEIiwic2V0U3RhdGUiLCJhdXRoRXJyb3IiLCJuZXdTdGFnZSIsIm5ld1BoYXNlIiwidWlhU3RhZ2UiLCJ1aWFTdGFnZVBoYXNlIiwic3RhdGUiLCJnZXREZWZhdWx0RGlhbG9nQWVzdGhldGljcyIsInNzb0Flc3RoZXRpY3MiLCJTU09BdXRoRW50cnkiLCJQSEFTRV9QUkVBVVRIIiwidGl0bGUiLCJib2R5IiwiY29udGludWVUZXh0IiwiY29udGludWVLaW5kIiwiUEhBU0VfUE9TVEFVVEgiLCJMT0dJTl9UWVBFIiwiVU5TVEFCTEVfTE9HSU5fVFlQRSIsInJlbmRlciIsImRpYWxvZ0Flc3RoZXRpY3MiLCJhZXN0aGV0aWNzRm9yU3RhZ2VQaGFzZXMiLCJhZXN0aGV0aWNzIiwiY29udGVudCIsIm1lc3NhZ2UiLCJ0b1N0cmluZyIsIm9uRGlzbWlzc0NsaWNrIiwibWF0cml4Q2xpZW50IiwiYXV0aERhdGEiLCJtYWtlUmVxdWVzdCIsIm9uQXV0aEZpbmlzaGVkIiwib25VcGRhdGVTdGFnZVBoYXNlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWtCQTs7QUFFQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7Ozs7Ozs7SUE0RHFCQSxxQixXQURwQixnREFBcUIscUNBQXJCLEMsZ0JBQUQsTUFDcUJBLHFCQURyQixTQUNtREMsZUFBTUMsU0FEekQsQ0FDbUY7QUFDL0VDLEVBQUFBLFdBQVcsQ0FBQ0MsS0FBRCxFQUFnQjtBQUN2QixVQUFNQSxLQUFOO0FBRHVCLDBEQWtDRixDQUFDQyxPQUFELEVB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QUVqQixZQU5sQjtBQU9JLFFBQUEsWUFBWSxFQUFFQztBQVBsQixRQUZKLENBREo7QUFjSDs7QUFFRCx3QkFDSSw2QkFBQyxtQkFBRDtBQUFZLE1BQUEsU0FBUyxFQUFDLDBCQUF0QjtBQUNJLE1BQUEsVUFBVSxFQUFFLEtBQUtuQixLQUFMLENBQVdHLFVBRDNCO0FBRUksTUFBQSxLQUFLLEVBQUVhLEtBRlg7QUFHSSxNQUFBLFNBQVMsRUFBQztBQUhkLE9BS01XLE9BTE4sQ0FESjtBQVNIOztBQXJIOEUsQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNiBPcGVuTWFya2V0IEx0ZFxuQ29weXJpZ2h0IDIwMTcgVmVjdG9yIENyZWF0aW9ucyBMdGRcbkNvcHlyaWdodCAyMDIwIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcblxuaW1wb3J0IHsgX3QgfSBmcm9tICcuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXInO1xuXG5pbXBvcnQgQWNjZXNzaWJsZUJ1dHRvbiBmcm9tICcuLi9lbGVtZW50cy9BY2Nlc3NpYmxlQnV0dG9uJztcbmltcG9ydCBJbnRlcmFjdGl2ZUF1dGgsIHsgRVJST1JfVVNFUl9DQU5DRUxMRUQgfSBmcm9tIFwiLi4vLi4vc3RydWN0dXJlcy9JbnRlcmFjdGl2ZUF1dGhcIjtcbmltcG9ydCB7IFNTT0F1dGhFbnRyeSB9IGZyb20gXCIuLi9hdXRoL0ludGVyYWN0aXZlQXV0aEVudHJ5Q29tcG9uZW50c1wiO1xuaW1wb3J0IHsgcmVwbGFjZWFibGVDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvcmVwbGFjZWFibGVDb21wb25lbnRcIjtcbmltcG9ydCB7IE1hdHJpeENsaWVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9jbGllbnRcIjtcbmltcG9ydCBCYXNlRGlhbG9nIGZyb20gXCIuL0Jhc2VEaWFsb2dcIjtcbmltcG9ydCB7IElBdXRoRGF0YSB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9pbnRlcmFjdGl2ZS1hdXRoXCI7XG5pbXBvcnQgeyBJRGlhbG9nUHJvcHMgfSBmcm9tIFwiLi9JRGlhbG9nUHJvcHNcIjtcblxuaW50ZXJmYWNlIElEaWFsb2dBZXN0aGV0aWNzIHtcbiAgICBbeDogc3RyaW5nXToge1xuICAgICAgICBbeDogbnVtYmVyXToge1xuICAgICAgICAgICAgdGl0bGU6IHN0cmluZztcbiAgICAgICAgICAgIGJvZHk6IHN0cmluZztcbiAgICAgICAgICAgIGNvbnRpbnVlVGV4dDogc3RyaW5nO1xuICAgICAgICAgICAgY29udGludWVLaW5kOiBzdHJpbmc7XG4gICAgICAgIH07XG4gICAgfTtcbn1cblxuaW50ZXJmYWNlIElQcm9wcyBleHRlbmRzIElEaWFsb2dQcm9wcyB7XG4gICAgLy8gbWF0cml4IGNsaWVudCB0byB1c2UgZm9yIFVJIGF1dGggcmVxdWVzdHNcbiAgICBtYXRyaXhDbGllbnQ6IE1hdHJpeENsaWVudDtcblxuICAgIC8vIHJlc3BvbnNlIGZyb20gaW5pdGlhbCByZXF1ZXN0LiBJZiBub3Qgc3VwcGxpZWQsIHdpbGwgZG8gYSByZXF1ZXN0IG9uXG4gICAgLy8gbW91bnQuXG4gICAgYXV0aERhdGE/OiBJQXV0aERhdGE7XG5cbiAgICAvLyBjYWxsYmFja1xuICAgIG1ha2VSZXF1ZXN0OiAoYXV0aDogSUF1dGhEYXRhKSA9PiBQcm9taXNlPElBdXRoRGF0YT47XG5cbiAgICAvLyBPcHRpb25hbCB0aXRsZSBhbmQgYm9keSB0byBzaG93IHdoZW4gbm90IHNob3dpbmcgYSBwYXJ0aWN1bGFyIHN0YWdlXG4gICAgdGl0bGU/OiBzdHJpbmc7XG4gICAgYm9keT86IHN0cmluZztcblxuICAgIC8vIE9wdGlvbmFsIHRpdGxlIGFuZCBib2R5IHBhaXJzIGZvciBwYXJ0aWN1bGFyIHN0YWdlcyBhbmQgcGhhc2VzIHdpdGhpblxuICAgIC8vIHRob3NlIHN0YWdlcy4gT2JqZWN0IHN0cnVjdHVyZS9leGFtcGxlIGlzOlxuICAgIC8vIHtcbiAgICAvLyAgICAgXCJvcmcuZXhhbXBsZS5zdGFnZV90eXBlXCI6IHtcbiAgICAvLyAgICAgICAgIDE6IHtcbiAgICAvLyAgICAgICAgICAgICBcImJvZHlcIjogXCJUaGlzIGlzIGEgYm9keSBmb3IgcGhhc2UgMVwiIG9mIG9yZy5leGFtcGxlLnN0YWdlX3R5cGUsXG4gICAgLy8gICAgICAgICAgICAgXCJ0aXRsZVwiOiBcIlRpdGxlIGZvciBwaGFzZSAxIG9mIG9yZy5leGFtcGxlLnN0YWdlX3R5cGVcIlxuICAgIC8vICAgICAgICAgfSxcbiAgICAvLyAgICAgICAgIDI6IHtcbiAgICAvLyAgICAgICAgICAgICBcImJvZHlcIjogXCJUaGlzIGlzIGEgYm9keSBmb3IgcGhhc2UgMiBvZiBvcmcuZXhhbXBsZS5zdGFnZV90eXBlXCIsXG4gICAgLy8gICAgICAgICAgICAgXCJ0aXRsZVwiOiBcIlRpdGxlIGZvciBwaGFzZSAyIG9mIG9yZy5leGFtcGxlLnN0YWdlX3R5cGVcIlxuICAgIC8vICAgICAgICAgICAgIFwiY29udGludWVUZXh0XCI6IFwiQ29uZmlybSBpZGVudGl0eSB3aXRoIEV4YW1wbGUgQXV0aFwiLFxuICAgIC8vICAgICAgICAgICAgIFwiY29udGludWVLaW5kXCI6IFwiZGFuZ2VyXCJcbiAgICAvLyAgICAgICAgIH1cbiAgICAvLyAgICAgfVxuICAgIC8vIH1cbiAgICAvL1xuICAgIC8vIERlZmF1bHQgaXMgZGVmaW5lZCBpbiBfZ2V0RGVmYXVsdERpYWxvZ0Flc3RoZXRpY3MoKVxuICAgIGFlc3RoZXRpY3NGb3JTdGFnZVBoYXNlcz86IElEaWFsb2dBZXN0aGV0aWNzO1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBhdXRoRXJyb3I6IEVycm9yO1xuXG4gICAgLy8gU2VlIF9vblVwZGF0ZVN0YWdlUGhhc2UoKVxuICAgIHVpYVN0YWdlOiBudW1iZXIgfCBzdHJpbmc7XG4gICAgdWlhU3RhZ2VQaGFzZTogbnVtYmVyIHwgc3RyaW5nO1xufVxuXG5AcmVwbGFjZWFibGVDb21wb25lbnQoXCJ2aWV3cy5kaWFsb2dzLkludGVyYWN0aXZlQXV0aERpYWxvZ1wiKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSW50ZXJhY3RpdmVBdXRoRGlhbG9nIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PElQcm9wcywgSVN0YXRlPiB7XG4gICAgY29uc3RydWN0b3IocHJvcHM6IElQcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG5cbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIGF1dGhFcnJvcjogbnVsbCxcblxuICAgICAgICAgICAgLy8gU2VlIF9vblVwZGF0ZVN0YWdlUGhhc2UoKVxuICAgICAgICAgICAgdWlhU3RhZ2U6IG51bGwsXG4gICAgICAgICAgICB1aWFTdGFnZVBoYXNlOiBudWxsLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0RGVmYXVsdERpYWxvZ0Flc3RoZXRpY3MoKTogSURpYWxvZ0Flc3RoZXRpY3Mge1xuICAgICAgICBjb25zdCBzc29BZXN0aGV0aWNzID0ge1xuICAgICAgICAgICAgW1NTT0F1dGhFbnRyeS5QSEFTRV9QUkVBVVRIXToge1xuICAgICAgICAgICAgICAgIHRpdGxlOiBfdChcIlVzZSBTaW5nbGUgU2lnbiBPbiB0byBjb250aW51ZVwiKSxcbiAgICAgICAgICAgICAgICBib2R5OiBfdChcIlRvIGNvbnRpbnVlLCB1c2UgU2luZ2xlIFNpZ24gT24gdG8gcHJvdmUgeW91ciBpZGVudGl0eS5cIiksXG4gICAgICAgICAgICAgICAgY29udGludWVUZXh0OiBfdChcIlNpbmdsZSBTaWduIE9uXCIpLFxuICAgICAgICAgICAgICAgIGNvbnRpbnVlS2luZDogXCJwcmltYXJ5XCIsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgW1NTT0F1dGhFbnRyeS5QSEFTRV9QT1NUQVVUSF06IHtcbiAgICAgICAgICAgICAgICB0aXRsZTogX3QoXCJDb25maXJtIHRvIGNvbnRpbnVlXCIpLFxuICAgICAgICAgICAgICAgIGJvZHk6IF90KFwiQ2xpY2sgdGhlIGJ1dHRvbiBiZWxvdyB0byBjb25maXJtIHlvdXIgaWRlbnRpdHkuXCIpLFxuICAgICAgICAgICAgICAgIGNvbnRpbnVlVGV4dDogX3QoXCJDb25maXJtXCIpLFxuICAgICAgICAgICAgICAgIGNvbnRpbnVlS2luZDogXCJwcmltYXJ5XCIsXG4gICAgICAgICAgICB9LFxuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBbU1NPQXV0aEVudHJ5LkxPR0lOX1RZUEVdOiBzc29BZXN0aGV0aWNzLFxuICAgICAgICAgICAgW1NTT0F1dGhFbnRyeS5VTlNUQUJMRV9MT0dJTl9UWVBFXTogc3NvQWVzdGhldGljcyxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uQXV0aEZpbmlzaGVkID0gKHN1Y2Nlc3M6IGJvb2xlYW4sIHJlc3VsdDogRXJyb3IpOiB2b2lkID0+IHtcbiAgICAgICAgaWYgKHN1Y2Nlc3MpIHtcbiAgICAgICAgICAgIHRoaXMucHJvcHMub25GaW5pc2hlZCh0cnVlLCByZXN1bHQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gRVJST1JfVVNFUl9DQU5DRUxMRUQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnByb3BzLm9uRmluaXNoZWQoZmFsc2UsIG51bGwpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICAgICAgYXV0aEVycm9yOiByZXN1bHQsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvblVwZGF0ZVN0YWdlUGhhc2UgPSAobmV3U3RhZ2U6IHN0cmluZyB8IG51bWJlciwgbmV3UGhhc2U6IHN0cmluZyB8IG51bWJlcik6IHZvaWQgPT4ge1xuICAgICAgICAvLyBXZSBjb3B5IHRoZSBzdGFnZSBhbmQgc3RhZ2UgcGhhc2UgcGFyYW1zIGludG8gc3RhdGUgZm9yIHRpdGxlIHNlbGVjdGlvbiBpbiByZW5kZXIoKVxuICAgICAgICB0aGlzLnNldFN0YXRlKHsgdWlhU3RhZ2U6IG5ld1N0YWdlLCB1aWFTdGFnZVBoYXNlOiBuZXdQaGFzZSB9KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkRpc21pc3NDbGljayA9ICgpOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5wcm9wcy5vbkZpbmlzaGVkKGZhbHNlKTtcbiAgICB9O1xuXG4gICAgcHVibGljIHJlbmRlcigpOiBKU1guRWxlbWVudCB7XG4gICAgICAgIC8vIExldCdzIHBpY2sgYSB0aXRsZSwgYm9keSwgYW5kIG90aGVyIHBhcmFtcyB0ZXh0IHRoYXQgd2UnbGwgc2hvdyB0byB0aGUgdXNlci4gVGhlIG9yZGVyXG4gICAgICAgIC8vIGlzIG1vc3Qgc3BlY2lmaWMgZmlyc3QsIHNvIHN0YWdlUGhhc2UgPiBvdXIgcHJvcHMgPiBkZWZhdWx0cy5cblxuICAgICAgICBsZXQgdGl0bGUgPSB0aGlzLnN0YXRlLmF1dGhFcnJvciA/ICdFcnJvcicgOiAodGhpcy5wcm9wcy50aXRsZSB8fCBfdCgnQXV0aGVudGljYXRpb24nKSk7XG4gICAgICAgIGxldCBib2R5ID0gdGhpcy5zdGF0ZS5hdXRoRXJyb3IgPyBudWxsIDogdGhpcy5wcm9wcy5ib2R5O1xuICAgICAgICBsZXQgY29udGludWVUZXh0ID0gbnVsbDtcbiAgICAgICAgbGV0IGNvbnRpbnVlS2luZCA9IG51bGw7XG4gICAgICAgIGNvbnN0IGRpYWxvZ0Flc3RoZXRpY3MgPSB0aGlzLnByb3BzLmFlc3RoZXRpY3NGb3JTdGFnZVBoYXNlcyB8fCB0aGlzLmdldERlZmF1bHREaWFsb2dBZXN0aGV0aWNzKCk7XG4gICAgICAgIGlmICghdGhpcy5zdGF0ZS5hdXRoRXJyb3IgJiYgZGlhbG9nQWVzdGhldGljcykge1xuICAgICAgICAgICAgaWYgKGRpYWxvZ0Flc3RoZXRpY3NbdGhpcy5zdGF0ZS51aWFTdGFnZV0pIHtcbiAgICAgICAgICAgICAgICBjb25zdCBhZXN0aGV0aWNzID0gZGlhbG9nQWVzdGhldGljc1t0aGlzLnN0YXRlLnVpYVN0YWdlXVt0aGlzLnN0YXRlLnVpYVN0YWdlUGhhc2VdO1xuICAgICAgICAgICAgICAgIGlmIChhZXN0aGV0aWNzICYmIGFlc3RoZXRpY3MudGl0bGUpIHRpdGxlID0gYWVzdGhldGljcy50aXRsZTtcbiAgICAgICAgICAgICAgICBpZiAoYWVzdGhldGljcyAmJiBhZXN0aGV0aWNzLmJvZHkpIGJvZHkgPSBhZXN0aGV0aWNzLmJvZHk7XG4gICAgICAgICAgICAgICAgaWYgKGFlc3RoZXRpY3MgJiYgYWVzdGhldGljcy5jb250aW51ZVRleHQpIGNvbnRpbnVlVGV4dCA9IGFlc3RoZXRpY3MuY29udGludWVUZXh0O1xuICAgICAgICAgICAgICAgIGlmIChhZXN0aGV0aWNzICYmIGFlc3RoZXRpY3MuY29udGludWVLaW5kKSBjb250aW51ZUtpbmQgPSBhZXN0aGV0aWNzLmNvbnRpbnVlS2luZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBjb250ZW50O1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5hdXRoRXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnRlbnQgPSAoXG4gICAgICAgICAgICAgICAgPGRpdiBpZD0nbXhfRGlhbG9nX2NvbnRlbnQnPlxuICAgICAgICAgICAgICAgICAgICA8ZGl2IHJvbGU9XCJhbGVydFwiPnsgdGhpcy5zdGF0ZS5hdXRoRXJyb3IubWVzc2FnZSB8fCB0aGlzLnN0YXRlLmF1dGhFcnJvci50b1N0cmluZygpIH08L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgPGJyIC8+XG4gICAgICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uIG9uQ2xpY2s9e3RoaXMub25EaXNtaXNzQ2xpY2t9XG4gICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9HZW5lcmFsQnV0dG9uXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIGF1dG9Gb2N1cz17dHJ1ZX1cbiAgICAgICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIkRpc21pc3NcIikgfVxuICAgICAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29udGVudCA9IChcbiAgICAgICAgICAgICAgICA8ZGl2IGlkPSdteF9EaWFsb2dfY29udGVudCc+XG4gICAgICAgICAgICAgICAgICAgIHsgYm9keSB9XG4gICAgICAgICAgICAgICAgICAgIDxJbnRlcmFjdGl2ZUF1dGhcbiAgICAgICAgICAgICAgICAgICAgICAgIG1hdHJpeENsaWVudD17dGhpcy5wcm9wcy5tYXRyaXhDbGllbnR9XG4gICAgICAgICAgICAgICAgICAgICAgICBhdXRoRGF0YT17dGhpcy5wcm9wcy5hdXRoRGF0YX1cbiAgICAgICAgICAgICAgICAgICAgICAgIG1ha2VSZXF1ZXN0PXt0aGlzLnByb3BzLm1ha2VSZXF1ZXN0fVxuICAgICAgICAgICAgICAgICAgICAgICAgb25BdXRoRmluaXNoZWQ9e3RoaXMub25BdXRoRmluaXNoZWR9XG4gICAgICAgICAgICAgICAgICAgICAgICBvblN0YWdlUGhhc2VDaGFuZ2U9e3RoaXMub25VcGRhdGVTdGFnZVBoYXNlfVxuICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWVUZXh0PXtjb250aW51ZVRleHR9XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZUtpbmQ9e2NvbnRpbnVlS2luZH1cbiAgICAgICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPEJhc2VEaWFsb2cgY2xhc3NOYW1lPVwibXhfSW50ZXJhY3RpdmVBdXRoRGlhbG9nXCJcbiAgICAgICAgICAgICAgICBvbkZpbmlzaGVkPXt0aGlzLnByb3BzLm9uRmluaXNoZWR9XG4gICAgICAgICAgICAgICAgdGl0bGU9e3RpdGxlfVxuICAgICAgICAgICAgICAgIGNvbnRlbnRJZD0nbXhfRGlhbG9nX2NvbnRlbnQnXG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgeyBjb250ZW50IH1cbiAgICAgICAgICAgIDwvQmFzZURpYWxvZz5cbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=