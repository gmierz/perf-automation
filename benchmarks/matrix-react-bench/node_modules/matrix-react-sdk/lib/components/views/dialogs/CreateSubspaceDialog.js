"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireWildcard(require("react"));

var _partials = require("matrix-js-sdk/src/@types/partials");

var _languageHandler = require("../../../languageHandler");

var _BaseDialog = _interopRequireDefault(require("./BaseDialog"));

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _MatrixClientContext = _interopRequireDefault(require("../../../contexts/MatrixClientContext"));

var _BetaCard = require("../beta/BetaCard");

var _SpaceStore = _interopRequireDefault(require("../../../stores/spaces/SpaceStore"));

var _SpaceCreateMenu = require("../spaces/SpaceCreateMenu");

var _AddExistingToSpaceDialog = require("./AddExistingToSpaceDialog");

var _JoinRuleDropdown = _interopRequireDefault(require("../elements/JoinRuleDropdown"));

var _logger = require("matrix-js-sdk/src/logger");

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/*
Copyright 2021 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const CreateSubspaceDialog = ({
  space,
  onAddExistingSpaceClick,
  onFinished
}) => {
  var _SpaceStore$instance$;

  const [parentSpace, setParentSpace] = (0, _react.useState)(space);
  const [busy, setBusy] = (0, _react.useState)(false);
  const [name, setName] = (0, _react.useState)("");
  const spaceNameField = (0, _react.useRef)();
  const [alias, setAlias] = (0, _react.useState)("");
  const spaceAliasField = (0, _react.useRef)();
  const [avatar, setAvatar] = (0, _react.useState)(null);
  const [topic, setTopic] = (0, _react.useState)("");
  const supportsRestricted = !!((_SpaceStore$instance$ = _SpaceStore.default.instance.restrictedJoinRuleSupport) !== null && _SpaceStore$instance$ !== void 0 && _SpaceStore$instance$.preferred);
  const spaceJoinRule = space.getJoinRule();
  let defaultJoinRule = _partials.JoinRule.Invite;

  if (spaceJoinRule === _partials.JoinRule.Public) {
    defaultJoinRule = _partials.JoinRule.Public;
  } else if (supportsRestricted) {
    defaultJoinRule = _partials.JoinRule.Restricted;
  }

  const [joinRule, setJoinRule] = (0, _react.useState)(defaultJoinRule);

  const onCreateSubspaceClick = async e => {
    e.preventDefault();
    if (busy) return;
    setBusy(true); // require & validate the space name field

    if (!(await spaceNameField.current.validate({
      allowEmpty: false
    }))) {
      spaceNameField.current.focus();
      spaceNameField.current.validate({
        allowEmpty: false,
        focused: true
      });
      setBusy(false);
      return;
    } // validate the space name alias field but do not require it


    if (joinRule === _partials.JoinRule.Public && !(await spaceAliasField.current.validate({
      allowEmpty: true
    }))) {
      spaceAliasField.current.focus();
      spaceAliasField.current.validate({
        allowEmpty: true,
        focused: true
      });
      setBusy(false);
      return;
    }

    try {
      await (0, _SpaceCreateMenu.createSpace)(name, joinRule === _partials.JoinRule.Public, alias, topic, avatar, {}, {
        parentSpace,
        joinRule
      });
      onFinished(true);
    } catch (e) {
      _logger.logger.error(e);
    }
  };

  let joinRuleMicrocopy;

  if (joinRule === _partials.JoinRule.Restricted) {
    joinRuleMicrocopy = /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Anyone in <SpaceName/> will be able to find and join.", {}, {
      SpaceName: () => /*#__PURE__*/_react.default.createElement("b", null, parentSpace.name)
    }));
  } else if (joinRule === _partials.JoinRule.Public) {
    joinRuleMicrocopy = /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Anyone will be able to find and join this space, not just members of <SpaceName/>.", {}, {
      SpaceName: () => /*#__PURE__*/_react.default.createElement("b", null, parentSpace.name)
    }));
  } else if (joinRule === _partials.JoinRule.Invite) {
    joinRuleMicrocopy = /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Only people invited will be able to find and join this space."));
  }

  return /*#__PURE__*/_react.default.createElement(_BaseDialog.default, {
    title: /*#__PURE__*/_react.default.createElement(_AddExistingToSpaceDialog.SubspaceSelector, {
      title: (0, _languageHandler._t)("Create a space"),
      space: space,
      value: parentSpace,
      onChange: setParentSpace
    }),
    className: "mx_CreateSubspaceDialog",
    contentId: "mx_CreateSubspaceDialog",
    onFinished: onFinished,
    fixedWidth: false
  }, /*#__PURE__*/_react.default.createElement(_MatrixClientContext.default.Provider, {
    value: space.client
  }, /*#__PURE__*/_react.default.createElement("div", {
    className: "mx_CreateSubspaceDialog_content"
  }, /*#__PURE__*/_react.default.createElement("div", {
    className: "mx_CreateSubspaceDialog_betaNotice"
  }, /*#__PURE__*/_react.default.createElement(_BetaCard.BetaPill, null), (0, _languageHandler._t)("Add a space to a space you manage.")), /*#__PURE__*/_react.default.createElement(_SpaceCreateMenu.SpaceCreateForm, {
    busy: busy,
    onSubmit: onCreateSubspaceClick,
    setAvatar: setAvatar,
    name: name,
    setName: setName,
    nameFieldRef: spaceNameField,
    topic: topic,
    setTopic: setTopic,
    alias: alias,
    setAlias: setAlias,
    showAliasField: joinRule === _partials.JoinRule.Public,
    aliasFieldRef: spaceAliasField
  }, /*#__PURE__*/_react.default.createElement(_JoinRuleDropdown.default, {
    label: (0, _languageHandler._t)("Space visibility"),
    labelInvite: (0, _languageHandler._t)("Private space (invite only)"),
    labelPublic: (0, _languageHandler._t)("Public space"),
    labelRestricted: supportsRestricted ? (0, _languageHandler._t)("Visible to space members") : undefined,
    width: 478,
    value: joinRule,
    onChange: setJoinRule
  }), joinRuleMicrocopy)), /*#__PURE__*/_react.default.createElement("div", {
    className: "mx_CreateSubspaceDialog_footer"
  }, /*#__PURE__*/_react.default.createElement("div", {
    className: "mx_CreateSubspaceDialog_footer_prompt"
  }, /*#__PURE__*/_react.default.createElement("div", null, (0, _languageHandler._t)("Want to add an existing space instead?")), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
    kind: "link",
    onClick: () => {
      onAddExistingSpaceClick();
      onFinished();
    }
  }, (0, _languageHandler._t)("Add existing space"))), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
    kind: "primary_outline",
    disabled: busy,
    onClick: () => onFinished(false)
  }, (0, _languageHandler._t)("Cancel")), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
    kind: "primary",
    disabled: busy,
    onClick: onCreateSubspaceClick
  }, busy ? (0, _languageHandler._t)("Adding...") : (0, _languageHandler._t)("Add")))));
};

var _default = CreateSubspaceDialog;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvQ3JlYXRlU3Vic3BhY2VEaWFsb2cudHN4Il0sIm5hbWVzIjpbIkNyZWF0ZVN1YnNwYWNlRGlhbG9nIiwic3BhY2UiLCJvbkFkZEV4aXN0aW5nU3BhY2VDbGljayIsIm9uRmluaXNoZWQiLCJwYXJlbnRTcGFjZSIsInNldFBhcmVudFNwYWNlIiwiYnVzeSIsInNldEJ1c3kiLCJuYW1lIiwic2V0TmFtZSIsInNwYWNlTmFtZUZpZWxkIiwiYWxpYXMiLCJzZXRBbGlhcyIsInNwYWNlQWxpYXNGaWVsZCIsImF2YXRhciIsInNldEF2YXRhciIsInRvcGljIiwic2V0VG9waWMiLCJzdXBwb3J0c1Jlc3RyaWN0ZWQiLCJTcGFjZVN0b3JlIiwiaW5zdGFuY2UiLCJyZXN0cmljdGVkSm9pblJ1bGVTdXBwb3J0IiwicHJlZmVycmVkIiwic3BhY2VKb2luUnVsZSIsImdldEpvaW5SdWxlIiwiZGVmYXVsdEpvaW5SdWxlIiwiSm9pblJ1bGUiLCJJbnZpdGUiLCJQdWJsaWMiLCJSZXN0cmljdGVkIiwiam9pblJ1bGUiLCJzZXRKb2luUnVsZSIsIm9uQ3JlYXRlU3Vic3BhY2VDbGljayIsImUiLCJwcmV2ZW50RGVmYXVsdCIsImN1cnJlbnQiLCJ2YWxpZGF0ZSIsImFsbG93RW1wdHkiLCJmb2N1cyIsImZvY3VzZWQiLCJsb2dnZXIiLCJlcnJvciIsImpvaW5SdWxlTWljcm9jb3B5IiwiU3BhY2VOYW1lIiwiY2xpZW50IiwidW5kZWZpbmVkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFnQkE7O0FBRUE7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7Ozs7OztBQWhDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUEwQkEsTUFBTUEsb0JBQXNDLEdBQUcsQ0FB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LGtCQUNJLDBDQUFPLHlCQUFHLHdDQUFILENBQVAsQ0FESixlQUVJLDZCQUFDLHlCQUFEO0FBQ0ksSUFBQSxJQUFJLEVBQUMsTUFEVDtBQUVJLElBQUEsT0FBTyxFQUFFLE1BQU07QUFDWHhDLE1BQUFBLHVCQUF1QjtBQUN2QkMsTUFBQUEsVUFBVTtBQUNiO0FBTEwsS0FPTSx5QkFBRyxvQkFBSCxDQVBOLENBRkosQ0FESixlQWNJLDZCQUFDLHlCQUFEO0FBQWtCLElBQUEsSUFBSSxFQUFDLGlCQUF2QjtBQUF5QyxJQUFBLFFBQVEsRUFBRUcsSUFBbkQ7QUFBeUQsSUFBQSxPQUFPLEVBQUUsTUFBTUgsVUFBVSxDQUFDLEtBQUQ7QUFBbEYsS0FDTSx5QkFBRyxRQUFILENBRE4sQ0FkSixlQWlCSSw2QkFBQyx5QkFBRDtBQUFrQixJQUFBLElBQUksRUFBQyxTQUF2QjtBQUFpQyxJQUFBLFFBQVEsRUFBRUcsSUFBM0M7QUFBaUQsSUFBQSxPQUFPLEVBQUUwQjtBQUExRCxLQUNNMUIsSUFBSSxHQUFHLHlCQUFHLFdBQUgsQ0FBSCxHQUFxQix5QkFBRyxLQUFILENBRC9CLENBakJKLENBbENKLENBZEcsQ0FBUDtBQXVFSCxDQWpKRDs7ZUFtSmVOLG9CIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDIxIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0LCB7IHVzZVJlZiwgdXNlU3RhdGUgfSBmcm9tIFwicmVhY3RcIjtcbmltcG9ydCB7IFJvb20gfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3Jvb21cIjtcbmltcG9ydCB7IEpvaW5SdWxlIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL0B0eXBlcy9wYXJ0aWFsc1wiO1xuXG5pbXBvcnQgeyBfdCB9IGZyb20gJy4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlcic7XG5pbXBvcnQgQmFzZURpYWxvZyBmcm9tIFwiLi9CYXNlRGlhbG9nXCI7XG5pbXBvcnQgQWNjZXNzaWJsZUJ1dHRvbiBmcm9tIFwiLi4vZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvblwiO1xuaW1wb3J0IE1hdHJpeENsaWVudENvbnRleHQgZnJvbSBcIi4uLy4uLy4uL2NvbnRleHRzL01hdHJpeENsaWVudENvbnRleHRcIjtcbmltcG9ydCB7IEJldGFQaWxsIH0gZnJvbSBcIi4uL2JldGEvQmV0YUNhcmRcIjtcbmltcG9ydCBGaWVsZCBmcm9tIFwiLi4vZWxlbWVudHMvRmllbGRcIjtcbmltcG9ydCBSb29tQWxpYXNGaWVsZCBmcm9tIFwiLi4vZWxlbWVudHMvUm9vbUFsaWFzRmllbGRcIjtcbmltcG9ydCBTcGFjZVN0b3JlIGZyb20gXCIuLi8uLi8uLi9zdG9yZXMvc3BhY2VzL1NwYWNlU3RvcmVcIjtcbmltcG9ydCB7IGNyZWF0ZVNwYWNlLCBTcGFjZUNyZWF0ZUZvcm0gfSBmcm9tIFwiLi4vc3BhY2VzL1NwYWNlQ3JlYXRlTWVudVwiO1xuaW1wb3J0IHsgU3Vic3BhY2VTZWxlY3RvciB9IGZyb20gXCIuL0FkZEV4aXN0aW5nVG9TcGFjZURpYWxvZ1wiO1xuaW1wb3J0IEpvaW5SdWxlRHJvcGRvd24gZnJvbSBcIi4uL2VsZW1lbnRzL0pvaW5SdWxlRHJvcGRvd25cIjtcblxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2xvZ2dlclwiO1xuXG5pbnRlcmZhY2UgSVByb3BzIHtcbiAgICBzcGFjZTogUm9vbTtcbiAgICBvbkFkZEV4aXN0aW5nU3BhY2VDbGljaygpOiB2b2lkO1xuICAgIG9uRmluaXNoZWQoYWRkZWQ/OiBib29sZWFuKTogdm9pZDtcbn1cblxuY29uc3QgQ3JlYXRlU3Vic3BhY2VEaWFsb2c6IFJlYWN0LkZDPElQcm9wcz4gPSAoeyBzcGFjZSwgb25BZGRFeGlzdGluZ1NwYWNlQ2xpY2ssIG9uRmluaXNoZWQgfSkgPT4ge1xuICAgIGNvbnN0IFtwYXJlbnRTcGFjZSwgc2V0UGFyZW50U3BhY2VdID0gdXNlU3RhdGUoc3BhY2UpO1xuXG4gICAgY29uc3QgW2J1c3ksIHNldEJ1c3ldID0gdXNlU3RhdGU8Ym9vbGVhbj4oZmFsc2UpO1xuICAgIGNvbnN0IFtuYW1lLCBzZXROYW1lXSA9IHVzZVN0YXRlKFwiXCIpO1xuICAgIGNvbnN0IHNwYWNlTmFtZUZpZWxkID0gdXNlUmVmPEZpZWxkPigpO1xuICAgIGNvbnN0IFthbGlhcywgc2V0QWxpYXNdID0gdXNlU3RhdGUoXCJcIik7XG4gICAgY29uc3Qgc3BhY2VBbGlhc0ZpZWxkID0gdXNlUmVmPFJvb21BbGlhc0ZpZWxkPigpO1xuICAgIGNvbnN0IFthdmF0YXIsIHNldEF2YXRhcl0gPSB1c2VTdGF0ZTxGaWxlPihudWxsKTtcbiAgICBjb25zdCBbdG9waWMsIHNldFRvcGljXSA9IHVzZVN0YXRlPHN0cmluZz4oXCJcIik7XG5cbiAgICBjb25zdCBzdXBwb3J0c1Jlc3RyaWN0ZWQgPSAhIVNwYWNlU3RvcmUuaW5zdGFuY2UucmVzdHJpY3RlZEpvaW5SdWxlU3VwcG9ydD8ucHJlZmVycmVkO1xuXG4gICAgY29uc3Qgc3BhY2VKb2luUnVsZSA9IHNwYWNlLmdldEpvaW5SdWxlKCk7XG4gICAgbGV0IGRlZmF1bHRKb2luUnVsZSA9IEpvaW5SdWxlLkludml0ZTtcbiAgICBpZiAoc3BhY2VKb2luUnVsZSA9PT0gSm9pblJ1bGUuUHVibGljKSB7XG4gICAgICAgIGRlZmF1bHRKb2luUnVsZSA9IEpvaW5SdWxlLlB1YmxpYztcbiAgICB9IGVsc2UgaWYgKHN1cHBvcnRzUmVzdHJpY3RlZCkge1xuICAgICAgICBkZWZhdWx0Sm9pblJ1bGUgPSBKb2luUnVsZS5SZXN0cmljdGVkO1xuICAgIH1cbiAgICBjb25zdCBbam9pblJ1bGUsIHNldEpvaW5SdWxlXSA9IHVzZVN0YXRlPEpvaW5SdWxlPihkZWZhdWx0Sm9pblJ1bGUpO1xuXG4gICAgY29uc3Qgb25DcmVhdGVTdWJzcGFjZUNsaWNrID0gYXN5bmMgKGUpID0+IHtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBpZiAoYnVzeSkgcmV0dXJuO1xuXG4gICAgICAgIHNldEJ1c3kodHJ1ZSk7XG4gICAgICAgIC8vIHJlcXVpcmUgJiB2YWxpZGF0ZSB0aGUgc3BhY2UgbmFtZSBmaWVsZFxuICAgICAgICBpZiAoIShhd2FpdCBzcGFjZU5hbWVGaWVsZC5jdXJyZW50LnZhbGlkYXRlKHsgYWxsb3dFbXB0eTogZmFsc2UgfSkpKSB7XG4gICAgICAgICAgICBzcGFjZU5hbWVGaWVsZC5jdXJyZW50LmZvY3VzKCk7XG4gICAgICAgICAgICBzcGFjZU5hbWVGaWVsZC5jdXJyZW50LnZhbGlkYXRlKHsgYWxsb3dFbXB0eTogZmFsc2UsIGZvY3VzZWQ6IHRydWUgfSk7XG4gICAgICAgICAgICBzZXRCdXN5KGZhbHNlKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICAvLyB2YWxpZGF0ZSB0aGUgc3BhY2UgbmFtZSBhbGlhcyBmaWVsZCBidXQgZG8gbm90IHJlcXVpcmUgaXRcbiAgICAgICAgaWYgKGpvaW5SdWxlID09PSBKb2luUnVsZS5QdWJsaWMgJiYgIShhd2FpdCBzcGFjZUFsaWFzRmllbGQuY3VycmVudC52YWxpZGF0ZSh7IGFsbG93RW1wdHk6IHRydWUgfSkpKSB7XG4gICAgICAgICAgICBzcGFjZUFsaWFzRmllbGQuY3VycmVudC5mb2N1cygpO1xuICAgICAgICAgICAgc3BhY2VBbGlhc0ZpZWxkLmN1cnJlbnQudmFsaWRhdGUoeyBhbGxvd0VtcHR5OiB0cnVlLCBmb2N1c2VkOiB0cnVlIH0pO1xuICAgICAgICAgICAgc2V0QnVzeShmYWxzZSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgY3JlYXRlU3BhY2UobmFtZSwgam9pblJ1bGUgPT09IEpvaW5SdWxlLlB1YmxpYywgYWxpYXMsIHRvcGljLCBhdmF0YXIsIHt9LCB7IHBhcmVudFNwYWNlLCBqb2luUnVsZSB9KTtcblxuICAgICAgICAgICAgb25GaW5pc2hlZCh0cnVlKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGUpO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIGxldCBqb2luUnVsZU1pY3JvY29weTogSlNYLkVsZW1lbnQ7XG4gICAgaWYgKGpvaW5SdWxlID09PSBKb2luUnVsZS5SZXN0cmljdGVkKSB7XG4gICAgICAgIGpvaW5SdWxlTWljcm9jb3B5ID0gPHA+XG4gICAgICAgICAgICB7IF90KFxuICAgICAgICAgICAgICAgIFwiQW55b25lIGluIDxTcGFjZU5hbWUvPiB3aWxsIGJlIGFibGUgdG8gZmluZCBhbmQgam9pbi5cIiwge30sIHtcbiAgICAgICAgICAgICAgICAgICAgU3BhY2VOYW1lOiAoKSA9PiA8Yj57IHBhcmVudFNwYWNlLm5hbWUgfTwvYj4sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICkgfVxuICAgICAgICA8L3A+O1xuICAgIH0gZWxzZSBpZiAoam9pblJ1bGUgPT09IEpvaW5SdWxlLlB1YmxpYykge1xuICAgICAgICBqb2luUnVsZU1pY3JvY29weSA9IDxwPlxuICAgICAgICAgICAgeyBfdChcbiAgICAgICAgICAgICAgICBcIkFueW9uZSB3aWxsIGJlIGFibGUgdG8gZmluZCBhbmQgam9pbiB0aGlzIHNwYWNlLCBub3QganVzdCBtZW1iZXJzIG9mIDxTcGFjZU5hbWUvPi5cIiwge30sIHtcbiAgICAgICAgICAgICAgICAgICAgU3BhY2VOYW1lOiAoKSA9PiA8Yj57IHBhcmVudFNwYWNlLm5hbWUgfTwvYj4sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICkgfVxuICAgICAgICA8L3A+O1xuICAgIH0gZWxzZSBpZiAoam9pblJ1bGUgPT09IEpvaW5SdWxlLkludml0ZSkge1xuICAgICAgICBqb2luUnVsZU1pY3JvY29weSA9IDxwPlxuICAgICAgICAgICAgeyBfdChcIk9ubHkgcGVvcGxlIGludml0ZWQgd2lsbCBiZSBhYmxlIHRvIGZpbmQgYW5kIGpvaW4gdGhpcyBzcGFjZS5cIikgfVxuICAgICAgICA8L3A+O1xuICAgIH1cblxuICAgIHJldHVybiA8QmFzZURpYWxvZ1xuICAgICAgICB0aXRsZT17KFxuICAgICAgICAgICAgPFN1YnNwYWNlU2VsZWN0b3JcbiAgICAgICAgICAgICAgICB0aXRsZT17X3QoXCJDcmVhdGUgYSBzcGFjZVwiKX1cbiAgICAgICAgICAgICAgICBzcGFjZT17c3BhY2V9XG4gICAgICAgICAgICAgICAgdmFsdWU9e3BhcmVudFNwYWNlfVxuICAgICAgICAgICAgICAgIG9uQ2hhbmdlPXtzZXRQYXJlbnRTcGFjZX1cbiAgICAgICAgICAgIC8+XG4gICAgICAgICl9XG4gICAgICAgIGNsYXNzTmFtZT1cIm14X0NyZWF0ZVN1YnNwYWNlRGlhbG9nXCJcbiAgICAgICAgY29udGVudElkPVwibXhfQ3JlYXRlU3Vic3BhY2VEaWFsb2dcIlxuICAgICAgICBvbkZpbmlzaGVkPXtvbkZpbmlzaGVkfVxuICAgICAgICBmaXhlZFdpZHRoPXtmYWxzZX1cbiAgICA+XG4gICAgICAgIDxNYXRyaXhDbGllbnRDb250ZXh0LlByb3ZpZGVyIHZhbHVlPXtzcGFjZS5jbGllbnR9PlxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9DcmVhdGVTdWJzcGFjZURpYWxvZ19jb250ZW50XCI+XG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9DcmVhdGVTdWJzcGFjZURpYWxvZ19iZXRhTm90aWNlXCI+XG4gICAgICAgICAgICAgICAgICAgIDxCZXRhUGlsbCAvPlxuICAgICAgICAgICAgICAgICAgICB7IF90KFwiQWRkIGEgc3BhY2UgdG8gYSBzcGFjZSB5b3UgbWFuYWdlLlwiKSB9XG4gICAgICAgICAgICAgICAgPC9kaXY+XG5cbiAgICAgICAgICAgICAgICA8U3BhY2VDcmVhdGVGb3JtXG4gICAgICAgICAgICAgICAgICAgIGJ1c3k9e2J1c3l9XG4gICAgICAgICAgICAgICAgICAgIG9uU3VibWl0PXtvbkNyZWF0ZVN1YnNwYWNlQ2xpY2t9XG4gICAgICAgICAgICAgICAgICAgIHNldEF2YXRhcj17c2V0QXZhdGFyfVxuICAgICAgICAgICAgICAgICAgICBuYW1lPXtuYW1lfVxuICAgICAgICAgICAgICAgICAgICBzZXROYW1lPXtzZXROYW1lfVxuICAgICAgICAgICAgICAgICAgICBuYW1lRmllbGRSZWY9e3NwYWNlTmFtZUZpZWxkfVxuICAgICAgICAgICAgICAgICAgICB0b3BpYz17dG9waWN9XG4gICAgICAgICAgICAgICAgICAgIHNldFRvcGljPXtzZXRUb3BpY31cbiAgICAgICAgICAgICAgICAgICAgYWxpYXM9e2FsaWFzfVxuICAgICAgICAgICAgICAgICAgICBzZXRBbGlhcz17c2V0QWxpYXN9XG4gICAgICAgICAgICAgICAgICAgIHNob3dBbGlhc0ZpZWxkPXtqb2luUnVsZSA9PT0gSm9pblJ1bGUuUHVibGljfVxuICAgICAgICAgICAgICAgICAgICBhbGlhc0ZpZWxkUmVmPXtzcGFjZUFsaWFzRmllbGR9XG4gICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICA8Sm9pblJ1bGVEcm9wZG93blxuICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw9e190KFwiU3BhY2UgdmlzaWJpbGl0eVwiKX1cbiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsSW52aXRlPXtfdChcIlByaXZhdGUgc3BhY2UgKGludml0ZSBvbmx5KVwiKX1cbiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsUHVibGljPXtfdChcIlB1YmxpYyBzcGFjZVwiKX1cbiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsUmVzdHJpY3RlZD17c3VwcG9ydHNSZXN0cmljdGVkID8gX3QoXCJWaXNpYmxlIHRvIHNwYWNlIG1lbWJlcnNcIikgOiB1bmRlZmluZWR9XG4gICAgICAgICAgICAgICAgICAgICAgICB3aWR0aD17NDc4fVxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU9e2pvaW5SdWxlfVxuICAgICAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2U9e3NldEpvaW5SdWxlfVxuICAgICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgICAgICB7IGpvaW5SdWxlTWljcm9jb3B5IH1cbiAgICAgICAgICAgICAgICA8L1NwYWNlQ3JlYXRlRm9ybT5cbiAgICAgICAgICAgIDwvZGl2PlxuXG4gICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0NyZWF0ZVN1YnNwYWNlRGlhbG9nX2Zvb3RlclwiPlxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfQ3JlYXRlU3Vic3BhY2VEaWFsb2dfZm9vdGVyX3Byb21wdFwiPlxuICAgICAgICAgICAgICAgICAgICA8ZGl2PnsgX3QoXCJXYW50IHRvIGFkZCBhbiBleGlzdGluZyBzcGFjZSBpbnN0ZWFkP1wiKSB9PC9kaXY+XG4gICAgICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uXG4gICAgICAgICAgICAgICAgICAgICAgICBraW5kPVwibGlua1wiXG4gICAgICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXsoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb25BZGRFeGlzdGluZ1NwYWNlQ2xpY2soKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkZpbmlzaGVkKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9fVxuICAgICAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICAgICAgICB7IF90KFwiQWRkIGV4aXN0aW5nIHNwYWNlXCIpIH1cbiAgICAgICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgICAgIDwvZGl2PlxuXG4gICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b24ga2luZD1cInByaW1hcnlfb3V0bGluZVwiIGRpc2FibGVkPXtidXN5fSBvbkNsaWNrPXsoKSA9PiBvbkZpbmlzaGVkKGZhbHNlKX0+XG4gICAgICAgICAgICAgICAgICAgIHsgX3QoXCJDYW5jZWxcIikgfVxuICAgICAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj5cbiAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvbiBraW5kPVwicHJpbWFyeVwiIGRpc2FibGVkPXtidXN5fSBvbkNsaWNrPXtvbkNyZWF0ZVN1YnNwYWNlQ2xpY2t9PlxuICAgICAgICAgICAgICAgICAgICB7IGJ1c3kgPyBfdChcIkFkZGluZy4uLlwiKSA6IF90KFwiQWRkXCIpIH1cbiAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgPC9NYXRyaXhDbGllbnRDb250ZXh0LlByb3ZpZGVyPlxuICAgIDwvQmFzZURpYWxvZz47XG59O1xuXG5leHBvcnQgZGVmYXVsdCBDcmVhdGVTdWJzcGFjZURpYWxvZztcblxuIl19