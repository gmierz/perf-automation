"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _BaseDialog = _interopRequireDefault(require("./BaseDialog"));

var _languageHandler = require("../../../languageHandler");

var _Field = _interopRequireDefault(require("../elements/Field"));

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _arrays = require("../../../utils/arrays");

var _SdkConfig = _interopRequireDefault(require("../../../SdkConfig"));

var _InviteDialog = _interopRequireDefault(require("./InviteDialog"));

var _BaseAvatar = _interopRequireDefault(require("../avatars/BaseAvatar"));

var _RoomInvite = require("../../../RoomInvite");

var _StyledCheckbox = _interopRequireDefault(require("../elements/StyledCheckbox"));

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _ErrorDialog = _interopRequireDefault(require("./ErrorDialog"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _Media = require("../../../customisations/Media");

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class;

let CommunityPrototypeInviteDialog = (_dec = (0, _replaceableComponent.replaceableComponent)("views.dialogs.CommunityPrototypeInviteDialog"), _dec(_class = class CommunityPrototypeInviteDialog extends _react.default.PureComponent {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onSubmit", async ev => {
      ev.preventDefault();
      ev.stopPropagation();
      this.setState({
        busy: true
      });

      try {
        const targets = [...this.state.emailTargets, ...this.state.userTargets];
        const result = await (0, _RoomInvite.inviteMultipleToRoom)(this.props.roomId, targets);

        const room = _MatrixClientPeg.MatrixClientPeg.get().getRoom(this.props.roomId);

        const success = (0, _RoomInvite.showAnyInviteErrors)(result.states, room, result.inviter);

        if (success) {
          this.props.onFinished(true);
        } else {
          this.setState({
            busy: false
          });
        }
      } catch (e) {
        this.setState({
          busy: false
        });

        _logger.logger.error(e);

        _Modal.default.createTrackedDialog('Failed to invite', '', _ErrorDialog.default, {
          title: (0, _languageHandler._t)("Failed to invite"),
          description: e && e.message ? e.message : (0, _languageHandler._t)("Operation failed")
        });
      }
    });
    (0, _defineProperty2.default)(this, "onAddressChange", (ev, index) => {
      const targets = (0, _arrays.arrayFastClone)(this.state.emailTargets);

      if (index >= targets.length) {
        targets.push(ev.target.value);
      } else {
        targets[index] = ev.target.value;
      }

      this.setState({
        emailTargets: targets
      });
    });
    (0, _defineProperty2.default)(this, "onAddressBlur", index => {
      const targets = (0, _arrays.arrayFastClone)(this.state.emailTargets);
      if (index >= targets.length) return; // not important

      if (targets[index].trim() === "") {
        targets.splice(index, 1);
        this.setState({
          emailTargets: targets
        });
      }
    });
    (0, _defineProperty2.default)(this, "onShowPeopleClick", () => {
      this.setState({
        showPeople: !this.state.showPeople
      });
    });
    (0, _defineProperty2.default)(this, "setPersonToggle", (person, selected) => {
      const targets = (0, _arrays.arrayFastClone)(this.state.userTargets);

      if (selected && !targets.includes(person.userId)) {
        targets.push(person.userId);
      } else if (!selected && targets.includes(person.userId)) {
        targets.splice(targets.indexOf(person.userId), 1);
      }

      this.setState({
        userTargets: targets
      });
    });
    (0, _defineProperty2.default)(this, "onShowMorePeople", () => {
      this.setState({
        numPeople: this.state.numPeople + 5
      }); // arbitrary increase
    });
    this.state = {
      emailTargets: [],
      userTargets: [],
      showPeople: false,
      people: this.buildSuggestions(),
      numPeople: 5,
      // arbitrary default
      busy: false
    };
  }

  buildSuggestions() {
    const alreadyInvited = new Set([_MatrixClientPeg.MatrixClientPeg.get().getUserId(), _SdkConfig.default.get()['welcomeUserId']]);

    if (this.props.roomId) {
      const room = _MatrixClientPeg.MatrixClientPeg.get().getRoom(this.props.roomId);

      if (!room) throw new Error("Room ID given to InviteDialog does not look like a room");
      room.getMembersWithMembership('invite').forEach(m => alreadyInvited.add(m.userId));
      room.getMembersWithMembership('join').forEach(m => alreadyInvited.add(m.userId)); // add banned users, so we don't try to invite them

      room.getMembersWithMembership('ban').forEach(m => alreadyInvited.add(m.userId));
    }

    return _InviteDialog.default.buildRecents(alreadyInvited);
  }

  renderPerson(person, key) {
    const avatarSize = 36;
    let avatarUrl = null;

    if (person.user.getMxcAvatarUrl()) {
      avatarUrl = (0, _Media.mediaFromMxc)(person.user.getMxcAvatarUrl()).getSquareThumbnailHttp(avatarSize);
    }

    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_CommunityPrototypeInviteDialog_person",
      key: key
    }, /*#__PURE__*/_react.default.createElement(_BaseAvatar.default, {
      url: avatarUrl,
      name: person.user.name,
      idName: person.user.userId,
      width: avatarSize,
      height: avatarSize
    }), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_CommunityPrototypeInviteDialog_personIdentifiers"
    }, /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_CommunityPrototypeInviteDialog_personName"
    }, person.user.name), /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_CommunityPrototypeInviteDialog_personId"
    }, person.userId)), /*#__PURE__*/_react.default.createElement(_StyledCheckbox.default, {
      onChange: e => this.setPersonToggle(person, e.target.checked)
    }));
  }

  render() {
    const emailAddresses = [];
    this.state.emailTargets.forEach((address, i) => {
      emailAddresses.push( /*#__PURE__*/_react.default.createElement(_Field.default, {
        key: i,
        value: address,
        onChange: e => this.onAddressChange(e, i),
        label: (0, _languageHandler._t)("Email address"),
        placeholder: (0, _languageHandler._t)("Email address"),
        onBlur: () => this.onAddressBlur(i)
      }));
    }); // Push a clean input

    emailAddresses.push( /*#__PURE__*/_react.default.createElement(_Field.default, {
      key: emailAddresses.length,
      value: "",
      onChange: e => this.onAddressChange(e, emailAddresses.length),
      label: emailAddresses.length > 0 ? (0, _languageHandler._t)("Add another email") : (0, _languageHandler._t)("Email address"),
      placeholder: emailAddresses.length > 0 ? (0, _languageHandler._t)("Add another email") : (0, _languageHandler._t)("Email address")
    }));
    let peopleIntro = null;
    const people = [];

    if (this.state.showPeople) {
      const humansToPresent = this.state.people.slice(0, this.state.numPeople);
      humansToPresent.forEach((person, i) => {
        people.push(this.renderPerson(person, i));
      });

      if (humansToPresent.length < this.state.people.length) {
        people.push( /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
          onClick: this.onShowMorePeople,
          kind: "link",
          key: "more",
          className: "mx_CommunityPrototypeInviteDialog_morePeople"
        }, (0, _languageHandler._t)("Show more")));
      }
    }

    if (this.state.people.length > 0) {
      peopleIntro = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_CommunityPrototypeInviteDialog_people"
      }, /*#__PURE__*/_react.default.createElement("span", null, (0, _languageHandler._t)("People you know on %(brand)s", {
        brand: _SdkConfig.default.get().brand
      })), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        onClick: this.onShowPeopleClick
      }, this.state.showPeople ? (0, _languageHandler._t)("Hide") : (0, _languageHandler._t)("Show")));
    }

    let buttonText = (0, _languageHandler._t)("Skip");
    const targetCount = this.state.userTargets.length + this.state.emailTargets.length;

    if (targetCount > 0) {
      buttonText = (0, _languageHandler._t)("Send %(count)s invites", {
        count: targetCount
      });
    }

    return /*#__PURE__*/_react.default.createElement(_BaseDialog.default, {
      className: "mx_CommunityPrototypeInviteDialog",
      onFinished: this.props.onFinished,
      title: (0, _languageHandler._t)("Invite people to join %(communityName)s", {
        communityName: this.props.communityName
      })
    }, /*#__PURE__*/_react.default.createElement("form", {
      onSubmit: this.onSubmit
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_Dialog_content"
    }, emailAddresses, peopleIntro, people, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      kind: "primary",
      onClick: this.onSubmit,
      disabled: this.state.busy,
      className: "mx_CommunityPrototypeInviteDialog_primaryButton"
    }, buttonText))));
  }

}) || _class);
exports.default = CommunityPrototypeInviteDialog;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvQ29tbXVuaXR5UHJvdG90eXBlSW52aXRlRGlhbG9nLnRzeCJdLCJuYW1lcyI6WyJDb21tdW5pdHlQcm90b3R5cGVJbnZpdGVEaWFsb2ciLCJSZWFjdCIsIlB1cmVDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwiZXYiLCJwcmV2ZW50RGVmYXVsdCIsInN0b3BQcm9wYWdhdGlvbiIsInNldFN0YXRlIiwiYnVzeSIsInRhcmdldHMiLCJzdGF0ZSIsImVtYWlsVGFyZ2V0cyIsInVzZXJUYXJnZXRzIiwicmVzdWx0Iiwicm9vbUlkIiwicm9vbSIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsImdldFJvb20iLCJzdWNjZXNzIiwic3RhdGVzIiwiaW52aXRlciIsIm9uRmluaXNoZWQiLCJlIiwibG9nZ2VyIiwiZXJyb3IiLCJNb2RhbCIsImNyZWF0ZVRyYWNrZWREaWFsb2ciLCJFcnJvckRpYWxvZyIsInRpdGxlIiwiZGVzY3JpcHRpb24iLCJtZXNzYWdlIiwiaW5kZXgiLCJsZW5ndGgiLCJwdXNoIiwidGFyZ2V0IiwidmFsdWUiLCJ0cmltIiwic3BsaWNlIiwic2hvd1Blb3BsZSIsInBlcnNvbiIsInNlbGVjdGVkIiwiaW5jbHVkZXMiLCJ1c2VySWQiLCJpbmRleE9mIiwibnVtUGVvcGxlIiwicGVvcGxlIiwiYnVpbGRTdWdnZXN0aW9ucyIsImFscmVhZHlJbnZpdGVkIiwiU2V0IiwiZ2V0VXNlcklkIiwiU2RrQ29uZmlnIiwiRXJyb3IiLCJnZXRNZW1iZXJzV2l0aE1lbWJlcnNoaXAiLCJmb3JFYWNoIiwibSIsImFkZCIsIkludml0ZURpYWxvZyIsImJ1aWxkUmVjZW50cyIsInJlbmRlclBlcnNvbiIsImtleSIsImF2YXRhclNpemUiLCJhdmF0YXJVcmwiLCJ1c2VyIiwiZ2V0TXhjQXZhdGFyVXJsIiwiZ2V0U3F1YXJlVGh1bWJuYWlsSHR0cCIsIm5hbWUiLCJzZXRQZXJzb25Ub2dnbGUiLCJjaGVja2VkIiwicmVuZGVyIiwiZW1haWxBZGRyZXNzZXMiLCJhZGRyZXNzIiwiaSIsIm9uQWRkcmVzc0NoYW5nZSIsIm9uQWRkcmVzc0JsdXIiLCJwZW9wbGVJbnRybyIsImh1bWFuc1RvUHJlc2VudCIsInNsaWNlIiwib25TaG93TW9yZVBlb3BsZSIsImJyYW5kIiwib25TaG93UGVvcGxlQ2xpY2siLCJidXR0b25UZXh0IiwidGFyZ2V0Q291bnQiLCJjb3VudCIsImNvbW11bml0eU5hbWUiLCJvblN1Ym1pdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFnQkE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7Ozs7SUF1QnFCQSw4QixXQURwQixnREFBcUIsOENBQXJCLEMsZ0JBQUQsTUFDcUJBLDhCQURyQixTQUM0REMsZUFBTUMsYUFEbEUsQ0FDZ0c7QUFDNUZDLEVBQUFBLFdBQVcsQ0FBQ0MsS0FBRCxFQUFnQjtBQUN2QixVQUFNQSxLQUFOO0FBRHVCLG9EQTJCUixNQUFPQyxFQUFQLElBQXlCO0FBQ3hDQSxNQUFBQSxFQUFFLENBQUNDLGNBQUg7QUFDQUQsTUFBQUEsRUFBRSxDQUFDRSxlQUFIO0FBRUEsV0FBS0MsUUFBTCxDQUFjO0FBQUVDLFFBQUFBLElBQUksRUFBRTtBQUFSLE9BQWQ7O0FBQ0EsVUFBSTtBQUNBLGNBQU1DLE9BQU8sR0FBRyxDQUFDLEdBQUcsS0FBS0MsS0FBTCxDQUFXQyxZQUFmLEVBQTZCLEdBQUcsS0FBS0QsS0FBTCxDQUFXRSxXQUEzQyxDQUFoQjtBQUNBLGNBQU1DLE1BQU0sR0FBRyxNQUFNLHNDQUFxQixLQUFLVixLQUFMLENBQVdXLE1BQWhDLEVBQXdDTCxPQUF4QyxDQUFyQjs7QUFDQSxjQUFNTSxJQUFJLEdBQUdDLGlDQUFnQkMsR0FBaEIsR0FBc0JDLE9BQXRCLENBQThCLEtBQUtmLEtBQUwsQ0FBV1csTUFBekMsQ0FB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QUFHSSxNQUFBLFFBQVEsRUFBRSxLQUFLM0UsS0FBTCxDQUFXRixJQUh6QjtBQUlJLE1BQUEsU0FBUyxFQUFDO0FBSmQsT0FNTXlFLFVBTk4sQ0FKSixDQURKLENBTEosQ0FESjtBQXVCSDs7QUF4TTJGLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMjAgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QsIHsgQ2hhbmdlRXZlbnQsIEZvcm1FdmVudCB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCBCYXNlRGlhbG9nIGZyb20gXCIuL0Jhc2VEaWFsb2dcIjtcbmltcG9ydCB7IF90IH0gZnJvbSBcIi4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlclwiO1xuaW1wb3J0IHsgSURpYWxvZ1Byb3BzIH0gZnJvbSBcIi4vSURpYWxvZ1Byb3BzXCI7XG5pbXBvcnQgRmllbGQgZnJvbSBcIi4uL2VsZW1lbnRzL0ZpZWxkXCI7XG5pbXBvcnQgQWNjZXNzaWJsZUJ1dHRvbiBmcm9tIFwiLi4vZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvblwiO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSBcIi4uLy4uLy4uL01hdHJpeENsaWVudFBlZ1wiO1xuaW1wb3J0IHsgYXJyYXlGYXN0Q2xvbmUgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvYXJyYXlzXCI7XG5pbXBvcnQgU2RrQ29uZmlnIGZyb20gXCIuLi8uLi8uLi9TZGtDb25maWdcIjtcbmltcG9ydCB7IFJvb21NZW1iZXIgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3Jvb20tbWVtYmVyXCI7XG5pbXBvcnQgSW52aXRlRGlhbG9nIGZyb20gXCIuL0ludml0ZURpYWxvZ1wiO1xuaW1wb3J0IEJhc2VBdmF0YXIgZnJvbSBcIi4uL2F2YXRhcnMvQmFzZUF2YXRhclwiO1xuaW1wb3J0IHsgaW52aXRlTXVsdGlwbGVUb1Jvb20sIHNob3dBbnlJbnZpdGVFcnJvcnMgfSBmcm9tIFwiLi4vLi4vLi4vUm9vbUludml0ZVwiO1xuaW1wb3J0IFN0eWxlZENoZWNrYm94IGZyb20gXCIuLi9lbGVtZW50cy9TdHlsZWRDaGVja2JveFwiO1xuaW1wb3J0IE1vZGFsIGZyb20gXCIuLi8uLi8uLi9Nb2RhbFwiO1xuaW1wb3J0IEVycm9yRGlhbG9nIGZyb20gXCIuL0Vycm9yRGlhbG9nXCI7XG5pbXBvcnQgeyByZXBsYWNlYWJsZUNvbXBvbmVudCB9IGZyb20gXCIuLi8uLi8uLi91dGlscy9yZXBsYWNlYWJsZUNvbXBvbmVudFwiO1xuaW1wb3J0IHsgbWVkaWFGcm9tTXhjIH0gZnJvbSBcIi4uLy4uLy4uL2N1c3RvbWlzYXRpb25zL01lZGlhXCI7XG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcblxuaW50ZXJmYWNlIElQcm9wcyBleHRlbmRzIElEaWFsb2dQcm9wcyB7XG4gICAgcm9vbUlkOiBzdHJpbmc7XG4gICAgY29tbXVuaXR5TmFtZTogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgSVBlcnNvbiB7XG4gICAgdXNlcklkOiBzdHJpbmc7XG4gICAgdXNlcjogUm9vbU1lbWJlcjtcbiAgICBsYXN0QWN0aXZlOiBudW1iZXI7XG59XG5cbmludGVyZmFjZSBJU3RhdGUge1xuICAgIGVtYWlsVGFyZ2V0czogc3RyaW5nW107XG4gICAgdXNlclRhcmdldHM6IHN0cmluZ1tdO1xuICAgIHNob3dQZW9wbGU6IGJvb2xlYW47XG4gICAgcGVvcGxlOiBJUGVyc29uW107XG4gICAgbnVtUGVvcGxlOiBudW1iZXI7XG4gICAgYnVzeTogYm9vbGVhbjtcbn1cblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3MuZGlhbG9ncy5Db21tdW5pdHlQcm90b3R5cGVJbnZpdGVEaWFsb2dcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIENvbW11bml0eVByb3RvdHlwZUludml0ZURpYWxvZyBleHRlbmRzIFJlYWN0LlB1cmVDb21wb25lbnQ8SVByb3BzLCBJU3RhdGU+IHtcbiAgICBjb25zdHJ1Y3Rvcihwcm9wczogSVByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgZW1haWxUYXJnZXRzOiBbXSxcbiAgICAgICAgICAgIHVzZXJUYXJnZXRzOiBbXSxcbiAgICAgICAgICAgIHNob3dQZW9wbGU6IGZhbHNlLFxuICAgICAgICAgICAgcGVvcGxlOiB0aGlzLmJ1aWxkU3VnZ2VzdGlvbnMoKSxcbiAgICAgICAgICAgIG51bVBlb3BsZTogNSwgLy8gYXJiaXRyYXJ5IGRlZmF1bHRcbiAgICAgICAgICAgIGJ1c3k6IGZhbHNlLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgYnVpbGRTdWdnZXN0aW9ucygpOiBJUGVyc29uW10ge1xuICAgICAgICBjb25zdCBhbHJlYWR5SW52aXRlZCA9IG5ldyBTZXQoW01hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRVc2VySWQoKSwgU2RrQ29uZmlnLmdldCgpWyd3ZWxjb21lVXNlcklkJ11dKTtcbiAgICAgICAgaWYgKHRoaXMucHJvcHMucm9vbUlkKSB7XG4gICAgICAgICAgICBjb25zdCByb29tID0gTWF0cml4Q2xpZW50UGVnLmdldCgpLmdldFJvb20odGhpcy5wcm9wcy5yb29tSWQpO1xuICAgICAgICAgICAgaWYgKCFyb29tKSB0aHJvdyBuZXcgRXJyb3IoXCJSb29tIElEIGdpdmVuIHRvIEludml0ZURpYWxvZyBkb2VzIG5vdCBsb29rIGxpa2UgYSByb29tXCIpO1xuICAgICAgICAgICAgcm9vbS5nZXRNZW1iZXJzV2l0aE1lbWJlcnNoaXAoJ2ludml0ZScpLmZvckVhY2gobSA9PiBhbHJlYWR5SW52aXRlZC5hZGQobS51c2VySWQpKTtcbiAgICAgICAgICAgIHJvb20uZ2V0TWVtYmVyc1dpdGhNZW1iZXJzaGlwKCdqb2luJykuZm9yRWFjaChtID0+IGFscmVhZHlJbnZpdGVkLmFkZChtLnVzZXJJZCkpO1xuICAgICAgICAgICAgLy8gYWRkIGJhbm5lZCB1c2Vycywgc28gd2UgZG9uJ3QgdHJ5IHRvIGludml0ZSB0aGVtXG4gICAgICAgICAgICByb29tLmdldE1lbWJlcnNXaXRoTWVtYmVyc2hpcCgnYmFuJykuZm9yRWFjaChtID0+IGFscmVhZHlJbnZpdGVkLmFkZChtLnVzZXJJZCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIEludml0ZURpYWxvZy5idWlsZFJlY2VudHMoYWxyZWFkeUludml0ZWQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25TdWJtaXQgPSBhc3luYyAoZXY6IEZvcm1FdmVudCkgPT4ge1xuICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBldi5zdG9wUHJvcGFnYXRpb24oKTtcblxuICAgICAgICB0aGlzLnNldFN0YXRlKHsgYnVzeTogdHJ1ZSB9KTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHRhcmdldHMgPSBbLi4udGhpcy5zdGF0ZS5lbWFpbFRhcmdldHMsIC4uLnRoaXMuc3RhdGUudXNlclRhcmdldHNdO1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaW52aXRlTXVsdGlwbGVUb1Jvb20odGhpcy5wcm9wcy5yb29tSWQsIHRhcmdldHMpO1xuICAgICAgICAgICAgY29uc3Qgcm9vbSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRSb29tKHRoaXMucHJvcHMucm9vbUlkKTtcbiAgICAgICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBzaG93QW55SW52aXRlRXJyb3JzKHJlc3VsdC5zdGF0ZXMsIHJvb20sIHJlc3VsdC5pbnZpdGVyKTtcbiAgICAgICAgICAgIGlmIChzdWNjZXNzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5wcm9wcy5vbkZpbmlzaGVkKHRydWUpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgYnVzeTogZmFsc2UgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBidXN5OiBmYWxzZSB9KTtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihlKTtcbiAgICAgICAgICAgIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coJ0ZhaWxlZCB0byBpbnZpdGUnLCAnJywgRXJyb3JEaWFsb2csIHtcbiAgICAgICAgICAgICAgICB0aXRsZTogX3QoXCJGYWlsZWQgdG8gaW52aXRlXCIpLFxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAoKGUgJiYgZS5tZXNzYWdlKSA/IGUubWVzc2FnZSA6IF90KFwiT3BlcmF0aW9uIGZhaWxlZFwiKSksXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwcml2YXRlIG9uQWRkcmVzc0NoYW5nZSA9IChldjogQ2hhbmdlRXZlbnQ8SFRNTElucHV0RWxlbWVudD4sIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgICAgY29uc3QgdGFyZ2V0cyA9IGFycmF5RmFzdENsb25lKHRoaXMuc3RhdGUuZW1haWxUYXJnZXRzKTtcbiAgICAgICAgaWYgKGluZGV4ID49IHRhcmdldHMubGVuZ3RoKSB7XG4gICAgICAgICAgICB0YXJnZXRzLnB1c2goZXYudGFyZ2V0LnZhbHVlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRhcmdldHNbaW5kZXhdID0gZXYudGFyZ2V0LnZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBlbWFpbFRhcmdldHM6IHRhcmdldHMgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25BZGRyZXNzQmx1ciA9IChpbmRleDogbnVtYmVyKSA9PiB7XG4gICAgICAgIGNvbnN0IHRhcmdldHMgPSBhcnJheUZhc3RDbG9uZSh0aGlzLnN0YXRlLmVtYWlsVGFyZ2V0cyk7XG4gICAgICAgIGlmIChpbmRleCA+PSB0YXJnZXRzLmxlbmd0aCkgcmV0dXJuOyAvLyBub3QgaW1wb3J0YW50XG4gICAgICAgIGlmICh0YXJnZXRzW2luZGV4XS50cmltKCkgPT09IFwiXCIpIHtcbiAgICAgICAgICAgIHRhcmdldHMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBlbWFpbFRhcmdldHM6IHRhcmdldHMgfSk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvblNob3dQZW9wbGVDbGljayA9ICgpID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IHNob3dQZW9wbGU6ICF0aGlzLnN0YXRlLnNob3dQZW9wbGUgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgc2V0UGVyc29uVG9nZ2xlID0gKHBlcnNvbjogSVBlcnNvbiwgc2VsZWN0ZWQ6IGJvb2xlYW4pID0+IHtcbiAgICAgICAgY29uc3QgdGFyZ2V0cyA9IGFycmF5RmFzdENsb25lKHRoaXMuc3RhdGUudXNlclRhcmdldHMpO1xuICAgICAgICBpZiAoc2VsZWN0ZWQgJiYgIXRhcmdldHMuaW5jbHVkZXMocGVyc29uLnVzZXJJZCkpIHtcbiAgICAgICAgICAgIHRhcmdldHMucHVzaChwZXJzb24udXNlcklkKTtcbiAgICAgICAgfSBlbHNlIGlmICghc2VsZWN0ZWQgJiYgdGFyZ2V0cy5pbmNsdWRlcyhwZXJzb24udXNlcklkKSkge1xuICAgICAgICAgICAgdGFyZ2V0cy5zcGxpY2UodGFyZ2V0cy5pbmRleE9mKHBlcnNvbi51c2VySWQpLCAxKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNldFN0YXRlKHsgdXNlclRhcmdldHM6IHRhcmdldHMgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgcmVuZGVyUGVyc29uKHBlcnNvbjogSVBlcnNvbiwga2V5OiBhbnkpIHtcbiAgICAgICAgY29uc3QgYXZhdGFyU2l6ZSA9IDM2O1xuICAgICAgICBsZXQgYXZhdGFyVXJsID0gbnVsbDtcbiAgICAgICAgaWYgKHBlcnNvbi51c2VyLmdldE14Y0F2YXRhclVybCgpKSB7XG4gICAgICAgICAgICBhdmF0YXJVcmwgPSBtZWRpYUZyb21NeGMocGVyc29uLnVzZXIuZ2V0TXhjQXZhdGFyVXJsKCkpLmdldFNxdWFyZVRodW1ibmFpbEh0dHAoYXZhdGFyU2l6ZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfQ29tbXVuaXR5UHJvdG90eXBlSW52aXRlRGlhbG9nX3BlcnNvblwiIGtleT17a2V5fT5cbiAgICAgICAgICAgICAgICA8QmFzZUF2YXRhclxuICAgICAgICAgICAgICAgICAgICB1cmw9e2F2YXRhclVybH1cbiAgICAgICAgICAgICAgICAgICAgbmFtZT17cGVyc29uLnVzZXIubmFtZX1cbiAgICAgICAgICAgICAgICAgICAgaWROYW1lPXtwZXJzb24udXNlci51c2VySWR9XG4gICAgICAgICAgICAgICAgICAgIHdpZHRoPXthdmF0YXJTaXplfVxuICAgICAgICAgICAgICAgICAgICBoZWlnaHQ9e2F2YXRhclNpemV9XG4gICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0NvbW11bml0eVByb3RvdHlwZUludml0ZURpYWxvZ19wZXJzb25JZGVudGlmaWVyc1wiPlxuICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9XCJteF9Db21tdW5pdHlQcm90b3R5cGVJbnZpdGVEaWFsb2dfcGVyc29uTmFtZVwiPnsgcGVyc29uLnVzZXIubmFtZSB9PC9zcGFuPlxuICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9XCJteF9Db21tdW5pdHlQcm90b3R5cGVJbnZpdGVEaWFsb2dfcGVyc29uSWRcIj57IHBlcnNvbi51c2VySWQgfTwvc3Bhbj5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICA8U3R5bGVkQ2hlY2tib3ggb25DaGFuZ2U9eyhlKSA9PiB0aGlzLnNldFBlcnNvblRvZ2dsZShwZXJzb24sIGUudGFyZ2V0LmNoZWNrZWQpfSAvPlxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvblNob3dNb3JlUGVvcGxlID0gKCkgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgbnVtUGVvcGxlOiB0aGlzLnN0YXRlLm51bVBlb3BsZSArIDUgfSk7IC8vIGFyYml0cmFyeSBpbmNyZWFzZVxuICAgIH07XG5cbiAgICBwdWJsaWMgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCBlbWFpbEFkZHJlc3NlcyA9IFtdO1xuICAgICAgICB0aGlzLnN0YXRlLmVtYWlsVGFyZ2V0cy5mb3JFYWNoKChhZGRyZXNzLCBpKSA9PiB7XG4gICAgICAgICAgICBlbWFpbEFkZHJlc3Nlcy5wdXNoKChcbiAgICAgICAgICAgICAgICA8RmllbGRcbiAgICAgICAgICAgICAgICAgICAga2V5PXtpfVxuICAgICAgICAgICAgICAgICAgICB2YWx1ZT17YWRkcmVzc31cbiAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2U9eyhlKSA9PiB0aGlzLm9uQWRkcmVzc0NoYW5nZShlLCBpKX1cbiAgICAgICAgICAgICAgICAgICAgbGFiZWw9e190KFwiRW1haWwgYWRkcmVzc1wiKX1cbiAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI9e190KFwiRW1haWwgYWRkcmVzc1wiKX1cbiAgICAgICAgICAgICAgICAgICAgb25CbHVyPXsoKSA9PiB0aGlzLm9uQWRkcmVzc0JsdXIoaSl9XG4gICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICkpO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBQdXNoIGEgY2xlYW4gaW5wdXRcbiAgICAgICAgZW1haWxBZGRyZXNzZXMucHVzaCgoXG4gICAgICAgICAgICA8RmllbGRcbiAgICAgICAgICAgICAgICBrZXk9e2VtYWlsQWRkcmVzc2VzLmxlbmd0aH1cbiAgICAgICAgICAgICAgICB2YWx1ZT1cIlwiXG4gICAgICAgICAgICAgICAgb25DaGFuZ2U9eyhlKSA9PiB0aGlzLm9uQWRkcmVzc0NoYW5nZShlLCBlbWFpbEFkZHJlc3Nlcy5sZW5ndGgpfVxuICAgICAgICAgICAgICAgIGxhYmVsPXtlbWFpbEFkZHJlc3Nlcy5sZW5ndGggPiAwID8gX3QoXCJBZGQgYW5vdGhlciBlbWFpbFwiKSA6IF90KFwiRW1haWwgYWRkcmVzc1wiKX1cbiAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcj17ZW1haWxBZGRyZXNzZXMubGVuZ3RoID4gMCA/IF90KFwiQWRkIGFub3RoZXIgZW1haWxcIikgOiBfdChcIkVtYWlsIGFkZHJlc3NcIil9XG4gICAgICAgICAgICAvPlxuICAgICAgICApKTtcblxuICAgICAgICBsZXQgcGVvcGxlSW50cm8gPSBudWxsO1xuICAgICAgICBjb25zdCBwZW9wbGUgPSBbXTtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuc2hvd1Blb3BsZSkge1xuICAgICAgICAgICAgY29uc3QgaHVtYW5zVG9QcmVzZW50ID0gdGhpcy5zdGF0ZS5wZW9wbGUuc2xpY2UoMCwgdGhpcy5zdGF0ZS5udW1QZW9wbGUpO1xuICAgICAgICAgICAgaHVtYW5zVG9QcmVzZW50LmZvckVhY2goKHBlcnNvbiwgaSkgPT4ge1xuICAgICAgICAgICAgICAgIHBlb3BsZS5wdXNoKHRoaXMucmVuZGVyUGVyc29uKHBlcnNvbiwgaSkpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpZiAoaHVtYW5zVG9QcmVzZW50Lmxlbmd0aCA8IHRoaXMuc3RhdGUucGVvcGxlLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHBlb3BsZS5wdXNoKChcbiAgICAgICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b25cbiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s9e3RoaXMub25TaG93TW9yZVBlb3BsZX1cbiAgICAgICAgICAgICAgICAgICAgICAgIGtpbmQ9XCJsaW5rXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIGtleT1cIm1vcmVcIlxuICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfQ29tbXVuaXR5UHJvdG90eXBlSW52aXRlRGlhbG9nX21vcmVQZW9wbGVcIlxuICAgICAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICAgICAgICB7IF90KFwiU2hvdyBtb3JlXCIpIH1cbiAgICAgICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgICAgICkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnBlb3BsZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBwZW9wbGVJbnRybyA9IChcbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0NvbW11bml0eVByb3RvdHlwZUludml0ZURpYWxvZ19wZW9wbGVcIj5cbiAgICAgICAgICAgICAgICAgICAgPHNwYW4+eyBfdChcIlBlb3BsZSB5b3Uga25vdyBvbiAlKGJyYW5kKXNcIiwgeyBicmFuZDogU2RrQ29uZmlnLmdldCgpLmJyYW5kIH0pIH08L3NwYW4+XG4gICAgICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uIG9uQ2xpY2s9e3RoaXMub25TaG93UGVvcGxlQ2xpY2t9PlxuICAgICAgICAgICAgICAgICAgICAgICAgeyB0aGlzLnN0YXRlLnNob3dQZW9wbGUgPyBfdChcIkhpZGVcIikgOiBfdChcIlNob3dcIikgfVxuICAgICAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGJ1dHRvblRleHQgPSBfdChcIlNraXBcIik7XG4gICAgICAgIGNvbnN0IHRhcmdldENvdW50ID0gdGhpcy5zdGF0ZS51c2VyVGFyZ2V0cy5sZW5ndGggKyB0aGlzLnN0YXRlLmVtYWlsVGFyZ2V0cy5sZW5ndGg7XG4gICAgICAgIGlmICh0YXJnZXRDb3VudCA+IDApIHtcbiAgICAgICAgICAgIGJ1dHRvblRleHQgPSBfdChcIlNlbmQgJShjb3VudClzIGludml0ZXNcIiwgeyBjb3VudDogdGFyZ2V0Q291bnQgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPEJhc2VEaWFsb2dcbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9Db21tdW5pdHlQcm90b3R5cGVJbnZpdGVEaWFsb2dcIlxuICAgICAgICAgICAgICAgIG9uRmluaXNoZWQ9e3RoaXMucHJvcHMub25GaW5pc2hlZH1cbiAgICAgICAgICAgICAgICB0aXRsZT17X3QoXCJJbnZpdGUgcGVvcGxlIHRvIGpvaW4gJShjb21tdW5pdHlOYW1lKXNcIiwgeyBjb21tdW5pdHlOYW1lOiB0aGlzLnByb3BzLmNvbW11bml0eU5hbWUgfSl9XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgPGZvcm0gb25TdWJtaXQ9e3RoaXMub25TdWJtaXR9PlxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0RpYWxvZ19jb250ZW50XCI+XG4gICAgICAgICAgICAgICAgICAgICAgICB7IGVtYWlsQWRkcmVzc2VzIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgcGVvcGxlSW50cm8gfVxuICAgICAgICAgICAgICAgICAgICAgICAgeyBwZW9wbGUgfVxuICAgICAgICAgICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b25cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBraW5kPVwicHJpbWFyeVwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5vblN1Ym1pdH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZD17dGhpcy5zdGF0ZS5idXN5fVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X0NvbW11bml0eVByb3RvdHlwZUludml0ZURpYWxvZ19wcmltYXJ5QnV0dG9uXCJcbiAgICAgICAgICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IGJ1dHRvblRleHQgfVxuICAgICAgICAgICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICA8L2Zvcm0+XG4gICAgICAgICAgICA8L0Jhc2VEaWFsb2c+XG4gICAgICAgICk7XG4gICAgfVxufVxuIl19