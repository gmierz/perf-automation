"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var _languageHandler = require("../../../languageHandler");

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _BaseDialog = _interopRequireDefault(require("./BaseDialog"));

var _Spinner = _interopRequireDefault(require("../elements/Spinner"));

var _dec, _class;

let CreateGroupDialog = (_dec = (0, _replaceableComponent.replaceableComponent)("views.dialogs.CreateGroupDialog"), _dec(_class = class CreateGroupDialog extends _react.default.Component {
  constructor(...args) {
    super(...args);
    (0, _defineProperty2.default)(this, "state", {
      groupName: '',
      groupId: '',
      groupIdError: '',
      creating: false,
      createError: null
    });
    (0, _defineProperty2.default)(this, "onGroupNameChange", e => {
      this.setState({
        groupName: e.currentTarget.value
      });
    });
    (0, _defineProperty2.default)(this, "onGroupIdChange", e => {
      this.setState({
        groupId: e.currentTarget.value
      });
    });
    (0, _defineProperty2.default)(this, "onGroupIdBlur", () => {
      this.checkGroupId();
    });
    (0, _defineProperty2.default)(this, "onFormSubmit", e => {
      e.preventDefault();
      if (this.checkGroupId()) return;
      const profile = {};

      if (this.state.groupName !== '') {
        profile.name = this.state.groupName;
      }

      this.setState({
        creating: true
      });

      _MatrixClientPeg.MatrixClientPeg.get().createGroup({
        localpart: this.state.groupId,
        profile: profile
      }).then(result => {
        _dispatcher.default.dispatch({
          action: 'view_group',
          group_id: result.group_id,
          group_is_new: true
        });

        this.props.onFinished(true);
      }).catch(e => {
        this.setState({
          createError: e
        });
      }).finally(() => {
        this.setState({
          creating: false
        });
      });
    });
    (0, _defineProperty2.default)(this, "onCancel", () => {
      this.props.onFinished(false);
    });
  }

  checkGroupId() {
    let error = null;

    if (!this.state.groupId) {
      error = (0, _languageHandler._t)("Community IDs cannot be empty.");
    } else if (!/^[a-z0-9=_\-./]*$/.test(this.state.groupId)) {
      error = (0, _languageHandler._t)("Community IDs may only contain characters a-z, 0-9, or '=_-./'");
    }

    this.setState({
      groupIdError: error,
      // Reset createError to get rid of now stale error message
      createError: null
    });
    return error;
  }

  render() {
    if (this.state.creating) {
      return /*#__PURE__*/_react.default.createElement(_Spinner.default, null);
    }

    let createErrorNode;

    if (this.state.createError) {
      // XXX: We should catch errcodes and give sensible i18ned messages for them,
      // rather than displaying what the server gives us, but synapse doesn't give
      // any yet.
      createErrorNode = /*#__PURE__*/_react.default.createElement("div", {
        className: "error",
        role: "alert"
      }, /*#__PURE__*/_react.default.createElement("div", null, (0, _languageHandler._t)('Something went wrong whilst creating your community')), /*#__PURE__*/_react.default.createElement("div", null, this.state.createError.message));
    }

    return /*#__PURE__*/_react.default.createElement(_BaseDialog.default, {
      className: "mx_CreateGroupDialog",
      onFinished: this.props.onFinished,
      title: (0, _languageHandler._t)('Create Community')
    }, /*#__PURE__*/_react.default.createElement("form", {
      onSubmit: this.onFormSubmit
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_Dialog_content"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_CreateGroupDialog_inputRow"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_CreateGroupDialog_label"
    }, /*#__PURE__*/_react.default.createElement("label", {
      htmlFor: "groupname"
    }, (0, _languageHandler._t)('Community Name'))), /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("input", {
      id: "groupname",
      className: "mx_CreateGroupDialog_input",
      autoFocus: true,
      size: 64,
      placeholder: (0, _languageHandler._t)('Example'),
      onChange: this.onGroupNameChange,
      value: this.state.groupName
    }))), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_CreateGroupDialog_inputRow"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_CreateGroupDialog_label"
    }, /*#__PURE__*/_react.default.createElement("label", {
      htmlFor: "groupid"
    }, (0, _languageHandler._t)('Community ID'))), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_CreateGroupDialog_input_group"
    }, /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_CreateGroupDialog_prefix"
    }, "+"), /*#__PURE__*/_react.default.createElement("input", {
      id: "groupid",
      className: "mx_CreateGroupDialog_input mx_CreateGroupDialog_input_hasPrefixAndSuffix",
      size: 32,
      placeholder: (0, _languageHandler._t)('example'),
      onChange: this.onGroupIdChange,
      onBlur: this.onGroupIdBlur,
      value: this.state.groupId
    }), /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_CreateGroupDialog_suffix"
    }, ":", _MatrixClientPeg.MatrixClientPeg.get().getDomain()))), /*#__PURE__*/_react.default.createElement("div", {
      className: "error"
    }, this.state.groupIdError), createErrorNode), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_Dialog_buttons"
    }, /*#__PURE__*/_react.default.createElement("input", {
      type: "submit",
      value: (0, _languageHandler._t)('Create'),
      className: "mx_Dialog_primary"
    }), /*#__PURE__*/_react.default.createElement("button", {
      onClick: this.onCancel
    }, (0, _languageHandler._t)("Cancel")))));
  }

}) || _class);
exports.default = CreateGroupDialog;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvQ3JlYXRlR3JvdXBEaWFsb2cudHN4Il0sIm5hbWVzIjpbIkNyZWF0ZUdyb3VwRGlhbG9nIiwiUmVhY3QiLCJDb21wb25lbnQiLCJncm91cE5hbWUiLCJncm91cElkIiwiZ3JvdXBJZEVycm9yIiwiY3JlYXRpbmciLCJjcmVhdGVFcnJvciIsImUiLCJzZXRTdGF0ZSIsImN1cnJlbnRUYXJnZXQiLCJ2YWx1ZSIsImNoZWNrR3JvdXBJZCIsInByZXZlbnREZWZhdWx0IiwicHJvZmlsZSIsInN0YXRlIiwibmFtZSIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsImNyZWF0ZUdyb3VwIiwibG9jYWxwYXJ0IiwidGhlbiIsInJlc3VsdCIsImRpcyIsImRpc3BhdGNoIiwiYWN0aW9uIiwiZ3JvdXBfaWQiLCJncm91cF9pc19uZXciLCJwcm9wcyIsIm9uRmluaXNoZWQiLCJjYXRjaCIsImZpbmFsbHkiLCJlcnJvciIsInRlc3QiLCJyZW5kZXIiLCJjcmVhdGVFcnJvck5vZGUiLCJtZXNzYWdlIiwib25Gb3JtU3VibWl0Iiwib25Hcm91cE5hbWVDaGFuZ2UiLCJvbkdyb3VwSWRDaGFuZ2UiLCJvbkdyb3VwSWRCbHVyIiwiZ2V0RG9tYWluIiwib25DYW5jZWwiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0lBZXFCQSxpQixXQURwQixnREFBcUIsaUNBQXJCLEMsZ0JBQUQsTUFDcUJBLGlCQURyQixTQUMrQ0MsZUFBTUMsU0FEckQsQ0FDK0U7QUFBQTtBQUFBO0FBQUEsaURBQzVEO0FBQ1hDLE1BQUFBLFNBQVMsRUFBRSxFQURBO0FBRVhDLE1BQUFBLE9BQU8sRUFBRSxFQUZFO0FBR1hDLE1BQUFBLFlBQVksRUFBRSxFQUhIO0FBSVhDLE1BQUFBLFFBQVEsRUFBRSxLQUpDO0FBS1hDLE1BQUFBLFdBQVcsRUFBRTtBQUxGLEtBRDREO0FBQUEsNkRBUzlDQyxDQUFELElBQWdEO0FBQ3hFLFdBQUtDLFFBQUwsQ0FBYztBQUNWTixRQUFBQSxTQUFTLEVBQUVLLENBQUMsQ0FBQ0UsYUFBRixDQUFnQkM7QUFEakIsT0FBZDtBQUdILEtBYjBFO0FBQUEsMkRBZWhESCxDQUFELElBQWdEO0FBQ3RFLFdBQUtDLFFBQUwsQ0FBYztBQUNWTCxRQUFBQSxPQUFPLEVBQUVJLENBQUMsQ0FBQ0UsYUFBRixDQUFnQkM7QUFEZixPQUFkO0FBR0gsS0FuQjBFO0FBQUEseURBcUJuRCxNQUFZO0FBQ2hDLFdBQUtDLFlBQUw7QUFDSCxLQXZCMEU7QUFBQSx3REF3Q25ESixDQUFELElBQXlDO0FBQzVEQSxNQUFBQSxDQUFDLENBQUNLLGNBQUY7QUFFQSxVQUFJLEtBQUtELFlBQUwsRUFBSixFQUF5QjtBQUV6QixZQUFNRSxPQUFZLEdBQUcsRUFBckI7O0FBQ0EsVUFBSSxLQUFLQyxLQUFMLENBQVdaLFNBQVgsS0FBeUIsRUFBN0IsRUFBaUM7QUFDN0JXLFFBQUFBLE9BQU8sQ0FBQ0UsSUFBUixHQUFlLEtBQUtELEtBQUwsQ0FBV1osU0FBMUI7QUFDSDs7QUFDRCxXQUFLTSxRQUFMLENBQWM7QUFBRUgsUUFBQUEsUUFBUSxFQUFFO0FBQVosT0FBZDs7QUFDQVcsdUNBQWdCQyxHQUFoQixHQUFzQkMsV0FBdEIsQ0FBa0M7QUFDOUJDLFFBQUFBLFNBQVMsRUFBRSxLQUFLTCxLQUFMLENBQVdYLE9BRFE7QUFFOUJVLFFBQUFBLE9BQU8sRUFBRUE7QUFGcUIsT0FBbEMsRUFHR08sSUFISCxDQUdTQyxNQUFELElBQVk7QUFDaEJDLDRCQUFJQyxRQUFKLENBQWE7QUFDVEMsVUFBQUEsTUFBTSxFQUFFLFlBREM7QUFFVEMsVUFBQUEsUUFBUSxFQUFFSixNQUFNLENBQUNJLFFBRlI7QUFHVEMsVUFBQUEsWUFBWSxFQUFFO0FBSEwsU0FBYjs7QUFLQSxhQUFLQyxLQUFMLENBQVdDLFVBQVgsQ0FBc0IsSUFBdEI7QUFDSCxPQVZELEVBVUdDLEtBVkgsQ0FVVXRCLENBQUQsSUFBTztBQUNaLGFBQUtDLFFBQUwsQ0FBYztBQUFFRixVQUFBQSxXQUFXLEVBQUVDO0FBQWYsU0FBZDtBQUNILE9BWkQsRUFZR3VCLE9BWkgsQ0FZVyxNQUFNO0FBQ2IsYUFBS3RCLFFBQUwsQ0FBYztBQUFFSCxVQUFBQSxRQUFRLEVBQUU7QUFBWixTQUFkO0FBQ0gsT0FkRDtBQWVILEtBakUwRTtBQUFBLG9EQW1FeEQsTUFBTTtBQUNyQixXQUFLc0IsS0FBTCxDQUFXQyxVQUFYLENBQXNCLEtBQXRCO0FBQ0gsS0FyRTBFO0FBQUE7O0FBeUJuRWpCLEVBQUFBLFlBQVksR0FBRztBQUNuQixRQUFJb0IsS0FBSyxHQUFHLElBQVo7O0FBQ0EsUUFBSSxDQUFDLEtBQUtqQixLQUFMLENBQVdYLE9BQWhCLEVBQXlCO0FBQ3JCNEIsTUFBQUEsS0FBSyxHQUFHLHlCQUFHLGdDQUFILENBQVI7QUFDSCxLQUZELE1BRU8sSUFBSSxDQUFDLG9CQUFvQkMsSUFBcEIsQ0FBeUIsS0FBS2xCLEtBQUwsQ0FBV1gsT0FBcEMsQ0FBTCxFQUFtRDtBQUN0RDRCLE1BQUFBLEtBQUssR0FBRyx5QkFBRyxnRUFBSCxDQUFSO0FBQ0g7O0FBQ0QsU0FBS3ZCLFFBQUwsQ0FBYztBQUNWSixNQUFBQSxZQUFZLEVBQUUyQixLQURKO0FBRVY7QUFDQXpCLE1BQUFBLFdBQVcsRUFBRTtBQUhILEtBQWQ7QUFLQSxXQUFPeUIsS0FBUDtBQUNIOztBQWlDREUsRUFBQUEsTUFBTSxHQUFHO0FBQ0wsUUFBSSxLQUFLbkIsS0FBTCxDQUFXVCxRQUFmLEVBQXlCO0FBQ3JCLDBCQUFPLDZCQUFDLGdCQUFELE9BQVA7QUFDSDs7QUFFRCxRQUFJNkIsZUFBSjs7QUFDQSxRQUFJLEtBQUtwQixLQUFMLENBQVdSLFdBQWYsRUFBNEI7QUFDeEI7QUFDQTtBQUNBO0FBQ0E0QixNQUFBQSxlQUFlLGdCQUFHO0FBQUssUUFBQSxTQUFTLEVBQUMsT0FBZjtBQUF1QixRQUFBLElBQUksRUFBQztBQUE1QixzQkFDZCwwQ0FBTyx5QkFBRyxxREFBSCxDQUFQLENBRGMsZUFFZCwwQ0FBTyxLQUFLcEIsS0FBTCxDQUFXUixXQUFYLENBQXVCNkIsT0FBOUIsQ0FGYyxDQUFsQjtBQUlIOztBQUVELHdCQUNJLDZCQUFDLG1CQUFEO0FBQ0ksTUFBQSxTQUFTLEVBQUMsc0JBRGQ7QUFFSSxNQUFBLFVBQVUsRUFBRSxLQUFLUixLQUFMLENBQVdDLFVBRjNCO0FBR0ksTUFBQSxLQUFLLEVBQUUseUJBQUcsa0JBQUg7QUFIWCxvQkFLSTtBQUFNLE1BQUEsUUFBUSxFQUFFLEtBQUtRO0FBQXJCLG9CQUNJO0FBQUssTUFBQSxTQUFTLEVBQUM7QUFBZixvQkFDSTtBQUFLLE1BQUEsU0FBUyxFQUFDO0FBQWYsb0JBQ0k7QUFBSyxNQUFBLFNBQVMsRUFBQztBQUFmLG9CQUNJO0FBQU8sTUFBQSxPQUFPLEVBQUM7QUFBZixPQUE2Qix5QkFBRyxnQkFBSCxDQUE3QixDQURKLENBREosZUFJSSx1REFDSTtBQUNJLE1BQUEsRUFBRSxFQUFDLFdBRFA7QUFFSSxNQUFBLFNBQVMsRUFBQyw0QkFGZDtBQUdJLE1BQUEsU0FBUyxFQUFFLElBSGY7QUFJSSxNQUFBLElBQUksRUFBRSxFQUpWO0FBS0ksTUFBQSxXQUFXLEVBQUUseUJBQUcsU0FBSCxDQUxqQjtBQU1JLE1BQUEsUUFBUSxFQUFFLEtBQUtDLGlCQU5uQjtBQU9JLE1BQUEsS0FBSyxFQUFFLEtBQUt2QixLQUFMLENBQVdaO0FBUHRCLE1BREosQ0FKSixDQURKLGVBaUJJO0FBQUssTUFBQSxTQUFTLEVBQUM7QUFBZixvQkFDSTtBQUFLLE1BQUEsU0FBUyxFQUFDO0FBQWYsb0JBQ0k7QUFBTyxNQUFBLE9BQU8sRUFBQztBQUFmLE9BQTJCLHlCQUFHLGNBQUgsQ0FBM0IsQ0FESixDQURKLGVBSUk7QUFBSyxNQUFBLFNBQVMsRUFBQztBQUFmLG9CQUNJO0FBQU0sTUFBQSxTQUFTLEVBQUM7QUFBaEIsV0FESixlQUVJO0FBQU8sTUFBQSxFQUFFLEVBQUMsU0FBVjtBQUNJLE1BQUEsU0FBUyxFQUFDLDBFQURkO0FBRUksTUFBQSxJQUFJLEVBQUUsRUFGVjtBQUdJLE1BQUEsV0FBVyxFQUFFLHlCQUFHLFNBQUgsQ0FIakI7QUFJSSxNQUFBLFFBQVEsRUFBRSxLQUFLb0MsZUFKbkI7QUFLSSxNQUFBLE1BQU0sRUFBRSxLQUFLQyxhQUxqQjtBQU1JLE1BQUEsS0FBSyxFQUFFLEtBQUt6QixLQUFMLENBQVdYO0FBTnRCLE1BRkosZUFVSTtBQUFNLE1BQUEsU0FBUyxFQUFDO0FBQWhCLFlBQ09hLGlDQUFnQkMsR0FBaEIsR0FBc0J1QixTQUF0QixFQURQLENBVkosQ0FKSixDQWpCSixlQW9DSTtBQUFLLE1BQUEsU0FBUyxFQUFDO0FBQWYsT0FDTSxLQUFLMUIsS0FBTCxDQUFXVixZQURqQixDQXBDSixFQXVDTThCLGVBdkNOLENBREosZUEwQ0k7QUFBSyxNQUFBLFNBQVMsRUFBQztBQUFmLG9CQUNJO0FBQU8sTUFBQSxJQUFJLEVBQUMsUUFBWjtBQUFxQixNQUFBLEtBQUssRUFBRSx5QkFBRyxRQUFILENBQTVCO0FBQTBDLE1BQUEsU0FBUyxFQUFDO0FBQXBELE1BREosZUFFSTtBQUFRLE1BQUEsT0FBTyxFQUFFLEtBQUtPO0FBQXRCLE9BQ00seUJBQUcsUUFBSCxDQUROLENBRkosQ0ExQ0osQ0FMSixDQURKO0FBeURIOztBQWhKMEUsQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNyBWZWN0b3IgQ3JlYXRpb25zIEx0ZFxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgZGlzIGZyb20gJy4uLy4uLy4uL2Rpc3BhdGNoZXIvZGlzcGF0Y2hlcic7XG5pbXBvcnQgeyBfdCB9IGZyb20gJy4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlcic7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tICcuLi8uLi8uLi9NYXRyaXhDbGllbnRQZWcnO1xuaW1wb3J0IHsgcmVwbGFjZWFibGVDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvcmVwbGFjZWFibGVDb21wb25lbnRcIjtcbmltcG9ydCBCYXNlRGlhbG9nIGZyb20gXCIuL0Jhc2VEaWFsb2dcIjtcbmltcG9ydCBTcGlubmVyIGZyb20gXCIuLi9lbGVtZW50cy9TcGlubmVyXCI7XG5cbmludGVyZmFjZSBJUHJvcHMge1xuICAgIG9uRmluaXNoZWQ6IChzdWNjZXNzOiBib29sZWFuKSA9PiB2b2lkO1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBncm91cE5hbWU6IHN0cmluZztcbiAgICBncm91cElkOiBzdHJpbmc7XG4gICAgZ3JvdXBJZEVycm9yOiBzdHJpbmc7XG4gICAgY3JlYXRpbmc6IGJvb2xlYW47XG4gICAgY3JlYXRlRXJyb3I6IEVycm9yO1xufVxuXG5AcmVwbGFjZWFibGVDb21wb25lbnQoXCJ2aWV3cy5kaWFsb2dzLkNyZWF0ZUdyb3VwRGlhbG9nXCIpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDcmVhdGVHcm91cERpYWxvZyBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxJUHJvcHMsIElTdGF0ZT4ge1xuICAgIHB1YmxpYyBzdGF0ZSA9IHtcbiAgICAgICAgZ3JvdXBOYW1lOiAnJyxcbiAgICAgICAgZ3JvdXBJZDogJycsXG4gICAgICAgIGdyb3VwSWRFcnJvcjogJycsXG4gICAgICAgIGNyZWF0aW5nOiBmYWxzZSxcbiAgICAgICAgY3JlYXRlRXJyb3I6IG51bGwsXG4gICAgfTtcblxuICAgIHByaXZhdGUgb25Hcm91cE5hbWVDaGFuZ2UgPSAoZTogUmVhY3QuRm9ybUV2ZW50PEhUTUxJbnB1dEVsZW1lbnQ+KTogdm9pZCA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgZ3JvdXBOYW1lOiBlLmN1cnJlbnRUYXJnZXQudmFsdWUsXG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uR3JvdXBJZENoYW5nZSA9IChlOiBSZWFjdC5Gb3JtRXZlbnQ8SFRNTElucHV0RWxlbWVudD4pOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBncm91cElkOiBlLmN1cnJlbnRUYXJnZXQudmFsdWUsXG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uR3JvdXBJZEJsdXIgPSAoKTogdm9pZCA9PiB7XG4gICAgICAgIHRoaXMuY2hlY2tHcm91cElkKCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgY2hlY2tHcm91cElkKCkge1xuICAgICAgICBsZXQgZXJyb3IgPSBudWxsO1xuICAgICAgICBpZiAoIXRoaXMuc3RhdGUuZ3JvdXBJZCkge1xuICAgICAgICAgICAgZXJyb3IgPSBfdChcIkNvbW11bml0eSBJRHMgY2Fubm90IGJlIGVtcHR5LlwiKTtcbiAgICAgICAgfSBlbHNlIGlmICghL15bYS16MC05PV9cXC0uL10qJC8udGVzdCh0aGlzLnN0YXRlLmdyb3VwSWQpKSB7XG4gICAgICAgICAgICBlcnJvciA9IF90KFwiQ29tbXVuaXR5IElEcyBtYXkgb25seSBjb250YWluIGNoYXJhY3RlcnMgYS16LCAwLTksIG9yICc9Xy0uLydcIik7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBncm91cElkRXJyb3I6IGVycm9yLFxuICAgICAgICAgICAgLy8gUmVzZXQgY3JlYXRlRXJyb3IgdG8gZ2V0IHJpZCBvZiBub3cgc3RhbGUgZXJyb3IgbWVzc2FnZVxuICAgICAgICAgICAgY3JlYXRlRXJyb3I6IG51bGwsXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gZXJyb3I7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkZvcm1TdWJtaXQgPSAoZTogUmVhY3QuRm9ybUV2ZW50PEhUTUxGb3JtRWxlbWVudD4pID0+IHtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAgIGlmICh0aGlzLmNoZWNrR3JvdXBJZCgpKSByZXR1cm47XG5cbiAgICAgICAgY29uc3QgcHJvZmlsZTogYW55ID0ge307XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLmdyb3VwTmFtZSAhPT0gJycpIHtcbiAgICAgICAgICAgIHByb2ZpbGUubmFtZSA9IHRoaXMuc3RhdGUuZ3JvdXBOYW1lO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBjcmVhdGluZzogdHJ1ZSB9KTtcbiAgICAgICAgTWF0cml4Q2xpZW50UGVnLmdldCgpLmNyZWF0ZUdyb3VwKHtcbiAgICAgICAgICAgIGxvY2FscGFydDogdGhpcy5zdGF0ZS5ncm91cElkLFxuICAgICAgICAgICAgcHJvZmlsZTogcHJvZmlsZSxcbiAgICAgICAgfSkudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICAgICAgICBkaXMuZGlzcGF0Y2goe1xuICAgICAgICAgICAgICAgIGFjdGlvbjogJ3ZpZXdfZ3JvdXAnLFxuICAgICAgICAgICAgICAgIGdyb3VwX2lkOiByZXN1bHQuZ3JvdXBfaWQsXG4gICAgICAgICAgICAgICAgZ3JvdXBfaXNfbmV3OiB0cnVlLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0aGlzLnByb3BzLm9uRmluaXNoZWQodHJ1ZSk7XG4gICAgICAgIH0pLmNhdGNoKChlKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgY3JlYXRlRXJyb3I6IGUgfSk7XG4gICAgICAgIH0pLmZpbmFsbHkoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGNyZWF0aW5nOiBmYWxzZSB9KTtcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25DYW5jZWwgPSAoKSA9PiB7XG4gICAgICAgIHRoaXMucHJvcHMub25GaW5pc2hlZChmYWxzZSk7XG4gICAgfTtcblxuICAgIHJlbmRlcigpIHtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuY3JlYXRpbmcpIHtcbiAgICAgICAgICAgIHJldHVybiA8U3Bpbm5lciAvPjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBjcmVhdGVFcnJvck5vZGU7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLmNyZWF0ZUVycm9yKSB7XG4gICAgICAgICAgICAvLyBYWFg6IFdlIHNob3VsZCBjYXRjaCBlcnJjb2RlcyBhbmQgZ2l2ZSBzZW5zaWJsZSBpMThuZWQgbWVzc2FnZXMgZm9yIHRoZW0sXG4gICAgICAgICAgICAvLyByYXRoZXIgdGhhbiBkaXNwbGF5aW5nIHdoYXQgdGhlIHNlcnZlciBnaXZlcyB1cywgYnV0IHN5bmFwc2UgZG9lc24ndCBnaXZlXG4gICAgICAgICAgICAvLyBhbnkgeWV0LlxuICAgICAgICAgICAgY3JlYXRlRXJyb3JOb2RlID0gPGRpdiBjbGFzc05hbWU9XCJlcnJvclwiIHJvbGU9XCJhbGVydFwiPlxuICAgICAgICAgICAgICAgIDxkaXY+eyBfdCgnU29tZXRoaW5nIHdlbnQgd3Jvbmcgd2hpbHN0IGNyZWF0aW5nIHlvdXIgY29tbXVuaXR5JykgfTwvZGl2PlxuICAgICAgICAgICAgICAgIDxkaXY+eyB0aGlzLnN0YXRlLmNyZWF0ZUVycm9yLm1lc3NhZ2UgfTwvZGl2PlxuICAgICAgICAgICAgPC9kaXY+O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxCYXNlRGlhbG9nXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfQ3JlYXRlR3JvdXBEaWFsb2dcIlxuICAgICAgICAgICAgICAgIG9uRmluaXNoZWQ9e3RoaXMucHJvcHMub25GaW5pc2hlZH1cbiAgICAgICAgICAgICAgICB0aXRsZT17X3QoJ0NyZWF0ZSBDb21tdW5pdHknKX1cbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICA8Zm9ybSBvblN1Ym1pdD17dGhpcy5vbkZvcm1TdWJtaXR9PlxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0RpYWxvZ19jb250ZW50XCI+XG4gICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0NyZWF0ZUdyb3VwRGlhbG9nX2lucHV0Um93XCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9DcmVhdGVHcm91cERpYWxvZ19sYWJlbFwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8bGFiZWwgaHRtbEZvcj1cImdyb3VwbmFtZVwiPnsgX3QoJ0NvbW11bml0eSBOYW1lJykgfTwvbGFiZWw+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZD1cImdyb3VwbmFtZVwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9DcmVhdGVHcm91cERpYWxvZ19pbnB1dFwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdXRvRm9jdXM9e3RydWV9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaXplPXs2NH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyPXtfdCgnRXhhbXBsZScpfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2U9e3RoaXMub25Hcm91cE5hbWVDaGFuZ2V9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZT17dGhpcy5zdGF0ZS5ncm91cE5hbWV9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfQ3JlYXRlR3JvdXBEaWFsb2dfaW5wdXRSb3dcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0NyZWF0ZUdyb3VwRGlhbG9nX2xhYmVsXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxsYWJlbCBodG1sRm9yPVwiZ3JvdXBpZFwiPnsgX3QoJ0NvbW11bml0eSBJRCcpIH08L2xhYmVsPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfQ3JlYXRlR3JvdXBEaWFsb2dfaW5wdXRfZ3JvdXBcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3NOYW1lPVwibXhfQ3JlYXRlR3JvdXBEaWFsb2dfcHJlZml4XCI+Kzwvc3Bhbj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IGlkPVwiZ3JvdXBpZFwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9DcmVhdGVHcm91cERpYWxvZ19pbnB1dCBteF9DcmVhdGVHcm91cERpYWxvZ19pbnB1dF9oYXNQcmVmaXhBbmRTdWZmaXhcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZT17MzJ9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcj17X3QoJ2V4YW1wbGUnKX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2hhbmdlPXt0aGlzLm9uR3JvdXBJZENoYW5nZX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uQmx1cj17dGhpcy5vbkdyb3VwSWRCbHVyfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU9e3RoaXMuc3RhdGUuZ3JvdXBJZH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3NOYW1lPVwibXhfQ3JlYXRlR3JvdXBEaWFsb2dfc3VmZml4XCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6eyBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZ2V0RG9tYWluKCkgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3NwYW4+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwiZXJyb3JcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IHRoaXMuc3RhdGUuZ3JvdXBJZEVycm9yIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBjcmVhdGVFcnJvck5vZGUgfVxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9EaWFsb2dfYnV0dG9uc1wiPlxuICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9XCJzdWJtaXRcIiB2YWx1ZT17X3QoJ0NyZWF0ZScpfSBjbGFzc05hbWU9XCJteF9EaWFsb2dfcHJpbWFyeVwiIC8+XG4gICAgICAgICAgICAgICAgICAgICAgICA8YnV0dG9uIG9uQ2xpY2s9e3RoaXMub25DYW5jZWx9PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCJDYW5jZWxcIikgfVxuICAgICAgICAgICAgICAgICAgICAgICAgPC9idXR0b24+XG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgIDwvZm9ybT5cbiAgICAgICAgICAgIDwvQmFzZURpYWxvZz5cbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=