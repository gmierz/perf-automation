"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _url = _interopRequireDefault(require("url"));

var _react = _interopRequireDefault(require("react"));

var _languageHandler = require("../../../languageHandler");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _serviceTypes = require("matrix-js-sdk/src/service-types");

var _DialogButtons = _interopRequireDefault(require("../elements/DialogButtons"));

var _BaseDialog = _interopRequireDefault(require("./BaseDialog"));

var _dec, _class;

class TermsCheckbox extends _react.default.PureComponent {
  constructor(...args) {
    super(...args);
    (0, _defineProperty2.default)(this, "onChange", ev => {
      this.props.onChange(this.props.url, ev.currentTarget.checked);
    });
  }

  render() {
    return /*#__PURE__*/_react.default.createElement("input", {
      type: "checkbox",
      onChange: this.onChange,
      checked: this.props.checked
    });
  }

}

let TermsDialog = (_dec = (0, _replaceableComponent.replaceableComponent)("views.dialogs.TermsDialog"), _dec(_class = class TermsDialog extends _react.default.PureComponent {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onCancelClick", () => {
      this.props.onFinished(false);
    });
    (0, _defineProperty2.default)(this, "onNextClick", () => {
      this.props.onFinished(true, Object.keys(this.state.agreedUrls).filter(url => this.state.agreedUrls[url]));
    });
    (0, _defineProperty2.default)(this, "onTermsCheckboxChange", (url, checked) => {
      this.setState({
        agreedUrls: Object.assign({}, this.state.agreedUrls, {
          [url]: checked
        })
      });
    });
    this.state = {
      // url -> boolean
      agreedUrls: {}
    };

    for (const url of props.agreedUrls) {
      this.state.agreedUrls[url] = true;
    }
  }

  nameForServiceType(serviceType, host) {
    switch (serviceType) {
      case _serviceTypes.SERVICE_TYPES.IS:
        return /*#__PURE__*/_react.default.createElement("div", null, (0, _languageHandler._t)("Identity server"), /*#__PURE__*/_react.default.createElement("br", null), "(", host, ")");

      case _serviceTypes.SERVICE_TYPES.IM:
        return /*#__PURE__*/_react.default.createElement("div", null, (0, _languageHandler._t)("Integration manager"), /*#__PURE__*/_react.default.createElement("br", null), "(", host, ")");
    }
  }

  summaryForServiceType(serviceType) {
    switch (serviceType) {
      case _serviceTypes.SERVICE_TYPES.IS:
        return /*#__PURE__*/_react.default.createElement("div", null, (0, _languageHandler._t)("Find others by phone or email"), /*#__PURE__*/_react.default.createElement("br", null), (0, _languageHandler._t)("Be found by phone or email"));

      case _serviceTypes.SERVICE_TYPES.IM:
        return /*#__PURE__*/_react.default.createElement("div", null, (0, _languageHandler._t)("Use bots, bridges, widgets and sticker packs"));
    }
  }

  render() {
    const rows = [];

    for (const policiesAndService of this.props.policiesAndServicePairs) {
      const parsedBaseUrl = _url.default.parse(policiesAndService.service.baseUrl);

      const policyValues = Object.values(policiesAndService.policies);

      for (let i = 0; i < policyValues.length; ++i) {
        const termDoc = policyValues[i];
        const termsLang = (0, _languageHandler.pickBestLanguage)(Object.keys(termDoc).filter(k => k !== 'version'));
        let serviceName;
        let summary;

        if (i === 0) {
          serviceName = this.nameForServiceType(policiesAndService.service.serviceType, parsedBaseUrl.host);
          summary = this.summaryForServiceType(policiesAndService.service.serviceType);
        }

        rows.push( /*#__PURE__*/_react.default.createElement("tr", {
          key: termDoc[termsLang].url
        }, /*#__PURE__*/_react.default.createElement("td", {
          className: "mx_TermsDialog_service"
        }, serviceName), /*#__PURE__*/_react.default.createElement("td", {
          className: "mx_TermsDialog_summary"
        }, summary), /*#__PURE__*/_react.default.createElement("td", null, termDoc[termsLang].name, /*#__PURE__*/_react.default.createElement("a", {
          rel: "noreferrer noopener",
          target: "_blank",
          href: termDoc[termsLang].url
        }, /*#__PURE__*/_react.default.createElement("span", {
          className: "mx_TermsDialog_link"
        }))), /*#__PURE__*/_react.default.createElement("td", null, /*#__PURE__*/_react.default.createElement(TermsCheckbox, {
          url: termDoc[termsLang].url,
          onChange: this.onTermsCheckboxChange,
          checked: Boolean(this.state.agreedUrls[termDoc[termsLang].url])
        }))));
      }
    } // if all the documents for at least one service have been checked, we can enable
    // the submit button


    let enableSubmit = false;

    for (const policiesAndService of this.props.policiesAndServicePairs) {
      let docsAgreedForService = 0;

      for (const terms of Object.values(policiesAndService.policies)) {
        let docAgreed = false;

        for (const lang of Object.keys(terms)) {
          if (lang === 'version') continue;

          if (this.state.agreedUrls[terms[lang].url]) {
            docAgreed = true;
            break;
          }
        }

        if (docAgreed) {
          ++docsAgreedForService;
        }
      }

      if (docsAgreedForService === Object.keys(policiesAndService.policies).length) {
        enableSubmit = true;
        break;
      }
    }

    return /*#__PURE__*/_react.default.createElement(_BaseDialog.default, {
      fixedWidth: false,
      onFinished: this.onCancelClick,
      title: (0, _languageHandler._t)("Terms of Service"),
      contentId: "mx_Dialog_content",
      hasCancel: false
    }, /*#__PURE__*/_react.default.createElement("div", {
      id: "mx_Dialog_content"
    }, /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("To continue you need to accept the terms of this service.")), /*#__PURE__*/_react.default.createElement("table", {
      className: "mx_TermsDialog_termsTable"
    }, /*#__PURE__*/_react.default.createElement("tbody", null, /*#__PURE__*/_react.default.createElement("tr", {
      className: "mx_TermsDialog_termsTableHeader"
    }, /*#__PURE__*/_react.default.createElement("th", null, (0, _languageHandler._t)("Service")), /*#__PURE__*/_react.default.createElement("th", null, (0, _languageHandler._t)("Summary")), /*#__PURE__*/_react.default.createElement("th", null, (0, _languageHandler._t)("Document")), /*#__PURE__*/_react.default.createElement("th", null, (0, _languageHandler._t)("Accept"))), rows))), /*#__PURE__*/_react.default.createElement(_DialogButtons.default, {
      primaryButton: (0, _languageHandler._t)('Next'),
      hasCancel: true,
      onCancel: this.onCancelClick,
      onPrimaryButtonClick: this.onNextClick,
      primaryDisabled: !enableSubmit
    }));
  }

}) || _class);
exports.default = TermsDialog;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvVGVybXNEaWFsb2cudHN4Il0sIm5hbWVzIjpbIlRlcm1zQ2hlY2tib3giLCJSZWFjdCIsIlB1cmVDb21wb25lbnQiLCJldiIsInByb3BzIiwib25DaGFuZ2UiLCJ1cmwiLCJjdXJyZW50VGFyZ2V0IiwiY2hlY2tlZCIsInJlbmRlciIsIlRlcm1zRGlhbG9nIiwiY29uc3RydWN0b3IiLCJvbkZpbmlzaGVkIiwiT2JqZWN0Iiwia2V5cyIsInN0YXRlIiwiYWdyZWVkVXJscyIsImZpbHRlciIsInNldFN0YXRlIiwiYXNzaWduIiwibmFtZUZvclNlcnZpY2VUeXBlIiwic2VydmljZVR5cGUiLCJob3N0IiwiU0VSVklDRV9UWVBFUyIsIklTIiwiSU0iLCJzdW1tYXJ5Rm9yU2VydmljZVR5cGUiLCJyb3dzIiwicG9saWNpZXNBbmRTZXJ2aWNlIiwicG9saWNpZXNBbmRTZXJ2aWNlUGFpcnMiLCJwYXJzZWRCYXNlVXJsIiwicGFyc2UiLCJzZXJ2aWNlIiwiYmFzZVVybCIsInBvbGljeVZhbHVlcyIsInZhbHVlcyIsInBvbGljaWVzIiwiaSIsImxlbmd0aCIsInRlcm1Eb2MiLCJ0ZXJtc0xhbmciLCJrIiwic2VydmljZU5hbWUiLCJzdW1tYXJ5IiwicHVzaCIsIm5hbWUiLCJvblRlcm1zQ2hlY2tib3hDaGFuZ2UiLCJCb29sZWFuIiwiZW5hYmxlU3VibWl0IiwiZG9jc0FncmVlZEZvclNlcnZpY2UiLCJ0ZXJtcyIsImRvY0FncmVlZCIsImxhbmciLCJvbkNhbmNlbENsaWNrIiwib25OZXh0Q2xpY2siXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBUUEsTUFBTUEsYUFBTixTQUE0QkMsZUFBTUMsYUFBbEMsQ0FBcUU7QUFBQTtBQUFBO0FBQUEsb0RBQzdDQyxFQUFELElBQWlEO0FBQ2hFLFdBQUtDLEtBQUwsQ0FB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RUFBRSxLQURoQjtBQUVJLE1BQUEsVUFBVSxFQUFFLEtBQUtLLGFBRnJCO0FBR0ksTUFBQSxLQUFLLEVBQUUseUJBQUcsa0JBQUgsQ0FIWDtBQUlJLE1BQUEsU0FBUyxFQUFDLG1CQUpkO0FBS0ksTUFBQSxTQUFTLEVBQUU7QUFMZixvQkFPSTtBQUFLLE1BQUEsRUFBRSxFQUFDO0FBQVIsb0JBQ0ksd0NBQUsseUJBQUcsMkRBQUgsQ0FBTCxDQURKLGVBR0k7QUFBTyxNQUFBLFNBQVMsRUFBQztBQUFqQixvQkFBNkMseURBQ3pDO0FBQUksTUFBQSxTQUFTLEVBQUM7QUFBZCxvQkFDSSx5Q0FBTSx5QkFBRyxTQUFILENBQU4sQ0FESixlQUVJLHlDQUFNLHlCQUFHLFNBQUgsQ0FBTixDQUZKLGVBR0kseUNBQU0seUJBQUcsVUFBSCxDQUFOLENBSEosZUFJSSx5Q0FBTSx5QkFBRyxRQUFILENBQU4sQ0FKSixDQUR5QyxFQU92QzFCLElBUHVDLENBQTdDLENBSEosQ0FQSixlQXFCSSw2QkFBQyxzQkFBRDtBQUFlLE1BQUEsYUFBYSxFQUFFLHlCQUFHLE1BQUgsQ0FBOUI7QUFDSSxNQUFBLFNBQVMsRUFBRSxJQURmO0FBRUksTUFBQSxRQUFRLEVBQUUsS0FBSzBCLGFBRm5CO0FBR0ksTUFBQSxvQkFBb0IsRUFBRSxLQUFLQyxXQUgvQjtBQUlJLE1BQUEsZUFBZSxFQUFFLENBQUNOO0FBSnRCLE1BckJKLENBREo7QUE4Qkg7O0FBNUltRixDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE5IFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IHVybCBmcm9tICd1cmwnO1xuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IF90LCBwaWNrQmVzdExhbmd1YWdlIH0gZnJvbSAnLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyJztcblxuaW1wb3J0IHsgcmVwbGFjZWFibGVDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvcmVwbGFjZWFibGVDb21wb25lbnRcIjtcbmltcG9ydCB7IFNFUlZJQ0VfVFlQRVMgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvc2VydmljZS10eXBlc1wiO1xuaW1wb3J0IERpYWxvZ0J1dHRvbnMgZnJvbSBcIi4uL2VsZW1lbnRzL0RpYWxvZ0J1dHRvbnNcIjtcbmltcG9ydCBCYXNlRGlhbG9nIGZyb20gXCIuL0Jhc2VEaWFsb2dcIjtcblxuaW50ZXJmYWNlIElUZXJtc0NoZWNrYm94UHJvcHMge1xuICAgIG9uQ2hhbmdlOiAodXJsOiBzdHJpbmcsIGNoZWNrZWQ6IGJvb2xlYW4pID0+IHZvaWQ7XG4gICAgdXJsOiBzdHJpbmc7XG4gICAgY2hlY2tlZDogYm9vbGVhbjtcbn1cblxuY2xhc3MgVGVybXNDaGVja2JveCBleHRlbmRzIFJlYWN0LlB1cmVDb21wb25lbnQ8SVRlcm1zQ2hlY2tib3hQcm9wcz4ge1xuICAgIHByaXZhdGUgb25DaGFuZ2UgPSAoZXY6IFJlYWN0LkZvcm1FdmVudDxIVE1MSW5wdXRFbGVtZW50Pik6IHZvaWQgPT4ge1xuICAgICAgICB0aGlzLnByb3BzLm9uQ2hhbmdlKHRoaXMucHJvcHMudXJsLCBldi5jdXJyZW50VGFyZ2V0LmNoZWNrZWQpO1xuICAgIH07XG5cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIHJldHVybiA8aW5wdXQgdHlwZT1cImNoZWNrYm94XCJcbiAgICAgICAgICAgIG9uQ2hhbmdlPXt0aGlzLm9uQ2hhbmdlfVxuICAgICAgICAgICAgY2hlY2tlZD17dGhpcy5wcm9wcy5jaGVja2VkfVxuICAgICAgICAvPjtcbiAgICB9XG59XG5cbmludGVyZmFjZSBJVGVybXNEaWFsb2dQcm9wcyB7XG4gICAgLyoqXG4gICAgICogQXJyYXkgb2YgW1NlcnZpY2UsIHBvbGljaWVzXSBwYWlycywgd2hlcmUgcG9saWNpZXMgaXMgdGhlIHJlc3BvbnNlIGZyb20gdGhlXG4gICAgICogL3Rlcm1zIGVuZHBvaW50IGZvciB0aGF0IHNlcnZpY2VcbiAgICAgKi9cbiAgICBwb2xpY2llc0FuZFNlcnZpY2VQYWlyczogYW55W107XG5cbiAgICAvKipcbiAgICAgKiB1cmxzIHRoYXQgdGhlIHVzZXIgaGFzIGFscmVhZHkgYWdyZWVkIHRvXG4gICAgICovXG4gICAgYWdyZWVkVXJscz86IHN0cmluZ1tdO1xuXG4gICAgLyoqXG4gICAgICogQ2FsbGVkIHdpdGg6XG4gICAgICogICAgICogc3VjY2VzcyB7Ym9vbH0gVHJ1ZSBpZiB0aGUgdXNlciBhY2NlcHRlZCBhbnkgZG91bWVudHMsIGZhbHNlIGlmIGNhbmNlbGxlZFxuICAgICAqICAgICAqIGFncmVlZFVybHMge3N0cmluZ1tdfSBMaXN0IG9mIGFncmVlZCBVUkxzXG4gICAgICovXG4gICAgb25GaW5pc2hlZDogKHN1Y2Nlc3M6IGJvb2xlYW4sIGFncmVlZFVybHM/OiBzdHJpbmdbXSkgPT4gdm9pZDtcbn1cblxuaW50ZXJmYWNlIElTdGF0ZSB7XG4gICAgYWdyZWVkVXJsczogYW55O1xufVxuXG5AcmVwbGFjZWFibGVDb21wb25lbnQoXCJ2aWV3cy5kaWFsb2dzLlRlcm1zRGlhbG9nXCIpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBUZXJtc0RpYWxvZyBleHRlbmRzIFJlYWN0LlB1cmVDb21wb25lbnQ8SVRlcm1zRGlhbG9nUHJvcHMsIElTdGF0ZT4ge1xuICAgIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIC8vIHVybCAtPiBib29sZWFuXG4gICAgICAgICAgICBhZ3JlZWRVcmxzOiB7fSxcbiAgICAgICAgfTtcbiAgICAgICAgZm9yIChjb25zdCB1cmwgb2YgcHJvcHMuYWdyZWVkVXJscykge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS5hZ3JlZWRVcmxzW3VybF0gPSB0cnVlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkNhbmNlbENsaWNrID0gKCk6IHZvaWQgPT4ge1xuICAgICAgICB0aGlzLnByb3BzLm9uRmluaXNoZWQoZmFsc2UpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uTmV4dENsaWNrID0gKCk6IHZvaWQgPT4ge1xuICAgICAgICB0aGlzLnByb3BzLm9uRmluaXNoZWQodHJ1ZSwgT2JqZWN0LmtleXModGhpcy5zdGF0ZS5hZ3JlZWRVcmxzKS5maWx0ZXIoKHVybCkgPT4gdGhpcy5zdGF0ZS5hZ3JlZWRVcmxzW3VybF0pKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBuYW1lRm9yU2VydmljZVR5cGUoc2VydmljZVR5cGU6IFNFUlZJQ0VfVFlQRVMsIGhvc3Q6IHN0cmluZyk6IEpTWC5FbGVtZW50IHtcbiAgICAgICAgc3dpdGNoIChzZXJ2aWNlVHlwZSkge1xuICAgICAgICAgICAgY2FzZSBTRVJWSUNFX1RZUEVTLklTOlxuICAgICAgICAgICAgICAgIHJldHVybiA8ZGl2PnsgX3QoXCJJZGVudGl0eSBzZXJ2ZXJcIikgfTxiciAvPih7IGhvc3QgfSk8L2Rpdj47XG4gICAgICAgICAgICBjYXNlIFNFUlZJQ0VfVFlQRVMuSU06XG4gICAgICAgICAgICAgICAgcmV0dXJuIDxkaXY+eyBfdChcIkludGVncmF0aW9uIG1hbmFnZXJcIikgfTxiciAvPih7IGhvc3QgfSk8L2Rpdj47XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHN1bW1hcnlGb3JTZXJ2aWNlVHlwZShzZXJ2aWNlVHlwZTogU0VSVklDRV9UWVBFUyk6IEpTWC5FbGVtZW50IHtcbiAgICAgICAgc3dpdGNoIChzZXJ2aWNlVHlwZSkge1xuICAgICAgICAgICAgY2FzZSBTRVJWSUNFX1RZUEVTLklTOlxuICAgICAgICAgICAgICAgIHJldHVybiA8ZGl2PlxuICAgICAgICAgICAgICAgICAgICB7IF90KFwiRmluZCBvdGhlcnMgYnkgcGhvbmUgb3IgZW1haWxcIikgfVxuICAgICAgICAgICAgICAgICAgICA8YnIgLz5cbiAgICAgICAgICAgICAgICAgICAgeyBfdChcIkJlIGZvdW5kIGJ5IHBob25lIG9yIGVtYWlsXCIpIH1cbiAgICAgICAgICAgICAgICA8L2Rpdj47XG4gICAgICAgICAgICBjYXNlIFNFUlZJQ0VfVFlQRVMuSU06XG4gICAgICAgICAgICAgICAgcmV0dXJuIDxkaXY+XG4gICAgICAgICAgICAgICAgICAgIHsgX3QoXCJVc2UgYm90cywgYnJpZGdlcywgd2lkZ2V0cyBhbmQgc3RpY2tlciBwYWNrc1wiKSB9XG4gICAgICAgICAgICAgICAgPC9kaXY+O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvblRlcm1zQ2hlY2tib3hDaGFuZ2UgPSAodXJsOiBzdHJpbmcsIGNoZWNrZWQ6IGJvb2xlYW4pID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBhZ3JlZWRVcmxzOiBPYmplY3QuYXNzaWduKHt9LCB0aGlzLnN0YXRlLmFncmVlZFVybHMsIHsgW3VybF06IGNoZWNrZWQgfSksXG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBwdWJsaWMgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCByb3dzID0gW107XG4gICAgICAgIGZvciAoY29uc3QgcG9saWNpZXNBbmRTZXJ2aWNlIG9mIHRoaXMucHJvcHMucG9saWNpZXNBbmRTZXJ2aWNlUGFpcnMpIHtcbiAgICAgICAgICAgIGNvbnN0IHBhcnNlZEJhc2VVcmwgPSB1cmwucGFyc2UocG9saWNpZXNBbmRTZXJ2aWNlLnNlcnZpY2UuYmFzZVVybCk7XG5cbiAgICAgICAgICAgIGNvbnN0IHBvbGljeVZhbHVlcyA9IE9iamVjdC52YWx1ZXMocG9saWNpZXNBbmRTZXJ2aWNlLnBvbGljaWVzKTtcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9saWN5VmFsdWVzLmxlbmd0aDsgKytpKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdGVybURvYyA9IHBvbGljeVZhbHVlc1tpXTtcbiAgICAgICAgICAgICAgICBjb25zdCB0ZXJtc0xhbmcgPSBwaWNrQmVzdExhbmd1YWdlKE9iamVjdC5rZXlzKHRlcm1Eb2MpLmZpbHRlcigoaykgPT4gayAhPT0gJ3ZlcnNpb24nKSk7XG4gICAgICAgICAgICAgICAgbGV0IHNlcnZpY2VOYW1lO1xuICAgICAgICAgICAgICAgIGxldCBzdW1tYXJ5O1xuICAgICAgICAgICAgICAgIGlmIChpID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHNlcnZpY2VOYW1lID0gdGhpcy5uYW1lRm9yU2VydmljZVR5cGUocG9saWNpZXNBbmRTZXJ2aWNlLnNlcnZpY2Uuc2VydmljZVR5cGUsIHBhcnNlZEJhc2VVcmwuaG9zdCk7XG4gICAgICAgICAgICAgICAgICAgIHN1bW1hcnkgPSB0aGlzLnN1bW1hcnlGb3JTZXJ2aWNlVHlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgIHBvbGljaWVzQW5kU2VydmljZS5zZXJ2aWNlLnNlcnZpY2VUeXBlLFxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJvd3MucHVzaCg8dHIga2V5PXt0ZXJtRG9jW3Rlcm1zTGFuZ10udXJsfT5cbiAgICAgICAgICAgICAgICAgICAgPHRkIGNsYXNzTmFtZT1cIm14X1Rlcm1zRGlhbG9nX3NlcnZpY2VcIj57IHNlcnZpY2VOYW1lIH08L3RkPlxuICAgICAgICAgICAgICAgICAgICA8dGQgY2xhc3NOYW1lPVwibXhfVGVybXNEaWFsb2dfc3VtbWFyeVwiPnsgc3VtbWFyeSB9PC90ZD5cbiAgICAgICAgICAgICAgICAgICAgPHRkPlxuICAgICAgICAgICAgICAgICAgICAgICAgeyB0ZXJtRG9jW3Rlcm1zTGFuZ10ubmFtZSB9XG4gICAgICAgICAgICAgICAgICAgICAgICA8YSByZWw9XCJub3JlZmVycmVyIG5vb3BlbmVyXCIgdGFyZ2V0PVwiX2JsYW5rXCIgaHJlZj17dGVybURvY1t0ZXJtc0xhbmddLnVybH0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3NOYW1lPVwibXhfVGVybXNEaWFsb2dfbGlua1wiIC8+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L2E+XG4gICAgICAgICAgICAgICAgICAgIDwvdGQ+XG4gICAgICAgICAgICAgICAgICAgIDx0ZD48VGVybXNDaGVja2JveFxuICAgICAgICAgICAgICAgICAgICAgICAgdXJsPXt0ZXJtRG9jW3Rlcm1zTGFuZ10udXJsfVxuICAgICAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2U9e3RoaXMub25UZXJtc0NoZWNrYm94Q2hhbmdlfVxuICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tlZD17Qm9vbGVhbih0aGlzLnN0YXRlLmFncmVlZFVybHNbdGVybURvY1t0ZXJtc0xhbmddLnVybF0pfVxuICAgICAgICAgICAgICAgICAgICAvPjwvdGQ+XG4gICAgICAgICAgICAgICAgPC90cj4pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gaWYgYWxsIHRoZSBkb2N1bWVudHMgZm9yIGF0IGxlYXN0IG9uZSBzZXJ2aWNlIGhhdmUgYmVlbiBjaGVja2VkLCB3ZSBjYW4gZW5hYmxlXG4gICAgICAgIC8vIHRoZSBzdWJtaXQgYnV0dG9uXG4gICAgICAgIGxldCBlbmFibGVTdWJtaXQgPSBmYWxzZTtcbiAgICAgICAgZm9yIChjb25zdCBwb2xpY2llc0FuZFNlcnZpY2Ugb2YgdGhpcy5wcm9wcy5wb2xpY2llc0FuZFNlcnZpY2VQYWlycykge1xuICAgICAgICAgICAgbGV0IGRvY3NBZ3JlZWRGb3JTZXJ2aWNlID0gMDtcbiAgICAgICAgICAgIGZvciAoY29uc3QgdGVybXMgb2YgT2JqZWN0LnZhbHVlcyhwb2xpY2llc0FuZFNlcnZpY2UucG9saWNpZXMpKSB7XG4gICAgICAgICAgICAgICAgbGV0IGRvY0FncmVlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGZvciAoY29uc3QgbGFuZyBvZiBPYmplY3Qua2V5cyh0ZXJtcykpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGxhbmcgPT09ICd2ZXJzaW9uJykgY29udGludWU7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlLmFncmVlZFVybHNbdGVybXNbbGFuZ10udXJsXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9jQWdyZWVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChkb2NBZ3JlZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgKytkb2NzQWdyZWVkRm9yU2VydmljZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZG9jc0FncmVlZEZvclNlcnZpY2UgPT09IE9iamVjdC5rZXlzKHBvbGljaWVzQW5kU2VydmljZS5wb2xpY2llcykubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgZW5hYmxlU3VibWl0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8QmFzZURpYWxvZ1xuICAgICAgICAgICAgICAgIGZpeGVkV2lkdGg9e2ZhbHNlfVxuICAgICAgICAgICAgICAgIG9uRmluaXNoZWQ9e3RoaXMub25DYW5jZWxDbGlja31cbiAgICAgICAgICAgICAgICB0aXRsZT17X3QoXCJUZXJtcyBvZiBTZXJ2aWNlXCIpfVxuICAgICAgICAgICAgICAgIGNvbnRlbnRJZD0nbXhfRGlhbG9nX2NvbnRlbnQnXG4gICAgICAgICAgICAgICAgaGFzQ2FuY2VsPXtmYWxzZX1cbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICA8ZGl2IGlkPSdteF9EaWFsb2dfY29udGVudCc+XG4gICAgICAgICAgICAgICAgICAgIDxwPnsgX3QoXCJUbyBjb250aW51ZSB5b3UgbmVlZCB0byBhY2NlcHQgdGhlIHRlcm1zIG9mIHRoaXMgc2VydmljZS5cIikgfTwvcD5cblxuICAgICAgICAgICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPVwibXhfVGVybXNEaWFsb2dfdGVybXNUYWJsZVwiPjx0Ym9keT5cbiAgICAgICAgICAgICAgICAgICAgICAgIDx0ciBjbGFzc05hbWU9XCJteF9UZXJtc0RpYWxvZ190ZXJtc1RhYmxlSGVhZGVyXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRoPnsgX3QoXCJTZXJ2aWNlXCIpIH08L3RoPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0aD57IF90KFwiU3VtbWFyeVwiKSB9PC90aD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGg+eyBfdChcIkRvY3VtZW50XCIpIH08L3RoPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0aD57IF90KFwiQWNjZXB0XCIpIH08L3RoPlxuICAgICAgICAgICAgICAgICAgICAgICAgPC90cj5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgcm93cyB9XG4gICAgICAgICAgICAgICAgICAgIDwvdGJvZHk+PC90YWJsZT5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cblxuICAgICAgICAgICAgICAgIDxEaWFsb2dCdXR0b25zIHByaW1hcnlCdXR0b249e190KCdOZXh0Jyl9XG4gICAgICAgICAgICAgICAgICAgIGhhc0NhbmNlbD17dHJ1ZX1cbiAgICAgICAgICAgICAgICAgICAgb25DYW5jZWw9e3RoaXMub25DYW5jZWxDbGlja31cbiAgICAgICAgICAgICAgICAgICAgb25QcmltYXJ5QnV0dG9uQ2xpY2s9e3RoaXMub25OZXh0Q2xpY2t9XG4gICAgICAgICAgICAgICAgICAgIHByaW1hcnlEaXNhYmxlZD17IWVuYWJsZVN1Ym1pdH1cbiAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgPC9CYXNlRGlhbG9nPlxuICAgICAgICApO1xuICAgIH1cbn1cbiJdfQ==