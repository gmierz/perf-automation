"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _languageHandler = require("../../../languageHandler");

var _DateUtils = require("../../../DateUtils");

var _SettingsStore = _interopRequireDefault(require("../../../settings/SettingsStore"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _BaseDialog = _interopRequireDefault(require("./BaseDialog"));

var _ScrollPanel = _interopRequireDefault(require("../../structures/ScrollPanel"));

var _Spinner = _interopRequireDefault(require("../elements/Spinner"));

var _EditHistoryMessage = _interopRequireDefault(require("../messages/EditHistoryMessage"));

var _DateSeparator = _interopRequireDefault(require("../messages/DateSeparator"));

var _event = require("matrix-js-sdk/src/@types/event");

var _utils = require("matrix-js-sdk/src/utils");

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class;

let MessageEditHistoryDialog = (_dec = (0, _replaceableComponent.replaceableComponent)("views.dialogs.MessageEditHistoryDialog"), _dec(_class = class MessageEditHistoryDialog extends _react.default.PureComponent {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "loadMoreEdits", async backwards => {
      if (backwards || !this.state.nextBatch && !this.state.isLoading) {
        // bail out on backwards as we only paginate in one direction
        return false;
      }

      const opts = {
        from: this.state.nextBatch
      };
      const roomId = this.props.mxEvent.getRoomId();
      const eventId = this.props.mxEvent.getId();

      const client = _MatrixClientPeg.MatrixClientPeg.get();

      const {
        resolve,
        reject,
        promise
      } = (0, _utils.defer)();
      let result;

      try {
        result = await client.relations(roomId, eventId, _event.RelationType.Replace, _event.EventType.RoomMessage, opts);
      } catch (error) {
        // log if the server returned an error
        if (error.errcode) {
          _logger.logger.error("fetching /relations failed with error", error);
        }

        this.setState({
          error
        }, () => reject(error));
        return promise;
      }

      const newEvents = result.events;
      this.locallyRedactEventsIfNeeded(newEvents);
      this.setState({
        originalEvent: this.state.originalEvent || result.originalEvent,
        events: this.state.events.concat(newEvents),
        nextBatch: result.nextBatch,
        isLoading: false
      }, () => {
        const hasMoreResults = !!this.state.nextBatch;
        resolve(hasMoreResults);
      });
      return promise;
    });
    this.state = {
      originalEvent: null,
      error: null,
      events: [],
      nextBatch: null,
      isLoading: true,
      isTwelveHour: _SettingsStore.default.getValue("showTwelveHourTimestamps")
    };
  }

  locallyRedactEventsIfNeeded(newEvents) {
    const roomId = this.props.mxEvent.getRoomId();

    const client = _MatrixClientPeg.MatrixClientPeg.get();

    const room = client.getRoom(roomId);
    const pendingEvents = room.getPendingEvents();

    for (const e of newEvents) {
      const pendingRedaction = pendingEvents.find(pe => {
        return pe.getType() === "m.room.redaction" && pe.getAssociatedId() === e.getId();
      });

      if (pendingRedaction) {
        e.markLocallyRedacted(pendingRedaction);
      }
    }
  }

  componentDidMount() {
    this.loadMoreEdits();
  }

  renderEdits() {
    const nodes = [];
    let lastEvent;
    let allEvents = this.state.events; // append original event when we've done last pagination

    if (this.state.originalEvent && !this.state.nextBatch) {
      allEvents = allEvents.concat(this.state.originalEvent);
    }

    const baseEventId = this.props.mxEvent.getId();
    allEvents.forEach((e, i) => {
      if (!lastEvent || (0, _DateUtils.wantsDateSeparator)(lastEvent.getDate(), e.getDate())) {
        nodes.push( /*#__PURE__*/_react.default.createElement("li", {
          key: e.getTs() + "~"
        }, /*#__PURE__*/_react.default.createElement(_DateSeparator.default, {
          ts: e.getTs()
        })));
      }

      const isBaseEvent = e.getId() === baseEventId;
      nodes.push( /*#__PURE__*/_react.default.createElement(_EditHistoryMessage.default, {
        key: e.getId(),
        previousEdit: !isBaseEvent ? allEvents[i + 1] : null,
        isBaseEvent: isBaseEvent,
        mxEvent: e,
        isTwelveHour: this.state.isTwelveHour
      }));
      lastEvent = e;
    });
    return nodes;
  }

  render() {
    let content;

    if (this.state.error) {
      const {
        error
      } = this.state;

      if (error.errcode === "M_UNRECOGNIZED") {
        content = /*#__PURE__*/_react.default.createElement("p", {
          className: "mx_MessageEditHistoryDialog_error"
        }, (0, _languageHandler._t)("Your homeserver doesn't seem to support this feature."));
      } else if (error.errcode) {
        // some kind of error from the homeserver
        content = /*#__PURE__*/_react.default.createElement("p", {
          className: "mx_MessageEditHistoryDialog_error"
        }, (0, _languageHandler._t)("Something went wrong!"));
      } else {
        content = /*#__PURE__*/_react.default.createElement("p", {
          className: "mx_MessageEditHistoryDialog_error"
        }, (0, _languageHandler._t)("Cannot reach homeserver"), /*#__PURE__*/_react.default.createElement("br", null), (0, _languageHandler._t)("Ensure you have a stable internet connection, or get in touch with the server admin"));
      }
    } else if (this.state.isLoading) {
      content = /*#__PURE__*/_react.default.createElement(_Spinner.default, null);
    } else {
      content = /*#__PURE__*/_react.default.createElement(_ScrollPanel.default, {
        className: "mx_MessageEditHistoryDialog_scrollPanel",
        onFillRequest: this.loadMoreEdits,
        stickyBottom: false,
        startAtBottom: false
      }, /*#__PURE__*/_react.default.createElement("ul", {
        className: "mx_MessageEditHistoryDialog_edits"
      }, this.renderEdits()));
    }

    return /*#__PURE__*/_react.default.createElement(_BaseDialog.default, {
      className: "mx_MessageEditHistoryDialog",
      hasCancel: true,
      onFinished: this.props.onFinished,
      title: (0, _languageHandler._t)("Message edits")
    }, content);
  }

}) || _class);
exports.default = MessageEditHistoryDialog;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvTWVzc2FnZUVkaXRIaXN0b3J5RGlhbG9nLnRzeCJdLCJuYW1lcyI6WyJNZXNzYWdlRWRpdEhpc3RvcnlEaWFsb2ciLCJSZWFjdCIsIlB1cmVDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwiYmFja3dhcmRzIiwic3RhdGUiLCJuZXh0QmF0Y2giLCJpc0xvYWRpbmciLCJvcHRzIiwiZnJvbSIsInJvb21JZCIsIm14RXZlbnQiLCJnZXRSb29tSWQiLCJldmVudElkIiwiZ2V0SWQiLCJjbGllbnQiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJyZXNvbHZlIiwicmVqZWN0IiwicHJvbWlzZSIsInJlc3VsdCIsInJlbGF0aW9ucyIsIlJlbGF0aW9uVHlwZSIsIlJlcGxhY2UiLCJFdmVudFR5cGUiLCJSb29tTWVzc2FnZSIsImVycm9yIiwiZXJyY29kZSIsImxvZ2dlciIsInNldFN0YXRlIiwibmV3RXZlbnRzIiwiZXZlbnRzIiwibG9jYWxseVJlZGFjdEV2ZW50c0lmTmVlZGVkIiwib3JpZ2luYWxFdmVudCIsImNvbmNhdCIsImhhc01vcmVSZXN1bHRzIiwiaXNUd2VsdmVIb3VyIiwiU2V0dGluZ3NTdG9yZSIsImdldFZhbHVlIiwicm9vbSIsImdldFJvb20iLCJwZW5kaW5nRXZlbnRzIiwiZ2V0UGVuZGluZ0V2ZW50cyIsImUiLCJwZW5kaW5nUmVkYWN0aW9uIiwiZmluZCIsInBlIiwiZ2V0VHlwZSIsImdldEFzc29jaWF0ZWRJZCIsIm1hcmtMb2NhbGx5UmVkYWN0ZWQiLCJjb21wb25lbnREaWRNb3VudCIsImxvYWRNb3JlRWRpdHMiLCJyZW5kZXJFZGl0cyIsIm5vZGVzIiwibGFzdEV2ZW50IiwiYWxsRXZlbnRzIiwiYmFzZUV2ZW50SWQiLCJmb3JFYWNoIiwiaSIsImdldERhdGUiLCJwdXNoIiwiZ2V0VHMiLCJpc0Jhc2VFdmVudCIsInJlbmRlciIsImNvbnRlbnQiLCJv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QUk7QUFBRyxVQUFBLFNBQVMsRUFBQztBQUFiLFdBQ0wseUJBQUcsdURBQUgsQ0FESyxDQUFYO0FBR0gsT0FKRCxNQUlPLElBQUl0QyxLQUFLLENBQUNDLE9BQVYsRUFBbUI7QUFDdEI7QUFDQXFDLFFBQUFBLE9BQU8sZ0JBQUk7QUFBRyxVQUFBLFNBQVMsRUFBQztBQUFiLFdBQ0wseUJBQUcsdUJBQUgsQ0FESyxDQUFYO0FBR0gsT0FMTSxNQUtBO0FBQ0hBLFFBQUFBLE9BQU8sZ0JBQUk7QUFBRyxVQUFBLFNBQVMsRUFBQztBQUFiLFdBQ0wseUJBQUcseUJBQUgsQ0FESyxlQUVQLHdDQUZPLEVBR0wseUJBQUcscUZBQUgsQ0FISyxDQUFYO0FBS0g7QUFDSixLQWxCRCxNQWtCTyxJQUFJLEtBQUs1RCxLQUFMLENBQVdFLFNBQWYsRUFBMEI7QUFDN0IwRCxNQUFBQSxPQUFPLGdCQUFHLDZCQUFDLGdCQUFELE9BQVY7QUFDSCxLQUZNLE1BRUE7QUFDSEEsTUFBQUEsT0FBTyxnQkFBSSw2QkFBQyxvQkFBRDtBQUNQLFFBQUEsU0FBUyxFQUFDLHlDQURIO0FBRVAsUUFBQSxhQUFhLEVBQUUsS0FBS2IsYUFGYjtBQUdQLFFBQUEsWUFBWSxFQUFFLEtBSFA7QUFJUCxRQUFBLGFBQWEsRUFBRTtBQUpSLHNCQU1QO0FBQUksUUFBQSxTQUFTLEVBQUM7QUFBZCxTQUFvRCxLQUFLQyxXQUFMLEVBQXBELENBTk8sQ0FBWDtBQVFIOztBQUNELHdCQUNJLDZCQUFDLG1CQUFEO0FBQ0ksTUFBQSxTQUFTLEVBQUMsNkJBRGQ7QUFFSSxNQUFBLFNBQVMsRUFBRSxJQUZmO0FBR0ksTUFBQSxVQUFVLEVBQUUsS0FBS2xELEtBQUwsQ0FBVytELFVBSDNCO0FBSUksTUFBQSxLQUFLLEVBQUUseUJBQUcsZUFBSDtBQUpYLE9BTU1ELE9BTk4sQ0FESjtBQVVIOztBQTVJcUYsQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxOSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tIFwiLi4vLi4vLi4vTWF0cml4Q2xpZW50UGVnXCI7XG5pbXBvcnQgeyBfdCB9IGZyb20gJy4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlcic7XG5pbXBvcnQgeyB3YW50c0RhdGVTZXBhcmF0b3IgfSBmcm9tICcuLi8uLi8uLi9EYXRlVXRpbHMnO1xuaW1wb3J0IFNldHRpbmdzU3RvcmUgZnJvbSAnLi4vLi4vLi4vc2V0dGluZ3MvU2V0dGluZ3NTdG9yZSc7XG5pbXBvcnQgeyByZXBsYWNlYWJsZUNvbXBvbmVudCB9IGZyb20gXCIuLi8uLi8uLi91dGlscy9yZXBsYWNlYWJsZUNvbXBvbmVudFwiO1xuaW1wb3J0IHsgTWF0cml4RXZlbnQgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL2V2ZW50XCI7XG5pbXBvcnQgQmFzZURpYWxvZyBmcm9tIFwiLi9CYXNlRGlhbG9nXCI7XG5pbXBvcnQgU2Nyb2xsUGFuZWwgZnJvbSBcIi4uLy4uL3N0cnVjdHVyZXMvU2Nyb2xsUGFuZWxcIjtcbmltcG9ydCBTcGlubmVyIGZyb20gXCIuLi9lbGVtZW50cy9TcGlubmVyXCI7XG5pbXBvcnQgRWRpdEhpc3RvcnlNZXNzYWdlIGZyb20gXCIuLi9tZXNzYWdlcy9FZGl0SGlzdG9yeU1lc3NhZ2VcIjtcbmltcG9ydCBEYXRlU2VwYXJhdG9yIGZyb20gXCIuLi9tZXNzYWdlcy9EYXRlU2VwYXJhdG9yXCI7XG5pbXBvcnQgeyBJRGlhbG9nUHJvcHMgfSBmcm9tIFwiLi9JRGlhbG9nUHJvcHNcIjtcbmltcG9ydCB7IEV2ZW50VHlwZSwgUmVsYXRpb25UeXBlIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL0B0eXBlcy9ldmVudFwiO1xuaW1wb3J0IHsgZGVmZXIgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvdXRpbHNcIjtcblxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2xvZ2dlclwiO1xuXG5pbnRlcmZhY2UgSVByb3BzIGV4dGVuZHMgSURpYWxvZ1Byb3BzIHtcbiAgICBteEV2ZW50OiBNYXRyaXhFdmVudDtcbn1cblxuaW50ZXJmYWNlIElTdGF0ZSB7XG4gICAgb3JpZ2luYWxFdmVudDogTWF0cml4RXZlbnQ7XG4gICAgZXJyb3I6IHtcbiAgICAgICAgZXJyY29kZTogc3RyaW5nO1xuICAgIH07XG4gICAgZXZlbnRzOiBNYXRyaXhFdmVudFtdO1xuICAgIG5leHRCYXRjaDogc3RyaW5nO1xuICAgIGlzTG9hZGluZzogYm9vbGVhbjtcbiAgICBpc1R3ZWx2ZUhvdXI6IGJvb2xlYW47XG59XG5cbkByZXBsYWNlYWJsZUNvbXBvbmVudChcInZpZXdzLmRpYWxvZ3MuTWVzc2FnZUVkaXRIaXN0b3J5RGlhbG9nXCIpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBNZXNzYWdlRWRpdEhpc3RvcnlEaWFsb2cgZXh0ZW5kcyBSZWFjdC5QdXJlQ29tcG9uZW50PElQcm9wcywgSVN0YXRlPiB7XG4gICAgY29uc3RydWN0b3IocHJvcHM6IElQcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICBvcmlnaW5hbEV2ZW50OiBudWxsLFxuICAgICAgICAgICAgZXJyb3I6IG51bGwsXG4gICAgICAgICAgICBldmVudHM6IFtdLFxuICAgICAgICAgICAgbmV4dEJhdGNoOiBudWxsLFxuICAgICAgICAgICAgaXNMb2FkaW5nOiB0cnVlLFxuICAgICAgICAgICAgaXNUd2VsdmVIb3VyOiBTZXR0aW5nc1N0b3JlLmdldFZhbHVlKFwic2hvd1R3ZWx2ZUhvdXJUaW1lc3RhbXBzXCIpLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgbG9hZE1vcmVFZGl0cyA9IGFzeW5jIChiYWNrd2FyZHM/OiBib29sZWFuKTogUHJvbWlzZTxib29sZWFuPiA9PiB7XG4gICAgICAgIGlmIChiYWNrd2FyZHMgfHwgKCF0aGlzLnN0YXRlLm5leHRCYXRjaCAmJiAhdGhpcy5zdGF0ZS5pc0xvYWRpbmcpKSB7XG4gICAgICAgICAgICAvLyBiYWlsIG91dCBvbiBiYWNrd2FyZHMgYXMgd2Ugb25seSBwYWdpbmF0ZSBpbiBvbmUgZGlyZWN0aW9uXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgb3B0cyA9IHsgZnJvbTogdGhpcy5zdGF0ZS5uZXh0QmF0Y2ggfTtcbiAgICAgICAgY29uc3Qgcm9vbUlkID0gdGhpcy5wcm9wcy5teEV2ZW50LmdldFJvb21JZCgpO1xuICAgICAgICBjb25zdCBldmVudElkID0gdGhpcy5wcm9wcy5teEV2ZW50LmdldElkKCk7XG4gICAgICAgIGNvbnN0IGNsaWVudCA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcblxuICAgICAgICBjb25zdCB7IHJlc29sdmUsIHJlamVjdCwgcHJvbWlzZSB9ID0gZGVmZXI8Ym9vbGVhbj4oKTtcbiAgICAgICAgbGV0IHJlc3VsdDtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgcmVzdWx0ID0gYXdhaXQgY2xpZW50LnJlbGF0aW9ucyhcbiAgICAgICAgICAgICAgICByb29tSWQsIGV2ZW50SWQsIFJlbGF0aW9uVHlwZS5SZXBsYWNlLCBFdmVudFR5cGUuUm9vbU1lc3NhZ2UsIG9wdHMpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgLy8gbG9nIGlmIHRoZSBzZXJ2ZXIgcmV0dXJuZWQgYW4gZXJyb3JcbiAgICAgICAgICAgIGlmIChlcnJvci5lcnJjb2RlKSB7XG4gICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKFwiZmV0Y2hpbmcgL3JlbGF0aW9ucyBmYWlsZWQgd2l0aCBlcnJvclwiLCBlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgZXJyb3IgfSwgKCkgPT4gcmVqZWN0KGVycm9yKSk7XG4gICAgICAgICAgICByZXR1cm4gcHJvbWlzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG5ld0V2ZW50cyA9IHJlc3VsdC5ldmVudHM7XG4gICAgICAgIHRoaXMubG9jYWxseVJlZGFjdEV2ZW50c0lmTmVlZGVkKG5ld0V2ZW50cyk7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgb3JpZ2luYWxFdmVudDogdGhpcy5zdGF0ZS5vcmlnaW5hbEV2ZW50IHx8IHJlc3VsdC5vcmlnaW5hbEV2ZW50LFxuICAgICAgICAgICAgZXZlbnRzOiB0aGlzLnN0YXRlLmV2ZW50cy5jb25jYXQobmV3RXZlbnRzKSxcbiAgICAgICAgICAgIG5leHRCYXRjaDogcmVzdWx0Lm5leHRCYXRjaCxcbiAgICAgICAgICAgIGlzTG9hZGluZzogZmFsc2UsXG4gICAgICAgIH0sICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGhhc01vcmVSZXN1bHRzID0gISF0aGlzLnN0YXRlLm5leHRCYXRjaDtcbiAgICAgICAgICAgIHJlc29sdmUoaGFzTW9yZVJlc3VsdHMpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHByb21pc2U7XG4gICAgfTtcblxuICAgIHByaXZhdGUgbG9jYWxseVJlZGFjdEV2ZW50c0lmTmVlZGVkKG5ld0V2ZW50czogTWF0cml4RXZlbnRbXSk6IHZvaWQge1xuICAgICAgICBjb25zdCByb29tSWQgPSB0aGlzLnByb3BzLm14RXZlbnQuZ2V0Um9vbUlkKCk7XG4gICAgICAgIGNvbnN0IGNsaWVudCA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICAgICAgY29uc3Qgcm9vbSA9IGNsaWVudC5nZXRSb29tKHJvb21JZCk7XG4gICAgICAgIGNvbnN0IHBlbmRpbmdFdmVudHMgPSByb29tLmdldFBlbmRpbmdFdmVudHMoKTtcbiAgICAgICAgZm9yIChjb25zdCBlIG9mIG5ld0V2ZW50cykge1xuICAgICAgICAgICAgY29uc3QgcGVuZGluZ1JlZGFjdGlvbiA9IHBlbmRpbmdFdmVudHMuZmluZChwZSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHBlLmdldFR5cGUoKSA9PT0gXCJtLnJvb20ucmVkYWN0aW9uXCIgJiYgcGUuZ2V0QXNzb2NpYXRlZElkKCkgPT09IGUuZ2V0SWQoKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgaWYgKHBlbmRpbmdSZWRhY3Rpb24pIHtcbiAgICAgICAgICAgICAgICBlLm1hcmtMb2NhbGx5UmVkYWN0ZWQocGVuZGluZ1JlZGFjdGlvbik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgY29tcG9uZW50RGlkTW91bnQoKTogdm9pZCB7XG4gICAgICAgIHRoaXMubG9hZE1vcmVFZGl0cygpO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVuZGVyRWRpdHMoKTogSlNYLkVsZW1lbnRbXSB7XG4gICAgICAgIGNvbnN0IG5vZGVzID0gW107XG4gICAgICAgIGxldCBsYXN0RXZlbnQ7XG4gICAgICAgIGxldCBhbGxFdmVudHMgPSB0aGlzLnN0YXRlLmV2ZW50cztcbiAgICAgICAgLy8gYXBwZW5kIG9yaWdpbmFsIGV2ZW50IHdoZW4gd2UndmUgZG9uZSBsYXN0IHBhZ2luYXRpb25cbiAgICAgICAgaWYgKHRoaXMuc3RhdGUub3JpZ2luYWxFdmVudCAmJiAhdGhpcy5zdGF0ZS5uZXh0QmF0Y2gpIHtcbiAgICAgICAgICAgIGFsbEV2ZW50cyA9IGFsbEV2ZW50cy5jb25jYXQodGhpcy5zdGF0ZS5vcmlnaW5hbEV2ZW50KTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBiYXNlRXZlbnRJZCA9IHRoaXMucHJvcHMubXhFdmVudC5nZXRJZCgpO1xuICAgICAgICBhbGxFdmVudHMuZm9yRWFjaCgoZSwgaSkgPT4ge1xuICAgICAgICAgICAgaWYgKCFsYXN0RXZlbnQgfHwgd2FudHNEYXRlU2VwYXJhdG9yKGxhc3RFdmVudC5nZXREYXRlKCksIGUuZ2V0RGF0ZSgpKSkge1xuICAgICAgICAgICAgICAgIG5vZGVzLnB1c2goPGxpIGtleT17ZS5nZXRUcygpICsgXCJ+XCJ9PjxEYXRlU2VwYXJhdG9yIHRzPXtlLmdldFRzKCl9IC8+PC9saT4pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgaXNCYXNlRXZlbnQgPSBlLmdldElkKCkgPT09IGJhc2VFdmVudElkO1xuICAgICAgICAgICAgbm9kZXMucHVzaCgoXG4gICAgICAgICAgICAgICAgPEVkaXRIaXN0b3J5TWVzc2FnZVxuICAgICAgICAgICAgICAgICAgICBrZXk9e2UuZ2V0SWQoKX1cbiAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNFZGl0PXshaXNCYXNlRXZlbnQgPyBhbGxFdmVudHNbaSArIDFdIDogbnVsbH1cbiAgICAgICAgICAgICAgICAgICAgaXNCYXNlRXZlbnQ9e2lzQmFzZUV2ZW50fVxuICAgICAgICAgICAgICAgICAgICBteEV2ZW50PXtlfVxuICAgICAgICAgICAgICAgICAgICBpc1R3ZWx2ZUhvdXI9e3RoaXMuc3RhdGUuaXNUd2VsdmVIb3VyfVxuICAgICAgICAgICAgICAgIC8+KSk7XG4gICAgICAgICAgICBsYXN0RXZlbnQgPSBlO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIG5vZGVzO1xuICAgIH1cblxuICAgIHB1YmxpYyByZW5kZXIoKTogSlNYLkVsZW1lbnQge1xuICAgICAgICBsZXQgY29udGVudDtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnN0IHsgZXJyb3IgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgICAgICBpZiAoZXJyb3IuZXJyY29kZSA9PT0gXCJNX1VOUkVDT0dOSVpFRFwiKSB7XG4gICAgICAgICAgICAgICAgY29udGVudCA9ICg8cCBjbGFzc05hbWU9XCJteF9NZXNzYWdlRWRpdEhpc3RvcnlEaWFsb2dfZXJyb3JcIj5cbiAgICAgICAgICAgICAgICAgICAgeyBfdChcIllvdXIgaG9tZXNlcnZlciBkb2Vzbid0IHNlZW0gdG8gc3VwcG9ydCB0aGlzIGZlYXR1cmUuXCIpIH1cbiAgICAgICAgICAgICAgICA8L3A+KTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXJyb3IuZXJyY29kZSkge1xuICAgICAgICAgICAgICAgIC8vIHNvbWUga2luZCBvZiBlcnJvciBmcm9tIHRoZSBob21lc2VydmVyXG4gICAgICAgICAgICAgICAgY29udGVudCA9ICg8cCBjbGFzc05hbWU9XCJteF9NZXNzYWdlRWRpdEhpc3RvcnlEaWFsb2dfZXJyb3JcIj5cbiAgICAgICAgICAgICAgICAgICAgeyBfdChcIlNvbWV0aGluZyB3ZW50IHdyb25nIVwiKSB9XG4gICAgICAgICAgICAgICAgPC9wPik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnRlbnQgPSAoPHAgY2xhc3NOYW1lPVwibXhfTWVzc2FnZUVkaXRIaXN0b3J5RGlhbG9nX2Vycm9yXCI+XG4gICAgICAgICAgICAgICAgICAgIHsgX3QoXCJDYW5ub3QgcmVhY2ggaG9tZXNlcnZlclwiKSB9XG4gICAgICAgICAgICAgICAgICAgIDxiciAvPlxuICAgICAgICAgICAgICAgICAgICB7IF90KFwiRW5zdXJlIHlvdSBoYXZlIGEgc3RhYmxlIGludGVybmV0IGNvbm5lY3Rpb24sIG9yIGdldCBpbiB0b3VjaCB3aXRoIHRoZSBzZXJ2ZXIgYWRtaW5cIikgfVxuICAgICAgICAgICAgICAgIDwvcD4pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuc3RhdGUuaXNMb2FkaW5nKSB7XG4gICAgICAgICAgICBjb250ZW50ID0gPFNwaW5uZXIgLz47XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb250ZW50ID0gKDxTY3JvbGxQYW5lbFxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X01lc3NhZ2VFZGl0SGlzdG9yeURpYWxvZ19zY3JvbGxQYW5lbFwiXG4gICAgICAgICAgICAgICAgb25GaWxsUmVxdWVzdD17dGhpcy5sb2FkTW9yZUVkaXRzfVxuICAgICAgICAgICAgICAgIHN0aWNreUJvdHRvbT17ZmFsc2V9XG4gICAgICAgICAgICAgICAgc3RhcnRBdEJvdHRvbT17ZmFsc2V9XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgPHVsIGNsYXNzTmFtZT1cIm14X01lc3NhZ2VFZGl0SGlzdG9yeURpYWxvZ19lZGl0c1wiPnsgdGhpcy5yZW5kZXJFZGl0cygpIH08L3VsPlxuICAgICAgICAgICAgPC9TY3JvbGxQYW5lbD4pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8QmFzZURpYWxvZ1xuICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0nbXhfTWVzc2FnZUVkaXRIaXN0b3J5RGlhbG9nJ1xuICAgICAgICAgICAgICAgIGhhc0NhbmNlbD17dHJ1ZX1cbiAgICAgICAgICAgICAgICBvbkZpbmlzaGVkPXt0aGlzLnByb3BzLm9uRmluaXNoZWR9XG4gICAgICAgICAgICAgICAgdGl0bGU9e190KFwiTWVzc2FnZSBlZGl0c1wiKX1cbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICB7IGNvbnRlbnQgfVxuICAgICAgICAgICAgPC9CYXNlRGlhbG9nPlxuICAgICAgICApO1xuICAgIH1cbn1cbiJdfQ==