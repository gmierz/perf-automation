"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _languageHandler = require("../../../languageHandler");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _Media = require("../../../customisations/Media");

var _VerificationComplete = _interopRequireDefault(require("../verification/VerificationComplete"));

var _VerificationCancelled = _interopRequireDefault(require("../verification/VerificationCancelled"));

var _BaseAvatar = _interopRequireDefault(require("../avatars/BaseAvatar"));

var _Spinner = _interopRequireDefault(require("../elements/Spinner"));

var _VerificationShowSas = _interopRequireDefault(require("../verification/VerificationShowSas"));

var _BaseDialog = _interopRequireDefault(require("./BaseDialog"));

var _DialogButtons = _interopRequireDefault(require("../elements/DialogButtons"));

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class;

const PHASE_START = 0;
const PHASE_SHOW_SAS = 1;
const PHASE_WAIT_FOR_PARTNER_TO_CONFIRM = 2;
const PHASE_VERIFIED = 3;
const PHASE_CANCELLED = 4;
let IncomingSasDialog = (_dec = (0, _replaceableComponent.replaceableComponent)("views.dialogs.IncomingSasDialog"), _dec(_class = class IncomingSasDialog extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "showSasEvent", void 0);
    (0, _defineProperty2.default)(this, "onFinished", () => {
      this.props.onFinished(this.state.phase === PHASE_VERIFIED);
    });
    (0, _defineProperty2.default)(this, "onCancelClick", () => {
      this.props.onFinished(this.state.phase === PHASE_VERIFIED);
    });
    (0, _defineProperty2.default)(this, "onContinueClick", () => {
      this.setState({
        phase: PHASE_WAIT_FOR_PARTNER_TO_CONFIRM
      });
      this.props.verifier.verify().then(() => {
        this.setState({
          phase: PHASE_VERIFIED
        });
      }).catch(e => {
        _logger.logger.log("Verification failed", e);
      });
    });
    (0, _defineProperty2.default)(this, "onVerifierShowSas", e => {
      this.showSasEvent = e;
      this.setState({
        phase: PHASE_SHOW_SAS,
        sas: e.sas
      });
    });
    (0, _defineProperty2.default)(this, "onVerifierCancel", () => {
      this.setState({
        phase: PHASE_CANCELLED
      });
    });
    (0, _defineProperty2.default)(this, "onSasMatchesClick", () => {
      this.showSasEvent.confirm();
      this.setState({
        phase: PHASE_WAIT_FOR_PARTNER_TO_CONFIRM
      });
    });
    (0, _defineProperty2.default)(this, "onVerifiedDoneClick", () => {
      this.props.onFinished(true);
    });
    let phase = PHASE_START;

    if (this.props.verifier.hasBeenCancelled) {
      _logger.logger.log("Verifier was cancelled in the background.");

      phase = PHASE_CANCELLED;
    }

    this.showSasEvent = null;
    this.state = {
      phase: phase,
      sasVerified: false,
      opponentProfile: null,
      opponentProfileError: null,
      sas: null
    };
    this.props.verifier.on('show_sas', this.onVerifierShowSas);
    this.props.verifier.on('cancel', this.onVerifierCancel);
    this.fetchOpponentProfile();
  }

  componentWillUnmount() {
    if (this.state.phase !== PHASE_CANCELLED && this.state.phase !== PHASE_VERIFIED) {
      this.props.verifier.cancel(new Error('User cancel'));
    }

    this.props.verifier.removeListener('show_sas', this.onVerifierShowSas);
  }

  async fetchOpponentProfile() {
    try {
      const prof = await _MatrixClientPeg.MatrixClientPeg.get().getProfileInfo(this.props.verifier.userId);
      this.setState({
        opponentProfile: prof
      });
    } catch (e) {
      this.setState({
        opponentProfileError: e
      });
    }
  }

  renderPhaseStart() {
    const isSelf = this.props.verifier.userId === _MatrixClientPeg.MatrixClientPeg.get().getUserId();

    let profile;
    const oppProfile = this.state.opponentProfile;

    if (oppProfile) {
      const url = oppProfile.avatar_url ? (0, _Media.mediaFromMxc)(oppProfile.avatar_url).getSquareThumbnailHttp(48) : null;
      profile = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_IncomingSasDialog_opponentProfile"
      }, /*#__PURE__*/_react.default.createElement(_BaseAvatar.default, {
        name: oppProfile.displayname,
        idName: this.props.verifier.userId,
        url: url,
        width: 48,
        height: 48,
        resizeMethod: "crop"
      }), /*#__PURE__*/_react.default.createElement("h2", null, oppProfile.displayname));
    } else if (this.state.opponentProfileError) {
      profile = /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement(_BaseAvatar.default, {
        name: this.props.verifier.userId.slice(1),
        idName: this.props.verifier.userId,
        width: 48,
        height: 48
      }), /*#__PURE__*/_react.default.createElement("h2", null, this.props.verifier.userId));
    } else {
      profile = /*#__PURE__*/_react.default.createElement(_Spinner.default, null);
    }

    const userDetailText = [/*#__PURE__*/_react.default.createElement("p", {
      key: "p1"
    }, (0, _languageHandler._t)("Verify this user to mark them as trusted. " + "Trusting users gives you extra peace of mind when using " + "end-to-end encrypted messages.")), /*#__PURE__*/_react.default.createElement("p", {
      key: "p2"
    }, (0, _languageHandler._t)( // NB. Below wording adjusted to singular 'session' until we have
    // cross-signing
    "Verifying this user will mark their session as trusted, and " + "also mark your session as trusted to them."))];
    const selfDetailText = [/*#__PURE__*/_react.default.createElement("p", {
      key: "p1"
    }, (0, _languageHandler._t)("Verify this device to mark it as trusted. " + "Trusting this device gives you and other users extra peace of mind when using " + "end-to-end encrypted messages.")), /*#__PURE__*/_react.default.createElement("p", {
      key: "p2"
    }, (0, _languageHandler._t)("Verifying this device will mark it as trusted, and users who have verified with " + "you will trust this device."))];
    return /*#__PURE__*/_react.default.createElement("div", null, profile, isSelf ? selfDetailText : userDetailText, /*#__PURE__*/_react.default.createElement(_DialogButtons.default, {
      primaryButton: (0, _languageHandler._t)('Continue'),
      hasCancel: true,
      onPrimaryButtonClick: this.onContinueClick,
      onCancel: this.onCancelClick
    }));
  }

  renderPhaseShowSas() {
    return /*#__PURE__*/_react.default.createElement(_VerificationShowSas.default, {
      sas: this.showSasEvent.sas,
      onCancel: this.onCancelClick,
      onDone: this.onSasMatchesClick,
      isSelf: this.props.verifier.userId === _MatrixClientPeg.MatrixClientPeg.get().getUserId(),
      inDialog: true
    });
  }

  renderPhaseWaitForPartnerToConfirm() {
    return /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement(_Spinner.default, null), /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Waiting for partner to confirm...")));
  }

  renderPhaseVerified() {
    return /*#__PURE__*/_react.default.createElement(_VerificationComplete.default, {
      onDone: this.onVerifiedDoneClick
    });
  }

  renderPhaseCancelled() {
    return /*#__PURE__*/_react.default.createElement(_VerificationCancelled.default, {
      onDone: this.onCancelClick
    });
  }

  render() {
    let body;

    switch (this.state.phase) {
      case PHASE_START:
        body = this.renderPhaseStart();
        break;

      case PHASE_SHOW_SAS:
        body = this.renderPhaseShowSas();
        break;

      case PHASE_WAIT_FOR_PARTNER_TO_CONFIRM:
        body = this.renderPhaseWaitForPartnerToConfirm();
        break;

      case PHASE_VERIFIED:
        body = this.renderPhaseVerified();
        break;

      case PHASE_CANCELLED:
        body = this.renderPhaseCancelled();
        break;
    }

    return /*#__PURE__*/_react.default.createElement(_BaseDialog.default, {
      title: (0, _languageHandler._t)("Incoming Verification Request"),
      onFinished: this.onFinished,
      fixedWidth: false
    }, body);
  }

}) || _class);
exports.default = IncomingSasDialog;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvSW5jb21pbmdTYXNEaWFsb2cudHN4Il0sIm5hbWVzIjpbIlBIQVNFX1NUQVJUIiwiUEhBU0VfU0hPV19TQVMiLCJQSEFTRV9XQUlUX0ZPUl9QQVJUTkVSX1RPX0NPTkZJUk0iLCJQSEFTRV9WRVJJRklFRCIsIlBIQVNFX0NBTkNFTExFRCIsIkluY29taW5nU2FzRGlhbG9nIiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwib25GaW5pc2hlZCIsInN0YXRlIiwicGhhc2UiLCJzZXRTdGF0ZSIsInZlcmlmaWVyIiwidmVyaWZ5IiwidGhlbiIsImNhdGNoIiwiZSIsImxvZ2dlciIsImxvZyIsInNob3dTYXNFdmVudCIsInNhcyIsImNvbmZpcm0iLCJoYXNCZWVuQ2FuY2VsbGVkIiwic2FzVmVyaWZpZWQiLCJvcHBvbmVudFByb2ZpbGUiLCJvcHBvbmVudFByb2ZpbGVFcnJvciIsIm9uIiwib25WZXJpZmllclNob3dTYXMiLCJvblZlcmlmaWVyQ2FuY2VsIiwiZmV0Y2hPcHBvbmVudFByb2ZpbGUiLCJjb21wb25lbnRXaWxsVW5tb3VudCIsImNhbmNlbCIsIkVycm9yIiwicmVtb3ZlTGlzdGVuZXIiLCJwcm9mIiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0IiwiZ2V0UHJvZmlsZUluZm8iLCJ1c2VySWQiLCJyZW5kZXJQaGFzZVN0YXJ0IiwiaXNTZWxmIiwiZ2V0VXNlcklkIiwicHJvZmlsZSIsIm9wcFByb2ZpbGUiLCJ1cmwiLCJhdmF0YXJfdXJsIiwiZ2V0U3F1YXJlVGh1bWJuYWlsSHR0cCIsImRpc3BsYXluYW1lIiwic2xpY2UiLCJ1c2VyRGV0YWlsVGV4dCIsInNlbGZEZXRhaWxUZXh0Iiwib25Db250aW51ZUNsaWNrIiwib25DYW5jZWxDbGljayIsInJlbmRlclBoYXNlU2hvd1NhcyIsIm9uU2FzTWF0Y2hlc0NsaWNrIiwicmVuZGVyUGhhc2VXYWl0Rm9yUGFydG5lclRvQ29uZmlybSIsInJlbmRlclBoYXNlVmVyaWZpZWQiLCJvblZlcmlmaWVkRG9uZUNsaWNrIiwicmVuZGVyUGhhc2VDYW5jZWxsZWQiLCJyZW5kZXIiLCJib2R5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWdCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFLQTs7OztBQUVBLE1BQU1BLFdBQVcsR0FBRyxDQUFwQjtBQUNBLE1BQU1DLGNBQWMsR0FBRyxDQUF2QjtBQUNBLE1BQU1DLGlDQUFpQyxHQUFHLENBQTFDO0FBQ0EsTUFBTUMsY0FBYyxHQUFHLENBQXZCO0FBQ0EsTUFBTUMsZUFBZSxHQUFHLENBQXhCO0lBbUJxQkMsaUIsV0FEcEIsZ0RBQXFCLGlDQUFyQixDLGdCQUFELE1BQ3FCQSxpQkFEckIsU0FDK0NDLGVBQU1DLFNBRHJELENBQytFO0FBRzNFQyxFQUFBQSxXQUFXLENBQUNDLEtBQUQsRUFBZ0I7QUFDdkIsVUFBTUEsS0FBTjtBQUR1QjtBQUFBLHNEQTRDTixNQUFZO0FBQzdCLFdBQUtBLEtBQUwsQ0FBV0MsVUFBWCxDQUFzQixLQUFLQyxLQUFMLENBQVdDLEtBQVgsS0FBcUJULGNBQTNDO0FBQ0gsS0E5QzBCO0FBQUEseURBZ0RILE1BQVk7QUFDaEMsV0FBS00sS0FBTCxDQUFXQyxVQUFYLENBQXNCLEtBQUtDLEtBQUwsQ0FBV0MsS0FBWCxLQUFxQlQsY0FBM0M7QUFDSCxLQWxEMEI7QUFBQSwyREFvREQsTUFBWTtBQUNsQyxXQUFLVSxRQUFMLENBQWM7QUFBRUQsUUFBQUEsS0FBSyxFQUFFVjtBQUFULE9BQWQ7QUFDQSxXQUFLTyxLQUFMLENBQVdLLFFBQVgsQ0FBb0JDLE1BQXBCLEdBQTZCQyxJQUE3QixDQUFrQyxNQUFNO0FBQ3BDLGFBQUtILFFBQUwsQ0FBYztBQUFFRCxVQUFBQSxLQUFLLEVBQUVUO0FBQVQsU0FBZDtBQUNILE9BRkQsRUFFR2MsS0FGSCxDQUVVQyxDQUFELElB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QkFBTyw2QkFBQyw2QkFBRDtBQUFzQixNQUFBLE1BQU0sRUFBRSxLQUFLQztBQUFuQyxNQUFQO0FBQ0g7O0FBRU9DLEVBQUFBLG9CQUFvQixHQUFnQjtBQUN4Qyx3QkFBTyw2QkFBQyw4QkFBRDtBQUF1QixNQUFBLE1BQU0sRUFBRSxLQUFLTjtBQUFwQyxNQUFQO0FBQ0g7O0FBRU1PLEVBQUFBLE1BQU0sR0FBZ0I7QUFDekIsUUFBSUMsSUFBSjs7QUFDQSxZQUFRLEtBQUtuRCxLQUFMLENBQVdDLEtBQW5CO0FBQ0ksV0FBS1osV0FBTDtBQUNJOEQsUUFBQUEsSUFBSSxHQUFHLEtBQUtyQixnQkFBTCxFQUFQO0FBQ0E7O0FBQ0osV0FBS3hDLGNBQUw7QUFDSTZELFFBQUFBLElBQUksR0FBRyxLQUFLUCxrQkFBTCxFQUFQO0FBQ0E7O0FBQ0osV0FBS3JELGlDQUFMO0FBQ0k0RCxRQUFBQSxJQUFJLEdBQUcsS0FBS0wsa0NBQUwsRUFBUDtBQUNBOztBQUNKLFdBQUt0RCxjQUFMO0FBQ0kyRCxRQUFBQSxJQUFJLEdBQUcsS0FBS0osbUJBQUwsRUFBUDtBQUNBOztBQUNKLFdBQUt0RCxlQUFMO0FBQ0kwRCxRQUFBQSxJQUFJLEdBQUcsS0FBS0Ysb0JBQUwsRUFBUDtBQUNBO0FBZlI7O0FBa0JBLHdCQUNJLDZCQUFDLG1CQUFEO0FBQ0ksTUFBQSxLQUFLLEVBQUUseUJBQUcsK0JBQUgsQ0FEWDtBQUVJLE1BQUEsVUFBVSxFQUFFLEtBQUtsRCxVQUZyQjtBQUdJLE1BQUEsVUFBVSxFQUFFO0FBSGhCLE9BS01vRCxJQUxOLENBREo7QUFTSDs7QUEzTjBFLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTkgTmV3IFZlY3RvciBMdGRcblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSAnLi4vLi4vLi4vTWF0cml4Q2xpZW50UGVnJztcbmltcG9ydCB7IF90IH0gZnJvbSAnLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyJztcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5pbXBvcnQgeyBtZWRpYUZyb21NeGMgfSBmcm9tIFwiLi4vLi4vLi4vY3VzdG9taXNhdGlvbnMvTWVkaWFcIjtcbmltcG9ydCBWZXJpZmljYXRpb25Db21wbGV0ZSBmcm9tIFwiLi4vdmVyaWZpY2F0aW9uL1ZlcmlmaWNhdGlvbkNvbXBsZXRlXCI7XG5pbXBvcnQgVmVyaWZpY2F0aW9uQ2FuY2VsbGVkIGZyb20gXCIuLi92ZXJpZmljYXRpb24vVmVyaWZpY2F0aW9uQ2FuY2VsbGVkXCI7XG5pbXBvcnQgQmFzZUF2YXRhciBmcm9tIFwiLi4vYXZhdGFycy9CYXNlQXZhdGFyXCI7XG5pbXBvcnQgU3Bpbm5lciBmcm9tIFwiLi4vZWxlbWVudHMvU3Bpbm5lclwiO1xuaW1wb3J0IFZlcmlmaWNhdGlvblNob3dTYXMgZnJvbSBcIi4uL3ZlcmlmaWNhdGlvbi9WZXJpZmljYXRpb25TaG93U2FzXCI7XG5pbXBvcnQgQmFzZURpYWxvZyBmcm9tIFwiLi9CYXNlRGlhbG9nXCI7XG5pbXBvcnQgRGlhbG9nQnV0dG9ucyBmcm9tIFwiLi4vZWxlbWVudHMvRGlhbG9nQnV0dG9uc1wiO1xuaW1wb3J0IHsgSURpYWxvZ1Byb3BzIH0gZnJvbSBcIi4vSURpYWxvZ1Byb3BzXCI7XG5pbXBvcnQgeyBJR2VuZXJhdGVkU2FzLCBJU2FzRXZlbnQgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvY3J5cHRvL3ZlcmlmaWNhdGlvbi9TQVNcIjtcbmltcG9ydCB7IFZlcmlmaWNhdGlvbkJhc2UgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvY3J5cHRvL3ZlcmlmaWNhdGlvbi9CYXNlXCI7XG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcblxuY29uc3QgUEhBU0VfU1RBUlQgPSAwO1xuY29uc3QgUEhBU0VfU0hPV19TQVMgPSAxO1xuY29uc3QgUEhBU0VfV0FJVF9GT1JfUEFSVE5FUl9UT19DT05GSVJNID0gMjtcbmNvbnN0IFBIQVNFX1ZFUklGSUVEID0gMztcbmNvbnN0IFBIQVNFX0NBTkNFTExFRCA9IDQ7XG5cbmludGVyZmFjZSBJUHJvcHMgZXh0ZW5kcyBJRGlhbG9nUHJvcHMge1xuICAgIHZlcmlmaWVyOiBWZXJpZmljYXRpb25CYXNlO1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBwaGFzZTogbnVtYmVyO1xuICAgIHNhc1ZlcmlmaWVkOiBib29sZWFuO1xuICAgIG9wcG9uZW50UHJvZmlsZToge1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgY2FtZWxjYXNlXG4gICAgICAgIGF2YXRhcl91cmw/OiBzdHJpbmc7XG4gICAgICAgIGRpc3BsYXluYW1lPzogc3RyaW5nO1xuICAgIH07XG4gICAgb3Bwb25lbnRQcm9maWxlRXJyb3I6IEVycm9yO1xuICAgIHNhczogSUdlbmVyYXRlZFNhcztcbn1cblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3MuZGlhbG9ncy5JbmNvbWluZ1Nhc0RpYWxvZ1wiKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSW5jb21pbmdTYXNEaWFsb2cgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8SVByb3BzLCBJU3RhdGU+IHtcbiAgICBwcml2YXRlIHNob3dTYXNFdmVudDogSVNhc0V2ZW50O1xuXG4gICAgY29uc3RydWN0b3IocHJvcHM6IElQcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG5cbiAgICAgICAgbGV0IHBoYXNlID0gUEhBU0VfU1RBUlQ7XG4gICAgICAgIGlmICh0aGlzLnByb3BzLnZlcmlmaWVyLmhhc0JlZW5DYW5jZWxsZWQpIHtcbiAgICAgICAgICAgIGxvZ2dlci5sb2coXCJWZXJpZmllciB3YXMgY2FuY2VsbGVkIGluIHRoZSBiYWNrZ3JvdW5kLlwiKTtcbiAgICAgICAgICAgIHBoYXNlID0gUEhBU0VfQ0FOQ0VMTEVEO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zaG93U2FzRXZlbnQgPSBudWxsO1xuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgcGhhc2U6IHBoYXNlLFxuICAgICAgICAgICAgc2FzVmVyaWZpZWQ6IGZhbHNlLFxuICAgICAgICAgICAgb3Bwb25lbnRQcm9maWxlOiBudWxsLFxuICAgICAgICAgICAgb3Bwb25lbnRQcm9maWxlRXJyb3I6IG51bGwsXG4gICAgICAgICAgICBzYXM6IG51bGwsXG4gICAgICAgIH07XG4gICAgICAgIHRoaXMucHJvcHMudmVyaWZpZXIub24oJ3Nob3dfc2FzJywgdGhpcy5vblZlcmlmaWVyU2hvd1Nhcyk7XG4gICAgICAgIHRoaXMucHJvcHMudmVyaWZpZXIub24oJ2NhbmNlbCcsIHRoaXMub25WZXJpZmllckNhbmNlbCk7XG4gICAgICAgIHRoaXMuZmV0Y2hPcHBvbmVudFByb2ZpbGUoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY29tcG9uZW50V2lsbFVubW91bnQoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnBoYXNlICE9PSBQSEFTRV9DQU5DRUxMRUQgJiYgdGhpcy5zdGF0ZS5waGFzZSAhPT0gUEhBU0VfVkVSSUZJRUQpIHtcbiAgICAgICAgICAgIHRoaXMucHJvcHMudmVyaWZpZXIuY2FuY2VsKG5ldyBFcnJvcignVXNlciBjYW5jZWwnKSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5wcm9wcy52ZXJpZmllci5yZW1vdmVMaXN0ZW5lcignc2hvd19zYXMnLCB0aGlzLm9uVmVyaWZpZXJTaG93U2FzKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIGZldGNoT3Bwb25lbnRQcm9maWxlKCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgcHJvZiA9IGF3YWl0IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRQcm9maWxlSW5mbyhcbiAgICAgICAgICAgICAgICB0aGlzLnByb3BzLnZlcmlmaWVyLnVzZXJJZCxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICBvcHBvbmVudFByb2ZpbGU6IHByb2YsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgb3Bwb25lbnRQcm9maWxlRXJyb3I6IGUsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgb25GaW5pc2hlZCA9ICgpOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5wcm9wcy5vbkZpbmlzaGVkKHRoaXMuc3RhdGUucGhhc2UgPT09IFBIQVNFX1ZFUklGSUVEKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkNhbmNlbENsaWNrID0gKCk6IHZvaWQgPT4ge1xuICAgICAgICB0aGlzLnByb3BzLm9uRmluaXNoZWQodGhpcy5zdGF0ZS5waGFzZSA9PT0gUEhBU0VfVkVSSUZJRUQpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uQ29udGludWVDbGljayA9ICgpOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IHBoYXNlOiBQSEFTRV9XQUlUX0ZPUl9QQVJUTkVSX1RPX0NPTkZJUk0gfSk7XG4gICAgICAgIHRoaXMucHJvcHMudmVyaWZpZXIudmVyaWZ5KCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgcGhhc2U6IFBIQVNFX1ZFUklGSUVEIH0pO1xuICAgICAgICB9KS5jYXRjaCgoZSkgPT4ge1xuICAgICAgICAgICAgbG9nZ2VyLmxvZyhcIlZlcmlmaWNhdGlvbiBmYWlsZWRcIiwgZSk7XG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uVmVyaWZpZXJTaG93U2FzID0gKGU6IElTYXNFdmVudCk6IHZvaWQgPT4ge1xuICAgICAgICB0aGlzLnNob3dTYXNFdmVudCA9IGU7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgcGhhc2U6IFBIQVNFX1NIT1dfU0FTLFxuICAgICAgICAgICAgc2FzOiBlLnNhcyxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25WZXJpZmllckNhbmNlbCA9ICgpOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBwaGFzZTogUEhBU0VfQ0FOQ0VMTEVELFxuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvblNhc01hdGNoZXNDbGljayA9ICgpOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5zaG93U2FzRXZlbnQuY29uZmlybSgpO1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIHBoYXNlOiBQSEFTRV9XQUlUX0ZPUl9QQVJUTkVSX1RPX0NPTkZJUk0sXG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uVmVyaWZpZWREb25lQ2xpY2sgPSAoKTogdm9pZCA9PiB7XG4gICAgICAgIHRoaXMucHJvcHMub25GaW5pc2hlZCh0cnVlKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSByZW5kZXJQaGFzZVN0YXJ0KCk6IEpTWC5FbGVtZW50IHtcbiAgICAgICAgY29uc3QgaXNTZWxmID0gdGhpcy5wcm9wcy52ZXJpZmllci51c2VySWQgPT09IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRVc2VySWQoKTtcblxuICAgICAgICBsZXQgcHJvZmlsZTtcbiAgICAgICAgY29uc3Qgb3BwUHJvZmlsZSA9IHRoaXMuc3RhdGUub3Bwb25lbnRQcm9maWxlO1xuICAgICAgICBpZiAob3BwUHJvZmlsZSkge1xuICAgICAgICAgICAgY29uc3QgdXJsID0gb3BwUHJvZmlsZS5hdmF0YXJfdXJsXG4gICAgICAgICAgICAgICAgPyBtZWRpYUZyb21NeGMob3BwUHJvZmlsZS5hdmF0YXJfdXJsKS5nZXRTcXVhcmVUaHVtYm5haWxIdHRwKDQ4KVxuICAgICAgICAgICAgICAgIDogbnVsbDtcbiAgICAgICAgICAgIHByb2ZpbGUgPSA8ZGl2IGNsYXNzTmFtZT1cIm14X0luY29taW5nU2FzRGlhbG9nX29wcG9uZW50UHJvZmlsZVwiPlxuICAgICAgICAgICAgICAgIDxCYXNlQXZhdGFyXG4gICAgICAgICAgICAgICAgICAgIG5hbWU9e29wcFByb2ZpbGUuZGlzcGxheW5hbWV9XG4gICAgICAgICAgICAgICAgICAgIGlkTmFtZT17dGhpcy5wcm9wcy52ZXJpZmllci51c2VySWR9XG4gICAgICAgICAgICAgICAgICAgIHVybD17dXJsfVxuICAgICAgICAgICAgICAgICAgICB3aWR0aD17NDh9XG4gICAgICAgICAgICAgICAgICAgIGhlaWdodD17NDh9XG4gICAgICAgICAgICAgICAgICAgIHJlc2l6ZU1ldGhvZD0nY3JvcCdcbiAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgIDxoMj57IG9wcFByb2ZpbGUuZGlzcGxheW5hbWUgfTwvaDI+XG4gICAgICAgICAgICA8L2Rpdj47XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5zdGF0ZS5vcHBvbmVudFByb2ZpbGVFcnJvcikge1xuICAgICAgICAgICAgcHJvZmlsZSA9IDxkaXY+XG4gICAgICAgICAgICAgICAgPEJhc2VBdmF0YXJcbiAgICAgICAgICAgICAgICAgICAgbmFtZT17dGhpcy5wcm9wcy52ZXJpZmllci51c2VySWQuc2xpY2UoMSl9XG4gICAgICAgICAgICAgICAgICAgIGlkTmFtZT17dGhpcy5wcm9wcy52ZXJpZmllci51c2VySWR9XG4gICAgICAgICAgICAgICAgICAgIHdpZHRoPXs0OH1cbiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0PXs0OH1cbiAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgIDxoMj57IHRoaXMucHJvcHMudmVyaWZpZXIudXNlcklkIH08L2gyPlxuICAgICAgICAgICAgPC9kaXY+O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcHJvZmlsZSA9IDxTcGlubmVyIC8+O1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdXNlckRldGFpbFRleHQgPSBbXG4gICAgICAgICAgICA8cCBrZXk9XCJwMVwiPnsgX3QoXG4gICAgICAgICAgICAgICAgXCJWZXJpZnkgdGhpcyB1c2VyIHRvIG1hcmsgdGhlbSBhcyB0cnVzdGVkLiBcIiArXG4gICAgICAgICAgICAgICAgXCJUcnVzdGluZyB1c2VycyBnaXZlcyB5b3UgZXh0cmEgcGVhY2Ugb2YgbWluZCB3aGVuIHVzaW5nIFwiICtcbiAgICAgICAgICAgICAgICBcImVuZC10by1lbmQgZW5jcnlwdGVkIG1lc3NhZ2VzLlwiLFxuICAgICAgICAgICAgKSB9PC9wPixcbiAgICAgICAgICAgIDxwIGtleT1cInAyXCI+eyBfdChcbiAgICAgICAgICAgICAgICAvLyBOQi4gQmVsb3cgd29yZGluZyBhZGp1c3RlZCB0byBzaW5ndWxhciAnc2Vzc2lvbicgdW50aWwgd2UgaGF2ZVxuICAgICAgICAgICAgICAgIC8vIGNyb3NzLXNpZ25pbmdcbiAgICAgICAgICAgICAgICBcIlZlcmlmeWluZyB0aGlzIHVzZXIgd2lsbCBtYXJrIHRoZWlyIHNlc3Npb24gYXMgdHJ1c3RlZCwgYW5kIFwiICtcbiAgICAgICAgICAgICAgICBcImFsc28gbWFyayB5b3VyIHNlc3Npb24gYXMgdHJ1c3RlZCB0byB0aGVtLlwiLFxuICAgICAgICAgICAgKSB9PC9wPixcbiAgICAgICAgXTtcblxuICAgICAgICBjb25zdCBzZWxmRGV0YWlsVGV4dCA9IFtcbiAgICAgICAgICAgIDxwIGtleT1cInAxXCI+eyBfdChcbiAgICAgICAgICAgICAgICBcIlZlcmlmeSB0aGlzIGRldmljZSB0byBtYXJrIGl0IGFzIHRydXN0ZWQuIFwiICtcbiAgICAgICAgICAgICAgICBcIlRydXN0aW5nIHRoaXMgZGV2aWNlIGdpdmVzIHlvdSBhbmQgb3RoZXIgdXNlcnMgZXh0cmEgcGVhY2Ugb2YgbWluZCB3aGVuIHVzaW5nIFwiICtcbiAgICAgICAgICAgICAgICBcImVuZC10by1lbmQgZW5jcnlwdGVkIG1lc3NhZ2VzLlwiLFxuICAgICAgICAgICAgKSB9PC9wPixcbiAgICAgICAgICAgIDxwIGtleT1cInAyXCI+eyBfdChcbiAgICAgICAgICAgICAgICBcIlZlcmlmeWluZyB0aGlzIGRldmljZSB3aWxsIG1hcmsgaXQgYXMgdHJ1c3RlZCwgYW5kIHVzZXJzIHdobyBoYXZlIHZlcmlmaWVkIHdpdGggXCIgK1xuICAgICAgICAgICAgICAgIFwieW91IHdpbGwgdHJ1c3QgdGhpcyBkZXZpY2UuXCIsXG4gICAgICAgICAgICApIH08L3A+LFxuICAgICAgICBdO1xuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8ZGl2PlxuICAgICAgICAgICAgICAgIHsgcHJvZmlsZSB9XG4gICAgICAgICAgICAgICAgeyBpc1NlbGYgPyBzZWxmRGV0YWlsVGV4dCA6IHVzZXJEZXRhaWxUZXh0IH1cbiAgICAgICAgICAgICAgICA8RGlhbG9nQnV0dG9uc1xuICAgICAgICAgICAgICAgICAgICBwcmltYXJ5QnV0dG9uPXtfdCgnQ29udGludWUnKX1cbiAgICAgICAgICAgICAgICAgICAgaGFzQ2FuY2VsPXt0cnVlfVxuICAgICAgICAgICAgICAgICAgICBvblByaW1hcnlCdXR0b25DbGljaz17dGhpcy5vbkNvbnRpbnVlQ2xpY2t9XG4gICAgICAgICAgICAgICAgICAgIG9uQ2FuY2VsPXt0aGlzLm9uQ2FuY2VsQ2xpY2t9XG4gICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVuZGVyUGhhc2VTaG93U2FzKCk6IEpTWC5FbGVtZW50IHtcbiAgICAgICAgcmV0dXJuIDxWZXJpZmljYXRpb25TaG93U2FzXG4gICAgICAgICAgICBzYXM9e3RoaXMuc2hvd1Nhc0V2ZW50LnNhc31cbiAgICAgICAgICAgIG9uQ2FuY2VsPXt0aGlzLm9uQ2FuY2VsQ2xpY2t9XG4gICAgICAgICAgICBvbkRvbmU9e3RoaXMub25TYXNNYXRjaGVzQ2xpY2t9XG4gICAgICAgICAgICBpc1NlbGY9e3RoaXMucHJvcHMudmVyaWZpZXIudXNlcklkID09PSBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZ2V0VXNlcklkKCl9XG4gICAgICAgICAgICBpbkRpYWxvZz17dHJ1ZX1cbiAgICAgICAgLz47XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZW5kZXJQaGFzZVdhaXRGb3JQYXJ0bmVyVG9Db25maXJtKCk6IEpTWC5FbGVtZW50IHtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXY+XG4gICAgICAgICAgICAgICAgPFNwaW5uZXIgLz5cbiAgICAgICAgICAgICAgICA8cD57IF90KFwiV2FpdGluZyBmb3IgcGFydG5lciB0byBjb25maXJtLi4uXCIpIH08L3A+XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlbmRlclBoYXNlVmVyaWZpZWQoKTogSlNYLkVsZW1lbnQge1xuICAgICAgICByZXR1cm4gPFZlcmlmaWNhdGlvbkNvbXBsZXRlIG9uRG9uZT17dGhpcy5vblZlcmlmaWVkRG9uZUNsaWNrfSAvPjtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlbmRlclBoYXNlQ2FuY2VsbGVkKCk6IEpTWC5FbGVtZW50IHtcbiAgICAgICAgcmV0dXJuIDxWZXJpZmljYXRpb25DYW5jZWxsZWQgb25Eb25lPXt0aGlzLm9uQ2FuY2VsQ2xpY2t9IC8+O1xuICAgIH1cblxuICAgIHB1YmxpYyByZW5kZXIoKTogSlNYLkVsZW1lbnQge1xuICAgICAgICBsZXQgYm9keTtcbiAgICAgICAgc3dpdGNoICh0aGlzLnN0YXRlLnBoYXNlKSB7XG4gICAgICAgICAgICBjYXNlIFBIQVNFX1NUQVJUOlxuICAgICAgICAgICAgICAgIGJvZHkgPSB0aGlzLnJlbmRlclBoYXNlU3RhcnQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgUEhBU0VfU0hPV19TQVM6XG4gICAgICAgICAgICAgICAgYm9keSA9IHRoaXMucmVuZGVyUGhhc2VTaG93U2FzKCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFBIQVNFX1dBSVRfRk9SX1BBUlRORVJfVE9fQ09ORklSTTpcbiAgICAgICAgICAgICAgICBib2R5ID0gdGhpcy5yZW5kZXJQaGFzZVdhaXRGb3JQYXJ0bmVyVG9Db25maXJtKCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFBIQVNFX1ZFUklGSUVEOlxuICAgICAgICAgICAgICAgIGJvZHkgPSB0aGlzLnJlbmRlclBoYXNlVmVyaWZpZWQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgUEhBU0VfQ0FOQ0VMTEVEOlxuICAgICAgICAgICAgICAgIGJvZHkgPSB0aGlzLnJlbmRlclBoYXNlQ2FuY2VsbGVkKCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPEJhc2VEaWFsb2dcbiAgICAgICAgICAgICAgICB0aXRsZT17X3QoXCJJbmNvbWluZyBWZXJpZmljYXRpb24gUmVxdWVzdFwiKX1cbiAgICAgICAgICAgICAgICBvbkZpbmlzaGVkPXt0aGlzLm9uRmluaXNoZWR9XG4gICAgICAgICAgICAgICAgZml4ZWRXaWR0aD17ZmFsc2V9XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgeyBib2R5IH1cbiAgICAgICAgICAgIDwvQmFzZURpYWxvZz5cbiAgICAgICAgKTtcbiAgICB9XG59XG5cbiJdfQ==