"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _event = require("matrix-js-sdk/src/@types/event");

var _partials = require("matrix-js-sdk/src/@types/partials");

var _languageHandler = require("../../../languageHandler");

var _SdkConfig = _interopRequireDefault(require("../../../SdkConfig"));

var _LabelledToggleSwitch = _interopRequireDefault(require("../elements/LabelledToggleSwitch"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _BugReportDialog = _interopRequireDefault(require("./BugReportDialog"));

var _BaseDialog = _interopRequireDefault(require("./BaseDialog"));

var _DialogButtons = _interopRequireDefault(require("../elements/DialogButtons"));

var _ProgressBar = _interopRequireDefault(require("../elements/ProgressBar"));

var _dec, _class;

let RoomUpgradeWarningDialog = (_dec = (0, _replaceableComponent.replaceableComponent)("views.dialogs.RoomUpgradeWarningDialog"), _dec(_class = class RoomUpgradeWarningDialog extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "isPrivate", void 0);
    (0, _defineProperty2.default)(this, "currentVersion", void 0);
    (0, _defineProperty2.default)(this, "onProgressCallback", (progressText, progress, total) => {
      this.setState({
        progressText,
        progress,
        total
      });
    });
    (0, _defineProperty2.default)(this, "onContinue", () => {
      const opts = {
        continue: true,
        invite: this.isPrivate && this.state.inviteUsersToNewRoom
      };

      if (this.props.doUpgrade) {
        this.props.doUpgrade(opts, this.onProgressCallback).then(() => {
          this.props.onFinished(opts);
        });
      } else {
        this.props.onFinished(opts);
      }
    });
    (0, _defineProperty2.default)(this, "onCancel", () => {
      this.props.onFinished({
        continue: false,
        invite: false
      });
    });
    (0, _defineProperty2.default)(this, "onInviteUsersToggle", inviteUsersToNewRoom => {
      this.setState({
        inviteUsersToNewRoom
      });
    });
    (0, _defineProperty2.default)(this, "openBugReportDialog", e => {
      e.preventDefault();
      e.stopPropagation();

      _Modal.default.createTrackedDialog('Bug Report Dialog', '', _BugReportDialog.default, {});
    });

    const room = _MatrixClientPeg.MatrixClientPeg.get().getRoom(this.props.roomId);

    const joinRules = room === null || room === void 0 ? void 0 : room.currentState.getStateEvents(_event.EventType.RoomJoinRules, "");
    this.isPrivate = (joinRules === null || joinRules === void 0 ? void 0 : joinRules.getContent()['join_rule']) !== _partials.JoinRule.Public ?? true;
    this.currentVersion = room === null || room === void 0 ? void 0 : room.getVersion();
    this.state = {
      inviteUsersToNewRoom: true
    };
  }

  render() {
    const brand = _SdkConfig.default.get().brand;

    let inviteToggle = null;

    if (this.isPrivate) {
      inviteToggle = /*#__PURE__*/_react.default.createElement(_LabelledToggleSwitch.default, {
        value: this.state.inviteUsersToNewRoom,
        onChange: this.onInviteUsersToggle,
        label: (0, _languageHandler._t)("Automatically invite members from this room to the new one")
      });
    }

    const title = this.isPrivate ? (0, _languageHandler._t)("Upgrade private room") : (0, _languageHandler._t)("Upgrade public room");

    let bugReports = /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("This usually only affects how the room is processed on the server. If you're " + "having problems with your %(brand)s, please report a bug.", {
      brand
    }));

    if (_SdkConfig.default.get().bug_report_endpoint_url) {
      bugReports = /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("This usually only affects how the room is processed on the server. If you're " + "having problems with your %(brand)s, please <a>report a bug</a>.", {
        brand
      }, {
        "a": sub => {
          return /*#__PURE__*/_react.default.createElement("a", {
            href: "#",
            onClick: this.openBugReportDialog
          }, sub);
        }
      }));
    }

    let footer;

    if (this.state.progressText) {
      footer = /*#__PURE__*/_react.default.createElement("span", {
        className: "mx_RoomUpgradeWarningDialog_progress"
      }, /*#__PURE__*/_react.default.createElement(_ProgressBar.default, {
        value: this.state.progress,
        max: this.state.total
      }), /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_RoomUpgradeWarningDialog_progressText"
      }, this.state.progressText));
    } else {
      footer = /*#__PURE__*/_react.default.createElement(_DialogButtons.default, {
        primaryButton: (0, _languageHandler._t)("Upgrade"),
        onPrimaryButtonClick: this.onContinue,
        cancelButton: (0, _languageHandler._t)("Cancel"),
        onCancel: this.onCancel
      });
    }

    return /*#__PURE__*/_react.default.createElement(_BaseDialog.default, {
      className: "mx_RoomUpgradeWarningDialog",
      hasCancel: true,
      fixedWidth: false,
      onFinished: this.props.onFinished,
      title: title
    }, /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("p", null, this.props.description || (0, _languageHandler._t)("Upgrading a room is an advanced action and is usually recommended when a room " + "is unstable due to bugs, missing features or security vulnerabilities.")), /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("<b>Please note upgrading will make a new version of the room</b>. " + "All current messages will stay in this archived room.", {}, {
      b: sub => /*#__PURE__*/_react.default.createElement("b", null, sub)
    })), bugReports, /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("You'll upgrade this room from <oldVersion /> to <newVersion />.", {}, {
      oldVersion: () => /*#__PURE__*/_react.default.createElement("code", null, this.currentVersion),
      newVersion: () => /*#__PURE__*/_react.default.createElement("code", null, this.props.targetVersion)
    })), inviteToggle), footer);
  }

}) || _class);
exports.default = RoomUpgradeWarningDialog;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvUm9vbVVwZ3JhZGVXYXJuaW5nRGlhbG9nLnRzeCJdLCJuYW1lcyI6WyJSb29tVXBncmFkZVdhcm5pbmdEaWFsb2ciLCJSZWFjdCIsIkNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJwcm9ncmVzc1RleHQiLCJwcm9ncmVzcyIsInRvdGFsIiwic2V0U3RhdGUiLCJvcHRzIiwiY29udGludWUiLCJpbnZpdGUiLCJpc1ByaXZhdGUiLCJzdGF0ZSIsImludml0ZVVzZXJzVG9OZXdSb29tIiwiZG9VcGdyYWRlIiwib25Qcm9ncmVzc0NhbGxiYWNrIiwidGhlbiIsIm9uRmluaXNoZWQiLCJlIiwicHJldmVudERlZmF1bHQiLCJzdG9wUHJvcGFnYXRpb24iLCJNb2RhbCIsImNyZWF0ZVRyYWNrZWREaWFsb2ciLCJCdWdSZXBvcnREaWFsb2ciLCJyb29tIiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0IiwiZ2V0Um9vbSIsInJvb21JZCIsImpvaW5SdWxlcyIsImN1cnJlbnRTdGF0ZSIsImdldFN0YXRlRXZlbnRzIiwiRXZlbnRUeXBlIiwiUm9vbUpvaW5SdWxlcyIsImdldENvbnRlbnQiLCJKb2luUnVsZSIsIlB1YmxpYyIsImN1cnJlbnRWZXJzaW9uIiwiZ2V0VmVyc2lvbiIsInJlbmRlciIsImJyYW5kIiwiU2RrQ29uZmlnIiwiaW52aXRlVG9nZ2xlIiwib25JbnZpdGVVc2Vyc1RvZ2dsZSIsInRpdGxlIiwiYnVnUmVwb3J0cyIsImJ1Z19yZXBvcnRfZW5kcG9pbnRfdXJsIiwic3ViIiwib3BlbkJ1Z1JlcG9ydERpYWxvZyIsImZvb3RlciIsIm9uQ29udGludWUiLCJvbkNhbmNlbCIsImRlc2NyaXB0aW9uIiwiYiIsIm9sZFZlcnNpb24iLCJuZXdWZXJzaW9uIiwidGFyZ2V0VmVyc2lvbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFnQkE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FB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QUFILENBSFQ7QUFJTCxRQUFBLFFBQVEsRUFBRSxLQUFLQztBQUpWLFFBQVQ7QUFNSDs7QUFFRCx3QkFDSSw2QkFBQyxtQkFBRDtBQUNJLE1BQUEsU0FBUyxFQUFDLDZCQURkO0FBRUksTUFBQSxTQUFTLEVBQUUsSUFGZjtBQUdJLE1BQUEsVUFBVSxFQUFFLEtBSGhCO0FBSUksTUFBQSxVQUFVLEVBQUUsS0FBS2hELEtBQUwsQ0FBV2MsVUFKM0I7QUFLSSxNQUFBLEtBQUssRUFBRTJCO0FBTFgsb0JBT0ksdURBQ0ksd0NBQ00sS0FBS3pDLEtBQUwsQ0FBV2lELFdBQVgsSUFBMEIseUJBQ3hCLG1GQUNBLHdFQUZ3QixDQURoQyxDQURKLGVBT0ksd0NBQ00seUJBQ0UsdUVBQ0EsdURBRkYsRUFFMkQsRUFGM0QsRUFFK0Q7QUFDekRDLE1BQUFBLENBQUMsRUFBRU4sR0FBRyxpQkFBSSx3Q0FBS0EsR0FBTDtBQUQrQyxLQUYvRCxDQUROLENBUEosRUFlTUYsVUFmTixlQWdCSSx3Q0FDTSx5QkFDRSxpRUFERixFQUVFLEVBRkYsRUFHRTtBQUNJUyxNQUFBQSxVQUFVLEVBQUUsbUJBQU0sMkNBQVEsS0FBS2pCLGNBQWIsQ0FEdEI7QUFFSWtCLE1BQUFBLFVBQVUsRUFBRSxtQkFBTSwyQ0FBUSxLQUFLcEQsS0FBTCxDQUFXcUQsYUFBbkI7QUFGdEIsS0FIRixDQUROLENBaEJKLEVBMEJNZCxZQTFCTixDQVBKLEVBbUNNTyxNQW5DTixDQURKO0FBdUNIOztBQXJKaUYsQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxOSAtIDIwMjEgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QsIHsgUmVhY3ROb2RlIH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgRXZlbnRUeXBlIH0gZnJvbSAnbWF0cml4LWpzLXNkay9zcmMvQHR5cGVzL2V2ZW50JztcbmltcG9ydCB7IEpvaW5SdWxlIH0gZnJvbSAnbWF0cml4LWpzLXNkay9zcmMvQHR5cGVzL3BhcnRpYWxzJztcblxuaW1wb3J0IHsgX3QgfSBmcm9tIFwiLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyXCI7XG5pbXBvcnQgU2RrQ29uZmlnIGZyb20gXCIuLi8uLi8uLi9TZGtDb25maWdcIjtcbmltcG9ydCBMYWJlbGxlZFRvZ2dsZVN3aXRjaCBmcm9tIFwiLi4vZWxlbWVudHMvTGFiZWxsZWRUb2dnbGVTd2l0Y2hcIjtcbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gXCIuLi8uLi8uLi9NYXRyaXhDbGllbnRQZWdcIjtcbmltcG9ydCBNb2RhbCBmcm9tIFwiLi4vLi4vLi4vTW9kYWxcIjtcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5pbXBvcnQgeyBJRGlhbG9nUHJvcHMgfSBmcm9tIFwiLi9JRGlhbG9nUHJvcHNcIjtcbmltcG9ydCBCdWdSZXBvcnREaWFsb2cgZnJvbSAnLi9CdWdSZXBvcnREaWFsb2cnO1xuaW1wb3J0IEJhc2VEaWFsb2cgZnJvbSBcIi4vQmFzZURpYWxvZ1wiO1xuaW1wb3J0IERpYWxvZ0J1dHRvbnMgZnJvbSBcIi4uL2VsZW1lbnRzL0RpYWxvZ0J1dHRvbnNcIjtcbmltcG9ydCBQcm9ncmVzc0JhciBmcm9tIFwiLi4vZWxlbWVudHMvUHJvZ3Jlc3NCYXJcIjtcblxuZXhwb3J0IGludGVyZmFjZSBJRmluaXNoZWRPcHRzIHtcbiAgICBjb250aW51ZTogYm9vbGVhbjtcbiAgICBpbnZpdGU6IGJvb2xlYW47XG59XG5cbmludGVyZmFjZSBJUHJvcHMgZXh0ZW5kcyBJRGlhbG9nUHJvcHMge1xuICAgIHJvb21JZDogc3RyaW5nO1xuICAgIHRhcmdldFZlcnNpb246IHN0cmluZztcbiAgICBkZXNjcmlwdGlvbj86IFJlYWN0Tm9kZTtcbiAgICBkb1VwZ3JhZGU/KG9wdHM6IElGaW5pc2hlZE9wdHMsIGZuOiAocHJvZ3Jlc3NUZXh0OiBzdHJpbmcsIHByb2dyZXNzOiBudW1iZXIsIHRvdGFsOiBudW1iZXIpID0+IHZvaWQpOiBQcm9taXNlPHZvaWQ+O1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBpbnZpdGVVc2Vyc1RvTmV3Um9vbTogYm9vbGVhbjtcbiAgICBwcm9ncmVzc1RleHQ/OiBzdHJpbmc7XG4gICAgcHJvZ3Jlc3M/OiBudW1iZXI7XG4gICAgdG90YWw/OiBudW1iZXI7XG59XG5cbkByZXBsYWNlYWJsZUNvbXBvbmVudChcInZpZXdzLmRpYWxvZ3MuUm9vbVVwZ3JhZGVXYXJuaW5nRGlhbG9nXCIpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSb29tVXBncmFkZVdhcm5pbmdEaWFsb2cgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8SVByb3BzLCBJU3RhdGU+IHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGlzUHJpdmF0ZTogYm9vbGVhbjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGN1cnJlbnRWZXJzaW9uOiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG5cbiAgICAgICAgY29uc3Qgcm9vbSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRSb29tKHRoaXMucHJvcHMucm9vbUlkKTtcbiAgICAgICAgY29uc3Qgam9pblJ1bGVzID0gcm9vbT8uY3VycmVudFN0YXRlLmdldFN0YXRlRXZlbnRzKEV2ZW50VHlwZS5Sb29tSm9pblJ1bGVzLCBcIlwiKTtcbiAgICAgICAgdGhpcy5pc1ByaXZhdGUgPSBqb2luUnVsZXM/LmdldENvbnRlbnQoKVsnam9pbl9ydWxlJ10gIT09IEpvaW5SdWxlLlB1YmxpYyA/PyB0cnVlO1xuICAgICAgICB0aGlzLmN1cnJlbnRWZXJzaW9uID0gcm9vbT8uZ2V0VmVyc2lvbigpO1xuXG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICBpbnZpdGVVc2Vyc1RvTmV3Um9vbTogdHJ1ZSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uUHJvZ3Jlc3NDYWxsYmFjayA9IChwcm9ncmVzc1RleHQ6IHN0cmluZywgcHJvZ3Jlc3M6IG51bWJlciwgdG90YWw6IG51bWJlcik6IHZvaWQgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgcHJvZ3Jlc3NUZXh0LCBwcm9ncmVzcywgdG90YWwgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25Db250aW51ZSA9ICgpID0+IHtcbiAgICAgICAgY29uc3Qgb3B0cyA9IHtcbiAgICAgICAgICAgIGNvbnRpbnVlOiB0cnVlLFxuICAgICAgICAgICAgaW52aXRlOiB0aGlzLmlzUHJpdmF0ZSAmJiB0aGlzLnN0YXRlLmludml0ZVVzZXJzVG9OZXdSb29tLFxuICAgICAgICB9O1xuXG4gICAgICAgIGlmICh0aGlzLnByb3BzLmRvVXBncmFkZSkge1xuICAgICAgICAgICAgdGhpcy5wcm9wcy5kb1VwZ3JhZGUob3B0cywgdGhpcy5vblByb2dyZXNzQ2FsbGJhY2spLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMucHJvcHMub25GaW5pc2hlZChvcHRzKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5wcm9wcy5vbkZpbmlzaGVkKG9wdHMpO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25DYW5jZWwgPSAoKSA9PiB7XG4gICAgICAgIHRoaXMucHJvcHMub25GaW5pc2hlZCh7IGNvbnRpbnVlOiBmYWxzZSwgaW52aXRlOiBmYWxzZSB9KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkludml0ZVVzZXJzVG9nZ2xlID0gKGludml0ZVVzZXJzVG9OZXdSb29tOiBib29sZWFuKSA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBpbnZpdGVVc2Vyc1RvTmV3Um9vbSB9KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvcGVuQnVnUmVwb3J0RGlhbG9nID0gKGUpID0+IHtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xuXG4gICAgICAgIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coJ0J1ZyBSZXBvcnQgRGlhbG9nJywgJycsIEJ1Z1JlcG9ydERpYWxvZywge30pO1xuICAgIH07XG5cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIGNvbnN0IGJyYW5kID0gU2RrQ29uZmlnLmdldCgpLmJyYW5kO1xuXG4gICAgICAgIGxldCBpbnZpdGVUb2dnbGUgPSBudWxsO1xuICAgICAgICBpZiAodGhpcy5pc1ByaXZhdGUpIHtcbiAgICAgICAgICAgIGludml0ZVRvZ2dsZSA9IChcbiAgICAgICAgICAgICAgICA8TGFiZWxsZWRUb2dnbGVTd2l0Y2hcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU9e3RoaXMuc3RhdGUuaW52aXRlVXNlcnNUb05ld1Jvb219XG4gICAgICAgICAgICAgICAgICAgIG9uQ2hhbmdlPXt0aGlzLm9uSW52aXRlVXNlcnNUb2dnbGV9XG4gICAgICAgICAgICAgICAgICAgIGxhYmVsPXtfdChcIkF1dG9tYXRpY2FsbHkgaW52aXRlIG1lbWJlcnMgZnJvbSB0aGlzIHJvb20gdG8gdGhlIG5ldyBvbmVcIil9IC8+XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdGl0bGUgPSB0aGlzLmlzUHJpdmF0ZSA/IF90KFwiVXBncmFkZSBwcml2YXRlIHJvb21cIikgOiBfdChcIlVwZ3JhZGUgcHVibGljIHJvb21cIik7XG5cbiAgICAgICAgbGV0IGJ1Z1JlcG9ydHMgPSAoXG4gICAgICAgICAgICA8cD5cbiAgICAgICAgICAgICAgICB7IF90KFxuICAgICAgICAgICAgICAgICAgICBcIlRoaXMgdXN1YWxseSBvbmx5IGFmZmVjdHMgaG93IHRoZSByb29tIGlzIHByb2Nlc3NlZCBvbiB0aGUgc2VydmVyLiBJZiB5b3UncmUgXCIgK1xuICAgICAgICAgICAgICAgICAgICBcImhhdmluZyBwcm9ibGVtcyB3aXRoIHlvdXIgJShicmFuZClzLCBwbGVhc2UgcmVwb3J0IGEgYnVnLlwiLCB7IGJyYW5kIH0sXG4gICAgICAgICAgICAgICAgKSB9XG4gICAgICAgICAgICA8L3A+XG4gICAgICAgICk7XG4gICAgICAgIGlmIChTZGtDb25maWcuZ2V0KCkuYnVnX3JlcG9ydF9lbmRwb2ludF91cmwpIHtcbiAgICAgICAgICAgIGJ1Z1JlcG9ydHMgPSAoXG4gICAgICAgICAgICAgICAgPHA+XG4gICAgICAgICAgICAgICAgICAgIHsgX3QoXG4gICAgICAgICAgICAgICAgICAgICAgICBcIlRoaXMgdXN1YWxseSBvbmx5IGFmZmVjdHMgaG93IHRoZSByb29tIGlzIHByb2Nlc3NlZCBvbiB0aGUgc2VydmVyLiBJZiB5b3UncmUgXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJoYXZpbmcgcHJvYmxlbXMgd2l0aCB5b3VyICUoYnJhbmQpcywgcGxlYXNlIDxhPnJlcG9ydCBhIGJ1ZzwvYT4uXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJhbmQsXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiYVwiOiAoc3ViKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiA8YSBocmVmPScjJyBvbkNsaWNrPXt0aGlzLm9wZW5CdWdSZXBvcnREaWFsb2d9Pnsgc3ViIH08L2E+O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICApIH1cbiAgICAgICAgICAgICAgICA8L3A+XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGZvb3RlcjogSlNYLkVsZW1lbnQ7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnByb2dyZXNzVGV4dCkge1xuICAgICAgICAgICAgZm9vdGVyID0gPHNwYW4gY2xhc3NOYW1lPVwibXhfUm9vbVVwZ3JhZGVXYXJuaW5nRGlhbG9nX3Byb2dyZXNzXCI+XG4gICAgICAgICAgICAgICAgPFByb2dyZXNzQmFyIHZhbHVlPXt0aGlzLnN0YXRlLnByb2dyZXNzfSBtYXg9e3RoaXMuc3RhdGUudG90YWx9IC8+XG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9Sb29tVXBncmFkZVdhcm5pbmdEaWFsb2dfcHJvZ3Jlc3NUZXh0XCI+XG4gICAgICAgICAgICAgICAgICAgIHsgdGhpcy5zdGF0ZS5wcm9ncmVzc1RleHQgfVxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgPC9zcGFuPjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGZvb3RlciA9IDxEaWFsb2dCdXR0b25zXG4gICAgICAgICAgICAgICAgcHJpbWFyeUJ1dHRvbj17X3QoXCJVcGdyYWRlXCIpfVxuICAgICAgICAgICAgICAgIG9uUHJpbWFyeUJ1dHRvbkNsaWNrPXt0aGlzLm9uQ29udGludWV9XG4gICAgICAgICAgICAgICAgY2FuY2VsQnV0dG9uPXtfdChcIkNhbmNlbFwiKX1cbiAgICAgICAgICAgICAgICBvbkNhbmNlbD17dGhpcy5vbkNhbmNlbH1cbiAgICAgICAgICAgIC8+O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxCYXNlRGlhbG9nXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lPSdteF9Sb29tVXBncmFkZVdhcm5pbmdEaWFsb2cnXG4gICAgICAgICAgICAgICAgaGFzQ2FuY2VsPXt0cnVlfVxuICAgICAgICAgICAgICAgIGZpeGVkV2lkdGg9e2ZhbHNlfVxuICAgICAgICAgICAgICAgIG9uRmluaXNoZWQ9e3RoaXMucHJvcHMub25GaW5pc2hlZH1cbiAgICAgICAgICAgICAgICB0aXRsZT17dGl0bGV9XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgICAgICAgICAgPHA+XG4gICAgICAgICAgICAgICAgICAgICAgICB7IHRoaXMucHJvcHMuZGVzY3JpcHRpb24gfHwgX3QoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJVcGdyYWRpbmcgYSByb29tIGlzIGFuIGFkdmFuY2VkIGFjdGlvbiBhbmQgaXMgdXN1YWxseSByZWNvbW1lbmRlZCB3aGVuIGEgcm9vbSBcIiArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJpcyB1bnN0YWJsZSBkdWUgdG8gYnVncywgbWlzc2luZyBmZWF0dXJlcyBvciBzZWN1cml0eSB2dWxuZXJhYmlsaXRpZXMuXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICApIH1cbiAgICAgICAgICAgICAgICAgICAgPC9wPlxuICAgICAgICAgICAgICAgICAgICA8cD5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCI8Yj5QbGVhc2Ugbm90ZSB1cGdyYWRpbmcgd2lsbCBtYWtlIGEgbmV3IHZlcnNpb24gb2YgdGhlIHJvb208L2I+LiBcIiArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJBbGwgY3VycmVudCBtZXNzYWdlcyB3aWxsIHN0YXkgaW4gdGhpcyBhcmNoaXZlZCByb29tLlwiLCB7fSwge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiOiBzdWIgPT4gPGI+eyBzdWIgfTwvYj4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICkgfVxuICAgICAgICAgICAgICAgICAgICA8L3A+XG4gICAgICAgICAgICAgICAgICAgIHsgYnVnUmVwb3J0cyB9XG4gICAgICAgICAgICAgICAgICAgIDxwPlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIllvdSdsbCB1cGdyYWRlIHRoaXMgcm9vbSBmcm9tIDxvbGRWZXJzaW9uIC8+IHRvIDxuZXdWZXJzaW9uIC8+LlwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHt9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2xkVmVyc2lvbjogKCkgPT4gPGNvZGU+eyB0aGlzLmN1cnJlbnRWZXJzaW9uIH08L2NvZGU+LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdWZXJzaW9uOiAoKSA9PiA8Y29kZT57IHRoaXMucHJvcHMudGFyZ2V0VmVyc2lvbiB9PC9jb2RlPixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgKSB9XG4gICAgICAgICAgICAgICAgICAgIDwvcD5cbiAgICAgICAgICAgICAgICAgICAgeyBpbnZpdGVUb2dnbGUgfVxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgIHsgZm9vdGVyIH1cbiAgICAgICAgICAgIDwvQmFzZURpYWxvZz5cbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=