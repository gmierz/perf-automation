"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _BaseDialog = _interopRequireDefault(require("./BaseDialog"));

var _languageHandler = require("../../../languageHandler");

var _Field = _interopRequireDefault(require("../elements/Field"));

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _CommunityPrototypeStore = require("../../../stores/CommunityPrototypeStore");

var _FlairStore = _interopRequireDefault(require("../../../stores/FlairStore"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _Media = require("../../../customisations/Media");

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class;

let EditCommunityPrototypeDialog = ( // XXX: This is a lot of duplication from the create dialog, just in a different shape
_dec = (0, _replaceableComponent.replaceableComponent)("views.dialogs.EditCommunityPrototypeDialog"), _dec(_class = class EditCommunityPrototypeDialog extends _react.default.PureComponent {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "avatarUploadRef", /*#__PURE__*/_react.default.createRef());
    (0, _defineProperty2.default)(this, "onNameChange", ev => {
      this.setState({
        name: ev.target.value
      });
    });
    (0, _defineProperty2.default)(this, "onSubmit", async ev => {
      ev.preventDefault();
      ev.stopPropagation();
      if (this.state.busy) return; // We'll create the community now to see if it's taken, leaving it active in
      // the background for the user to look at while they invite people.

      this.setState({
        busy: true
      });

      try {
        let avatarUrl = this.state.currentAvatarUrl || ""; // must be a string for synapse to accept it

        if (this.state.avatarFile) {
          avatarUrl = await _MatrixClientPeg.MatrixClientPeg.get().uploadContent(this.state.avatarFile);
        }

        await _MatrixClientPeg.MatrixClientPeg.get().setGroupProfile(this.props.communityId, {
          name: this.state.name,
          avatar_url: avatarUrl
        }); // ask the flair store to update the profile too

        await _FlairStore.default.refreshGroupProfile(_MatrixClientPeg.MatrixClientPeg.get(), this.props.communityId); // we did it, so close the dialog

        this.props.onFinished(true);
      } catch (e) {
        _logger.logger.error(e);

        this.setState({
          busy: false,
          error: (0, _languageHandler._t)("There was an error updating your community. The server is unable to process your request.")
        });
      }
    });
    (0, _defineProperty2.default)(this, "onAvatarChanged", e => {
      if (!e.target.files || !e.target.files.length) {
        this.setState({
          avatarFile: null
        });
      } else {
        this.setState({
          busy: true
        });
        const file = e.target.files[0];
        const reader = new FileReader();

        reader.onload = ev => {
          this.setState({
            avatarFile: file,
            busy: false,
            avatarPreview: ev.target.result
          });
        };

        reader.readAsDataURL(file);
      }
    });
    (0, _defineProperty2.default)(this, "onChangeAvatar", () => {
      if (this.avatarUploadRef.current) this.avatarUploadRef.current.click();
    });

    const profile = _CommunityPrototypeStore.CommunityPrototypeStore.instance.getCommunityProfile(props.communityId);

    this.state = {
      name: (profile === null || profile === void 0 ? void 0 : profile.name) || "",
      error: null,
      busy: false,
      avatarFile: null,
      avatarPreview: null,
      currentAvatarUrl: profile === null || profile === void 0 ? void 0 : profile.avatarUrl
    };
  }

  render() {
    let preview = /*#__PURE__*/_react.default.createElement("img", {
      src: this.state.avatarPreview,
      className: "mx_EditCommunityPrototypeDialog_avatar"
    });

    if (!this.state.avatarPreview) {
      if (this.state.currentAvatarUrl) {
        const url = (0, _Media.mediaFromMxc)(this.state.currentAvatarUrl).srcHttp;
        preview = /*#__PURE__*/_react.default.createElement("img", {
          src: url,
          className: "mx_EditCommunityPrototypeDialog_avatar"
        });
      } else {
        preview = /*#__PURE__*/_react.default.createElement("div", {
          className: "mx_EditCommunityPrototypeDialog_placeholderAvatar"
        });
      }
    }

    return /*#__PURE__*/_react.default.createElement(_BaseDialog.default, {
      className: "mx_EditCommunityPrototypeDialog",
      onFinished: this.props.onFinished,
      title: (0, _languageHandler._t)("Update community")
    }, /*#__PURE__*/_react.default.createElement("form", {
      onSubmit: this.onSubmit
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_Dialog_content"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_EditCommunityPrototypeDialog_rowName"
    }, /*#__PURE__*/_react.default.createElement(_Field.default, {
      value: this.state.name,
      onChange: this.onNameChange,
      placeholder: (0, _languageHandler._t)("Enter name"),
      label: (0, _languageHandler._t)("Enter name")
    })), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_EditCommunityPrototypeDialog_rowAvatar"
    }, /*#__PURE__*/_react.default.createElement("input", {
      type: "file",
      style: {
        display: "none"
      },
      ref: this.avatarUploadRef,
      accept: "image/*",
      onChange: this.onAvatarChanged
    }), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      onClick: this.onChangeAvatar,
      className: "mx_EditCommunityPrototypeDialog_avatarContainer"
    }, preview), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_EditCommunityPrototypeDialog_tip"
    }, /*#__PURE__*/_react.default.createElement("b", null, (0, _languageHandler._t)("Add image (optional)")), /*#__PURE__*/_react.default.createElement("span", null, (0, _languageHandler._t)("An image will help people identify your community.")))), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      kind: "primary",
      onClick: this.onSubmit,
      disabled: this.state.busy
    }, (0, _languageHandler._t)("Save")))));
  }

}) || _class);
exports.default = EditCommunityPrototypeDialog;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvRWRpdENvbW11bml0eVByb3RvdHlwZURpYWxvZy50c3giXSwibmFtZXMiOlsiRWRpdENvbW11bml0eVByb3RvdHlwZURpYWxvZyIsIlJlYWN0IiwiUHVyZUNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJjcmVhdGVSZWYiLCJldiIsInNldFN0YXRlIiwibmFtZSIsInRhcmdldCIsInZhbHVlIiwicHJldmVudERlZmF1bHQiLCJzdG9wUHJvcGFnYXRpb24iLCJzdGF0ZSIsImJ1c3kiLCJhdmF0YXJVcmwiLCJjdXJyZW50QXZhdGFyVXJsIiwiYXZhdGFyRmlsZSIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsInVwbG9hZENvbnRlbnQiLCJzZXRHcm91cFByb2ZpbGUiLCJjb21tdW5pdHlJZCIsImF2YXRhcl91cmwiLCJGbGFpclN0b3JlIiwicmVmcmVzaEdyb3VwUHJvZmlsZSIsIm9uRmluaXNoZWQiLCJlIiwibG9nZ2VyIiwiZXJyb3IiLCJmaWxlcyIsImxlbmd0aCIsImZpbGUiLCJyZWFkZXIiLCJGaWxlUmVhZGVyIiwib25sb2FkIiwiYXZhdGFyUHJldmlldyIsInJlc3VsdCIsInJlYWRBc0RhdGFVUkwiLCJhdmF0YXJVcGxvYWRSZWYiLCJjdXJyZW50IiwiY2xpY2siLCJwcm9maWxlIiwiQ29tbXVuaXR5UHJvdG90eXBlU3RvcmUiLCJpbnN0YW5jZSIsImdldENvbW11bml0eVByb2ZpbGUiLCJyZW5kZXIiLCJwcmV2aWV3IiwidXJsIiwic3JjSHR0cCIsIm9uU3VibWl0Iiwib25OYW1lQ2hhbmdlIiwiZGlzcGxheSIsIm9uQXZhdGFyQ2hhbmdlZCIsIm9uQ2hhbmdlQXZhdGFyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWdCQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7OztJQWlCcUJBLDRCLEtB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QSxRQUFRLEVBQUUsS0FBS3JDLEtBQUwsQ0FBV0M7QUFBOUUsT0FDTSx5QkFBRyxNQUFILENBRE4sQ0E1QkosQ0FESixDQUxKLENBREo7QUEwQ0g7O0FBL0h5RixDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDIwIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0LCB7IENoYW5nZUV2ZW50IH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IEJhc2VEaWFsb2cgZnJvbSBcIi4vQmFzZURpYWxvZ1wiO1xuaW1wb3J0IHsgX3QgfSBmcm9tIFwiLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyXCI7XG5pbXBvcnQgeyBJRGlhbG9nUHJvcHMgfSBmcm9tIFwiLi9JRGlhbG9nUHJvcHNcIjtcbmltcG9ydCBGaWVsZCBmcm9tIFwiLi4vZWxlbWVudHMvRmllbGRcIjtcbmltcG9ydCBBY2Nlc3NpYmxlQnV0dG9uIGZyb20gXCIuLi9lbGVtZW50cy9BY2Nlc3NpYmxlQnV0dG9uXCI7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tIFwiLi4vLi4vLi4vTWF0cml4Q2xpZW50UGVnXCI7XG5pbXBvcnQgeyBDb21tdW5pdHlQcm90b3R5cGVTdG9yZSB9IGZyb20gXCIuLi8uLi8uLi9zdG9yZXMvQ29tbXVuaXR5UHJvdG90eXBlU3RvcmVcIjtcbmltcG9ydCBGbGFpclN0b3JlIGZyb20gXCIuLi8uLi8uLi9zdG9yZXMvRmxhaXJTdG9yZVwiO1xuaW1wb3J0IHsgcmVwbGFjZWFibGVDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvcmVwbGFjZWFibGVDb21wb25lbnRcIjtcbmltcG9ydCB7IG1lZGlhRnJvbU14YyB9IGZyb20gXCIuLi8uLi8uLi9jdXN0b21pc2F0aW9ucy9NZWRpYVwiO1xuXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbG9nZ2VyXCI7XG5cbmludGVyZmFjZSBJUHJvcHMgZXh0ZW5kcyBJRGlhbG9nUHJvcHMge1xuICAgIGNvbW11bml0eUlkOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBJU3RhdGUge1xuICAgIG5hbWU6IHN0cmluZztcbiAgICBlcnJvcjogc3RyaW5nO1xuICAgIGJ1c3k6IGJvb2xlYW47XG4gICAgY3VycmVudEF2YXRhclVybDogc3RyaW5nO1xuICAgIGF2YXRhckZpbGU6IEZpbGU7XG4gICAgYXZhdGFyUHJldmlldzogc3RyaW5nO1xufVxuXG4vLyBYWFg6IFRoaXMgaXMgYSBsb3Qgb2YgZHVwbGljYXRpb24gZnJvbSB0aGUgY3JlYXRlIGRpYWxvZywganVzdCBpbiBhIGRpZmZlcmVudCBzaGFwZVxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3MuZGlhbG9ncy5FZGl0Q29tbXVuaXR5UHJvdG90eXBlRGlhbG9nXCIpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBFZGl0Q29tbXVuaXR5UHJvdG90eXBlRGlhbG9nIGV4dGVuZHMgUmVhY3QuUHVyZUNvbXBvbmVudDxJUHJvcHMsIElTdGF0ZT4ge1xuICAgIHByaXZhdGUgYXZhdGFyVXBsb2FkUmVmOiBSZWFjdC5SZWZPYmplY3Q8SFRNTElucHV0RWxlbWVudD4gPSBSZWFjdC5jcmVhdGVSZWYoKTtcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBJUHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuXG4gICAgICAgIGNvbnN0IHByb2ZpbGUgPSBDb21tdW5pdHlQcm90b3R5cGVTdG9yZS5pbnN0YW5jZS5nZXRDb21tdW5pdHlQcm9maWxlKHByb3BzLmNvbW11bml0eUlkKTtcblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgbmFtZTogcHJvZmlsZT8ubmFtZSB8fCBcIlwiLFxuICAgICAgICAgICAgZXJyb3I6IG51bGwsXG4gICAgICAgICAgICBidXN5OiBmYWxzZSxcbiAgICAgICAgICAgIGF2YXRhckZpbGU6IG51bGwsXG4gICAgICAgICAgICBhdmF0YXJQcmV2aWV3OiBudWxsLFxuICAgICAgICAgICAgY3VycmVudEF2YXRhclVybDogcHJvZmlsZT8uYXZhdGFyVXJsLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgb25OYW1lQ2hhbmdlID0gKGV2OiBDaGFuZ2VFdmVudDxIVE1MSW5wdXRFbGVtZW50PikgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgbmFtZTogZXYudGFyZ2V0LnZhbHVlIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uU3VibWl0ID0gYXN5bmMgKGV2KSA9PiB7XG4gICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIGV2LnN0b3BQcm9wYWdhdGlvbigpO1xuXG4gICAgICAgIGlmICh0aGlzLnN0YXRlLmJ1c3kpIHJldHVybjtcblxuICAgICAgICAvLyBXZSdsbCBjcmVhdGUgdGhlIGNvbW11bml0eSBub3cgdG8gc2VlIGlmIGl0J3MgdGFrZW4sIGxlYXZpbmcgaXQgYWN0aXZlIGluXG4gICAgICAgIC8vIHRoZSBiYWNrZ3JvdW5kIGZvciB0aGUgdXNlciB0byBsb29rIGF0IHdoaWxlIHRoZXkgaW52aXRlIHBlb3BsZS5cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGJ1c3k6IHRydWUgfSk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBsZXQgYXZhdGFyVXJsID0gdGhpcy5zdGF0ZS5jdXJyZW50QXZhdGFyVXJsIHx8IFwiXCI7IC8vIG11c3QgYmUgYSBzdHJpbmcgZm9yIHN5bmFwc2UgdG8gYWNjZXB0IGl0XG4gICAgICAgICAgICBpZiAodGhpcy5zdGF0ZS5hdmF0YXJGaWxlKSB7XG4gICAgICAgICAgICAgICAgYXZhdGFyVXJsID0gYXdhaXQgTWF0cml4Q2xpZW50UGVnLmdldCgpLnVwbG9hZENvbnRlbnQodGhpcy5zdGF0ZS5hdmF0YXJGaWxlKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgYXdhaXQgTWF0cml4Q2xpZW50UGVnLmdldCgpLnNldEdyb3VwUHJvZmlsZSh0aGlzLnByb3BzLmNvbW11bml0eUlkLCB7XG4gICAgICAgICAgICAgICAgbmFtZTogdGhpcy5zdGF0ZS5uYW1lLFxuICAgICAgICAgICAgICAgIGF2YXRhcl91cmw6IGF2YXRhclVybCxcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAvLyBhc2sgdGhlIGZsYWlyIHN0b3JlIHRvIHVwZGF0ZSB0aGUgcHJvZmlsZSB0b29cbiAgICAgICAgICAgIGF3YWl0IEZsYWlyU3RvcmUucmVmcmVzaEdyb3VwUHJvZmlsZShNYXRyaXhDbGllbnRQZWcuZ2V0KCksIHRoaXMucHJvcHMuY29tbXVuaXR5SWQpO1xuXG4gICAgICAgICAgICAvLyB3ZSBkaWQgaXQsIHNvIGNsb3NlIHRoZSBkaWFsb2dcbiAgICAgICAgICAgIHRoaXMucHJvcHMub25GaW5pc2hlZCh0cnVlKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGUpO1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgYnVzeTogZmFsc2UsXG4gICAgICAgICAgICAgICAgZXJyb3I6IF90KFwiVGhlcmUgd2FzIGFuIGVycm9yIHVwZGF0aW5nIHlvdXIgY29tbXVuaXR5LiBUaGUgc2VydmVyIGlzIHVuYWJsZSB0byBwcm9jZXNzIHlvdXIgcmVxdWVzdC5cIiksXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwcml2YXRlIG9uQXZhdGFyQ2hhbmdlZCA9IChlOiBDaGFuZ2VFdmVudDxIVE1MSW5wdXRFbGVtZW50PikgPT4ge1xuICAgICAgICBpZiAoIWUudGFyZ2V0LmZpbGVzIHx8ICFlLnRhcmdldC5maWxlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBhdmF0YXJGaWxlOiBudWxsIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGJ1c3k6IHRydWUgfSk7XG4gICAgICAgICAgICBjb25zdCBmaWxlID0gZS50YXJnZXQuZmlsZXNbMF07XG4gICAgICAgICAgICBjb25zdCByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xuICAgICAgICAgICAgcmVhZGVyLm9ubG9hZCA9IChldjogUHJvZ3Jlc3NFdmVudDxGaWxlUmVhZGVyPikgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBhdmF0YXJGaWxlOiBmaWxlLCBidXN5OiBmYWxzZSwgYXZhdGFyUHJldmlldzogZXYudGFyZ2V0LnJlc3VsdCBhcyBzdHJpbmcgfSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcmVhZGVyLnJlYWRBc0RhdGFVUkwoZmlsZSk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkNoYW5nZUF2YXRhciA9ICgpID0+IHtcbiAgICAgICAgaWYgKHRoaXMuYXZhdGFyVXBsb2FkUmVmLmN1cnJlbnQpIHRoaXMuYXZhdGFyVXBsb2FkUmVmLmN1cnJlbnQuY2xpY2soKTtcbiAgICB9O1xuXG4gICAgcHVibGljIHJlbmRlcigpIHtcbiAgICAgICAgbGV0IHByZXZpZXcgPSA8aW1nIHNyYz17dGhpcy5zdGF0ZS5hdmF0YXJQcmV2aWV3fSBjbGFzc05hbWU9XCJteF9FZGl0Q29tbXVuaXR5UHJvdG90eXBlRGlhbG9nX2F2YXRhclwiIC8+O1xuICAgICAgICBpZiAoIXRoaXMuc3RhdGUuYXZhdGFyUHJldmlldykge1xuICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUuY3VycmVudEF2YXRhclVybCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHVybCA9IG1lZGlhRnJvbU14Yyh0aGlzLnN0YXRlLmN1cnJlbnRBdmF0YXJVcmwpLnNyY0h0dHA7XG4gICAgICAgICAgICAgICAgcHJldmlldyA9IDxpbWcgc3JjPXt1cmx9IGNsYXNzTmFtZT1cIm14X0VkaXRDb21tdW5pdHlQcm90b3R5cGVEaWFsb2dfYXZhdGFyXCIgLz47XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHByZXZpZXcgPSA8ZGl2IGNsYXNzTmFtZT1cIm14X0VkaXRDb21tdW5pdHlQcm90b3R5cGVEaWFsb2dfcGxhY2Vob2xkZXJBdmF0YXJcIiAvPjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8QmFzZURpYWxvZ1xuICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X0VkaXRDb21tdW5pdHlQcm90b3R5cGVEaWFsb2dcIlxuICAgICAgICAgICAgICAgIG9uRmluaXNoZWQ9e3RoaXMucHJvcHMub25GaW5pc2hlZH1cbiAgICAgICAgICAgICAgICB0aXRsZT17X3QoXCJVcGRhdGUgY29tbXVuaXR5XCIpfVxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgIDxmb3JtIG9uU3VibWl0PXt0aGlzLm9uU3VibWl0fT5cbiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9EaWFsb2dfY29udGVudFwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9FZGl0Q29tbXVuaXR5UHJvdG90eXBlRGlhbG9nX3Jvd05hbWVcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8RmllbGRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU9e3RoaXMuc3RhdGUubmFtZX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2U9e3RoaXMub25OYW1lQ2hhbmdlfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcj17X3QoXCJFbnRlciBuYW1lXCIpfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbD17X3QoXCJFbnRlciBuYW1lXCIpfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfRWRpdENvbW11bml0eVByb3RvdHlwZURpYWxvZ19yb3dBdmF0YXJcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8aW5wdXRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZT1cImZpbGVcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHlsZT17eyBkaXNwbGF5OiBcIm5vbmVcIiB9fVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWY9e3RoaXMuYXZhdGFyVXBsb2FkUmVmfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NlcHQ9XCJpbWFnZS8qXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2U9e3RoaXMub25BdmF0YXJDaGFuZ2VkfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b25cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5vbkNoYW5nZUF2YXRhcn1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfRWRpdENvbW11bml0eVByb3RvdHlwZURpYWxvZ19hdmF0YXJDb250YWluZXJcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgID57IHByZXZpZXcgfTwvQWNjZXNzaWJsZUJ1dHRvbj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0VkaXRDb21tdW5pdHlQcm90b3R5cGVEaWFsb2dfdGlwXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxiPnsgX3QoXCJBZGQgaW1hZ2UgKG9wdGlvbmFsKVwiKSB9PC9iPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3Bhbj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCJBbiBpbWFnZSB3aWxsIGhlbHAgcGVvcGxlIGlkZW50aWZ5IHlvdXIgY29tbXVuaXR5LlwiKSB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvc3Bhbj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b24ga2luZD1cInByaW1hcnlcIiBvbkNsaWNrPXt0aGlzLm9uU3VibWl0fSBkaXNhYmxlZD17dGhpcy5zdGF0ZS5idXN5fT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IF90KFwiU2F2ZVwiKSB9XG4gICAgICAgICAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgIDwvZm9ybT5cbiAgICAgICAgICAgIDwvQmFzZURpYWxvZz5cbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=