"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _PersistedElement = _interopRequireDefault(require("../elements/PersistedElement"));

var _QuestionDialog = _interopRequireDefault(require("./QuestionDialog"));

var _SdkConfig = _interopRequireDefault(require("../../../SdkConfig"));

var _classnames = _interopRequireDefault(require("classnames"));

var _languageHandler = require("../../../languageHandler");

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _HostSignupStore = require("../../../stores/HostSignupStore");

var _OwnProfileStore = require("../../../stores/OwnProfileStore");

var _HostSignupDialogTypes = require("./HostSignupDialogTypes");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class;

const HOST_SIGNUP_KEY = "host_signup";
let HostSignupDialog = (_dec = (0, _replaceableComponent.replaceableComponent)("views.dialogs.HostSignupDialog"), _dec(_class = class HostSignupDialog extends _react.default.PureComponent {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "iframeRef", /*#__PURE__*/_react.default.createRef());
    (0, _defineProperty2.default)(this, "config", void 0);
    (0, _defineProperty2.default)(this, "messageHandler", async message => {
      if (!this.config.url.startsWith(message.origin)) {
        return;
      }

      switch (message.data.action) {
        case _HostSignupDialogTypes.PostmessageAction.HostSignupAccountDetailsRequest:
          this.onAccountDetailsRequest();
          break;

        case _HostSignupDialogTypes.PostmessageAction.Maximize:
          this.setState({
            minimized: false
          });
          break;

        case _HostSignupDialogTypes.PostmessageAction.Minimize:
          this.setState({
            minimized: true
          });
          break;

        case _HostSignupDialogTypes.PostmessageAction.SetupComplete:
          this.setState({
            completed: true
          });
          break;

        case _HostSignupDialogTypes.PostmessageAction.CloseDialog:
          return this.closeDialog();
      }
    });
    (0, _defineProperty2.default)(this, "maximizeDialog", () => {
      this.setState({
        minimized: false
      }); // Send this action to the iframe so it can act accordingly

      this.sendMessage({
        action: _HostSignupDialogTypes.PostmessageAction.Maximize
      });
    });
    (0, _defineProperty2.default)(this, "minimizeDialog", () => {
      this.setState({
        minimized: true
      }); // Send this action to the iframe so it can act accordingly

      this.sendMessage({
        action: _HostSignupDialogTypes.PostmessageAction.Minimize
      });
    });
    (0, _defineProperty2.default)(this, "closeDialog", async () => {
      window.removeEventListener("message", this.messageHandler); // Ensure we destroy the host signup persisted element

      _PersistedElement.default.destroyElement("host_signup"); // Finally clear the flag in


      return _HostSignupStore.HostSignupStore.instance.setHostSignupActive(false);
    });
    (0, _defineProperty2.default)(this, "onCloseClick", async () => {
      if (this.state.completed) {
        // We're done, close
        return this.closeDialog();
      } else {
        _Modal.default.createDialog(_QuestionDialog.default, {
          title: (0, _languageHandler._t)("Confirm abort of host creation"),
          description: (0, _languageHandler._t)("Are you sure you wish to abort creation of the host? The process cannot be continued."),
          button: (0, _languageHandler._t)("Abort"),
          onFinished: result => {
            if (result) {
              return this.closeDialog();
            }
          }
        });
      }
    });
    (0, _defineProperty2.default)(this, "sendMessage", message => {
      this.iframeRef.current.contentWindow.postMessage(message, this.config.url);
    });
    (0, _defineProperty2.default)(this, "onAccountDetailsDialogFinished", async result => {
      if (result) {
        return this.sendAccountDetails();
      }

      return this.closeDialog();
    });
    (0, _defineProperty2.default)(this, "onAccountDetailsRequest", () => {
      const textComponent = /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Continuing temporarily allows the %(hostSignupBrand)s setup process to access your " + "account to fetch verified email addresses. This data is not stored.", {
        hostSignupBrand: this.config.brand
      })), /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Learn more in our <privacyPolicyLink />, <termsOfServiceLink /> and <cookiePolicyLink />.", {}, {
        cookiePolicyLink: () => /*#__PURE__*/_react.default.createElement("a", {
          href: this.config.cookiePolicyUrl,
          target: "_blank",
          rel: "noreferrer noopener"
        }, (0, _languageHandler._t)("Cookie Policy")),
        privacyPolicyLink: () => /*#__PURE__*/_react.default.createElement("a", {
          href: this.config.privacyPolicyUrl,
          target: "_blank",
          rel: "noreferrer noopener"
        }, (0, _languageHandler._t)("Privacy Policy")),
        termsOfServiceLink: () => /*#__PURE__*/_react.default.createElement("a", {
          href: this.config.termsOfServiceUrl,
          target: "_blank",
          rel: "noreferrer noopener"
        }, (0, _languageHandler._t)("Terms of Service"))
      })));

      _Modal.default.createDialog(_QuestionDialog.default, {
        title: (0, _languageHandler._t)("You should know"),
        description: textComponent,
        button: (0, _languageHandler._t)("Continue"),
        onFinished: this.onAccountDetailsDialogFinished
      });
    });
    this.state = {
      completed: false,
      error: null,
      minimized: false
    };
    this.config = _SdkConfig.default.get().hostSignup;
  }

  async sendAccountDetails() {
    const openIdToken = await _MatrixClientPeg.MatrixClientPeg.get().getOpenIdToken();

    if (!openIdToken || !openIdToken.access_token) {
      _logger.logger.warn("Failed to connect to homeserver for OpenID token.");

      this.setState({
        completed: true,
        error: (0, _languageHandler._t)("Failed to connect to your homeserver. Please close this dialog and try again.")
      });
      return;
    }

    this.sendMessage({
      action: _HostSignupDialogTypes.PostmessageAction.HostSignupAccountDetails,
      account: {
        accessToken: await _MatrixClientPeg.MatrixClientPeg.get().getAccessToken(),
        name: _OwnProfileStore.OwnProfileStore.instance.displayName,
        openIdToken: openIdToken.access_token,
        serverName: await _MatrixClientPeg.MatrixClientPeg.get().getDomain(),
        userLocalpart: await _MatrixClientPeg.MatrixClientPeg.get().getUserIdLocalpart(),
        termsAccepted: true
      }
    });
  }

  componentDidMount() {
    window.addEventListener("message", this.messageHandler);
  }

  componentWillUnmount() {
    if (_HostSignupStore.HostSignupStore.instance.isHostSignupActive) {
      // Run the close dialog actions if we're still active, otherwise good to go
      return this.closeDialog();
    }
  }

  render() {
    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_HostSignup_persisted"
    }, /*#__PURE__*/_react.default.createElement(_PersistedElement.default, {
      key: HOST_SIGNUP_KEY,
      persistKey: HOST_SIGNUP_KEY
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: (0, _classnames.default)({
        "mx_Dialog_wrapper": !this.state.minimized
      })
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: (0, _classnames.default)("mx_Dialog", {
        "mx_HostSignupDialog_minimized": this.state.minimized,
        "mx_HostSignupDialog": !this.state.minimized
      })
    }, this.state.minimized && /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_Dialog_header mx_Dialog_headerWithButton"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_Dialog_title"
    }, (0, _languageHandler._t)("%(hostSignupBrand)s Setup", {
      hostSignupBrand: this.config.brand
    })), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      className: "mx_HostSignup_maximize_button",
      onClick: this.maximizeDialog,
      "aria-label": (0, _languageHandler._t)("Maximise dialog"),
      title: (0, _languageHandler._t)("Maximise dialog")
    })), !this.state.minimized && /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_Dialog_header mx_Dialog_headerWithCancel"
    }, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      onClick: this.minimizeDialog,
      className: "mx_HostSignup_minimize_button",
      "aria-label": (0, _languageHandler._t)("Minimise dialog"),
      title: (0, _languageHandler._t)("Minimise dialog")
    }), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      onClick: this.onCloseClick,
      className: "mx_Dialog_cancelButton",
      "aria-label": (0, _languageHandler._t)("Close dialog"),
      title: (0, _languageHandler._t)("Close dialog")
    })), this.state.error && /*#__PURE__*/_react.default.createElement("div", null, this.state.error), !this.state.error && /*#__PURE__*/_react.default.createElement("iframe", {
      src: this.config.url,
      ref: this.iframeRef,
      sandbox: "allow-forms allow-scripts allow-same-origin allow-popups"
    })))));
  }

}) || _class);
exports.default = HostSignupDialog;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvSG9zdFNpZ251cERpYWxvZy50c3giXSwibmFtZXMiOlsiSE9TVF9TSUdOVVBfS0VZIiwiSG9zdFNpZ251cERpYWxvZyIsIlJlYWN0IiwiUHVyZUNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJjcmVhdGVSZWYiLCJtZXNzYWdlIiwiY29uZmlnIiwidXJsIiwic3RhcnRzV2l0aCIsIm9yaWdpbiIsImRhdGEiLCJhY3Rpb24iLCJQb3N0bWVzc2FnZUFjdGlvbiIsIkhvc3RTaWdudXBBY2NvdW50RGV0YWlsc1JlcXVlc3QiLCJvbkFjY291bnREZXRhaWxzUmVxdWVzdCIsIk1heGltaXplIiwic2V0U3RhdGUiLCJtaW5pbWl6ZWQiLCJNaW5pbWl6ZSIsIlNldHVwQ29tcGxldGUiLCJjb21wbGV0ZWQiLCJDbG9zZURpYWxvZyIsImNsb3NlRGlhbG9nIiwic2VuZE1lc3NhZ2UiLCJ3aW5kb3ciLCJyZW1vdmVFdmVudExpc3RlbmVyIiwibWVzc2FnZUhhbmRsZXIiLCJQZXJzaXN0ZWRFbGVtZW50IiwiZGVzdHJveUVsZW1lbnQiLCJIb3N0U2lnbnVwU3RvcmUiLCJpbnN0YW5jZSIsInNldEhvc3RTaWdudXBBY3RpdmUiLCJzdGF0ZSIsIk1vZGFsIiwiY3JlYXRlRGlhbG9nIiwiUXVlc3Rpb25EaWFsb2ciLCJ0aXRsZSIsImRlc2NyaXB0aW9uIiwiYnV0dG9uIiwib25GaW5pc2hlZCIsInJlc3VsdCIsImlmcmFtZVJlZiIsImN1cnJlbnQiLCJjb250ZW50V2luZG93IiwicG9zdE1lc3NhZ2UiLCJzZW5kQWNjb3VudERldGFpbHMiLCJ0ZXh0Q29tcG9uZW50IiwiaG9zdFNpZ251cEJyYW5kIiwiYnJhbmQiLCJjb29raWVQb2xpY3lMaW5rIiwiY29va2llUG9saWN5VXJsIiwicHJpdmFjeVBvbGljeUxpbmsiLCJwcml2YWN5UG9saWN5VXJsIiwidGVybXNPZlNlcnZpY2VMaW5rIiwidGVybXNPZlNlcnZpY2VVcmwiLCJvbkFjY291bnREZXRhaWxzRGlhbG9nRmluaXNoZWQiLCJlcnJvciIsIlNka0NvbmZpZyIsImdldCIsImhvc3RTaWdudXAiLCJvcGVuSWRUb2tlbiIsIk1hdHJpeENsaWVudFBlZyIsImdldE9wZW5JZFRva2VuIiwiYWNjZXNzX3Rva2VuIiwibG9nZ2VyIiwid2FybiIsIkhvc3RTaWdudXBBY2NvdW50RGV0YWlscyIsImFjY291bnQiLCJhY2Nlc3NUb2tlbiIsImdldEFjY2Vzc1Rva2VuIiwibmFtZSIsIk93blByb2ZpbGVTdG9yZSIsImRpc3BsYXlOYW1lIiwic2VydmVyTmFtZSIsImdldERvbWFpbiIsInVzZXJMb2NhbHBhcnQiLCJnZXRVc2VySWRMb2NhbHBhcnQiLCJ0ZXJtc0FjY2VwdGVkIiwiY29tcG9uZW50RGlkTW91bnQiLCJhZGRFdmVudExpc3RlbmVyIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJpc0hvc3RTaWdudXBBY3RpdmUiLCJyZW5kZXIiLCJtYXhpbWl6ZURpYWxvZyIsIm1pbmltaXplRGlhbG9nIiwib25DbG9zZUNsaWNrIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWdCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFNQTs7QUFFQTs7OztBQUVBLE1BQU1BLGVBQWUsR0FBRyxhQUF4QjtJQVdxQkMsZ0IsV0FEcEIsZ0RBQXFCLGdDQUFyQixDLGdCQUFELE1BQ3FCQSxnQkFEckIsU0FDOENDLGVBQU1DLGFBRHBELENBQ2tGO0FBSTlFQyxFQUFBQSxXQUFXLENBQUNDLEtBQUQsRUFBZ0I7QUFDdkIsVUFBTUEsS0FBTjtBQUR1QixrRUFINkJILGVBQU1JLFNBQU4sRUFHN0I7QUFBQTtBQUFBLDBEQVlGLE1BQU9DLE9BQVAsSUFBaUM7QUFDdEQsVUFBSSxDQUFDLEtBQUtDLE1BQUwsQ0FBWUMsR0FBWixDQUFnQkMsVUFBaEIsQ0FBMkJILE9BQU8sQ0FBQ0ksTUFB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Y0FBSCxDQUhoQjtBQUlJLE1BQUEsS0FBSyxFQUFFLHlCQUFHLGNBQUg7QUFKWCxNQVBKLENBeEJSLEVBdUNNLEtBQUtyRCxLQUFMLENBQVd3QixLQUFYLGlCQUNFLDBDQUNNLEtBQUt4QixLQUFMLENBQVd3QixLQURqQixDQXhDUixFQTRDTSxDQUFDLEtBQUt4QixLQUFMLENBQVd3QixLQUFaLGlCQUNFO0FBQ0ksTUFBQSxHQUFHLEVBQUUsS0FBS2xELE1BQUwsQ0FBWUMsR0FEckI7QUFFSSxNQUFBLEdBQUcsRUFBRSxLQUFLa0MsU0FGZDtBQUdJLE1BQUEsT0FBTyxFQUFDO0FBSFosTUE3Q1IsQ0FESixDQURKLENBREosQ0FESjtBQTRESDs7QUFyUDZFLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMjEgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSBcInJlYWN0XCI7XG5pbXBvcnQgQWNjZXNzaWJsZUJ1dHRvbiBmcm9tIFwiLi4vZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvblwiO1xuaW1wb3J0IE1vZGFsIGZyb20gXCIuLi8uLi8uLi9Nb2RhbFwiO1xuaW1wb3J0IFBlcnNpc3RlZEVsZW1lbnQgZnJvbSBcIi4uL2VsZW1lbnRzL1BlcnNpc3RlZEVsZW1lbnRcIjtcbmltcG9ydCBRdWVzdGlvbkRpYWxvZyBmcm9tICcuL1F1ZXN0aW9uRGlhbG9nJztcbmltcG9ydCBTZGtDb25maWcgZnJvbSBcIi4uLy4uLy4uL1Nka0NvbmZpZ1wiO1xuaW1wb3J0IGNsYXNzTmFtZXMgZnJvbSBcImNsYXNzbmFtZXNcIjtcbmltcG9ydCB7IF90IH0gZnJvbSBcIi4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlclwiO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSBcIi4uLy4uLy4uL01hdHJpeENsaWVudFBlZ1wiO1xuaW1wb3J0IHsgSG9zdFNpZ251cFN0b3JlIH0gZnJvbSBcIi4uLy4uLy4uL3N0b3Jlcy9Ib3N0U2lnbnVwU3RvcmVcIjtcbmltcG9ydCB7IE93blByb2ZpbGVTdG9yZSB9IGZyb20gXCIuLi8uLi8uLi9zdG9yZXMvT3duUHJvZmlsZVN0b3JlXCI7XG5pbXBvcnQge1xuICAgIElIb3N0U2lnbnVwQ29uZmlnLFxuICAgIElQb3N0bWVzc2FnZSxcbiAgICBJUG9zdG1lc3NhZ2VSZXNwb25zZURhdGEsXG4gICAgUG9zdG1lc3NhZ2VBY3Rpb24sXG59IGZyb20gXCIuL0hvc3RTaWdudXBEaWFsb2dUeXBlc1wiO1xuaW1wb3J0IHsgcmVwbGFjZWFibGVDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvcmVwbGFjZWFibGVDb21wb25lbnRcIjtcblxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2xvZ2dlclwiO1xuXG5jb25zdCBIT1NUX1NJR05VUF9LRVkgPSBcImhvc3Rfc2lnbnVwXCI7XG5cbmludGVyZmFjZSBJUHJvcHMge31cblxuaW50ZXJmYWNlIElTdGF0ZSB7XG4gICAgY29tcGxldGVkOiBib29sZWFuO1xuICAgIGVycm9yOiBzdHJpbmc7XG4gICAgbWluaW1pemVkOiBib29sZWFuO1xufVxuXG5AcmVwbGFjZWFibGVDb21wb25lbnQoXCJ2aWV3cy5kaWFsb2dzLkhvc3RTaWdudXBEaWFsb2dcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEhvc3RTaWdudXBEaWFsb2cgZXh0ZW5kcyBSZWFjdC5QdXJlQ29tcG9uZW50PElQcm9wcywgSVN0YXRlPiB7XG4gICAgcHJpdmF0ZSBpZnJhbWVSZWY6IFJlYWN0LlJlZk9iamVjdDxIVE1MSUZyYW1lRWxlbWVudD4gPSBSZWFjdC5jcmVhdGVSZWYoKTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbmZpZzogSUhvc3RTaWdudXBDb25maWc7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wczogSVByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgY29tcGxldGVkOiBmYWxzZSxcbiAgICAgICAgICAgIGVycm9yOiBudWxsLFxuICAgICAgICAgICAgbWluaW1pemVkOiBmYWxzZSxcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLmNvbmZpZyA9IFNka0NvbmZpZy5nZXQoKS5ob3N0U2lnbnVwO1xuICAgIH1cblxuICAgIHByaXZhdGUgbWVzc2FnZUhhbmRsZXIgPSBhc3luYyAobWVzc2FnZTogSVBvc3RtZXNzYWdlKSA9PiB7XG4gICAgICAgIGlmICghdGhpcy5jb25maWcudXJsLnN0YXJ0c1dpdGgobWVzc2FnZS5vcmlnaW4pKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgc3dpdGNoIChtZXNzYWdlLmRhdGEuYWN0aW9uKSB7XG4gICAgICAgICAgICBjYXNlIFBvc3RtZXNzYWdlQWN0aW9uLkhvc3RTaWdudXBBY2NvdW50RGV0YWlsc1JlcXVlc3Q6XG4gICAgICAgICAgICAgICAgdGhpcy5vbkFjY291bnREZXRhaWxzUmVxdWVzdCgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBQb3N0bWVzc2FnZUFjdGlvbi5NYXhpbWl6ZTpcbiAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICAgICAgbWluaW1pemVkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgUG9zdG1lc3NhZ2VBY3Rpb24uTWluaW1pemU6XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgICAgIG1pbmltaXplZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgUG9zdG1lc3NhZ2VBY3Rpb24uU2V0dXBDb21wbGV0ZTpcbiAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICAgICAgY29tcGxldGVkOiB0cnVlLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBQb3N0bWVzc2FnZUFjdGlvbi5DbG9zZURpYWxvZzpcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jbG9zZURpYWxvZygpO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIHByaXZhdGUgbWF4aW1pemVEaWFsb2cgPSAoKSA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgbWluaW1pemVkOiBmYWxzZSxcbiAgICAgICAgfSk7XG4gICAgICAgIC8vIFNlbmQgdGhpcyBhY3Rpb24gdG8gdGhlIGlmcmFtZSBzbyBpdCBjYW4gYWN0IGFjY29yZGluZ2x5XG4gICAgICAgIHRoaXMuc2VuZE1lc3NhZ2Uoe1xuICAgICAgICAgICAgYWN0aW9uOiBQb3N0bWVzc2FnZUFjdGlvbi5NYXhpbWl6ZSxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgbWluaW1pemVEaWFsb2cgPSAoKSA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgbWluaW1pemVkOiB0cnVlLFxuICAgICAgICB9KTtcbiAgICAgICAgLy8gU2VuZCB0aGlzIGFjdGlvbiB0byB0aGUgaWZyYW1lIHNvIGl0IGNhbiBhY3QgYWNjb3JkaW5nbHlcbiAgICAgICAgdGhpcy5zZW5kTWVzc2FnZSh7XG4gICAgICAgICAgICBhY3Rpb246IFBvc3RtZXNzYWdlQWN0aW9uLk1pbmltaXplLFxuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBjbG9zZURpYWxvZyA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJtZXNzYWdlXCIsIHRoaXMubWVzc2FnZUhhbmRsZXIpO1xuICAgICAgICAvLyBFbnN1cmUgd2UgZGVzdHJveSB0aGUgaG9zdCBzaWdudXAgcGVyc2lzdGVkIGVsZW1lbnRcbiAgICAgICAgUGVyc2lzdGVkRWxlbWVudC5kZXN0cm95RWxlbWVudChcImhvc3Rfc2lnbnVwXCIpO1xuICAgICAgICAvLyBGaW5hbGx5IGNsZWFyIHRoZSBmbGFnIGluXG4gICAgICAgIHJldHVybiBIb3N0U2lnbnVwU3RvcmUuaW5zdGFuY2Uuc2V0SG9zdFNpZ251cEFjdGl2ZShmYWxzZSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25DbG9zZUNsaWNrID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5jb21wbGV0ZWQpIHtcbiAgICAgICAgICAgIC8vIFdlJ3JlIGRvbmUsIGNsb3NlXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jbG9zZURpYWxvZygpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgTW9kYWwuY3JlYXRlRGlhbG9nKFxuICAgICAgICAgICAgICAgIFF1ZXN0aW9uRGlhbG9nLFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6IF90KFwiQ29uZmlybSBhYm9ydCBvZiBob3N0IGNyZWF0aW9uXCIpLFxuICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogX3QoXG4gICAgICAgICAgICAgICAgICAgICAgICBcIkFyZSB5b3Ugc3VyZSB5b3Ugd2lzaCB0byBhYm9ydCBjcmVhdGlvbiBvZiB0aGUgaG9zdD8gVGhlIHByb2Nlc3MgY2Fubm90IGJlIGNvbnRpbnVlZC5cIixcbiAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgYnV0dG9uOiBfdChcIkFib3J0XCIpLFxuICAgICAgICAgICAgICAgICAgICBvbkZpbmlzaGVkOiByZXN1bHQgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNsb3NlRGlhbG9nKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBzZW5kTWVzc2FnZSA9IChtZXNzYWdlOiBJUG9zdG1lc3NhZ2VSZXNwb25zZURhdGEpID0+IHtcbiAgICAgICAgdGhpcy5pZnJhbWVSZWYuY3VycmVudC5jb250ZW50V2luZG93LnBvc3RNZXNzYWdlKG1lc3NhZ2UsIHRoaXMuY29uZmlnLnVybCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgYXN5bmMgc2VuZEFjY291bnREZXRhaWxzKCkge1xuICAgICAgICBjb25zdCBvcGVuSWRUb2tlbiA9IGF3YWl0IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRPcGVuSWRUb2tlbigpO1xuICAgICAgICBpZiAoIW9wZW5JZFRva2VuIHx8ICFvcGVuSWRUb2tlbi5hY2Nlc3NfdG9rZW4pIHtcbiAgICAgICAgICAgIGxvZ2dlci53YXJuKFwiRmFpbGVkIHRvIGNvbm5lY3QgdG8gaG9tZXNlcnZlciBmb3IgT3BlbklEIHRva2VuLlwiKTtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgIGNvbXBsZXRlZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBlcnJvcjogX3QoXCJGYWlsZWQgdG8gY29ubmVjdCB0byB5b3VyIGhvbWVzZXJ2ZXIuIFBsZWFzZSBjbG9zZSB0aGlzIGRpYWxvZyBhbmQgdHJ5IGFnYWluLlwiKSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2VuZE1lc3NhZ2Uoe1xuICAgICAgICAgICAgYWN0aW9uOiBQb3N0bWVzc2FnZUFjdGlvbi5Ib3N0U2lnbnVwQWNjb3VudERldGFpbHMsXG4gICAgICAgICAgICBhY2NvdW50OiB7XG4gICAgICAgICAgICAgICAgYWNjZXNzVG9rZW46IGF3YWl0IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRBY2Nlc3NUb2tlbigpLFxuICAgICAgICAgICAgICAgIG5hbWU6IE93blByb2ZpbGVTdG9yZS5pbnN0YW5jZS5kaXNwbGF5TmFtZSxcbiAgICAgICAgICAgICAgICBvcGVuSWRUb2tlbjogb3BlbklkVG9rZW4uYWNjZXNzX3Rva2VuLFxuICAgICAgICAgICAgICAgIHNlcnZlck5hbWU6IGF3YWl0IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXREb21haW4oKSxcbiAgICAgICAgICAgICAgICB1c2VyTG9jYWxwYXJ0OiBhd2FpdCBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZ2V0VXNlcklkTG9jYWxwYXJ0KCksXG4gICAgICAgICAgICAgICAgdGVybXNBY2NlcHRlZDogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25BY2NvdW50RGV0YWlsc0RpYWxvZ0ZpbmlzaGVkID0gYXN5bmMgKHJlc3VsdCkgPT4ge1xuICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zZW5kQWNjb3VudERldGFpbHMoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5jbG9zZURpYWxvZygpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uQWNjb3VudERldGFpbHNSZXF1ZXN0ID0gKCkgPT4ge1xuICAgICAgICBjb25zdCB0ZXh0Q29tcG9uZW50ID0gKFxuICAgICAgICAgICAgPD5cbiAgICAgICAgICAgICAgICA8cD5cbiAgICAgICAgICAgICAgICAgICAgeyBfdChcIkNvbnRpbnVpbmcgdGVtcG9yYXJpbHkgYWxsb3dzIHRoZSAlKGhvc3RTaWdudXBCcmFuZClzIHNldHVwIHByb2Nlc3MgdG8gYWNjZXNzIHlvdXIgXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJhY2NvdW50IHRvIGZldGNoIHZlcmlmaWVkIGVtYWlsIGFkZHJlc3Nlcy4gVGhpcyBkYXRhIGlzIG5vdCBzdG9yZWQuXCIsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGhvc3RTaWdudXBCcmFuZDogdGhpcy5jb25maWcuYnJhbmQsXG4gICAgICAgICAgICAgICAgICAgIH0pIH1cbiAgICAgICAgICAgICAgICA8L3A+XG4gICAgICAgICAgICAgICAgPHA+XG4gICAgICAgICAgICAgICAgICAgIHsgX3QoXCJMZWFybiBtb3JlIGluIG91ciA8cHJpdmFjeVBvbGljeUxpbmsgLz4sIDx0ZXJtc09mU2VydmljZUxpbmsgLz4gYW5kIDxjb29raWVQb2xpY3lMaW5rIC8+LlwiLFxuICAgICAgICAgICAgICAgICAgICAgICAge30sXG4gICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29va2llUG9saWN5TGluazogKCkgPT4gKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8YSBocmVmPXt0aGlzLmNvbmZpZy5jb29raWVQb2xpY3lVcmx9IHRhcmdldD1cIl9ibGFua1wiIHJlbD1cIm5vcmVmZXJyZXIgbm9vcGVuZXJcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCJDb29raWUgUG9saWN5XCIpIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9hPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpdmFjeVBvbGljeUxpbms6ICgpID0+IChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGEgaHJlZj17dGhpcy5jb25maWcucHJpdmFjeVBvbGljeVVybH0gdGFyZ2V0PVwiX2JsYW5rXCIgcmVsPVwibm9yZWZlcnJlciBub29wZW5lclwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIlByaXZhY3kgUG9saWN5XCIpIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9hPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVybXNPZlNlcnZpY2VMaW5rOiAoKSA9PiAoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxhIGhyZWY9e3RoaXMuY29uZmlnLnRlcm1zT2ZTZXJ2aWNlVXJsfSB0YXJnZXQ9XCJfYmxhbmtcIiByZWw9XCJub3JlZmVycmVyIG5vb3BlbmVyXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IF90KFwiVGVybXMgb2YgU2VydmljZVwiKSB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvYT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgKSB9XG4gICAgICAgICAgICAgICAgPC9wPlxuICAgICAgICAgICAgPC8+XG4gICAgICAgICk7XG4gICAgICAgIE1vZGFsLmNyZWF0ZURpYWxvZyhcbiAgICAgICAgICAgIFF1ZXN0aW9uRGlhbG9nLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHRpdGxlOiBfdChcIllvdSBzaG91bGQga25vd1wiKSxcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogdGV4dENvbXBvbmVudCxcbiAgICAgICAgICAgICAgICBidXR0b246IF90KFwiQ29udGludWVcIiksXG4gICAgICAgICAgICAgICAgb25GaW5pc2hlZDogdGhpcy5vbkFjY291bnREZXRhaWxzRGlhbG9nRmluaXNoZWQsXG4gICAgICAgICAgICB9LFxuICAgICAgICApO1xuICAgIH07XG5cbiAgICBwdWJsaWMgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwibWVzc2FnZVwiLCB0aGlzLm1lc3NhZ2VIYW5kbGVyKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgICAgIGlmIChIb3N0U2lnbnVwU3RvcmUuaW5zdGFuY2UuaXNIb3N0U2lnbnVwQWN0aXZlKSB7XG4gICAgICAgICAgICAvLyBSdW4gdGhlIGNsb3NlIGRpYWxvZyBhY3Rpb25zIGlmIHdlJ3JlIHN0aWxsIGFjdGl2ZSwgb3RoZXJ3aXNlIGdvb2QgdG8gZ29cbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNsb3NlRGlhbG9nKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgcmVuZGVyKCk6IFJlYWN0LlJlYWN0Tm9kZSB7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0hvc3RTaWdudXBfcGVyc2lzdGVkXCI+XG4gICAgICAgICAgICAgICAgPFBlcnNpc3RlZEVsZW1lbnQga2V5PXtIT1NUX1NJR05VUF9LRVl9IHBlcnNpc3RLZXk9e0hPU1RfU0lHTlVQX0tFWX0+XG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPXtjbGFzc05hbWVzKHsgXCJteF9EaWFsb2dfd3JhcHBlclwiOiAhdGhpcy5zdGF0ZS5taW5pbWl6ZWQgfSl9PlxuICAgICAgICAgICAgICAgICAgICAgICAgPGRpdlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT17Y2xhc3NOYW1lcyhcIm14X0RpYWxvZ1wiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIm14X0hvc3RTaWdudXBEaWFsb2dfbWluaW1pemVkXCI6IHRoaXMuc3RhdGUubWluaW1pemVkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJteF9Ib3N0U2lnbnVwRGlhbG9nXCI6ICF0aGlzLnN0YXRlLm1pbmltaXplZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApfVxuICAgICAgICAgICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgdGhpcy5zdGF0ZS5taW5pbWl6ZWQgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9EaWFsb2dfaGVhZGVyIG14X0RpYWxvZ19oZWFkZXJXaXRoQnV0dG9uXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0RpYWxvZ190aXRsZVwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCIlKGhvc3RTaWdudXBCcmFuZClzIFNldHVwXCIsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaG9zdFNpZ251cEJyYW5kOiB0aGlzLmNvbmZpZy5icmFuZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfSG9zdFNpZ251cF9tYXhpbWl6ZV9idXR0b25cIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s9e3RoaXMubWF4aW1pemVEaWFsb2d9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJpYS1sYWJlbD17X3QoXCJNYXhpbWlzZSBkaWFsb2dcIil9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGU9e190KFwiTWF4aW1pc2UgZGlhbG9nXCIpfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgIXRoaXMuc3RhdGUubWluaW1pemVkICYmXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfRGlhbG9nX2hlYWRlciBteF9EaWFsb2dfaGVhZGVyV2l0aENhbmNlbFwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b25cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLm1pbmltaXplRGlhbG9nfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X0hvc3RTaWdudXBfbWluaW1pemVfYnV0dG9uXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmlhLWxhYmVsPXtfdChcIk1pbmltaXNlIGRpYWxvZ1wiKX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aXRsZT17X3QoXCJNaW5pbWlzZSBkaWFsb2dcIil9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b25cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLm9uQ2xvc2VDbGlja31cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9EaWFsb2dfY2FuY2VsQnV0dG9uXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmlhLWxhYmVsPXtfdChcIkNsb3NlIGRpYWxvZ1wiKX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aXRsZT17X3QoXCJDbG9zZSBkaWFsb2dcIil9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeyB0aGlzLnN0YXRlLmVycm9yICYmXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXY+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IHRoaXMuc3RhdGUuZXJyb3IgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeyAhdGhpcy5zdGF0ZS5lcnJvciAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8aWZyYW1lXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcmM9e3RoaXMuY29uZmlnLnVybH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZj17dGhpcy5pZnJhbWVSZWZ9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYW5kYm94PVwiYWxsb3ctZm9ybXMgYWxsb3ctc2NyaXB0cyBhbGxvdy1zYW1lLW9yaWdpbiBhbGxvdy1wb3B1cHNcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICA8L1BlcnNpc3RlZEVsZW1lbnQ+XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=