"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireWildcard(require("react"));

var _event = require("matrix-js-sdk/src/@types/event");

var _MatrixClientContext = _interopRequireDefault(require("../../../contexts/MatrixClientContext"));

var _RoomContext = _interopRequireDefault(require("../../../contexts/RoomContext"));

var _DMRoomMap = _interopRequireDefault(require("../../../utils/DMRoomMap"));

var _languageHandler = require("../../../languageHandler");

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _MiniAvatarUploader = _interopRequireWildcard(require("../elements/MiniAvatarUploader"));

var _RoomAvatar = _interopRequireDefault(require("../avatars/RoomAvatar"));

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var _actions = require("../../../dispatcher/actions");

var _SpaceStore = _interopRequireDefault(require("../../../stores/spaces/SpaceStore"));

var _space = require("../../../utils/space");

var _createRoom = require("../../../createRoom");

var _EventTileBubble = _interopRequireDefault(require("../messages/EventTileBubble"));

var _RoomSettingsDialog = require("../dialogs/RoomSettingsDialog");

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _UIComponents = require("../../../customisations/helpers/UIComponents");

var _UIFeature = require("../../../settings/UIFeature");

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/*
Copyright 2020, 2021 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
function hasExpectedEncryptionSettings(matrixClient, room) {
  const isEncrypted = matrixClient.isRoomEncrypted(room.roomId);
  const isPublic = room.getJoinRule() === "public";
  return isPublic || !(0, _createRoom.privateShouldBeEncrypted)() || isEncrypted;
}

const NewRoomIntro = () => {
  const cli = (0, _react.useContext)(_MatrixClientContext.default);
  const {
    room,
    roomId
  } = (0, _react.useContext)(_RoomContext.default);

  const dmPartner = _DMRoomMap.default.shared().getUserIdForRoomId(roomId);

  let body;

  if (dmPartner) {
    let caption;

    if (room.getJoinedMemberCount() + room.getInvitedMemberCount() === 2) {
      caption = (0, _languageHandler._t)("Only the two of you are in this conversation, unless either of you invites anyone to join.");
    }

    const member = room === null || room === void 0 ? void 0 : room.getMember(dmPartner);
    const displayName = (member === null || member === void 0 ? void 0 : member.rawDisplayName) || dmPartner;
    body = /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement(_RoomAvatar.default, {
      room: room,
      width: _MiniAvatarUploader.AVATAR_SIZE,
      height: _MiniAvatarUploader.AVATAR_SIZE,
      onClick: () => {
        _dispatcher.default.dispatch({
          action: _actions.Action.ViewUser,
          // XXX: We should be using a real member object and not assuming what the receiver wants.
          member: member || {
            userId: dmPartner
          }
        });
      }
    }), /*#__PURE__*/_react.default.createElement("h2", null, room.name), /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("This is the beginning of your direct message history with <displayName/>.", {}, {
      displayName: () => /*#__PURE__*/_react.default.createElement("b", null, displayName)
    })), caption && /*#__PURE__*/_react.default.createElement("p", null, caption));
  } else {
    var _room$currentState$ge, _room$currentState$ge2, _room$currentState$ge3, _room$getMember, _SpaceStore$instance$, _room$currentState$ge4, _room$currentState$ge5;

    const inRoom = room && room.getMyMembership() === "join";
    const topic = (_room$currentState$ge = room.currentState.getStateEvents(_event.EventType.RoomTopic, "")) === null || _room$currentState$ge === void 0 ? void 0 : (_room$currentState$ge2 = _room$currentState$ge.getContent()) === null || _room$currentState$ge2 === void 0 ? void 0 : _room$currentState$ge2.topic;
    const canAddTopic = inRoom && room.currentState.maySendStateEvent(_event.EventType.RoomTopic, cli.getUserId());

    const onTopicClick = () => {
      _dispatcher.default.dispatch({
        action: "open_room_settings",
        room_id: roomId
      }, true); // focus the topic field to help the user find it as it'll gain an outline


      setImmediate(() => {
        window.document.getElementById("profileTopic").focus();
      });
    };

    let topicText;

    if (canAddTopic && topic) {
      topicText = (0, _languageHandler._t)("Topic: %(topic)s (<a>edit</a>)", {
        topic
      }, {
        a: sub => /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
          kind: "link",
          onClick: onTopicClick
        }, sub)
      });
    } else if (topic) {
      topicText = (0, _languageHandler._t)("Topic: %(topic)s ", {
        topic
      });
    } else if (canAddTopic) {
      topicText = (0, _languageHandler._t)("<a>Add a topic</a> to help people know what it is about.", {}, {
        a: sub => /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
          kind: "link",
          element: "span",
          onClick: onTopicClick
        }, sub)
      });
    }

    const creator = (_room$currentState$ge3 = room.currentState.getStateEvents(_event.EventType.RoomCreate, "")) === null || _room$currentState$ge3 === void 0 ? void 0 : _room$currentState$ge3.getSender();
    const creatorName = (room === null || room === void 0 ? void 0 : (_room$getMember = room.getMember(creator)) === null || _room$getMember === void 0 ? void 0 : _room$getMember.rawDisplayName) || creator;
    let createdText;

    if (creator === cli.getUserId()) {
      createdText = (0, _languageHandler._t)("You created this room.");
    } else {
      createdText = (0, _languageHandler._t)("%(displayName)s created this room.", {
        displayName: creatorName
      });
    }

    let parentSpace;

    if ((_SpaceStore$instance$ = _SpaceStore.default.instance.activeSpaceRoom) !== null && _SpaceStore$instance$ !== void 0 && _SpaceStore$instance$.canInvite(cli.getUserId()) && _SpaceStore.default.instance.getSpaceFilteredRoomIds(_SpaceStore.default.instance.activeSpace).has(room.roomId)) {
      parentSpace = _SpaceStore.default.instance.activeSpaceRoom;
    }

    let buttons;

    if (parentSpace) {
      buttons = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_NewRoomIntro_buttons"
      }, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        className: "mx_NewRoomIntro_inviteButton",
        kind: "primary",
        onClick: () => {
          (0, _space.showSpaceInvite)(parentSpace);
        }
      }, (0, _languageHandler._t)("Invite to %(spaceName)s", {
        spaceName: parentSpace.name
      })), room.canInvite(cli.getUserId()) && /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        className: "mx_NewRoomIntro_inviteButton",
        kind: "primary_outline",
        onClick: () => {
          _dispatcher.default.dispatch({
            action: "view_invite",
            roomId
          });
        }
      }, (0, _languageHandler._t)("Invite to just this room")));
    } else if (room.canInvite(cli.getUserId()) && (0, _UIComponents.shouldShowComponent)(_UIFeature.UIComponent.InviteUsers)) {
      buttons = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_NewRoomIntro_buttons"
      }, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        className: "mx_NewRoomIntro_inviteButton",
        kind: "primary",
        onClick: () => {
          _dispatcher.default.dispatch({
            action: "view_invite",
            roomId
          });
        }
      }, (0, _languageHandler._t)("Invite to this room")));
    }

    const avatarUrl = (_room$currentState$ge4 = room.currentState.getStateEvents(_event.EventType.RoomAvatar, "")) === null || _room$currentState$ge4 === void 0 ? void 0 : (_room$currentState$ge5 = _room$currentState$ge4.getContent()) === null || _room$currentState$ge5 === void 0 ? void 0 : _room$currentState$ge5.url;
    body = /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement(_MiniAvatarUploader.default, {
      hasAvatar: !!avatarUrl,
      noAvatarLabel: (0, _languageHandler._t)("Add a photo, so people can easily spot your room."),
      setAvatarUrl: url => cli.sendStateEvent(roomId, _event.EventType.RoomAvatar, {
        url
      }, '')
    }, /*#__PURE__*/_react.default.createElement(_RoomAvatar.default, {
      room: room,
      width: _MiniAvatarUploader.AVATAR_SIZE,
      height: _MiniAvatarUploader.AVATAR_SIZE
    })), /*#__PURE__*/_react.default.createElement("h2", null, room.name), /*#__PURE__*/_react.default.createElement("p", null, createdText, " ", (0, _languageHandler._t)("This is the start of <roomName/>.", {}, {
      roomName: () => /*#__PURE__*/_react.default.createElement("b", null, room.name)
    })), /*#__PURE__*/_react.default.createElement("p", null, topicText), buttons);
  }

  function openRoomSettings(event) {
    event.preventDefault();

    _dispatcher.default.dispatch({
      action: "open_room_settings",
      initial_tab_id: _RoomSettingsDialog.ROOM_SECURITY_TAB
    });
  }

  const subText = (0, _languageHandler._t)("Your private messages are normally encrypted, but this room isn't. " + "Usually this is due to an unsupported device or method being used, " + "like email invites.");
  let subButton;

  if (room.currentState.mayClientSendStateEvent(_event.EventType.RoomEncryption, _MatrixClientPeg.MatrixClientPeg.get())) {
    subButton = /*#__PURE__*/_react.default.createElement("a", {
      onClick: openRoomSettings,
      href: "#"
    }, " ", (0, _languageHandler._t)("Enable encryption in settings."));
  }

  const subtitle = /*#__PURE__*/_react.default.createElement("span", null, " ", subText, " ", subButton, " ");

  return /*#__PURE__*/_react.default.createElement("div", {
    className: "mx_NewRoomIntro"
  }, !hasExpectedEncryptionSettings(cli, room) && /*#__PURE__*/_react.default.createElement(_EventTileBubble.default, {
    className: "mx_cryptoEvent mx_cryptoEvent_icon_warning",
    title: (0, _languageHandler._t)("End-to-end encryption isn't enabled"),
    subtitle: subtitle
  }), body);
};

var _default = NewRoomIntro;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3Jvb21zL05ld1Jvb21JbnRyby50c3giXSwibmFtZXMiOlsiaGFzRXhwZWN0ZWRFbmNyeXB0aW9uU2V0dGluZ3MiLCJtYXRyaXhDbGllbnQiLCJyb29tIiwiaXNFbmNyeXB0ZWQiLCJpc1Jvb21FbmNyeXB0ZWQiLCJyb29tSWQiLCJpc1B1YmxpYyIsImdldEpvaW5SdWxlIiwiTmV3Um9vbUludHJvIiwiY2xpIiwiTWF0cml4Q2xpZW50Q29udGV4dCIsIlJvb21Db250ZXh0IiwiZG1QYXJ0bmVyIiwiRE1Sb29tTWFwIiwic2hhcmVkIiwiZ2V0VXNlcklkRm9yUm9vbUlkIiwiYm9keSIsImNhcHRpb24iLCJnZXRKb2luZWRNZW1iZXJDb3VudCIsImdldEludml0ZWRNZW1iZXJDb3VudCIsIm1lbWJlciIsImdldE1lbWJlciIsImRpc3BsYXlOYW1lIiwicmF3RGlzcGxheU5hbWUiLCJBVkFUQVJfU0laRSIsImRlZmF1bHREaXNwYXRjaGVyIiwiZGlzcGF0Y2giLCJhY3Rpb24iLCJBY3Rpb24iLCJWaWV3VXNlciIsInVzZXJJZCIsIm5hbWUiLCJpblJvb20iLCJnZXRNeU1lbWJlcnNoaXAiLCJ0b3BpYyIsImN1cnJlbnRTdGF0ZSIsImdldFN0YXRlRXZlbnRzIiwiRXZlbnRUeXBlIiwiUm9vbVRvcGljIiwiZ2V0Q29udGVudCIsImNhbkFkZFRvcGljIiwibWF5U2VuZFN0YXRlRXZlbnQiLCJnZXRVc2VySWQiLCJvblRvcGljQ2xpY2siLCJkaXMiLCJyb29tX2lkIiwic2V0SW1tZWRpYXRlIiwid2luZG93IiwiZG9jdW1lbnQiLCJnZXRFbGVtZW50QnlJZCIsImZvY3VzIiwidG9waWNUZXh0IiwiYSIsInN1YiIsImNyZWF0b3IiLCJSb29tQ3JlYXRlIiwiZ2V0U2VuZGVyIiwiY3JlYXRvck5hbWUiLCJjcmVhdGVkVGV4dCIsInBhcmVudFNwYWNlIiwiaW5zdGFuY2UiLCJhY3RpdmVTcGFjZVJvb20iLCJjYW5JbnZpdGUiLCJTcGFjZVN0b3JlIiwiZ2V0U3BhY2VGaWx0ZXJlZFJvb21JZHMiLCJhY3RpdmVTcGFjZSIsImhhcyIsImJ1dHRvbnMiLCJzcGFjZU5hbWUiLCJVSUNvbXBvbmVudCIsIkludml0ZVVzZXJzIiwiYXZhdGFyVXJsIiwiUm9vbUF2YXRhciIsInVybCIsInNlbmRTdGF0ZUV2ZW50Iiwicm9vbU5hbWUiLCJvcGVuUm9vbVNldHRpbmdzIiwiZXZlbnQiLCJwcmV2ZW50RGVmYXVsdCIsImluaXRpYWxfdGFiX2lkIiwiUk9PTV9TRUNVUklUWV9UQUIiLCJzdWJUZXh0Iiwic3ViQnV0dG9uIiwibWF5Q2xpZW50U2VuZFN0YXRlRXZlbnQiLCJSb29tRW5jcnlwdGlvbiIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsInN1YnRpdGxlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFnQkE7O0FBQ0E7O0FBS0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQXhDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUE0QkEsU0FBU0EsNkJBQVQsQ0FBdUNDLFlBQXZDLEVBQW1FQyxJQUFuRSxFQUF3RjtBQUNwRixRQUFNQyxXQUFvQixHQUFHRixZQUFZLENBQUNHLGVBQWIsQ0FBNkJGLElBQUksQ0FBQ0csTUFBbEMsQ0FBN0I7QUFDQSxRQUFNQyxRQUFpQixHQUFHSixJQUFJLENBQUNLLFdBQUwsT0FBdUIsUUFBakQ7QUFDQSxTQUFPRCxRQUFRLElBQUksQ0FBQywyQ0FBYixJQUEyQ0gsV0FBbEQ7QUFDSDs7QUFFRCxNQUFNSyxZQUFZLEdBQUcsTUFBTTtBQUN2QixRQUFNQyxHQUFHLEdBQUcsdUJBQVdDLDRCQUFYLENBQVo7QUFDQSxRQUFNO0FBQUVSLElBQUFBLElBQUY7QUFBUUcsSUFB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S0FBNUMsQ0FBckIsQ0FYRyxlQWNILHdDQUFLb0IsU0FBTCxDQWRHLEVBZURnQixPQWZDLENBQVA7QUFpQkg7O0FBRUQsV0FBU1MsZ0JBQVQsQ0FBMEJDLEtBQTFCLEVBQWlDO0FBQzdCQSxJQUFBQSxLQUFLLENBQUNDLGNBQU47O0FBQ0FsQyx3QkFBSWxCLFFBQUosQ0FBYTtBQUNUQyxNQUFBQSxNQUFNLEVBQUUsb0JBREM7QUFFVG9ELE1BQUFBLGNBQWMsRUFBRUM7QUFGUCxLQUFiO0FBSUg7O0FBRUQsUUFBTUMsT0FBTyxHQUFHLHlCQUNaLHdFQUNBLHFFQURBLEdBRUEscUJBSFksQ0FBaEI7QUFNQSxNQUFJQyxTQUFKOztBQUNBLE1BQUloRixJQUFJLENBQUNpQyxZQUFMLENBQWtCZ0QsdUJBQWxCLENBQTBDOUMsaUJBQVUrQyxjQUFwRCxFQUFvRUMsaUNBQWdCQyxHQUFoQixFQUFwRSxDQUFKLEVBQWdHO0FBQzVGSixJQUFBQSxTQUFTLGdCQUNMO0FBQUcsTUFBQSxPQUFPLEVBQUVOLGdCQUFaO0FBQThCLE1BQUEsSUFBSSxFQUFDO0FBQW5DLFlBQTBDLHlCQUFHLGdDQUFILENBQTFDLENBREo7QUFHSDs7QUFFRCxRQUFNVyxRQUFRLGdCQUNWLGdEQUFTTixPQUFULE9BQXFCQyxTQUFyQixNQURKOztBQUlBLHNCQUFPO0FBQUssSUFBQSxTQUFTLEVBQUM7QUFBZixLQUVELENBQUNsRiw2QkFBNkIsQ0FBQ1MsR0FBRCxFQUFNUCxJQUFOLENBQTlCLGlCQUNFLDZCQUFDLHdCQUFEO0FBQ0ksSUFBQSxTQUFTLEVBQUMsNENBRGQ7QUFFSSxJQUFBLEtBQUssRUFBRSx5QkFBRyxxQ0FBSCxDQUZYO0FBR0ksSUFBQSxRQUFRLEVBQUVxRjtBQUhkLElBSEQsRUFVRHZFLElBVkMsQ0FBUDtBQVlILENBckxEOztlQXVMZVIsWSIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAyMCwgMjAyMSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCwgeyB1c2VDb250ZXh0IH0gZnJvbSBcInJlYWN0XCI7XG5pbXBvcnQgeyBFdmVudFR5cGUgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvQHR5cGVzL2V2ZW50XCI7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnQgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvY2xpZW50XCI7XG5pbXBvcnQgeyBSb29tIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yb29tXCI7XG5pbXBvcnQgeyBVc2VyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy91c2VyXCI7XG5cbmltcG9ydCBNYXRyaXhDbGllbnRDb250ZXh0IGZyb20gXCIuLi8uLi8uLi9jb250ZXh0cy9NYXRyaXhDbGllbnRDb250ZXh0XCI7XG5pbXBvcnQgUm9vbUNvbnRleHQgZnJvbSBcIi4uLy4uLy4uL2NvbnRleHRzL1Jvb21Db250ZXh0XCI7XG5pbXBvcnQgRE1Sb29tTWFwIGZyb20gXCIuLi8uLi8uLi91dGlscy9ETVJvb21NYXBcIjtcbmltcG9ydCB7IF90IH0gZnJvbSBcIi4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlclwiO1xuaW1wb3J0IEFjY2Vzc2libGVCdXR0b24gZnJvbSBcIi4uL2VsZW1lbnRzL0FjY2Vzc2libGVCdXR0b25cIjtcbmltcG9ydCBNaW5pQXZhdGFyVXBsb2FkZXIsIHsgQVZBVEFSX1NJWkUgfSBmcm9tIFwiLi4vZWxlbWVudHMvTWluaUF2YXRhclVwbG9hZGVyXCI7XG5pbXBvcnQgUm9vbUF2YXRhciBmcm9tIFwiLi4vYXZhdGFycy9Sb29tQXZhdGFyXCI7XG5pbXBvcnQgZGVmYXVsdERpc3BhdGNoZXIgZnJvbSBcIi4uLy4uLy4uL2Rpc3BhdGNoZXIvZGlzcGF0Y2hlclwiO1xuaW1wb3J0IGRpcyBmcm9tIFwiLi4vLi4vLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyXCI7XG5pbXBvcnQgeyBWaWV3VXNlclBheWxvYWQgfSBmcm9tIFwiLi4vLi4vLi4vZGlzcGF0Y2hlci9wYXlsb2Fkcy9WaWV3VXNlclBheWxvYWRcIjtcbmltcG9ydCB7IEFjdGlvbiB9IGZyb20gXCIuLi8uLi8uLi9kaXNwYXRjaGVyL2FjdGlvbnNcIjtcbmltcG9ydCBTcGFjZVN0b3JlIGZyb20gXCIuLi8uLi8uLi9zdG9yZXMvc3BhY2VzL1NwYWNlU3RvcmVcIjtcbmltcG9ydCB7IHNob3dTcGFjZUludml0ZSB9IGZyb20gXCIuLi8uLi8uLi91dGlscy9zcGFjZVwiO1xuaW1wb3J0IHsgcHJpdmF0ZVNob3VsZEJlRW5jcnlwdGVkIH0gZnJvbSBcIi4uLy4uLy4uL2NyZWF0ZVJvb21cIjtcbmltcG9ydCBFdmVudFRpbGVCdWJibGUgZnJvbSBcIi4uL21lc3NhZ2VzL0V2ZW50VGlsZUJ1YmJsZVwiO1xuaW1wb3J0IHsgUk9PTV9TRUNVUklUWV9UQUIgfSBmcm9tIFwiLi4vZGlhbG9ncy9Sb29tU2V0dGluZ3NEaWFsb2dcIjtcbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gXCIuLi8uLi8uLi9NYXRyaXhDbGllbnRQZWdcIjtcbmltcG9ydCB7IHNob3VsZFNob3dDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vY3VzdG9taXNhdGlvbnMvaGVscGVycy9VSUNvbXBvbmVudHNcIjtcbmltcG9ydCB7IFVJQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uL3NldHRpbmdzL1VJRmVhdHVyZVwiO1xuXG5mdW5jdGlvbiBoYXNFeHBlY3RlZEVuY3J5cHRpb25TZXR0aW5ncyhtYXRyaXhDbGllbnQ6IE1hdHJpeENsaWVudCwgcm9vbTogUm9vbSk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGlzRW5jcnlwdGVkOiBib29sZWFuID0gbWF0cml4Q2xpZW50LmlzUm9vbUVuY3J5cHRlZChyb29tLnJvb21JZCk7XG4gICAgY29uc3QgaXNQdWJsaWM6IGJvb2xlYW4gPSByb29tLmdldEpvaW5SdWxlKCkgPT09IFwicHVibGljXCI7XG4gICAgcmV0dXJuIGlzUHVibGljIHx8ICFwcml2YXRlU2hvdWxkQmVFbmNyeXB0ZWQoKSB8fCBpc0VuY3J5cHRlZDtcbn1cblxuY29uc3QgTmV3Um9vbUludHJvID0gKCkgPT4ge1xuICAgIGNvbnN0IGNsaSA9IHVzZUNvbnRleHQoTWF0cml4Q2xpZW50Q29udGV4dCk7XG4gICAgY29uc3QgeyByb29tLCByb29tSWQgfSA9IHVzZUNvbnRleHQoUm9vbUNvbnRleHQpO1xuXG4gICAgY29uc3QgZG1QYXJ0bmVyID0gRE1Sb29tTWFwLnNoYXJlZCgpLmdldFVzZXJJZEZvclJvb21JZChyb29tSWQpO1xuICAgIGxldCBib2R5O1xuICAgIGlmIChkbVBhcnRuZXIpIHtcbiAgICAgICAgbGV0IGNhcHRpb247XG4gICAgICAgIGlmICgocm9vbS5nZXRKb2luZWRNZW1iZXJDb3VudCgpICsgcm9vbS5nZXRJbnZpdGVkTWVtYmVyQ291bnQoKSkgPT09IDIpIHtcbiAgICAgICAgICAgIGNhcHRpb24gPSBfdChcIk9ubHkgdGhlIHR3byBvZiB5b3UgYXJlIGluIHRoaXMgY29udmVyc2F0aW9uLCB1bmxlc3MgZWl0aGVyIG9mIHlvdSBpbnZpdGVzIGFueW9uZSB0byBqb2luLlwiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG1lbWJlciA9IHJvb20/LmdldE1lbWJlcihkbVBhcnRuZXIpO1xuICAgICAgICBjb25zdCBkaXNwbGF5TmFtZSA9IG1lbWJlcj8ucmF3RGlzcGxheU5hbWUgfHwgZG1QYXJ0bmVyO1xuICAgICAgICBib2R5ID0gPFJlYWN0LkZyYWdtZW50PlxuICAgICAgICAgICAgPFJvb21BdmF0YXJcbiAgICAgICAgICAgICAgICByb29tPXtyb29tfVxuICAgICAgICAgICAgICAgIHdpZHRoPXtBVkFUQVJfU0laRX1cbiAgICAgICAgICAgICAgICBoZWlnaHQ9e0FWQVRBUl9TSVpFfVxuICAgICAgICAgICAgICAgIG9uQ2xpY2s9eygpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdERpc3BhdGNoZXIuZGlzcGF0Y2g8Vmlld1VzZXJQYXlsb2FkPih7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb246IEFjdGlvbi5WaWV3VXNlcixcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFhYWDogV2Ugc2hvdWxkIGJlIHVzaW5nIGEgcmVhbCBtZW1iZXIgb2JqZWN0IGFuZCBub3QgYXNzdW1pbmcgd2hhdCB0aGUgcmVjZWl2ZXIgd2FudHMuXG4gICAgICAgICAgICAgICAgICAgICAgICBtZW1iZXI6IG1lbWJlciB8fCB7IHVzZXJJZDogZG1QYXJ0bmVyIH0gYXMgVXNlcixcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfX1cbiAgICAgICAgICAgIC8+XG5cbiAgICAgICAgICAgIDxoMj57IHJvb20ubmFtZSB9PC9oMj5cblxuICAgICAgICAgICAgPHA+eyBfdChcIlRoaXMgaXMgdGhlIGJlZ2lubmluZyBvZiB5b3VyIGRpcmVjdCBtZXNzYWdlIGhpc3Rvcnkgd2l0aCA8ZGlzcGxheU5hbWUvPi5cIiwge30sIHtcbiAgICAgICAgICAgICAgICBkaXNwbGF5TmFtZTogKCkgPT4gPGI+eyBkaXNwbGF5TmFtZSB9PC9iPixcbiAgICAgICAgICAgIH0pIH08L3A+XG4gICAgICAgICAgICB7IGNhcHRpb24gJiYgPHA+eyBjYXB0aW9uIH08L3A+IH1cbiAgICAgICAgPC9SZWFjdC5GcmFnbWVudD47XG4gICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgaW5Sb29tID0gcm9vbSAmJiByb29tLmdldE15TWVtYmVyc2hpcCgpID09PSBcImpvaW5cIjtcbiAgICAgICAgY29uc3QgdG9waWMgPSByb29tLmN1cnJlbnRTdGF0ZS5nZXRTdGF0ZUV2ZW50cyhFdmVudFR5cGUuUm9vbVRvcGljLCBcIlwiKT8uZ2V0Q29udGVudCgpPy50b3BpYztcbiAgICAgICAgY29uc3QgY2FuQWRkVG9waWMgPSBpblJvb20gJiYgcm9vbS5jdXJyZW50U3RhdGUubWF5U2VuZFN0YXRlRXZlbnQoRXZlbnRUeXBlLlJvb21Ub3BpYywgY2xpLmdldFVzZXJJZCgpKTtcblxuICAgICAgICBjb25zdCBvblRvcGljQ2xpY2sgPSAoKSA9PiB7XG4gICAgICAgICAgICBkaXMuZGlzcGF0Y2goe1xuICAgICAgICAgICAgICAgIGFjdGlvbjogXCJvcGVuX3Jvb21fc2V0dGluZ3NcIixcbiAgICAgICAgICAgICAgICByb29tX2lkOiByb29tSWQsXG4gICAgICAgICAgICB9LCB0cnVlKTtcbiAgICAgICAgICAgIC8vIGZvY3VzIHRoZSB0b3BpYyBmaWVsZCB0byBoZWxwIHRoZSB1c2VyIGZpbmQgaXQgYXMgaXQnbGwgZ2FpbiBhbiBvdXRsaW5lXG4gICAgICAgICAgICBzZXRJbW1lZGlhdGUoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHdpbmRvdy5kb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInByb2ZpbGVUb3BpY1wiKS5mb2N1cygpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgbGV0IHRvcGljVGV4dDtcbiAgICAgICAgaWYgKGNhbkFkZFRvcGljICYmIHRvcGljKSB7XG4gICAgICAgICAgICB0b3BpY1RleHQgPSBfdChcIlRvcGljOiAlKHRvcGljKXMgKDxhPmVkaXQ8L2E+KVwiLCB7IHRvcGljIH0sIHtcbiAgICAgICAgICAgICAgICBhOiBzdWIgPT4gPEFjY2Vzc2libGVCdXR0b24ga2luZD1cImxpbmtcIiBvbkNsaWNrPXtvblRvcGljQ2xpY2t9Pnsgc3ViIH08L0FjY2Vzc2libGVCdXR0b24+LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSBpZiAodG9waWMpIHtcbiAgICAgICAgICAgIHRvcGljVGV4dCA9IF90KFwiVG9waWM6ICUodG9waWMpcyBcIiwgeyB0b3BpYyB9KTtcbiAgICAgICAgfSBlbHNlIGlmIChjYW5BZGRUb3BpYykge1xuICAgICAgICAgICAgdG9waWNUZXh0ID0gX3QoXCI8YT5BZGQgYSB0b3BpYzwvYT4gdG8gaGVscCBwZW9wbGUga25vdyB3aGF0IGl0IGlzIGFib3V0LlwiLCB7fSwge1xuICAgICAgICAgICAgICAgIGE6IHN1YiA9PiA8QWNjZXNzaWJsZUJ1dHRvblxuICAgICAgICAgICAgICAgICAgICBraW5kPVwibGlua1wiXG4gICAgICAgICAgICAgICAgICAgIGVsZW1lbnQ9XCJzcGFuXCJcbiAgICAgICAgICAgICAgICAgICAgb25DbGljaz17b25Ub3BpY0NsaWNrfVxuICAgICAgICAgICAgICAgID57IHN1YiB9PC9BY2Nlc3NpYmxlQnV0dG9uPixcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY3JlYXRvciA9IHJvb20uY3VycmVudFN0YXRlLmdldFN0YXRlRXZlbnRzKEV2ZW50VHlwZS5Sb29tQ3JlYXRlLCBcIlwiKT8uZ2V0U2VuZGVyKCk7XG4gICAgICAgIGNvbnN0IGNyZWF0b3JOYW1lID0gcm9vbT8uZ2V0TWVtYmVyKGNyZWF0b3IpPy5yYXdEaXNwbGF5TmFtZSB8fCBjcmVhdG9yO1xuXG4gICAgICAgIGxldCBjcmVhdGVkVGV4dDtcbiAgICAgICAgaWYgKGNyZWF0b3IgPT09IGNsaS5nZXRVc2VySWQoKSkge1xuICAgICAgICAgICAgY3JlYXRlZFRleHQgPSBfdChcIllvdSBjcmVhdGVkIHRoaXMgcm9vbS5cIik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjcmVhdGVkVGV4dCA9IF90KFwiJShkaXNwbGF5TmFtZSlzIGNyZWF0ZWQgdGhpcyByb29tLlwiLCB7XG4gICAgICAgICAgICAgICAgZGlzcGxheU5hbWU6IGNyZWF0b3JOYW1lLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgcGFyZW50U3BhY2U6IFJvb207XG4gICAgICAgIGlmIChcbiAgICAgICAgICAgIFNwYWNlU3RvcmUuaW5zdGFuY2UuYWN0aXZlU3BhY2VSb29tPy5jYW5JbnZpdGUoY2xpLmdldFVzZXJJZCgpKSAmJlxuICAgICAgICAgICAgU3BhY2VTdG9yZS5pbnN0YW5jZS5nZXRTcGFjZUZpbHRlcmVkUm9vbUlkcyhTcGFjZVN0b3JlLmluc3RhbmNlLmFjdGl2ZVNwYWNlKS5oYXMocm9vbS5yb29tSWQpXG4gICAgICAgICkge1xuICAgICAgICAgICAgcGFyZW50U3BhY2UgPSBTcGFjZVN0b3JlLmluc3RhbmNlLmFjdGl2ZVNwYWNlUm9vbTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBidXR0b25zO1xuICAgICAgICBpZiAocGFyZW50U3BhY2UpIHtcbiAgICAgICAgICAgIGJ1dHRvbnMgPSA8ZGl2IGNsYXNzTmFtZT1cIm14X05ld1Jvb21JbnRyb19idXR0b25zXCI+XG4gICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b25cbiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfTmV3Um9vbUludHJvX2ludml0ZUJ1dHRvblwiXG4gICAgICAgICAgICAgICAgICAgIGtpbmQ9XCJwcmltYXJ5XCJcbiAgICAgICAgICAgICAgICAgICAgb25DbGljaz17KCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2hvd1NwYWNlSW52aXRlKHBhcmVudFNwYWNlKTtcbiAgICAgICAgICAgICAgICAgICAgfX1cbiAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICAgIHsgX3QoXCJJbnZpdGUgdG8gJShzcGFjZU5hbWUpc1wiLCB7IHNwYWNlTmFtZTogcGFyZW50U3BhY2UubmFtZSB9KSB9XG4gICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgICAgIHsgcm9vbS5jYW5JbnZpdGUoY2xpLmdldFVzZXJJZCgpKSAmJiA8QWNjZXNzaWJsZUJ1dHRvblxuICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9OZXdSb29tSW50cm9faW52aXRlQnV0dG9uXCJcbiAgICAgICAgICAgICAgICAgICAga2luZD1cInByaW1hcnlfb3V0bGluZVwiXG4gICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s9eygpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpcy5kaXNwYXRjaCh7IGFjdGlvbjogXCJ2aWV3X2ludml0ZVwiLCByb29tSWQgfSk7XG4gICAgICAgICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICB7IF90KFwiSW52aXRlIHRvIGp1c3QgdGhpcyByb29tXCIpIH1cbiAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+IH1cbiAgICAgICAgICAgIDwvZGl2PjtcbiAgICAgICAgfSBlbHNlIGlmIChyb29tLmNhbkludml0ZShjbGkuZ2V0VXNlcklkKCkpICYmIHNob3VsZFNob3dDb21wb25lbnQoVUlDb21wb25lbnQuSW52aXRlVXNlcnMpKSB7XG4gICAgICAgICAgICBidXR0b25zID0gPGRpdiBjbGFzc05hbWU9XCJteF9OZXdSb29tSW50cm9fYnV0dG9uc1wiPlxuICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uXG4gICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X05ld1Jvb21JbnRyb19pbnZpdGVCdXR0b25cIlxuICAgICAgICAgICAgICAgICAgICBraW5kPVwicHJpbWFyeVwiXG4gICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s9eygpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpcy5kaXNwYXRjaCh7IGFjdGlvbjogXCJ2aWV3X2ludml0ZVwiLCByb29tSWQgfSk7XG4gICAgICAgICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICB7IF90KFwiSW52aXRlIHRvIHRoaXMgcm9vbVwiKSB9XG4gICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgPC9kaXY+O1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgYXZhdGFyVXJsID0gcm9vbS5jdXJyZW50U3RhdGUuZ2V0U3RhdGVFdmVudHMoRXZlbnRUeXBlLlJvb21BdmF0YXIsIFwiXCIpPy5nZXRDb250ZW50KCk/LnVybDtcbiAgICAgICAgYm9keSA9IDxSZWFjdC5GcmFnbWVudD5cbiAgICAgICAgICAgIDxNaW5pQXZhdGFyVXBsb2FkZXJcbiAgICAgICAgICAgICAgICBoYXNBdmF0YXI9eyEhYXZhdGFyVXJsfVxuICAgICAgICAgICAgICAgIG5vQXZhdGFyTGFiZWw9e190KFwiQWRkIGEgcGhvdG8sIHNvIHBlb3BsZSBjYW4gZWFzaWx5IHNwb3QgeW91ciByb29tLlwiKX1cbiAgICAgICAgICAgICAgICBzZXRBdmF0YXJVcmw9e3VybCA9PiBjbGkuc2VuZFN0YXRlRXZlbnQocm9vbUlkLCBFdmVudFR5cGUuUm9vbUF2YXRhciwgeyB1cmwgfSwgJycpfVxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgIDxSb29tQXZhdGFyIHJvb209e3Jvb219IHdpZHRoPXtBVkFUQVJfU0laRX0gaGVpZ2h0PXtBVkFUQVJfU0laRX0gLz5cbiAgICAgICAgICAgIDwvTWluaUF2YXRhclVwbG9hZGVyPlxuXG4gICAgICAgICAgICA8aDI+eyByb29tLm5hbWUgfTwvaDI+XG5cbiAgICAgICAgICAgIDxwPnsgY3JlYXRlZFRleHQgfSB7IF90KFwiVGhpcyBpcyB0aGUgc3RhcnQgb2YgPHJvb21OYW1lLz4uXCIsIHt9LCB7XG4gICAgICAgICAgICAgICAgcm9vbU5hbWU6ICgpID0+IDxiPnsgcm9vbS5uYW1lIH08L2I+LFxuICAgICAgICAgICAgfSkgfTwvcD5cbiAgICAgICAgICAgIDxwPnsgdG9waWNUZXh0IH08L3A+XG4gICAgICAgICAgICB7IGJ1dHRvbnMgfVxuICAgICAgICA8L1JlYWN0LkZyYWdtZW50PjtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBvcGVuUm9vbVNldHRpbmdzKGV2ZW50KSB7XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIGRpcy5kaXNwYXRjaCh7XG4gICAgICAgICAgICBhY3Rpb246IFwib3Blbl9yb29tX3NldHRpbmdzXCIsXG4gICAgICAgICAgICBpbml0aWFsX3RhYl9pZDogUk9PTV9TRUNVUklUWV9UQUIsXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHN1YlRleHQgPSBfdChcbiAgICAgICAgXCJZb3VyIHByaXZhdGUgbWVzc2FnZXMgYXJlIG5vcm1hbGx5IGVuY3J5cHRlZCwgYnV0IHRoaXMgcm9vbSBpc24ndC4gXCIrXG4gICAgICAgIFwiVXN1YWxseSB0aGlzIGlzIGR1ZSB0byBhbiB1bnN1cHBvcnRlZCBkZXZpY2Ugb3IgbWV0aG9kIGJlaW5nIHVzZWQsIFwiICtcbiAgICAgICAgXCJsaWtlIGVtYWlsIGludml0ZXMuXCIsXG4gICAgKTtcblxuICAgIGxldCBzdWJCdXR0b247XG4gICAgaWYgKHJvb20uY3VycmVudFN0YXRlLm1heUNsaWVudFNlbmRTdGF0ZUV2ZW50KEV2ZW50VHlwZS5Sb29tRW5jcnlwdGlvbiwgTWF0cml4Q2xpZW50UGVnLmdldCgpKSkge1xuICAgICAgICBzdWJCdXR0b24gPSAoXG4gICAgICAgICAgICA8YSBvbkNsaWNrPXtvcGVuUm9vbVNldHRpbmdzfSBocmVmPVwiI1wiPiB7IF90KFwiRW5hYmxlIGVuY3J5cHRpb24gaW4gc2V0dGluZ3MuXCIpIH08L2E+XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3VidGl0bGUgPSAoXG4gICAgICAgIDxzcGFuPiB7IHN1YlRleHQgfSB7IHN1YkJ1dHRvbiB9IDwvc3Bhbj5cbiAgICApO1xuXG4gICAgcmV0dXJuIDxkaXYgY2xhc3NOYW1lPVwibXhfTmV3Um9vbUludHJvXCI+XG5cbiAgICAgICAgeyAhaGFzRXhwZWN0ZWRFbmNyeXB0aW9uU2V0dGluZ3MoY2xpLCByb29tKSAmJiAoXG4gICAgICAgICAgICA8RXZlbnRUaWxlQnViYmxlXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfY3J5cHRvRXZlbnQgbXhfY3J5cHRvRXZlbnRfaWNvbl93YXJuaW5nXCJcbiAgICAgICAgICAgICAgICB0aXRsZT17X3QoXCJFbmQtdG8tZW5kIGVuY3J5cHRpb24gaXNuJ3QgZW5hYmxlZFwiKX1cbiAgICAgICAgICAgICAgICBzdWJ0aXRsZT17c3VidGl0bGV9XG4gICAgICAgICAgICAvPlxuICAgICAgICApIH1cblxuICAgICAgICB7IGJvZHkgfVxuICAgIDwvZGl2Pjtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IE5ld1Jvb21JbnRybztcbiJdfQ==