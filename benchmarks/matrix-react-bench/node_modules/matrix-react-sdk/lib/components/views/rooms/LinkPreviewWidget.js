"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var _htmlEntities = require("html-entities");

var _HtmlUtils = require("../../../HtmlUtils");

var _SettingsStore = _interopRequireDefault(require("../../../settings/SettingsStore"));

var _Modal = _interopRequireDefault(require("../../../Modal"));

var ImageUtils = _interopRequireWildcard(require("../../../ImageUtils"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _Media = require("../../../customisations/Media");

var _ImageView = _interopRequireDefault(require("../elements/ImageView"));

var _dec, _class;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

let LinkPreviewWidget = (_dec = (0, _replaceableComponent.replaceableComponent)("views.rooms.LinkPreviewWidget"), _dec(_class = class LinkPreviewWidget extends _react.default.Component {
  constructor(...args) {
    super(...args);
    (0, _defineProperty2.default)(this, "description", /*#__PURE__*/(0, _react.createRef)());
    (0, _defineProperty2.default)(this, "image", /*#__PURE__*/(0, _react.createRef)());
    (0, _defineProperty2.default)(this, "onImageClick", ev => {
      const p = this.props.preview;
      if (ev.button != 0 || ev.metaKey) return;
      ev.preventDefault();
      let src = p["og:image"];

      if (src && src.startsWith("mxc://")) {
        src = (0, _Media.mediaFromMxc)(src).srcHttp;
      }

      const params = {
        src: src,
        width: p["og:image:width"],
        height: p["og:image:height"],
        name: p["og:title"] || p["og:description"] || this.props.link,
        fileSize: p["matrix:image:size"],
        link: this.props.link
      };

      if (this.image.current) {
        const clientRect = this.image.current.getBoundingClientRect();
        params.thumbnailInfo = {
          width: clientRect.width,
          height: clientRect.height,
          positionX: clientRect.x,
          positionY: clientRect.y
        };
      }

      _Modal.default.createDialog(_ImageView.default, params, "mx_Dialog_lightbox", null, true);
    });
  }

  componentDidMount() {
    if (this.description.current) {
      (0, _HtmlUtils.linkifyElement)(this.description.current);
    }
  }

  componentDidUpdate() {
    if (this.description.current) {
      (0, _HtmlUtils.linkifyElement)(this.description.current);
    }
  }

  render() {
    const p = this.props.preview;

    if (!p || Object.keys(p).length === 0) {
      return /*#__PURE__*/_react.default.createElement("div", null);
    } // FIXME: do we want to factor out all image displaying between this and MImageBody - especially for lightboxing?


    let image = p["og:image"];

    if (!_SettingsStore.default.getValue("showImages")) {
      image = null; // Don't render a button to show the image, just hide it outright
    }

    const imageMaxWidth = 100;
    const imageMaxHeight = 100;

    if (image && image.startsWith("mxc://")) {
      // We deliberately don't want a square here, so use the source HTTP thumbnail function
      image = (0, _Media.mediaFromMxc)(image).getThumbnailOfSourceHttp(imageMaxWidth, imageMaxHeight, 'scale');
    }

    let thumbHeight = imageMaxHeight;

    if (p["og:image:width"] && p["og:image:height"]) {
      thumbHeight = ImageUtils.thumbHeight(p["og:image:width"], p["og:image:height"], imageMaxWidth, imageMaxHeight);
    }

    let img;

    if (image) {
      img = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_LinkPreviewWidget_image",
        style: {
          height: thumbHeight
        }
      }, /*#__PURE__*/_react.default.createElement("img", {
        ref: this.image,
        style: {
          maxWidth: imageMaxWidth,
          maxHeight: imageMaxHeight
        },
        src: image,
        onClick: this.onImageClick
      }));
    } // The description includes &-encoded HTML entities, we decode those as React treats the thing as an
    // opaque string. This does not allow any HTML to be injected into the DOM.


    const description = _htmlEntities.AllHtmlEntities.decode(p["og:description"] || "");

    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_LinkPreviewWidget"
    }, img, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_LinkPreviewWidget_caption"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_LinkPreviewWidget_title"
    }, /*#__PURE__*/_react.default.createElement("a", {
      href: this.props.link,
      target: "_blank",
      rel: "noreferrer noopener"
    }, p["og:title"]), p["og:site_name"] && /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_LinkPreviewWidget_siteName"
    }, " - " + p["og:site_name"])), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_LinkPreviewWidget_description",
      ref: this.description
    }, description)), this.props.children);
  }

}) || _class);
exports.default = LinkPreviewWidget;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3Jvb21zL0xpbmtQcmV2aWV3V2lkZ2V0LnRzeCJdLCJuYW1lcyI6WyJMaW5rUHJldmlld1dpZGdldCIsIlJlYWN0IiwiQ29tcG9uZW50IiwiZXYiLCJwIiwicHJvcHMiLCJwcmV2aWV3IiwiYnV0dG9uIiwibWV0YUtleSIsInByZXZlbnREZWZhdWx0Iiwic3JjIiwic3RhcnRzV2l0aCIsInNyY0h0dHAiLCJwYXJhbXMiLCJ3aWR0aCIsImhlaWdodCIsIm5hbWUiLCJsaW5rIiwiZmlsZVNpemUiLCJpbWFnZSIsImN1cnJlbnQiLCJjbGllbnRSZWN0IiwiZ2V0Qm91bmRpbmdDbGllbnRSZWN0IiwidGh1bWJuYWlsSW5mbyIsInBvc2l0aW9uWCIsIngiLCJwb3NpdGlvblkiLCJ5IiwiTW9kYWwiLCJjcmVhdGVEaWFsb2ciLCJJbWFnZVZpZXciLCJjb21wb25lbnREaWRNb3VudCIsImRlc2NyaXB0aW9uIiwiY29tcG9uZW50RGlkVXBkYXRlIiwicmVuZGVyIiwiT2JqZWN0Iiwia2V5cyIsImxlbmd0aCIsIlNldHRpbmdzU3RvcmUiLCJnZXRWYWx1ZSIsImltYWdlTWF4V2lkdGgiLCJpbWFnZU1heEhlaWdodCIsImdldFRodW1ibmFpbE9mU291cmNlSHR0cCIsInRodW1iSGVpZ2h0IiwiSW1hZ2VVdGlscyIsImltZyIsIm1heFdpZHRoIiwibWF4SGVpZ2h0Iiwib25JbWFnZUNsaWNrIiwiQWxsSHRtbEVudGl0aWVzIiwiZGVjb2RlIiwiY2hpbGRyZW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUNBOztBQUlBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7OztJQVNxQkEsaUIsV0FEcEIsZ0RBQXFCLCtCQUFyQixDLGdCQUFELE1BQ3FCQSxpQkFEckIsU0FDK0NDLGVBQU1DLFNBRHJELENBQ3VFO0FBQUE7QUFBQTtBQUFBLG9FQUNwQyx1QkFEb0M7QUFBQSw4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WSxJQUFwQjtBQUEwQixNQUFBLE1BQU0sRUFBQyxRQUFqQztBQUEwQyxNQUFBLEdBQUcsRUFBQztBQUE5QyxPQUFzRWIsQ0FBQyxDQUFDLFVBQUQsQ0FBdkUsQ0FESixFQUVNQSxDQUFDLENBQUMsY0FBRCxDQUFELGlCQUFxQjtBQUFNLE1BQUEsU0FBUyxFQUFDO0FBQWhCLE9BQ2hCLFFBQVFBLENBQUMsQ0FBQyxjQUFELENBRE8sQ0FGM0IsQ0FESixlQU9JO0FBQUssTUFBQSxTQUFTLEVBQUMsa0NBQWY7QUFBa0QsTUFBQSxHQUFHLEVBQUUsS0FBSzRCO0FBQTVELE9BQ01BLFdBRE4sQ0FQSixDQUZKLEVBYU0sS0FBSzNCLEtBQUwsQ0FBVzhDLFFBYmpCLENBREo7QUFpQkg7O0FBdkdrRSxDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE2IC0gMjAyMSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCwgeyBDb21wb25lbnRQcm9wcywgY3JlYXRlUmVmIH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgQWxsSHRtbEVudGl0aWVzIH0gZnJvbSAnaHRtbC1lbnRpdGllcyc7XG5pbXBvcnQgeyBNYXRyaXhFdmVudCB9IGZyb20gJ21hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9ldmVudCc7XG5pbXBvcnQgeyBJUHJldmlld1VybFJlc3BvbnNlIH0gZnJvbSAnbWF0cml4LWpzLXNkay9zcmMvY2xpZW50JztcblxuaW1wb3J0IHsgbGlua2lmeUVsZW1lbnQgfSBmcm9tICcuLi8uLi8uLi9IdG1sVXRpbHMnO1xuaW1wb3J0IFNldHRpbmdzU3RvcmUgZnJvbSBcIi4uLy4uLy4uL3NldHRpbmdzL1NldHRpbmdzU3RvcmVcIjtcbmltcG9ydCBNb2RhbCBmcm9tIFwiLi4vLi4vLi4vTW9kYWxcIjtcbmltcG9ydCAqIGFzIEltYWdlVXRpbHMgZnJvbSBcIi4uLy4uLy4uL0ltYWdlVXRpbHNcIjtcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5pbXBvcnQgeyBtZWRpYUZyb21NeGMgfSBmcm9tIFwiLi4vLi4vLi4vY3VzdG9taXNhdGlvbnMvTWVkaWFcIjtcbmltcG9ydCBJbWFnZVZpZXcgZnJvbSAnLi4vZWxlbWVudHMvSW1hZ2VWaWV3JztcblxuaW50ZXJmYWNlIElQcm9wcyB7XG4gICAgbGluazogc3RyaW5nO1xuICAgIHByZXZpZXc6IElQcmV2aWV3VXJsUmVzcG9uc2U7XG4gICAgbXhFdmVudDogTWF0cml4RXZlbnQ7IC8vIHRoZSBFdmVudCBhc3NvY2lhdGVkIHdpdGggdGhlIHByZXZpZXdcbn1cblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3Mucm9vbXMuTGlua1ByZXZpZXdXaWRnZXRcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIExpbmtQcmV2aWV3V2lkZ2V0IGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PElQcm9wcz4ge1xuICAgIHByaXZhdGUgcmVhZG9ubHkgZGVzY3JpcHRpb24gPSBjcmVhdGVSZWY8SFRNTERpdkVsZW1lbnQ+KCk7XG4gICAgcHJpdmF0ZSBpbWFnZSA9IGNyZWF0ZVJlZjxIVE1MSW1hZ2VFbGVtZW50PigpO1xuXG4gICAgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgICAgIGlmICh0aGlzLmRlc2NyaXB0aW9uLmN1cnJlbnQpIHtcbiAgICAgICAgICAgIGxpbmtpZnlFbGVtZW50KHRoaXMuZGVzY3JpcHRpb24uY3VycmVudCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb21wb25lbnREaWRVcGRhdGUoKSB7XG4gICAgICAgIGlmICh0aGlzLmRlc2NyaXB0aW9uLmN1cnJlbnQpIHtcbiAgICAgICAgICAgIGxpbmtpZnlFbGVtZW50KHRoaXMuZGVzY3JpcHRpb24uY3VycmVudCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIG9uSW1hZ2VDbGljayA9IGV2ID0+IHtcbiAgICAgICAgY29uc3QgcCA9IHRoaXMucHJvcHMucHJldmlldztcbiAgICAgICAgaWYgKGV2LmJ1dHRvbiAhPSAwIHx8IGV2Lm1ldGFLZXkpIHJldHVybjtcbiAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgICBsZXQgc3JjID0gcFtcIm9nOmltYWdlXCJdO1xuICAgICAgICBpZiAoc3JjICYmIHNyYy5zdGFydHNXaXRoKFwibXhjOi8vXCIpKSB7XG4gICAgICAgICAgICBzcmMgPSBtZWRpYUZyb21NeGMoc3JjKS5zcmNIdHRwO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcGFyYW1zOiBPbWl0PENvbXBvbmVudFByb3BzPHR5cGVvZiBJbWFnZVZpZXc+LCBcIm9uRmluaXNoZWRcIj4gPSB7XG4gICAgICAgICAgICBzcmM6IHNyYyxcbiAgICAgICAgICAgIHdpZHRoOiBwW1wib2c6aW1hZ2U6d2lkdGhcIl0sXG4gICAgICAgICAgICBoZWlnaHQ6IHBbXCJvZzppbWFnZTpoZWlnaHRcIl0sXG4gICAgICAgICAgICBuYW1lOiBwW1wib2c6dGl0bGVcIl0gfHwgcFtcIm9nOmRlc2NyaXB0aW9uXCJdIHx8IHRoaXMucHJvcHMubGluayxcbiAgICAgICAgICAgIGZpbGVTaXplOiBwW1wibWF0cml4OmltYWdlOnNpemVcIl0sXG4gICAgICAgICAgICBsaW5rOiB0aGlzLnByb3BzLmxpbmssXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKHRoaXMuaW1hZ2UuY3VycmVudCkge1xuICAgICAgICAgICAgY29uc3QgY2xpZW50UmVjdCA9IHRoaXMuaW1hZ2UuY3VycmVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcblxuICAgICAgICAgICAgcGFyYW1zLnRodW1ibmFpbEluZm8gPSB7XG4gICAgICAgICAgICAgICAgd2lkdGg6IGNsaWVudFJlY3Qud2lkdGgsXG4gICAgICAgICAgICAgICAgaGVpZ2h0OiBjbGllbnRSZWN0LmhlaWdodCxcbiAgICAgICAgICAgICAgICBwb3NpdGlvblg6IGNsaWVudFJlY3QueCxcbiAgICAgICAgICAgICAgICBwb3NpdGlvblk6IGNsaWVudFJlY3QueSxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICBNb2RhbC5jcmVhdGVEaWFsb2coSW1hZ2VWaWV3LCBwYXJhbXMsIFwibXhfRGlhbG9nX2xpZ2h0Ym94XCIsIG51bGwsIHRydWUpO1xuICAgIH07XG5cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIGNvbnN0IHAgPSB0aGlzLnByb3BzLnByZXZpZXc7XG4gICAgICAgIGlmICghcCB8fCBPYmplY3Qua2V5cyhwKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiA8ZGl2IC8+O1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gRklYTUU6IGRvIHdlIHdhbnQgdG8gZmFjdG9yIG91dCBhbGwgaW1hZ2UgZGlzcGxheWluZyBiZXR3ZWVuIHRoaXMgYW5kIE1JbWFnZUJvZHkgLSBlc3BlY2lhbGx5IGZvciBsaWdodGJveGluZz9cbiAgICAgICAgbGV0IGltYWdlID0gcFtcIm9nOmltYWdlXCJdO1xuICAgICAgICBpZiAoIVNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJzaG93SW1hZ2VzXCIpKSB7XG4gICAgICAgICAgICBpbWFnZSA9IG51bGw7IC8vIERvbid0IHJlbmRlciBhIGJ1dHRvbiB0byBzaG93IHRoZSBpbWFnZSwganVzdCBoaWRlIGl0IG91dHJpZ2h0XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgaW1hZ2VNYXhXaWR0aCA9IDEwMDtcbiAgICAgICAgY29uc3QgaW1hZ2VNYXhIZWlnaHQgPSAxMDA7XG4gICAgICAgIGlmIChpbWFnZSAmJiBpbWFnZS5zdGFydHNXaXRoKFwibXhjOi8vXCIpKSB7XG4gICAgICAgICAgICAvLyBXZSBkZWxpYmVyYXRlbHkgZG9uJ3Qgd2FudCBhIHNxdWFyZSBoZXJlLCBzbyB1c2UgdGhlIHNvdXJjZSBIVFRQIHRodW1ibmFpbCBmdW5jdGlvblxuICAgICAgICAgICAgaW1hZ2UgPSBtZWRpYUZyb21NeGMoaW1hZ2UpLmdldFRodW1ibmFpbE9mU291cmNlSHR0cChpbWFnZU1heFdpZHRoLCBpbWFnZU1heEhlaWdodCwgJ3NjYWxlJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgdGh1bWJIZWlnaHQgPSBpbWFnZU1heEhlaWdodDtcbiAgICAgICAgaWYgKHBbXCJvZzppbWFnZTp3aWR0aFwiXSAmJiBwW1wib2c6aW1hZ2U6aGVpZ2h0XCJdKSB7XG4gICAgICAgICAgICB0aHVtYkhlaWdodCA9IEltYWdlVXRpbHMudGh1bWJIZWlnaHQoXG4gICAgICAgICAgICAgICAgcFtcIm9nOmltYWdlOndpZHRoXCJdLCBwW1wib2c6aW1hZ2U6aGVpZ2h0XCJdLFxuICAgICAgICAgICAgICAgIGltYWdlTWF4V2lkdGgsIGltYWdlTWF4SGVpZ2h0LFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBpbWc7XG4gICAgICAgIGlmIChpbWFnZSkge1xuICAgICAgICAgICAgaW1nID0gPGRpdiBjbGFzc05hbWU9XCJteF9MaW5rUHJldmlld1dpZGdldF9pbWFnZVwiIHN0eWxlPXt7IGhlaWdodDogdGh1bWJIZWlnaHQgfX0+XG4gICAgICAgICAgICAgICAgPGltZyByZWY9e3RoaXMuaW1hZ2V9IHN0eWxlPXt7IG1heFdpZHRoOiBpbWFnZU1heFdpZHRoLCBtYXhIZWlnaHQ6IGltYWdlTWF4SGVpZ2h0IH19IHNyYz17aW1hZ2V9IG9uQ2xpY2s9e3RoaXMub25JbWFnZUNsaWNrfSAvPlxuICAgICAgICAgICAgPC9kaXY+O1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gVGhlIGRlc2NyaXB0aW9uIGluY2x1ZGVzICYtZW5jb2RlZCBIVE1MIGVudGl0aWVzLCB3ZSBkZWNvZGUgdGhvc2UgYXMgUmVhY3QgdHJlYXRzIHRoZSB0aGluZyBhcyBhblxuICAgICAgICAvLyBvcGFxdWUgc3RyaW5nLiBUaGlzIGRvZXMgbm90IGFsbG93IGFueSBIVE1MIHRvIGJlIGluamVjdGVkIGludG8gdGhlIERPTS5cbiAgICAgICAgY29uc3QgZGVzY3JpcHRpb24gPSBBbGxIdG1sRW50aXRpZXMuZGVjb2RlKHBbXCJvZzpkZXNjcmlwdGlvblwiXSB8fCBcIlwiKTtcblxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9MaW5rUHJldmlld1dpZGdldFwiPlxuICAgICAgICAgICAgICAgIHsgaW1nIH1cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0xpbmtQcmV2aWV3V2lkZ2V0X2NhcHRpb25cIj5cbiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9MaW5rUHJldmlld1dpZGdldF90aXRsZVwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgPGEgaHJlZj17dGhpcy5wcm9wcy5saW5rfSB0YXJnZXQ9XCJfYmxhbmtcIiByZWw9XCJub3JlZmVycmVyIG5vb3BlbmVyXCI+eyBwW1wib2c6dGl0bGVcIl0gfTwvYT5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgcFtcIm9nOnNpdGVfbmFtZVwiXSAmJiA8c3BhbiBjbGFzc05hbWU9XCJteF9MaW5rUHJldmlld1dpZGdldF9zaXRlTmFtZVwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgKFwiIC0gXCIgKyBwW1wib2c6c2l0ZV9uYW1lXCJdKSB9XG4gICAgICAgICAgICAgICAgICAgICAgICA8L3NwYW4+IH1cbiAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfTGlua1ByZXZpZXdXaWRnZXRfZGVzY3JpcHRpb25cIiByZWY9e3RoaXMuZGVzY3JpcHRpb259PlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBkZXNjcmlwdGlvbiB9XG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgIHsgdGhpcy5wcm9wcy5jaGlsZHJlbiB9XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=