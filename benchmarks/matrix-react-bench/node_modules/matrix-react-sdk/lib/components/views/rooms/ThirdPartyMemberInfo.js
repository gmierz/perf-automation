"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _languageHandler = require("../../../languageHandler");

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _RoomInvite = require("../../../RoomInvite");

var _RoomAvatar = _interopRequireDefault(require("../avatars/RoomAvatar"));

var _RoomName = _interopRequireDefault(require("../elements/RoomName"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _ErrorDialog = _interopRequireDefault(require("../dialogs/ErrorDialog"));

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _SpaceStore = _interopRequireDefault(require("../../../stores/spaces/SpaceStore"));

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class;

let ThirdPartyMemberInfo = (_dec = (0, _replaceableComponent.replaceableComponent)("views.rooms.ThirdPartyMemberInfo"), _dec(_class = class ThirdPartyMemberInfo extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "room", void 0);
    (0, _defineProperty2.default)(this, "onRoomStateEvents", ev => {
      if (ev.getType() === "m.room.third_party_invite" && ev.getStateKey() === this.state.stateKey) {
        const newDisplayName = ev.getContent().display_name;
        const isInvited = (0, _RoomInvite.isValid3pidInvite)(ev);
        const newState = {
          invited: isInvited
        };
        if (newDisplayName) newState['displayName'] = newDisplayName;
        this.setState(newState);
      }
    });
    (0, _defineProperty2.default)(this, "onCancel", () => {
      _dispatcher.default.dispatch({
        action: "view_3pid_invite",
        event: null
      });
    });
    (0, _defineProperty2.default)(this, "onKickClick", () => {
      _MatrixClientPeg.MatrixClientPeg.get().sendStateEvent(this.state.roomId, "m.room.third_party_invite", {}, this.state.stateKey).catch(err => {
        _logger.logger.error(err); // Revert echo because of error


        this.setState({
          invited: true
        });

        _Modal.default.createTrackedDialog('Revoke 3pid invite failed', '', _ErrorDialog.default, {
          title: (0, _languageHandler._t)("Failed to revoke invite"),
          description: (0, _languageHandler._t)("Could not revoke the invite. The server may be experiencing a temporary problem or " + "you do not have sufficient permissions to revoke the invite.")
        });
      }); // Local echo


      this.setState({
        invited: false
      });
    });
    this.room = _MatrixClientPeg.MatrixClientPeg.get().getRoom(this.props.event.getRoomId());
    const me = this.room.getMember(_MatrixClientPeg.MatrixClientPeg.get().getUserId());
    const powerLevels = this.room.currentState.getStateEvents("m.room.power_levels", "");
    let kickLevel = powerLevels ? powerLevels.getContent().kick : 50;
    if (typeof kickLevel !== 'number') kickLevel = 50;
    const sender = this.room.getMember(this.props.event.getSender());
    this.state = {
      stateKey: this.props.event.getStateKey(),
      roomId: this.props.event.getRoomId(),
      displayName: this.props.event.getContent().display_name,
      invited: true,
      canKick: me ? me.powerLevel > kickLevel : false,
      senderName: sender ? sender.name : this.props.event.getSender()
    };
  }

  componentDidMount() {
    _MatrixClientPeg.MatrixClientPeg.get().on("RoomState.events", this.onRoomStateEvents);
  }

  componentWillUnmount() {
    const client = _MatrixClientPeg.MatrixClientPeg.get();

    if (client) {
      client.removeListener("RoomState.events", this.onRoomStateEvents);
    }
  }

  render() {
    let adminTools = null;

    if (this.state.canKick && this.state.invited) {
      adminTools = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_MemberInfo_container"
      }, /*#__PURE__*/_react.default.createElement("h3", null, (0, _languageHandler._t)("Admin Tools")), /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_MemberInfo_buttons"
      }, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        className: "mx_MemberInfo_field",
        onClick: this.onKickClick
      }, (0, _languageHandler._t)("Revoke invite"))));
    }

    let scopeHeader;

    if (_SpaceStore.default.spacesEnabled && this.room.isSpaceRoom()) {
      scopeHeader = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_RightPanel_scopeHeader"
      }, /*#__PURE__*/_react.default.createElement(_RoomAvatar.default, {
        room: this.room,
        height: 32,
        width: 32
      }), /*#__PURE__*/_react.default.createElement(_RoomName.default, {
        room: this.room
      }));
    } // We shamelessly rip off the MemberInfo styles here.


    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_MemberInfo",
      role: "tabpanel"
    }, scopeHeader, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_MemberInfo_name"
    }, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      className: "mx_MemberInfo_cancel",
      onClick: this.onCancel,
      title: (0, _languageHandler._t)('Close')
    }), /*#__PURE__*/_react.default.createElement("h2", null, this.state.displayName)), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_MemberInfo_container"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_MemberInfo_profile"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_MemberInfo_profileField"
    }, (0, _languageHandler._t)("Invited by %(sender)s", {
      sender: this.state.senderName
    })))), adminTools);
  }

}) || _class);
exports.default = ThirdPartyMemberInfo;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3Jvb21zL1RoaXJkUGFydHlNZW1iZXJJbmZvLnRzeCJdLCJuYW1lcyI6WyJUaGlyZFBhcnR5TWVtYmVySW5mbyIsIlJlYWN0IiwiQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsImV2IiwiZ2V0VHlwZSIsImdldFN0YXRlS2V5Iiwic3RhdGUiLCJzdGF0ZUtleSIsIm5ld0Rpc3BsYXlOYW1lIiwiZ2V0Q29udGVudCIsImRpc3BsYXlfbmFtZSIsImlzSW52aXRlZCIsIm5ld1N0YXRlIiwiaW52aXRlZCIsInNldFN0YXRlIiwiZGlzIiwiZGlzcGF0Y2giLCJhY3Rpb24iLCJldmVudCIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsInNlbmRTdGF0ZUV2ZW50Iiwicm9vbUlkIiwiY2F0Y2giLCJlcnIiLCJsb2dnZXIiLCJlcnJvciIsIk1vZGFsIiwiY3JlYXRlVHJhY2tlZERpYWxvZyIsIkVycm9yRGlhbG9nIiwidGl0bGUiLCJkZXNjcmlwdGlvbiIsInJvb20iLCJnZXRSb29tIiwiZ2V0Um9vbUlkIiwibWUiLCJnZXRNZW1iZXIiLCJnZXRVc2VySWQiLCJwb3dlckxldmVscyIsImN1cnJlbnRTdGF0ZSIsImdldFN0YXRlRXZlbnRzIiwia2lja0xldmVsIiwia2ljayIsInNlbmRlciIsImdldFNlbmRlciIsImRpc3BsYXlOYW1lIiwiY2FuS2ljayIsInBvd2VyTGV2ZWwiLCJzZW5kZXJOYW1lIiwibmFtZSIsImNvbXBvbmVudERpZE1vdW50Iiwib24iLCJvblJvb21TdGF0ZUV2ZW50cyIsImNvbXBvbmVudFdpbGxVbm1vdW50IiwiY2xpZW50IiwicmVtb3ZlTGlzdGVuZXIiLCJyZW5kZXIiLCJhZG1pblRvb2xzIiwib25LaWNrQ2xpY2siLCJzY29wZUhlYWRlciIsIlNwYWNlU3RvcmUiLCJzcGFjZXNFbmFibGVkIiwiaXNTcGFjZVJvb20iLCJvbkNhbmNlbCJdLCJtYXBwaW5ncyI6Ijs7Ozs7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dCI6WyIvKlxuQ29weXJpZ2h0IDIwMTktMjAyMSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tIFwiLi4vLi4vLi4vTWF0cml4Q2xpZW50UGVnXCI7XG5pbXBvcnQgeyBNYXRyaXhFdmVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvZXZlbnRcIjtcbmltcG9ydCB7IFJvb20gfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3Jvb21cIjtcbmltcG9ydCB7IF90IH0gZnJvbSBcIi4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlclwiO1xuaW1wb3J0IGRpcyBmcm9tIFwiLi4vLi4vLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyXCI7XG5pbXBvcnQgTW9kYWwgZnJvbSBcIi4uLy4uLy4uL01vZGFsXCI7XG5pbXBvcnQgeyBpc1ZhbGlkM3BpZEludml0ZSB9IGZyb20gXCIuLi8uLi8uLi9Sb29tSW52aXRlXCI7XG5pbXBvcnQgUm9vbUF2YXRhciBmcm9tIFwiLi4vYXZhdGFycy9Sb29tQXZhdGFyXCI7XG5pbXBvcnQgUm9vbU5hbWUgZnJvbSBcIi4uL2VsZW1lbnRzL1Jvb21OYW1lXCI7XG5pbXBvcnQgeyByZXBsYWNlYWJsZUNvbXBvbmVudCB9IGZyb20gXCIuLi8uLi8uLi91dGlscy9yZXBsYWNlYWJsZUNvbXBvbmVudFwiO1xuaW1wb3J0IEVycm9yRGlhbG9nIGZyb20gJy4uL2RpYWxvZ3MvRXJyb3JEaWFsb2cnO1xuaW1wb3J0IEFjY2Vzc2libGVCdXR0b24gZnJvbSAnLi4vZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvbic7XG5pbXBvcnQgU3BhY2VTdG9yZSBmcm9tIFwiLi4vLi4vLi4vc3RvcmVzL3NwYWNlcy9TcGFjZVN0b3JlXCI7XG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcblxuaW50ZXJmYWNlIElQcm9wcyB7XG4gICAgZXZlbnQ6IE1hdHJpeEV2ZW50O1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBzdGF0ZUtleTogc3RyaW5nO1xuICAgIHJvb21JZDogc3RyaW5nO1xuICAgIGRpc3BsYXlOYW1lOiBzdHJpbmc7XG4gICAgaW52aXRlZDogYm9vbGVhbjtcbiAgICBjYW5LaWNrOiBib29sZWFuO1xuICAgIHNlbmRlck5hbWU6IHN0cmluZztcbn1cblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3Mucm9vbXMuVGhpcmRQYXJ0eU1lbWJlckluZm9cIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFRoaXJkUGFydHlNZW1iZXJJbmZvIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PElQcm9wcywgSVN0YXRlPiB7XG4gICAgcHJpdmF0ZSByb29tOiBSb29tO1xuXG4gICAgY29uc3RydWN0b3IocHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuXG4gICAgICAgIHRoaXMucm9vbSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRSb29tKHRoaXMucHJvcHMuZXZlbnQuZ2V0Um9vbUlkKCkpO1xuICAgICAgICBjb25zdCBtZSA9IHRoaXMucm9vbS5nZXRNZW1iZXIoTWF0cml4Q2xpZW50UGVnLmdldCgpLmdldFVzZXJJZCgpKTtcbiAgICAgICAgY29uc3QgcG93ZXJMZXZlbHMgPSB0aGlzLnJvb20uY3VycmVudFN0YXRlLmdldFN0YXRlRXZlbnRzKFwibS5yb29tLnBvd2VyX2xldmVsc1wiLCBcIlwiKTtcblxuICAgICAgICBsZXQga2lja0xldmVsID0gcG93ZXJMZXZlbHMgPyBwb3dlckxldmVscy5nZXRDb250ZW50KCkua2ljayA6IDUwO1xuICAgICAgICBpZiAodHlwZW9mKGtpY2tMZXZlbCkgIT09ICdudW1iZXInKSBraWNrTGV2ZWwgPSA1MDtcblxuICAgICAgICBjb25zdCBzZW5kZXIgPSB0aGlzLnJvb20uZ2V0TWVtYmVyKHRoaXMucHJvcHMuZXZlbnQuZ2V0U2VuZGVyKCkpO1xuXG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICBzdGF0ZUtleTogdGhpcy5wcm9wcy5ldmVudC5nZXRTdGF0ZUtleSgpLFxuICAgICAgICAgICAgcm9vbUlkOiB0aGlzLnByb3BzLmV2ZW50LmdldFJvb21JZCgpLFxuICAgICAgICAgICAgZGlzcGxheU5hbWU6IHRoaXMucHJvcHMuZXZlbnQuZ2V0Q29udGVudCgpLmRpc3BsYXlfbmFtZSxcbiAgICAgICAgICAgIGludml0ZWQ6IHRydWUsXG4gICAgICAgICAgICBjYW5LaWNrOiBtZSA/IG1lLnBvd2VyTGV2ZWwgPiBraWNrTGV2ZWwgOiBmYWxzZSxcbiAgICAgICAgICAgIHNlbmRlck5hbWU6IHNlbmRlciA/IHNlbmRlci5uYW1lIDogdGhpcy5wcm9wcy5ldmVudC5nZXRTZW5kZXIoKSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBjb21wb25lbnREaWRNb3VudCgpOiB2b2lkIHtcbiAgICAgICAgTWF0cml4Q2xpZW50UGVnLmdldCgpLm9uKFwiUm9vbVN0YXRlLmV2ZW50c1wiLCB0aGlzLm9uUm9vbVN0YXRlRXZlbnRzKTtcbiAgICB9XG5cbiAgICBjb21wb25lbnRXaWxsVW5tb3VudCgpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgY2xpZW50ID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuICAgICAgICBpZiAoY2xpZW50KSB7XG4gICAgICAgICAgICBjbGllbnQucmVtb3ZlTGlzdGVuZXIoXCJSb29tU3RhdGUuZXZlbnRzXCIsIHRoaXMub25Sb29tU3RhdGVFdmVudHMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgb25Sb29tU3RhdGVFdmVudHMgPSAoZXYpID0+IHtcbiAgICAgICAgaWYgKGV2LmdldFR5cGUoKSA9PT0gXCJtLnJvb20udGhpcmRfcGFydHlfaW52aXRlXCIgJiYgZXYuZ2V0U3RhdGVLZXkoKSA9PT0gdGhpcy5zdGF0ZS5zdGF0ZUtleSkge1xuICAgICAgICAgICAgY29uc3QgbmV3RGlzcGxheU5hbWUgPSBldi5nZXRDb250ZW50KCkuZGlzcGxheV9uYW1lO1xuICAgICAgICAgICAgY29uc3QgaXNJbnZpdGVkID0gaXNWYWxpZDNwaWRJbnZpdGUoZXYpO1xuXG4gICAgICAgICAgICBjb25zdCBuZXdTdGF0ZSA9IHsgaW52aXRlZDogaXNJbnZpdGVkIH07XG4gICAgICAgICAgICBpZiAobmV3RGlzcGxheU5hbWUpIG5ld1N0YXRlWydkaXNwbGF5TmFtZSddID0gbmV3RGlzcGxheU5hbWU7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKG5ld1N0YXRlKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBvbkNhbmNlbCA9ICgpID0+IHtcbiAgICAgICAgZGlzLmRpc3BhdGNoKHtcbiAgICAgICAgICAgIGFjdGlvbjogXCJ2aWV3XzNwaWRfaW52aXRlXCIsXG4gICAgICAgICAgICBldmVudDogbnVsbCxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIG9uS2lja0NsaWNrID0gKCkgPT4ge1xuICAgICAgICBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuc2VuZFN0YXRlRXZlbnQodGhpcy5zdGF0ZS5yb29tSWQsIFwibS5yb29tLnRoaXJkX3BhcnR5X2ludml0ZVwiLCB7fSwgdGhpcy5zdGF0ZS5zdGF0ZUtleSlcbiAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGVycik7XG5cbiAgICAgICAgICAgICAgICAvLyBSZXZlcnQgZWNobyBiZWNhdXNlIG9mIGVycm9yXG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGludml0ZWQ6IHRydWUgfSk7XG5cbiAgICAgICAgICAgICAgICBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nKCdSZXZva2UgM3BpZCBpbnZpdGUgZmFpbGVkJywgJycsIEVycm9yRGlhbG9nLCB7XG4gICAgICAgICAgICAgICAgICAgIHRpdGxlOiBfdChcIkZhaWxlZCB0byByZXZva2UgaW52aXRlXCIpLFxuICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogX3QoXG4gICAgICAgICAgICAgICAgICAgICAgICBcIkNvdWxkIG5vdCByZXZva2UgdGhlIGludml0ZS4gVGhlIHNlcnZlciBtYXkgYmUgZXhwZXJpZW5jaW5nIGEgdGVtcG9yYXJ5IHByb2JsZW0gb3IgXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJ5b3UgZG8gbm90IGhhdmUgc3VmZmljaWVudCBwZXJtaXNzaW9ucyB0byByZXZva2UgdGhlIGludml0ZS5cIixcbiAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIC8vIExvY2FsIGVjaG9cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGludml0ZWQ6IGZhbHNlIH0pO1xuICAgIH07XG5cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIGxldCBhZG1pblRvb2xzID0gbnVsbDtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuY2FuS2ljayAmJiB0aGlzLnN0YXRlLmludml0ZWQpIHtcbiAgICAgICAgICAgIGFkbWluVG9vbHMgPSAoXG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9NZW1iZXJJbmZvX2NvbnRhaW5lclwiPlxuICAgICAgICAgICAgICAgICAgICA8aDM+eyBfdChcIkFkbWluIFRvb2xzXCIpIH08L2gzPlxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X01lbWJlckluZm9fYnV0dG9uc1wiPlxuICAgICAgICAgICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b24gY2xhc3NOYW1lPVwibXhfTWVtYmVySW5mb19maWVsZFwiIG9uQ2xpY2s9e3RoaXMub25LaWNrQ2xpY2t9PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCJSZXZva2UgaW52aXRlXCIpIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj5cbiAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHNjb3BlSGVhZGVyO1xuICAgICAgICBpZiAoU3BhY2VTdG9yZS5zcGFjZXNFbmFibGVkICYmIHRoaXMucm9vbS5pc1NwYWNlUm9vbSgpKSB7XG4gICAgICAgICAgICBzY29wZUhlYWRlciA9IDxkaXYgY2xhc3NOYW1lPVwibXhfUmlnaHRQYW5lbF9zY29wZUhlYWRlclwiPlxuICAgICAgICAgICAgICAgIDxSb29tQXZhdGFyIHJvb209e3RoaXMucm9vbX0gaGVpZ2h0PXszMn0gd2lkdGg9ezMyfSAvPlxuICAgICAgICAgICAgICAgIDxSb29tTmFtZSByb29tPXt0aGlzLnJvb219IC8+XG4gICAgICAgICAgICA8L2Rpdj47XG4gICAgICAgIH1cblxuICAgICAgICAvLyBXZSBzaGFtZWxlc3NseSByaXAgb2ZmIHRoZSBNZW1iZXJJbmZvIHN0eWxlcyBoZXJlLlxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9NZW1iZXJJbmZvXCIgcm9sZT1cInRhYnBhbmVsXCI+XG4gICAgICAgICAgICAgICAgeyBzY29wZUhlYWRlciB9XG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9NZW1iZXJJbmZvX25hbWVcIj5cbiAgICAgICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b24gY2xhc3NOYW1lPVwibXhfTWVtYmVySW5mb19jYW5jZWxcIlxuICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5vbkNhbmNlbH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlPXtfdCgnQ2xvc2UnKX1cbiAgICAgICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgICAgICAgPGgyPnsgdGhpcy5zdGF0ZS5kaXNwbGF5TmFtZSB9PC9oMj5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X01lbWJlckluZm9fY29udGFpbmVyXCI+XG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfTWVtYmVySW5mb19wcm9maWxlXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X01lbWJlckluZm9fcHJvZmlsZUZpZWxkXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIkludml0ZWQgYnkgJShzZW5kZXIpc1wiLCB7IHNlbmRlcjogdGhpcy5zdGF0ZS5zZW5kZXJOYW1lIH0pIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICB7IGFkbWluVG9vbHMgfVxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICk7XG4gICAgfVxufVxuIl19