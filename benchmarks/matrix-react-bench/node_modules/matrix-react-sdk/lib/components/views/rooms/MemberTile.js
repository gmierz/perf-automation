"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _SettingsStore = _interopRequireDefault(require("../../../settings/SettingsStore"));

var _react = _interopRequireDefault(require("react"));

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var _languageHandler = require("../../../languageHandler");

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _actions = require("../../../dispatcher/actions");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _event = require("matrix-js-sdk/src/@types/event");

var _EntityTile = _interopRequireWildcard(require("./EntityTile"));

var _MemberAvatar = _interopRequireDefault(require("./../avatars/MemberAvatar"));

var _dec, _class, _class2, _temp;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

let MemberTile = (_dec = (0, _replaceableComponent.replaceableComponent)("views.rooms.MemberTile"), _dec(_class = (_temp = _class2 = class MemberTile extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "userLastModifiedTime", void 0);
    (0, _defineProperty2.default)(this, "memberLastModifiedTime", void 0);
    (0, _defineProperty2.default)(this, "onRoomStateEvents", ev => {
      if (ev.getType() !== _event.EventType.RoomEncryption) return;
      const {
        roomId
      } = this.props.member;
      if (ev.getRoomId() !== roomId) return; // The room is encrypted now.

      const cli = _MatrixClientPeg.MatrixClientPeg.get();

      cli.removeListener("RoomState.events", this.onRoomStateEvents);
      this.setState({
        isRoomEncrypted: true
      });
      this.updateE2EStatus();
    });
    (0, _defineProperty2.default)(this, "onUserTrustStatusChanged", (userId, trustStatus) => {
      if (userId !== this.props.member.userId) return;
      this.updateE2EStatus();
    });
    (0, _defineProperty2.default)(this, "onDeviceVerificationChanged", (userId, deviceId, deviceInfo) => {
      if (userId !== this.props.member.userId) return;
      this.updateE2EStatus();
    });
    (0, _defineProperty2.default)(this, "onStatusMessageCommitted", () => {
      // The `User` object has observed a status message change.
      this.setState({
        statusMessage: this.getStatusMessage()
      });
    });
    (0, _defineProperty2.default)(this, "onClick", () => {
      _dispatcher.default.dispatch({
        action: _actions.Action.ViewUser,
        member: this.props.member
      });
    });
    this.state = {
      statusMessage: this.getStatusMessage(),
      isRoomEncrypted: false,
      e2eStatus: null
    };
  }

  componentDidMount() {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    if (_SettingsStore.default.getValue("feature_custom_status")) {
      const {
        user
      } = this.props.member;

      if (user) {
        user.on("User._unstable_statusMessage", this.onStatusMessageCommitted);
      }
    }

    const {
      roomId
    } = this.props.member;

    if (roomId) {
      const isRoomEncrypted = cli.isRoomEncrypted(roomId);
      this.setState({
        isRoomEncrypted
      });

      if (isRoomEncrypted) {
        cli.on("userTrustStatusChanged", this.onUserTrustStatusChanged);
        cli.on("deviceVerificationChanged", this.onDeviceVerificationChanged);
        this.updateE2EStatus();
      } else {
        // Listen for room to become encrypted
        cli.on("RoomState.events", this.onRoomStateEvents);
      }
    }
  }

  componentWillUnmount() {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    const {
      user
    } = this.props.member;

    if (user) {
      user.removeListener("User._unstable_statusMessage", this.onStatusMessageCommitted);
    }

    if (cli) {
      cli.removeListener("RoomState.events", this.onRoomStateEvents);
      cli.removeListener("userTrustStatusChanged", this.onUserTrustStatusChanged);
      cli.removeListener("deviceVerificationChanged", this.onDeviceVerificationChanged);
    }
  }

  async updateE2EStatus() {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    const {
      userId
    } = this.props.member;
    const isMe = userId === cli.getUserId();
    const userTrust = cli.checkUserTrust(userId);

    if (!userTrust.isCrossSigningVerified()) {
      this.setState({
        e2eStatus: userTrust.wasCrossSigningVerified() ? "warning" : "normal"
      });
      return;
    }

    const devices = cli.getStoredDevicesForUser(userId);
    const anyDeviceUnverified = devices.some(device => {
      const {
        deviceId
      } = device; // For your own devices, we use the stricter check of cross-signing
      // verification to encourage everyone to trust their own devices via
      // cross-signing so that other users can then safely trust you.
      // For other people's devices, the more general verified check that
      // includes locally verified devices can be used.

      const deviceTrust = cli.checkDeviceTrust(userId, deviceId);
      return isMe ? !deviceTrust.isCrossSigningVerified() : !deviceTrust.isVerified();
    });
    this.setState({
      e2eStatus: anyDeviceUnverified ? "warning" : "verified"
    });
  }

  getStatusMessage() {
    const {
      user
    } = this.props.member;

    if (!user) {
      return "";
    }

    return user.unstable_statusMessage;
  }

  shouldComponentUpdate(nextProps, nextState) {
    if (this.memberLastModifiedTime === undefined || this.memberLastModifiedTime < nextProps.member.getLastModifiedTime()) {
      return true;
    }

    if (nextProps.member.user && (this.userLastModifiedTime === undefined || this.userLastModifiedTime < nextProps.member.user.getLastModifiedTime())) {
      return true;
    }

    if (nextState.isRoomEncrypted !== this.state.isRoomEncrypted || nextState.e2eStatus !== this.state.e2eStatus) {
      return true;
    }

    return false;
  }

  getDisplayName() {
    return this.props.member.name;
  }

  getPowerLabel() {
    return (0, _languageHandler._t)("%(userName)s (power %(powerLevelNumber)s)", {
      userName: this.props.member.userId,
      powerLevelNumber: this.props.member.powerLevel
    });
  }

  render() {
    const member = this.props.member;
    const name = this.getDisplayName();
    const presenceState = member.user ? member.user.presence : null;
    let statusMessage = null;

    if (member.user && _SettingsStore.default.getValue("feature_custom_status")) {
      statusMessage = this.state.statusMessage;
    }

    const av = /*#__PURE__*/_react.default.createElement(_MemberAvatar.default, {
      member: member,
      width: 36,
      height: 36,
      "aria-hidden": "true"
    });

    if (member.user) {
      this.userLastModifiedTime = member.user.getLastModifiedTime();
    }

    this.memberLastModifiedTime = member.getLastModifiedTime();
    const powerStatusMap = new Map([[100, _EntityTile.PowerStatus.Admin], [50, _EntityTile.PowerStatus.Moderator]]); // Find the nearest power level with a badge

    let powerLevel = this.props.member.powerLevel;

    for (const [pl] of powerStatusMap) {
      if (this.props.member.powerLevel >= pl) {
        powerLevel = pl;
        break;
      }
    }

    const powerStatus = powerStatusMap.get(powerLevel);
    let e2eStatus;

    if (this.state.isRoomEncrypted) {
      e2eStatus = this.state.e2eStatus;
    }

    return /*#__PURE__*/_react.default.createElement(_EntityTile.default, (0, _extends2.default)({}, this.props, {
      presenceState: presenceState,
      presenceLastActiveAgo: member.user ? member.user.lastActiveAgo : 0,
      presenceLastTs: member.user ? member.user.lastPresenceTs : 0,
      presenceCurrentlyActive: member.user ? member.user.currentlyActive : false,
      avatarJsx: av,
      title: this.getPowerLabel(),
      name: name,
      powerStatus: powerStatus,
      showPresence: this.props.showPresence,
      subtextLabel: statusMessage,
      e2eStatus: e2eStatus,
      onClick: this.onClick
    }));
  }

}, (0, _defineProperty2.default)(_class2, "defaultProps", {
  showPresence: true
}), _temp)) || _class);
exports.default = MemberTile;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3Jvb21zL01lbWJlclRpbGUudHN4Il0sIm5hbWVzIjpbIk1lbWJlclRpbGUiLCJSZWFjdCIsIkNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJldiIsImdldFR5cGUiLCJFdmVudFR5cGUiLCJSb29tRW5jcnlwdGlvbiIsInJvb21JZCIsIm1lbWJlciIsImdldFJvb21JZCIsImNsaSIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsInJlbW92ZUxpc3RlbmVyIiwib25Sb29tU3RhdGVFdmVudHMiLCJzZXRTdGF0ZSIsImlzUm9vbUVuY3J5cHRlZCIsInVwZGF0ZUUyRVN0YXR1cyIsInVzZXJJZCIsInRydXN0U3RhdHVzIiwiZGV2aWNlSWQiLCJkZXZpY2VJbmZvIiwic3RhdHVzTWVzc2FnZSIsImdldFN0YXR1c01lc3NhZ2UiLCJkaXMiLCJkaXNwYXRjaCIsImFjdGlvbiIsIkFjdGlvbiIsIlZpZXdVc2VyIiwic3RhdGUiLCJlMmVTdGF0dXMiLCJjb21wb25lbnREaWRNb3VudCIsIlNldHRpbmdzU3RvcmUiLCJnZXRWYWx1ZSIsInVzZXIiLCJvbiIsIm9uU3RhdHVzTWVzc2FnZUNvbW1pdHRlZCIsIm9uVXNlclRydXN0U3RhdHVzQ2hhbmdlZCIsIm9uRGV2aWNlVmVyaWZpY2F0aW9uQ2hhbmdlZCIsImNvbXBvbmVudFdpbGxVbm1vdW50IiwiaXNNZSIsImdldFVzZXJJZCIsInVzZXJUcnVzdCIsImNoZWNrVXNlclRydXN0IiwiaXNDcm9zc1NpZ25pbmdWZXJpZmllZCIsIndhc0Nyb3NzU2lnbmluZ1ZlcmlmaWVkIiwiZGV2aWNlcyIsImdldFN0b3JlZERldmljZXNGb3JVc2VyIiwiYW55RGV2aWNlVW52ZXJpZmllZCIsInNvbWUiLCJkZXZpY2UiLCJkZXZpY2VUcnVzdCIsImNoZWNrRGV2aWNlVHJ1c3QiLCJpc1ZlcmlmaWVkIiwidW5zdGFibGVfc3RhdHVzTWVzc2FnZSIsInNob3VsZENvbXBvbmVudFVwZGF0ZSIsIm5leHRQcm9wcyIsIm5leHRTdGF0ZSIsIm1lbWJlckxhc3RNb2RpZmllZFRpbWUiLCJ1bmRlZmluZWQiLCJnZXRMYXN0TW9kaWZpZWRUaW1lIiwidXNlckxhc3RNb2RpZmllZFRpbWUiLCJnZXREaXNwbGF5TmFtZSIsIm5hbWUiLCJnZXRQb3dlckxhYmVsIiwidXNlck5hbWUiLCJwb3dlckxldmVsTnVtYmVyIiwicG93ZXJMZXZlbCIsInJlbmRlciIsInByZXNlbmNlU3RhdGUiLCJwcmVzZW5jZSIsImF2IiwicG93ZXJTdGF0dXNNYXAiLCJNYXAiLCJQb3dlclN0YXR1cyIsIkFkbWluIiwiTW9kZXJhdG9yIiwicGwiLCJwb3dlclN0YXR1cyIsImxhc3RBY3RpdmVBZ28iLCJsYXN0UHJlc2VuY2VUcyIsImN1cnJlbnRseUFjdGl2ZSIsInNob3dQcmVzZW5jZSIsIm9uQ2xpY2siXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFpQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0E7O0FBRUE7O0FBQ0E7Ozs7Ozs7O0lBY3FCQSxVLFdBRHBCLGdEQUFxQix3QkFBckIsQyxtQ0FBRCxNQUNxQkEsVUFEckIsU0FDd0NDLGVBQU1DLFNBRDlDLENBQ3dFO0FBUXBFQyxFQUFBQSxXQUFXLENBQUNDLEtBQUQsRUFBUTtBQUNmLFVBQU1BLEtBQU47QUFEZTtBQUFBO0FBQUEsNkRBdURVQyxFQUFELElBQTJCO0FBQ25ELFVBQUlBLEVBQUUsQ0FBQ0MsT0FBSCxPQUFpQkMsaUJBQVVDLGNBQS9CLEVBQStDO0FBQy9DLFlBQU07QUFBRUMsUUFBQUE7QUFBRixVQUFhLEtBQUtMLEtBQUwsQ0FBV00sTUFBOUI7QUFDQSxVQUFJTCxFQUFFLENBQUNNLFNBQUgsT0FBbUJGLE1BQXZCLEVBQStCLE9BSG9CLENBS25EOztBQUNBLFlBQU1HLEdBQUcsR0FBR0MsaUNBQWdCQyxHQUFoQixFQUFaOztBQUNBRixNQUFBQSxHQUFHLENBQUNHLGNBQUosQ0FBbUIsa0JBQW5C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RUFBRSxLQUFLcUQ7QUFibEIsT0FESjtBQWlCSDs7QUFwT21FLEMseURBSTlDO0FBQ2xCRCxFQUFBQSxZQUFZLEVBQUU7QUFESSxDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE1LCAyMDE2IE9wZW5NYXJrZXQgTHRkXG5Db3B5cmlnaHQgMjAxOSwgMjAyMCBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBTZXR0aW5nc1N0b3JlIGZyb20gXCIuLi8uLi8uLi9zZXR0aW5ncy9TZXR0aW5nc1N0b3JlXCI7XG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IGRpcyBmcm9tIFwiLi4vLi4vLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyXCI7XG5pbXBvcnQgeyBfdCB9IGZyb20gJy4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlcic7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tIFwiLi4vLi4vLi4vTWF0cml4Q2xpZW50UGVnXCI7XG5pbXBvcnQgeyBBY3Rpb24gfSBmcm9tIFwiLi4vLi4vLi4vZGlzcGF0Y2hlci9hY3Rpb25zXCI7XG5pbXBvcnQgeyByZXBsYWNlYWJsZUNvbXBvbmVudCB9IGZyb20gXCIuLi8uLi8uLi91dGlscy9yZXBsYWNlYWJsZUNvbXBvbmVudFwiO1xuaW1wb3J0IHsgUm9vbU1lbWJlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvcm9vbS1tZW1iZXJcIjtcbmltcG9ydCB7IE1hdHJpeEV2ZW50IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9ldmVudFwiO1xuaW1wb3J0IHsgRXZlbnRUeXBlIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL0B0eXBlcy9ldmVudFwiO1xuaW1wb3J0IHsgRGV2aWNlSW5mbyB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9jcnlwdG8vZGV2aWNlaW5mb1wiO1xuaW1wb3J0IEVudGl0eVRpbGUsIHsgUG93ZXJTdGF0dXMgfSBmcm9tIFwiLi9FbnRpdHlUaWxlXCI7XG5pbXBvcnQgTWVtYmVyQXZhdGFyIGZyb20gXCIuLy4uL2F2YXRhcnMvTWVtYmVyQXZhdGFyXCI7XG5cbmludGVyZmFjZSBJUHJvcHMge1xuICAgIG1lbWJlcjogUm9vbU1lbWJlcjtcbiAgICBzaG93UHJlc2VuY2U/OiBib29sZWFuO1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBzdGF0dXNNZXNzYWdlOiBzdHJpbmc7XG4gICAgaXNSb29tRW5jcnlwdGVkOiBib29sZWFuO1xuICAgIGUyZVN0YXR1czogc3RyaW5nO1xufVxuXG5AcmVwbGFjZWFibGVDb21wb25lbnQoXCJ2aWV3cy5yb29tcy5NZW1iZXJUaWxlXCIpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBNZW1iZXJUaWxlIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PElQcm9wcywgSVN0YXRlPiB7XG4gICAgcHJpdmF0ZSB1c2VyTGFzdE1vZGlmaWVkVGltZTogbnVtYmVyO1xuICAgIHByaXZhdGUgbWVtYmVyTGFzdE1vZGlmaWVkVGltZTogbnVtYmVyO1xuXG4gICAgc3RhdGljIGRlZmF1bHRQcm9wcyA9IHtcbiAgICAgICAgc2hvd1ByZXNlbmNlOiB0cnVlLFxuICAgIH07XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG5cbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIHN0YXR1c01lc3NhZ2U6IHRoaXMuZ2V0U3RhdHVzTWVzc2FnZSgpLFxuICAgICAgICAgICAgaXNSb29tRW5jcnlwdGVkOiBmYWxzZSxcbiAgICAgICAgICAgIGUyZVN0YXR1czogbnVsbCxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICAgICAgY29uc3QgY2xpID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuXG4gICAgICAgIGlmIChTZXR0aW5nc1N0b3JlLmdldFZhbHVlKFwiZmVhdHVyZV9jdXN0b21fc3RhdHVzXCIpKSB7XG4gICAgICAgICAgICBjb25zdCB7IHVzZXIgfSA9IHRoaXMucHJvcHMubWVtYmVyO1xuICAgICAgICAgICAgaWYgKHVzZXIpIHtcbiAgICAgICAgICAgICAgICB1c2VyLm9uKFwiVXNlci5fdW5zdGFibGVfc3RhdHVzTWVzc2FnZVwiLCB0aGlzLm9uU3RhdHVzTWVzc2FnZUNvbW1pdHRlZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB7IHJvb21JZCB9ID0gdGhpcy5wcm9wcy5tZW1iZXI7XG4gICAgICAgIGlmIChyb29tSWQpIHtcbiAgICAgICAgICAgIGNvbnN0IGlzUm9vbUVuY3J5cHRlZCA9IGNsaS5pc1Jvb21FbmNyeXB0ZWQocm9vbUlkKTtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgIGlzUm9vbUVuY3J5cHRlZCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgaWYgKGlzUm9vbUVuY3J5cHRlZCkge1xuICAgICAgICAgICAgICAgIGNsaS5vbihcInVzZXJUcnVzdFN0YXR1c0NoYW5nZWRcIiwgdGhpcy5vblVzZXJUcnVzdFN0YXR1c0NoYW5nZWQpO1xuICAgICAgICAgICAgICAgIGNsaS5vbihcImRldmljZVZlcmlmaWNhdGlvbkNoYW5nZWRcIiwgdGhpcy5vbkRldmljZVZlcmlmaWNhdGlvbkNoYW5nZWQpO1xuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlRTJFU3RhdHVzKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIExpc3RlbiBmb3Igcm9vbSB0byBiZWNvbWUgZW5jcnlwdGVkXG4gICAgICAgICAgICAgICAgY2xpLm9uKFwiUm9vbVN0YXRlLmV2ZW50c1wiLCB0aGlzLm9uUm9vbVN0YXRlRXZlbnRzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgICBjb25zdCBjbGkgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG5cbiAgICAgICAgY29uc3QgeyB1c2VyIH0gPSB0aGlzLnByb3BzLm1lbWJlcjtcbiAgICAgICAgaWYgKHVzZXIpIHtcbiAgICAgICAgICAgIHVzZXIucmVtb3ZlTGlzdGVuZXIoXG4gICAgICAgICAgICAgICAgXCJVc2VyLl91bnN0YWJsZV9zdGF0dXNNZXNzYWdlXCIsXG4gICAgICAgICAgICAgICAgdGhpcy5vblN0YXR1c01lc3NhZ2VDb21taXR0ZWQsXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNsaSkge1xuICAgICAgICAgICAgY2xpLnJlbW92ZUxpc3RlbmVyKFwiUm9vbVN0YXRlLmV2ZW50c1wiLCB0aGlzLm9uUm9vbVN0YXRlRXZlbnRzKTtcbiAgICAgICAgICAgIGNsaS5yZW1vdmVMaXN0ZW5lcihcInVzZXJUcnVzdFN0YXR1c0NoYW5nZWRcIiwgdGhpcy5vblVzZXJUcnVzdFN0YXR1c0NoYW5nZWQpO1xuICAgICAgICAgICAgY2xpLnJlbW92ZUxpc3RlbmVyKFwiZGV2aWNlVmVyaWZpY2F0aW9uQ2hhbmdlZFwiLCB0aGlzLm9uRGV2aWNlVmVyaWZpY2F0aW9uQ2hhbmdlZCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIG9uUm9vbVN0YXRlRXZlbnRzID0gKGV2OiBNYXRyaXhFdmVudCk6IHZvaWQgPT4ge1xuICAgICAgICBpZiAoZXYuZ2V0VHlwZSgpICE9PSBFdmVudFR5cGUuUm9vbUVuY3J5cHRpb24pIHJldHVybjtcbiAgICAgICAgY29uc3QgeyByb29tSWQgfSA9IHRoaXMucHJvcHMubWVtYmVyO1xuICAgICAgICBpZiAoZXYuZ2V0Um9vbUlkKCkgIT09IHJvb21JZCkgcmV0dXJuO1xuXG4gICAgICAgIC8vIFRoZSByb29tIGlzIGVuY3J5cHRlZCBub3cuXG4gICAgICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICAgICAgY2xpLnJlbW92ZUxpc3RlbmVyKFwiUm9vbVN0YXRlLmV2ZW50c1wiLCB0aGlzLm9uUm9vbVN0YXRlRXZlbnRzKTtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBpc1Jvb21FbmNyeXB0ZWQ6IHRydWUsXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnVwZGF0ZUUyRVN0YXR1cygpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uVXNlclRydXN0U3RhdHVzQ2hhbmdlZCA9ICh1c2VySWQ6IHN0cmluZywgdHJ1c3RTdGF0dXM6IHN0cmluZyk6IHZvaWQgPT4ge1xuICAgICAgICBpZiAodXNlcklkICE9PSB0aGlzLnByb3BzLm1lbWJlci51c2VySWQpIHJldHVybjtcbiAgICAgICAgdGhpcy51cGRhdGVFMkVTdGF0dXMoKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkRldmljZVZlcmlmaWNhdGlvbkNoYW5nZWQgPSAodXNlcklkOiBzdHJpbmcsIGRldmljZUlkOiBzdHJpbmcsIGRldmljZUluZm86IERldmljZUluZm8pOiB2b2lkID0+IHtcbiAgICAgICAgaWYgKHVzZXJJZCAhPT0gdGhpcy5wcm9wcy5tZW1iZXIudXNlcklkKSByZXR1cm47XG4gICAgICAgIHRoaXMudXBkYXRlRTJFU3RhdHVzKCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgYXN5bmMgdXBkYXRlRTJFU3RhdHVzKCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBjb25zdCBjbGkgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIGNvbnN0IHsgdXNlcklkIH0gPSB0aGlzLnByb3BzLm1lbWJlcjtcbiAgICAgICAgY29uc3QgaXNNZSA9IHVzZXJJZCA9PT0gY2xpLmdldFVzZXJJZCgpO1xuICAgICAgICBjb25zdCB1c2VyVHJ1c3QgPSBjbGkuY2hlY2tVc2VyVHJ1c3QodXNlcklkKTtcbiAgICAgICAgaWYgKCF1c2VyVHJ1c3QuaXNDcm9zc1NpZ25pbmdWZXJpZmllZCgpKSB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICBlMmVTdGF0dXM6IHVzZXJUcnVzdC53YXNDcm9zc1NpZ25pbmdWZXJpZmllZCgpID8gXCJ3YXJuaW5nXCIgOiBcIm5vcm1hbFwiLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBkZXZpY2VzID0gY2xpLmdldFN0b3JlZERldmljZXNGb3JVc2VyKHVzZXJJZCk7XG4gICAgICAgIGNvbnN0IGFueURldmljZVVudmVyaWZpZWQgPSBkZXZpY2VzLnNvbWUoZGV2aWNlID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHsgZGV2aWNlSWQgfSA9IGRldmljZTtcbiAgICAgICAgICAgIC8vIEZvciB5b3VyIG93biBkZXZpY2VzLCB3ZSB1c2UgdGhlIHN0cmljdGVyIGNoZWNrIG9mIGNyb3NzLXNpZ25pbmdcbiAgICAgICAgICAgIC8vIHZlcmlmaWNhdGlvbiB0byBlbmNvdXJhZ2UgZXZlcnlvbmUgdG8gdHJ1c3QgdGhlaXIgb3duIGRldmljZXMgdmlhXG4gICAgICAgICAgICAvLyBjcm9zcy1zaWduaW5nIHNvIHRoYXQgb3RoZXIgdXNlcnMgY2FuIHRoZW4gc2FmZWx5IHRydXN0IHlvdS5cbiAgICAgICAgICAgIC8vIEZvciBvdGhlciBwZW9wbGUncyBkZXZpY2VzLCB0aGUgbW9yZSBnZW5lcmFsIHZlcmlmaWVkIGNoZWNrIHRoYXRcbiAgICAgICAgICAgIC8vIGluY2x1ZGVzIGxvY2FsbHkgdmVyaWZpZWQgZGV2aWNlcyBjYW4gYmUgdXNlZC5cbiAgICAgICAgICAgIGNvbnN0IGRldmljZVRydXN0ID0gY2xpLmNoZWNrRGV2aWNlVHJ1c3QodXNlcklkLCBkZXZpY2VJZCk7XG4gICAgICAgICAgICByZXR1cm4gaXNNZSA/ICFkZXZpY2VUcnVzdC5pc0Nyb3NzU2lnbmluZ1ZlcmlmaWVkKCkgOiAhZGV2aWNlVHJ1c3QuaXNWZXJpZmllZCgpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBlMmVTdGF0dXM6IGFueURldmljZVVudmVyaWZpZWQgPyBcIndhcm5pbmdcIiA6IFwidmVyaWZpZWRcIixcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRTdGF0dXNNZXNzYWdlKCk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IHsgdXNlciB9ID0gdGhpcy5wcm9wcy5tZW1iZXI7XG4gICAgICAgIGlmICghdXNlcikge1xuICAgICAgICAgICAgcmV0dXJuIFwiXCI7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHVzZXIudW5zdGFibGVfc3RhdHVzTWVzc2FnZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uU3RhdHVzTWVzc2FnZUNvbW1pdHRlZCA9ICgpOiB2b2lkID0+IHtcbiAgICAgICAgLy8gVGhlIGBVc2VyYCBvYmplY3QgaGFzIG9ic2VydmVkIGEgc3RhdHVzIG1lc3NhZ2UgY2hhbmdlLlxuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIHN0YXR1c01lc3NhZ2U6IHRoaXMuZ2V0U3RhdHVzTWVzc2FnZSgpLFxuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgc2hvdWxkQ29tcG9uZW50VXBkYXRlKG5leHRQcm9wczogSVByb3BzLCBuZXh0U3RhdGU6IElTdGF0ZSk6IGJvb2xlYW4ge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgICB0aGlzLm1lbWJlckxhc3RNb2RpZmllZFRpbWUgPT09IHVuZGVmaW5lZCB8fFxuICAgICAgICAgICAgdGhpcy5tZW1iZXJMYXN0TW9kaWZpZWRUaW1lIDwgbmV4dFByb3BzLm1lbWJlci5nZXRMYXN0TW9kaWZpZWRUaW1lKClcbiAgICAgICAgKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoXG4gICAgICAgICAgICBuZXh0UHJvcHMubWVtYmVyLnVzZXIgJiZcbiAgICAgICAgICAgICh0aGlzLnVzZXJMYXN0TW9kaWZpZWRUaW1lID09PSB1bmRlZmluZWQgfHxcbiAgICAgICAgICAgIHRoaXMudXNlckxhc3RNb2RpZmllZFRpbWUgPCBuZXh0UHJvcHMubWVtYmVyLnVzZXIuZ2V0TGFzdE1vZGlmaWVkVGltZSgpKVxuICAgICAgICApIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChcbiAgICAgICAgICAgIG5leHRTdGF0ZS5pc1Jvb21FbmNyeXB0ZWQgIT09IHRoaXMuc3RhdGUuaXNSb29tRW5jcnlwdGVkIHx8XG4gICAgICAgICAgICBuZXh0U3RhdGUuZTJlU3RhdHVzICE9PSB0aGlzLnN0YXRlLmUyZVN0YXR1c1xuICAgICAgICApIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uQ2xpY2sgPSAoKTogdm9pZCA9PiB7XG4gICAgICAgIGRpcy5kaXNwYXRjaCh7XG4gICAgICAgICAgICBhY3Rpb246IEFjdGlvbi5WaWV3VXNlcixcbiAgICAgICAgICAgIG1lbWJlcjogdGhpcy5wcm9wcy5tZW1iZXIsXG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIGdldERpc3BsYXlOYW1lKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLnByb3BzLm1lbWJlci5uYW1lO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0UG93ZXJMYWJlbCgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gX3QoXCIlKHVzZXJOYW1lKXMgKHBvd2VyICUocG93ZXJMZXZlbE51bWJlcilzKVwiLCB7XG4gICAgICAgICAgICB1c2VyTmFtZTogdGhpcy5wcm9wcy5tZW1iZXIudXNlcklkLFxuICAgICAgICAgICAgcG93ZXJMZXZlbE51bWJlcjogdGhpcy5wcm9wcy5tZW1iZXIucG93ZXJMZXZlbCxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCBtZW1iZXIgPSB0aGlzLnByb3BzLm1lbWJlcjtcbiAgICAgICAgY29uc3QgbmFtZSA9IHRoaXMuZ2V0RGlzcGxheU5hbWUoKTtcbiAgICAgICAgY29uc3QgcHJlc2VuY2VTdGF0ZSA9IG1lbWJlci51c2VyID8gbWVtYmVyLnVzZXIucHJlc2VuY2UgOiBudWxsO1xuXG4gICAgICAgIGxldCBzdGF0dXNNZXNzYWdlID0gbnVsbDtcbiAgICAgICAgaWYgKG1lbWJlci51c2VyICYmIFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJmZWF0dXJlX2N1c3RvbV9zdGF0dXNcIikpIHtcbiAgICAgICAgICAgIHN0YXR1c01lc3NhZ2UgPSB0aGlzLnN0YXRlLnN0YXR1c01lc3NhZ2U7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBhdiA9IChcbiAgICAgICAgICAgIDxNZW1iZXJBdmF0YXIgbWVtYmVyPXttZW1iZXJ9IHdpZHRoPXszNn0gaGVpZ2h0PXszNn0gYXJpYS1oaWRkZW49XCJ0cnVlXCIgLz5cbiAgICAgICAgKTtcblxuICAgICAgICBpZiAobWVtYmVyLnVzZXIpIHtcbiAgICAgICAgICAgIHRoaXMudXNlckxhc3RNb2RpZmllZFRpbWUgPSBtZW1iZXIudXNlci5nZXRMYXN0TW9kaWZpZWRUaW1lKCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5tZW1iZXJMYXN0TW9kaWZpZWRUaW1lID0gbWVtYmVyLmdldExhc3RNb2RpZmllZFRpbWUoKTtcblxuICAgICAgICBjb25zdCBwb3dlclN0YXR1c01hcCA9IG5ldyBNYXAoW1xuICAgICAgICAgICAgWzEwMCwgUG93ZXJTdGF0dXMuQWRtaW5dLFxuICAgICAgICAgICAgWzUwLCBQb3dlclN0YXR1cy5Nb2RlcmF0b3JdLFxuICAgICAgICBdKTtcblxuICAgICAgICAvLyBGaW5kIHRoZSBuZWFyZXN0IHBvd2VyIGxldmVsIHdpdGggYSBiYWRnZVxuICAgICAgICBsZXQgcG93ZXJMZXZlbCA9IHRoaXMucHJvcHMubWVtYmVyLnBvd2VyTGV2ZWw7XG4gICAgICAgIGZvciAoY29uc3QgW3BsXSBvZiBwb3dlclN0YXR1c01hcCkge1xuICAgICAgICAgICAgaWYgKHRoaXMucHJvcHMubWVtYmVyLnBvd2VyTGV2ZWwgPj0gcGwpIHtcbiAgICAgICAgICAgICAgICBwb3dlckxldmVsID0gcGw7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwb3dlclN0YXR1cyA9IHBvd2VyU3RhdHVzTWFwLmdldChwb3dlckxldmVsKTtcblxuICAgICAgICBsZXQgZTJlU3RhdHVzO1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5pc1Jvb21FbmNyeXB0ZWQpIHtcbiAgICAgICAgICAgIGUyZVN0YXR1cyA9IHRoaXMuc3RhdGUuZTJlU3RhdHVzO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxFbnRpdHlUaWxlXG4gICAgICAgICAgICAgICAgey4uLnRoaXMucHJvcHN9XG4gICAgICAgICAgICAgICAgcHJlc2VuY2VTdGF0ZT17cHJlc2VuY2VTdGF0ZX1cbiAgICAgICAgICAgICAgICBwcmVzZW5jZUxhc3RBY3RpdmVBZ289e21lbWJlci51c2VyID8gbWVtYmVyLnVzZXIubGFzdEFjdGl2ZUFnbyA6IDB9XG4gICAgICAgICAgICAgICAgcHJlc2VuY2VMYXN0VHM9e21lbWJlci51c2VyID8gbWVtYmVyLnVzZXIubGFzdFByZXNlbmNlVHMgOiAwfVxuICAgICAgICAgICAgICAgIHByZXNlbmNlQ3VycmVudGx5QWN0aXZlPXttZW1iZXIudXNlciA/IG1lbWJlci51c2VyLmN1cnJlbnRseUFjdGl2ZSA6IGZhbHNlfVxuICAgICAgICAgICAgICAgIGF2YXRhckpzeD17YXZ9XG4gICAgICAgICAgICAgICAgdGl0bGU9e3RoaXMuZ2V0UG93ZXJMYWJlbCgpfVxuICAgICAgICAgICAgICAgIG5hbWU9e25hbWV9XG4gICAgICAgICAgICAgICAgcG93ZXJTdGF0dXM9e3Bvd2VyU3RhdHVzfVxuICAgICAgICAgICAgICAgIHNob3dQcmVzZW5jZT17dGhpcy5wcm9wcy5zaG93UHJlc2VuY2V9XG4gICAgICAgICAgICAgICAgc3VidGV4dExhYmVsPXtzdGF0dXNNZXNzYWdlfVxuICAgICAgICAgICAgICAgIGUyZVN0YXR1cz17ZTJlU3RhdHVzfVxuICAgICAgICAgICAgICAgIG9uQ2xpY2s9e3RoaXMub25DbGlja31cbiAgICAgICAgICAgIC8+XG4gICAgICAgICk7XG4gICAgfVxufVxuIl19