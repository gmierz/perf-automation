"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _AccessibleTooltipButton = _interopRequireDefault(require("../elements/AccessibleTooltipButton"));

var _languageHandler = require("../../../languageHandler");

var _react = _interopRequireDefault(require("react"));

var _VoiceRecording = require("../../../audio/VoiceRecording");

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _LiveRecordingWaveform = _interopRequireDefault(require("../audio_messages/LiveRecordingWaveform"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _LiveRecordingClock = _interopRequireDefault(require("../audio_messages/LiveRecordingClock"));

var _VoiceRecordingStore = require("../../../stores/VoiceRecordingStore");

var _AsyncStore = require("../../../stores/AsyncStore");

var _RecordingPlayback = _interopRequireDefault(require("../audio_messages/RecordingPlayback"));

var _event = require("matrix-js-sdk/src/@types/event");

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _ErrorDialog = _interopRequireDefault(require("../dialogs/ErrorDialog"));

var _MediaDeviceHandler = _interopRequireWildcard(require("../../../MediaDeviceHandler"));

var _NotificationBadge = _interopRequireDefault(require("./NotificationBadge"));

var _StaticNotificationState = require("../../../stores/notifications/StaticNotificationState");

var _NotificationColor = require("../../../stores/notifications/NotificationColor");

var _InlineSpinner = _interopRequireDefault(require("../elements/InlineSpinner"));

var _PlaybackManager = require("../../../audio/PlaybackManager");

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

let VoiceRecordComposerTile = (
/**
 * Container tile for rendering the voice message recorder in the composer.
 */
_dec = (0, _replaceableComponent.replaceableComponent)("views.rooms.VoiceRecordComposerTile"), _dec(_class = class VoiceRecordComposerTile extends _react.default.PureComponent {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onCancel", async () => {
      await this.disposeRecording();
    });
    (0, _defineProperty2.default)(this, "onRecordStartEndClick", async () => {
      if (this.state.recorder) {
        await this.state.recorder.stop();
        return;
      } // The "microphone access error" dialogs are used a lot, so let's functionify them


      const accessError = () => {
        _Modal.default.createTrackedDialog('Microphone Access Error', '', _ErrorDialog.default, {
          title: (0, _languageHandler._t)("Unable to access your microphone"),
          description: /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("We were unable to access your microphone. Please check your browser settings and try again.")))
        });
      }; // Do a sanity test to ensure we're about to grab a valid microphone reference. Things might
      // change between this and recording, but at least we will have tried.


      try {
        var _devices$MediaDeviceK;

        const devices = await _MediaDeviceHandler.default.getDevices();

        if (!(devices !== null && devices !== void 0 && (_devices$MediaDeviceK = devices[_MediaDeviceHandler.MediaDeviceKindEnum.AudioInput]) !== null && _devices$MediaDeviceK !== void 0 && _devices$MediaDeviceK.length)) {
          _Modal.default.createTrackedDialog('No Microphone Error', '', _ErrorDialog.default, {
            title: (0, _languageHandler._t)("No microphone found"),
            description: /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("We didn't find a microphone on your device. Please check your settings and try again.")))
          });

          return;
        } // else we probably have a device that is good enough

      } catch (e) {
        _logger.logger.error("Error getting devices: ", e);

        accessError();
        return;
      }

      try {
        // stop any noises which might be happening
        await _PlaybackManager.PlaybackManager.instance.pauseAllExcept(null);

        const recorder = _VoiceRecordingStore.VoiceRecordingStore.instance.startRecording();

        await recorder.start(); // We don't need to remove the listener: the recorder will clean that up for us.

        recorder.on(_AsyncStore.UPDATE_EVENT, ev => {
          if (ev === _VoiceRecording.RecordingState.EndingSoon) return; // ignore this state: it has no UI purpose here

          this.setState({
            recordingPhase: ev
          });
        });
        this.setState({
          recorder,
          recordingPhase: _VoiceRecording.RecordingState.Started
        });
      } catch (e) {
        _logger.logger.error("Error starting recording: ", e);

        accessError(); // noinspection ES6MissingAwait - if this goes wrong we don't want it to affect the call stack

        _VoiceRecordingStore.VoiceRecordingStore.instance.disposeRecording();
      }
    });
    this.state = {
      recorder: null // no recording started by default

    };
  }

  async componentWillUnmount() {
    await _VoiceRecordingStore.VoiceRecordingStore.instance.disposeRecording();
  } // called by composer


  async send() {
    if (!this.state.recorder) {
      throw new Error("No recording started - cannot send anything");
    }

    await this.state.recorder.stop();
    let upload;

    try {
      upload = await this.state.recorder.upload(this.props.room.roomId);
    } catch (e) {
      _logger.logger.error("Error uploading voice message:", e); // Flag error and move on. The recording phase will be reset by the upload function.


      this.setState({
        didUploadFail: true
      });
      return; // don't dispose the recording: the user has a chance to re-upload
    }

    try {
      // noinspection ES6MissingAwait - we don't care if it fails, it'll get queued.
      _MatrixClientPeg.MatrixClientPeg.get().sendMessage(this.props.room.roomId, {
        "body": "Voice message",
        //"msgtype": "org.matrix.msc2516.voice",
        "msgtype": _event.MsgType.Audio,
        "url": upload.mxc,
        "file": upload.encrypted,
        "info": {
          duration: Math.round(this.state.recorder.durationSeconds * 1000),
          mimetype: this.state.recorder.contentType,
          size: this.state.recorder.contentLength
        },
        // MSC1767 + Ideals of MSC2516 as MSC3245
        // https://github.com/matrix-org/matrix-doc/pull/3245
        "org.matrix.msc1767.text": "Voice message",
        "org.matrix.msc1767.file": {
          url: upload.mxc,
          file: upload.encrypted,
          name: "Voice message.ogg",
          mimetype: this.state.recorder.contentType,
          size: this.state.recorder.contentLength
        },
        "org.matrix.msc1767.audio": {
          duration: Math.round(this.state.recorder.durationSeconds * 1000),
          // https://github.com/matrix-org/matrix-doc/pull/3246
          waveform: this.state.recorder.getPlayback().thumbnailWaveform.map(v => Math.round(v * 1024))
        },
        "org.matrix.msc3245.voice": {} // No content, this is a rendering hint

      });
    } catch (e) {
      _logger.logger.error("Error sending voice message:", e); // Voice message should be in the timeline at this point, so let other things take care
      // of error handling. We also shouldn't need the recording anymore, so fall through to
      // disposal.

    }

    await this.disposeRecording();
  }

  async disposeRecording() {
    await _VoiceRecordingStore.VoiceRecordingStore.instance.disposeRecording(); // Reset back to no recording, which means no phase (ie: restart component entirely)

    this.setState({
      recorder: null,
      recordingPhase: null,
      didUploadFail: false
    });
  }

  renderWaveformArea() {
    if (!this.state.recorder) return null; // no recorder means we're not recording: no waveform

    if (this.state.recordingPhase !== _VoiceRecording.RecordingState.Started) {
      return /*#__PURE__*/_react.default.createElement(_RecordingPlayback.default, {
        playback: this.state.recorder.getPlayback()
      });
    } // only other UI is the recording-in-progress UI


    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_MediaBody mx_VoiceMessagePrimaryContainer mx_VoiceRecordComposerTile_recording"
    }, /*#__PURE__*/_react.default.createElement(_LiveRecordingClock.default, {
      recorder: this.state.recorder
    }), /*#__PURE__*/_react.default.createElement(_LiveRecordingWaveform.default, {
      recorder: this.state.recorder
    }));
  }

  render() {
    if (!this.state.recordingPhase) return null;
    let stopBtn;
    let deleteButton;

    if (this.state.recordingPhase === _VoiceRecording.RecordingState.Started) {
      var _this$state$recorder;

      let tooltip = (0, _languageHandler._t)("Send voice message");

      if (!!this.state.recorder) {
        tooltip = (0, _languageHandler._t)("Stop recording");
      }

      stopBtn = /*#__PURE__*/_react.default.createElement(_AccessibleTooltipButton.default, {
        className: "mx_VoiceRecordComposerTile_stop",
        onClick: this.onRecordStartEndClick,
        title: tooltip
      });

      if (this.state.recorder && !((_this$state$recorder = this.state.recorder) !== null && _this$state$recorder !== void 0 && _this$state$recorder.isRecording)) {
        stopBtn = null;
      }
    }

    if (this.state.recorder && this.state.recordingPhase !== _VoiceRecording.RecordingState.Uploading) {
      deleteButton = /*#__PURE__*/_react.default.createElement(_AccessibleTooltipButton.default, {
        className: "mx_VoiceRecordComposerTile_delete",
        title: (0, _languageHandler._t)("Delete"),
        onClick: this.onCancel
      });
    }

    let uploadIndicator;

    if (this.state.recordingPhase === _VoiceRecording.RecordingState.Uploading) {
      uploadIndicator = /*#__PURE__*/_react.default.createElement("span", {
        className: "mx_VoiceRecordComposerTile_uploadingState"
      }, /*#__PURE__*/_react.default.createElement(_InlineSpinner.default, {
        w: 16,
        h: 16
      }));
    } else if (this.state.didUploadFail && this.state.recordingPhase === _VoiceRecording.RecordingState.Ended) {
      uploadIndicator = /*#__PURE__*/_react.default.createElement("span", {
        className: "mx_VoiceRecordComposerTile_failedState"
      }, /*#__PURE__*/_react.default.createElement("span", {
        className: "mx_VoiceRecordComposerTile_uploadState_badge"
      }, /*#__PURE__*/_react.default.createElement(_NotificationBadge.default, {
        notification: _StaticNotificationState.StaticNotificationState.forSymbol("!", _NotificationColor.NotificationColor.Red)
      })), /*#__PURE__*/_react.default.createElement("span", {
        className: "text-warning"
      }, (0, _languageHandler._t)("Failed to send")));
    }

    return /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, uploadIndicator, deleteButton, stopBtn, this.renderWaveformArea());
  }

}) || _class);
exports.default = VoiceRecordComposerTile;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3Jvb21zL1ZvaWNlUmVjb3JkQ29tcG9zZXJUaWxlLnRzeCJdLCJuYW1lcyI6WyJWb2ljZVJlY29yZENvbXBvc2VyVGlsZSIsIlJlYWN0IiwiUHVyZUNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJkaXNwb3NlUmVjb3JkaW5nIiwic3RhdGUiLCJyZWNvcmRlciIsInN0b3AiLCJhY2Nlc3NFcnJvciIsIk1vZGFsIiwiY3JlYXRlVHJhY2tlZERpYWxvZyIsIkVycm9yRGlhbG9nIiwidGl0bGUiLCJkZXNjcmlwdGlvbiIsImRldmljZXMiLCJNZWRpYURldmljZUhhbmRsZXIiLCJnZXREZXZpY2VzIiwiTWVkaWFEZXZpY2VLaW5kRW51bSIsIkF1ZGlvSW5wdXQiLCJsZW5ndGgiLCJlIiwibG9nZ2VyIiwiZXJyb3IiLCJQbGF5YmFja01hbmFnZXIiLCJpbnN0YW5jZSIsInBhdXNlQWxsRXhjZXB0IiwiVm9pY2VSZWNvcmRpbmdTdG9yZSIsInN0YXJ0UmVjb3JkaW5nIiwic3RhcnQiLCJvbiIsIlVQREFURV9FVkVOVCIsImV2IiwiUmVjb3JkaW5nU3RhdGUiLCJFbmRpbmdTb29uIiwic2V0U3RhdGUiLCJyZWNvcmRpbmdQaGFzZSIsIlN0YXJ0ZWQiLCJjb21wb25lbnRXaWxsVW5tb3VudCIsInNlbmQiLCJFcnJvciIsInVwbG9hZCIsInJvb20iLCJyb29tSWQiLCJkaWRVcGxvYWRGYWlsIiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0Iiwic2VuZE1lc3NhZ2UiLCJNc2dUeXBlIiwiQXVkaW8iLCJteGMiLCJlbmNyeXB0ZWQiLCJkdXJhdGlvbiIsIk1hdGgiLCJyb3VuZCIsImR1cmF0aW9uU2Vjb25kcyIsIm1pbWV0eXBlIiwiY29udGVudFR5cGUiLCJzaXplIiwiY29udGVudExlbmd0aCIsInVybCIsImZpbGUiLCJuYW1lIiwid2F2ZWZvcm0iLCJnZXRQbGF5YmFjayIsInRodW1ibmFpbFdhdmVmb3JtIiwibWFwIiwidiIsInJlbmRlcldhdmVmb3JtQXJlYSIsInJlbmRlciIsInN0b3BCdG4iLCJkZWxldGVCdXR0b24iLCJ0b29sdGlwIiwib25SZWNvcmRTdGFydEVuZENsaWNrIiwiaXNSZWNvcmRpbmciLCJVcGxvYWRpbmciLCJvbkNhbmNlbCIsInVwbG9hZEluZGljYXRvciIsIkVuZGVkIiwiU3RhdGljTm90aWZpY2F0aW9uU3RhdGUiLCJmb3JTeW1ib2wiLCJOb3RpZmljYXRpb25Db2xvciIsIlJlZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFnQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7Ozs7Ozs7O0lBZ0JxQkEsdUI7QUFKckI7QUFDQTtBQUNBO09BQ0MsZ0RBQXFCLHFDQUFyQixDLGdCQUFELE1BQ3FCQSx1QkFEckIsU0FDcURDLGVBQU1DLGFBRDNELENBQ3lGO0FBQzlFQyxFQUFBQSxXQUFXLENBQUNDLEtBQUQsRUFBUTtBQUN0QixVQUFNQSxLQUFOO0FBRHNCLG9EQWlGUCxZQUFZO0FBQzNCLFlBQU0sS0FBS0MsZ0JBQUwsRUFBTjtBQUNILEtBbkZ5QjtBQUFBLGlFQXFGSyxZQUFZO0FBQ3ZDLFVBQUksS0FBS0MsS0FBTCxDQUFXQyxRQUFmLEVBQXlCO0FBQ3JCLGNBQU0sS0FBS0QsS0FBTCxDQUFXQyxRQUFYLENBQW9CQyxJQUFwQixFQUFOO0FBQ0E7QUFDSCxPQUpzQyxDQU12Qzs7O0FBQ0EsWUFBTUMsV0FBVyxHQUFHLE1BQU07QUFDdEJDLHVCQUFNQyxtQkFBTixDQUEwQix5QkFBMUIsRUFBcUQsRUFBckQsRUFBeURDLG9CQUF6RCxFQUFzRTtBQUNsRUMsVUFBQUEsS0FBSyxFQUFFLHlCQUFHLGtDQUFILENBRDJEO0FBRWxFQyxVQUFBQSxXQUFXLGVBQUUseUVBQ1Qsd0NBQUsseUJBQ0QsNkZBREMs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QUNkLDZCQUFDLHNCQUFEO0FBQWUsUUFBQSxDQUFDLEVBQUUsRUFBbEI7QUFBc0IsUUFBQSxDQUFDLEVBQUU7QUFBekIsUUFEYyxDQUFsQjtBQUdILEtBSkQsTUFJTyxJQUFJLEtBQUt2RSxLQUFMLENBQVdzQyxhQUFYLElBQTRCLEtBQUt0QyxLQUFMLENBQVc4QixjQUFYLEtBQThCSCwrQkFBZTZDLEtBQTdFLEVBQW9GO0FBQ3ZGRCxNQUFBQSxlQUFlLGdCQUFHO0FBQU0sUUFBQSxTQUFTLEVBQUM7QUFBaEIsc0JBQ2Q7QUFBTSxRQUFBLFNBQVMsRUFBQztBQUFoQixzQkFFSSw2QkFBQywwQkFBRDtBQUNJLFFBQUEsWUFBWSxFQUFFRSxpREFBd0JDLFNBQXhCLENBQWtDLEdBQWxDLEVBQXVDQyxxQ0FBa0JDLEdBQXpEO0FBRGxCLFFBRkosQ0FEYyxlQU9kO0FBQU0sUUFBQSxTQUFTLEVBQUM7QUFBaEIsU0FBaUMseUJBQUcsZ0JBQUgsQ0FBakMsQ0FQYyxDQUFsQjtBQVNIOztBQUVELHdCQUFRLDREQUNGTCxlQURFLEVBRUZOLFlBRkUsRUFHRkQsT0FIRSxFQUlGLEtBQUtGLGtCQUFMLEVBSkUsQ0FBUjtBQU1IOztBQXZOb0YsQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAyMSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBBY2Nlc3NpYmxlVG9vbHRpcEJ1dHRvbiBmcm9tIFwiLi4vZWxlbWVudHMvQWNjZXNzaWJsZVRvb2x0aXBCdXR0b25cIjtcbmltcG9ydCB7IF90IH0gZnJvbSBcIi4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlclwiO1xuaW1wb3J0IFJlYWN0LCB7IFJlYWN0Tm9kZSB9IGZyb20gXCJyZWFjdFwiO1xuaW1wb3J0IHsgSVVwbG9hZCwgUmVjb3JkaW5nU3RhdGUsIFZvaWNlUmVjb3JkaW5nIH0gZnJvbSBcIi4uLy4uLy4uL2F1ZGlvL1ZvaWNlUmVjb3JkaW5nXCI7XG5pbXBvcnQgeyBSb29tIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yb29tXCI7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tIFwiLi4vLi4vLi4vTWF0cml4Q2xpZW50UGVnXCI7XG5pbXBvcnQgTGl2ZVJlY29yZGluZ1dhdmVmb3JtIGZyb20gXCIuLi9hdWRpb19tZXNzYWdlcy9MaXZlUmVjb3JkaW5nV2F2ZWZvcm1cIjtcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5pbXBvcnQgTGl2ZVJlY29yZGluZ0Nsb2NrIGZyb20gXCIuLi9hdWRpb19tZXNzYWdlcy9MaXZlUmVjb3JkaW5nQ2xvY2tcIjtcbmltcG9ydCB7IFZvaWNlUmVjb3JkaW5nU3RvcmUgfSBmcm9tIFwiLi4vLi4vLi4vc3RvcmVzL1ZvaWNlUmVjb3JkaW5nU3RvcmVcIjtcbmltcG9ydCB7IFVQREFURV9FVkVOVCB9IGZyb20gXCIuLi8uLi8uLi9zdG9yZXMvQXN5bmNTdG9yZVwiO1xuaW1wb3J0IFJlY29yZGluZ1BsYXliYWNrIGZyb20gXCIuLi9hdWRpb19tZXNzYWdlcy9SZWNvcmRpbmdQbGF5YmFja1wiO1xuaW1wb3J0IHsgTXNnVHlwZSB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9AdHlwZXMvZXZlbnRcIjtcbmltcG9ydCBNb2RhbCBmcm9tIFwiLi4vLi4vLi4vTW9kYWxcIjtcbmltcG9ydCBFcnJvckRpYWxvZyBmcm9tIFwiLi4vZGlhbG9ncy9FcnJvckRpYWxvZ1wiO1xuaW1wb3J0IE1lZGlhRGV2aWNlSGFuZGxlciwgeyBNZWRpYURldmljZUtpbmRFbnVtIH0gZnJvbSBcIi4uLy4uLy4uL01lZGlhRGV2aWNlSGFuZGxlclwiO1xuaW1wb3J0IE5vdGlmaWNhdGlvbkJhZGdlIGZyb20gXCIuL05vdGlmaWNhdGlvbkJhZGdlXCI7XG5pbXBvcnQgeyBTdGF0aWNOb3RpZmljYXRpb25TdGF0ZSB9IGZyb20gXCIuLi8uLi8uLi9zdG9yZXMvbm90aWZpY2F0aW9ucy9TdGF0aWNOb3RpZmljYXRpb25TdGF0ZVwiO1xuaW1wb3J0IHsgTm90aWZpY2F0aW9uQ29sb3IgfSBmcm9tIFwiLi4vLi4vLi4vc3RvcmVzL25vdGlmaWNhdGlvbnMvTm90aWZpY2F0aW9uQ29sb3JcIjtcbmltcG9ydCBJbmxpbmVTcGlubmVyIGZyb20gXCIuLi9lbGVtZW50cy9JbmxpbmVTcGlubmVyXCI7XG5pbXBvcnQgeyBQbGF5YmFja01hbmFnZXIgfSBmcm9tIFwiLi4vLi4vLi4vYXVkaW8vUGxheWJhY2tNYW5hZ2VyXCI7XG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcblxuaW50ZXJmYWNlIElQcm9wcyB7XG4gICAgcm9vbTogUm9vbTtcbn1cblxuaW50ZXJmYWNlIElTdGF0ZSB7XG4gICAgcmVjb3JkZXI/OiBWb2ljZVJlY29yZGluZztcbiAgICByZWNvcmRpbmdQaGFzZT86IFJlY29yZGluZ1N0YXRlO1xuICAgIGRpZFVwbG9hZEZhaWw/OiBib29sZWFuO1xufVxuXG4vKipcbiAqIENvbnRhaW5lciB0aWxlIGZvciByZW5kZXJpbmcgdGhlIHZvaWNlIG1lc3NhZ2UgcmVjb3JkZXIgaW4gdGhlIGNvbXBvc2VyLlxuICovXG5AcmVwbGFjZWFibGVDb21wb25lbnQoXCJ2aWV3cy5yb29tcy5Wb2ljZVJlY29yZENvbXBvc2VyVGlsZVwiKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVm9pY2VSZWNvcmRDb21wb3NlclRpbGUgZXh0ZW5kcyBSZWFjdC5QdXJlQ29tcG9uZW50PElQcm9wcywgSVN0YXRlPiB7XG4gICAgcHVibGljIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgcmVjb3JkZXI6IG51bGwsIC8vIG5vIHJlY29yZGluZyBzdGFydGVkIGJ5IGRlZmF1bHRcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgICAgIGF3YWl0IFZvaWNlUmVjb3JkaW5nU3RvcmUuaW5zdGFuY2UuZGlzcG9zZVJlY29yZGluZygpO1xuICAgIH1cblxuICAgIC8vIGNhbGxlZCBieSBjb21wb3NlclxuICAgIHB1YmxpYyBhc3luYyBzZW5kKCkge1xuICAgICAgICBpZiAoIXRoaXMuc3RhdGUucmVjb3JkZXIpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIk5vIHJlY29yZGluZyBzdGFydGVkIC0gY2Fubm90IHNlbmQgYW55dGhpbmdcIik7XG4gICAgICAgIH1cblxuICAgICAgICBhd2FpdCB0aGlzLnN0YXRlLnJlY29yZGVyLnN0b3AoKTtcblxuICAgICAgICBsZXQgdXBsb2FkOiBJVXBsb2FkO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdXBsb2FkID0gYXdhaXQgdGhpcy5zdGF0ZS5yZWNvcmRlci51cGxvYWQodGhpcy5wcm9wcy5yb29tLnJvb21JZCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihcIkVycm9yIHVwbG9hZGluZyB2b2ljZSBtZXNzYWdlOlwiLCBlKTtcblxuICAgICAgICAgICAgLy8gRmxhZyBlcnJvciBhbmQgbW92ZSBvbi4gVGhlIHJlY29yZGluZyBwaGFzZSB3aWxsIGJlIHJlc2V0IGJ5IHRoZSB1cGxvYWQgZnVuY3Rpb24uXG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgZGlkVXBsb2FkRmFpbDogdHJ1ZSB9KTtcblxuICAgICAgICAgICAgcmV0dXJuOyAvLyBkb24ndCBkaXNwb3NlIHRoZSByZWNvcmRpbmc6IHRoZSB1c2VyIGhhcyBhIGNoYW5jZSB0byByZS11cGxvYWRcbiAgICAgICAgfVxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICAvLyBub2luc3BlY3Rpb24gRVM2TWlzc2luZ0F3YWl0IC0gd2UgZG9uJ3QgY2FyZSBpZiBpdCBmYWlscywgaXQnbGwgZ2V0IHF1ZXVlZC5cbiAgICAgICAgICAgIE1hdHJpeENsaWVudFBlZy5nZXQoKS5zZW5kTWVzc2FnZSh0aGlzLnByb3BzLnJvb20ucm9vbUlkLCB7XG4gICAgICAgICAgICAgICAgXCJib2R5XCI6IFwiVm9pY2UgbWVzc2FnZVwiLFxuICAgICAgICAgICAgICAgIC8vXCJtc2d0eXBlXCI6IFwib3JnLm1hdHJpeC5tc2MyNTE2LnZvaWNlXCIsXG4gICAgICAgICAgICAgICAgXCJtc2d0eXBlXCI6IE1zZ1R5cGUuQXVkaW8sXG4gICAgICAgICAgICAgICAgXCJ1cmxcIjogdXBsb2FkLm14YyxcbiAgICAgICAgICAgICAgICBcImZpbGVcIjogdXBsb2FkLmVuY3J5cHRlZCxcbiAgICAgICAgICAgICAgICBcImluZm9cIjoge1xuICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogTWF0aC5yb3VuZCh0aGlzLnN0YXRlLnJlY29yZGVyLmR1cmF0aW9uU2Vjb25kcyAqIDEwMDApLFxuICAgICAgICAgICAgICAgICAgICBtaW1ldHlwZTogdGhpcy5zdGF0ZS5yZWNvcmRlci5jb250ZW50VHlwZSxcbiAgICAgICAgICAgICAgICAgICAgc2l6ZTogdGhpcy5zdGF0ZS5yZWNvcmRlci5jb250ZW50TGVuZ3RoLFxuICAgICAgICAgICAgICAgIH0sXG5cbiAgICAgICAgICAgICAgICAvLyBNU0MxNzY3ICsgSWRlYWxzIG9mIE1TQzI1MTYgYXMgTVNDMzI0NVxuICAgICAgICAgICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9tYXRyaXgtb3JnL21hdHJpeC1kb2MvcHVsbC8zMjQ1XG4gICAgICAgICAgICAgICAgXCJvcmcubWF0cml4Lm1zYzE3NjcudGV4dFwiOiBcIlZvaWNlIG1lc3NhZ2VcIixcbiAgICAgICAgICAgICAgICBcIm9yZy5tYXRyaXgubXNjMTc2Ny5maWxlXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgdXJsOiB1cGxvYWQubXhjLFxuICAgICAgICAgICAgICAgICAgICBmaWxlOiB1cGxvYWQuZW5jcnlwdGVkLFxuICAgICAgICAgICAgICAgICAgICBuYW1lOiBcIlZvaWNlIG1lc3NhZ2Uub2dnXCIsXG4gICAgICAgICAgICAgICAgICAgIG1pbWV0eXBlOiB0aGlzLnN0YXRlLnJlY29yZGVyLmNvbnRlbnRUeXBlLFxuICAgICAgICAgICAgICAgICAgICBzaXplOiB0aGlzLnN0YXRlLnJlY29yZGVyLmNvbnRlbnRMZW5ndGgsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBcIm9yZy5tYXRyaXgubXNjMTc2Ny5hdWRpb1wiOiB7XG4gICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiBNYXRoLnJvdW5kKHRoaXMuc3RhdGUucmVjb3JkZXIuZHVyYXRpb25TZWNvbmRzICogMTAwMCksXG5cbiAgICAgICAgICAgICAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL21hdHJpeC1vcmcvbWF0cml4LWRvYy9wdWxsLzMyNDZcbiAgICAgICAgICAgICAgICAgICAgd2F2ZWZvcm06IHRoaXMuc3RhdGUucmVjb3JkZXIuZ2V0UGxheWJhY2soKS50aHVtYm5haWxXYXZlZm9ybS5tYXAodiA9PiBNYXRoLnJvdW5kKHYgKiAxMDI0KSksXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBcIm9yZy5tYXRyaXgubXNjMzI0NS52b2ljZVwiOiB7fSwgLy8gTm8gY29udGVudCwgdGhpcyBpcyBhIHJlbmRlcmluZyBoaW50XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKFwiRXJyb3Igc2VuZGluZyB2b2ljZSBtZXNzYWdlOlwiLCBlKTtcblxuICAgICAgICAgICAgLy8gVm9pY2UgbWVzc2FnZSBzaG91bGQgYmUgaW4gdGhlIHRpbWVsaW5lIGF0IHRoaXMgcG9pbnQsIHNvIGxldCBvdGhlciB0aGluZ3MgdGFrZSBjYXJlXG4gICAgICAgICAgICAvLyBvZiBlcnJvciBoYW5kbGluZy4gV2UgYWxzbyBzaG91bGRuJ3QgbmVlZCB0aGUgcmVjb3JkaW5nIGFueW1vcmUsIHNvIGZhbGwgdGhyb3VnaCB0b1xuICAgICAgICAgICAgLy8gZGlzcG9zYWwuXG4gICAgICAgIH1cbiAgICAgICAgYXdhaXQgdGhpcy5kaXNwb3NlUmVjb3JkaW5nKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBkaXNwb3NlUmVjb3JkaW5nKCkge1xuICAgICAgICBhd2FpdCBWb2ljZVJlY29yZGluZ1N0b3JlLmluc3RhbmNlLmRpc3Bvc2VSZWNvcmRpbmcoKTtcblxuICAgICAgICAvLyBSZXNldCBiYWNrIHRvIG5vIHJlY29yZGluZywgd2hpY2ggbWVhbnMgbm8gcGhhc2UgKGllOiByZXN0YXJ0IGNvbXBvbmVudCBlbnRpcmVseSlcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IHJlY29yZGVyOiBudWxsLCByZWNvcmRpbmdQaGFzZTogbnVsbCwgZGlkVXBsb2FkRmFpbDogZmFsc2UgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkNhbmNlbCA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5kaXNwb3NlUmVjb3JkaW5nKCk7XG4gICAgfTtcblxuICAgIHB1YmxpYyBvblJlY29yZFN0YXJ0RW5kQ2xpY2sgPSBhc3luYyAoKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnJlY29yZGVyKSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnN0YXRlLnJlY29yZGVyLnN0b3AoKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFRoZSBcIm1pY3JvcGhvbmUgYWNjZXNzIGVycm9yXCIgZGlhbG9ncyBhcmUgdXNlZCBhIGxvdCwgc28gbGV0J3MgZnVuY3Rpb25pZnkgdGhlbVxuICAgICAgICBjb25zdCBhY2Nlc3NFcnJvciA9ICgpID0+IHtcbiAgICAgICAgICAgIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coJ01pY3JvcGhvbmUgQWNjZXNzIEVycm9yJywgJycsIEVycm9yRGlhbG9nLCB7XG4gICAgICAgICAgICAgICAgdGl0bGU6IF90KFwiVW5hYmxlIHRvIGFjY2VzcyB5b3VyIG1pY3JvcGhvbmVcIiksXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IDw+XG4gICAgICAgICAgICAgICAgICAgIDxwPnsgX3QoXG4gICAgICAgICAgICAgICAgICAgICAgICBcIldlIHdlcmUgdW5hYmxlIHRvIGFjY2VzcyB5b3VyIG1pY3JvcGhvbmUuIFBsZWFzZSBjaGVjayB5b3VyIGJyb3dzZXIgc2V0dGluZ3MgYW5kIHRyeSBhZ2Fpbi5cIixcbiAgICAgICAgICAgICAgICAgICAgKSB9PC9wPlxuICAgICAgICAgICAgICAgIDwvPixcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8vIERvIGEgc2FuaXR5IHRlc3QgdG8gZW5zdXJlIHdlJ3JlIGFib3V0IHRvIGdyYWIgYSB2YWxpZCBtaWNyb3Bob25lIHJlZmVyZW5jZS4gVGhpbmdzIG1pZ2h0XG4gICAgICAgIC8vIGNoYW5nZSBiZXR3ZWVuIHRoaXMgYW5kIHJlY29yZGluZywgYnV0IGF0IGxlYXN0IHdlIHdpbGwgaGF2ZSB0cmllZC5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGRldmljZXMgPSBhd2FpdCBNZWRpYURldmljZUhhbmRsZXIuZ2V0RGV2aWNlcygpO1xuICAgICAgICAgICAgaWYgKCFkZXZpY2VzPy5bTWVkaWFEZXZpY2VLaW5kRW51bS5BdWRpb0lucHV0XT8ubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZygnTm8gTWljcm9waG9uZSBFcnJvcicsICcnLCBFcnJvckRpYWxvZywge1xuICAgICAgICAgICAgICAgICAgICB0aXRsZTogX3QoXCJObyBtaWNyb3Bob25lIGZvdW5kXCIpLFxuICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogPD5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxwPnsgX3QoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJXZSBkaWRuJ3QgZmluZCBhIG1pY3JvcGhvbmUgb24geW91ciBkZXZpY2UuIFBsZWFzZSBjaGVjayB5b3VyIHNldHRpbmdzIGFuZCB0cnkgYWdhaW4uXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICApIH08L3A+XG4gICAgICAgICAgICAgICAgICAgIDwvPixcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBlbHNlIHdlIHByb2JhYmx5IGhhdmUgYSBkZXZpY2UgdGhhdCBpcyBnb29kIGVub3VnaFxuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoXCJFcnJvciBnZXR0aW5nIGRldmljZXM6IFwiLCBlKTtcbiAgICAgICAgICAgIGFjY2Vzc0Vycm9yKCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgLy8gc3RvcCBhbnkgbm9pc2VzIHdoaWNoIG1pZ2h0IGJlIGhhcHBlbmluZ1xuICAgICAgICAgICAgYXdhaXQgUGxheWJhY2tNYW5hZ2VyLmluc3RhbmNlLnBhdXNlQWxsRXhjZXB0KG51bGwpO1xuXG4gICAgICAgICAgICBjb25zdCByZWNvcmRlciA9IFZvaWNlUmVjb3JkaW5nU3RvcmUuaW5zdGFuY2Uuc3RhcnRSZWNvcmRpbmcoKTtcbiAgICAgICAgICAgIGF3YWl0IHJlY29yZGVyLnN0YXJ0KCk7XG5cbiAgICAgICAgICAgIC8vIFdlIGRvbid0IG5lZWQgdG8gcmVtb3ZlIHRoZSBsaXN0ZW5lcjogdGhlIHJlY29yZGVyIHdpbGwgY2xlYW4gdGhhdCB1cCBmb3IgdXMuXG4gICAgICAgICAgICByZWNvcmRlci5vbihVUERBVEVfRVZFTlQsIChldjogUmVjb3JkaW5nU3RhdGUpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXYgPT09IFJlY29yZGluZ1N0YXRlLkVuZGluZ1Nvb24pIHJldHVybjsgLy8gaWdub3JlIHRoaXMgc3RhdGU6IGl0IGhhcyBubyBVSSBwdXJwb3NlIGhlcmVcbiAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgcmVjb3JkaW5nUGhhc2U6IGV2IH0pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyByZWNvcmRlciwgcmVjb3JkaW5nUGhhc2U6IFJlY29yZGluZ1N0YXRlLlN0YXJ0ZWQgfSk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihcIkVycm9yIHN0YXJ0aW5nIHJlY29yZGluZzogXCIsIGUpO1xuICAgICAgICAgICAgYWNjZXNzRXJyb3IoKTtcblxuICAgICAgICAgICAgLy8gbm9pbnNwZWN0aW9uIEVTNk1pc3NpbmdBd2FpdCAtIGlmIHRoaXMgZ29lcyB3cm9uZyB3ZSBkb24ndCB3YW50IGl0IHRvIGFmZmVjdCB0aGUgY2FsbCBzdGFja1xuICAgICAgICAgICAgVm9pY2VSZWNvcmRpbmdTdG9yZS5pbnN0YW5jZS5kaXNwb3NlUmVjb3JkaW5nKCk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSByZW5kZXJXYXZlZm9ybUFyZWEoKTogUmVhY3ROb2RlIHtcbiAgICAgICAgaWYgKCF0aGlzLnN0YXRlLnJlY29yZGVyKSByZXR1cm4gbnVsbDsgLy8gbm8gcmVjb3JkZXIgbWVhbnMgd2UncmUgbm90IHJlY29yZGluZzogbm8gd2F2ZWZvcm1cblxuICAgICAgICBpZiAodGhpcy5zdGF0ZS5yZWNvcmRpbmdQaGFzZSAhPT0gUmVjb3JkaW5nU3RhdGUuU3RhcnRlZCkge1xuICAgICAgICAgICAgcmV0dXJuIDxSZWNvcmRpbmdQbGF5YmFjayBwbGF5YmFjaz17dGhpcy5zdGF0ZS5yZWNvcmRlci5nZXRQbGF5YmFjaygpfSAvPjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIG9ubHkgb3RoZXIgVUkgaXMgdGhlIHJlY29yZGluZy1pbi1wcm9ncmVzcyBVSVxuICAgICAgICByZXR1cm4gPGRpdiBjbGFzc05hbWU9XCJteF9NZWRpYUJvZHkgbXhfVm9pY2VNZXNzYWdlUHJpbWFyeUNvbnRhaW5lciBteF9Wb2ljZVJlY29yZENvbXBvc2VyVGlsZV9yZWNvcmRpbmdcIj5cbiAgICAgICAgICAgIDxMaXZlUmVjb3JkaW5nQ2xvY2sgcmVjb3JkZXI9e3RoaXMuc3RhdGUucmVjb3JkZXJ9IC8+XG4gICAgICAgICAgICA8TGl2ZVJlY29yZGluZ1dhdmVmb3JtIHJlY29yZGVyPXt0aGlzLnN0YXRlLnJlY29yZGVyfSAvPlxuICAgICAgICA8L2Rpdj47XG4gICAgfVxuXG4gICAgcHVibGljIHJlbmRlcigpOiBSZWFjdE5vZGUge1xuICAgICAgICBpZiAoIXRoaXMuc3RhdGUucmVjb3JkaW5nUGhhc2UpIHJldHVybiBudWxsO1xuXG4gICAgICAgIGxldCBzdG9wQnRuO1xuICAgICAgICBsZXQgZGVsZXRlQnV0dG9uO1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5yZWNvcmRpbmdQaGFzZSA9PT0gUmVjb3JkaW5nU3RhdGUuU3RhcnRlZCkge1xuICAgICAgICAgICAgbGV0IHRvb2x0aXAgPSBfdChcIlNlbmQgdm9pY2UgbWVzc2FnZVwiKTtcbiAgICAgICAgICAgIGlmICghIXRoaXMuc3RhdGUucmVjb3JkZXIpIHtcbiAgICAgICAgICAgICAgICB0b29sdGlwID0gX3QoXCJTdG9wIHJlY29yZGluZ1wiKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgc3RvcEJ0biA9IDxBY2Nlc3NpYmxlVG9vbHRpcEJ1dHRvblxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X1ZvaWNlUmVjb3JkQ29tcG9zZXJUaWxlX3N0b3BcIlxuICAgICAgICAgICAgICAgIG9uQ2xpY2s9e3RoaXMub25SZWNvcmRTdGFydEVuZENsaWNrfVxuICAgICAgICAgICAgICAgIHRpdGxlPXt0b29sdGlwfVxuICAgICAgICAgICAgLz47XG4gICAgICAgICAgICBpZiAodGhpcy5zdGF0ZS5yZWNvcmRlciAmJiAhdGhpcy5zdGF0ZS5yZWNvcmRlcj8uaXNSZWNvcmRpbmcpIHtcbiAgICAgICAgICAgICAgICBzdG9wQnRuID0gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnJlY29yZGVyICYmIHRoaXMuc3RhdGUucmVjb3JkaW5nUGhhc2UgIT09IFJlY29yZGluZ1N0YXRlLlVwbG9hZGluZykge1xuICAgICAgICAgICAgZGVsZXRlQnV0dG9uID0gPEFjY2Vzc2libGVUb29sdGlwQnV0dG9uXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lPSdteF9Wb2ljZVJlY29yZENvbXBvc2VyVGlsZV9kZWxldGUnXG4gICAgICAgICAgICAgICAgdGl0bGU9e190KFwiRGVsZXRlXCIpfVxuICAgICAgICAgICAgICAgIG9uQ2xpY2s9e3RoaXMub25DYW5jZWx9XG4gICAgICAgICAgICAvPjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCB1cGxvYWRJbmRpY2F0b3I7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnJlY29yZGluZ1BoYXNlID09PSBSZWNvcmRpbmdTdGF0ZS5VcGxvYWRpbmcpIHtcbiAgICAgICAgICAgIHVwbG9hZEluZGljYXRvciA9IDxzcGFuIGNsYXNzTmFtZT0nbXhfVm9pY2VSZWNvcmRDb21wb3NlclRpbGVfdXBsb2FkaW5nU3RhdGUnPlxuICAgICAgICAgICAgICAgIDxJbmxpbmVTcGlubmVyIHc9ezE2fSBoPXsxNn0gLz5cbiAgICAgICAgICAgIDwvc3Bhbj47XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5zdGF0ZS5kaWRVcGxvYWRGYWlsICYmIHRoaXMuc3RhdGUucmVjb3JkaW5nUGhhc2UgPT09IFJlY29yZGluZ1N0YXRlLkVuZGVkKSB7XG4gICAgICAgICAgICB1cGxvYWRJbmRpY2F0b3IgPSA8c3BhbiBjbGFzc05hbWU9J214X1ZvaWNlUmVjb3JkQ29tcG9zZXJUaWxlX2ZhaWxlZFN0YXRlJz5cbiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9J214X1ZvaWNlUmVjb3JkQ29tcG9zZXJUaWxlX3VwbG9hZFN0YXRlX2JhZGdlJz5cbiAgICAgICAgICAgICAgICAgICAgeyAvKiBOZWVkIHRvIHN0aWNrIHRoZSBiYWRnZSBpbiBhIHNwYW4gdG8gZW5zdXJlIGl0IGRvZXNuJ3QgY3JlYXRlIGEgYmxvY2sgY29tcG9uZW50ICovIH1cbiAgICAgICAgICAgICAgICAgICAgPE5vdGlmaWNhdGlvbkJhZGdlXG4gICAgICAgICAgICAgICAgICAgICAgICBub3RpZmljYXRpb249e1N0YXRpY05vdGlmaWNhdGlvblN0YXRlLmZvclN5bWJvbChcIiFcIiwgTm90aWZpY2F0aW9uQ29sb3IuUmVkKX1cbiAgICAgICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgICA8L3NwYW4+XG4gICAgICAgICAgICAgICAgPHNwYW4gY2xhc3NOYW1lPSd0ZXh0LXdhcm5pbmcnPnsgX3QoXCJGYWlsZWQgdG8gc2VuZFwiKSB9PC9zcGFuPlxuICAgICAgICAgICAgPC9zcGFuPjtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAoPD5cbiAgICAgICAgICAgIHsgdXBsb2FkSW5kaWNhdG9yIH1cbiAgICAgICAgICAgIHsgZGVsZXRlQnV0dG9uIH1cbiAgICAgICAgICAgIHsgc3RvcEJ0biB9XG4gICAgICAgICAgICB7IHRoaXMucmVuZGVyV2F2ZWZvcm1BcmVhKCkgfVxuICAgICAgICA8Lz4pO1xuICAgIH1cbn1cbiJdfQ==