"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var _classnames = _interopRequireDefault(require("classnames"));

var _languageHandler = require("../../../languageHandler");

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var _actions = require("../../../dispatcher/actions");

var _SenderProfile = _interopRequireDefault(require("../messages/SenderProfile"));

var _MImageReplyBody = _interopRequireDefault(require("../messages/MImageReplyBody"));

var sdk = _interopRequireWildcard(require("../../../index"));

var _event = require("matrix-js-sdk/src/@types/event");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _EventUtils = require("../../../utils/EventUtils");

var _MFileBody = _interopRequireDefault(require("../messages/MFileBody"));

var _MVoiceMessageBody = _interopRequireDefault(require("../messages/MVoiceMessageBody"));

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class, _class2, _temp;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

let ReplyTile = (_dec = (0, _replaceableComponent.replaceableComponent)("views.rooms.ReplyTile"), _dec(_class = (_temp = _class2 = class ReplyTile extends _react.default.PureComponent {
  constructor(...args) {
    super(...args);
    (0, _defineProperty2.default)(this, "anchorElement", /*#__PURE__*/(0, _react.createRef)());
    (0, _defineProperty2.default)(this, "onDecrypted", () => {
      this.forceUpdate();

      if (this.props.onHeightChanged) {
        this.props.onHeightChanged();
      }
    });
    (0, _defineProperty2.default)(this, "onEventRequiresUpdate", () => {
      // Force update when necessary - redactions and edits
      this.forceUpdate();
    });
    (0, _defineProperty2.default)(this, "onClick", e => {
      const clickTarget = e.target; // Following a link within a reply should not dispatch the `view_room` action
      // so that the browser can direct the user to the correct location
      // The exception being the link wrapping the reply

      if (clickTarget.tagName.toLowerCase() !== "a" || clickTarget.closest("a") === null || clickTarget === this.anchorElement.current) {
        // This allows the permalink to be opened in a new tab/window or copied as
        // matrix.to, but also for it to enable routing within Riot when clicked.
        e.preventDefault(); // Expand thread on shift key

        if (this.props.toggleExpandedQuote && e.shiftKey) {
          this.props.toggleExpandedQuote();
        } else {
          _dispatcher.default.dispatch({
            action: _actions.Action.ViewRoom,
            event_id: this.props.mxEvent.getId(),
            highlighted: true,
            room_id: this.props.mxEvent.getRoomId()
          });
        }
      }
    });
  }

  componentDidMount() {
    this.props.mxEvent.on("Event.decrypted", this.onDecrypted);
    this.props.mxEvent.on("Event.beforeRedaction", this.onEventRequiresUpdate);
    this.props.mxEvent.on("Event.replaced", this.onEventRequiresUpdate);
  }

  componentWillUnmount() {
    this.props.mxEvent.removeListener("Event.decrypted", this.onDecrypted);
    this.props.mxEvent.removeListener("Event.beforeRedaction", this.onEventRequiresUpdate);
    this.props.mxEvent.removeListener("Event.replaced", this.onEventRequiresUpdate);
  }

  render() {
    const mxEvent = this.props.mxEvent;
    const msgType = mxEvent.getContent().msgtype;
    const evType = mxEvent.getType();
    const {
      tileHandler,
      isInfoMessage
    } = (0, _EventUtils.getEventDisplayInfo)(mxEvent); // This shouldn't happen: the caller should check we support this type
    // before trying to instantiate us

    if (!tileHandler) {
      const {
        mxEvent
      } = this.props;

      _logger.logger.warn(`Event type not supported: type:${mxEvent.getType()} isState:${mxEvent.isState()}`);

      return /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_ReplyTile mx_ReplyTile_info mx_MNoticeBody"
      }, (0, _languageHandler._t)('This event could not be displayed'));
    }

    const EventTileType = sdk.getComponent(tileHandler);
    const classes = (0, _classnames.default)("mx_ReplyTile", {
      mx_ReplyTile_info: isInfoMessage && !mxEvent.isRedacted(),
      mx_ReplyTile_audio: msgType === _event.MsgType.Audio,
      mx_ReplyTile_video: msgType === _event.MsgType.Video
    });
    let permalink = "#";

    if (this.props.permalinkCreator) {
      permalink = this.props.permalinkCreator.forEvent(mxEvent.getId());
    }

    let sender;
    const needsSenderProfile = !isInfoMessage && msgType !== _event.MsgType.Image && tileHandler !== _event.EventType.RoomCreate && evType !== _event.EventType.Sticker;

    if (needsSenderProfile) {
      sender = /*#__PURE__*/_react.default.createElement(_SenderProfile.default, {
        mxEvent: mxEvent,
        enableFlair: false
      });
    }

    const msgtypeOverrides = {
      [_event.MsgType.Image]: _MImageReplyBody.default,
      // Override audio and video body with file body. We also hide the download/decrypt button using CSS
      [_event.MsgType.Audio]: (0, _EventUtils.isVoiceMessage)(mxEvent) ? _MVoiceMessageBody.default : _MFileBody.default,
      [_event.MsgType.Video]: _MFileBody.default
    };
    const evOverrides = {
      // Use MImageReplyBody so that the sticker isn't taking up a lot of space
      [_event.EventType.Sticker]: _MImageReplyBody.default
    };
    return /*#__PURE__*/_react.default.createElement("div", {
      className: classes
    }, /*#__PURE__*/_react.default.createElement("a", {
      href: permalink,
      onClick: this.onClick,
      ref: this.anchorElement
    }, sender, /*#__PURE__*/_react.default.createElement(EventTileType, {
      ref: "tile",
      mxEvent: mxEvent,
      highlights: this.props.highlights,
      highlightLink: this.props.highlightLink,
      onHeightChanged: this.props.onHeightChanged,
      showUrlPreview: false,
      overrideBodyTypes: msgtypeOverrides,
      overrideEventTypes: evOverrides,
      replacingEventId: mxEvent.replacingEventId(),
      maxImageHeight: 96
    })));
  }

}, (0, _defineProperty2.default)(_class2, "defaultProps", {
  onHeightChanged: () => {}
}), _temp)) || _class);
exports.default = ReplyTile;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3Jvb21zL1JlcGx5VGlsZS50c3giXSwibmFtZXMiOlsiUmVwbHlUaWxlIiwiUmVhY3QiLCJQdXJlQ29tcG9uZW50IiwiZm9yY2VVcGRhdGUiLCJwcm9wcyIsIm9uSGVpZ2h0Q2hhbmdlZCIsImUiLCJjbGlja1RhcmdldCIsInRhcmdldCIsInRhZ05hbWUiLCJ0b0xvd2VyQ2FzZSIsImNsb3Nlc3QiLCJhbmNob3JFbGVtZW50IiwiY3VycmVudCIsInByZXZlbnREZWZhdWx0IiwidG9nZ2xlRXhwYW5kZWRRdW90ZSIsInNoaWZ0S2V5IiwiZGlzIiwiZGlzcGF0Y2giLCJhY3Rpb24iLCJBY3Rpb24iLCJWaWV3Um9vbSIsImV2ZW50X2lkIiwibXhFdmVudCIsImdldElkIiwiaGlnaGxpZ2h0ZWQiLCJyb29tX2lkIiwiZ2V0Um9vbUlkIiwiY29tcG9uZW50RGlkTW91bnQiLCJvbiIsIm9uRGVjcnlwdGVkIiwib25FdmVudFJlcXVpcmVzVXBkYXRlIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJyZW1vdmVMaXN0ZW5lciIsInJlbmRlciIsIm1zZ1R5cGUiLCJnZXRDb250ZW50IiwibXNndHlwZSIsImV2VHlwZSIsImdldFR5cGUiLCJ0aWxlSGFuZGxlciIsImlzSW5mb01lc3NhZ2UiLCJsb2dnZXIiLCJ3YXJuIiwiaXNTdGF0ZSIsIkV2ZW50VGlsZVR5cGUiLCJzZGsiLCJnZXRDb21wb25lbnQiLCJjbGFzc2VzIiwibXhfUmVwbHlUaWxlX2luZm8iLCJpc1JlZGFjdGVkIiwibXhfUmVwbHlUaWxlX2F1ZGlvIiwiTXNnVHlwZSIsIkF1ZGlvIiwibXhfUmVwbHlUaWxlX3ZpZGVvIiwiVmlkZW8iLCJwZXJtYWxpbmsiLCJwZXJtYWxpbmtDcmVhdG9yIiwiZm9yRXZlbnQiLCJzZW5kZXIiLCJuZWVkc1NlbmRlclByb2ZpbGUiLCJJbWFnZSIsIkV2ZW50VHlwZSIsIlJvb21DcmVhdGUiLCJTdGlja2VyIiwibXNndHlwZU92ZXJyaWRlcyIsIk1JbWFnZVJlcGx5Qm9keSIsIk1Wb2ljZU1lc3NhZ2VCb2R5IiwiTUZpbGVCb2R5IiwiZXZPdmVycmlkZXMiLCJvbkNsaWNrIiwiaGlnaGxpZ2h0cyIsImhpZ2hsaWdodExpbmsiLCJyZXBsYWNpbmdFdmVudElkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWdCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7Ozs7Ozs7SUFZcUJBLFMsV0FEcEIsZ0RBQXFCLHVCQUFyQixDLG1DQUFELE1BQ3FCQSxTQURyQixTQUN1Q0MsZUFBTUMsYUFEN0MsQ0FDbUU7QUFBQTtBQUFBO0FBQUEsc0VBQ3ZDLHVCQUR1QztBQUFBLHVEQW1CekMsTUFBWTtBQUM5QixXQUFLQyxXQUFMOztBQUNBLFVBQUksS0FBS0MsS0FBTCxDQUFXQyxlQUFmLEVBQWdDO0FBQzVCLGFBQUtELEtBQUwsQ0FBV0MsZUFBWDtBQUNIO0FBQ0osS0F4QjhEO0FBQUEsaUVBMEIvQixNQUFZO0FBQ3hDO0FBQ0EsV0FBS0YsV0FBTDtBQUNILEtBN0I4RDtBQUFBLG1EQStCNUNHLENBQUQsSUFBK0I7QUFDN0MsWUFBTUMsV0FBVyxHQUFHRCxDQUFDLENBQUNFLE1BQXRCLENBRDZDLENBRTdDO0FBQ0E7QUFDQTs7QUFDQSxVQUNJRCxXQUFXLENBQUNFLE9BQVosQ0FBb0JDLFdBQXBCLE9BQXNDLEdBQXRDLElBQ0FILFdBQVcsQ0FBQ0ksT0FBWixDQUFvQixHQUFwQixNQUE2QixJQUQ3QixJQUVBSixXQUFXLEtBQUssS0FBS0ssYUFBTCxDQUFtQkMsT0FIdkMsRUFJRTtBQUNFO0FBQ0E7QUFDQVAsUUFBQUEsQ0FBQyxDQUFDUSxjQUFGLEdBSEYsQ0FJRTs7QUFDQSxZQUFJLEtBQUtWLEtBQUwsQ0FBV1csbUJBQVgsSUFBa0NULENBQUMsQ0FBQ1UsUUFBeEMsRUFBa0Q7QUFDOUMsZUFBS1osS0FBTCxDQUFXVyxtQkFBWDtB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VUksTUFBQSxjQUFjLEVBQUU7QUFWcEIsTUFGSixDQURKLENBREo7QUFrQkg7O0FBbkk4RCxDLHlEQUd6QztBQUNsQnBFLEVBQUFBLGVBQWUsRUFBRSxNQUFNLENBQUU7QUFEUCxDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDIwLTIwMjEgVHVsaXIgQXNva2FuIDx0dWxpckBtYXVuaXVtLm5ldD5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QsIHsgY3JlYXRlUmVmIH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IGNsYXNzTmFtZXMgZnJvbSAnY2xhc3NuYW1lcyc7XG5pbXBvcnQgeyBfdCB9IGZyb20gJy4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlcic7XG5pbXBvcnQgZGlzIGZyb20gJy4uLy4uLy4uL2Rpc3BhdGNoZXIvZGlzcGF0Y2hlcic7XG5pbXBvcnQgeyBBY3Rpb24gfSBmcm9tICcuLi8uLi8uLi9kaXNwYXRjaGVyL2FjdGlvbnMnO1xuaW1wb3J0IHsgTWF0cml4RXZlbnQgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL2V2ZW50XCI7XG5pbXBvcnQgeyBSb29tUGVybWFsaW5rQ3JlYXRvciB9IGZyb20gJy4uLy4uLy4uL3V0aWxzL3Blcm1hbGlua3MvUGVybWFsaW5rcyc7XG5pbXBvcnQgU2VuZGVyUHJvZmlsZSBmcm9tIFwiLi4vbWVzc2FnZXMvU2VuZGVyUHJvZmlsZVwiO1xuaW1wb3J0IE1JbWFnZVJlcGx5Qm9keSBmcm9tIFwiLi4vbWVzc2FnZXMvTUltYWdlUmVwbHlCb2R5XCI7XG5pbXBvcnQgKiBhcyBzZGsgZnJvbSAnLi4vLi4vLi4vaW5kZXgnO1xuaW1wb3J0IHsgRXZlbnRUeXBlLCBNc2dUeXBlIH0gZnJvbSAnbWF0cml4LWpzLXNkay9zcmMvQHR5cGVzL2V2ZW50JztcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSAnLi4vLi4vLi4vdXRpbHMvcmVwbGFjZWFibGVDb21wb25lbnQnO1xuaW1wb3J0IHsgZ2V0RXZlbnREaXNwbGF5SW5mbywgaXNWb2ljZU1lc3NhZ2UgfSBmcm9tICcuLi8uLi8uLi91dGlscy9FdmVudFV0aWxzJztcbmltcG9ydCBNRmlsZUJvZHkgZnJvbSBcIi4uL21lc3NhZ2VzL01GaWxlQm9keVwiO1xuaW1wb3J0IE1Wb2ljZU1lc3NhZ2VCb2R5IGZyb20gXCIuLi9tZXNzYWdlcy9NVm9pY2VNZXNzYWdlQm9keVwiO1xuXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbG9nZ2VyXCI7XG5cbmludGVyZmFjZSBJUHJvcHMge1xuICAgIG14RXZlbnQ6IE1hdHJpeEV2ZW50O1xuICAgIHBlcm1hbGlua0NyZWF0b3I/OiBSb29tUGVybWFsaW5rQ3JlYXRvcjtcbiAgICBoaWdobGlnaHRzPzogc3RyaW5nW107XG4gICAgaGlnaGxpZ2h0TGluaz86IHN0cmluZztcbiAgICBvbkhlaWdodENoYW5nZWQ/KCk6IHZvaWQ7XG4gICAgdG9nZ2xlRXhwYW5kZWRRdW90ZT86ICgpID0+IHZvaWQ7XG59XG5cbkByZXBsYWNlYWJsZUNvbXBvbmVudChcInZpZXdzLnJvb21zLlJlcGx5VGlsZVwiKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUmVwbHlUaWxlIGV4dGVuZHMgUmVhY3QuUHVyZUNvbXBvbmVudDxJUHJvcHM+IHtcbiAgICBwcml2YXRlIGFuY2hvckVsZW1lbnQgPSBjcmVhdGVSZWY8SFRNTEFuY2hvckVsZW1lbnQ+KCk7XG5cbiAgICBzdGF0aWMgZGVmYXVsdFByb3BzID0ge1xuICAgICAgICBvbkhlaWdodENoYW5nZWQ6ICgpID0+IHt9LFxuICAgIH07XG5cbiAgICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICAgICAgdGhpcy5wcm9wcy5teEV2ZW50Lm9uKFwiRXZlbnQuZGVjcnlwdGVkXCIsIHRoaXMub25EZWNyeXB0ZWQpO1xuICAgICAgICB0aGlzLnByb3BzLm14RXZlbnQub24oXCJFdmVudC5iZWZvcmVSZWRhY3Rpb25cIiwgdGhpcy5vbkV2ZW50UmVxdWlyZXNVcGRhdGUpO1xuICAgICAgICB0aGlzLnByb3BzLm14RXZlbnQub24oXCJFdmVudC5yZXBsYWNlZFwiLCB0aGlzLm9uRXZlbnRSZXF1aXJlc1VwZGF0ZSk7XG4gICAgfVxuXG4gICAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgICAgIHRoaXMucHJvcHMubXhFdmVudC5yZW1vdmVMaXN0ZW5lcihcIkV2ZW50LmRlY3J5cHRlZFwiLCB0aGlzLm9uRGVjcnlwdGVkKTtcbiAgICAgICAgdGhpcy5wcm9wcy5teEV2ZW50LnJlbW92ZUxpc3RlbmVyKFwiRXZlbnQuYmVmb3JlUmVkYWN0aW9uXCIsIHRoaXMub25FdmVudFJlcXVpcmVzVXBkYXRlKTtcbiAgICAgICAgdGhpcy5wcm9wcy5teEV2ZW50LnJlbW92ZUxpc3RlbmVyKFwiRXZlbnQucmVwbGFjZWRcIiwgdGhpcy5vbkV2ZW50UmVxdWlyZXNVcGRhdGUpO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25EZWNyeXB0ZWQgPSAoKTogdm9pZCA9PiB7XG4gICAgICAgIHRoaXMuZm9yY2VVcGRhdGUoKTtcbiAgICAgICAgaWYgKHRoaXMucHJvcHMub25IZWlnaHRDaGFuZ2VkKSB7XG4gICAgICAgICAgICB0aGlzLnByb3BzLm9uSGVpZ2h0Q2hhbmdlZCgpO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25FdmVudFJlcXVpcmVzVXBkYXRlID0gKCk6IHZvaWQgPT4ge1xuICAgICAgICAvLyBGb3JjZSB1cGRhdGUgd2hlbiBuZWNlc3NhcnkgLSByZWRhY3Rpb25zIGFuZCBlZGl0c1xuICAgICAgICB0aGlzLmZvcmNlVXBkYXRlKCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25DbGljayA9IChlOiBSZWFjdC5Nb3VzZUV2ZW50KTogdm9pZCA9PiB7XG4gICAgICAgIGNvbnN0IGNsaWNrVGFyZ2V0ID0gZS50YXJnZXQgYXMgSFRNTEVsZW1lbnQ7XG4gICAgICAgIC8vIEZvbGxvd2luZyBhIGxpbmsgd2l0aGluIGEgcmVwbHkgc2hvdWxkIG5vdCBkaXNwYXRjaCB0aGUgYHZpZXdfcm9vbWAgYWN0aW9uXG4gICAgICAgIC8vIHNvIHRoYXQgdGhlIGJyb3dzZXIgY2FuIGRpcmVjdCB0aGUgdXNlciB0byB0aGUgY29ycmVjdCBsb2NhdGlvblxuICAgICAgICAvLyBUaGUgZXhjZXB0aW9uIGJlaW5nIHRoZSBsaW5rIHdyYXBwaW5nIHRoZSByZXBseVxuICAgICAgICBpZiAoXG4gICAgICAgICAgICBjbGlja1RhcmdldC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgIT09IFwiYVwiIHx8XG4gICAgICAgICAgICBjbGlja1RhcmdldC5jbG9zZXN0KFwiYVwiKSA9PT0gbnVsbCB8fFxuICAgICAgICAgICAgY2xpY2tUYXJnZXQgPT09IHRoaXMuYW5jaG9yRWxlbWVudC5jdXJyZW50XG4gICAgICAgICkge1xuICAgICAgICAgICAgLy8gVGhpcyBhbGxvd3MgdGhlIHBlcm1hbGluayB0byBiZSBvcGVuZWQgaW4gYSBuZXcgdGFiL3dpbmRvdyBvciBjb3BpZWQgYXNcbiAgICAgICAgICAgIC8vIG1hdHJpeC50bywgYnV0IGFsc28gZm9yIGl0IHRvIGVuYWJsZSByb3V0aW5nIHdpdGhpbiBSaW90IHdoZW4gY2xpY2tlZC5cbiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIC8vIEV4cGFuZCB0aHJlYWQgb24gc2hpZnQga2V5XG4gICAgICAgICAgICBpZiAodGhpcy5wcm9wcy50b2dnbGVFeHBhbmRlZFF1b3RlICYmIGUuc2hpZnRLZXkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnByb3BzLnRvZ2dsZUV4cGFuZGVkUXVvdGUoKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZGlzLmRpc3BhdGNoKHtcbiAgICAgICAgICAgICAgICAgICAgYWN0aW9uOiBBY3Rpb24uVmlld1Jvb20sXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50X2lkOiB0aGlzLnByb3BzLm14RXZlbnQuZ2V0SWQoKSxcbiAgICAgICAgICAgICAgICAgICAgaGlnaGxpZ2h0ZWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIHJvb21faWQ6IHRoaXMucHJvcHMubXhFdmVudC5nZXRSb29tSWQoKSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG5cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIGNvbnN0IG14RXZlbnQgPSB0aGlzLnByb3BzLm14RXZlbnQ7XG4gICAgICAgIGNvbnN0IG1zZ1R5cGUgPSBteEV2ZW50LmdldENvbnRlbnQoKS5tc2d0eXBlO1xuICAgICAgICBjb25zdCBldlR5cGUgPSBteEV2ZW50LmdldFR5cGUoKSBhcyBFdmVudFR5cGU7XG5cbiAgICAgICAgY29uc3QgeyB0aWxlSGFuZGxlciwgaXNJbmZvTWVzc2FnZSB9ID0gZ2V0RXZlbnREaXNwbGF5SW5mbyhteEV2ZW50KTtcbiAgICAgICAgLy8gVGhpcyBzaG91bGRuJ3QgaGFwcGVuOiB0aGUgY2FsbGVyIHNob3VsZCBjaGVjayB3ZSBzdXBwb3J0IHRoaXMgdHlwZVxuICAgICAgICAvLyBiZWZvcmUgdHJ5aW5nIHRvIGluc3RhbnRpYXRlIHVzXG4gICAgICAgIGlmICghdGlsZUhhbmRsZXIpIHtcbiAgICAgICAgICAgIGNvbnN0IHsgbXhFdmVudCB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgICAgIGxvZ2dlci53YXJuKGBFdmVudCB0eXBlIG5vdCBzdXBwb3J0ZWQ6IHR5cGU6JHtteEV2ZW50LmdldFR5cGUoKX0gaXNTdGF0ZToke214RXZlbnQuaXNTdGF0ZSgpfWApO1xuICAgICAgICAgICAgcmV0dXJuIDxkaXYgY2xhc3NOYW1lPVwibXhfUmVwbHlUaWxlIG14X1JlcGx5VGlsZV9pbmZvIG14X01Ob3RpY2VCb2R5XCI+XG4gICAgICAgICAgICAgICAgeyBfdCgnVGhpcyBldmVudCBjb3VsZCBub3QgYmUgZGlzcGxheWVkJykgfVxuICAgICAgICAgICAgPC9kaXY+O1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgRXZlbnRUaWxlVHlwZSA9IHNkay5nZXRDb21wb25lbnQodGlsZUhhbmRsZXIpO1xuXG4gICAgICAgIGNvbnN0IGNsYXNzZXMgPSBjbGFzc05hbWVzKFwibXhfUmVwbHlUaWxlXCIsIHtcbiAgICAgICAgICAgIG14X1JlcGx5VGlsZV9pbmZvOiBpc0luZm9NZXNzYWdlICYmICFteEV2ZW50LmlzUmVkYWN0ZWQoKSxcbiAgICAgICAgICAgIG14X1JlcGx5VGlsZV9hdWRpbzogbXNnVHlwZSA9PT0gTXNnVHlwZS5BdWRpbyxcbiAgICAgICAgICAgIG14X1JlcGx5VGlsZV92aWRlbzogbXNnVHlwZSA9PT0gTXNnVHlwZS5WaWRlbyxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgbGV0IHBlcm1hbGluayA9IFwiI1wiO1xuICAgICAgICBpZiAodGhpcy5wcm9wcy5wZXJtYWxpbmtDcmVhdG9yKSB7XG4gICAgICAgICAgICBwZXJtYWxpbmsgPSB0aGlzLnByb3BzLnBlcm1hbGlua0NyZWF0b3IuZm9yRXZlbnQobXhFdmVudC5nZXRJZCgpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBzZW5kZXI7XG4gICAgICAgIGNvbnN0IG5lZWRzU2VuZGVyUHJvZmlsZSA9IChcbiAgICAgICAgICAgICFpc0luZm9NZXNzYWdlICYmXG4gICAgICAgICAgICBtc2dUeXBlICE9PSBNc2dUeXBlLkltYWdlICYmXG4gICAgICAgICAgICB0aWxlSGFuZGxlciAhPT0gRXZlbnRUeXBlLlJvb21DcmVhdGUgJiZcbiAgICAgICAgICAgIGV2VHlwZSAhPT0gRXZlbnRUeXBlLlN0aWNrZXJcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAobmVlZHNTZW5kZXJQcm9maWxlKSB7XG4gICAgICAgICAgICBzZW5kZXIgPSA8U2VuZGVyUHJvZmlsZVxuICAgICAgICAgICAgICAgIG14RXZlbnQ9e214RXZlbnR9XG4gICAgICAgICAgICAgICAgZW5hYmxlRmxhaXI9e2ZhbHNlfVxuICAgICAgICAgICAgLz47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBtc2d0eXBlT3ZlcnJpZGVzID0ge1xuICAgICAgICAgICAgW01zZ1R5cGUuSW1hZ2VdOiBNSW1hZ2VSZXBseUJvZHksXG4gICAgICAgICAgICAvLyBPdmVycmlkZSBhdWRpbyBhbmQgdmlkZW8gYm9keSB3aXRoIGZpbGUgYm9keS4gV2UgYWxzbyBoaWRlIHRoZSBkb3dubG9hZC9kZWNyeXB0IGJ1dHRvbiB1c2luZyBDU1NcbiAgICAgICAgICAgIFtNc2dUeXBlLkF1ZGlvXTogaXNWb2ljZU1lc3NhZ2UobXhFdmVudCkgPyBNVm9pY2VNZXNzYWdlQm9keSA6IE1GaWxlQm9keSxcbiAgICAgICAgICAgIFtNc2dUeXBlLlZpZGVvXTogTUZpbGVCb2R5LFxuICAgICAgICB9O1xuICAgICAgICBjb25zdCBldk92ZXJyaWRlcyA9IHtcbiAgICAgICAgICAgIC8vIFVzZSBNSW1hZ2VSZXBseUJvZHkgc28gdGhhdCB0aGUgc3RpY2tlciBpc24ndCB0YWtpbmcgdXAgYSBsb3Qgb2Ygc3BhY2VcbiAgICAgICAgICAgIFtFdmVudFR5cGUuU3RpY2tlcl06IE1JbWFnZVJlcGx5Qm9keSxcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9e2NsYXNzZXN9PlxuICAgICAgICAgICAgICAgIDxhIGhyZWY9e3Blcm1hbGlua30gb25DbGljaz17dGhpcy5vbkNsaWNrfSByZWY9e3RoaXMuYW5jaG9yRWxlbWVudH0+XG4gICAgICAgICAgICAgICAgICAgIHsgc2VuZGVyIH1cbiAgICAgICAgICAgICAgICAgICAgPEV2ZW50VGlsZVR5cGVcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlZj1cInRpbGVcIlxuICAgICAgICAgICAgICAgICAgICAgICAgbXhFdmVudD17bXhFdmVudH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGhpZ2hsaWdodHM9e3RoaXMucHJvcHMuaGlnaGxpZ2h0c31cbiAgICAgICAgICAgICAgICAgICAgICAgIGhpZ2hsaWdodExpbms9e3RoaXMucHJvcHMuaGlnaGxpZ2h0TGlua31cbiAgICAgICAgICAgICAgICAgICAgICAgIG9uSGVpZ2h0Q2hhbmdlZD17dGhpcy5wcm9wcy5vbkhlaWdodENoYW5nZWR9XG4gICAgICAgICAgICAgICAgICAgICAgICBzaG93VXJsUHJldmlldz17ZmFsc2V9XG4gICAgICAgICAgICAgICAgICAgICAgICBvdmVycmlkZUJvZHlUeXBlcz17bXNndHlwZU92ZXJyaWRlc31cbiAgICAgICAgICAgICAgICAgICAgICAgIG92ZXJyaWRlRXZlbnRUeXBlcz17ZXZPdmVycmlkZXN9XG4gICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNpbmdFdmVudElkPXtteEV2ZW50LnJlcGxhY2luZ0V2ZW50SWQoKX1cbiAgICAgICAgICAgICAgICAgICAgICAgIG1heEltYWdlSGVpZ2h0PXs5Nn0gLz5cbiAgICAgICAgICAgICAgICA8L2E+XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=