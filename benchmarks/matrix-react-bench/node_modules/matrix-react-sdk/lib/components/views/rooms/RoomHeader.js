"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _classnames = _interopRequireDefault(require("classnames"));

var _languageHandler = require("../../../languageHandler");

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _SettingsStore = _interopRequireDefault(require("../../../settings/SettingsStore"));

var _RoomHeaderButtons = _interopRequireDefault(require("../right_panel/RoomHeaderButtons"));

var _E2EIcon = _interopRequireDefault(require("./E2EIcon"));

var _DecoratedRoomAvatar = _interopRequireDefault(require("../avatars/DecoratedRoomAvatar"));

var _AccessibleTooltipButton = _interopRequireDefault(require("../elements/AccessibleTooltipButton"));

var _RoomTopic = _interopRequireDefault(require("../elements/RoomTopic"));

var _RoomName = _interopRequireDefault(require("../elements/RoomName"));

var _CallHandler = require("../../../CallHandler");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _InfoDialog = _interopRequireDefault(require("../dialogs/InfoDialog"));

var _lodash = require("lodash");

var _ContextMenu = require("../../structures/ContextMenu");

var _RoomContextMenu = _interopRequireDefault(require("../context_menus/RoomContextMenu"));

var _RoomTile = require("./RoomTile");

var _RoomNotificationStateStore = require("../../../stores/notifications/RoomNotificationStateStore");

var _NotificationState = require("../../../stores/notifications/NotificationState");

var _dec, _class, _class2, _temp;

let RoomHeader = (_dec = (0, _replaceableComponent.replaceableComponent)("views.rooms.RoomHeader"), _dec(_class = (_temp = _class2 = class RoomHeader extends _react.default.Component {
  constructor(props, context) {
    super(props, context);
    (0, _defineProperty2.default)(this, "onRoomStateEvents", (event, state) => {
      if (!this.props.room || event.getRoomId() !== this.props.room.roomId) {
        return;
      } // redisplay the room name, topic, etc.


      this.rateLimitedUpdate();
    });
    (0, _defineProperty2.default)(this, "onNotificationUpdate", () => {
      this.forceUpdate();
    });
    (0, _defineProperty2.default)(this, "rateLimitedUpdate", (0, _lodash.throttle)(() => {
      this.forceUpdate();
    }, 500, {
      leading: true,
      trailing: true
    }));
    (0, _defineProperty2.default)(this, "onContextMenuOpenClick", ev => {
      ev.preventDefault();
      ev.stopPropagation();
      const target = ev.target;
      this.setState({
        contextMenuPosition: target.getBoundingClientRect()
      });
    });
    (0, _defineProperty2.default)(this, "onContextMenuCloseClick", () => {
      this.setState({
        contextMenuPosition: null
      });
    });

    const notiStore = _RoomNotificationStateStore.RoomNotificationStateStore.instance.getRoomState(props.room);

    notiStore.on(_NotificationState.NOTIFICATION_STATE_UPDATE, this.onNotificationUpdate);
    this.state = {};
  }

  componentDidMount() {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    cli.on("RoomState.events", this.onRoomStateEvents);
  }

  componentWillUnmount() {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    if (cli) {
      cli.removeListener("RoomState.events", this.onRoomStateEvents);
    }

    const notiStore = _RoomNotificationStateStore.RoomNotificationStateStore.instance.getRoomState(this.props.room);

    notiStore.removeListener(_NotificationState.NOTIFICATION_STATE_UPDATE, this.onNotificationUpdate);
  }

  displayInfoDialogAboutScreensharing() {
    _Modal.default.createDialog(_InfoDialog.default, {
      title: (0, _languageHandler._t)("Screen sharing is here!"),
      description: (0, _languageHandler._t)("You can now share your screen by pressing the \"screen share\" " + "button during a call. You can even do this in audio calls if both sides support it!")
    });
  }

  render() {
    let searchStatus = null; // don't display the search count until the search completes and
    // gives us a valid (possibly zero) searchCount.

    if (this.props.searchInfo && this.props.searchInfo.searchCount !== undefined && this.props.searchInfo.searchCount !== null) {
      searchStatus = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_RoomHeader_searchStatus"
      }, "\xA0", (0, _languageHandler._t)("(~%(count)s results)", {
        count: this.props.searchInfo.searchCount
      }));
    } // XXX: this is a bit inefficient - we could just compare room.name for 'Empty room'...


    let settingsHint = false;
    const members = this.props.room ? this.props.room.getJoinedMembers() : undefined;

    if (members) {
      if (members.length === 1 && members[0].userId === _MatrixClientPeg.MatrixClientPeg.get().credentials.userId) {
        const nameEvent = this.props.room.currentState.getStateEvents('m.room.name', '');

        if (!nameEvent || !nameEvent.getContent().name) {
          settingsHint = true;
        }
      }
    }

    let oobName = (0, _languageHandler._t)("Join Room");

    if (this.props.oobData && this.props.oobData.name) {
      oobName = this.props.oobData.name;
    }

    let contextMenu;

    if (this.state.contextMenuPosition && this.props.room) {
      contextMenu = /*#__PURE__*/_react.default.createElement(_RoomContextMenu.default, (0, _extends2.default)({}, (0, _RoomTile.contextMenuBelow)(this.state.contextMenuPosition), {
        room: this.props.room,
        onFinished: this.onContextMenuCloseClick
      }));
    }

    const textClasses = (0, _classnames.default)('mx_RoomHeader_nametext', {
      mx_RoomHeader_settingsHint: settingsHint
    });

    const name = /*#__PURE__*/_react.default.createElement(_ContextMenu.ContextMenuTooltipButton, {
      className: "mx_RoomHeader_name",
      onClick: this.onContextMenuOpenClick,
      isExpanded: !!this.state.contextMenuPosition,
      title: (0, _languageHandler._t)("Room options")
    }, /*#__PURE__*/_react.default.createElement(_RoomName.default, {
      room: this.props.room
    }, name => {
      const roomName = name || oobName;
      return /*#__PURE__*/_react.default.createElement("div", {
        dir: "auto",
        className: textClasses,
        title: roomName
      }, roomName);
    }), this.props.room && /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_RoomHeader_chevron"
    }), contextMenu);

    const topicElement = /*#__PURE__*/_react.default.createElement(_RoomTopic.default, {
      room: this.props.room
    }, (topic, ref) => /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_RoomHeader_topic",
      ref: ref,
      title: topic,
      dir: "auto"
    }, topic));

    let roomAvatar;

    if (this.props.room) {
      roomAvatar = /*#__PURE__*/_react.default.createElement(_DecoratedRoomAvatar.default, {
        room: this.props.room,
        avatarSize: 24,
        oobData: this.props.oobData,
        viewAvatarOnClick: true
      });
    }

    const buttons = [];

    if (this.props.inRoom && _SettingsStore.default.getValue("showCallButtonsInComposer")) {
      const voiceCallButton = /*#__PURE__*/_react.default.createElement(_AccessibleTooltipButton.default, {
        className: "mx_RoomHeader_button mx_RoomHeader_voiceCallButton",
        onClick: () => this.props.onCallPlaced(_CallHandler.PlaceCallType.Voice),
        title: (0, _languageHandler._t)("Voice call"),
        key: "voice"
      });

      const videoCallButton = /*#__PURE__*/_react.default.createElement(_AccessibleTooltipButton.default, {
        className: "mx_RoomHeader_button mx_RoomHeader_videoCallButton",
        onClick: ev => ev.shiftKey ? this.displayInfoDialogAboutScreensharing() : this.props.onCallPlaced(_CallHandler.PlaceCallType.Video),
        title: (0, _languageHandler._t)("Video call"),
        key: "video"
      });

      buttons.push(voiceCallButton, videoCallButton);
    }

    if (this.props.onForgetClick) {
      const forgetButton = /*#__PURE__*/_react.default.createElement(_AccessibleTooltipButton.default, {
        className: "mx_RoomHeader_button mx_RoomHeader_forgetButton",
        onClick: this.props.onForgetClick,
        title: (0, _languageHandler._t)("Forget room"),
        key: "forget"
      });

      buttons.push(forgetButton);
    }

    if (this.props.onAppsClick) {
      const appsButton = /*#__PURE__*/_react.default.createElement(_AccessibleTooltipButton.default, {
        className: (0, _classnames.default)("mx_RoomHeader_button mx_RoomHeader_appsButton", {
          mx_RoomHeader_appsButton_highlight: this.props.appsShown
        }),
        onClick: this.props.onAppsClick,
        title: this.props.appsShown ? (0, _languageHandler._t)("Hide Widgets") : (0, _languageHandler._t)("Show Widgets"),
        key: "apps"
      });

      buttons.push(appsButton);
    }

    if (this.props.onSearchClick && this.props.inRoom) {
      const searchButton = /*#__PURE__*/_react.default.createElement(_AccessibleTooltipButton.default, {
        className: "mx_RoomHeader_button mx_RoomHeader_searchButton",
        onClick: this.props.onSearchClick,
        title: (0, _languageHandler._t)("Search"),
        key: "search"
      });

      buttons.push(searchButton);
    }

    const rightRow = /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_RoomHeader_buttons"
    }, buttons);

    const e2eIcon = this.props.e2eStatus ? /*#__PURE__*/_react.default.createElement(_E2EIcon.default, {
      status: this.props.e2eStatus
    }) : undefined;
    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_RoomHeader light-panel"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_RoomHeader_wrapper",
      "aria-owns": "mx_RightPanel"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_RoomHeader_avatar"
    }, roomAvatar), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_RoomHeader_e2eIcon"
    }, e2eIcon), name, searchStatus, topicElement, rightRow, /*#__PURE__*/_react.default.createElement(_RoomHeaderButtons.default, {
      room: this.props.room,
      excludedRightPanelPhaseButtons: this.props.excludedRightPanelPhaseButtons
    })));
  }

}, (0, _defineProperty2.default)(_class2, "defaultProps", {
  editing: false,
  inRoom: false,
  excludedRightPanelPhaseButtons: []
}), _temp)) || _class);
exports.default = RoomHeader;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3Jvb21zL1Jvb21IZWFkZXIudHN4Il0sIm5hbWVzIjpbIlJvb21IZWFkZXIiLCJSZWFjdCIsIkNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJjb250ZXh0IiwiZXZlbnQiLCJzdGF0ZSIsInJvb20iLCJnZXRSb29tSWQiLCJyb29tSWQiLCJyYXRlTGltaXRlZFVwZGF0ZSIsImZvcmNlVXBkYXRlIiwibGVhZGluZyIsInRyYWlsaW5nIiwiZXYiLCJwcmV2ZW50RGVmYXVsdCIsInN0b3BQcm9wYWdhdGlvbiIsInRhcmdldCIsInNldFN0YXRlIiwiY29udGV4dE1lbnVQb3NpdGlvbiIsImdldEJvdW5kaW5nQ2xpZW50UmVjdCIsIm5vdGlTdG9yZSIsIlJvb21Ob3RpZmljYXRpb25TdGF0ZVN0b3JlIiwiaW5zdGFuY2UiLCJnZXRSb29tU3RhdGUiLCJvbiIsIk5PVElGSUNBVElPTl9TVEFURV9VUERBVEUiLCJvbk5vdGlmaWNhdGlvblVwZGF0ZSIsImNvbXBvbmVudERpZE1vdW50IiwiY2xpIiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0Iiwib25Sb29tU3RhdGVFdmVudHMiLCJjb21wb25lbnRXaWxsVW5tb3VudCIsInJlbW92ZUxpc3RlbmVyIiwiZGlzcGxheUluZm9EaWFsb2dBYm91dFNjcmVlbnNoYXJpbmciLCJNb2RhbCIsImNyZWF0ZURpYWxvZyIsIkluZm9EaWFsb2ciLCJ0aXRsZSIsImRlc2NyaXB0aW9uIiwicmVuZGVyIiwic2VhcmNoU3RhdHVzIiwic2VhcmNoSW5mbyIsInNlYXJjaENvdW50IiwidW5kZWZpbmVkIiwiY291bnQiLCJzZXR0aW5nc0hpbnQiLCJtZW1iZXJzIiwiZ2V0Sm9pbmVkTWVtYmVycyIsImxlbmd0aCIsInVzZXJJZCIsImNyZWRlbnRpYWxzIiwibmFtZUV2ZW50IiwiY3VycmVudFN0YXRlIiwiZ2V0U3RhdGVFdmVudHMiLCJnZXRDb250ZW50IiwibmFtZSIsIm9vYk5hbWUiLCJvb2JEYXRhIiwiY29udGV4dE1lbnUiLCJvbkNvbnRleHRNZW51Q2xvc2VDbGljayIsInRleHRDbGFzc2VzIiwibXhfUm9vbUhlYWRlcl9zZXR0aW5nc0hpbnQiLCJvbkNvbnRleHRNZW51T3BlbkNsaWNrIiwicm9vbU5hbWUiLCJ0b3BpY0VsZW1lbnQiLCJ0b3BpYyIsInJlZiIsInJvb21BdmF0YXIiLCJidXR0b25zIiwiaW5Sb29tIiwiU2V0dGluZ3NTdG9yZSIsImdldFZhbHVlIiwidm9pY2VDYWxsQnV0dG9uIiwib25DYWxsUGxhY2VkIiwiUGxhY2VDYWxsVHlwZSIsIlZvaWNlIiwidmlkZW9DYWxsQnV0dG9uIiwic2hpZnRLZXkiLCJWaWRlbyIsInB1c2giLCJvbkZvcmdldENsaWNrIiwiZm9yZ2V0QnV0dG9uIiwib25BcHBzQ2xpY2siLCJhcHBzQnV0dG9uIiwibXhfUm9vbUhlYWRlcl9hcHBzQnV0dG9uX2hpZ2hsaWdodCIsImFwcHNTaG93biIsIm9uU2VhcmNoQ2xpY2siLCJzZWFyY2hCdXR0b24iLCJyaWdodFJvdyIsImUyZUljb24iLCJlMmVTdGF0dXMiLCJleGNsdWRlZFJpZ2h0UGFuZWxQaGFzZUJ1dHRvbnMiLCJlZGl0aW5nIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBaUJBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUtBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0lBNEJxQkEsVSxXQURwQixnREFBcUIsd0JBQXJCLEMsbUNBQUQsTUFDcUJBLFVBRHJCLFNBQ3dDQyxlQUFNQyxTQUQ5QyxDQUN3RTtBQU9wRUMsRUFBQUEsV0FBVyxDQUFDQyxLQUFELEVBQVFDLE9BQVIsRUFBaUI7QUFDeEIsVUFBTUQsS0FBTixFQUFhQyxPQUFiO0FBRHdCLDZEQXFCQSxDQUFDQyxLQUFELEVBQXFCQyxLQUFyQixLQUEwQztBQUNsRSxVQUFJ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LFFBQVEsZ0JBQ1Y7QUFBSyxNQUFBLFNBQVMsRUFBQztBQUFmLE9BQ01wQixPQUROLENBREo7O0FBS0EsVUFBTXFCLE9BQU8sR0FBRyxLQUFLeEYsS0FBTCxDQUFXeUYsU0FBWCxnQkFBdUIsNkJBQUMsZ0JBQUQ7QUFBUyxNQUFBLE1BQU0sRUFBRSxLQUFLekYsS0FBTCxDQUFXeUY7QUFBNUIsTUFBdkIsR0FBbUUvQyxTQUFuRjtBQUVBLHdCQUNJO0FBQUssTUFBQSxTQUFTLEVBQUM7QUFBZixvQkFDSTtBQUFLLE1BQUEsU0FBUyxFQUFDLHVCQUFmO0FBQXVDLG1CQUFVO0FBQWpELG9CQUNJO0FBQUssTUFBQSxTQUFTLEVBQUM7QUFBZixPQUF3Q3dCLFVBQXhDLENBREosZUFFSTtBQUFLLE1BQUEsU0FBUyxFQUFDO0FBQWYsT0FBeUNzQixPQUF6QyxDQUZKLEVBR01sQyxJQUhOLEVBSU1mLFlBSk4sRUFLTXdCLFlBTE4sRUFNTXdCLFFBTk4sZUFPSSw2QkFBQywwQkFBRDtBQUFtQixNQUFBLElBQUksRUFBRSxLQUFLdkYsS0FBTCxDQUFXSSxJQUFwQztBQUEwQyxNQUFBLDhCQUE4QixFQUFFLEtBQUtKLEtBQUwsQ0FBVzBGO0FBQXJGLE1BUEosQ0FESixDQURKO0FBYUg7O0FBbk5tRSxDLHlEQUM5QztBQUNsQkMsRUFBQUEsT0FBTyxFQUFFLEtBRFM7QUFFbEJ2QixFQUFBQSxNQUFNLEVBQUUsS0FGVTtBQUdsQnNCLEVBQUFBLDhCQUE4QixFQUFFO0FBSGQsQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNSwgMjAxNiBPcGVuTWFya2V0IEx0ZFxuQ29weXJpZ2h0IDIwMTksIDIwMjEgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IGNsYXNzTmFtZXMgZnJvbSAnY2xhc3NuYW1lcyc7XG5pbXBvcnQgeyBfdCB9IGZyb20gJy4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlcic7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tICcuLi8uLi8uLi9NYXRyaXhDbGllbnRQZWcnO1xuXG5pbXBvcnQgU2V0dGluZ3NTdG9yZSBmcm9tIFwiLi4vLi4vLi4vc2V0dGluZ3MvU2V0dGluZ3NTdG9yZVwiO1xuaW1wb3J0IFJvb21IZWFkZXJCdXR0b25zIGZyb20gJy4uL3JpZ2h0X3BhbmVsL1Jvb21IZWFkZXJCdXR0b25zJztcbmltcG9ydCBFMkVJY29uIGZyb20gJy4vRTJFSWNvbic7XG5pbXBvcnQgRGVjb3JhdGVkUm9vbUF2YXRhciBmcm9tIFwiLi4vYXZhdGFycy9EZWNvcmF0ZWRSb29tQXZhdGFyXCI7XG5pbXBvcnQgQWNjZXNzaWJsZVRvb2x0aXBCdXR0b24gZnJvbSBcIi4uL2VsZW1lbnRzL0FjY2Vzc2libGVUb29sdGlwQnV0dG9uXCI7XG5pbXBvcnQgUm9vbVRvcGljIGZyb20gXCIuLi9lbGVtZW50cy9Sb29tVG9waWNcIjtcbmltcG9ydCBSb29tTmFtZSBmcm9tIFwiLi4vZWxlbWVudHMvUm9vbU5hbWVcIjtcbmltcG9ydCB7IFBsYWNlQ2FsbFR5cGUgfSBmcm9tIFwiLi4vLi4vLi4vQ2FsbEhhbmRsZXJcIjtcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5pbXBvcnQgTW9kYWwgZnJvbSAnLi4vLi4vLi4vTW9kYWwnO1xuaW1wb3J0IEluZm9EaWFsb2cgZnJvbSBcIi4uL2RpYWxvZ3MvSW5mb0RpYWxvZ1wiO1xuaW1wb3J0IHsgdGhyb3R0bGUgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgTWF0cml4RXZlbnQsIFJvb20sIFJvb21TdGF0ZSB9IGZyb20gJ21hdHJpeC1qcy1zZGsvc3JjJztcbmltcG9ydCB7IEUyRVN0YXR1cyB9IGZyb20gJy4uLy4uLy4uL3V0aWxzL1NoaWVsZFV0aWxzJztcbmltcG9ydCB7IElPT0JEYXRhIH0gZnJvbSAnLi4vLi4vLi4vc3RvcmVzL1RocmVlcGlkSW52aXRlU3RvcmUnO1xuaW1wb3J0IHsgU2VhcmNoU2NvcGUgfSBmcm9tICcuL1NlYXJjaEJhcic7XG5pbXBvcnQgeyBDb250ZXh0TWVudVRvb2x0aXBCdXR0b24gfSBmcm9tICcuLi8uLi9zdHJ1Y3R1cmVzL0NvbnRleHRNZW51JztcbmltcG9ydCBSb29tQ29udGV4dE1lbnUgZnJvbSBcIi4uL2NvbnRleHRfbWVudXMvUm9vbUNvbnRleHRNZW51XCI7XG5pbXBvcnQgeyBjb250ZXh0TWVudUJlbG93IH0gZnJvbSAnLi9Sb29tVGlsZSc7XG5pbXBvcnQgeyBSb29tTm90aWZpY2F0aW9uU3RhdGVTdG9yZSB9IGZyb20gJy4uLy4uLy4uL3N0b3Jlcy9ub3RpZmljYXRpb25zL1Jvb21Ob3RpZmljYXRpb25TdGF0ZVN0b3JlJztcbmltcG9ydCB7IE5PVElGSUNBVElPTl9TVEFURV9VUERBVEUgfSBmcm9tICcuLi8uLi8uLi9zdG9yZXMvbm90aWZpY2F0aW9ucy9Ob3RpZmljYXRpb25TdGF0ZSc7XG5pbXBvcnQgeyBSaWdodFBhbmVsUGhhc2VzIH0gZnJvbSAnLi4vLi4vLi4vc3RvcmVzL1JpZ2h0UGFuZWxTdG9yZVBoYXNlcyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVNlYXJjaEluZm8ge1xuICAgIHNlYXJjaFRlcm06IHN0cmluZztcbiAgICBzZWFyY2hTY29wZTogU2VhcmNoU2NvcGU7XG4gICAgc2VhcmNoQ291bnQ6IG51bWJlcjtcbn1cblxuaW50ZXJmYWNlIElQcm9wcyB7XG4gICAgcm9vbTogUm9vbTtcbiAgICBvb2JEYXRhPzogSU9PQkRhdGE7XG4gICAgaW5Sb29tOiBib29sZWFuO1xuICAgIG9uU2VhcmNoQ2xpY2s6ICgpID0+IHZvaWQ7XG4gICAgb25Gb3JnZXRDbGljazogKCkgPT4gdm9pZDtcbiAgICBvbkNhbGxQbGFjZWQ6ICh0eXBlOiBQbGFjZUNhbGxUeXBlKSA9PiB2b2lkO1xuICAgIG9uQXBwc0NsaWNrOiAoKSA9PiB2b2lkO1xuICAgIGUyZVN0YXR1czogRTJFU3RhdHVzO1xuICAgIGFwcHNTaG93bjogYm9vbGVhbjtcbiAgICBzZWFyY2hJbmZvOiBJU2VhcmNoSW5mbztcbiAgICBleGNsdWRlZFJpZ2h0UGFuZWxQaGFzZUJ1dHRvbnM/OiBBcnJheTxSaWdodFBhbmVsUGhhc2VzPjtcbn1cblxuaW50ZXJmYWNlIElTdGF0ZSB7XG4gICAgY29udGV4dE1lbnVQb3NpdGlvbj86IERPTVJlY3Q7XG59XG5cbkByZXBsYWNlYWJsZUNvbXBvbmVudChcInZpZXdzLnJvb21zLlJvb21IZWFkZXJcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJvb21IZWFkZXIgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8SVByb3BzLCBJU3RhdGU+IHtcbiAgICBzdGF0aWMgZGVmYXVsdFByb3BzID0ge1xuICAgICAgICBlZGl0aW5nOiBmYWxzZSxcbiAgICAgICAgaW5Sb29tOiBmYWxzZSxcbiAgICAgICAgZXhjbHVkZWRSaWdodFBhbmVsUGhhc2VCdXR0b25zOiBbXSxcbiAgICB9O1xuXG4gICAgY29uc3RydWN0b3IocHJvcHMsIGNvbnRleHQpIHtcbiAgICAgICAgc3VwZXIocHJvcHMsIGNvbnRleHQpO1xuICAgICAgICBjb25zdCBub3RpU3RvcmUgPSBSb29tTm90aWZpY2F0aW9uU3RhdGVTdG9yZS5pbnN0YW5jZS5nZXRSb29tU3RhdGUocHJvcHMucm9vbSk7XG4gICAgICAgIG5vdGlTdG9yZS5vbihOT1RJRklDQVRJT05fU1RBVEVfVVBEQVRFLCB0aGlzLm9uTm90aWZpY2F0aW9uVXBkYXRlKTtcbiAgICAgICAgdGhpcy5zdGF0ZSA9IHt9O1xuICAgIH1cblxuICAgIHB1YmxpYyBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICAgICAgY29uc3QgY2xpID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuICAgICAgICBjbGkub24oXCJSb29tU3RhdGUuZXZlbnRzXCIsIHRoaXMub25Sb29tU3RhdGVFdmVudHMpO1xuICAgIH1cblxuICAgIHB1YmxpYyBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICAgICAgY29uc3QgY2xpID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuICAgICAgICBpZiAoY2xpKSB7XG4gICAgICAgICAgICBjbGkucmVtb3ZlTGlzdGVuZXIoXCJSb29tU3RhdGUuZXZlbnRzXCIsIHRoaXMub25Sb29tU3RhdGVFdmVudHMpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IG5vdGlTdG9yZSA9IFJvb21Ob3RpZmljYXRpb25TdGF0ZVN0b3JlLmluc3RhbmNlLmdldFJvb21TdGF0ZSh0aGlzLnByb3BzLnJvb20pO1xuICAgICAgICBub3RpU3RvcmUucmVtb3ZlTGlzdGVuZXIoTk9USUZJQ0FUSU9OX1NUQVRFX1VQREFURSwgdGhpcy5vbk5vdGlmaWNhdGlvblVwZGF0ZSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvblJvb21TdGF0ZUV2ZW50cyA9IChldmVudDogTWF0cml4RXZlbnQsIHN0YXRlOiBSb29tU3RhdGUpID0+IHtcbiAgICAgICAgaWYgKCF0aGlzLnByb3BzLnJvb20gfHwgZXZlbnQuZ2V0Um9vbUlkKCkgIT09IHRoaXMucHJvcHMucm9vbS5yb29tSWQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHJlZGlzcGxheSB0aGUgcm9vbSBuYW1lLCB0b3BpYywgZXRjLlxuICAgICAgICB0aGlzLnJhdGVMaW1pdGVkVXBkYXRlKCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25Ob3RpZmljYXRpb25VcGRhdGUgPSAoKSA9PiB7XG4gICAgICAgIHRoaXMuZm9yY2VVcGRhdGUoKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSByYXRlTGltaXRlZFVwZGF0ZSA9IHRocm90dGxlKCgpID0+IHtcbiAgICAgICAgdGhpcy5mb3JjZVVwZGF0ZSgpO1xuICAgIH0sIDUwMCwgeyBsZWFkaW5nOiB0cnVlLCB0cmFpbGluZzogdHJ1ZSB9KTtcblxuICAgIHByaXZhdGUgZGlzcGxheUluZm9EaWFsb2dBYm91dFNjcmVlbnNoYXJpbmcoKSB7XG4gICAgICAgIE1vZGFsLmNyZWF0ZURpYWxvZyhJbmZvRGlhbG9nLCB7XG4gICAgICAgICAgICB0aXRsZTogX3QoXCJTY3JlZW4gc2hhcmluZyBpcyBoZXJlIVwiKSxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBfdChcIllvdSBjYW4gbm93IHNoYXJlIHlvdXIgc2NyZWVuIGJ5IHByZXNzaW5nIHRoZSBcXFwic2NyZWVuIHNoYXJlXFxcIiBcIiArXG4gICAgICAgICAgICBcImJ1dHRvbiBkdXJpbmcgYSBjYWxsLiBZb3UgY2FuIGV2ZW4gZG8gdGhpcyBpbiBhdWRpbyBjYWxscyBpZiBib3RoIHNpZGVzIHN1cHBvcnQgaXQhXCIpLFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uQ29udGV4dE1lbnVPcGVuQ2xpY2sgPSAoZXY6IFJlYWN0Lk1vdXNlRXZlbnQpID0+IHtcbiAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgZXYuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIGNvbnN0IHRhcmdldCA9IGV2LnRhcmdldCBhcyBIVE1MQnV0dG9uRWxlbWVudDtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGNvbnRleHRNZW51UG9zaXRpb246IHRhcmdldC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSB9KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkNvbnRleHRNZW51Q2xvc2VDbGljayA9ICgpID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGNvbnRleHRNZW51UG9zaXRpb246IG51bGwgfSk7XG4gICAgfTtcblxuICAgIHB1YmxpYyByZW5kZXIoKSB7XG4gICAgICAgIGxldCBzZWFyY2hTdGF0dXMgPSBudWxsO1xuXG4gICAgICAgIC8vIGRvbid0IGRpc3BsYXkgdGhlIHNlYXJjaCBjb3VudCB1bnRpbCB0aGUgc2VhcmNoIGNvbXBsZXRlcyBhbmRcbiAgICAgICAgLy8gZ2l2ZXMgdXMgYSB2YWxpZCAocG9zc2libHkgemVybykgc2VhcmNoQ291bnQuXG4gICAgICAgIGlmICh0aGlzLnByb3BzLnNlYXJjaEluZm8gJiZcbiAgICAgICAgICAgIHRoaXMucHJvcHMuc2VhcmNoSW5mby5zZWFyY2hDb3VudCAhPT0gdW5kZWZpbmVkICYmXG4gICAgICAgICAgICB0aGlzLnByb3BzLnNlYXJjaEluZm8uc2VhcmNoQ291bnQgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHNlYXJjaFN0YXR1cyA9IDxkaXYgY2xhc3NOYW1lPVwibXhfUm9vbUhlYWRlcl9zZWFyY2hTdGF0dXNcIj4mbmJzcDtcbiAgICAgICAgICAgICAgICB7IF90KFwiKH4lKGNvdW50KXMgcmVzdWx0cylcIiwgeyBjb3VudDogdGhpcy5wcm9wcy5zZWFyY2hJbmZvLnNlYXJjaENvdW50IH0pIH1cbiAgICAgICAgICAgIDwvZGl2PjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFhYWDogdGhpcyBpcyBhIGJpdCBpbmVmZmljaWVudCAtIHdlIGNvdWxkIGp1c3QgY29tcGFyZSByb29tLm5hbWUgZm9yICdFbXB0eSByb29tJy4uLlxuICAgICAgICBsZXQgc2V0dGluZ3NIaW50ID0gZmFsc2U7XG4gICAgICAgIGNvbnN0IG1lbWJlcnMgPSB0aGlzLnByb3BzLnJvb20gPyB0aGlzLnByb3BzLnJvb20uZ2V0Sm9pbmVkTWVtYmVycygpIDogdW5kZWZpbmVkO1xuICAgICAgICBpZiAobWVtYmVycykge1xuICAgICAgICAgICAgaWYgKG1lbWJlcnMubGVuZ3RoID09PSAxICYmIG1lbWJlcnNbMF0udXNlcklkID09PSBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuY3JlZGVudGlhbHMudXNlcklkKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbmFtZUV2ZW50ID0gdGhpcy5wcm9wcy5yb29tLmN1cnJlbnRTdGF0ZS5nZXRTdGF0ZUV2ZW50cygnbS5yb29tLm5hbWUnLCAnJyk7XG4gICAgICAgICAgICAgICAgaWYgKCFuYW1lRXZlbnQgfHwgIW5hbWVFdmVudC5nZXRDb250ZW50KCkubmFtZSkge1xuICAgICAgICAgICAgICAgICAgICBzZXR0aW5nc0hpbnQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBvb2JOYW1lID0gX3QoXCJKb2luIFJvb21cIik7XG4gICAgICAgIGlmICh0aGlzLnByb3BzLm9vYkRhdGEgJiYgdGhpcy5wcm9wcy5vb2JEYXRhLm5hbWUpIHtcbiAgICAgICAgICAgIG9vYk5hbWUgPSB0aGlzLnByb3BzLm9vYkRhdGEubmFtZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBjb250ZXh0TWVudTogSlNYLkVsZW1lbnQ7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLmNvbnRleHRNZW51UG9zaXRpb24gJiYgdGhpcy5wcm9wcy5yb29tKSB7XG4gICAgICAgICAgICBjb250ZXh0TWVudSA9IChcbiAgICAgICAgICAgICAgICA8Um9vbUNvbnRleHRNZW51XG4gICAgICAgICAgICAgICAgICAgIHsuLi5jb250ZXh0TWVudUJlbG93KHRoaXMuc3RhdGUuY29udGV4dE1lbnVQb3NpdGlvbil9XG4gICAgICAgICAgICAgICAgICAgIHJvb209e3RoaXMucHJvcHMucm9vbX1cbiAgICAgICAgICAgICAgICAgICAgb25GaW5pc2hlZD17dGhpcy5vbkNvbnRleHRNZW51Q2xvc2VDbGlja31cbiAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHRleHRDbGFzc2VzID0gY2xhc3NOYW1lcygnbXhfUm9vbUhlYWRlcl9uYW1ldGV4dCcsIHsgbXhfUm9vbUhlYWRlcl9zZXR0aW5nc0hpbnQ6IHNldHRpbmdzSGludCB9KTtcbiAgICAgICAgY29uc3QgbmFtZSA9IChcbiAgICAgICAgICAgIDxDb250ZXh0TWVudVRvb2x0aXBCdXR0b25cbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9Sb29tSGVhZGVyX25hbWVcIlxuICAgICAgICAgICAgICAgIG9uQ2xpY2s9e3RoaXMub25Db250ZXh0TWVudU9wZW5DbGlja31cbiAgICAgICAgICAgICAgICBpc0V4cGFuZGVkPXshIXRoaXMuc3RhdGUuY29udGV4dE1lbnVQb3NpdGlvbn1cbiAgICAgICAgICAgICAgICB0aXRsZT17X3QoXCJSb29tIG9wdGlvbnNcIil9XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgPFJvb21OYW1lIHJvb209e3RoaXMucHJvcHMucm9vbX0+XG4gICAgICAgICAgICAgICAgICAgIHsgKG5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJvb21OYW1lID0gbmFtZSB8fCBvb2JOYW1lO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDxkaXYgZGlyPVwiYXV0b1wiIGNsYXNzTmFtZT17dGV4dENsYXNzZXN9IHRpdGxlPXtyb29tTmFtZX0+eyByb29tTmFtZSB9PC9kaXY+O1xuICAgICAgICAgICAgICAgICAgICB9IH1cbiAgICAgICAgICAgICAgICA8L1Jvb21OYW1lPlxuICAgICAgICAgICAgICAgIHsgdGhpcy5wcm9wcy5yb29tICYmIDxkaXYgY2xhc3NOYW1lPVwibXhfUm9vbUhlYWRlcl9jaGV2cm9uXCIgLz4gfVxuICAgICAgICAgICAgICAgIHsgY29udGV4dE1lbnUgfVxuICAgICAgICAgICAgPC9Db250ZXh0TWVudVRvb2x0aXBCdXR0b24+XG4gICAgICAgICk7XG5cbiAgICAgICAgY29uc3QgdG9waWNFbGVtZW50ID0gPFJvb21Ub3BpYyByb29tPXt0aGlzLnByb3BzLnJvb219PlxuICAgICAgICAgICAgeyAodG9waWMsIHJlZikgPT4gPGRpdiBjbGFzc05hbWU9XCJteF9Sb29tSGVhZGVyX3RvcGljXCIgcmVmPXtyZWZ9IHRpdGxlPXt0b3BpY30gZGlyPVwiYXV0b1wiPlxuICAgICAgICAgICAgICAgIHsgdG9waWMgfVxuICAgICAgICAgICAgPC9kaXY+IH1cbiAgICAgICAgPC9Sb29tVG9waWM+O1xuXG4gICAgICAgIGxldCByb29tQXZhdGFyO1xuICAgICAgICBpZiAodGhpcy5wcm9wcy5yb29tKSB7XG4gICAgICAgICAgICByb29tQXZhdGFyID0gPERlY29yYXRlZFJvb21BdmF0YXJcbiAgICAgICAgICAgICAgICByb29tPXt0aGlzLnByb3BzLnJvb219XG4gICAgICAgICAgICAgICAgYXZhdGFyU2l6ZT17MjR9XG4gICAgICAgICAgICAgICAgb29iRGF0YT17dGhpcy5wcm9wcy5vb2JEYXRhfVxuICAgICAgICAgICAgICAgIHZpZXdBdmF0YXJPbkNsaWNrPXt0cnVlfVxuICAgICAgICAgICAgLz47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBidXR0b25zOiBKU1guRWxlbWVudFtdID0gW107XG5cbiAgICAgICAgaWYgKHRoaXMucHJvcHMuaW5Sb29tICYmIFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJzaG93Q2FsbEJ1dHRvbnNJbkNvbXBvc2VyXCIpKSB7XG4gICAgICAgICAgICBjb25zdCB2b2ljZUNhbGxCdXR0b24gPSA8QWNjZXNzaWJsZVRvb2x0aXBCdXR0b25cbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9Sb29tSGVhZGVyX2J1dHRvbiBteF9Sb29tSGVhZGVyX3ZvaWNlQ2FsbEJ1dHRvblwiXG4gICAgICAgICAgICAgICAgb25DbGljaz17KCkgPT4gdGhpcy5wcm9wcy5vbkNhbGxQbGFjZWQoUGxhY2VDYWxsVHlwZS5Wb2ljZSl9XG4gICAgICAgICAgICAgICAgdGl0bGU9e190KFwiVm9pY2UgY2FsbFwiKX1cbiAgICAgICAgICAgICAgICBrZXk9XCJ2b2ljZVwiXG4gICAgICAgICAgICAvPjtcbiAgICAgICAgICAgIGNvbnN0IHZpZGVvQ2FsbEJ1dHRvbiA9IDxBY2Nlc3NpYmxlVG9vbHRpcEJ1dHRvblxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X1Jvb21IZWFkZXJfYnV0dG9uIG14X1Jvb21IZWFkZXJfdmlkZW9DYWxsQnV0dG9uXCJcbiAgICAgICAgICAgICAgICBvbkNsaWNrPXsoZXY6IFJlYWN0Lk1vdXNlRXZlbnQ8RWxlbWVudD4pID0+IGV2LnNoaWZ0S2V5ID9cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kaXNwbGF5SW5mb0RpYWxvZ0Fib3V0U2NyZWVuc2hhcmluZygpIDogdGhpcy5wcm9wcy5vbkNhbGxQbGFjZWQoUGxhY2VDYWxsVHlwZS5WaWRlbyl9XG4gICAgICAgICAgICAgICAgdGl0bGU9e190KFwiVmlkZW8gY2FsbFwiKX1cbiAgICAgICAgICAgICAgICBrZXk9XCJ2aWRlb1wiXG4gICAgICAgICAgICAvPjtcbiAgICAgICAgICAgIGJ1dHRvbnMucHVzaCh2b2ljZUNhbGxCdXR0b24sIHZpZGVvQ2FsbEJ1dHRvbik7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5wcm9wcy5vbkZvcmdldENsaWNrKSB7XG4gICAgICAgICAgICBjb25zdCBmb3JnZXRCdXR0b24gPSA8QWNjZXNzaWJsZVRvb2x0aXBCdXR0b25cbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9Sb29tSGVhZGVyX2J1dHRvbiBteF9Sb29tSGVhZGVyX2ZvcmdldEJ1dHRvblwiXG4gICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5wcm9wcy5vbkZvcmdldENsaWNrfVxuICAgICAgICAgICAgICAgIHRpdGxlPXtfdChcIkZvcmdldCByb29tXCIpfVxuICAgICAgICAgICAgICAgIGtleT1cImZvcmdldFwiXG4gICAgICAgICAgICAvPjtcbiAgICAgICAgICAgIGJ1dHRvbnMucHVzaChmb3JnZXRCdXR0b24pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMucHJvcHMub25BcHBzQ2xpY2spIHtcbiAgICAgICAgICAgIGNvbnN0IGFwcHNCdXR0b24gPSA8QWNjZXNzaWJsZVRvb2x0aXBCdXR0b25cbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9e2NsYXNzTmFtZXMoXCJteF9Sb29tSGVhZGVyX2J1dHRvbiBteF9Sb29tSGVhZGVyX2FwcHNCdXR0b25cIiwge1xuICAgICAgICAgICAgICAgICAgICBteF9Sb29tSGVhZGVyX2FwcHNCdXR0b25faGlnaGxpZ2h0OiB0aGlzLnByb3BzLmFwcHNTaG93bixcbiAgICAgICAgICAgICAgICB9KX1cbiAgICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLnByb3BzLm9uQXBwc0NsaWNrfVxuICAgICAgICAgICAgICAgIHRpdGxlPXt0aGlzLnByb3BzLmFwcHNTaG93biA/IF90KFwiSGlkZSBXaWRnZXRzXCIpIDogX3QoXCJTaG93IFdpZGdldHNcIil9XG4gICAgICAgICAgICAgICAga2V5PVwiYXBwc1wiXG4gICAgICAgICAgICAvPjtcbiAgICAgICAgICAgIGJ1dHRvbnMucHVzaChhcHBzQnV0dG9uKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLnByb3BzLm9uU2VhcmNoQ2xpY2sgJiYgdGhpcy5wcm9wcy5pblJvb20pIHtcbiAgICAgICAgICAgIGNvbnN0IHNlYXJjaEJ1dHRvbiA9IDxBY2Nlc3NpYmxlVG9vbHRpcEJ1dHRvblxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X1Jvb21IZWFkZXJfYnV0dG9uIG14X1Jvb21IZWFkZXJfc2VhcmNoQnV0dG9uXCJcbiAgICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLnByb3BzLm9uU2VhcmNoQ2xpY2t9XG4gICAgICAgICAgICAgICAgdGl0bGU9e190KFwiU2VhcmNoXCIpfVxuICAgICAgICAgICAgICAgIGtleT1cInNlYXJjaFwiXG4gICAgICAgICAgICAvPjtcbiAgICAgICAgICAgIGJ1dHRvbnMucHVzaChzZWFyY2hCdXR0b24pO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmlnaHRSb3cgPVxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9Sb29tSGVhZGVyX2J1dHRvbnNcIj5cbiAgICAgICAgICAgICAgICB7IGJ1dHRvbnMgfVxuICAgICAgICAgICAgPC9kaXY+O1xuXG4gICAgICAgIGNvbnN0IGUyZUljb24gPSB0aGlzLnByb3BzLmUyZVN0YXR1cyA/IDxFMkVJY29uIHN0YXR1cz17dGhpcy5wcm9wcy5lMmVTdGF0dXN9IC8+IDogdW5kZWZpbmVkO1xuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X1Jvb21IZWFkZXIgbGlnaHQtcGFuZWxcIj5cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X1Jvb21IZWFkZXJfd3JhcHBlclwiIGFyaWEtb3ducz1cIm14X1JpZ2h0UGFuZWxcIj5cbiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9Sb29tSGVhZGVyX2F2YXRhclwiPnsgcm9vbUF2YXRhciB9PC9kaXY+XG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfUm9vbUhlYWRlcl9lMmVJY29uXCI+eyBlMmVJY29uIH08L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgeyBuYW1lIH1cbiAgICAgICAgICAgICAgICAgICAgeyBzZWFyY2hTdGF0dXMgfVxuICAgICAgICAgICAgICAgICAgICB7IHRvcGljRWxlbWVudCB9XG4gICAgICAgICAgICAgICAgICAgIHsgcmlnaHRSb3cgfVxuICAgICAgICAgICAgICAgICAgICA8Um9vbUhlYWRlckJ1dHRvbnMgcm9vbT17dGhpcy5wcm9wcy5yb29tfSBleGNsdWRlZFJpZ2h0UGFuZWxQaGFzZUJ1dHRvbnM9e3RoaXMucHJvcHMuZXhjbHVkZWRSaWdodFBhbmVsUGhhc2VCdXR0b25zfSAvPlxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICk7XG4gICAgfVxufVxuIl19