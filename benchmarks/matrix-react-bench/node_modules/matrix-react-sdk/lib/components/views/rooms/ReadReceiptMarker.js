"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var _languageHandler = require("../../../languageHandler");

var _DateUtils = require("../../../DateUtils");

var _NodeAnimator = _interopRequireDefault(require("../../../NodeAnimator"));

var _units = require("../../../utils/units");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _MemberAvatar = _interopRequireDefault(require("../avatars/MemberAvatar"));

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class, _class2, _temp;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

let ReadReceiptMarker = (_dec = (0, _replaceableComponent.replaceableComponent)("views.rooms.ReadReceiptMarker"), _dec(_class = (_temp = _class2 = class ReadReceiptMarker extends _react.default.PureComponent {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "avatar", /*#__PURE__*/(0, _react.createRef)());
    this.state = {
      // if we are going to animate the RR, we don't show it on first render,
      // and instead just add a placeholder to the DOM; once we've been
      // mounted, we start an animation which moves the RR from its old
      // position.
      suppressDisplay: !this.props.suppressAnimation
    };
  }

  componentWillUnmount() {
    // before we remove the rr, store its location in the map, so that if
    // it reappears, it can be animated from the right place.
    const rrInfo = this.props.readReceiptInfo;

    if (!rrInfo) {
      return;
    } // checking the DOM properties can force a re-layout, which can be
    // quite expensive; so if the parent messagepanel is being unmounted,
    // then don't bother with this.


    if (this.props.checkUnmounting && this.props.checkUnmounting()) {
      return;
    }

    const avatarNode = this.avatar.current;
    rrInfo.top = avatarNode.offsetTop;
    rrInfo.left = avatarNode.offsetLeft;
    rrInfo.parent = avatarNode.offsetParent;
  }

  componentDidMount() {
    if (!this.state.suppressDisplay) {
      // we've already done our display - nothing more to do.
      return;
    }

    this.animateMarker();
  }

  componentDidUpdate(prevProps) {
    const differentLeftOffset = prevProps.leftOffset !== this.props.leftOffset;
    const visibilityChanged = prevProps.hidden !== this.props.hidden;

    if (differentLeftOffset || visibilityChanged) {
      this.animateMarker();
    }
  }

  animateMarker() {
    // treat new RRs as though they were off the top of the screen
    let oldTop = -15;
    const oldInfo = this.props.readReceiptInfo;

    if (oldInfo && oldInfo.parent) {
      oldTop = oldInfo.top + oldInfo.parent.getBoundingClientRect().top;
    }

    const newElement = this.avatar.current;
    let startTopOffset;

    if (!newElement.offsetParent) {
      // this seems to happen sometimes for reasons I don't understand
      // the docs for `offsetParent` say it may be null if `display` is
      // `none`, but I can't see why that would happen.
      _logger.logger.warn(`ReadReceiptMarker for ${this.props.fallbackUserId} in has no offsetParent`);

      startTopOffset = 0;
    } else {
      startTopOffset = oldTop - newElement.offsetParent.getBoundingClientRect().top;
    }

    const startStyles = [];

    if (oldInfo && oldInfo.left) {
      // start at the old height and in the old h pos
      startStyles.push({
        top: startTopOffset + "px",
        left: (0, _units.toPx)(oldInfo.left)
      });
    }

    startStyles.push({
      top: startTopOffset + 'px',
      left: '0'
    });
    this.setState({
      suppressDisplay: false,
      startStyles: startStyles
    });
  }

  render() {
    if (this.state.suppressDisplay) {
      return /*#__PURE__*/_react.default.createElement("div", {
        ref: this.avatar
      });
    }

    const style = {
      left: (0, _units.toPx)(this.props.leftOffset),
      top: '0px'
    };
    let title;

    if (this.props.timestamp) {
      const dateString = (0, _DateUtils.formatDate)(new Date(this.props.timestamp), this.props.showTwelveHour);

      if (!this.props.member || this.props.fallbackUserId === this.props.member.rawDisplayName) {
        title = (0, _languageHandler._t)("Seen by %(userName)s at %(dateTime)s", {
          userName: this.props.fallbackUserId,
          dateTime: dateString
        });
      } else {
        title = (0, _languageHandler._t)("Seen by %(displayName)s (%(userName)s) at %(dateTime)s", {
          displayName: this.props.member.rawDisplayName,
          userName: this.props.fallbackUserId,
          dateTime: dateString
        });
      }
    }

    return /*#__PURE__*/_react.default.createElement(_NodeAnimator.default, {
      startStyles: this.state.startStyles
    }, /*#__PURE__*/_react.default.createElement(_MemberAvatar.default, {
      member: this.props.member,
      fallbackUserId: this.props.fallbackUserId,
      "aria-hidden": "true",
      "aria-live": "off",
      width: 14,
      height: 14,
      resizeMethod: "crop",
      style: style,
      title: title,
      onClick: this.props.onClick,
      inputRef: this.avatar
    }));
  }

}, (0, _defineProperty2.default)(_class2, "defaultProps", {
  leftOffset: 0
}), _temp)) || _class);
exports.default = ReadReceiptMarker;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3Jvb21zL1JlYWRSZWNlaXB0TWFya2VyLnRzeCJdLCJuYW1lcyI6WyJSZWFkUmVjZWlwdE1hcmtlciIsIlJlYWN0IiwiUHVyZUNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJzdGF0ZSIsInN1cHByZXNzRGlzcGxheSIsInN1cHByZXNzQW5pbWF0aW9uIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJyckluZm8iLCJyZWFkUmVjZWlwdEluZm8iLCJjaGVja1VubW91bnRpbmciLCJhdmF0YXJOb2RlIiwiYXZhdGFyIiwiY3VycmVudCIsInRvcCIsIm9mZnNldFRvcCIsImxlZnQiLCJvZmZzZXRMZWZ0IiwicGFyZW50Iiwib2Zmc2V0UGFyZW50IiwiY29tcG9uZW50RGlkTW91bnQiLCJhbmltYXRlTWFya2VyIiwiY29tcG9uZW50RGlkVXBkYXRlIiwicHJldlByb3BzIiwiZGlmZmVyZW50TGVmdE9mZnNldCIsImxlZnRPZmZzZXQiLCJ2aXNpYmlsaXR5Q2hhbmdlZCIsImhpZGRlbiIsIm9sZFRvcCIsIm9sZEluZm8iLCJnZXRCb3VuZGluZ0NsaWVudFJlY3QiLCJuZXdFbGVtZW50Iiwic3RhcnRUb3BPZmZzZXQiLCJsb2dnZXIiLCJ3YXJuIiwiZmFsbGJhY2tVc2VySWQiLCJzdGFydFN0eWxlcyIsInB1c2giLCJzZXRTdGF0ZSIsInJlbmRlciIsInN0eWxlIiwidGl0bGUiLCJ0aW1lc3RhbXAiLCJkYXRlU3RyaW5nIiwiRGF0ZSIsInNob3dUd2VsdmVIb3VyIiwibWVtYmVyIiwicmF3RGlzcGxheU5hbWUiLCJ1c2VyTmFtZSIsImRhdGVUaW1lIiwiZGlzcGxheU5hbWUiLCJvbkNsaWNrIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWlCQTs7QUFHQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFFQTs7Ozs7Ozs7SUFrRHFCQSxpQixXQURwQixnREFBcUIsK0JBQXJCLEMs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QyxLQUFMLENBQVcyQyxNQUFYLENBQWtCQyxjQUFqQztBQUNJQyxVQUFBQSxRQUFRLEVBQUUsS0FBSzdDLEtBQUwsQ0FBV2dDLGNBRHpCO0FBRUljLFVBQUFBLFFBQVEsRUFBRU47QUFGZCxTQUZJLENBQVI7QUFNSDtBQUNKOztBQUVELHdCQUNJLDZCQUFDLHFCQUFEO0FBQWMsTUFBQSxXQUFXLEVBQUUsS0FBS3ZDLEtBQUwsQ0FBV2dDO0FBQXRDLG9CQUNJLDZCQUFDLHFCQUFEO0FBQ0ksTUFBQSxNQUFNLEVBQUUsS0FBS2pDLEtBQUwsQ0FBVzJDLE1BRHZCO0FBRUksTUFBQSxjQUFjLEVBQUUsS0FBSzNDLEtBQUwsQ0FBV2dDLGNBRi9CO0FBR0kscUJBQVksTUFIaEI7QUFJSSxtQkFBVSxLQUpkO0FBS0ksTUFBQSxLQUFLLEVBQUUsRUFMWDtBQU1JLE1BQUEsTUFBTSxFQUFFLEVBTlo7QUFPSSxNQUFBLFlBQVksRUFBQyxNQVBqQjtBQVFJLE1BQUEsS0FBSyxFQUFFSyxLQVJYO0FBU0ksTUFBQSxLQUFLLEVBQUVDLEtBVFg7QUFVSSxNQUFBLE9BQU8sRUFBRSxLQUFLdEMsS0FBTCxDQUFXZ0QsT0FWeEI7QUFXSSxNQUFBLFFBQVEsRUFBRSxLQUFLdkM7QUFYbkIsTUFESixDQURKO0FBaUJIOztBQTdJOEUsQyx5REFHekQ7QUFDbEJhLEVBQUFBLFVBQVUsRUFBRTtBQURNLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTYgT3Blbk1hcmtldCBMdGRcbkNvcHlyaWdodCAyMDE5IFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0LCB7IGNyZWF0ZVJlZiwgUmVmT2JqZWN0IH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgUm9vbU1lbWJlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvcm9vbS1tZW1iZXJcIjtcblxuaW1wb3J0IHsgX3QgfSBmcm9tICcuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXInO1xuaW1wb3J0IHsgZm9ybWF0RGF0ZSB9IGZyb20gJy4uLy4uLy4uL0RhdGVVdGlscyc7XG5pbXBvcnQgTm9kZUFuaW1hdG9yIGZyb20gXCIuLi8uLi8uLi9Ob2RlQW5pbWF0b3JcIjtcbmltcG9ydCB7IHRvUHggfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvdW5pdHNcIjtcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5cbmltcG9ydCBNZW1iZXJBdmF0YXIgZnJvbSAnLi4vYXZhdGFycy9NZW1iZXJBdmF0YXInO1xuXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbG9nZ2VyXCI7XG5cbmludGVyZmFjZSBJUHJvcHMge1xuICAgIC8vIHRoZSBSb29tTWVtYmVyIHRvIHNob3cgdGhlIFJSIGZvclxuICAgIG1lbWJlcj86IFJvb21NZW1iZXI7XG4gICAgLy8gdXNlcklkIHRvIGZhbGxiYWNrIHRoZSBhdmF0YXIgdG9cbiAgICAvLyBpZiB0aGUgbWVtYmVyIGhhc24ndCBiZWVuIGxvYWRlZCB5ZXRcbiAgICBmYWxsYmFja1VzZXJJZDogc3RyaW5nO1xuXG4gICAgLy8gbnVtYmVyIG9mIHBpeGVscyB0byBvZmZzZXQgdGhlIGF2YXRhciBmcm9tIHRoZSByaWdodCBvZiBpdHMgcGFyZW50O1xuICAgIC8vIHR5cGljYWxseSBhIG5lZ2F0aXZlIHZhbHVlLlxuICAgIGxlZnRPZmZzZXQ/OiBudW1iZXI7XG5cbiAgICAvLyB0cnVlIHRvIGhpZGUgdGhlIGF2YXRhciAoaXQgd2lsbCBzdGlsbCBiZSBhbmltYXRlZClcbiAgICBoaWRkZW4/OiBib29sZWFuO1xuXG4gICAgLy8gZG9uJ3QgYW5pbWF0ZSB0aGlzIFJSIGludG8gcG9zaXRpb25cbiAgICBzdXBwcmVzc0FuaW1hdGlvbj86IGJvb2xlYW47XG5cbiAgICAvLyBhbiBvcGFxdWUgb2JqZWN0IGZvciBzdG9yaW5nIGluZm9ybWF0aW9uIGFib3V0IHRoaXMgdXNlcidzIFJSIGluXG4gICAgLy8gdGhpcyByb29tXG4gICAgLy8gVE9ETzogcHJvcGVyIHR5cGluZyBmb3IgUlIgaW5mb1xuICAgIHJlYWRSZWNlaXB0SW5mbzogYW55O1xuXG4gICAgLy8gQSBmdW5jdGlvbiB3aGljaCBpcyB1c2VkIHRvIGNoZWNrIGlmIHRoZSBwYXJlbnQgcGFuZWwgaXMgYmVpbmdcbiAgICAvLyB1bm1vdW50ZWQsIHRvIGF2b2lkIHVubmVjZXNzYXJ5IHdvcmsuIFNob3VsZCByZXR1cm4gdHJ1ZSBpZiB3ZVxuICAgIC8vIGFyZSBiZWluZyB1bm1vdW50ZWQuXG4gICAgY2hlY2tVbm1vdW50aW5nPzogKCkgPT4gYm9vbGVhbjtcblxuICAgIC8vIGNhbGxiYWNrIGZvciBjbGlja3Mgb24gdGhpcyBSUlxuICAgIG9uQ2xpY2s/OiAoZTogUmVhY3QuTW91c2VFdmVudCkgPT4gdm9pZDtcblxuICAgIC8vIFRpbWVzdGFtcCB3aGVuIHRoZSByZWNlaXB0IHdhcyByZWFkXG4gICAgdGltZXN0YW1wPzogbnVtYmVyO1xuXG4gICAgLy8gVHJ1ZSB0byBzaG93IHR3ZWx2ZSBob3VyIGZvcm1hdCwgZmFsc2Ugb3RoZXJ3aXNlXG4gICAgc2hvd1R3ZWx2ZUhvdXI/OiBib29sZWFuO1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBzdXBwcmVzc0Rpc3BsYXk6IGJvb2xlYW47XG4gICAgc3RhcnRTdHlsZXM/OiBJUmVhZFJlY2VpcHRNYXJrZXJTdHlsZVtdO1xufVxuXG5pbnRlcmZhY2UgSVJlYWRSZWNlaXB0TWFya2VyU3R5bGUge1xuICAgIHRvcDogbnVtYmVyO1xuICAgIGxlZnQ6IG51bWJlcjtcbn1cblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3Mucm9vbXMuUmVhZFJlY2VpcHRNYXJrZXJcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJlYWRSZWNlaXB0TWFya2VyIGV4dGVuZHMgUmVhY3QuUHVyZUNvbXBvbmVudDxJUHJvcHMsIElTdGF0ZT4ge1xuICAgIHByaXZhdGUgYXZhdGFyOiBSZWFjdC5SZWZPYmplY3Q8SFRNTERpdkVsZW1lbnQgfCBIVE1MSW1hZ2VFbGVtZW50IHwgSFRNTFNwYW5FbGVtZW50PiA9IGNyZWF0ZVJlZigpO1xuXG4gICAgc3RhdGljIGRlZmF1bHRQcm9wcyA9IHtcbiAgICAgICAgbGVmdE9mZnNldDogMCxcbiAgICB9O1xuXG4gICAgY29uc3RydWN0b3IocHJvcHM6IElQcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG5cbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIC8vIGlmIHdlIGFyZSBnb2luZyB0byBhbmltYXRlIHRoZSBSUiwgd2UgZG9uJ3Qgc2hvdyBpdCBvbiBmaXJzdCByZW5kZXIsXG4gICAgICAgICAgICAvLyBhbmQgaW5zdGVhZCBqdXN0IGFkZCBhIHBsYWNlaG9sZGVyIHRvIHRoZSBET007IG9uY2Ugd2UndmUgYmVlblxuICAgICAgICAgICAgLy8gbW91bnRlZCwgd2Ugc3RhcnQgYW4gYW5pbWF0aW9uIHdoaWNoIG1vdmVzIHRoZSBSUiBmcm9tIGl0cyBvbGRcbiAgICAgICAgICAgIC8vIHBvc2l0aW9uLlxuICAgICAgICAgICAgc3VwcHJlc3NEaXNwbGF5OiAhdGhpcy5wcm9wcy5zdXBwcmVzc0FuaW1hdGlvbixcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY29tcG9uZW50V2lsbFVubW91bnQoKTogdm9pZCB7XG4gICAgICAgIC8vIGJlZm9yZSB3ZSByZW1vdmUgdGhlIHJyLCBzdG9yZSBpdHMgbG9jYXRpb24gaW4gdGhlIG1hcCwgc28gdGhhdCBpZlxuICAgICAgICAvLyBpdCByZWFwcGVhcnMsIGl0IGNhbiBiZSBhbmltYXRlZCBmcm9tIHRoZSByaWdodCBwbGFjZS5cbiAgICAgICAgY29uc3QgcnJJbmZvID0gdGhpcy5wcm9wcy5yZWFkUmVjZWlwdEluZm87XG4gICAgICAgIGlmICghcnJJbmZvKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICAvLyBjaGVja2luZyB0aGUgRE9NIHByb3BlcnRpZXMgY2FuIGZvcmNlIGEgcmUtbGF5b3V0LCB3aGljaCBjYW4gYmVcbiAgICAgICAgLy8gcXVpdGUgZXhwZW5zaXZlOyBzbyBpZiB0aGUgcGFyZW50IG1lc3NhZ2VwYW5lbCBpcyBiZWluZyB1bm1vdW50ZWQsXG4gICAgICAgIC8vIHRoZW4gZG9uJ3QgYm90aGVyIHdpdGggdGhpcy5cbiAgICAgICAgaWYgKHRoaXMucHJvcHMuY2hlY2tVbm1vdW50aW5nICYmIHRoaXMucHJvcHMuY2hlY2tVbm1vdW50aW5nKCkpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGF2YXRhck5vZGUgPSB0aGlzLmF2YXRhci5jdXJyZW50O1xuICAgICAgICByckluZm8udG9wID0gYXZhdGFyTm9kZS5vZmZzZXRUb3A7XG4gICAgICAgIHJySW5mby5sZWZ0ID0gYXZhdGFyTm9kZS5vZmZzZXRMZWZ0O1xuICAgICAgICByckluZm8ucGFyZW50ID0gYXZhdGFyTm9kZS5vZmZzZXRQYXJlbnQ7XG4gICAgfVxuXG4gICAgcHVibGljIGNvbXBvbmVudERpZE1vdW50KCk6IHZvaWQge1xuICAgICAgICBpZiAoIXRoaXMuc3RhdGUuc3VwcHJlc3NEaXNwbGF5KSB7XG4gICAgICAgICAgICAvLyB3ZSd2ZSBhbHJlYWR5IGRvbmUgb3VyIGRpc3BsYXkgLSBub3RoaW5nIG1vcmUgdG8gZG8uXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5hbmltYXRlTWFya2VyKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGNvbXBvbmVudERpZFVwZGF0ZShwcmV2UHJvcHM6IElQcm9wcyk6IHZvaWQge1xuICAgICAgICBjb25zdCBkaWZmZXJlbnRMZWZ0T2Zmc2V0ID0gcHJldlByb3BzLmxlZnRPZmZzZXQgIT09IHRoaXMucHJvcHMubGVmdE9mZnNldDtcbiAgICAgICAgY29uc3QgdmlzaWJpbGl0eUNoYW5nZWQgPSBwcmV2UHJvcHMuaGlkZGVuICE9PSB0aGlzLnByb3BzLmhpZGRlbjtcbiAgICAgICAgaWYgKGRpZmZlcmVudExlZnRPZmZzZXQgfHwgdmlzaWJpbGl0eUNoYW5nZWQpIHtcbiAgICAgICAgICAgIHRoaXMuYW5pbWF0ZU1hcmtlcigpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhbmltYXRlTWFya2VyKCk6IHZvaWQge1xuICAgICAgICAvLyB0cmVhdCBuZXcgUlJzIGFzIHRob3VnaCB0aGV5IHdlcmUgb2ZmIHRoZSB0b3Agb2YgdGhlIHNjcmVlblxuICAgICAgICBsZXQgb2xkVG9wID0gLTE1O1xuXG4gICAgICAgIGNvbnN0IG9sZEluZm8gPSB0aGlzLnByb3BzLnJlYWRSZWNlaXB0SW5mbztcbiAgICAgICAgaWYgKG9sZEluZm8gJiYgb2xkSW5mby5wYXJlbnQpIHtcbiAgICAgICAgICAgIG9sZFRvcCA9IG9sZEluZm8udG9wICsgb2xkSW5mby5wYXJlbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkudG9wO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgbmV3RWxlbWVudCA9IHRoaXMuYXZhdGFyLmN1cnJlbnQ7XG4gICAgICAgIGxldCBzdGFydFRvcE9mZnNldDtcbiAgICAgICAgaWYgKCFuZXdFbGVtZW50Lm9mZnNldFBhcmVudCkge1xuICAgICAgICAgICAgLy8gdGhpcyBzZWVtcyB0byBoYXBwZW4gc29tZXRpbWVzIGZvciByZWFzb25zIEkgZG9uJ3QgdW5kZXJzdGFuZFxuICAgICAgICAgICAgLy8gdGhlIGRvY3MgZm9yIGBvZmZzZXRQYXJlbnRgIHNheSBpdCBtYXkgYmUgbnVsbCBpZiBgZGlzcGxheWAgaXNcbiAgICAgICAgICAgIC8vIGBub25lYCwgYnV0IEkgY2FuJ3Qgc2VlIHdoeSB0aGF0IHdvdWxkIGhhcHBlbi5cbiAgICAgICAgICAgIGxvZ2dlci53YXJuKFxuICAgICAgICAgICAgICAgIGBSZWFkUmVjZWlwdE1hcmtlciBmb3IgJHt0aGlzLnByb3BzLmZhbGxiYWNrVXNlcklkfSBpbiBoYXMgbm8gb2Zmc2V0UGFyZW50YCxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBzdGFydFRvcE9mZnNldCA9IDA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzdGFydFRvcE9mZnNldCA9IG9sZFRvcCAtIG5ld0VsZW1lbnQub2Zmc2V0UGFyZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnRvcDtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHN0YXJ0U3R5bGVzID0gW107XG5cbiAgICAgICAgaWYgKG9sZEluZm8gJiYgb2xkSW5mby5sZWZ0KSB7XG4gICAgICAgICAgICAvLyBzdGFydCBhdCB0aGUgb2xkIGhlaWdodCBhbmQgaW4gdGhlIG9sZCBoIHBvc1xuICAgICAgICAgICAgc3RhcnRTdHlsZXMucHVzaCh7IHRvcDogc3RhcnRUb3BPZmZzZXQrXCJweFwiLFxuICAgICAgICAgICAgICAgIGxlZnQ6IHRvUHgob2xkSW5mby5sZWZ0KSB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHN0YXJ0U3R5bGVzLnB1c2goeyB0b3A6IHN0YXJ0VG9wT2Zmc2V0KydweCcsIGxlZnQ6ICcwJyB9KTtcblxuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIHN1cHByZXNzRGlzcGxheTogZmFsc2UsXG4gICAgICAgICAgICBzdGFydFN0eWxlczogc3RhcnRTdHlsZXMsXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyByZW5kZXIoKTogSlNYLkVsZW1lbnQge1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5zdXBwcmVzc0Rpc3BsYXkpIHtcbiAgICAgICAgICAgIHJldHVybiA8ZGl2IHJlZj17dGhpcy5hdmF0YXIgYXMgUmVmT2JqZWN0PEhUTUxEaXZFbGVtZW50Pn0gLz47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzdHlsZSA9IHtcbiAgICAgICAgICAgIGxlZnQ6IHRvUHgodGhpcy5wcm9wcy5sZWZ0T2Zmc2V0KSxcbiAgICAgICAgICAgIHRvcDogJzBweCcsXG4gICAgICAgIH07XG5cbiAgICAgICAgbGV0IHRpdGxlO1xuICAgICAgICBpZiAodGhpcy5wcm9wcy50aW1lc3RhbXApIHtcbiAgICAgICAgICAgIGNvbnN0IGRhdGVTdHJpbmcgPSBmb3JtYXREYXRlKG5ldyBEYXRlKHRoaXMucHJvcHMudGltZXN0YW1wKSwgdGhpcy5wcm9wcy5zaG93VHdlbHZlSG91cik7XG4gICAgICAgICAgICBpZiAoIXRoaXMucHJvcHMubWVtYmVyIHx8IHRoaXMucHJvcHMuZmFsbGJhY2tVc2VySWQgPT09IHRoaXMucHJvcHMubWVtYmVyLnJhd0Rpc3BsYXlOYW1lKSB7XG4gICAgICAgICAgICAgICAgdGl0bGUgPSBfdChcbiAgICAgICAgICAgICAgICAgICAgXCJTZWVuIGJ5ICUodXNlck5hbWUpcyBhdCAlKGRhdGVUaW1lKXNcIixcbiAgICAgICAgICAgICAgICAgICAgeyB1c2VyTmFtZTogdGhpcy5wcm9wcy5mYWxsYmFja1VzZXJJZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGVUaW1lOiBkYXRlU3RyaW5nIH0sXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGl0bGUgPSBfdChcbiAgICAgICAgICAgICAgICAgICAgXCJTZWVuIGJ5ICUoZGlzcGxheU5hbWUpcyAoJSh1c2VyTmFtZSlzKSBhdCAlKGRhdGVUaW1lKXNcIixcbiAgICAgICAgICAgICAgICAgICAgeyBkaXNwbGF5TmFtZTogdGhpcy5wcm9wcy5tZW1iZXIucmF3RGlzcGxheU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICB1c2VyTmFtZTogdGhpcy5wcm9wcy5mYWxsYmFja1VzZXJJZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGVUaW1lOiBkYXRlU3RyaW5nIH0sXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8Tm9kZUFuaW1hdG9yIHN0YXJ0U3R5bGVzPXt0aGlzLnN0YXRlLnN0YXJ0U3R5bGVzfT5cbiAgICAgICAgICAgICAgICA8TWVtYmVyQXZhdGFyXG4gICAgICAgICAgICAgICAgICAgIG1lbWJlcj17dGhpcy5wcm9wcy5tZW1iZXJ9XG4gICAgICAgICAgICAgICAgICAgIGZhbGxiYWNrVXNlcklkPXt0aGlzLnByb3BzLmZhbGxiYWNrVXNlcklkfVxuICAgICAgICAgICAgICAgICAgICBhcmlhLWhpZGRlbj1cInRydWVcIlxuICAgICAgICAgICAgICAgICAgICBhcmlhLWxpdmU9XCJvZmZcIlxuICAgICAgICAgICAgICAgICAgICB3aWR0aD17MTR9XG4gICAgICAgICAgICAgICAgICAgIGhlaWdodD17MTR9XG4gICAgICAgICAgICAgICAgICAgIHJlc2l6ZU1ldGhvZD1cImNyb3BcIlxuICAgICAgICAgICAgICAgICAgICBzdHlsZT17c3R5bGV9XG4gICAgICAgICAgICAgICAgICAgIHRpdGxlPXt0aXRsZX1cbiAgICAgICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5wcm9wcy5vbkNsaWNrfVxuICAgICAgICAgICAgICAgICAgICBpbnB1dFJlZj17dGhpcy5hdmF0YXIgYXMgUmVmT2JqZWN0PEhUTUxJbWFnZUVsZW1lbnQ+fVxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICA8L05vZGVBbmltYXRvcj5cbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=