"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _utils = require("matrix-js-sdk/src/utils");

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _AppsDrawer = _interopRequireDefault(require("./AppsDrawer"));

var _SettingsStore = _interopRequireDefault(require("../../../settings/SettingsStore"));

var _AutoHideScrollbar = _interopRequireDefault(require("../../structures/AutoHideScrollbar"));

var _UIFeature = require("../../../settings/UIFeature");

var _CallViewForRoom = _interopRequireDefault(require("../voip/CallViewForRoom"));

var _objects = require("../../../utils/objects");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _lodash = require("lodash");

var _dec, _class, _class2, _temp;

let AuxPanel = (_dec = (0, _replaceableComponent.replaceableComponent)("views.rooms.AuxPanel"), _dec(_class = (_temp = _class2 = class AuxPanel extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "rateLimitedUpdate", (0, _lodash.throttle)(() => {
      this.setState({
        counters: this.computeCounters()
      });
    }, 500, {
      leading: true,
      trailing: true
    }));
    this.state = {
      counters: this.computeCounters()
    };
  }

  componentDidMount() {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    if (_SettingsStore.default.getValue("feature_state_counters")) {
      cli.on("RoomState.events", this.rateLimitedUpdate);
    }
  }

  componentWillUnmount() {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    if (cli && _SettingsStore.default.getValue("feature_state_counters")) {
      cli.removeListener("RoomState.events", this.rateLimitedUpdate);
    }
  }

  shouldComponentUpdate(nextProps, nextState) {
    return (0, _objects.objectHasDiff)(this.props, nextProps) || (0, _objects.objectHasDiff)(this.state, nextState);
  }

  computeCounters() {
    const counters = [];

    if (this.props.room && _SettingsStore.default.getValue("feature_state_counters")) {
      const stateEvs = this.props.room.currentState.getStateEvents('re.jki.counter');
      stateEvs.sort((a, b) => (0, _utils.lexicographicCompare)(a.getStateKey(), b.getStateKey()));

      for (const ev of stateEvs) {
        const title = ev.getContent().title;
        const value = ev.getContent().value;
        const link = ev.getContent().link;
        const severity = ev.getContent().severity || "normal";
        const stateKey = ev.getStateKey(); // We want a non-empty title but can accept falsey values (e.g.
        // zero)

        if (title && value !== undefined) {
          counters.push({
            title,
            value,
            link,
            severity,
            stateKey
          });
        }
      }
    }

    return counters;
  }

  render() {
    const callView = /*#__PURE__*/_react.default.createElement(_CallViewForRoom.default, {
      roomId: this.props.room.roomId,
      resizeNotifier: this.props.resizeNotifier,
      showApps: this.props.showApps
    });

    let appsDrawer;

    if (_SettingsStore.default.getValue(_UIFeature.UIFeature.Widgets)) {
      appsDrawer = /*#__PURE__*/_react.default.createElement(_AppsDrawer.default, {
        room: this.props.room,
        userId: this.props.userId,
        showApps: this.props.showApps,
        resizeNotifier: this.props.resizeNotifier
      });
    }

    let stateViews = null;

    if (this.state.counters && _SettingsStore.default.getValue("feature_state_counters")) {
      const counters = [];
      this.state.counters.forEach((counter, idx) => {
        const title = counter.title;
        const value = counter.value;
        const link = counter.link;
        const severity = counter.severity;
        const stateKey = counter.stateKey;

        let span = /*#__PURE__*/_react.default.createElement("span", null, title, ": ", value);

        if (link) {
          span = /*#__PURE__*/_react.default.createElement("a", {
            href: link,
            target: "_blank",
            rel: "noreferrer noopener"
          }, span);
        }

        span = /*#__PURE__*/_react.default.createElement("span", {
          className: "m_RoomView_auxPanel_stateViews_span",
          "data-severity": severity,
          key: "x-" + stateKey
        }, span);
        counters.push(span);
        counters.push( /*#__PURE__*/_react.default.createElement("span", {
          className: "m_RoomView_auxPanel_stateViews_delim",
          key: "delim" + idx
        }, " \u2500 "));
      });

      if (counters.length > 0) {
        counters.pop(); // remove last deliminator

        stateViews = /*#__PURE__*/_react.default.createElement("div", {
          className: "m_RoomView_auxPanel_stateViews"
        }, counters);
      }
    }

    return /*#__PURE__*/_react.default.createElement(_AutoHideScrollbar.default, {
      className: "mx_RoomView_auxPanel"
    }, stateViews, this.props.children, appsDrawer, callView);
  }

}, (0, _defineProperty2.default)(_class2, "defaultProps", {
  showApps: true
}), _temp)) || _class);
exports.default = AuxPanel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3Jvb21zL0F1eFBhbmVsLnRzeCJdLCJuYW1lcyI6WyJBdXhQYW5lbCIsIlJlYWN0IiwiQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsInNldFN0YXRlIiwiY291bnRlcnMiLCJjb21wdXRlQ291bnRlcnMiLCJsZWFkaW5nIiwidHJhaWxpbmciLCJzdGF0ZSIsImNvbXBvbmVudERpZE1vdW50IiwiY2xpIiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0IiwiU2V0dGluZ3NTdG9yZSIsImdldFZhbHVlIiwib24iLCJyYXRlTGltaXRlZFVwZGF0ZSIsImNvbXBvbmVudFdpbGxVbm1vdW50IiwicmVtb3ZlTGlzdGVuZXIiLCJzaG91bGRDb21wb25lbnRVcGRhdGUiLCJuZXh0UHJvcHMiLCJuZXh0U3RhdGUiLCJyb29tIiwic3RhdGVFdnMiLCJjdXJyZW50U3RhdGUiLCJnZXRTdGF0ZUV2ZW50cyIsInNvcnQiLCJhIiwiYiIsImdldFN0YXRlS2V5IiwiZXYiLCJ0aXRsZSIsImdldENvbnRlbnQiLCJ2YWx1ZSIsImxpbmsiLCJzZXZlcml0eSIsInN0YXRlS2V5IiwidW5kZWZpbmVkIiwicHVzaCIsInJlbmRlciIsImNhbGxWaWV3Iiwicm9vbUlkIiwicmVzaXplTm90aWZpZXIiLCJzaG93QXBwcyIsImFwcHNEcmF3ZXIiLCJVSUZlYXR1cmUiLCJXaWRnZXRzIiwidXNlcklkIiwic3RhdGVWaWV3cyIsImZvckVhY2giLCJjb3VudGVyIiwiaWR4Iiwic3BhbiIsImxlbmd0aCIsInBvcCIsImNoaWxkcmVuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWdCQTs7QUFDQTs7QUFHQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztJQXVCcUJBLFEsV0FEcEIsZ0RBQXFCLHNCQUFyQixDLG1DQUFELE1BQ3FCQSxRQURyQixTQUNzQ0MsZUFBTUMsU0FENUMsQ0FD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QUFDTmtCLFVBQUFBLElBQUksZ0JBQ0E7QUFBRyxZQUFBLElBQUksRUFBRWxCLElBQVQ7QUFBZSxZQUFBLE1BQU0sRUFBQyxRQUF0QjtBQUErQixZQUFBLEdBQUcsRUFBQztBQUFuQyxhQUNNa0IsSUFETixDQURKO0FBS0g7O0FBRURBLFFBQUFBLElBQUksZ0JBQ0E7QUFDSSxVQUFBLFNBQVMsRUFBQyxxQ0FEZDtBQUVJLDJCQUFlakIsUUFGbkI7QUFHSSxVQUFBLEdBQUcsRUFBRSxPQUFPQztBQUhoQixXQUtNZ0IsSUFMTixDQURKO0FBVUFoRCxRQUFBQSxRQUFRLENBQUNrQyxJQUFULENBQWNjLElBQWQ7QUFDQWhELFFBQUFBLFFBQVEsQ0FBQ2tDLElBQVQsZUFDSTtBQUNJLFVBQUEsU0FBUyxFQUFDLHNDQURkO0FBRUksVUFBQSxHQUFHLEVBQUUsVUFBVWE7QUFGbkIsc0JBREo7QUFNSCxPQWxDRDs7QUFvQ0EsVUFBSS9DLFFBQVEsQ0FBQ2lELE1BQVQsR0FBa0IsQ0FBdEIsRUFBeUI7QUFDckJqRCxRQUFBQSxRQUFRLENBQUNrRCxHQUFULEdBRHFCLENBQ0w7O0FBQ2hCTixRQUFBQSxVQUFVLGdCQUNOO0FBQUssVUFBQSxTQUFTLEVBQUM7QUFBZixXQUNNNUMsUUFETixDQURKO0FBS0g7QUFDSjs7QUFFRCx3QkFDSSw2QkFBQywwQkFBRDtBQUFtQixNQUFBLFNBQVMsRUFBQztBQUE3QixPQUNNNEMsVUFETixFQUVNLEtBQUs5QyxLQUFMLENBQVdxRCxRQUZqQixFQUdNWCxVQUhOLEVBSU1KLFFBSk4sQ0FESjtBQVFIOztBQS9JaUUsQyx5REFDNUM7QUFDbEJHLEVBQUFBLFFBQVEsRUFBRTtBQURRLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTUsIDIwMTYsIDIwMTcsIDIwMjAgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgbGV4aWNvZ3JhcGhpY0NvbXBhcmUgfSBmcm9tICdtYXRyaXgtanMtc2RrL3NyYy91dGlscyc7XG5pbXBvcnQgeyBSb29tIH0gZnJvbSAnbWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3Jvb20nO1xuXG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tIFwiLi4vLi4vLi4vTWF0cml4Q2xpZW50UGVnXCI7XG5pbXBvcnQgQXBwc0RyYXdlciBmcm9tICcuL0FwcHNEcmF3ZXInO1xuaW1wb3J0IFNldHRpbmdzU3RvcmUgZnJvbSBcIi4uLy4uLy4uL3NldHRpbmdzL1NldHRpbmdzU3RvcmVcIjtcbmltcG9ydCBBdXRvSGlkZVNjcm9sbGJhciBmcm9tIFwiLi4vLi4vc3RydWN0dXJlcy9BdXRvSGlkZVNjcm9sbGJhclwiO1xuaW1wb3J0IHsgVUlGZWF0dXJlIH0gZnJvbSBcIi4uLy4uLy4uL3NldHRpbmdzL1VJRmVhdHVyZVwiO1xuaW1wb3J0IFJlc2l6ZU5vdGlmaWVyIGZyb20gXCIuLi8uLi8uLi91dGlscy9SZXNpemVOb3RpZmllclwiO1xuaW1wb3J0IENhbGxWaWV3Rm9yUm9vbSBmcm9tICcuLi92b2lwL0NhbGxWaWV3Rm9yUm9vbSc7XG5pbXBvcnQgeyBvYmplY3RIYXNEaWZmIH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL29iamVjdHNcIjtcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5pbXBvcnQgeyB0aHJvdHRsZSB9IGZyb20gJ2xvZGFzaCc7XG5cbmludGVyZmFjZSBJUHJvcHMge1xuICAgIC8vIGpzLXNkayByb29tIG9iamVjdFxuICAgIHJvb206IFJvb207XG4gICAgdXNlcklkOiBzdHJpbmc7XG4gICAgc2hvd0FwcHM6IGJvb2xlYW47IC8vIFJlbmRlciBhcHBzXG4gICAgcmVzaXplTm90aWZpZXI6IFJlc2l6ZU5vdGlmaWVyO1xufVxuXG5pbnRlcmZhY2UgQ291bnRlciB7XG4gICAgdGl0bGU6IHN0cmluZztcbiAgICB2YWx1ZTogbnVtYmVyO1xuICAgIGxpbms6IHN0cmluZztcbiAgICBzZXZlcml0eTogc3RyaW5nO1xuICAgIHN0YXRlS2V5OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBJU3RhdGUge1xuICAgIGNvdW50ZXJzOiBDb3VudGVyW107XG59XG5cbkByZXBsYWNlYWJsZUNvbXBvbmVudChcInZpZXdzLnJvb21zLkF1eFBhbmVsXCIpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBdXhQYW5lbCBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxJUHJvcHMsIElTdGF0ZT4ge1xuICAgIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgICAgIHNob3dBcHBzOiB0cnVlLFxuICAgIH07XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG5cbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIGNvdW50ZXJzOiB0aGlzLmNvbXB1dGVDb3VudGVycygpLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgICAgICBjb25zdCBjbGkgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIGlmIChTZXR0aW5nc1N0b3JlLmdldFZhbHVlKFwiZmVhdHVyZV9zdGF0ZV9jb3VudGVyc1wiKSkge1xuICAgICAgICAgICAgY2xpLm9uKFwiUm9vbVN0YXRlLmV2ZW50c1wiLCB0aGlzLnJhdGVMaW1pdGVkVXBkYXRlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgICBjb25zdCBjbGkgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIGlmIChjbGkgJiYgU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcImZlYXR1cmVfc3RhdGVfY291bnRlcnNcIikpIHtcbiAgICAgICAgICAgIGNsaS5yZW1vdmVMaXN0ZW5lcihcIlJvb21TdGF0ZS5ldmVudHNcIiwgdGhpcy5yYXRlTGltaXRlZFVwZGF0ZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzaG91bGRDb21wb25lbnRVcGRhdGUobmV4dFByb3BzLCBuZXh0U3RhdGUpIHtcbiAgICAgICAgcmV0dXJuIG9iamVjdEhhc0RpZmYodGhpcy5wcm9wcywgbmV4dFByb3BzKSB8fCBvYmplY3RIYXNEaWZmKHRoaXMuc3RhdGUsIG5leHRTdGF0ZSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByYXRlTGltaXRlZFVwZGF0ZSA9IHRocm90dGxlKCgpID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGNvdW50ZXJzOiB0aGlzLmNvbXB1dGVDb3VudGVycygpIH0pO1xuICAgIH0sIDUwMCwgeyBsZWFkaW5nOiB0cnVlLCB0cmFpbGluZzogdHJ1ZSB9KTtcblxuICAgIHByaXZhdGUgY29tcHV0ZUNvdW50ZXJzKCkge1xuICAgICAgICBjb25zdCBjb3VudGVycyA9IFtdO1xuXG4gICAgICAgIGlmICh0aGlzLnByb3BzLnJvb20gJiYgU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcImZlYXR1cmVfc3RhdGVfY291bnRlcnNcIikpIHtcbiAgICAgICAgICAgIGNvbnN0IHN0YXRlRXZzID0gdGhpcy5wcm9wcy5yb29tLmN1cnJlbnRTdGF0ZS5nZXRTdGF0ZUV2ZW50cygncmUuamtpLmNvdW50ZXInKTtcbiAgICAgICAgICAgIHN0YXRlRXZzLnNvcnQoKGEsIGIpID0+IGxleGljb2dyYXBoaWNDb21wYXJlKGEuZ2V0U3RhdGVLZXkoKSwgYi5nZXRTdGF0ZUtleSgpKSk7XG5cbiAgICAgICAgICAgIGZvciAoY29uc3QgZXYgb2Ygc3RhdGVFdnMpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB0aXRsZSA9IGV2LmdldENvbnRlbnQoKS50aXRsZTtcbiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGV2LmdldENvbnRlbnQoKS52YWx1ZTtcbiAgICAgICAgICAgICAgICBjb25zdCBsaW5rID0gZXYuZ2V0Q29udGVudCgpLmxpbms7XG4gICAgICAgICAgICAgICAgY29uc3Qgc2V2ZXJpdHkgPSBldi5nZXRDb250ZW50KCkuc2V2ZXJpdHkgfHwgXCJub3JtYWxcIjtcbiAgICAgICAgICAgICAgICBjb25zdCBzdGF0ZUtleSA9IGV2LmdldFN0YXRlS2V5KCk7XG5cbiAgICAgICAgICAgICAgICAvLyBXZSB3YW50IGEgbm9uLWVtcHR5IHRpdGxlIGJ1dCBjYW4gYWNjZXB0IGZhbHNleSB2YWx1ZXMgKGUuZy5cbiAgICAgICAgICAgICAgICAvLyB6ZXJvKVxuICAgICAgICAgICAgICAgIGlmICh0aXRsZSAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvdW50ZXJzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGUsXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmssXG4gICAgICAgICAgICAgICAgICAgICAgICBzZXZlcml0eSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlS2V5LFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gY291bnRlcnM7XG4gICAgfVxuXG4gICAgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCBjYWxsVmlldyA9IChcbiAgICAgICAgICAgIDxDYWxsVmlld0ZvclJvb21cbiAgICAgICAgICAgICAgICByb29tSWQ9e3RoaXMucHJvcHMucm9vbS5yb29tSWR9XG4gICAgICAgICAgICAgICAgcmVzaXplTm90aWZpZXI9e3RoaXMucHJvcHMucmVzaXplTm90aWZpZXJ9XG4gICAgICAgICAgICAgICAgc2hvd0FwcHM9e3RoaXMucHJvcHMuc2hvd0FwcHN9XG4gICAgICAgICAgICAvPlxuICAgICAgICApO1xuXG4gICAgICAgIGxldCBhcHBzRHJhd2VyO1xuICAgICAgICBpZiAoU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShVSUZlYXR1cmUuV2lkZ2V0cykpIHtcbiAgICAgICAgICAgIGFwcHNEcmF3ZXIgPSA8QXBwc0RyYXdlclxuICAgICAgICAgICAgICAgIHJvb209e3RoaXMucHJvcHMucm9vbX1cbiAgICAgICAgICAgICAgICB1c2VySWQ9e3RoaXMucHJvcHMudXNlcklkfVxuICAgICAgICAgICAgICAgIHNob3dBcHBzPXt0aGlzLnByb3BzLnNob3dBcHBzfVxuICAgICAgICAgICAgICAgIHJlc2l6ZU5vdGlmaWVyPXt0aGlzLnByb3BzLnJlc2l6ZU5vdGlmaWVyfVxuICAgICAgICAgICAgLz47XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgc3RhdGVWaWV3cyA9IG51bGw7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLmNvdW50ZXJzICYmIFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJmZWF0dXJlX3N0YXRlX2NvdW50ZXJzXCIpKSB7XG4gICAgICAgICAgICBjb25zdCBjb3VudGVycyA9IFtdO1xuXG4gICAgICAgICAgICB0aGlzLnN0YXRlLmNvdW50ZXJzLmZvckVhY2goKGNvdW50ZXIsIGlkeCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHRpdGxlID0gY291bnRlci50aXRsZTtcbiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGNvdW50ZXIudmFsdWU7XG4gICAgICAgICAgICAgICAgY29uc3QgbGluayA9IGNvdW50ZXIubGluaztcbiAgICAgICAgICAgICAgICBjb25zdCBzZXZlcml0eSA9IGNvdW50ZXIuc2V2ZXJpdHk7XG4gICAgICAgICAgICAgICAgY29uc3Qgc3RhdGVLZXkgPSBjb3VudGVyLnN0YXRlS2V5O1xuXG4gICAgICAgICAgICAgICAgbGV0IHNwYW4gPSA8c3Bhbj57IHRpdGxlIH06IHsgdmFsdWUgfTwvc3Bhbj47XG5cbiAgICAgICAgICAgICAgICBpZiAobGluaykge1xuICAgICAgICAgICAgICAgICAgICBzcGFuID0gKFxuICAgICAgICAgICAgICAgICAgICAgICAgPGEgaHJlZj17bGlua30gdGFyZ2V0PVwiX2JsYW5rXCIgcmVsPVwibm9yZWZlcnJlciBub29wZW5lclwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgc3BhbiB9XG4gICAgICAgICAgICAgICAgICAgICAgICA8L2E+XG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgc3BhbiA9IChcbiAgICAgICAgICAgICAgICAgICAgPHNwYW5cbiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm1fUm9vbVZpZXdfYXV4UGFuZWxfc3RhdGVWaWV3c19zcGFuXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEtc2V2ZXJpdHk9e3NldmVyaXR5fVxuICAgICAgICAgICAgICAgICAgICAgICAga2V5PXtcIngtXCIgKyBzdGF0ZUtleX1cbiAgICAgICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBzcGFuIH1cbiAgICAgICAgICAgICAgICAgICAgPC9zcGFuPlxuICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICBjb3VudGVycy5wdXNoKHNwYW4pO1xuICAgICAgICAgICAgICAgIGNvdW50ZXJzLnB1c2goXG4gICAgICAgICAgICAgICAgICAgIDxzcGFuXG4gICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJtX1Jvb21WaWV3X2F1eFBhbmVsX3N0YXRlVmlld3NfZGVsaW1cIlxuICAgICAgICAgICAgICAgICAgICAgICAga2V5PXtcImRlbGltXCIgKyBpZHh9XG4gICAgICAgICAgICAgICAgICAgID4g4pSAIDwvc3Bhbj4sXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpZiAoY291bnRlcnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIGNvdW50ZXJzLnBvcCgpOyAvLyByZW1vdmUgbGFzdCBkZWxpbWluYXRvclxuICAgICAgICAgICAgICAgIHN0YXRlVmlld3MgPSAoXG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibV9Sb29tVmlld19hdXhQYW5lbF9zdGF0ZVZpZXdzXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICB7IGNvdW50ZXJzIH1cbiAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8QXV0b0hpZGVTY3JvbGxiYXIgY2xhc3NOYW1lPVwibXhfUm9vbVZpZXdfYXV4UGFuZWxcIj5cbiAgICAgICAgICAgICAgICB7IHN0YXRlVmlld3MgfVxuICAgICAgICAgICAgICAgIHsgdGhpcy5wcm9wcy5jaGlsZHJlbiB9XG4gICAgICAgICAgICAgICAgeyBhcHBzRHJhd2VyIH1cbiAgICAgICAgICAgICAgICB7IGNhbGxWaWV3IH1cbiAgICAgICAgICAgIDwvQXV0b0hpZGVTY3JvbGxiYXI+XG4gICAgICAgICk7XG4gICAgfVxufVxuIl19