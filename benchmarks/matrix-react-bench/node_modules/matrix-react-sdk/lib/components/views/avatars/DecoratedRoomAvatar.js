"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _classnames = _interopRequireDefault(require("classnames"));

var _RoomAvatar = _interopRequireDefault(require("./RoomAvatar"));

var _NotificationBadge = _interopRequireDefault(require("../rooms/NotificationBadge"));

var _RoomNotificationStateStore = require("../../../stores/notifications/RoomNotificationStateStore");

var _presence = require("../../../utils/presence");

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _languageHandler = require("../../../languageHandler");

var _TextWithTooltip = _interopRequireDefault(require("../elements/TextWithTooltip"));

var _DMRoomMap = _interopRequireDefault(require("../../../utils/DMRoomMap"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _dec, _class;

var Icon;

(function (Icon) {
  Icon["None"] = "NONE";
  Icon["Globe"] = "GLOBE";
  Icon["PresenceOnline"] = "ONLINE";
  Icon["PresenceAway"] = "AWAY";
  Icon["PresenceOffline"] = "OFFLINE";
})(Icon || (Icon = {}));

function tooltipText(variant) {
  switch (variant) {
    case Icon.Globe:
      return (0, _languageHandler._t)("This room is public");

    case Icon.PresenceOnline:
      return (0, _languageHandler._t)("Online");

    case Icon.PresenceAway:
      return (0, _languageHandler._t)("Away");

    case Icon.PresenceOffline:
      return (0, _languageHandler._t)("Offline");
  }
}

let DecoratedRoomAvatar = (_dec = (0, _replaceableComponent.replaceableComponent)("views.avatars.DecoratedRoomAvatar"), _dec(_class = class DecoratedRoomAvatar extends _react.default.PureComponent {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "_dmUser", void 0);
    (0, _defineProperty2.default)(this, "isUnmounted", false);
    (0, _defineProperty2.default)(this, "isWatchingTimeline", false);
    (0, _defineProperty2.default)(this, "onRoomTimeline", (ev, room) => {
      if (this.isUnmounted) return; // apparently these can happen?

      if (!room) return;
      if (this.props.room.roomId !== room.roomId) return;

      if (ev.getType() === 'm.room.join_rules' || ev.getType() === 'm.room.member') {
        const newIcon = this.calculateIcon();

        if (newIcon !== this.state.icon) {
          this.setState({
            icon: newIcon
          });
        }
      }
    });
    (0, _defineProperty2.default)(this, "onPresenceUpdate", () => {
      if (this.isUnmounted) return;
      const newIcon = this.getPresenceIcon();
      if (newIcon !== this.state.icon) this.setState({
        icon: newIcon
      });
    });
    this.state = {
      notificationState: _RoomNotificationStateStore.RoomNotificationStateStore.instance.getRoomState(this.props.room),
      icon: this.calculateIcon()
    };
  }

  componentWillUnmount() {
    this.isUnmounted = true;
    if (this.isWatchingTimeline) this.props.room.off('Room.timeline', this.onRoomTimeline);
    this.dmUser = null; // clear listeners, if any
  }

  get isPublicRoom() {
    const joinRules = this.props.room.currentState.getStateEvents("m.room.join_rules", "");
    const joinRule = joinRules && joinRules.getContent().join_rule;
    return joinRule === 'public';
  }

  get dmUser() {
    return this._dmUser;
  }

  set dmUser(val) {
    const oldUser = this._dmUser;
    this._dmUser = val;

    if (oldUser && oldUser !== this._dmUser) {
      oldUser.off('User.currentlyActive', this.onPresenceUpdate);
      oldUser.off('User.presence', this.onPresenceUpdate);
    }

    if (this._dmUser && oldUser !== this._dmUser) {
      this._dmUser.on('User.currentlyActive', this.onPresenceUpdate);

      this._dmUser.on('User.presence', this.onPresenceUpdate);
    }
  }

  getPresenceIcon() {
    if (!this.dmUser) return Icon.None;
    let icon = Icon.None;
    const isOnline = this.dmUser.currentlyActive || this.dmUser.presence === 'online';

    if (isOnline) {
      icon = Icon.PresenceOnline;
    } else if (this.dmUser.presence === 'offline') {
      icon = Icon.PresenceOffline;
    } else if (this.dmUser.presence === 'unavailable') {
      icon = Icon.PresenceAway;
    }

    return icon;
  }

  calculateIcon() {
    let icon = Icon.None; // We look at the DMRoomMap and not the tag here so that we don't exclude DMs in Favourites

    const otherUserId = _DMRoomMap.default.shared().getUserIdForRoomId(this.props.room.roomId);

    if (otherUserId && this.props.room.getJoinedMemberCount() === 2) {
      // Track presence, if available
      if ((0, _presence.isPresenceEnabled)()) {
        if (otherUserId) {
          this.dmUser = _MatrixClientPeg.MatrixClientPeg.get().getUser(otherUserId);
          icon = this.getPresenceIcon();
        }
      }
    } else {
      // Track publicity
      icon = this.isPublicRoom ? Icon.Globe : Icon.None;

      if (!this.isWatchingTimeline) {
        this.props.room.on('Room.timeline', this.onRoomTimeline);
        this.isWatchingTimeline = true;
      }
    }

    return icon;
  }

  render() {
    let badge;

    if (this.props.displayBadge) {
      badge = /*#__PURE__*/_react.default.createElement(_NotificationBadge.default, {
        notification: this.state.notificationState,
        forceCount: this.props.forceCount,
        roomId: this.props.room.roomId
      });
    }

    let icon;

    if (this.state.icon !== Icon.None) {
      icon = /*#__PURE__*/_react.default.createElement(_TextWithTooltip.default, {
        tooltip: tooltipText(this.state.icon),
        class: `mx_DecoratedRoomAvatar_icon mx_DecoratedRoomAvatar_icon_${this.state.icon.toLowerCase()}`
      });
    }

    const classes = (0, _classnames.default)("mx_DecoratedRoomAvatar", {
      mx_DecoratedRoomAvatar_cutout: icon
    });
    return /*#__PURE__*/_react.default.createElement("div", {
      className: classes
    }, /*#__PURE__*/_react.default.createElement(_RoomAvatar.default, {
      room: this.props.room,
      width: this.props.avatarSize,
      height: this.props.avatarSize,
      oobData: this.props.oobData,
      viewAvatarOnClick: this.props.viewAvatarOnClick
    }), icon, badge);
  }

}) || _class);
exports.default = DecoratedRoomAvatar;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2F2YXRhcnMvRGVjb3JhdGVkUm9vbUF2YXRhci50c3giXSwibmFtZXMiOlsiSWNvbiIsInRvb2x0aXBUZXh0IiwidmFyaWFudCIsIkdsb2JlIiwiUHJlc2VuY2VPbmxpbmUiLCJQcmVzZW5jZUF3YXkiLCJQcmVzZW5jZU9mZmxpbmUiLCJEZWNvcmF0ZWRSb29tQXZhdGFyIiwiUmVhY3QiLCJQdXJlQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsImV2Iiwicm9vbSIsImlzVW5tb3VudGVkIiwicm9vbUlkIiwiZ2V0VHlwZSIsIm5ld0ljb24iLCJjYWxjdWxhdGVJY29uIiwic3RhdGUiLCJpY29uIiwic2V0U3RhdGUiLCJnZXRQcmVzZW5jZUljb24iLCJub3RpZmljYXRpb25TdGF0ZSIsIlJvb21Ob3RpZmljYXRpb25TdGF0ZVN0b3JlIiwiaW5zdGFuY2UiLCJnZXRSb29tU3RhdGUiLCJjb21wb25lbnRXaWxsVW5tb3VudCIsImlzV2F0Y2hpbmdUaW1lbGluZSIsIm9mZiIsIm9uUm9vbVRpbWVsaW5lIiwiZG1Vc2VyIiwiaXNQdWJsaWNSb29tIiwiam9pblJ1bGVzIiwiY3VycmVudFN0YXRlIiwiZ2V0U3RhdGVFdmVudHMiLCJqb2luUnVsZSIsImdldENvbnRlbnQiLCJqb2luX3J1bGUiLCJfZG1Vc2VyIiwidmFsIiwib2xkVXNlciIsIm9uUHJlc2VuY2VVcGRhdGUiLCJvbiIsIk5vbmUiLCJpc09ubGluZSIsImN1cnJlbnRseUFjdGl2ZSIsInByZXNlbmNlIiwib3RoZXJVc2VySWQiLCJETVJvb21NYXAiLCJzaGFyZWQiLCJnZXRVc2VySWRGb3JSb29tSWQiLCJnZXRKb2luZWRNZW1iZXJDb3VudCIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsImdldFVzZXIiLCJyZW5kZXIiLCJiYWRnZSIsImRpc3BsYXlCYWRnZSIsImZvcmNlQ291bnQiLCJ0b0xvd2VyQ2FzZSIsImNsYXNzZXMiLCJteF9EZWNvcmF0ZWRSb29tQXZhdGFyX2N1dG91dCIsImF2YXRhclNpemUiLCJvb2JEYXRhIiwidmlld0F2YXRhck9uQ2xpY2siXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUNBOztBQUtBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0lBaUJLQSxJOztXQUFBQSxJO0FBQUFBLEVBQUFBLEk7QUFBQUEsRUFBQUEsSTtBQUFBQSxFQUFBQSxJO0FBQUFBLEVBQUFBLEk7QUFBQUEsRUFBQUEsSTtHQUFBQSxJLEtBQUFBLEk7O0FBU0wsU0FBU0MsV0FBVCxDQUFxQkMsT0FBckIsRUFBb0M7QUFDaEMsVUFBUUEsT0FBUjtBQUNJLFNBQUtGLElBQUksQ0FBQ0csS0FBVjtBQUNJLGFBQU8seUJBQUcscUJBQUgsQ0FBUDs7QUFDSixTQUFLSCxJQUFJLENBQUNJLGNBQVY7QUFDSSxhQUFPLHlCQUFHLFFBQUgsQ0FBUDs7QUFDSixTQUFLSixJQUFJLENBQUNLLFlBQVY7QUFDSSxhQUFPLHlCQUFHLE1BQUgsQ0FBUDs7QUFDSixTQUFLTCxJQUFJLENBQUNNLGVBQVY7QUFDSSxhQUFPLHlCQUFHLFNBQUgsQ0FBUDtBQVJSO0FBVUg7O0lBR29CQyxtQixXQURwQixnREFBcUIsbUNBQXJCLEMsZ0JBQUQsTUFDcUJBLG1CQURyQixTQUNpREMsZUFBTUMsYUFEdkQsQ0FDcUY7QUFLakZDLEVBQUFBLFdBQVcsQ0FBQ0MsS0FBRCxFQUFnQjtBQUN2QixVQUFNQSxLQUFOO0FBRHVCO0FBQUEsdURBSEwsS0FHSztBQUFBLDhEQUZFLEtBRUY7QUFBQSwwREFzQ0YsQ0FBQ0MsRUFBRCxFQUFrQkMsSUFBbEIsS0FBaUM7QUFDdEQsVUFBSSxLQUFLQyxXQUFULEVBQXNCLE9BRGdDLENBR3REOztBQUNBLFVBQUksQ0FBQ0QsSUFBTCxFQUFXO0FBQ1gsVUFBSSxLQUFLRixLQUFMLENBQVdFLElBQVgsQ0FBZ0JFLE1BQWhCLEtBQTJCRixJQUFJLENBQUNFLE1BQXBDLEVBQTRD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LEtBQUtyRCxLQUFMLENBQVdzRDtBQUxsQyxNQURHLEVBUUQ3QyxJQVJDLEVBU0RxQyxLQVRDLENBQVA7QUFXSDs7QUEzSWdGLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMjAgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSBcInJlYWN0XCI7XG5pbXBvcnQgY2xhc3NOYW1lcyBmcm9tIFwiY2xhc3NuYW1lc1wiO1xuaW1wb3J0IHsgUm9vbSB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvcm9vbVwiO1xuaW1wb3J0IHsgVXNlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvdXNlclwiO1xuaW1wb3J0IHsgTWF0cml4RXZlbnQgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL2V2ZW50XCI7XG5cbmltcG9ydCBSb29tQXZhdGFyIGZyb20gXCIuL1Jvb21BdmF0YXJcIjtcbmltcG9ydCBOb3RpZmljYXRpb25CYWRnZSBmcm9tICcuLi9yb29tcy9Ob3RpZmljYXRpb25CYWRnZSc7XG5pbXBvcnQgeyBSb29tTm90aWZpY2F0aW9uU3RhdGVTdG9yZSB9IGZyb20gXCIuLi8uLi8uLi9zdG9yZXMvbm90aWZpY2F0aW9ucy9Sb29tTm90aWZpY2F0aW9uU3RhdGVTdG9yZVwiO1xuaW1wb3J0IHsgTm90aWZpY2F0aW9uU3RhdGUgfSBmcm9tIFwiLi4vLi4vLi4vc3RvcmVzL25vdGlmaWNhdGlvbnMvTm90aWZpY2F0aW9uU3RhdGVcIjtcbmltcG9ydCB7IGlzUHJlc2VuY2VFbmFibGVkIH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3ByZXNlbmNlXCI7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tIFwiLi4vLi4vLi4vTWF0cml4Q2xpZW50UGVnXCI7XG5pbXBvcnQgeyBfdCB9IGZyb20gXCIuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXJcIjtcbmltcG9ydCBUZXh0V2l0aFRvb2x0aXAgZnJvbSBcIi4uL2VsZW1lbnRzL1RleHRXaXRoVG9vbHRpcFwiO1xuaW1wb3J0IERNUm9vbU1hcCBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvRE1Sb29tTWFwXCI7XG5pbXBvcnQgeyByZXBsYWNlYWJsZUNvbXBvbmVudCB9IGZyb20gXCIuLi8uLi8uLi91dGlscy9yZXBsYWNlYWJsZUNvbXBvbmVudFwiO1xuaW1wb3J0IHsgSU9PQkRhdGEgfSBmcm9tIFwiLi4vLi4vLi4vc3RvcmVzL1RocmVlcGlkSW52aXRlU3RvcmVcIjtcblxuaW50ZXJmYWNlIElQcm9wcyB7XG4gICAgcm9vbTogUm9vbTtcbiAgICBhdmF0YXJTaXplOiBudW1iZXI7XG4gICAgZGlzcGxheUJhZGdlPzogYm9vbGVhbjtcbiAgICBmb3JjZUNvdW50PzogYm9vbGVhbjtcbiAgICBvb2JEYXRhPzogSU9PQkRhdGE7XG4gICAgdmlld0F2YXRhck9uQ2xpY2s/OiBib29sZWFuO1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBub3RpZmljYXRpb25TdGF0ZT86IE5vdGlmaWNhdGlvblN0YXRlO1xuICAgIGljb246IEljb247XG59XG5cbmVudW0gSWNvbiB7XG4gICAgLy8gTm90ZTogdGhlIG5hbWVzIGhlcmUgYXJlIHVzZWQgaW4gQ1NTIGNsYXNzIG5hbWVzXG4gICAgTm9uZSA9IFwiTk9ORVwiLCAvLyAuLi4gZXhjZXB0IHRoaXMgb25lXG4gICAgR2xvYmUgPSBcIkdMT0JFXCIsXG4gICAgUHJlc2VuY2VPbmxpbmUgPSBcIk9OTElORVwiLFxuICAgIFByZXNlbmNlQXdheSA9IFwiQVdBWVwiLFxuICAgIFByZXNlbmNlT2ZmbGluZSA9IFwiT0ZGTElORVwiLFxufVxuXG5mdW5jdGlvbiB0b29sdGlwVGV4dCh2YXJpYW50OiBJY29uKSB7XG4gICAgc3dpdGNoICh2YXJpYW50KSB7XG4gICAgICAgIGNhc2UgSWNvbi5HbG9iZTpcbiAgICAgICAgICAgIHJldHVybiBfdChcIlRoaXMgcm9vbSBpcyBwdWJsaWNcIik7XG4gICAgICAgIGNhc2UgSWNvbi5QcmVzZW5jZU9ubGluZTpcbiAgICAgICAgICAgIHJldHVybiBfdChcIk9ubGluZVwiKTtcbiAgICAgICAgY2FzZSBJY29uLlByZXNlbmNlQXdheTpcbiAgICAgICAgICAgIHJldHVybiBfdChcIkF3YXlcIik7XG4gICAgICAgIGNhc2UgSWNvbi5QcmVzZW5jZU9mZmxpbmU6XG4gICAgICAgICAgICByZXR1cm4gX3QoXCJPZmZsaW5lXCIpO1xuICAgIH1cbn1cblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3MuYXZhdGFycy5EZWNvcmF0ZWRSb29tQXZhdGFyXCIpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBEZWNvcmF0ZWRSb29tQXZhdGFyIGV4dGVuZHMgUmVhY3QuUHVyZUNvbXBvbmVudDxJUHJvcHMsIElTdGF0ZT4ge1xuICAgIHByaXZhdGUgX2RtVXNlcjogVXNlcjtcbiAgICBwcml2YXRlIGlzVW5tb3VudGVkID0gZmFsc2U7XG4gICAgcHJpdmF0ZSBpc1dhdGNoaW5nVGltZWxpbmUgPSBmYWxzZTtcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBJUHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuXG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICBub3RpZmljYXRpb25TdGF0ZTogUm9vbU5vdGlmaWNhdGlvblN0YXRlU3RvcmUuaW5zdGFuY2UuZ2V0Um9vbVN0YXRlKHRoaXMucHJvcHMucm9vbSksXG4gICAgICAgICAgICBpY29uOiB0aGlzLmNhbGN1bGF0ZUljb24oKSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgICAgIHRoaXMuaXNVbm1vdW50ZWQgPSB0cnVlO1xuICAgICAgICBpZiAodGhpcy5pc1dhdGNoaW5nVGltZWxpbmUpIHRoaXMucHJvcHMucm9vbS5vZmYoJ1Jvb20udGltZWxpbmUnLCB0aGlzLm9uUm9vbVRpbWVsaW5lKTtcbiAgICAgICAgdGhpcy5kbVVzZXIgPSBudWxsOyAvLyBjbGVhciBsaXN0ZW5lcnMsIGlmIGFueVxuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0IGlzUHVibGljUm9vbSgpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3Qgam9pblJ1bGVzID0gdGhpcy5wcm9wcy5yb29tLmN1cnJlbnRTdGF0ZS5nZXRTdGF0ZUV2ZW50cyhcIm0ucm9vbS5qb2luX3J1bGVzXCIsIFwiXCIpO1xuICAgICAgICBjb25zdCBqb2luUnVsZSA9IGpvaW5SdWxlcyAmJiBqb2luUnVsZXMuZ2V0Q29udGVudCgpLmpvaW5fcnVsZTtcbiAgICAgICAgcmV0dXJuIGpvaW5SdWxlID09PSAncHVibGljJztcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldCBkbVVzZXIoKTogVXNlciB7XG4gICAgICAgIHJldHVybiB0aGlzLl9kbVVzZXI7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzZXQgZG1Vc2VyKHZhbDogVXNlcikge1xuICAgICAgICBjb25zdCBvbGRVc2VyID0gdGhpcy5fZG1Vc2VyO1xuICAgICAgICB0aGlzLl9kbVVzZXIgPSB2YWw7XG4gICAgICAgIGlmIChvbGRVc2VyICYmIG9sZFVzZXIgIT09IHRoaXMuX2RtVXNlcikge1xuICAgICAgICAgICAgb2xkVXNlci5vZmYoJ1VzZXIuY3VycmVudGx5QWN0aXZlJywgdGhpcy5vblByZXNlbmNlVXBkYXRlKTtcbiAgICAgICAgICAgIG9sZFVzZXIub2ZmKCdVc2VyLnByZXNlbmNlJywgdGhpcy5vblByZXNlbmNlVXBkYXRlKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5fZG1Vc2VyICYmIG9sZFVzZXIgIT09IHRoaXMuX2RtVXNlcikge1xuICAgICAgICAgICAgdGhpcy5fZG1Vc2VyLm9uKCdVc2VyLmN1cnJlbnRseUFjdGl2ZScsIHRoaXMub25QcmVzZW5jZVVwZGF0ZSk7XG4gICAgICAgICAgICB0aGlzLl9kbVVzZXIub24oJ1VzZXIucHJlc2VuY2UnLCB0aGlzLm9uUHJlc2VuY2VVcGRhdGUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvblJvb21UaW1lbGluZSA9IChldjogTWF0cml4RXZlbnQsIHJvb206IFJvb20pID0+IHtcbiAgICAgICAgaWYgKHRoaXMuaXNVbm1vdW50ZWQpIHJldHVybjtcblxuICAgICAgICAvLyBhcHBhcmVudGx5IHRoZXNlIGNhbiBoYXBwZW4/XG4gICAgICAgIGlmICghcm9vbSkgcmV0dXJuO1xuICAgICAgICBpZiAodGhpcy5wcm9wcy5yb29tLnJvb21JZCAhPT0gcm9vbS5yb29tSWQpIHJldHVybjtcblxuICAgICAgICBpZiAoZXYuZ2V0VHlwZSgpID09PSAnbS5yb29tLmpvaW5fcnVsZXMnIHx8IGV2LmdldFR5cGUoKSA9PT0gJ20ucm9vbS5tZW1iZXInKSB7XG4gICAgICAgICAgICBjb25zdCBuZXdJY29uID0gdGhpcy5jYWxjdWxhdGVJY29uKCk7XG4gICAgICAgICAgICBpZiAobmV3SWNvbiAhPT0gdGhpcy5zdGF0ZS5pY29uKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGljb246IG5ld0ljb24gfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvblByZXNlbmNlVXBkYXRlID0gKCkgPT4ge1xuICAgICAgICBpZiAodGhpcy5pc1VubW91bnRlZCkgcmV0dXJuO1xuXG4gICAgICAgIGNvbnN0IG5ld0ljb24gPSB0aGlzLmdldFByZXNlbmNlSWNvbigpO1xuICAgICAgICBpZiAobmV3SWNvbiAhPT0gdGhpcy5zdGF0ZS5pY29uKSB0aGlzLnNldFN0YXRlKHsgaWNvbjogbmV3SWNvbiB9KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBnZXRQcmVzZW5jZUljb24oKTogSWNvbiB7XG4gICAgICAgIGlmICghdGhpcy5kbVVzZXIpIHJldHVybiBJY29uLk5vbmU7XG5cbiAgICAgICAgbGV0IGljb24gPSBJY29uLk5vbmU7XG5cbiAgICAgICAgY29uc3QgaXNPbmxpbmUgPSB0aGlzLmRtVXNlci5jdXJyZW50bHlBY3RpdmUgfHwgdGhpcy5kbVVzZXIucHJlc2VuY2UgPT09ICdvbmxpbmUnO1xuICAgICAgICBpZiAoaXNPbmxpbmUpIHtcbiAgICAgICAgICAgIGljb24gPSBJY29uLlByZXNlbmNlT25saW5lO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuZG1Vc2VyLnByZXNlbmNlID09PSAnb2ZmbGluZScpIHtcbiAgICAgICAgICAgIGljb24gPSBJY29uLlByZXNlbmNlT2ZmbGluZTtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmRtVXNlci5wcmVzZW5jZSA9PT0gJ3VuYXZhaWxhYmxlJykge1xuICAgICAgICAgICAgaWNvbiA9IEljb24uUHJlc2VuY2VBd2F5O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGljb247XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjYWxjdWxhdGVJY29uKCk6IEljb24ge1xuICAgICAgICBsZXQgaWNvbiA9IEljb24uTm9uZTtcblxuICAgICAgICAvLyBXZSBsb29rIGF0IHRoZSBETVJvb21NYXAgYW5kIG5vdCB0aGUgdGFnIGhlcmUgc28gdGhhdCB3ZSBkb24ndCBleGNsdWRlIERNcyBpbiBGYXZvdXJpdGVzXG4gICAgICAgIGNvbnN0IG90aGVyVXNlcklkID0gRE1Sb29tTWFwLnNoYXJlZCgpLmdldFVzZXJJZEZvclJvb21JZCh0aGlzLnByb3BzLnJvb20ucm9vbUlkKTtcbiAgICAgICAgaWYgKG90aGVyVXNlcklkICYmIHRoaXMucHJvcHMucm9vbS5nZXRKb2luZWRNZW1iZXJDb3VudCgpID09PSAyKSB7XG4gICAgICAgICAgICAvLyBUcmFjayBwcmVzZW5jZSwgaWYgYXZhaWxhYmxlXG4gICAgICAgICAgICBpZiAoaXNQcmVzZW5jZUVuYWJsZWQoKSkge1xuICAgICAgICAgICAgICAgIGlmIChvdGhlclVzZXJJZCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmRtVXNlciA9IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRVc2VyKG90aGVyVXNlcklkKTtcbiAgICAgICAgICAgICAgICAgICAgaWNvbiA9IHRoaXMuZ2V0UHJlc2VuY2VJY29uKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gVHJhY2sgcHVibGljaXR5XG4gICAgICAgICAgICBpY29uID0gdGhpcy5pc1B1YmxpY1Jvb20gPyBJY29uLkdsb2JlIDogSWNvbi5Ob25lO1xuICAgICAgICAgICAgaWYgKCF0aGlzLmlzV2F0Y2hpbmdUaW1lbGluZSkge1xuICAgICAgICAgICAgICAgIHRoaXMucHJvcHMucm9vbS5vbignUm9vbS50aW1lbGluZScsIHRoaXMub25Sb29tVGltZWxpbmUpO1xuICAgICAgICAgICAgICAgIHRoaXMuaXNXYXRjaGluZ1RpbWVsaW5lID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaWNvbjtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVuZGVyKCk6IFJlYWN0LlJlYWN0Tm9kZSB7XG4gICAgICAgIGxldCBiYWRnZTogUmVhY3QuUmVhY3ROb2RlO1xuICAgICAgICBpZiAodGhpcy5wcm9wcy5kaXNwbGF5QmFkZ2UpIHtcbiAgICAgICAgICAgIGJhZGdlID0gPE5vdGlmaWNhdGlvbkJhZGdlXG4gICAgICAgICAgICAgICAgbm90aWZpY2F0aW9uPXt0aGlzLnN0YXRlLm5vdGlmaWNhdGlvblN0YXRlfVxuICAgICAgICAgICAgICAgIGZvcmNlQ291bnQ9e3RoaXMucHJvcHMuZm9yY2VDb3VudH1cbiAgICAgICAgICAgICAgICByb29tSWQ9e3RoaXMucHJvcHMucm9vbS5yb29tSWR9XG4gICAgICAgICAgICAvPjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBpY29uO1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5pY29uICE9PSBJY29uLk5vbmUpIHtcbiAgICAgICAgICAgIGljb24gPSA8VGV4dFdpdGhUb29sdGlwXG4gICAgICAgICAgICAgICAgdG9vbHRpcD17dG9vbHRpcFRleHQodGhpcy5zdGF0ZS5pY29uKX1cbiAgICAgICAgICAgICAgICBjbGFzcz17YG14X0RlY29yYXRlZFJvb21BdmF0YXJfaWNvbiBteF9EZWNvcmF0ZWRSb29tQXZhdGFyX2ljb25fJHt0aGlzLnN0YXRlLmljb24udG9Mb3dlckNhc2UoKX1gfVxuICAgICAgICAgICAgLz47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBjbGFzc2VzID0gY2xhc3NOYW1lcyhcIm14X0RlY29yYXRlZFJvb21BdmF0YXJcIiwge1xuICAgICAgICAgICAgbXhfRGVjb3JhdGVkUm9vbUF2YXRhcl9jdXRvdXQ6IGljb24sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiA8ZGl2IGNsYXNzTmFtZT17Y2xhc3Nlc30+XG4gICAgICAgICAgICA8Um9vbUF2YXRhclxuICAgICAgICAgICAgICAgIHJvb209e3RoaXMucHJvcHMucm9vbX1cbiAgICAgICAgICAgICAgICB3aWR0aD17dGhpcy5wcm9wcy5hdmF0YXJTaXplfVxuICAgICAgICAgICAgICAgIGhlaWdodD17dGhpcy5wcm9wcy5hdmF0YXJTaXplfVxuICAgICAgICAgICAgICAgIG9vYkRhdGE9e3RoaXMucHJvcHMub29iRGF0YX1cbiAgICAgICAgICAgICAgICB2aWV3QXZhdGFyT25DbGljaz17dGhpcy5wcm9wcy52aWV3QXZhdGFyT25DbGlja31cbiAgICAgICAgICAgIC8+XG4gICAgICAgICAgICB7IGljb24gfVxuICAgICAgICAgICAgeyBiYWRnZSB9XG4gICAgICAgIDwvZGl2PjtcbiAgICB9XG59XG4iXX0=