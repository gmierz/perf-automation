"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _react = _interopRequireWildcard(require("react"));

var _classnames = _interopRequireDefault(require("classnames"));

var AvatarLogic = _interopRequireWildcard(require("../../../Avatar"));

var _SettingsStore = _interopRequireDefault(require("../../../settings/SettingsStore"));

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _RoomContext = _interopRequireDefault(require("../../../contexts/RoomContext"));

var _MatrixClientContext = _interopRequireDefault(require("../../../contexts/MatrixClientContext"));

var _useEventEmitter = require("../../../hooks/useEventEmitter");

var _units = require("../../../utils/units");

var _languageHandler = require("../../../languageHandler");

const _excluded = ["name", "idName", "title", "url", "urls", "width", "height", "resizeMethod", "defaultToInitialLetter", "onClick", "inputRef", "className"];

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

const calculateUrls = (url, urls, lowBandwidth) => {
  // work out the full set of urls to try to load. This is formed like so:
  // imageUrls: [ props.url, ...props.urls ]
  let _urls = [];

  if (!lowBandwidth) {
    _urls = urls || [];

    if (url) {
      // copy urls and put url first
      _urls = [url, ..._urls];
    }
  } // deduplicate URLs


  return Array.from(new Set(_urls));
};

const useImageUrl = ({
  url,
  urls
}) => {
  // Since this is a hot code path and the settings store can be slow, we
  // use the cached lowBandwidth value from the room context if it exists
  const roomContext = (0, _react.useContext)(_RoomContext.default);
  const lowBandwidth = roomContext ? roomContext.lowBandwidth : _SettingsStore.default.getValue("lowBandwidth");
  const [imageUrls, setUrls] = (0, _react.useState)(calculateUrls(url, urls, lowBandwidth));
  const [urlsIndex, setIndex] = (0, _react.useState)(0);
  const onError = (0, _react.useCallback)(() => {
    setIndex(i => i + 1); // try the next one
  }, []);
  (0, _react.useEffect)(() => {
    setUrls(calculateUrls(url, urls, lowBandwidth));
    setIndex(0);
  }, [url, JSON.stringify(urls)]); // eslint-disable-line react-hooks/exhaustive-deps

  const cli = (0, _react.useContext)(_MatrixClientContext.default);
  const onClientSync = (0, _react.useCallback)((syncState, prevState) => {
    // Consider the client reconnected if there is no error with syncing.
    // This means the state could be RECONNECTING, SYNCING, PREPARED or CATCHUP.
    const reconnected = syncState !== "ERROR" && prevState !== syncState;

    if (reconnected) {
      setIndex(0);
    }
  }, []);
  (0, _useEventEmitter.useEventEmitter)(cli, "sync", onClientSync);
  const imageUrl = imageUrls[urlsIndex];
  return [imageUrl, onError];
};

const BaseAvatar = props => {
  const {
    name,
    idName,
    title,
    url,
    urls,
    width = 40,
    height = 40,
    resizeMethod = "crop",
    // eslint-disable-line @typescript-eslint/no-unused-vars
    defaultToInitialLetter = true,
    onClick,
    inputRef,
    className
  } = props,
        otherProps = (0, _objectWithoutProperties2.default)(props, _excluded);
  const [imageUrl, onError] = useImageUrl({
    url,
    urls
  });

  if (!imageUrl && defaultToInitialLetter) {
    const initialLetter = AvatarLogic.getInitialLetter(name);

    const textNode = /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_BaseAvatar_initial",
      "aria-hidden": "true",
      style: {
        fontSize: (0, _units.toPx)(width * 0.65),
        width: (0, _units.toPx)(width),
        lineHeight: (0, _units.toPx)(height)
      }
    }, initialLetter);

    const imgNode = /*#__PURE__*/_react.default.createElement("img", {
      className: "mx_BaseAvatar_image",
      src: AvatarLogic.defaultAvatarUrlForString(idName || name),
      alt: "",
      title: title,
      onError: onError,
      style: {
        width: (0, _units.toPx)(width),
        height: (0, _units.toPx)(height)
      },
      "aria-hidden": "true"
    });

    if (onClick) {
      return /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, (0, _extends2.default)({
        "aria-label": (0, _languageHandler._t)("Avatar"),
        "aria-live": "off"
      }, otherProps, {
        element: "span",
        className: (0, _classnames.default)("mx_BaseAvatar", className),
        onClick: onClick,
        inputRef: inputRef
      }), textNode, imgNode);
    } else {
      return /*#__PURE__*/_react.default.createElement("span", (0, _extends2.default)({
        className: (0, _classnames.default)("mx_BaseAvatar", className),
        ref: inputRef
      }, otherProps, {
        role: "presentation"
      }), textNode, imgNode);
    }
  }

  if (onClick) {
    return /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, (0, _extends2.default)({
      className: (0, _classnames.default)("mx_BaseAvatar mx_BaseAvatar_image", className),
      element: "img",
      src: imageUrl,
      onClick: onClick,
      onError: onError,
      style: {
        width: (0, _units.toPx)(width),
        height: (0, _units.toPx)(height)
      },
      title: title,
      alt: (0, _languageHandler._t)("Avatar"),
      inputRef: inputRef
    }, otherProps));
  } else {
    return /*#__PURE__*/_react.default.createElement("img", (0, _extends2.default)({
      className: (0, _classnames.default)("mx_BaseAvatar mx_BaseAvatar_image", className),
      src: imageUrl,
      onError: onError,
      style: {
        width: (0, _units.toPx)(width),
        height: (0, _units.toPx)(height)
      },
      title: title,
      alt: "",
      ref: inputRef
    }, otherProps));
  }
};

var _default = BaseAvatar;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2F2YXRhcnMvQmFzZUF2YXRhci50c3giXSwibmFtZXMiOlsiY2FsY3VsYXRlVXJscyIsInVybCIsInVybHMiLCJsb3dCYW5kd2lkdGgiLCJfdXJscyIsIkFycmF5IiwiZnJvbSIsIlNldCIsInVzZUltYWdlVXJsIiwicm9vbUNvbnRleHQiLCJSb29tQ29udGV4dCIsIlNldHRpbmdzU3RvcmUiLCJnZXRWYWx1ZSIsImltYWdlVXJscyIsInNldFVybHMiLCJ1cmxzSW5kZXgiLCJzZXRJbmRleCIsIm9uRXJyb3IiLCJpIiwiSlNPTiIsInN0cmluZ2lmeSIsImNsaSIsIk1hdHJpeENsaWVudENvbnRleHQiLCJvbkNsaWVudFN5bmMiLCJzeW5jU3RhdGUiLCJwcmV2U3RhdGUiLCJyZWNvbm5lY3RlZCIsImltYWdlVXJsIiwiQmFzZUF2YXRhciIsInByb3BzIiwibmFtZSIsImlkTmFtZSIsInRpdGxlIiwid2lkdGgiLCJoZWlnaHQiLCJyZXNpemVNZXRob2QiLCJkZWZhdWx0VG9Jbml0aWFsTGV0dGVyIiwib25DbGljayIsImlucHV0UmVmIiwiY2xhc3NOYW1lIiwib3RoZXJQcm9wcyIsImluaXRpYWxMZXR0ZXIiLCJBdmF0YXJMb2dpYyIsImdldEluaXRpYWxMZXR0ZXIiLCJ0ZXh0Tm9kZSIsImZvbnRTaXplIiwibGluZUhlaWdodCIsImltZ05vZGUiLCJkZWZhdWx0QXZhdGFyVXJsRm9yU3RyaW5nIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBbUJBOztBQUNBOztBQUdBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7OztBQWtCQSxNQUFNQSxhQUFhLEdBQUcsQ0FBQ0MsR0FBRCxFQUFNQyxJQUFOLEVBQVlDLFlBQVosS0FBNkI7QUFDL0M7QUFDQTtBQUVBLE1BQUlDLEtBQUssR0FBRyxFQUFaOztBQUNBLE1BQUksQ0FBQ0QsWUFBTCxFQUFtQjtBQUNmQyxJ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bkNvcHlyaWdodCAyMDE1LCAyMDE2IE9wZW5NYXJrZXQgTHRkXG5Db3B5cmlnaHQgMjAxOCBOZXcgVmVjdG9yIEx0ZFxuQ29weXJpZ2h0IDIwMTkgTWljaGFlbCBUZWxhdHluc2tpIDw3dDNjaGd1eUBnbWFpbC5jb20+XG5Db3B5cmlnaHQgMjAxOSwgMjAyMCBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCwgeyB1c2VDYWxsYmFjaywgdXNlQ29udGV4dCwgdXNlRWZmZWN0LCB1c2VTdGF0ZSB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCBjbGFzc05hbWVzIGZyb20gJ2NsYXNzbmFtZXMnO1xuaW1wb3J0IHsgUmVzaXplTWV0aG9kIH0gZnJvbSAnbWF0cml4LWpzLXNkay9zcmMvQHR5cGVzL3BhcnRpYWxzJztcblxuaW1wb3J0ICogYXMgQXZhdGFyTG9naWMgZnJvbSAnLi4vLi4vLi4vQXZhdGFyJztcbmltcG9ydCBTZXR0aW5nc1N0b3JlIGZyb20gXCIuLi8uLi8uLi9zZXR0aW5ncy9TZXR0aW5nc1N0b3JlXCI7XG5pbXBvcnQgQWNjZXNzaWJsZUJ1dHRvbiBmcm9tICcuLi9lbGVtZW50cy9BY2Nlc3NpYmxlQnV0dG9uJztcbmltcG9ydCBSb29tQ29udGV4dCBmcm9tIFwiLi4vLi4vLi4vY29udGV4dHMvUm9vbUNvbnRleHRcIjtcbmltcG9ydCBNYXRyaXhDbGllbnRDb250ZXh0IGZyb20gXCIuLi8uLi8uLi9jb250ZXh0cy9NYXRyaXhDbGllbnRDb250ZXh0XCI7XG5pbXBvcnQgeyB1c2VFdmVudEVtaXR0ZXIgfSBmcm9tIFwiLi4vLi4vLi4vaG9va3MvdXNlRXZlbnRFbWl0dGVyXCI7XG5pbXBvcnQgeyB0b1B4IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3VuaXRzXCI7XG5pbXBvcnQgeyBfdCB9IGZyb20gJy4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlcic7XG5cbmludGVyZmFjZSBJUHJvcHMge1xuICAgIG5hbWU6IHN0cmluZzsgLy8gVGhlIG5hbWUgKGZpcnN0IGluaXRpYWwgdXNlZCBhcyBkZWZhdWx0KVxuICAgIGlkTmFtZT86IHN0cmluZzsgLy8gSUQgZm9yIGdlbmVyYXRpbmcgaGFzaCBjb2xvdXJzXG4gICAgdGl0bGU/OiBzdHJpbmc7IC8vIG9uSG92ZXIgdGl0bGUgdGV4dFxuICAgIHVybD86IHN0cmluZzsgLy8gaGlnaGVzdCBwcmlvcml0eSBvZiB0aGVtIGFsbCwgc2hvcnRjdXQgdG8gc2V0IGluIHVybHNbMF1cbiAgICB1cmxzPzogc3RyaW5nW107IC8vIFtoaWdoZXN0X3ByaW9yaXR5LCAuLi4gLCBsb3dlc3RfcHJpb3JpdHldXG4gICAgd2lkdGg/OiBudW1iZXI7XG4gICAgaGVpZ2h0PzogbnVtYmVyO1xuICAgIC8vIFhYWDogcmVzaXplTWV0aG9kIG5vdCBhY3R1YWxseSB1c2VkLlxuICAgIHJlc2l6ZU1ldGhvZD86IFJlc2l6ZU1ldGhvZDtcbiAgICBkZWZhdWx0VG9Jbml0aWFsTGV0dGVyPzogYm9vbGVhbjsgLy8gdHJ1ZSB0byBhZGQgZGVmYXVsdCB1cmxcbiAgICBvbkNsaWNrPzogUmVhY3QuTW91c2VFdmVudEhhbmRsZXI7XG4gICAgaW5wdXRSZWY/OiBSZWFjdC5SZWZPYmplY3Q8SFRNTEltYWdlRWxlbWVudCAmIEhUTUxTcGFuRWxlbWVudD47XG4gICAgY2xhc3NOYW1lPzogc3RyaW5nO1xufVxuXG5jb25zdCBjYWxjdWxhdGVVcmxzID0gKHVybCwgdXJscywgbG93QmFuZHdpZHRoKSA9PiB7XG4gICAgLy8gd29yayBvdXQgdGhlIGZ1bGwgc2V0IG9mIHVybHMgdG8gdHJ5IHRvIGxvYWQuIFRoaXMgaXMgZm9ybWVkIGxpa2Ugc286XG4gICAgLy8gaW1hZ2VVcmxzOiBbIHByb3BzLnVybCwgLi4ucHJvcHMudXJscyBdXG5cbiAgICBsZXQgX3VybHMgPSBbXTtcbiAgICBpZiAoIWxvd0JhbmR3aWR0aCkge1xuICAgICAgICBfdXJscyA9IHVybHMgfHwgW107XG5cbiAgICAgICAgaWYgKHVybCkge1xuICAgICAgICAgICAgLy8gY29weSB1cmxzIGFuZCBwdXQgdXJsIGZpcnN0XG4gICAgICAgICAgICBfdXJscyA9IFt1cmwsIC4uLl91cmxzXTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIGRlZHVwbGljYXRlIFVSTHNcbiAgICByZXR1cm4gQXJyYXkuZnJvbShuZXcgU2V0KF91cmxzKSk7XG59O1xuXG5jb25zdCB1c2VJbWFnZVVybCA9ICh7IHVybCwgdXJscyB9KTogW3N0cmluZywgKCkgPT4gdm9pZF0gPT4ge1xuICAgIC8vIFNpbmNlIHRoaXMgaXMgYSBob3QgY29kZSBwYXRoIGFuZCB0aGUgc2V0dGluZ3Mgc3RvcmUgY2FuIGJlIHNsb3csIHdlXG4gICAgLy8gdXNlIHRoZSBjYWNoZWQgbG93QmFuZHdpZHRoIHZhbHVlIGZyb20gdGhlIHJvb20gY29udGV4dCBpZiBpdCBleGlzdHNcbiAgICBjb25zdCByb29tQ29udGV4dCA9IHVzZUNvbnRleHQoUm9vbUNvbnRleHQpO1xuICAgIGNvbnN0IGxvd0JhbmR3aWR0aCA9IHJvb21Db250ZXh0ID9cbiAgICAgICAgcm9vbUNvbnRleHQubG93QmFuZHdpZHRoIDogU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcImxvd0JhbmR3aWR0aFwiKTtcblxuICAgIGNvbnN0IFtpbWFnZVVybHMsIHNldFVybHNdID0gdXNlU3RhdGU8c3RyaW5nW10+KGNhbGN1bGF0ZVVybHModXJsLCB1cmxzLCBsb3dCYW5kd2lkdGgpKTtcbiAgICBjb25zdCBbdXJsc0luZGV4LCBzZXRJbmRleF0gPSB1c2VTdGF0ZTxudW1iZXI+KDApO1xuXG4gICAgY29uc3Qgb25FcnJvciA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICAgICAgc2V0SW5kZXgoaSA9PiBpICsgMSk7IC8vIHRyeSB0aGUgbmV4dCBvbmVcbiAgICB9LCBbXSk7XG5cbiAgICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgICAgICBzZXRVcmxzKGNhbGN1bGF0ZVVybHModXJsLCB1cmxzLCBsb3dCYW5kd2lkdGgpKTtcbiAgICAgICAgc2V0SW5kZXgoMCk7XG4gICAgfSwgW3VybCwgSlNPTi5zdHJpbmdpZnkodXJscyldKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZWFjdC1ob29rcy9leGhhdXN0aXZlLWRlcHNcblxuICAgIGNvbnN0IGNsaSA9IHVzZUNvbnRleHQoTWF0cml4Q2xpZW50Q29udGV4dCk7XG4gICAgY29uc3Qgb25DbGllbnRTeW5jID0gdXNlQ2FsbGJhY2soKHN5bmNTdGF0ZSwgcHJldlN0YXRlKSA9PiB7XG4gICAgICAgIC8vIENvbnNpZGVyIHRoZSBjbGllbnQgcmVjb25uZWN0ZWQgaWYgdGhlcmUgaXMgbm8gZXJyb3Igd2l0aCBzeW5jaW5nLlxuICAgICAgICAvLyBUaGlzIG1lYW5zIHRoZSBzdGF0ZSBjb3VsZCBiZSBSRUNPTk5FQ1RJTkcsIFNZTkNJTkcsIFBSRVBBUkVEIG9yIENBVENIVVAuXG4gICAgICAgIGNvbnN0IHJlY29ubmVjdGVkID0gc3luY1N0YXRlICE9PSBcIkVSUk9SXCIgJiYgcHJldlN0YXRlICE9PSBzeW5jU3RhdGU7XG4gICAgICAgIGlmIChyZWNvbm5lY3RlZCkge1xuICAgICAgICAgICAgc2V0SW5kZXgoMCk7XG4gICAgICAgIH1cbiAgICB9LCBbXSk7XG4gICAgdXNlRXZlbnRFbWl0dGVyKGNsaSwgXCJzeW5jXCIsIG9uQ2xpZW50U3luYyk7XG5cbiAgICBjb25zdCBpbWFnZVVybCA9IGltYWdlVXJsc1t1cmxzSW5kZXhdO1xuICAgIHJldHVybiBbaW1hZ2VVcmwsIG9uRXJyb3JdO1xufTtcblxuY29uc3QgQmFzZUF2YXRhciA9IChwcm9wczogSVByb3BzKSA9PiB7XG4gICAgY29uc3Qge1xuICAgICAgICBuYW1lLFxuICAgICAgICBpZE5hbWUsXG4gICAgICAgIHRpdGxlLFxuICAgICAgICB1cmwsXG4gICAgICAgIHVybHMsXG4gICAgICAgIHdpZHRoID0gNDAsXG4gICAgICAgIGhlaWdodCA9IDQwLFxuICAgICAgICByZXNpemVNZXRob2QgPSBcImNyb3BcIiwgLy8gZXNsaW50LWRpc2FibGUtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW51c2VkLXZhcnNcbiAgICAgICAgZGVmYXVsdFRvSW5pdGlhbExldHRlciA9IHRydWUsXG4gICAgICAgIG9uQ2xpY2ssXG4gICAgICAgIGlucHV0UmVmLFxuICAgICAgICBjbGFzc05hbWUsXG4gICAgICAgIC4uLm90aGVyUHJvcHNcbiAgICB9ID0gcHJvcHM7XG5cbiAgICBjb25zdCBbaW1hZ2VVcmwsIG9uRXJyb3JdID0gdXNlSW1hZ2VVcmwoeyB1cmwsIHVybHMgfSk7XG5cbiAgICBpZiAoIWltYWdlVXJsICYmIGRlZmF1bHRUb0luaXRpYWxMZXR0ZXIpIHtcbiAgICAgICAgY29uc3QgaW5pdGlhbExldHRlciA9IEF2YXRhckxvZ2ljLmdldEluaXRpYWxMZXR0ZXIobmFtZSk7XG4gICAgICAgIGNvbnN0IHRleHROb2RlID0gKFxuICAgICAgICAgICAgPHNwYW5cbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9CYXNlQXZhdGFyX2luaXRpYWxcIlxuICAgICAgICAgICAgICAgIGFyaWEtaGlkZGVuPVwidHJ1ZVwiXG4gICAgICAgICAgICAgICAgc3R5bGU9e3tcbiAgICAgICAgICAgICAgICAgICAgZm9udFNpemU6IHRvUHgod2lkdGggKiAwLjY1KSxcbiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IHRvUHgod2lkdGgpLFxuICAgICAgICAgICAgICAgICAgICBsaW5lSGVpZ2h0OiB0b1B4KGhlaWdodCksXG4gICAgICAgICAgICAgICAgfX1cbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICB7IGluaXRpYWxMZXR0ZXIgfVxuICAgICAgICAgICAgPC9zcGFuPlxuICAgICAgICApO1xuICAgICAgICBjb25zdCBpbWdOb2RlID0gKFxuICAgICAgICAgICAgPGltZ1xuICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X0Jhc2VBdmF0YXJfaW1hZ2VcIlxuICAgICAgICAgICAgICAgIHNyYz17QXZhdGFyTG9naWMuZGVmYXVsdEF2YXRhclVybEZvclN0cmluZyhpZE5hbWUgfHwgbmFtZSl9XG4gICAgICAgICAgICAgICAgYWx0PVwiXCJcbiAgICAgICAgICAgICAgICB0aXRsZT17dGl0bGV9XG4gICAgICAgICAgICAgICAgb25FcnJvcj17b25FcnJvcn1cbiAgICAgICAgICAgICAgICBzdHlsZT17e1xuICAgICAgICAgICAgICAgICAgICB3aWR0aDogdG9QeCh3aWR0aCksXG4gICAgICAgICAgICAgICAgICAgIGhlaWdodDogdG9QeChoZWlnaHQpLFxuICAgICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAgICAgYXJpYS1oaWRkZW49XCJ0cnVlXCIgLz5cbiAgICAgICAgKTtcblxuICAgICAgICBpZiAob25DbGljaykge1xuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvblxuICAgICAgICAgICAgICAgICAgICBhcmlhLWxhYmVsPXtfdChcIkF2YXRhclwiKX1cbiAgICAgICAgICAgICAgICAgICAgYXJpYS1saXZlPVwib2ZmXCJcbiAgICAgICAgICAgICAgICAgICAgey4uLm90aGVyUHJvcHN9XG4gICAgICAgICAgICAgICAgICAgIGVsZW1lbnQ9XCJzcGFuXCJcbiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPXtjbGFzc05hbWVzKFwibXhfQmFzZUF2YXRhclwiLCBjbGFzc05hbWUpfVxuICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXtvbkNsaWNrfVxuICAgICAgICAgICAgICAgICAgICBpbnB1dFJlZj17aW5wdXRSZWZ9XG4gICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICB7IHRleHROb2RlIH1cbiAgICAgICAgICAgICAgICAgICAgeyBpbWdOb2RlIH1cbiAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICA8c3BhblxuICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9e2NsYXNzTmFtZXMoXCJteF9CYXNlQXZhdGFyXCIsIGNsYXNzTmFtZSl9XG4gICAgICAgICAgICAgICAgICAgIHJlZj17aW5wdXRSZWZ9XG4gICAgICAgICAgICAgICAgICAgIHsuLi5vdGhlclByb3BzfVxuICAgICAgICAgICAgICAgICAgICByb2xlPVwicHJlc2VudGF0aW9uXCJcbiAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICAgIHsgdGV4dE5vZGUgfVxuICAgICAgICAgICAgICAgICAgICB7IGltZ05vZGUgfVxuICAgICAgICAgICAgICAgIDwvc3Bhbj5cbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAob25DbGljaykge1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b25cbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9e2NsYXNzTmFtZXMoXCJteF9CYXNlQXZhdGFyIG14X0Jhc2VBdmF0YXJfaW1hZ2VcIiwgY2xhc3NOYW1lKX1cbiAgICAgICAgICAgICAgICBlbGVtZW50PSdpbWcnXG4gICAgICAgICAgICAgICAgc3JjPXtpbWFnZVVybH1cbiAgICAgICAgICAgICAgICBvbkNsaWNrPXtvbkNsaWNrfVxuICAgICAgICAgICAgICAgIG9uRXJyb3I9e29uRXJyb3J9XG4gICAgICAgICAgICAgICAgc3R5bGU9e3tcbiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IHRvUHgod2lkdGgpLFxuICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IHRvUHgoaGVpZ2h0KSxcbiAgICAgICAgICAgICAgICB9fVxuICAgICAgICAgICAgICAgIHRpdGxlPXt0aXRsZX1cbiAgICAgICAgICAgICAgICBhbHQ9e190KFwiQXZhdGFyXCIpfVxuICAgICAgICAgICAgICAgIGlucHV0UmVmPXtpbnB1dFJlZn1cbiAgICAgICAgICAgICAgICB7Li4ub3RoZXJQcm9wc30gLz5cbiAgICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPGltZ1xuICAgICAgICAgICAgICAgIGNsYXNzTmFtZT17Y2xhc3NOYW1lcyhcIm14X0Jhc2VBdmF0YXIgbXhfQmFzZUF2YXRhcl9pbWFnZVwiLCBjbGFzc05hbWUpfVxuICAgICAgICAgICAgICAgIHNyYz17aW1hZ2VVcmx9XG4gICAgICAgICAgICAgICAgb25FcnJvcj17b25FcnJvcn1cbiAgICAgICAgICAgICAgICBzdHlsZT17e1xuICAgICAgICAgICAgICAgICAgICB3aWR0aDogdG9QeCh3aWR0aCksXG4gICAgICAgICAgICAgICAgICAgIGhlaWdodDogdG9QeChoZWlnaHQpLFxuICAgICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAgICAgdGl0bGU9e3RpdGxlfVxuICAgICAgICAgICAgICAgIGFsdD1cIlwiXG4gICAgICAgICAgICAgICAgcmVmPXtpbnB1dFJlZn1cbiAgICAgICAgICAgICAgICB7Li4ub3RoZXJQcm9wc30gLz5cbiAgICAgICAgKTtcbiAgICB9XG59O1xuXG5leHBvcnQgZGVmYXVsdCBCYXNlQXZhdGFyO1xuZXhwb3J0IHR5cGUgQmFzZUF2YXRhclR5cGUgPSBSZWFjdC5GQzxJUHJvcHM+O1xuIl19