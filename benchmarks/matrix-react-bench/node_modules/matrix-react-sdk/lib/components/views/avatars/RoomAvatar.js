"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _classnames = _interopRequireDefault(require("classnames"));

var _BaseAvatar = _interopRequireDefault(require("./BaseAvatar"));

var _ImageView = _interopRequireDefault(require("../elements/ImageView"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _Modal = _interopRequireDefault(require("../../../Modal"));

var Avatar = _interopRequireWildcard(require("../../../Avatar"));

var _DMRoomMap = _interopRequireDefault(require("../../../utils/DMRoomMap"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _Media = require("../../../customisations/Media");

const _excluded = ["room", "oobData", "viewAvatarOnClick", "onClick", "className"];

var _dec, _class, _class2, _temp;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

let RoomAvatar = (_dec = (0, _replaceableComponent.replaceableComponent)("views.avatars.RoomAvatar"), _dec(_class = (_temp = _class2 = class RoomAvatar extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onRoomStateEvents", ev => {
      if (!this.props.room || ev.getRoomId() !== this.props.room.roomId || ev.getType() !== 'm.room.avatar') return;
      this.setState({
        urls: RoomAvatar.getImageUrls(this.props)
      });
    });
    (0, _defineProperty2.default)(this, "onRoomAvatarClick", () => {
      const avatarUrl = Avatar.avatarUrlForRoom(this.props.room, null, null, null);
      const params = {
        src: avatarUrl,
        name: this.props.room.name
      };

      _Modal.default.createDialog(_ImageView.default, params, "mx_Dialog_lightbox", null, true);
    });
    this.state = {
      urls: RoomAvatar.getImageUrls(this.props)
    };
  }

  componentDidMount() {
    _MatrixClientPeg.MatrixClientPeg.get().on("RoomState.events", this.onRoomStateEvents);
  }

  componentWillUnmount() {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    if (cli) {
      cli.removeListener("RoomState.events", this.onRoomStateEvents);
    }
  }

  static getDerivedStateFromProps(nextProps) {
    return {
      urls: RoomAvatar.getImageUrls(nextProps)
    };
  }

  static getImageUrls(props) {
    let oobAvatar = null;

    if (props.oobData.avatarUrl) {
      oobAvatar = (0, _Media.mediaFromMxc)(props.oobData.avatarUrl).getThumbnailOfSourceHttp(props.width, props.height, props.resizeMethod);
    }

    return [oobAvatar, // highest priority
    RoomAvatar.getRoomAvatarUrl(props)].filter(function (url) {
      return url !== null && url !== "";
    });
  }

  static getRoomAvatarUrl(props) {
    if (!props.room) return null;
    return Avatar.avatarUrlForRoom(props.room, props.width, props.height, props.resizeMethod);
  }

  render() {
    const _this$props = this.props,
          {
      room,
      oobData,
      viewAvatarOnClick,
      onClick,
      className
    } = _this$props,
          otherProps = (0, _objectWithoutProperties2.default)(_this$props, _excluded);
    const roomName = room ? room.name : oobData.name; // If the room is a DM, we use the other user's ID for the color hash
    // in order to match the room avatar with their avatar

    const idName = room ? _DMRoomMap.default.shared().getUserIdForRoomId(room.roomId) ?? room.roomId : oobData.roomId;
    return /*#__PURE__*/_react.default.createElement(_BaseAvatar.default, (0, _extends2.default)({}, otherProps, {
      className: (0, _classnames.default)(className, {
        mx_RoomAvatar_isSpaceRoom: room === null || room === void 0 ? void 0 : room.isSpaceRoom()
      }),
      name: roomName,
      idName: idName,
      urls: this.state.urls,
      onClick: viewAvatarOnClick && this.state.urls[0] ? this.onRoomAvatarClick : onClick
    }));
  }

}, (0, _defineProperty2.default)(_class2, "defaultProps", {
  width: 36,
  height: 36,
  resizeMethod: 'crop',
  oobData: {}
}), _temp)) || _class);
exports.default = RoomAvatar;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2F2YXRhcnMvUm9vbUF2YXRhci50c3giXSwibmFtZXMiOlsiUm9vbUF2YXRhciIsIlJlYWN0IiwiQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsImV2Iiwicm9vbSIsImdldFJvb21JZCIsInJvb21JZCIsImdldFR5cGUiLCJzZXRTdGF0ZSIsInVybHMiLCJnZXRJbWFnZVVybHMiLCJhdmF0YXJVcmwiLCJBdmF0YXIiLCJhdmF0YXJVcmxGb3JSb29tIiwicGFyYW1zIiwic3JjIiwibmFtZSIsIk1vZGFsIiwiY3JlYXRlRGlhbG9nIiwiSW1hZ2VWaWV3Iiwic3RhdGUiLCJjb21wb25lbnREaWRNb3VudCIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsIm9uIiwib25Sb29tU3RhdGVFdmVudHMiLCJjb21wb25lbnRXaWxsVW5tb3VudCIsImNsaSIsInJlbW92ZUxpc3RlbmVyIiwiZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzIiwibmV4dFByb3BzIiwib29iQXZhdGFyIiwib29iRGF0YSIsImdldFRodW1ibmFpbE9mU291cmNlSHR0cCIsIndpZHRoIiwiaGVpZ2h0IiwicmVzaXplTWV0aG9kIiwiZ2V0Um9vbUF2YXRhclVybCIsImZpbHRlciIsInVybCIsInJlbmRlciIsInZpZXdBdmF0YXJPbkNsaWNrIiwib25DbGljayIsImNsYXNzTmFtZSIsIm90aGVyUHJvcHMiLCJyb29tTmFtZSIsImlkTmFtZSIsIkRNUm9vbU1hcCIsInNoYXJlZCIsImdldFVzZXJJZEZvclJvb21JZCIsIm14X1Jvb21BdmF0YXJfaXNTcGFjZVJvb20iLCJpc1NwYWNlUm9vbSIsIm9uUm9vbUF2YXRhckNsaWNrIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7QUFnQkE7O0FBSUE7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7SUF3QnFCQSxVLFdBRHBCLGdEQUFxQiwwQkFBckIsQyxtQ0FBRCxNQUNxQkEsVUFEckIsU0FDd0NDLGVBQU1DLFNBRDlDLENBQ3dFO0FBUXBFQyxFQUFBQSxXQUFXLENBQUNDLEtBQUQsRUFBZ0I7QUFDdkIsVUFBTUEsS0FBTjtBQUR1Qiw2REF5QkVDLEVBQUQsSUFBcUI7QUFDN0MsVUFBSSxDQUFDLEtBQUtELEtBQUwsQ0FBV0UsSUFBWixJQUNBRCxFQUFFLENBQUNFLFNBQUgsT0FBbUIsS0FBS0gsS0FBTCxDQUFXRSxJQUFYLENBQWdCRSxNQURuQyxJQUVBSCxFQUFFLENBQUNJLE9BQUgsT0FBaUIsZUFGckIsRUFHRTtBQUVGLFdBQUtDLFFBQUwsQ0FBYztBQUNWQyxRQUFBQSxJQUFJLEVBQUVYLFVBQVUsQ0FBQ1ksWUFBWCxDQUF3QixLQUFLUixLQUE3QjtBQURJLE9BQWQ7QUFHSCxLQWxDMEI7QUFBQSw2REEyREMsTUFBTTtBQUM5QixZQUFNUyxTQUFTLEdBQUdDLE1BQU0sQ0FBQ0MsZ0JBQVAsQ0FDZCxLQUFLWCxLQUFMLENBQVdFLElBREcsRUFFZCxJQUZjLEVBR2QsSUFIYyxFQUlkLElBSmMsQ0FBbEI7QUFNQSxZQUFNVSxNQUFNLEdBQUc7QUFDWEMsUUFBQUEsR0FBRyxFQUFFSixTQURNO0FBRVhLLFFBQUFBLElBQUksRUFBRSxLQUFLZCxLQUFMLENBQVdFLElBQVgsQ0FBZ0JZO0FBRlgsT0FBZjs7QUFLQUMscUJBQU1DLFlBQU4sQ0FBbUJDLGtCQUFuQixFQUE4QkwsTUFBOUIsRUFBc0Msb0JBQXRDLEVBQTRELElBQTVELEVBQWtFLElBQWxFO0FBQ0gsS0F4RTBCO0FBR3ZCLFNBQUtNLEtBQUwsR0FBYTtBQUNUWCxNQUFBQSxJQUFJLEVBQUVYLFVBQVUsQ0FBQ1ksWUFBWCxDQUF3QixLQUFLUixLQUE3QjtBQURHLEtBQWI7QUFHSDs7QUFFTW1CLEVBQUFBLGlCQUFpQixHQUFHO0FBQ3ZCQyxxQ0FBZ0JDLEdBQWhCLEdBQXNCQyxFQUF0QixDQUF5QixrQkFBekIsRUFBNkMsS0FBS0MsaUJBQWxEO0FBQ0g7O0FBRU1DLEVBQUFBLG9CQUFvQixHQUFHO0FBQzFCLFVBQU1DLEdBQUcsR0FBR0wsaUNBQWdCQyxHQUFoQixFQUFaOztBQUNBLFFBQUlJLEdBQUosRUFBUztBQUNMQSxNQUFBQSxHQUFHLENBQUNDLGNBQUosQ0FBbUIsa0JBQW5CLEVBQXVDLEtBQUtILGlCQUE1QztBQUNIO0FBQ0o7O0FBRXFDLFNBQXhCSSx3QkFBd0IsQ0FBQ0MsU0FBRCxFQUE0QjtBQUM5RCxXQUFPO0FBQ0hyQixNQUFBQSxJQUFJLEVBQUVYLFVBQVUsQ0FBQ1ksWUFBWCxDQUF3Qm9CLFNBQXhCO0FBREgsS0FBUDtBQUdIOztBQWEwQixTQUFacEIsWUFBWSxDQUFDUixLQUFELEVBQTBCO0FBQ2pELFFBQUk2QixTQUFTLEdBQUcsSUFBaEI7O0FBQ0EsUUFBSTdCLEtBQUssQ0FBQzhCLE9BQU4sQ0FBY3JCLFNBQWxCLEVBQTZCO0FBQ3pCb0IsTUFBQUEsU0FBUyxHQUFHLHlCQUFhN0IsS0FBSyxDQUFDOEIsT0FBTixDQUFjckIsU0FBM0IsRUFBc0NzQix3QkFBdEMsQ0FDUi9CLEtBQUssQ0FBQ2dDLEtBREUsRUFFUmhDLEtBQUssQ0FBQ2lDLE1BRkUsRUFHUmpDLEtBQUssQ0FBQ2tDLFlBSEUsQ0FBWjtBQUtIOztBQUNELFdBQU8sQ0FDSEwsU0FERyxFQUNRO0FBQ1hqQyxJQUFBQSxVQUFVLENBQUN1QyxnQkFBWCxDQUE0Qm5DLEtBQTVCLENBRkcsRUFHTG9DLE1BSEssQ0FHRSxVQUFTQyxHQUFULEVBQWM7QUFDbkIsYUFBUUEsR0FBRyxLQUFLLElBQVIsSUFBZ0JBLEdBQUcsS0FBSyxFQUFoQztBQUNILEtBTE0sQ0FBUDtBQU1IOztBQUU4QixTQUFoQkYsZ0JBQWdCLENBQUNuQyxLQUFELEVBQXdCO0FBQ25ELFFBQUksQ0FBQ0EsS0FBSyxDQUFDRSxJQUFYLEVBQWlCLE9BQU8sSUFBUDtBQUVqQixXQUFPUSxNQUFNLENBQUNDLGdCQUFQLENBQXdCWCxLQUFLLENBQUNFLElBQTlCLEVBQW9DRixLQUFLLENBQUNnQyxLQUExQyxFQUFpRGhDLEtBQUssQ0FBQ2lDLE1BQXZELEVBQStEakMsS0FBSyxDQUFDa0MsWUFBckUsQ0FBUDtBQUNIOztBQWlCTUksRUFBQUEsTUFBTSxHQUFHO0FBQ1osd0JBQWdGLEtBQUt0QyxLQUFyRjtBQUFBLFVBQU07QUFBRUUsTUFBQUEsSUFBRjtBQUFRNEIsTUFBQUEsT0FBUjtBQUFpQlMsTUFBQUEsaUJBQWpCO0FBQW9DQyxNQUFBQSxPQUFwQztBQUE2Q0MsTUFBQUE7QUFBN0MsS0FBTjtBQUFBLFVBQWlFQyxVQUFqRTtBQUVBLFVBQU1DLFFBQVEsR0FBR3pDLElBQUksR0FBR0EsSUFBSSxDQUFDWSxJQUFSLEdBQWVnQixPQUFPLENBQUNoQixJQUE1QyxDQUhZLENBSVo7QUFDQTs7QUFDQSxVQUFNOEIsTUFBTSxHQUFHMUMsSUFBSSxHQUFJMkMsbUJBQVVDLE1BQVYsR0FBbUJDLGtCQUFuQixDQUFzQzdDLElBQUksQ0FBQ0UsTUFBM0MsS0FBc0RGLElBQUksQ0FBQ0UsTUFBL0QsR0FBeUUwQixPQUFPLENBQUMxQixNQUFwRztBQUVBLHdCQUNJLDZCQUFDLG1CQUFELDZCQUNRc0MsVUFEUjtBQUVJLE1BQUEsU0FBUyxFQUFFLHlCQUFXRCxTQUFYLEVBQXNCO0FBQzdCTyxRQUFBQSx5QkFBeUIsRUFBRTlDLElBQUYsYUFBRUEsSUFBRix1QkFBRUEsSUFBSSxDQUFFK0MsV0FBTjtBQURFLE9BQXRCLENBRmY7QUFLSSxNQUFBLElBQUksRUFBRU4sUUFMVjtBQU1JLE1BQUEsTUFBTSxFQUFFQyxNQU5aO0FBT0ksTUFBQSxJQUFJLEVBQUUsS0FBSzFCLEtBQUwsQ0FBV1gsSUFQckI7QUFRSSxNQUFBLE9BQU8sRUFBRWdDLGlCQUFpQixJQUFJLEtBQUtyQixLQUFMLENBQVdYLElBQVgsQ0FBZ0IsQ0FBaEIsQ0FBckIsR0FBMEMsS0FBSzJDLGlCQUEvQyxHQUFtRVY7QUFSaEYsT0FESjtBQVlIOztBQXRHbUUsQyx5REFDdkM7QUFDekJSLEVBQUFBLEtBQUssRUFBRSxFQURrQjtBQUV6QkMsRUFBQUEsTUFBTSxFQUFFLEVBRmlCO0FBR3pCQyxFQUFBQSxZQUFZLEVBQUUsTUFIVztBQUl6QkosRUFBQUEsT0FBTyxFQUFFO0FBSmdCLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTUsIDIwMTYgT3Blbk1hcmtldCBMdGRcblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QsIHsgQ29tcG9uZW50UHJvcHMgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBSb29tIH0gZnJvbSAnbWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3Jvb20nO1xuaW1wb3J0IHsgUmVzaXplTWV0aG9kIH0gZnJvbSAnbWF0cml4LWpzLXNkay9zcmMvQHR5cGVzL3BhcnRpYWxzJztcbmltcG9ydCB7IE1hdHJpeEV2ZW50IH0gZnJvbSAnbWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL2V2ZW50JztcbmltcG9ydCBjbGFzc05hbWVzIGZyb20gXCJjbGFzc25hbWVzXCI7XG5cbmltcG9ydCBCYXNlQXZhdGFyIGZyb20gJy4vQmFzZUF2YXRhcic7XG5pbXBvcnQgSW1hZ2VWaWV3IGZyb20gJy4uL2VsZW1lbnRzL0ltYWdlVmlldyc7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tICcuLi8uLi8uLi9NYXRyaXhDbGllbnRQZWcnO1xuaW1wb3J0IE1vZGFsIGZyb20gJy4uLy4uLy4uL01vZGFsJztcbmltcG9ydCAqIGFzIEF2YXRhciBmcm9tICcuLi8uLi8uLi9BdmF0YXInO1xuaW1wb3J0IERNUm9vbU1hcCBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvRE1Sb29tTWFwXCI7XG5pbXBvcnQgeyByZXBsYWNlYWJsZUNvbXBvbmVudCB9IGZyb20gXCIuLi8uLi8uLi91dGlscy9yZXBsYWNlYWJsZUNvbXBvbmVudFwiO1xuaW1wb3J0IHsgbWVkaWFGcm9tTXhjIH0gZnJvbSBcIi4uLy4uLy4uL2N1c3RvbWlzYXRpb25zL01lZGlhXCI7XG5pbXBvcnQgeyBJT09CRGF0YSB9IGZyb20gJy4uLy4uLy4uL3N0b3Jlcy9UaHJlZXBpZEludml0ZVN0b3JlJztcblxuaW50ZXJmYWNlIElQcm9wcyBleHRlbmRzIE9taXQ8Q29tcG9uZW50UHJvcHM8dHlwZW9mIEJhc2VBdmF0YXI+LCBcIm5hbWVcIiB8IFwiaWROYW1lXCIgfCBcInVybFwiIHwgXCJvbkNsaWNrXCI+IHtcbiAgICAvLyBSb29tIG1heSBiZSBsZWZ0IHVuc2V0IGhlcmUsIGJ1dCBpZiBpdCBpcyxcbiAgICAvLyBvb2JEYXRhLmF2YXRhclVybCBzaG91bGQgYmUgc2V0IChlbHNlIHRoZXJlXG4gICAgLy8gd291bGQgYmUgbm93aGVyZSB0byBnZXQgdGhlIGF2YXRhciBmcm9tKVxuICAgIHJvb20/OiBSb29tO1xuICAgIG9vYkRhdGE/OiBJT09CRGF0YSAmIHtcbiAgICAgICAgcm9vbUlkPzogc3RyaW5nO1xuICAgIH07XG4gICAgd2lkdGg/OiBudW1iZXI7XG4gICAgaGVpZ2h0PzogbnVtYmVyO1xuICAgIHJlc2l6ZU1ldGhvZD86IFJlc2l6ZU1ldGhvZDtcbiAgICB2aWV3QXZhdGFyT25DbGljaz86IGJvb2xlYW47XG4gICAgY2xhc3NOYW1lPzogc3RyaW5nO1xuICAgIG9uQ2xpY2s/KCk6IHZvaWQ7XG59XG5cbmludGVyZmFjZSBJU3RhdGUge1xuICAgIHVybHM6IHN0cmluZ1tdO1xufVxuXG5AcmVwbGFjZWFibGVDb21wb25lbnQoXCJ2aWV3cy5hdmF0YXJzLlJvb21BdmF0YXJcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJvb21BdmF0YXIgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8SVByb3BzLCBJU3RhdGU+IHtcbiAgICBwdWJsaWMgc3RhdGljIGRlZmF1bHRQcm9wcyA9IHtcbiAgICAgICAgd2lkdGg6IDM2LFxuICAgICAgICBoZWlnaHQ6IDM2LFxuICAgICAgICByZXNpemVNZXRob2Q6ICdjcm9wJyxcbiAgICAgICAgb29iRGF0YToge30sXG4gICAgfTtcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBJUHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuXG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICB1cmxzOiBSb29tQXZhdGFyLmdldEltYWdlVXJscyh0aGlzLnByb3BzKSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgICAgIE1hdHJpeENsaWVudFBlZy5nZXQoKS5vbihcIlJvb21TdGF0ZS5ldmVudHNcIiwgdGhpcy5vblJvb21TdGF0ZUV2ZW50cyk7XG4gICAgfVxuXG4gICAgcHVibGljIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgICBjb25zdCBjbGkgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIGlmIChjbGkpIHtcbiAgICAgICAgICAgIGNsaS5yZW1vdmVMaXN0ZW5lcihcIlJvb21TdGF0ZS5ldmVudHNcIiwgdGhpcy5vblJvb21TdGF0ZUV2ZW50cyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyhuZXh0UHJvcHM6IElQcm9wcyk6IElTdGF0ZSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB1cmxzOiBSb29tQXZhdGFyLmdldEltYWdlVXJscyhuZXh0UHJvcHMpLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgb25Sb29tU3RhdGVFdmVudHMgPSAoZXY6IE1hdHJpeEV2ZW50KSA9PiB7XG4gICAgICAgIGlmICghdGhpcy5wcm9wcy5yb29tIHx8XG4gICAgICAgICAgICBldi5nZXRSb29tSWQoKSAhPT0gdGhpcy5wcm9wcy5yb29tLnJvb21JZCB8fFxuICAgICAgICAgICAgZXYuZ2V0VHlwZSgpICE9PSAnbS5yb29tLmF2YXRhcidcbiAgICAgICAgKSByZXR1cm47XG5cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICB1cmxzOiBSb29tQXZhdGFyLmdldEltYWdlVXJscyh0aGlzLnByb3BzKSxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgc3RhdGljIGdldEltYWdlVXJscyhwcm9wczogSVByb3BzKTogc3RyaW5nW10ge1xuICAgICAgICBsZXQgb29iQXZhdGFyID0gbnVsbDtcbiAgICAgICAgaWYgKHByb3BzLm9vYkRhdGEuYXZhdGFyVXJsKSB7XG4gICAgICAgICAgICBvb2JBdmF0YXIgPSBtZWRpYUZyb21NeGMocHJvcHMub29iRGF0YS5hdmF0YXJVcmwpLmdldFRodW1ibmFpbE9mU291cmNlSHR0cChcbiAgICAgICAgICAgICAgICBwcm9wcy53aWR0aCxcbiAgICAgICAgICAgICAgICBwcm9wcy5oZWlnaHQsXG4gICAgICAgICAgICAgICAgcHJvcHMucmVzaXplTWV0aG9kLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gW1xuICAgICAgICAgICAgb29iQXZhdGFyLCAvLyBoaWdoZXN0IHByaW9yaXR5XG4gICAgICAgICAgICBSb29tQXZhdGFyLmdldFJvb21BdmF0YXJVcmwocHJvcHMpLFxuICAgICAgICBdLmZpbHRlcihmdW5jdGlvbih1cmwpIHtcbiAgICAgICAgICAgIHJldHVybiAodXJsICE9PSBudWxsICYmIHVybCAhPT0gXCJcIik7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIGdldFJvb21BdmF0YXJVcmwocHJvcHM6IElQcm9wcyk6IHN0cmluZyB7XG4gICAgICAgIGlmICghcHJvcHMucm9vbSkgcmV0dXJuIG51bGw7XG5cbiAgICAgICAgcmV0dXJuIEF2YXRhci5hdmF0YXJVcmxGb3JSb29tKHByb3BzLnJvb20sIHByb3BzLndpZHRoLCBwcm9wcy5oZWlnaHQsIHByb3BzLnJlc2l6ZU1ldGhvZCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvblJvb21BdmF0YXJDbGljayA9ICgpID0+IHtcbiAgICAgICAgY29uc3QgYXZhdGFyVXJsID0gQXZhdGFyLmF2YXRhclVybEZvclJvb20oXG4gICAgICAgICAgICB0aGlzLnByb3BzLnJvb20sXG4gICAgICAgICAgICBudWxsLFxuICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgIG51bGwsXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IHtcbiAgICAgICAgICAgIHNyYzogYXZhdGFyVXJsLFxuICAgICAgICAgICAgbmFtZTogdGhpcy5wcm9wcy5yb29tLm5hbWUsXG4gICAgICAgIH07XG5cbiAgICAgICAgTW9kYWwuY3JlYXRlRGlhbG9nKEltYWdlVmlldywgcGFyYW1zLCBcIm14X0RpYWxvZ19saWdodGJveFwiLCBudWxsLCB0cnVlKTtcbiAgICB9O1xuXG4gICAgcHVibGljIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3QgeyByb29tLCBvb2JEYXRhLCB2aWV3QXZhdGFyT25DbGljaywgb25DbGljaywgY2xhc3NOYW1lLCAuLi5vdGhlclByb3BzIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgICAgIGNvbnN0IHJvb21OYW1lID0gcm9vbSA/IHJvb20ubmFtZSA6IG9vYkRhdGEubmFtZTtcbiAgICAgICAgLy8gSWYgdGhlIHJvb20gaXMgYSBETSwgd2UgdXNlIHRoZSBvdGhlciB1c2VyJ3MgSUQgZm9yIHRoZSBjb2xvciBoYXNoXG4gICAgICAgIC8vIGluIG9yZGVyIHRvIG1hdGNoIHRoZSByb29tIGF2YXRhciB3aXRoIHRoZWlyIGF2YXRhclxuICAgICAgICBjb25zdCBpZE5hbWUgPSByb29tID8gKERNUm9vbU1hcC5zaGFyZWQoKS5nZXRVc2VySWRGb3JSb29tSWQocm9vbS5yb29tSWQpID8/IHJvb20ucm9vbUlkKSA6IG9vYkRhdGEucm9vbUlkO1xuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8QmFzZUF2YXRhclxuICAgICAgICAgICAgICAgIHsuLi5vdGhlclByb3BzfVxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZT17Y2xhc3NOYW1lcyhjbGFzc05hbWUsIHtcbiAgICAgICAgICAgICAgICAgICAgbXhfUm9vbUF2YXRhcl9pc1NwYWNlUm9vbTogcm9vbT8uaXNTcGFjZVJvb20oKSxcbiAgICAgICAgICAgICAgICB9KX1cbiAgICAgICAgICAgICAgICBuYW1lPXtyb29tTmFtZX1cbiAgICAgICAgICAgICAgICBpZE5hbWU9e2lkTmFtZX1cbiAgICAgICAgICAgICAgICB1cmxzPXt0aGlzLnN0YXRlLnVybHN9XG4gICAgICAgICAgICAgICAgb25DbGljaz17dmlld0F2YXRhck9uQ2xpY2sgJiYgdGhpcy5zdGF0ZS51cmxzWzBdID8gdGhpcy5vblJvb21BdmF0YXJDbGljayA6IG9uQ2xpY2t9XG4gICAgICAgICAgICAvPlxuICAgICAgICApO1xuICAgIH1cbn1cbiJdfQ==