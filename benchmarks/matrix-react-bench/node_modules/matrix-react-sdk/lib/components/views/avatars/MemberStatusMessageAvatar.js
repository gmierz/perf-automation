"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _languageHandler = require("../../../languageHandler");

var _MemberAvatar = _interopRequireDefault(require("../avatars/MemberAvatar"));

var _classnames = _interopRequireDefault(require("classnames"));

var _StatusMessageContextMenu = _interopRequireDefault(require("../context_menus/StatusMessageContextMenu"));

var _SettingsStore = _interopRequireDefault(require("../../../settings/SettingsStore"));

var _ContextMenu = _interopRequireWildcard(require("../../structures/ContextMenu"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _dec, _class, _class2, _temp;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

let MemberStatusMessageAvatar = (_dec = (0, _replaceableComponent.replaceableComponent)("views.avatars.MemberStatusMessageAvatar"), _dec(_class = (_temp = _class2 = class MemberStatusMessageAvatar extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "button", /*#__PURE__*/(0, _react.createRef)());
    (0, _defineProperty2.default)(this, "onStatusMessageCommitted", () => {
      // The `User` object has observed a status message change.
      this.setState({
        hasStatus: this.hasStatus
      });
    });
    (0, _defineProperty2.default)(this, "openMenu", () => {
      this.setState({
        menuDisplayed: true
      });
    });
    (0, _defineProperty2.default)(this, "closeMenu", () => {
      this.setState({
        menuDisplayed: false
      });
    });
    this.state = {
      hasStatus: this.hasStatus,
      menuDisplayed: false
    };
  }

  componentDidMount() {
    if (this.props.member.userId !== _MatrixClientPeg.MatrixClientPeg.get().getUserId()) {
      throw new Error("Cannot use MemberStatusMessageAvatar on anyone but the logged in user");
    }

    if (!_SettingsStore.default.getValue("feature_custom_status")) {
      return;
    }

    const {
      user
    } = this.props.member;

    if (!user) {
      return;
    }

    user.on("User._unstable_statusMessage", this.onStatusMessageCommitted);
  }

  componentWillUnmount() {
    const {
      user
    } = this.props.member;

    if (!user) {
      return;
    }

    user.removeListener("User._unstable_statusMessage", this.onStatusMessageCommitted);
  }

  get hasStatus() {
    const {
      user
    } = this.props.member;

    if (!user) {
      return false;
    }

    return !!user.unstable_statusMessage;
  }

  render() {
    const avatar = /*#__PURE__*/_react.default.createElement(_MemberAvatar.default, {
      member: this.props.member,
      width: this.props.width,
      height: this.props.height,
      resizeMethod: this.props.resizeMethod
    });

    if (!_SettingsStore.default.getValue("feature_custom_status")) {
      return avatar;
    }

    const classes = (0, _classnames.default)({
      "mx_MemberStatusMessageAvatar": true,
      "mx_MemberStatusMessageAvatar_hasStatus": this.state.hasStatus
    });
    let contextMenu;

    if (this.state.menuDisplayed) {
      const elementRect = this.button.current.getBoundingClientRect();
      const chevronWidth = 16; // See .mx_ContextualMenu_chevron_bottom

      const chevronMargin = 1; // Add some spacing away from target

      contextMenu = /*#__PURE__*/_react.default.createElement(_ContextMenu.default, {
        chevronOffset: (elementRect.width - chevronWidth) / 2,
        chevronFace: _ContextMenu.ChevronFace.Bottom,
        left: elementRect.left + window.pageXOffset,
        top: elementRect.top + window.pageYOffset - chevronMargin,
        menuWidth: 226,
        onFinished: this.closeMenu
      }, /*#__PURE__*/_react.default.createElement(_StatusMessageContextMenu.default, {
        user: this.props.member.user
      }));
    }

    return /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement(_ContextMenu.ContextMenuButton, {
      className: classes,
      inputRef: this.button,
      onClick: this.openMenu,
      isExpanded: this.state.menuDisplayed,
      label: (0, _languageHandler._t)("User Status")
    }, avatar), contextMenu);
  }

}, (0, _defineProperty2.default)(_class2, "defaultProps", {
  width: 40,
  height: 40,
  resizeMethod: 'crop'
}), _temp)) || _class);
exports.default = MemberStatusMessageAvatar;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2F2YXRhcnMvTWVtYmVyU3RhdHVzTWVzc2FnZUF2YXRhci50c3giXSwibmFtZXMiOlsiTWVtYmVyU3RhdHVzTWVzc2FnZUF2YXRhciIsIlJlYWN0IiwiQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsInNldFN0YXRlIiwiaGFzU3RhdHVzIiwibWVudURpc3BsYXllZCIsInN0YXRlIiwiY29tcG9uZW50RGlkTW91bnQiLCJtZW1iZXIiLCJ1c2VySWQiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJnZXRVc2VySWQiLCJFcnJvciIsIlNldHRpbmdzU3RvcmUiLCJnZXRWYWx1ZSIsInVzZXIiLCJvbiIsIm9uU3RhdHVzTWVzc2FnZUNvbW1pdHRlZCIsImNvbXBvbmVudFdpbGxVbm1vdW50IiwicmVtb3ZlTGlzdGVuZXIiLCJ1bnN0YWJsZV9zdGF0dXNNZXNzYWdlIiwicmVuZGVyIiwiYXZhdGFyIiwid2lkdGgiLCJoZWlnaHQiLCJyZXNpemVNZXRob2QiLCJjbGFzc2VzIiwiY29udGV4dE1lbnUiLCJlbGVtZW50UmVjdCIsImJ1dHRvbiIsImN1cnJlbnQiLCJnZXRCb3VuZGluZ0NsaWVudFJlY3QiLCJjaGV2cm9uV2lkdGgiLCJjaGV2cm9uTWFyZ2luIiwiQ2hldnJvbkZhY2UiLCJCb3R0b20iLCJsZWZ0Iiwid2luZG93IiwicGFnZVhPZmZzZXQiLCJ0b3AiLCJwYWdlWU9mZnNldCIsImNsb3NlTWVudSIsIm9wZW5NZW51Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWdCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7SUFpQnFCQSx5QixXQURwQixnREFBcUIseUNBQXJCLEMsbUNBQUQsTUFDcUJBLHlCQURyQixTQUN1REMsZUFBTUMsU0FEN0QsQ0FDdUY7QUFRbkZDLEVBQUFBLFdBQVcsQ0FBQ0MsS0FBRCxFQUFnQjtBQUN2QixV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R0FBb0JTLFlBQXJCLElBQXFDLENBRHhEO0FBRUksUUFBQSxXQUFXLEVBQUVFLHlCQUFZQyxNQUY3QjtBQUdJLFFBQUEsSUFBSSxFQUFFUCxXQUFXLENBQUNRLElBQVosR0FBbUJDLE1BQU0sQ0FBQ0MsV0FIcEM7QUFJSSxRQUFBLEdBQUcsRUFBRVYsV0FBVyxDQUFDVyxHQUFaLEdBQWtCRixNQUFNLENBQUNHLFdBQXpCLEdBQXVDUCxhQUpoRDtBQUtJLFFBQUEsU0FBUyxFQUFFLEdBTGY7QUFNSSxRQUFBLFVBQVUsRUFBRSxLQUFLUTtBQU5yQixzQkFRSSw2QkFBQyxpQ0FBRDtBQUEwQixRQUFBLElBQUksRUFBRSxLQUFLeEMsS0FBTCxDQUFXTSxNQUFYLENBQWtCUTtBQUFsRCxRQVJKLENBREo7QUFZSDs7QUFFRCx3QkFBTyw2QkFBQyxjQUFELENBQU8sUUFBUCxxQkFDSCw2QkFBQyw4QkFBRDtBQUNJLE1BQUEsU0FBUyxFQUFFVyxPQURmO0FBRUksTUFBQSxRQUFRLEVBQUUsS0FBS0csTUFGbkI7QUFHSSxNQUFBLE9BQU8sRUFBRSxLQUFLYSxRQUhsQjtBQUlJLE1BQUEsVUFBVSxFQUFFLEtBQUtyQyxLQUFMLENBQVdELGFBSjNCO0FBS0ksTUFBQSxLQUFLLEVBQUUseUJBQUcsYUFBSDtBQUxYLE9BT01rQixNQVBOLENBREcsRUFXREssV0FYQyxDQUFQO0FBYUg7O0FBcEhrRixDLHlEQUNyQztBQUMxQ0osRUFBQUEsS0FBSyxFQUFFLEVBRG1DO0FBRTFDQyxFQUFBQSxNQUFNLEVBQUUsRUFGa0M7QUFHMUNDLEVBQUFBLFlBQVksRUFBRTtBQUg0QixDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE4IE5ldyBWZWN0b3IgTHRkXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0LCB7IGNyZWF0ZVJlZiB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gJy4uLy4uLy4uL01hdHJpeENsaWVudFBlZyc7XG5pbXBvcnQgeyBfdCB9IGZyb20gXCIuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXJcIjtcbmltcG9ydCBNZW1iZXJBdmF0YXIgZnJvbSAnLi4vYXZhdGFycy9NZW1iZXJBdmF0YXInO1xuaW1wb3J0IGNsYXNzTmFtZXMgZnJvbSAnY2xhc3NuYW1lcyc7XG5pbXBvcnQgU3RhdHVzTWVzc2FnZUNvbnRleHRNZW51IGZyb20gXCIuLi9jb250ZXh0X21lbnVzL1N0YXR1c01lc3NhZ2VDb250ZXh0TWVudVwiO1xuaW1wb3J0IFNldHRpbmdzU3RvcmUgZnJvbSBcIi4uLy4uLy4uL3NldHRpbmdzL1NldHRpbmdzU3RvcmVcIjtcbmltcG9ydCBDb250ZXh0TWVudSwgeyBDaGV2cm9uRmFjZSwgQ29udGV4dE1lbnVCdXR0b24gfSBmcm9tIFwiLi4vLi4vc3RydWN0dXJlcy9Db250ZXh0TWVudVwiO1xuaW1wb3J0IHsgcmVwbGFjZWFibGVDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvcmVwbGFjZWFibGVDb21wb25lbnRcIjtcbmltcG9ydCB7IFJvb21NZW1iZXIgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3Jvb20tbWVtYmVyXCI7XG5pbXBvcnQgeyBSZXNpemVNZXRob2QgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvQHR5cGVzL3BhcnRpYWxzXCI7XG5cbmludGVyZmFjZSBJUHJvcHMge1xuICAgIG1lbWJlcjogUm9vbU1lbWJlcjtcbiAgICB3aWR0aD86IG51bWJlcjtcbiAgICBoZWlnaHQ/OiBudW1iZXI7XG4gICAgcmVzaXplTWV0aG9kPzogUmVzaXplTWV0aG9kO1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBoYXNTdGF0dXM6IGJvb2xlYW47XG4gICAgbWVudURpc3BsYXllZDogYm9vbGVhbjtcbn1cblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3MuYXZhdGFycy5NZW1iZXJTdGF0dXNNZXNzYWdlQXZhdGFyXCIpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBNZW1iZXJTdGF0dXNNZXNzYWdlQXZhdGFyIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PElQcm9wcywgSVN0YXRlPiB7XG4gICAgcHVibGljIHN0YXRpYyBkZWZhdWx0UHJvcHM6IFBhcnRpYWw8SVByb3BzPiA9IHtcbiAgICAgICAgd2lkdGg6IDQwLFxuICAgICAgICBoZWlnaHQ6IDQwLFxuICAgICAgICByZXNpemVNZXRob2Q6ICdjcm9wJyxcbiAgICB9O1xuICAgIHByaXZhdGUgYnV0dG9uID0gY3JlYXRlUmVmPEhUTUxEaXZFbGVtZW50PigpO1xuXG4gICAgY29uc3RydWN0b3IocHJvcHM6IElQcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG5cbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIGhhc1N0YXR1czogdGhpcy5oYXNTdGF0dXMsXG4gICAgICAgICAgICBtZW51RGlzcGxheWVkOiBmYWxzZSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY29tcG9uZW50RGlkTW91bnQoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLnByb3BzLm1lbWJlci51c2VySWQgIT09IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRVc2VySWQoKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IHVzZSBNZW1iZXJTdGF0dXNNZXNzYWdlQXZhdGFyIG9uIGFueW9uZSBidXQgdGhlIGxvZ2dlZCBpbiB1c2VyXCIpO1xuICAgICAgICB9XG4gICAgICAgIGlmICghU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcImZlYXR1cmVfY3VzdG9tX3N0YXR1c1wiKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHsgdXNlciB9ID0gdGhpcy5wcm9wcy5tZW1iZXI7XG4gICAgICAgIGlmICghdXNlcikge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHVzZXIub24oXCJVc2VyLl91bnN0YWJsZV9zdGF0dXNNZXNzYWdlXCIsIHRoaXMub25TdGF0dXNNZXNzYWdlQ29tbWl0dGVkKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY29tcG9uZW50V2lsbFVubW91bnQoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IHsgdXNlciB9ID0gdGhpcy5wcm9wcy5tZW1iZXI7XG4gICAgICAgIGlmICghdXNlcikge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHVzZXIucmVtb3ZlTGlzdGVuZXIoXG4gICAgICAgICAgICBcIlVzZXIuX3Vuc3RhYmxlX3N0YXR1c01lc3NhZ2VcIixcbiAgICAgICAgICAgIHRoaXMub25TdGF0dXNNZXNzYWdlQ29tbWl0dGVkLFxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0IGhhc1N0YXR1cygpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgeyB1c2VyIH0gPSB0aGlzLnByb3BzLm1lbWJlcjtcbiAgICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuICEhdXNlci51bnN0YWJsZV9zdGF0dXNNZXNzYWdlO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25TdGF0dXNNZXNzYWdlQ29tbWl0dGVkID0gKCk6IHZvaWQgPT4ge1xuICAgICAgICAvLyBUaGUgYFVzZXJgIG9iamVjdCBoYXMgb2JzZXJ2ZWQgYSBzdGF0dXMgbWVzc2FnZSBjaGFuZ2UuXG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgaGFzU3RhdHVzOiB0aGlzLmhhc1N0YXR1cyxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb3Blbk1lbnUgPSAoKTogdm9pZCA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBtZW51RGlzcGxheWVkOiB0cnVlIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIGNsb3NlTWVudSA9ICgpOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IG1lbnVEaXNwbGF5ZWQ6IGZhbHNlIH0pO1xuICAgIH07XG5cbiAgICBwdWJsaWMgcmVuZGVyKCk6IEpTWC5FbGVtZW50IHtcbiAgICAgICAgY29uc3QgYXZhdGFyID0gPE1lbWJlckF2YXRhclxuICAgICAgICAgICAgbWVtYmVyPXt0aGlzLnByb3BzLm1lbWJlcn1cbiAgICAgICAgICAgIHdpZHRoPXt0aGlzLnByb3BzLndpZHRofVxuICAgICAgICAgICAgaGVpZ2h0PXt0aGlzLnByb3BzLmhlaWdodH1cbiAgICAgICAgICAgIHJlc2l6ZU1ldGhvZD17dGhpcy5wcm9wcy5yZXNpemVNZXRob2R9XG4gICAgICAgIC8+O1xuXG4gICAgICAgIGlmICghU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcImZlYXR1cmVfY3VzdG9tX3N0YXR1c1wiKSkge1xuICAgICAgICAgICAgcmV0dXJuIGF2YXRhcjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGNsYXNzZXMgPSBjbGFzc05hbWVzKHtcbiAgICAgICAgICAgIFwibXhfTWVtYmVyU3RhdHVzTWVzc2FnZUF2YXRhclwiOiB0cnVlLFxuICAgICAgICAgICAgXCJteF9NZW1iZXJTdGF0dXNNZXNzYWdlQXZhdGFyX2hhc1N0YXR1c1wiOiB0aGlzLnN0YXRlLmhhc1N0YXR1cyxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgbGV0IGNvbnRleHRNZW51O1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5tZW51RGlzcGxheWVkKSB7XG4gICAgICAgICAgICBjb25zdCBlbGVtZW50UmVjdCA9IHRoaXMuYnV0dG9uLmN1cnJlbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG5cbiAgICAgICAgICAgIGNvbnN0IGNoZXZyb25XaWR0aCA9IDE2OyAvLyBTZWUgLm14X0NvbnRleHR1YWxNZW51X2NoZXZyb25fYm90dG9tXG4gICAgICAgICAgICBjb25zdCBjaGV2cm9uTWFyZ2luID0gMTsgLy8gQWRkIHNvbWUgc3BhY2luZyBhd2F5IGZyb20gdGFyZ2V0XG5cbiAgICAgICAgICAgIGNvbnRleHRNZW51ID0gKFxuICAgICAgICAgICAgICAgIDxDb250ZXh0TWVudVxuICAgICAgICAgICAgICAgICAgICBjaGV2cm9uT2Zmc2V0PXsoZWxlbWVudFJlY3Qud2lkdGggLSBjaGV2cm9uV2lkdGgpIC8gMn1cbiAgICAgICAgICAgICAgICAgICAgY2hldnJvbkZhY2U9e0NoZXZyb25GYWNlLkJvdHRvbX1cbiAgICAgICAgICAgICAgICAgICAgbGVmdD17ZWxlbWVudFJlY3QubGVmdCArIHdpbmRvdy5wYWdlWE9mZnNldH1cbiAgICAgICAgICAgICAgICAgICAgdG9wPXtlbGVtZW50UmVjdC50b3AgKyB3aW5kb3cucGFnZVlPZmZzZXQgLSBjaGV2cm9uTWFyZ2lufVxuICAgICAgICAgICAgICAgICAgICBtZW51V2lkdGg9ezIyNn1cbiAgICAgICAgICAgICAgICAgICAgb25GaW5pc2hlZD17dGhpcy5jbG9zZU1lbnV9XG4gICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICA8U3RhdHVzTWVzc2FnZUNvbnRleHRNZW51IHVzZXI9e3RoaXMucHJvcHMubWVtYmVyLnVzZXJ9IC8+XG4gICAgICAgICAgICAgICAgPC9Db250ZXh0TWVudT5cbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gPFJlYWN0LkZyYWdtZW50PlxuICAgICAgICAgICAgPENvbnRleHRNZW51QnV0dG9uXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lPXtjbGFzc2VzfVxuICAgICAgICAgICAgICAgIGlucHV0UmVmPXt0aGlzLmJ1dHRvbn1cbiAgICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLm9wZW5NZW51fVxuICAgICAgICAgICAgICAgIGlzRXhwYW5kZWQ9e3RoaXMuc3RhdGUubWVudURpc3BsYXllZH1cbiAgICAgICAgICAgICAgICBsYWJlbD17X3QoXCJVc2VyIFN0YXR1c1wiKX1cbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICB7IGF2YXRhciB9XG4gICAgICAgICAgICA8L0NvbnRleHRNZW51QnV0dG9uPlxuXG4gICAgICAgICAgICB7IGNvbnRleHRNZW51IH1cbiAgICAgICAgPC9SZWFjdC5GcmFnbWVudD47XG4gICAgfVxufVxuIl19