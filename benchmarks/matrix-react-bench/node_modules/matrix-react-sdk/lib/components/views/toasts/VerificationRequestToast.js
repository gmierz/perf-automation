"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _languageHandler = require("../../../languageHandler");

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _RightPanelStorePhases = require("../../../stores/RightPanelStorePhases");

var _KeyVerificationStateObserver = require("../../../utils/KeyVerificationStateObserver");

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var _ToastStore = _interopRequireDefault(require("../../../stores/ToastStore"));

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _GenericToast = _interopRequireDefault(require("./GenericToast"));

var _actions = require("../../../dispatcher/actions");

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _VerificationRequestDialog = _interopRequireDefault(require("../dialogs/VerificationRequestDialog"));

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class;

let VerificationRequestToast = (_dec = (0, _replaceableComponent.replaceableComponent)("views.toasts.VerificationRequestToast"), _dec(_class = class VerificationRequestToast extends _react.default.PureComponent {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "intervalHandle", void 0);
    (0, _defineProperty2.default)(this, "checkRequestIsPending", () => {
      const {
        request
      } = this.props;

      if (!request.canAccept) {
        _ToastStore.default.sharedInstance().dismissToast(this.props.toastKey);
      }
    });
    (0, _defineProperty2.default)(this, "cancel", () => {
      _ToastStore.default.sharedInstance().dismissToast(this.props.toastKey);

      try {
        this.props.request.cancel();
      } catch (err) {
        _logger.logger.error("Error while cancelling verification request", err);
      }
    });
    (0, _defineProperty2.default)(this, "accept", async () => {
      _ToastStore.default.sharedInstance().dismissToast(this.props.toastKey);

      const {
        request
      } = this.props; // no room id for to_device requests

      const cli = _MatrixClientPeg.MatrixClientPeg.get();

      try {
        if (request.channel.roomId) {
          _dispatcher.default.dispatch({
            action: _actions.Action.ViewRoom,
            room_id: request.channel.roomId,
            should_peek: false
          });

          _dispatcher.default.dispatch({
            action: _actions.Action.SetRightPanelPhase,
            phase: _RightPanelStorePhases.RightPanelPhases.EncryptionPanel,
            refireParams: {
              verificationRequest: request,
              member: cli.getUser(request.otherUserId)
            }
          });
        } else {
          _Modal.default.createTrackedDialog('Incoming Verification', '', _VerificationRequestDialog.default, {
            verificationRequest: request,
            onFinished: () => {
              request.cancel();
            }
          }, null,
          /* priority = */
          false,
          /* static = */
          true);
        }

        await request.accept();
      } catch (err) {
        _logger.logger.error(err.message);
      }
    });
    this.state = {
      counter: Math.ceil(props.request.timeout / 1000)
    };
  }

  async componentDidMount() {
    const {
      request
    } = this.props;

    if (request.timeout && request.timeout > 0) {
      this.intervalHandle = setInterval(() => {
        let {
          counter
        } = this.state;
        counter = Math.max(0, counter - 1);
        this.setState({
          counter
        });
      }, 1000);
    }

    request.on("change", this.checkRequestIsPending); // We should probably have a separate class managing the active verification toasts,
    // rather than monitoring this in the toast component itself, since we'll get problems
    // like the toasdt not going away when the verification is cancelled unless it's the
    // one on the top (ie. the one that's mounted).
    // As a quick & dirty fix, check the toast is still relevant when it mounts (this prevents
    // a toast hanging around after logging in if you did a verification as part of login).

    this.checkRequestIsPending();

    if (request.isSelfVerification) {
      const cli = _MatrixClientPeg.MatrixClientPeg.get();

      const device = await cli.getDevice(request.channel.deviceId);
      const ip = device.last_seen_ip;
      this.setState({
        device: cli.getStoredDevice(cli.getUserId(), request.channel.deviceId),
        ip
      });
    }
  }

  componentWillUnmount() {
    clearInterval(this.intervalHandle);
    const {
      request
    } = this.props;
    request.off("change", this.checkRequestIsPending);
  }

  render() {
    const {
      request
    } = this.props;
    let description;
    let detail;

    if (request.isSelfVerification) {
      if (this.state.device) {
        description = this.state.device.getDisplayName();
        detail = (0, _languageHandler._t)("%(deviceId)s from %(ip)s", {
          deviceId: this.state.device.deviceId,
          ip: this.state.ip
        });
      }
    } else {
      const userId = request.otherUserId;
      const roomId = request.channel.roomId;
      description = roomId ? (0, _KeyVerificationStateObserver.userLabelForEventRoom)(userId, roomId) : userId; // for legacy to_device verification requests

      if (description === userId) {
        const client = _MatrixClientPeg.MatrixClientPeg.get();

        const user = client.getUser(userId);

        if (user && user.displayName) {
          description = (0, _languageHandler._t)("%(name)s (%(userId)s)", {
            name: user.displayName,
            userId
          });
        }
      }
    }

    const declineLabel = this.state.counter === 0 ? (0, _languageHandler._t)("Decline") : (0, _languageHandler._t)("Decline (%(counter)s)", {
      counter: this.state.counter
    });
    return /*#__PURE__*/_react.default.createElement(_GenericToast.default, {
      description: description,
      detail: detail,
      acceptLabel: (0, _languageHandler._t)("Accept"),
      onAccept: this.accept,
      rejectLabel: declineLabel,
      onReject: this.cancel
    });
  }

}) || _class);
exports.default = VerificationRequestToast;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3RvYXN0cy9WZXJpZmljYXRpb25SZXF1ZXN0VG9hc3QudHN4Il0sIm5hbWVzIjpbIlZlcmlmaWNhdGlvblJlcXVlc3RUb2FzdCIsIlJlYWN0IiwiUHVyZUNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJyZXF1ZXN0IiwiY2FuQWNjZXB0IiwiVG9hc3RTdG9yZSIsInNoYXJlZEluc3RhbmNlIiwiZGlzbWlzc1RvYXN0IiwidG9hc3RLZXkiLCJjYW5jZWwiLCJlcnIiLCJsb2dnZXIiLCJlcnJvciIsImNsaSIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsImNoYW5uZWwiLCJyb29tSWQiLCJkaXMiLCJkaXNwYXRjaCIsImFjdGlvbiIsIkFjdGlvbiIsIlZpZXdSb29tIiwicm9vbV9pZCIsInNob3VsZF9wZWVrIiwiU2V0UmlnaHRQYW5lbFBoYXNlIiwicGhhc2UiLCJSaWdodFBhbmVsUGhhc2VzIiwiRW5jcnlwdGlvblBhbmVsIiwicmVmaXJlUGFyYW1zIiwidmVyaWZpY2F0aW9uUmVxdWVzdCIsIm1lbWJlciIsImdldFVzZXIiLCJvdGhlclVzZXJJZCIsIk1vZGFsIiwiY3JlYXRlVHJhY2tlZERpYWxvZyIsIlZlcmlmaWNhdGlvblJlcXVlc3REaWFsb2ciLCJvbkZpbmlzaGVkIiwiYWNjZXB0IiwibWVzc2FnZSIsInN0YXRlIiwiY291bnRlciIsIk1hdGgiLCJjZWlsIiwidGltZW91dCIsImNvbXBvbmVudERpZE1vdW50IiwiaW50ZXJ2YWxIYW5kbGUiLCJzZXRJbnRlcnZhbCIsIm1heCIsInNldFN0YXRlIiwib24iLCJjaGVja1JlcXVlc3RJc1BlbmRpbmciLCJpc1NlbGZWZXJpZmljYXRpb24iLCJkZXZpY2UiLCJnZXREZXZpY2UiLCJkZXZpY2VJZCIsImlwIiwibGFzdF9zZWVuX2lwIiwiZ2V0U3RvcmVkRGV2aWNlIiwiZ2V0VXNlcklkIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJjbGVhckludGVydmFsIiwib2ZmIiwicmVuZGVyIiwiZGVzY3JpcHRpb24iLCJkZXRhaWwiLCJnZXREaXNwbGF5TmFtZSIsInVzZXJJZCIsImNsaWVudCIsInVzZXIiLCJkaXNwbGF5TmFtZSIsIm5hbWUiLCJkZWNsaW5lTGFiZWwiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUVBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBOztBQUNBOztBQUNBOztBQUVBOzs7O0lBY3FCQSx3QixXQURwQixnREFBcUIsdUNBQXJCLEMsZ0JBQUQsTUFDcUJBLHdCQURyQixTQUNzREMsZUFBTUMsYUFENUQsQ0FDMEY7QUFHdEZDLEVBQUFBLFdBQVcsQ0FBQ0MsS0FBRCxFQUFRO0FBQ2YsVUFBTUEsS0FBTjtBQURlO0FBQUEsaUVBd0NhLE1BQU07QUFDbEMsWUFBTTtBQUFFQyxRQUFBQTtBQUFGLFVBQWMsS0FBS0QsS0FBekI7O0FBQ0EsVUFBSSxDQUFDQyxPQUFPLENBQUNDLFNBQWIsRUFBd0I7QUFDcEJDLDRCQUFXQyxjQUFYLEdBQTRCQyxZQUE1QixDQUF5QyxLQUFLTCxLQUFMLENBQVdNLFFBQXBEO0FBQ0g7QUFDSixLQTdDa0I7QUFBQSxrREErQ1YsTUFBTTtBQUNYSCwwQkFBV0MsY0FBWCxHQUE0QkMsWUFBNUIsQ0FBeUMsS0FBS0wsS0FBTCxDQUFXTSxRQUFwRDs7QUFDQSxVQUFJO0FBQ0EsYUFBS04sS0FBTCxDQUFXQyxPQUFYLENBQW1CTSxNQUFuQjtBQUNILE9BRkQsQ0FFRSxPQUFPQyxHQUFQLEVBQVk7QUFDVkMsdUJBQU9DLEtBQVAsQ0FBYSw2Q0FBYixFQUE0REYsR0FBNUQ7QUFDSDtBQUNKLEtBdERrQjtBQUFBLGtEQXdEVixZQUFZO0FBQ2pCTCwwQkFBV0MsY0FBWCxHQUE0QkMsWUFBNUIsQ0FBeUMsS0FBS0wsS0FBTCxDQUFXTSxRQUFwRDs7QUFDQSxZQUFNO0FBQUVMLFFBQUFBO0FBQUYsVUFBYyxLQUFLRCxLQUF6QixDQUZpQixDQUdqQjs7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QU1zRCxJQUFJLEdBQUdELE1BQU0sQ0FBQ3BDLE9BQVAsQ0FBZW1DLE1BQWYsQ0FBYjs7QUFDQSxZQUFJRSxJQUFJLElBQUlBLElBQUksQ0FBQ0MsV0FBakIsRUFBOEI7QUFDMUJOLFVBQUFBLFdBQVcsR0FBRyx5QkFBRyx1QkFBSCxFQUE0QjtBQUFFTyxZQUFBQSxJQUFJLEVBQUVGLElBQUksQ0FBQ0MsV0FBYjtBQUEwQkgsWUFBQUE7QUFBMUIsV0FBNUIsQ0FBZDtBQUNIO0FBQ0o7QUFDSjs7QUFDRCxVQUFNSyxZQUFZLEdBQUcsS0FBS2hDLEtBQUwsQ0FBV0MsT0FBWCxLQUF1QixDQUF2QixHQUNqQix5QkFBRyxTQUFILENBRGlCLEdBRWpCLHlCQUFHLHVCQUFILEVBQTRCO0FBQUVBLE1BQUFBLE9BQU8sRUFBRSxLQUFLRCxLQUFMLENBQVdDO0FBQXRCLEtBQTVCLENBRko7QUFJQSx3QkFBTyw2QkFBQyxxQkFBRDtBQUNILE1BQUEsV0FBVyxFQUFFdUIsV0FEVjtBQUVILE1BQUEsTUFBTSxFQUFFQyxNQUZMO0FBR0gsTUFBQSxXQUFXLEVBQUUseUJBQUcsUUFBSCxDQUhWO0FBSUgsTUFBQSxRQUFRLEVBQUUsS0FBSzNCLE1BSlo7QUFLSCxNQUFBLFdBQVcsRUFBRWtDLFlBTFY7QUFNSCxNQUFBLFFBQVEsRUFBRSxLQUFLL0Q7QUFOWixNQUFQO0FBUUg7O0FBbElxRixDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE5LTIwMjEgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCBmcm9tIFwicmVhY3RcIjtcblxuaW1wb3J0IHsgX3QgfSBmcm9tICcuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXInO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSAnLi4vLi4vLi4vTWF0cml4Q2xpZW50UGVnJztcbmltcG9ydCB7IFJpZ2h0UGFuZWxQaGFzZXMgfSBmcm9tIFwiLi4vLi4vLi4vc3RvcmVzL1JpZ2h0UGFuZWxTdG9yZVBoYXNlc1wiO1xuaW1wb3J0IHsgU2V0UmlnaHRQYW5lbFBoYXNlUGF5bG9hZCB9IGZyb20gXCIuLi8uLi8uLi9kaXNwYXRjaGVyL3BheWxvYWRzL1NldFJpZ2h0UGFuZWxQaGFzZVBheWxvYWRcIjtcbmltcG9ydCB7IHVzZXJMYWJlbEZvckV2ZW50Um9vbSB9IGZyb20gXCIuLi8uLi8uLi91dGlscy9LZXlWZXJpZmljYXRpb25TdGF0ZU9ic2VydmVyXCI7XG5pbXBvcnQgZGlzIGZyb20gXCIuLi8uLi8uLi9kaXNwYXRjaGVyL2Rpc3BhdGNoZXJcIjtcbmltcG9ydCBUb2FzdFN0b3JlIGZyb20gXCIuLi8uLi8uLi9zdG9yZXMvVG9hc3RTdG9yZVwiO1xuaW1wb3J0IE1vZGFsIGZyb20gXCIuLi8uLi8uLi9Nb2RhbFwiO1xuaW1wb3J0IEdlbmVyaWNUb2FzdCBmcm9tIFwiLi9HZW5lcmljVG9hc3RcIjtcbmltcG9ydCB7IFZlcmlmaWNhdGlvblJlcXVlc3QgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvY3J5cHRvL3ZlcmlmaWNhdGlvbi9yZXF1ZXN0L1ZlcmlmaWNhdGlvblJlcXVlc3RcIjtcbmltcG9ydCB7IERldmljZUluZm8gfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvY3J5cHRvL2RldmljZWluZm9cIjtcbmltcG9ydCB7IEFjdGlvbiB9IGZyb20gXCIuLi8uLi8uLi9kaXNwYXRjaGVyL2FjdGlvbnNcIjtcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5pbXBvcnQgVmVyaWZpY2F0aW9uUmVxdWVzdERpYWxvZyBmcm9tIFwiLi4vZGlhbG9ncy9WZXJpZmljYXRpb25SZXF1ZXN0RGlhbG9nXCI7XG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcblxuaW50ZXJmYWNlIElQcm9wcyB7XG4gICAgdG9hc3RLZXk6IHN0cmluZztcbiAgICByZXF1ZXN0OiBWZXJpZmljYXRpb25SZXF1ZXN0O1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBjb3VudGVyOiBudW1iZXI7XG4gICAgZGV2aWNlPzogRGV2aWNlSW5mbztcbiAgICBpcD86IHN0cmluZztcbn1cblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3MudG9hc3RzLlZlcmlmaWNhdGlvblJlcXVlc3RUb2FzdFwiKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVmVyaWZpY2F0aW9uUmVxdWVzdFRvYXN0IGV4dGVuZHMgUmVhY3QuUHVyZUNvbXBvbmVudDxJUHJvcHMsIElTdGF0ZT4ge1xuICAgIHByaXZhdGUgaW50ZXJ2YWxIYW5kbGU6IG51bWJlcjtcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcbiAgICAgICAgdGhpcy5zdGF0ZSA9IHsgY291bnRlcjogTWF0aC5jZWlsKHByb3BzLnJlcXVlc3QudGltZW91dCAvIDEwMDApIH07XG4gICAgfVxuXG4gICAgYXN5bmMgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgICAgIGNvbnN0IHsgcmVxdWVzdCB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgaWYgKHJlcXVlc3QudGltZW91dCAmJiByZXF1ZXN0LnRpbWVvdXQgPiAwKSB7XG4gICAgICAgICAgICB0aGlzLmludGVydmFsSGFuZGxlID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCB7IGNvdW50ZXIgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgICAgICAgICAgY291bnRlciA9IE1hdGgubWF4KDAsIGNvdW50ZXIgLSAxKTtcbiAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgY291bnRlciB9KTtcbiAgICAgICAgICAgIH0sIDEwMDApO1xuICAgICAgICB9XG4gICAgICAgIHJlcXVlc3Qub24oXCJjaGFuZ2VcIiwgdGhpcy5jaGVja1JlcXVlc3RJc1BlbmRpbmcpO1xuICAgICAgICAvLyBXZSBzaG91bGQgcHJvYmFibHkgaGF2ZSBhIHNlcGFyYXRlIGNsYXNzIG1hbmFnaW5nIHRoZSBhY3RpdmUgdmVyaWZpY2F0aW9uIHRvYXN0cyxcbiAgICAgICAgLy8gcmF0aGVyIHRoYW4gbW9uaXRvcmluZyB0aGlzIGluIHRoZSB0b2FzdCBjb21wb25lbnQgaXRzZWxmLCBzaW5jZSB3ZSdsbCBnZXQgcHJvYmxlbXNcbiAgICAgICAgLy8gbGlrZSB0aGUgdG9hc2R0IG5vdCBnb2luZyBhd2F5IHdoZW4gdGhlIHZlcmlmaWNhdGlvbiBpcyBjYW5jZWxsZWQgdW5sZXNzIGl0J3MgdGhlXG4gICAgICAgIC8vIG9uZSBvbiB0aGUgdG9wIChpZS4gdGhlIG9uZSB0aGF0J3MgbW91bnRlZCkuXG4gICAgICAgIC8vIEFzIGEgcXVpY2sgJiBkaXJ0eSBmaXgsIGNoZWNrIHRoZSB0b2FzdCBpcyBzdGlsbCByZWxldmFudCB3aGVuIGl0IG1vdW50cyAodGhpcyBwcmV2ZW50c1xuICAgICAgICAvLyBhIHRvYXN0IGhhbmdpbmcgYXJvdW5kIGFmdGVyIGxvZ2dpbmcgaW4gaWYgeW91IGRpZCBhIHZlcmlmaWNhdGlvbiBhcyBwYXJ0IG9mIGxvZ2luKS5cbiAgICAgICAgdGhpcy5jaGVja1JlcXVlc3RJc1BlbmRpbmcoKTtcblxuICAgICAgICBpZiAocmVxdWVzdC5pc1NlbGZWZXJpZmljYXRpb24pIHtcbiAgICAgICAgICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICAgICAgICAgIGNvbnN0IGRldmljZSA9IGF3YWl0IGNsaS5nZXREZXZpY2UocmVxdWVzdC5jaGFubmVsLmRldmljZUlkKTtcbiAgICAgICAgICAgIGNvbnN0IGlwID0gZGV2aWNlLmxhc3Rfc2Vlbl9pcDtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgIGRldmljZTogY2xpLmdldFN0b3JlZERldmljZShjbGkuZ2V0VXNlcklkKCksIHJlcXVlc3QuY2hhbm5lbC5kZXZpY2VJZCksXG4gICAgICAgICAgICAgICAgaXAsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgICBjbGVhckludGVydmFsKHRoaXMuaW50ZXJ2YWxIYW5kbGUpO1xuICAgICAgICBjb25zdCB7IHJlcXVlc3QgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIHJlcXVlc3Qub2ZmKFwiY2hhbmdlXCIsIHRoaXMuY2hlY2tSZXF1ZXN0SXNQZW5kaW5nKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNoZWNrUmVxdWVzdElzUGVuZGluZyA9ICgpID0+IHtcbiAgICAgICAgY29uc3QgeyByZXF1ZXN0IH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBpZiAoIXJlcXVlc3QuY2FuQWNjZXB0KSB7XG4gICAgICAgICAgICBUb2FzdFN0b3JlLnNoYXJlZEluc3RhbmNlKCkuZGlzbWlzc1RvYXN0KHRoaXMucHJvcHMudG9hc3RLZXkpO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIGNhbmNlbCA9ICgpID0+IHtcbiAgICAgICAgVG9hc3RTdG9yZS5zaGFyZWRJbnN0YW5jZSgpLmRpc21pc3NUb2FzdCh0aGlzLnByb3BzLnRvYXN0S2V5KTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHRoaXMucHJvcHMucmVxdWVzdC5jYW5jZWwoKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoXCJFcnJvciB3aGlsZSBjYW5jZWxsaW5nIHZlcmlmaWNhdGlvbiByZXF1ZXN0XCIsIGVycik7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgYWNjZXB0ID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICBUb2FzdFN0b3JlLnNoYXJlZEluc3RhbmNlKCkuZGlzbWlzc1RvYXN0KHRoaXMucHJvcHMudG9hc3RLZXkpO1xuICAgICAgICBjb25zdCB7IHJlcXVlc3QgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIC8vIG5vIHJvb20gaWQgZm9yIHRvX2RldmljZSByZXF1ZXN0c1xuICAgICAgICBjb25zdCBjbGkgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAocmVxdWVzdC5jaGFubmVsLnJvb21JZCkge1xuICAgICAgICAgICAgICAgIGRpcy5kaXNwYXRjaCh7XG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbjogQWN0aW9uLlZpZXdSb29tLFxuICAgICAgICAgICAgICAgICAgICByb29tX2lkOiByZXF1ZXN0LmNoYW5uZWwucm9vbUlkLFxuICAgICAgICAgICAgICAgICAgICBzaG91bGRfcGVlazogZmFsc2UsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgZGlzLmRpc3BhdGNoPFNldFJpZ2h0UGFuZWxQaGFzZVBheWxvYWQ+KHtcbiAgICAgICAgICAgICAgICAgICAgYWN0aW9uOiBBY3Rpb24uU2V0UmlnaHRQYW5lbFBoYXNlLFxuICAgICAgICAgICAgICAgICAgICBwaGFzZTogUmlnaHRQYW5lbFBoYXNlcy5FbmNyeXB0aW9uUGFuZWwsXG4gICAgICAgICAgICAgICAgICAgIHJlZmlyZVBhcmFtczoge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmVyaWZpY2F0aW9uUmVxdWVzdDogcmVxdWVzdCxcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lbWJlcjogY2xpLmdldFVzZXIocmVxdWVzdC5vdGhlclVzZXJJZCksXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coJ0luY29taW5nIFZlcmlmaWNhdGlvbicsICcnLCBWZXJpZmljYXRpb25SZXF1ZXN0RGlhbG9nLCB7XG4gICAgICAgICAgICAgICAgICAgIHZlcmlmaWNhdGlvblJlcXVlc3Q6IHJlcXVlc3QsXG4gICAgICAgICAgICAgICAgICAgIG9uRmluaXNoZWQ6ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3QuY2FuY2VsKCk7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSwgbnVsbCwgLyogcHJpb3JpdHkgPSAqLyBmYWxzZSwgLyogc3RhdGljID0gKi8gdHJ1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhd2FpdCByZXF1ZXN0LmFjY2VwdCgpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihlcnIubWVzc2FnZSk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCB7IHJlcXVlc3QgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGxldCBkZXNjcmlwdGlvbjtcbiAgICAgICAgbGV0IGRldGFpbDtcbiAgICAgICAgaWYgKHJlcXVlc3QuaXNTZWxmVmVyaWZpY2F0aW9uKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5zdGF0ZS5kZXZpY2UpIHtcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbiA9IHRoaXMuc3RhdGUuZGV2aWNlLmdldERpc3BsYXlOYW1lKCk7XG4gICAgICAgICAgICAgICAgZGV0YWlsID0gX3QoXCIlKGRldmljZUlkKXMgZnJvbSAlKGlwKXNcIiwge1xuICAgICAgICAgICAgICAgICAgICBkZXZpY2VJZDogdGhpcy5zdGF0ZS5kZXZpY2UuZGV2aWNlSWQsXG4gICAgICAgICAgICAgICAgICAgIGlwOiB0aGlzLnN0YXRlLmlwLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgdXNlcklkID0gcmVxdWVzdC5vdGhlclVzZXJJZDtcbiAgICAgICAgICAgIGNvbnN0IHJvb21JZCA9IHJlcXVlc3QuY2hhbm5lbC5yb29tSWQ7XG4gICAgICAgICAgICBkZXNjcmlwdGlvbiA9IHJvb21JZCA/IHVzZXJMYWJlbEZvckV2ZW50Um9vbSh1c2VySWQsIHJvb21JZCkgOiB1c2VySWQ7XG4gICAgICAgICAgICAvLyBmb3IgbGVnYWN5IHRvX2RldmljZSB2ZXJpZmljYXRpb24gcmVxdWVzdHNcbiAgICAgICAgICAgIGlmIChkZXNjcmlwdGlvbiA9PT0gdXNlcklkKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY2xpZW50ID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHVzZXIgPSBjbGllbnQuZ2V0VXNlcih1c2VySWQpO1xuICAgICAgICAgICAgICAgIGlmICh1c2VyICYmIHVzZXIuZGlzcGxheU5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb24gPSBfdChcIiUobmFtZSlzICglKHVzZXJJZClzKVwiLCB7IG5hbWU6IHVzZXIuZGlzcGxheU5hbWUsIHVzZXJJZCB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgZGVjbGluZUxhYmVsID0gdGhpcy5zdGF0ZS5jb3VudGVyID09PSAwID9cbiAgICAgICAgICAgIF90KFwiRGVjbGluZVwiKSA6XG4gICAgICAgICAgICBfdChcIkRlY2xpbmUgKCUoY291bnRlcilzKVwiLCB7IGNvdW50ZXI6IHRoaXMuc3RhdGUuY291bnRlciB9KTtcblxuICAgICAgICByZXR1cm4gPEdlbmVyaWNUb2FzdFxuICAgICAgICAgICAgZGVzY3JpcHRpb249e2Rlc2NyaXB0aW9ufVxuICAgICAgICAgICAgZGV0YWlsPXtkZXRhaWx9XG4gICAgICAgICAgICBhY2NlcHRMYWJlbD17X3QoXCJBY2NlcHRcIil9XG4gICAgICAgICAgICBvbkFjY2VwdD17dGhpcy5hY2NlcHR9XG4gICAgICAgICAgICByZWplY3RMYWJlbD17ZGVjbGluZUxhYmVsfVxuICAgICAgICAgICAgb25SZWplY3Q9e3RoaXMuY2FuY2VsfVxuICAgICAgICAvPjtcbiAgICB9XG59XG4iXX0=