"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _event = require("matrix-js-sdk/src/models/event");

var sdk = _interopRequireWildcard(require("../../../index"));

var _languageHandler = require("../../../languageHandler");

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _ErrorDialog = _interopRequireDefault(require("../dialogs/ErrorDialog"));

var _MatrixClientContext = _interopRequireDefault(require("../../../contexts/MatrixClientContext"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _logger = require("matrix-js-sdk/src/logger");

var _dec, _class, _class2, _temp;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

const GROUP_ID_REGEX = /\+\S+:\S+/;
let RelatedGroupSettings = (_dec = (0, _replaceableComponent.replaceableComponent)("views.room_settings.RelatedGroupSettings"), _dec(_class = (_temp = _class2 = class RelatedGroupSettings extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onNewGroupChanged", newGroupId => {
      this.setState({
        newGroupId
      });
    });
    (0, _defineProperty2.default)(this, "onGroupAdded", groupId => {
      if (groupId.length === 0 || !this.validateGroupId(groupId)) {
        return;
      }

      const newGroupsList = [...this.state.newGroupsList, groupId];
      this.setState({
        newGroupsList: newGroupsList,
        newGroupId: ''
      });
      this.updateGroups(newGroupsList);
    });
    (0, _defineProperty2.default)(this, "onGroupDeleted", index => {
      const group = this.state.newGroupsList[index];
      const newGroupsList = this.state.newGroupsList.filter(g => g !== group);
      this.setState({
        newGroupsList
      });
      this.updateGroups(newGroupsList);
    });
    this.state = {
      newGroupId: "",
      newGroupsList: props.relatedGroupsEvent ? props.relatedGroupsEvent.getContent().groups || [] : []
    };
  }

  updateGroups(newGroupsList) {
    this.context.sendStateEvent(this.props.roomId, 'm.room.related_groups', {
      groups: newGroupsList
    }, '').catch(err => {
      _logger.logger.error(err);

      _Modal.default.createTrackedDialog('Error updating flair', '', _ErrorDialog.default, {
        title: (0, _languageHandler._t)("Error updating flair"),
        description: (0, _languageHandler._t)("There was an error updating the flair for this room. The server may not allow it or " + "a temporary error occurred.")
      });
    });
  }

  validateGroupId(groupId) {
    if (!GROUP_ID_REGEX.test(groupId)) {
      const ErrorDialog = sdk.getComponent("dialogs.ErrorDialog");

      _Modal.default.createTrackedDialog('Invalid related community ID', '', ErrorDialog, {
        title: (0, _languageHandler._t)('Invalid community ID'),
        description: (0, _languageHandler._t)('\'%(groupId)s\' is not a valid community ID', {
          groupId
        })
      });

      return false;
    }

    return true;
  }

  render() {
    const localDomain = this.context.getDomain();
    const EditableItemList = sdk.getComponent('elements.EditableItemList');
    return /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement(EditableItemList, {
      id: "relatedGroups",
      items: this.state.newGroupsList,
      className: "mx_RelatedGroupSettings",
      newItem: this.state.newGroupId,
      canRemove: this.props.canSetRelatedGroups,
      canEdit: this.props.canSetRelatedGroups,
      onNewItemChanged: this.onNewGroupChanged,
      onItemAdded: this.onGroupAdded,
      onItemRemoved: this.onGroupDeleted,
      itemsLabel: (0, _languageHandler._t)('Showing flair for these communities:'),
      noItemsLabel: (0, _languageHandler._t)('This room is not showing flair for any communities'),
      placeholder: (0, _languageHandler._t)('New community ID (e.g. +foo:%(localDomain)s)', {
        localDomain
      })
    }));
  }

}, (0, _defineProperty2.default)(_class2, "propTypes", {
  roomId: _propTypes.default.string.isRequired,
  canSetRelatedGroups: _propTypes.default.bool.isRequired,
  relatedGroupsEvent: _propTypes.default.instanceOf(_event.MatrixEvent)
}), (0, _defineProperty2.default)(_class2, "contextType", _MatrixClientContext.default), (0, _defineProperty2.default)(_class2, "defaultProps", {
  canSetRelatedGroups: false
}), _temp)) || _class);
exports.default = RelatedGroupSettings;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3Jvb21fc2V0dGluZ3MvUmVsYXRlZEdyb3VwU2V0dGluZ3MuanMiXSwibmFtZXMiOlsiR1JPVVBfSURfUkVHRVgiLCJSZWxhdGVkR3JvdXBTZXR0aW5ncyIsIlJlYWN0IiwiQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsIm5ld0dyb3VwSWQiLCJzZXRTdGF0ZSIsImdyb3VwSWQiLCJsZW5ndGgiLCJ2YWxpZGF0ZUdyb3VwSWQiLCJuZXdHcm91cHNMaXN0Iiwic3RhdGUiLCJ1cGRhdGVHcm91cHMiLCJpbmRleCIsImdyb3VwIiwiZmlsdGVyIiwiZyIsInJlbGF0ZWRHcm91cHNFdmVudCIsImdldENvbnRlbnQiLCJncm91cHMiLCJjb250ZXh0Iiwic2VuZFN0YXRlRXZlbnQiLCJyb29tSWQiLCJjYXRjaCIsImVyciIsImxvZ2dlciIsImVycm9yIiwiTW9kYWwiLCJjcmVhdGVUcmFja2VkRGlhbG9nIiwiRXJyb3JEaWFsb2ciLCJ0aXRsZSIsImRlc2NyaXB0aW9uIiwidGVzdCIsInNkayIsImdldENvbXBvbmVudCIsInJlbmRlciIsImxvY2FsRG9tYWluIiwiZ2V0RG9tYWluIiwiRWRpdGFibGVJdGVtTGlzdCIsImNhblNldFJlbGF0ZWRHcm91cHMiLCJvbk5ld0dyb3VwQ2hhbmdlZCIsIm9uR3JvdXBBZGRlZCIsIm9uR3JvdXBEZWxldGVkIiwiUHJvcFR5cGVzIiwic3RyaW5nIiwiaXNSZXF1aXJlZCIsImJvb2wiLCJpbnN0YW5jZU9mIiwiTWF0cml4RXZlbnQiLCJNYXRyaXhDbGllbnRDb250ZXh0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWdCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7Ozs7Ozs7QUFFQSxNQUFNQSxjQUFjLEdBQUcsV0FBdkI7SUFHcUJDLG9CLFdBRHBCLGdEQUFxQiwwQ0FBckIsQyxtQ0FBRCxNQUNx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SixDQUFpQiwyQkFBakIsQ0FBekI7QUFDQSx3QkFBTyx1REFDSCw2QkFBQyxnQkFBRDtBQUNJLE1BQUEsRUFBRSxFQUFDLGVBRFA7QUFFSSxNQUFBLEtBQUssRUFBRSxLQUFLdkIsS0FBTCxDQUFXRCxhQUZ0QjtBQUdJLE1BQUEsU0FBUyxFQUFDLHlCQUhkO0FBSUksTUFBQSxPQUFPLEVBQUUsS0FBS0MsS0FBTCxDQUFXTixVQUp4QjtBQUtJLE1BQUEsU0FBUyxFQUFFLEtBQUtELEtBQUwsQ0FBV21DLG1CQUwxQjtBQU1JLE1BQUEsT0FBTyxFQUFFLEtBQUtuQyxLQUFMLENBQVdtQyxtQkFOeEI7QUFPSSxNQUFBLGdCQUFnQixFQUFFLEtBQUtDLGlCQVAzQjtBQVFJLE1BQUEsV0FBVyxFQUFFLEtBQUtDLFlBUnRCO0FBU0ksTUFBQSxhQUFhLEVBQUUsS0FBS0MsY0FUeEI7QUFVSSxNQUFBLFVBQVUsRUFBRSx5QkFBRyxzQ0FBSCxDQVZoQjtBQVdJLE1BQUEsWUFBWSxFQUFFLHlCQUFHLG9EQUFILENBWGxCO0FBWUksTUFBQSxXQUFXLEVBQUUseUJBQ1QsOENBRFMsRUFDdUM7QUFBRU4sUUFBQUE7QUFBRixPQUR2QztBQVpqQixNQURHLENBQVA7QUFrQkg7O0FBN0Y2RCxDLHNEQUMzQztBQUNmZCxFQUFBQSxNQUFNLEVBQUVxQixtQkFBVUMsTUFBVixDQUFpQkMsVUFEVjtBQUVmTixFQUFBQSxtQkFBbUIsRUFBRUksbUJBQVVHLElBQVYsQ0FBZUQsVUFGckI7QUFHZjVCLEVBQUFBLGtCQUFrQixFQUFFMEIsbUJBQVVJLFVBQVYsQ0FBcUJDLGtCQUFyQjtBQUhMLEMseURBTUVDLDRCLDBEQUVDO0FBQ2xCVixFQUFBQSxtQkFBbUIsRUFBRTtBQURILEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTcsIDIwMTkgTmV3IFZlY3RvciBMdGQuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcyc7XG5pbXBvcnQgeyBNYXRyaXhFdmVudCB9IGZyb20gJ21hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9ldmVudCc7XG5pbXBvcnQgKiBhcyBzZGsgZnJvbSAnLi4vLi4vLi4vaW5kZXgnO1xuaW1wb3J0IHsgX3QgfSBmcm9tICcuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXInO1xuaW1wb3J0IE1vZGFsIGZyb20gJy4uLy4uLy4uL01vZGFsJztcbmltcG9ydCBFcnJvckRpYWxvZyBmcm9tIFwiLi4vZGlhbG9ncy9FcnJvckRpYWxvZ1wiO1xuaW1wb3J0IE1hdHJpeENsaWVudENvbnRleHQgZnJvbSBcIi4uLy4uLy4uL2NvbnRleHRzL01hdHJpeENsaWVudENvbnRleHRcIjtcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcblxuY29uc3QgR1JPVVBfSURfUkVHRVggPSAvXFwrXFxTKzpcXFMrLztcblxuQHJlcGxhY2VhYmxlQ29tcG9uZW50KFwidmlld3Mucm9vbV9zZXR0aW5ncy5SZWxhdGVkR3JvdXBTZXR0aW5nc1wiKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUmVsYXRlZEdyb3VwU2V0dGluZ3MgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQge1xuICAgIHN0YXRpYyBwcm9wVHlwZXMgPSB7XG4gICAgICAgIHJvb21JZDogUHJvcFR5cGVzLnN0cmluZy5pc1JlcXVpcmVkLFxuICAgICAgICBjYW5TZXRSZWxhdGVkR3JvdXBzOiBQcm9wVHlwZXMuYm9vbC5pc1JlcXVpcmVkLFxuICAgICAgICByZWxhdGVkR3JvdXBzRXZlbnQ6IFByb3BUeXBlcy5pbnN0YW5jZU9mKE1hdHJpeEV2ZW50KSxcbiAgICB9O1xuXG4gICAgc3RhdGljIGNvbnRleHRUeXBlID0gTWF0cml4Q2xpZW50Q29udGV4dDtcblxuICAgIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgICAgIGNhblNldFJlbGF0ZWRHcm91cHM6IGZhbHNlLFxuICAgIH07XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG5cbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIG5ld0dyb3VwSWQ6IFwiXCIsXG4gICAgICAgICAgICBuZXdHcm91cHNMaXN0OiBwcm9wcy5yZWxhdGVkR3JvdXBzRXZlbnQgPyAocHJvcHMucmVsYXRlZEdyb3Vwc0V2ZW50LmdldENvbnRlbnQoKS5ncm91cHMgfHwgW10pIDogW10sXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgdXBkYXRlR3JvdXBzKG5ld0dyb3Vwc0xpc3QpIHtcbiAgICAgICAgdGhpcy5jb250ZXh0LnNlbmRTdGF0ZUV2ZW50KHRoaXMucHJvcHMucm9vbUlkLCAnbS5yb29tLnJlbGF0ZWRfZ3JvdXBzJywge1xuICAgICAgICAgICAgZ3JvdXBzOiBuZXdHcm91cHNMaXN0LFxuICAgICAgICB9LCAnJykuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGVycik7XG4gICAgICAgICAgICBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nKCdFcnJvciB1cGRhdGluZyBmbGFpcicsICcnLCBFcnJvckRpYWxvZywge1xuICAgICAgICAgICAgICAgIHRpdGxlOiBfdChcIkVycm9yIHVwZGF0aW5nIGZsYWlyXCIpLFxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBfdChcbiAgICAgICAgICAgICAgICAgICAgXCJUaGVyZSB3YXMgYW4gZXJyb3IgdXBkYXRpbmcgdGhlIGZsYWlyIGZvciB0aGlzIHJvb20uIFRoZSBzZXJ2ZXIgbWF5IG5vdCBhbGxvdyBpdCBvciBcIiArXG4gICAgICAgICAgICAgICAgICAgIFwiYSB0ZW1wb3JhcnkgZXJyb3Igb2NjdXJyZWQuXCIsXG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICB2YWxpZGF0ZUdyb3VwSWQoZ3JvdXBJZCkge1xuICAgICAgICBpZiAoIUdST1VQX0lEX1JFR0VYLnRlc3QoZ3JvdXBJZCkpIHtcbiAgICAgICAgICAgIGNvbnN0IEVycm9yRGlhbG9nID0gc2RrLmdldENvbXBvbmVudChcImRpYWxvZ3MuRXJyb3JEaWFsb2dcIik7XG4gICAgICAgICAgICBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nKCdJbnZhbGlkIHJlbGF0ZWQgY29tbXVuaXR5IElEJywgJycsIEVycm9yRGlhbG9nLCB7XG4gICAgICAgICAgICAgICAgdGl0bGU6IF90KCdJbnZhbGlkIGNvbW11bml0eSBJRCcpLFxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBfdCgnXFwnJShncm91cElkKXNcXCcgaXMgbm90IGEgdmFsaWQgY29tbXVuaXR5IElEJywgeyBncm91cElkIH0pLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgb25OZXdHcm91cENoYW5nZWQgPSAobmV3R3JvdXBJZCkgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgbmV3R3JvdXBJZCB9KTtcbiAgICB9O1xuXG4gICAgb25Hcm91cEFkZGVkID0gKGdyb3VwSWQpID0+IHtcbiAgICAgICAgaWYgKGdyb3VwSWQubGVuZ3RoID09PSAwIHx8ICF0aGlzLnZhbGlkYXRlR3JvdXBJZChncm91cElkKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IG5ld0dyb3Vwc0xpc3QgPSBbLi4udGhpcy5zdGF0ZS5uZXdHcm91cHNMaXN0LCBncm91cElkXTtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBuZXdHcm91cHNMaXN0OiBuZXdHcm91cHNMaXN0LFxuICAgICAgICAgICAgbmV3R3JvdXBJZDogJycsXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnVwZGF0ZUdyb3VwcyhuZXdHcm91cHNMaXN0KTtcbiAgICB9O1xuXG4gICAgb25Hcm91cERlbGV0ZWQgPSAoaW5kZXgpID0+IHtcbiAgICAgICAgY29uc3QgZ3JvdXAgPSB0aGlzLnN0YXRlLm5ld0dyb3Vwc0xpc3RbaW5kZXhdO1xuICAgICAgICBjb25zdCBuZXdHcm91cHNMaXN0ID0gdGhpcy5zdGF0ZS5uZXdHcm91cHNMaXN0LmZpbHRlcigoZykgPT4gZyAhPT0gZ3JvdXApO1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgbmV3R3JvdXBzTGlzdCB9KTtcbiAgICAgICAgdGhpcy51cGRhdGVHcm91cHMobmV3R3JvdXBzTGlzdCk7XG4gICAgfTtcblxuICAgIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3QgbG9jYWxEb21haW4gPSB0aGlzLmNvbnRleHQuZ2V0RG9tYWluKCk7XG4gICAgICAgIGNvbnN0IEVkaXRhYmxlSXRlbUxpc3QgPSBzZGsuZ2V0Q29tcG9uZW50KCdlbGVtZW50cy5FZGl0YWJsZUl0ZW1MaXN0Jyk7XG4gICAgICAgIHJldHVybiA8ZGl2PlxuICAgICAgICAgICAgPEVkaXRhYmxlSXRlbUxpc3RcbiAgICAgICAgICAgICAgICBpZD1cInJlbGF0ZWRHcm91cHNcIlxuICAgICAgICAgICAgICAgIGl0ZW1zPXt0aGlzLnN0YXRlLm5ld0dyb3Vwc0xpc3R9XG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfUmVsYXRlZEdyb3VwU2V0dGluZ3NcIlxuICAgICAgICAgICAgICAgIG5ld0l0ZW09e3RoaXMuc3RhdGUubmV3R3JvdXBJZH1cbiAgICAgICAgICAgICAgICBjYW5SZW1vdmU9e3RoaXMucHJvcHMuY2FuU2V0UmVsYXRlZEdyb3Vwc31cbiAgICAgICAgICAgICAgICBjYW5FZGl0PXt0aGlzLnByb3BzLmNhblNldFJlbGF0ZWRHcm91cHN9XG4gICAgICAgICAgICAgICAgb25OZXdJdGVtQ2hhbmdlZD17dGhpcy5vbk5ld0dyb3VwQ2hhbmdlZH1cbiAgICAgICAgICAgICAgICBvbkl0ZW1BZGRlZD17dGhpcy5vbkdyb3VwQWRkZWR9XG4gICAgICAgICAgICAgICAgb25JdGVtUmVtb3ZlZD17dGhpcy5vbkdyb3VwRGVsZXRlZH1cbiAgICAgICAgICAgICAgICBpdGVtc0xhYmVsPXtfdCgnU2hvd2luZyBmbGFpciBmb3IgdGhlc2UgY29tbXVuaXRpZXM6Jyl9XG4gICAgICAgICAgICAgICAgbm9JdGVtc0xhYmVsPXtfdCgnVGhpcyByb29tIGlzIG5vdCBzaG93aW5nIGZsYWlyIGZvciBhbnkgY29tbXVuaXRpZXMnKX1cbiAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcj17X3QoXG4gICAgICAgICAgICAgICAgICAgICdOZXcgY29tbXVuaXR5IElEIChlLmcuICtmb286JShsb2NhbERvbWFpbilzKScsIHsgbG9jYWxEb21haW4gfSxcbiAgICAgICAgICAgICAgICApfVxuICAgICAgICAgICAgLz5cbiAgICAgICAgPC9kaXY+O1xuICAgIH1cbn1cbiJdfQ==