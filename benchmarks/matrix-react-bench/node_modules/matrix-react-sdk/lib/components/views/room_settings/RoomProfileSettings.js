"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var _languageHandler = require("../../../languageHandler");

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _Field = _interopRequireDefault(require("../elements/Field"));

var _replaceableComponent = require("../../../utils/replaceableComponent");

var _Media = require("../../../customisations/Media");

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _AvatarSetting = _interopRequireDefault(require("../settings/AvatarSetting"));

var _dec, _class;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

let RoomProfileSettings = ( // TODO: Merge with ProfileSettings?
_dec = (0, _replaceableComponent.replaceableComponent)("views.room_settings.RoomProfileSettings"), _dec(_class = class RoomProfileSettings extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "avatarUpload", /*#__PURE__*/(0, _react.createRef)());
    (0, _defineProperty2.default)(this, "uploadAvatar", () => {
      this.avatarUpload.current.click();
    });
    (0, _defineProperty2.default)(this, "removeAvatar", () => {
      // clear file upload field so same file can be selected
      this.avatarUpload.current.value = "";
      this.setState({
        avatarUrl: null,
        avatarFile: null,
        profileFieldsTouched: _objectSpread(_objectSpread({}, this.state.profileFieldsTouched), {}, {
          avatar: true
        })
      });
    });
    (0, _defineProperty2.default)(this, "isSaveEnabled", () => {
      return Boolean(Object.values(this.state.profileFieldsTouched).length);
    });
    (0, _defineProperty2.default)(this, "cancelProfileChanges", async e => {
      e.stopPropagation();
      e.preventDefault();
      if (!this.isSaveEnabled()) return;
      this.setState({
        profileFieldsTouched: {},
        displayName: this.state.originalDisplayName,
        topic: this.state.originalTopic,
        avatarUrl: this.state.originalAvatarUrl,
        avatarFile: null
      });
    });
    (0, _defineProperty2.default)(this, "saveProfile", async e => {
      e.stopPropagation();
      e.preventDefault();
      if (!this.isSaveEnabled()) return;
      this.setState({
        profileFieldsTouched: {}
      });

      const client = _MatrixClientPeg.MatrixClientPeg.get();

      const newState = {}; // TODO: What do we do about errors?

      const displayName = this.state.displayName.trim();

      if (this.state.originalDisplayName !== this.state.displayName) {
        await client.setRoomName(this.props.roomId, displayName);
        newState.originalDisplayName = displayName;
        newState.displayName = displayName;
      }

      if (this.state.avatarFile) {
        const uri = await client.uploadContent(this.state.avatarFile);
        await client.sendStateEvent(this.props.roomId, 'm.room.avatar', {
          url: uri
        }, '');
        newState.avatarUrl = (0, _Media.mediaFromMxc)(uri).getSquareThumbnailHttp(96);
        newState.originalAvatarUrl = newState.avatarUrl;
        newState.avatarFile = null;
      } else if (this.state.originalAvatarUrl !== this.state.avatarUrl) {
        await client.sendStateEvent(this.props.roomId, 'm.room.avatar', {}, '');
      }

      if (this.state.originalTopic !== this.state.topic) {
        await client.setRoomTopic(this.props.roomId, this.state.topic);
        newState.originalTopic = this.state.topic;
      }

      this.setState(newState);
    });
    (0, _defineProperty2.default)(this, "onDisplayNameChanged", e => {
      this.setState({
        displayName: e.target.value
      });

      if (this.state.originalDisplayName === e.target.value) {
        this.setState({
          profileFieldsTouched: _objectSpread(_objectSpread({}, this.state.profileFieldsTouched), {}, {
            name: false
          })
        });
      } else {
        this.setState({
          profileFieldsTouched: _objectSpread(_objectSpread({}, this.state.profileFieldsTouched), {}, {
            name: true
          })
        });
      }
    });
    (0, _defineProperty2.default)(this, "onTopicChanged", e => {
      this.setState({
        topic: e.target.value
      });

      if (this.state.originalTopic === e.target.value) {
        this.setState({
          profileFieldsTouched: _objectSpread(_objectSpread({}, this.state.profileFieldsTouched), {}, {
            topic: false
          })
        });
      } else {
        this.setState({
          profileFieldsTouched: _objectSpread(_objectSpread({}, this.state.profileFieldsTouched), {}, {
            topic: true
          })
        });
      }
    });
    (0, _defineProperty2.default)(this, "onAvatarChanged", e => {
      if (!e.target.files || !e.target.files.length) {
        this.setState({
          avatarUrl: this.state.originalAvatarUrl,
          avatarFile: null,
          profileFieldsTouched: _objectSpread(_objectSpread({}, this.state.profileFieldsTouched), {}, {
            avatar: false
          })
        });
        return;
      }

      const file = e.target.files[0];
      const reader = new FileReader();

      reader.onload = ev => {
        this.setState({
          avatarUrl: String(ev.target.result),
          avatarFile: file,
          profileFieldsTouched: _objectSpread(_objectSpread({}, this.state.profileFieldsTouched), {}, {
            avatar: true
          })
        });
      };

      reader.readAsDataURL(file);
    });

    const _client = _MatrixClientPeg.MatrixClientPeg.get();

    const room = _client.getRoom(props.roomId);

    if (!room) throw new Error(`Expected a room for ID: ${props.roomId}`);
    const avatarEvent = room.currentState.getStateEvents("m.room.avatar", "");
    let avatarUrl = avatarEvent && avatarEvent.getContent() ? avatarEvent.getContent()["url"] : null;
    if (avatarUrl) avatarUrl = (0, _Media.mediaFromMxc)(avatarUrl).getSquareThumbnailHttp(96);
    const topicEvent = room.currentState.getStateEvents("m.room.topic", "");
    const topic = topicEvent && topicEvent.getContent() ? topicEvent.getContent()['topic'] : '';
    const nameEvent = room.currentState.getStateEvents('m.room.name', '');
    const name = nameEvent && nameEvent.getContent() ? nameEvent.getContent()['name'] : '';
    this.state = {
      originalDisplayName: name,
      displayName: name,
      originalAvatarUrl: avatarUrl,
      avatarUrl: avatarUrl,
      avatarFile: null,
      originalTopic: topic,
      topic: topic,
      profileFieldsTouched: {},
      canSetName: room.currentState.maySendStateEvent('m.room.name', _client.getUserId()),
      canSetTopic: room.currentState.maySendStateEvent('m.room.topic', _client.getUserId()),
      canSetAvatar: room.currentState.maySendStateEvent('m.room.avatar', _client.getUserId())
    };
  }

  render() {
    let profileSettingsButtons;

    if (this.state.canSetName || this.state.canSetTopic || this.state.canSetAvatar) {
      profileSettingsButtons = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_ProfileSettings_buttons"
      }, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        onClick: this.cancelProfileChanges,
        kind: "link",
        disabled: !this.isSaveEnabled()
      }, (0, _languageHandler._t)("Cancel")), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        onClick: this.saveProfile,
        kind: "primary",
        disabled: !this.isSaveEnabled()
      }, (0, _languageHandler._t)("Save")));
    }

    return /*#__PURE__*/_react.default.createElement("form", {
      onSubmit: this.saveProfile,
      autoComplete: "off",
      noValidate: true,
      className: "mx_ProfileSettings_profileForm"
    }, /*#__PURE__*/_react.default.createElement("input", {
      type: "file",
      ref: this.avatarUpload,
      className: "mx_ProfileSettings_avatarUpload",
      onChange: this.onAvatarChanged,
      accept: "image/*"
    }), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_ProfileSettings_profile"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_ProfileSettings_controls"
    }, /*#__PURE__*/_react.default.createElement(_Field.default, {
      label: (0, _languageHandler._t)("Room Name"),
      type: "text",
      value: this.state.displayName,
      autoComplete: "off",
      onChange: this.onDisplayNameChanged,
      disabled: !this.state.canSetName
    }), /*#__PURE__*/_react.default.createElement(_Field.default, {
      className: "mx_ProfileSettings_controls_topic",
      id: "profileTopic",
      label: (0, _languageHandler._t)("Room Topic"),
      disabled: !this.state.canSetTopic,
      type: "text",
      value: this.state.topic,
      autoComplete: "off",
      onChange: this.onTopicChanged,
      element: "textarea"
    })), /*#__PURE__*/_react.default.createElement(_AvatarSetting.default, {
      avatarUrl: this.state.avatarUrl,
      avatarName: this.state.displayName || this.props.roomId,
      avatarAltText: (0, _languageHandler._t)("Room avatar"),
      uploadAvatar: this.state.canSetAvatar ? this.uploadAvatar : undefined,
      removeAvatar: this.state.canSetAvatar ? this.removeAvatar : undefined
    })), profileSettingsButtons);
  }

}) || _class);
exports.default = RoomProfileSettings;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3Jvb21fc2V0dGluZ3MvUm9vbVByb2ZpbGVTZXR0aW5ncy50c3giXSwibmFtZXMiOlsiUm9vbVByb2ZpbGVTZXR0aW5ncyIsIlJlYWN0IiwiQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsImF2YXRhclVwbG9hZCIsImN1cnJlbnQiLCJjbGljayIsInZhbHVlIiwic2V0U3RhdGUiLCJhdmF0YXJVcmwiLCJhdmF0YXJGaWxlIiwicHJvZmlsZUZpZWxkc1RvdWNoZWQiLCJzdGF0ZSIsImF2YXRhciIsIkJvb2xlYW4iLCJPYmplY3QiLCJ2YWx1ZXMiLCJsZW5ndGgiLCJlIiwic3RvcFByb3BhZ2F0aW9uIiwicHJldmVudERlZmF1bHQiLCJpc1NhdmVFbmFibGVkIiwiZGlzcGxheU5hbWUiLCJvcmlnaW5hbERpc3BsYXlOYW1lIiwidG9waWMiLCJvcmlnaW5hbFRvcGljIiwib3JpZ2luYWxBdmF0YXJVcmwiLCJjbGllbnQiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJuZXdTdGF0ZSIsInRyaW0iLCJzZXRSb29tTmFtZSIsInJvb21JZCIsInVyaSIsInVwbG9hZENvbnRlbnQiLCJzZW5kU3RhdGVFdmVudCIsInVybCIsImdldFNxdWFyZVRodW1ibmFpbEh0dHAiLCJzZXRSb29tVG9waWMiLCJ0YXJnZXQiLCJuYW1lIiwiZmlsZXMiLCJmaWxlIiwicmVhZGVyIiwiRmlsZVJlYWRlciIsIm9ubG9hZCIsImV2IiwiU3RyaW5nIiwicmVzdWx0IiwicmVhZEFzRGF0YVVSTCIsInJvb20iLCJnZXRSb29tIiwiRXJyb3IiLCJhdmF0YXJFdmVudCIsImN1cnJlbnRTdGF0ZSIsImdldFN0YXRlRXZlbnRzIiwiZ2V0Q29udGVudCIsInRvcGljRXZlbnQiLCJuYW1lRXZlbnQiLCJjYW5TZXROYW1lIiwibWF5U2VuZFN0YXRlRXZlbnQiLCJnZXRVc2VySWQiLCJjYW5TZXRUb3BpYyIsImNhblNldEF2YXRhciIsInJlbmRlciIsInByb2ZpbGVTZXR0aW5nc0J1dHRvbnMiLCJjYW5jZWxQcm9maWxlQ2hhbmdlcyIsInNhdmVQcm9maWxlIiwib25BdmF0YXJDaGFuZ2VkIiwib25EaXNwbGF5TmFtZUNoYW5nZWQiLCJvblRvcGljQ2hhbmdlZCIsInVwbG9hZEF2YXRhciIsInVuZGVmaW5lZCIsInJlbW92ZUF2YXRhciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFnQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7OztJQXNCcUJBLG1CLEtBRnJCO09BQ0MsZ0RBQXFCLHlDQUFyQixDLGdCQUFELE1BQ3FCQSxtQkFEckIsU0FDaURDLGVBQU1DLFNBRHZELENBQ2lGO0FBRzdFQyxFQUFBQSxXQUFXLENBQUNDLEtBQUQsRUFBZ0I7QUFDdkIsVUFBTUEsS0FBTjtBQUR1QixxRUFGSix1QkFFSTtBQUFBLHdEQWdDSixNQUFZO0FBQy9CLFdBQUtDLFlBQUwsQ0FBa0JDLE9BQWxCLENBQTBCQyxLQUExQjtBQUNILEtBbEMwQjtBQUFBLHdEQW9DSixNQUFZO0FBQy9CO0FBQ0EsV0FBS0YsWUFBTCxDQUFrQkMsT0FBbEIsQ0FBMEJFLEtBQTFCLEdBQWtDLEVBQWxDO0FBQ0EsV0FBS0MsUUFBTCxDQUFjO0FBQ1ZDLFFBQUFBLFNBQVMsRUFBRSxJQUREO0FBRVZDLFFBQUFBLFVBQVUsRUFBRSxJQUZGO0FBR1ZDLFFBQUFBLG9CQUFvQixrQ0FDYixLQUFLQyxLQUFMLENBQVdELG9CQURFO0FBRWhCRSxVQUFBQSxNQUFNLEVBQUU7QUFGUTtBQUhWLE9BQWQ7QUFRSCxLQS9DMEI7QUFBQSx5REFpREgsTUFBTTtBQUMxQixhQUFPQyxPQUFPLENBQUNDLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjLEtBQUtKLEtBQUwsQ0FBV0Qsb0JBQXpCLEVBQStDTSxNQUFoRCxDQUFkO0FBQ0gsS0FuRDBCO0FBQUEsZ0VBcURJLE1BQU9DLENBQVAsSUFBOEM7QUFDekVBLE1BQUFBLENBQUMsQ0FBQ0Ms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QUFILENBSG5CO0FBSUksTUFBQSxZQUFZLEVBQUUsS0FBS3JCLEtBQUwsQ0FBV29ELFlBQVgsR0FBMEIsS0FBS1EsWUFBL0IsR0FBOENDLFNBSmhFO0FBS0ksTUFBQSxZQUFZLEVBQUUsS0FBSzdELEtBQUwsQ0FBV29ELFlBQVgsR0FBMEIsS0FBS1UsWUFBL0IsR0FBOENEO0FBTGhFLE1BdEJKLENBYkosRUEwQ01QLHNCQTFDTixDQURKO0FBOENIOztBQXJQNEUsQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxOSBOZXcgVmVjdG9yIEx0ZFxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCwgeyBjcmVhdGVSZWYgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBfdCB9IGZyb20gXCIuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXJcIjtcbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gXCIuLi8uLi8uLi9NYXRyaXhDbGllbnRQZWdcIjtcbmltcG9ydCBGaWVsZCBmcm9tIFwiLi4vZWxlbWVudHMvRmllbGRcIjtcbmltcG9ydCB7IHJlcGxhY2VhYmxlQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50XCI7XG5pbXBvcnQgeyBtZWRpYUZyb21NeGMgfSBmcm9tIFwiLi4vLi4vLi4vY3VzdG9taXNhdGlvbnMvTWVkaWFcIjtcbmltcG9ydCBBY2Nlc3NpYmxlQnV0dG9uIGZyb20gXCIuLi9lbGVtZW50cy9BY2Nlc3NpYmxlQnV0dG9uXCI7XG5pbXBvcnQgQXZhdGFyU2V0dGluZyBmcm9tIFwiLi4vc2V0dGluZ3MvQXZhdGFyU2V0dGluZ1wiO1xuXG5pbnRlcmZhY2UgSVByb3BzIHtcbiAgICByb29tSWQ6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIElTdGF0ZSB7XG4gICAgb3JpZ2luYWxEaXNwbGF5TmFtZTogc3RyaW5nO1xuICAgIGRpc3BsYXlOYW1lOiBzdHJpbmc7XG4gICAgb3JpZ2luYWxBdmF0YXJVcmw6IHN0cmluZztcbiAgICBhdmF0YXJVcmw6IHN0cmluZztcbiAgICBhdmF0YXJGaWxlOiBGaWxlO1xuICAgIG9yaWdpbmFsVG9waWM6IHN0cmluZztcbiAgICB0b3BpYzogc3RyaW5nO1xuICAgIHByb2ZpbGVGaWVsZHNUb3VjaGVkOiBSZWNvcmQ8c3RyaW5nLCBib29sZWFuPjtcbiAgICBjYW5TZXROYW1lOiBib29sZWFuO1xuICAgIGNhblNldFRvcGljOiBib29sZWFuO1xuICAgIGNhblNldEF2YXRhcjogYm9vbGVhbjtcbn1cblxuLy8gVE9ETzogTWVyZ2Ugd2l0aCBQcm9maWxlU2V0dGluZ3M/XG5AcmVwbGFjZWFibGVDb21wb25lbnQoXCJ2aWV3cy5yb29tX3NldHRpbmdzLlJvb21Qcm9maWxlU2V0dGluZ3NcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJvb21Qcm9maWxlU2V0dGluZ3MgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8SVByb3BzLCBJU3RhdGU+IHtcbiAgICBwcml2YXRlIGF2YXRhclVwbG9hZCA9IGNyZWF0ZVJlZjxIVE1MSW5wdXRFbGVtZW50PigpO1xuXG4gICAgY29uc3RydWN0b3IocHJvcHM6IElQcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG5cbiAgICAgICAgY29uc3QgY2xpZW50ID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuICAgICAgICBjb25zdCByb29tID0gY2xpZW50LmdldFJvb20ocHJvcHMucm9vbUlkKTtcbiAgICAgICAgaWYgKCFyb29tKSB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIGEgcm9vbSBmb3IgSUQ6ICR7cHJvcHMucm9vbUlkfWApO1xuXG4gICAgICAgIGNvbnN0IGF2YXRhckV2ZW50ID0gcm9vbS5jdXJyZW50U3RhdGUuZ2V0U3RhdGVFdmVudHMoXCJtLnJvb20uYXZhdGFyXCIsIFwiXCIpO1xuICAgICAgICBsZXQgYXZhdGFyVXJsID0gYXZhdGFyRXZlbnQgJiYgYXZhdGFyRXZlbnQuZ2V0Q29udGVudCgpID8gYXZhdGFyRXZlbnQuZ2V0Q29udGVudCgpW1widXJsXCJdIDogbnVsbDtcbiAgICAgICAgaWYgKGF2YXRhclVybCkgYXZhdGFyVXJsID0gbWVkaWFGcm9tTXhjKGF2YXRhclVybCkuZ2V0U3F1YXJlVGh1bWJuYWlsSHR0cCg5Nik7XG5cbiAgICAgICAgY29uc3QgdG9waWNFdmVudCA9IHJvb20uY3VycmVudFN0YXRlLmdldFN0YXRlRXZlbnRzKFwibS5yb29tLnRvcGljXCIsIFwiXCIpO1xuICAgICAgICBjb25zdCB0b3BpYyA9IHRvcGljRXZlbnQgJiYgdG9waWNFdmVudC5nZXRDb250ZW50KCkgPyB0b3BpY0V2ZW50LmdldENvbnRlbnQoKVsndG9waWMnXSA6ICcnO1xuXG4gICAgICAgIGNvbnN0IG5hbWVFdmVudCA9IHJvb20uY3VycmVudFN0YXRlLmdldFN0YXRlRXZlbnRzKCdtLnJvb20ubmFtZScsICcnKTtcbiAgICAgICAgY29uc3QgbmFtZSA9IG5hbWVFdmVudCAmJiBuYW1lRXZlbnQuZ2V0Q29udGVudCgpID8gbmFtZUV2ZW50LmdldENvbnRlbnQoKVsnbmFtZSddIDogJyc7XG5cbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIG9yaWdpbmFsRGlzcGxheU5hbWU6IG5hbWUsXG4gICAgICAgICAgICBkaXNwbGF5TmFtZTogbmFtZSxcbiAgICAgICAgICAgIG9yaWdpbmFsQXZhdGFyVXJsOiBhdmF0YXJVcmwsXG4gICAgICAgICAgICBhdmF0YXJVcmw6IGF2YXRhclVybCxcbiAgICAgICAgICAgIGF2YXRhckZpbGU6IG51bGwsXG4gICAgICAgICAgICBvcmlnaW5hbFRvcGljOiB0b3BpYyxcbiAgICAgICAgICAgIHRvcGljOiB0b3BpYyxcbiAgICAgICAgICAgIHByb2ZpbGVGaWVsZHNUb3VjaGVkOiB7fSxcbiAgICAgICAgICAgIGNhblNldE5hbWU6IHJvb20uY3VycmVudFN0YXRlLm1heVNlbmRTdGF0ZUV2ZW50KCdtLnJvb20ubmFtZScsIGNsaWVudC5nZXRVc2VySWQoKSksXG4gICAgICAgICAgICBjYW5TZXRUb3BpYzogcm9vbS5jdXJyZW50U3RhdGUubWF5U2VuZFN0YXRlRXZlbnQoJ20ucm9vbS50b3BpYycsIGNsaWVudC5nZXRVc2VySWQoKSksXG4gICAgICAgICAgICBjYW5TZXRBdmF0YXI6IHJvb20uY3VycmVudFN0YXRlLm1heVNlbmRTdGF0ZUV2ZW50KCdtLnJvb20uYXZhdGFyJywgY2xpZW50LmdldFVzZXJJZCgpKSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHVwbG9hZEF2YXRhciA9ICgpOiB2b2lkID0+IHtcbiAgICAgICAgdGhpcy5hdmF0YXJVcGxvYWQuY3VycmVudC5jbGljaygpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIHJlbW92ZUF2YXRhciA9ICgpOiB2b2lkID0+IHtcbiAgICAgICAgLy8gY2xlYXIgZmlsZSB1cGxvYWQgZmllbGQgc28gc2FtZSBmaWxlIGNhbiBiZSBzZWxlY3RlZFxuICAgICAgICB0aGlzLmF2YXRhclVwbG9hZC5jdXJyZW50LnZhbHVlID0gXCJcIjtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBhdmF0YXJVcmw6IG51bGwsXG4gICAgICAgICAgICBhdmF0YXJGaWxlOiBudWxsLFxuICAgICAgICAgICAgcHJvZmlsZUZpZWxkc1RvdWNoZWQ6IHtcbiAgICAgICAgICAgICAgICAuLi50aGlzLnN0YXRlLnByb2ZpbGVGaWVsZHNUb3VjaGVkLFxuICAgICAgICAgICAgICAgIGF2YXRhcjogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIGlzU2F2ZUVuYWJsZWQgPSAoKSA9PiB7XG4gICAgICAgIHJldHVybiBCb29sZWFuKE9iamVjdC52YWx1ZXModGhpcy5zdGF0ZS5wcm9maWxlRmllbGRzVG91Y2hlZCkubGVuZ3RoKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBjYW5jZWxQcm9maWxlQ2hhbmdlcyA9IGFzeW5jIChlOiBSZWFjdC5Nb3VzZUV2ZW50KTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgICBpZiAoIXRoaXMuaXNTYXZlRW5hYmxlZCgpKSByZXR1cm47XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgcHJvZmlsZUZpZWxkc1RvdWNoZWQ6IHt9LFxuICAgICAgICAgICAgZGlzcGxheU5hbWU6IHRoaXMuc3RhdGUub3JpZ2luYWxEaXNwbGF5TmFtZSxcbiAgICAgICAgICAgIHRvcGljOiB0aGlzLnN0YXRlLm9yaWdpbmFsVG9waWMsXG4gICAgICAgICAgICBhdmF0YXJVcmw6IHRoaXMuc3RhdGUub3JpZ2luYWxBdmF0YXJVcmwsXG4gICAgICAgICAgICBhdmF0YXJGaWxlOiBudWxsLFxuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBzYXZlUHJvZmlsZSA9IGFzeW5jIChlOiBSZWFjdC5Gb3JtRXZlbnQpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAgIGlmICghdGhpcy5pc1NhdmVFbmFibGVkKCkpIHJldHVybjtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IHByb2ZpbGVGaWVsZHNUb3VjaGVkOiB7fSB9KTtcblxuICAgICAgICBjb25zdCBjbGllbnQgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIGNvbnN0IG5ld1N0YXRlOiBQYXJ0aWFsPElTdGF0ZT4gPSB7fTtcblxuICAgICAgICAvLyBUT0RPOiBXaGF0IGRvIHdlIGRvIGFib3V0IGVycm9ycz9cbiAgICAgICAgY29uc3QgZGlzcGxheU5hbWUgPSB0aGlzLnN0YXRlLmRpc3BsYXlOYW1lLnRyaW0oKTtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUub3JpZ2luYWxEaXNwbGF5TmFtZSAhPT0gdGhpcy5zdGF0ZS5kaXNwbGF5TmFtZSkge1xuICAgICAgICAgICAgYXdhaXQgY2xpZW50LnNldFJvb21OYW1lKHRoaXMucHJvcHMucm9vbUlkLCBkaXNwbGF5TmFtZSk7XG4gICAgICAgICAgICBuZXdTdGF0ZS5vcmlnaW5hbERpc3BsYXlOYW1lID0gZGlzcGxheU5hbWU7XG4gICAgICAgICAgICBuZXdTdGF0ZS5kaXNwbGF5TmFtZSA9IGRpc3BsYXlOYW1lO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuYXZhdGFyRmlsZSkge1xuICAgICAgICAgICAgY29uc3QgdXJpID0gYXdhaXQgY2xpZW50LnVwbG9hZENvbnRlbnQodGhpcy5zdGF0ZS5hdmF0YXJGaWxlKTtcbiAgICAgICAgICAgIGF3YWl0IGNsaWVudC5zZW5kU3RhdGVFdmVudCh0aGlzLnByb3BzLnJvb21JZCwgJ20ucm9vbS5hdmF0YXInLCB7IHVybDogdXJpIH0sICcnKTtcbiAgICAgICAgICAgIG5ld1N0YXRlLmF2YXRhclVybCA9IG1lZGlhRnJvbU14Yyh1cmkpLmdldFNxdWFyZVRodW1ibmFpbEh0dHAoOTYpO1xuICAgICAgICAgICAgbmV3U3RhdGUub3JpZ2luYWxBdmF0YXJVcmwgPSBuZXdTdGF0ZS5hdmF0YXJVcmw7XG4gICAgICAgICAgICBuZXdTdGF0ZS5hdmF0YXJGaWxlID0gbnVsbDtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLnN0YXRlLm9yaWdpbmFsQXZhdGFyVXJsICE9PSB0aGlzLnN0YXRlLmF2YXRhclVybCkge1xuICAgICAgICAgICAgYXdhaXQgY2xpZW50LnNlbmRTdGF0ZUV2ZW50KHRoaXMucHJvcHMucm9vbUlkLCAnbS5yb29tLmF2YXRhcicsIHt9LCAnJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5zdGF0ZS5vcmlnaW5hbFRvcGljICE9PSB0aGlzLnN0YXRlLnRvcGljKSB7XG4gICAgICAgICAgICBhd2FpdCBjbGllbnQuc2V0Um9vbVRvcGljKHRoaXMucHJvcHMucm9vbUlkLCB0aGlzLnN0YXRlLnRvcGljKTtcbiAgICAgICAgICAgIG5ld1N0YXRlLm9yaWdpbmFsVG9waWMgPSB0aGlzLnN0YXRlLnRvcGljO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zZXRTdGF0ZShuZXdTdGF0ZSBhcyBJU3RhdGUpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uRGlzcGxheU5hbWVDaGFuZ2VkID0gKGU6IFJlYWN0LkNoYW5nZUV2ZW50PEhUTUxJbnB1dEVsZW1lbnQ+KTogdm9pZCA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBkaXNwbGF5TmFtZTogZS50YXJnZXQudmFsdWUgfSk7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLm9yaWdpbmFsRGlzcGxheU5hbWUgPT09IGUudGFyZ2V0LnZhbHVlKSB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICBwcm9maWxlRmllbGRzVG91Y2hlZDoge1xuICAgICAgICAgICAgICAgICAgICAuLi50aGlzLnN0YXRlLnByb2ZpbGVGaWVsZHNUb3VjaGVkLFxuICAgICAgICAgICAgICAgICAgICBuYW1lOiBmYWxzZSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICBwcm9maWxlRmllbGRzVG91Y2hlZDoge1xuICAgICAgICAgICAgICAgICAgICAuLi50aGlzLnN0YXRlLnByb2ZpbGVGaWVsZHNUb3VjaGVkLFxuICAgICAgICAgICAgICAgICAgICBuYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwcml2YXRlIG9uVG9waWNDaGFuZ2VkID0gKGU6IFJlYWN0LkNoYW5nZUV2ZW50PEhUTUxUZXh0QXJlYUVsZW1lbnQ+KTogdm9pZCA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyB0b3BpYzogZS50YXJnZXQudmFsdWUgfSk7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLm9yaWdpbmFsVG9waWMgPT09IGUudGFyZ2V0LnZhbHVlKSB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICBwcm9maWxlRmllbGRzVG91Y2hlZDoge1xuICAgICAgICAgICAgICAgICAgICAuLi50aGlzLnN0YXRlLnByb2ZpbGVGaWVsZHNUb3VjaGVkLFxuICAgICAgICAgICAgICAgICAgICB0b3BpYzogZmFsc2UsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgcHJvZmlsZUZpZWxkc1RvdWNoZWQ6IHtcbiAgICAgICAgICAgICAgICAgICAgLi4udGhpcy5zdGF0ZS5wcm9maWxlRmllbGRzVG91Y2hlZCxcbiAgICAgICAgICAgICAgICAgICAgdG9waWM6IHRydWUsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25BdmF0YXJDaGFuZ2VkID0gKGU6IFJlYWN0LkNoYW5nZUV2ZW50PEhUTUxJbnB1dEVsZW1lbnQ+KTogdm9pZCA9PiB7XG4gICAgICAgIGlmICghZS50YXJnZXQuZmlsZXMgfHwgIWUudGFyZ2V0LmZpbGVzLmxlbmd0aCkge1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgYXZhdGFyVXJsOiB0aGlzLnN0YXRlLm9yaWdpbmFsQXZhdGFyVXJsLFxuICAgICAgICAgICAgICAgIGF2YXRhckZpbGU6IG51bGwsXG4gICAgICAgICAgICAgICAgcHJvZmlsZUZpZWxkc1RvdWNoZWQ6IHtcbiAgICAgICAgICAgICAgICAgICAgLi4udGhpcy5zdGF0ZS5wcm9maWxlRmllbGRzVG91Y2hlZCxcbiAgICAgICAgICAgICAgICAgICAgYXZhdGFyOiBmYWxzZSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBmaWxlID0gZS50YXJnZXQuZmlsZXNbMF07XG4gICAgICAgIGNvbnN0IHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XG4gICAgICAgIHJlYWRlci5vbmxvYWQgPSAoZXYpID0+IHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgIGF2YXRhclVybDogU3RyaW5nKGV2LnRhcmdldC5yZXN1bHQpLFxuICAgICAgICAgICAgICAgIGF2YXRhckZpbGU6IGZpbGUsXG4gICAgICAgICAgICAgICAgcHJvZmlsZUZpZWxkc1RvdWNoZWQ6IHtcbiAgICAgICAgICAgICAgICAgICAgLi4udGhpcy5zdGF0ZS5wcm9maWxlRmllbGRzVG91Y2hlZCxcbiAgICAgICAgICAgICAgICAgICAgYXZhdGFyOiB0cnVlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcbiAgICAgICAgcmVhZGVyLnJlYWRBc0RhdGFVUkwoZmlsZSk7XG4gICAgfTtcblxuICAgIHB1YmxpYyByZW5kZXIoKTogSlNYLkVsZW1lbnQge1xuICAgICAgICBsZXQgcHJvZmlsZVNldHRpbmdzQnV0dG9ucztcbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgdGhpcy5zdGF0ZS5jYW5TZXROYW1lIHx8XG4gICAgICAgICAgICB0aGlzLnN0YXRlLmNhblNldFRvcGljIHx8XG4gICAgICAgICAgICB0aGlzLnN0YXRlLmNhblNldEF2YXRhclxuICAgICAgICApIHtcbiAgICAgICAgICAgIHByb2ZpbGVTZXR0aW5nc0J1dHRvbnMgPSAoXG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9Qcm9maWxlU2V0dGluZ3NfYnV0dG9uc1wiPlxuICAgICAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvblxuICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5jYW5jZWxQcm9maWxlQ2hhbmdlc31cbiAgICAgICAgICAgICAgICAgICAgICAgIGtpbmQ9XCJsaW5rXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVkPXshdGhpcy5pc1NhdmVFbmFibGVkKCl9XG4gICAgICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCJDYW5jZWxcIikgfVxuICAgICAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uXG4gICAgICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLnNhdmVQcm9maWxlfVxuICAgICAgICAgICAgICAgICAgICAgICAga2luZD1cInByaW1hcnlcIlxuICAgICAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWQ9eyF0aGlzLmlzU2F2ZUVuYWJsZWQoKX1cbiAgICAgICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIlNhdmVcIikgfVxuICAgICAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxmb3JtXG4gICAgICAgICAgICAgICAgb25TdWJtaXQ9e3RoaXMuc2F2ZVByb2ZpbGV9XG4gICAgICAgICAgICAgICAgYXV0b0NvbXBsZXRlPVwib2ZmXCJcbiAgICAgICAgICAgICAgICBub1ZhbGlkYXRlPXt0cnVlfVxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X1Byb2ZpbGVTZXR0aW5nc19wcm9maWxlRm9ybVwiXG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgPGlucHV0XG4gICAgICAgICAgICAgICAgICAgIHR5cGU9XCJmaWxlXCJcbiAgICAgICAgICAgICAgICAgICAgcmVmPXt0aGlzLmF2YXRhclVwbG9hZH1cbiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfUHJvZmlsZVNldHRpbmdzX2F2YXRhclVwbG9hZFwiXG4gICAgICAgICAgICAgICAgICAgIG9uQ2hhbmdlPXt0aGlzLm9uQXZhdGFyQ2hhbmdlZH1cbiAgICAgICAgICAgICAgICAgICAgYWNjZXB0PVwiaW1hZ2UvKlwiXG4gICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X1Byb2ZpbGVTZXR0aW5nc19wcm9maWxlXCI+XG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfUHJvZmlsZVNldHRpbmdzX2NvbnRyb2xzXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICA8RmllbGRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbD17X3QoXCJSb29tIE5hbWVcIil9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZT1cInRleHRcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlPXt0aGlzLnN0YXRlLmRpc3BsYXlOYW1lfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1dG9Db21wbGV0ZT1cIm9mZlwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2U9e3RoaXMub25EaXNwbGF5TmFtZUNoYW5nZWR9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWQ9eyF0aGlzLnN0YXRlLmNhblNldE5hbWV9XG4gICAgICAgICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgICAgICAgICAgPEZpZWxkXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfUHJvZmlsZVNldHRpbmdzX2NvbnRyb2xzX3RvcGljXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZD1cInByb2ZpbGVUb3BpY1wiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw9e190KFwiUm9vbSBUb3BpY1wiKX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZD17IXRoaXMuc3RhdGUuY2FuU2V0VG9waWN9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZT1cInRleHRcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlPXt0aGlzLnN0YXRlLnRvcGljfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1dG9Db21wbGV0ZT1cIm9mZlwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2U9e3RoaXMub25Ub3BpY0NoYW5nZWR9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudD1cInRleHRhcmVhXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICA8QXZhdGFyU2V0dGluZ1xuICAgICAgICAgICAgICAgICAgICAgICAgYXZhdGFyVXJsPXt0aGlzLnN0YXRlLmF2YXRhclVybH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGF2YXRhck5hbWU9e3RoaXMuc3RhdGUuZGlzcGxheU5hbWUgfHwgdGhpcy5wcm9wcy5yb29tSWR9XG4gICAgICAgICAgICAgICAgICAgICAgICBhdmF0YXJBbHRUZXh0PXtfdChcIlJvb20gYXZhdGFyXCIpfVxuICAgICAgICAgICAgICAgICAgICAgICAgdXBsb2FkQXZhdGFyPXt0aGlzLnN0YXRlLmNhblNldEF2YXRhciA/IHRoaXMudXBsb2FkQXZhdGFyIDogdW5kZWZpbmVkfVxuICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlQXZhdGFyPXt0aGlzLnN0YXRlLmNhblNldEF2YXRhciA/IHRoaXMucmVtb3ZlQXZhdGFyIDogdW5kZWZpbmVkfSAvPlxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgIHsgcHJvZmlsZVNldHRpbmdzQnV0dG9ucyB9XG4gICAgICAgICAgICA8L2Zvcm0+XG4gICAgICAgICk7XG4gICAgfVxufVxuIl19