"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getIncomingCallToastKey = exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _call = require("matrix-js-sdk/src/webrtc/call");

var _classnames = _interopRequireDefault(require("classnames"));

var _replaceableComponent = require("../utils/replaceableComponent");

var _CallHandler = _interopRequireWildcard(require("../CallHandler"));

var _dispatcher = _interopRequireDefault(require("../dispatcher/dispatcher"));

var _MatrixClientPeg = require("../MatrixClientPeg");

var _languageHandler = require("../languageHandler");

var _RoomAvatar = _interopRequireDefault(require("../components/views/avatars/RoomAvatar"));

var _AccessibleTooltipButton = _interopRequireDefault(require("../components/views/elements/AccessibleTooltipButton"));

var _AccessibleButton = _interopRequireDefault(require("../components/views/elements/AccessibleButton"));

var _dec, _class;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

const getIncomingCallToastKey = callId => `call_${callId}`;

exports.getIncomingCallToastKey = getIncomingCallToastKey;
let IncomingCallToast = (_dec = (0, _replaceableComponent.replaceableComponent)("views.voip.IncomingCallToast"), _dec(_class = class IncomingCallToast extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "componentDidMount", () => {
      _CallHandler.default.sharedInstance().addListener(_CallHandler.CallHandlerEvent.SilencedCallsChanged, this.onSilencedCallsChanged);
    });
    (0, _defineProperty2.default)(this, "onSilencedCallsChanged", () => {
      this.setState({
        silenced: _CallHandler.default.sharedInstance().isCallSilenced(this.props.call.callId)
      });
    });
    (0, _defineProperty2.default)(this, "onAnswerClick", e => {
      e.stopPropagation();

      _dispatcher.default.dispatch({
        action: 'answer',
        room_id: _CallHandler.default.sharedInstance().roomIdForCall(this.props.call)
      });
    });
    (0, _defineProperty2.default)(this, "onRejectClick", e => {
      e.stopPropagation();

      _dispatcher.default.dispatch({
        action: 'reject',
        room_id: _CallHandler.default.sharedInstance().roomIdForCall(this.props.call)
      });
    });
    (0, _defineProperty2.default)(this, "onSilenceClick", e => {
      e.stopPropagation();
      const callId = this.props.call.callId;
      this.state.silenced ? _CallHandler.default.sharedInstance().unSilenceCall(callId) : _CallHandler.default.sharedInstance().silenceCall(callId);
    });
    this.state = {
      silenced: _CallHandler.default.sharedInstance().isCallSilenced(this.props.call.callId)
    };
  }

  componentWillUnmount() {
    _CallHandler.default.sharedInstance().removeListener(_CallHandler.CallHandlerEvent.SilencedCallsChanged, this.onSilencedCallsChanged);
  }

  render() {
    const call = this.props.call;

    const room = _MatrixClientPeg.MatrixClientPeg.get().getRoom(_CallHandler.default.sharedInstance().roomIdForCall(call));

    const isVoice = call.type === _call.CallType.Voice;
    const contentClass = (0, _classnames.default)("mx_IncomingCallToast_content", {
      "mx_IncomingCallToast_content_voice": isVoice,
      "mx_IncomingCallToast_content_video": !isVoice
    });
    const silenceClass = (0, _classnames.default)("mx_IncomingCallToast_iconButton", {
      "mx_IncomingCallToast_unSilence": this.state.silenced,
      "mx_IncomingCallToast_silence": !this.state.silenced
    });
    return /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement(_RoomAvatar.default, {
      room: room,
      height: 32,
      width: 32
    }), /*#__PURE__*/_react.default.createElement("div", {
      className: contentClass
    }, /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_CallEvent_caller"
    }, room ? room.name : (0, _languageHandler._t)("Unknown caller")), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_CallEvent_type"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_CallEvent_type_icon"
    }), isVoice ? (0, _languageHandler._t)("Voice call") : (0, _languageHandler._t)("Video call")), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_IncomingCallToast_buttons"
    }, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      className: "mx_IncomingCallToast_button mx_IncomingCallToast_button_decline",
      onClick: this.onRejectClick,
      kind: "danger"
    }, /*#__PURE__*/_react.default.createElement("span", null, " ", (0, _languageHandler._t)("Decline"), " ")), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
      className: "mx_IncomingCallToast_button mx_IncomingCallToast_button_accept",
      onClick: this.onAnswerClick,
      kind: "primary"
    }, /*#__PURE__*/_react.default.createElement("span", null, " ", (0, _languageHandler._t)("Accept"), " ")))), /*#__PURE__*/_react.default.createElement(_AccessibleTooltipButton.default, {
      className: silenceClass,
      onClick: this.onSilenceClick,
      title: this.state.silenced ? (0, _languageHandler._t)("Sound on") : (0, _languageHandler._t)("Silence call")
    }));
  }

}) || _class);
exports.default = IncomingCallToast;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90b2FzdHMvSW5jb21pbmdDYWxsVG9hc3QudHN4Il0sIm5hbWVzIjpbImdldEluY29taW5nQ2FsbFRvYXN0S2V5IiwiY2FsbElkIiwiSW5jb21pbmdDYWxsVG9hc3QiLCJSZWFjdCIsIkNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJDYWxsSGFuZGxlciIsInNoYXJlZEluc3RhbmNlIiwiYWRkTGlzdGVuZXIiLCJDYWxsSGFuZGxlckV2ZW50IiwiU2lsZW5jZWRDYWxsc0NoYW5nZWQiLCJvblNpbGVuY2VkQ2FsbHNDaGFuZ2VkIiwic2V0U3RhdGUiLCJzaWxlbmNlZCIsImlzQ2FsbFNpbGVuY2VkIiwiY2FsbCIsImUiLCJzdG9wUHJvcGFnYXRpb24iLCJkaXMiLCJkaXNwYXRjaCIsImFjdGlvbiIsInJvb21faWQiLCJyb29tSWRGb3JDYWxsIiwic3RhdGUiLCJ1blNpbGVuY2VDYWxsIiwic2lsZW5jZUNhbGwiLCJjb21wb25lbnRXaWxsVW5tb3VudCIsInJlbW92ZUxpc3RlbmVyIiwicmVuZGVyIiwicm9vbSIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsImdldFJvb20iLCJpc1ZvaWNlIiwidHlwZSIsIkNhbGxUeXBlIiwiVm9pY2UiLCJjb250ZW50Q2xhc3MiLCJzaWxlbmNlQ2xhc3MiLCJuYW1lIiwib25SZWplY3RDbGljayIsIm9uQW5zd2VyQ2xpY2siLCJvblNpbGVuY2VDbGljayJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFtQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7O0FBRU8sTUFBTUEsdUJBQXVCLEdBQUlDLE1BQUQsSUFBcUIsUUFBT0EsTUFBTyxFQUFuRTs7O0lBV2NDLGlCLFdBRHBCLGdEQUFxQiw4QkFBckIsQyxnQkFBRCxNQUNxQkEsaUJBRHJCLFNBQytDQyxlQUFNQyxTQURyRCxDQUMrRTtBQUMzRUMsRUFBQUEsV0FBVyxD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aEIsb0JBQ0k7QUFBTSxNQUFBLFNBQVMsRUFBQztBQUFoQixPQUNNUixJQUFJLEdBQUdBLElBQUksQ0FBQ1UsSUFBUixHQUFlLHlCQUFHLGdCQUFILENBRHpCLENBREosZUFJSTtBQUFLLE1BQUEsU0FBUyxFQUFDO0FBQWYsb0JBQ0k7QUFBSyxNQUFBLFNBQVMsRUFBQztBQUFmLE1BREosRUFFTU4sT0FBTyxHQUFHLHlCQUFHLFlBQUgsQ0FBSCxHQUFzQix5QkFBRyxZQUFILENBRm5DLENBSkosZUFRSTtBQUFLLE1BQUEsU0FBUyxFQUFDO0FBQWYsb0JBQ0ksNkJBQUMseUJBQUQ7QUFDSSxNQUFBLFNBQVMsRUFBQyxpRUFEZDtBQUVJLE1BQUEsT0FBTyxFQUFFLEtBQUtPLGFBRmxCO0FBR0ksTUFBQSxJQUFJLEVBQUM7QUFIVCxvQkFLSSxnREFBUyx5QkFBRyxTQUFILENBQVQsTUFMSixDQURKLGVBUUksNkJBQUMseUJBQUQ7QUFDSSxNQUFBLFNBQVMsRUFBQyxnRUFEZDtBQUVJLE1BQUEsT0FBTyxFQUFFLEtBQUtDLGFBRmxCO0FBR0ksTUFBQSxJQUFJLEVBQUM7QUFIVCxvQkFLSSxnREFBUyx5QkFBRyxRQUFILENBQVQsTUFMSixDQVJKLENBUkosQ0FORyxlQStCSCw2QkFBQyxnQ0FBRDtBQUNJLE1BQUEsU0FBUyxFQUFFSCxZQURmO0FBRUksTUFBQSxPQUFPLEVBQUUsS0FBS0ksY0FGbEI7QUFHSSxNQUFBLEtBQUssRUFBRSxLQUFLbkIsS0FBTCxDQUFXVixRQUFYLEdBQXNCLHlCQUFHLFVBQUgsQ0FBdEIsR0FBdUMseUJBQUcsY0FBSDtBQUhsRCxNQS9CRyxDQUFQO0FBcUNIOztBQWhHMEUsQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNSwgMjAxNiBPcGVuTWFya2V0IEx0ZFxuQ29weXJpZ2h0IDIwMTggTmV3IFZlY3RvciBMdGRcbkNvcHlyaWdodCAyMDE5LCAyMDIwIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5Db3B5cmlnaHQgMjAyMSDFoGltb24gQnJhbmRuZXIgPHNpbW9uLmJyYS5hZ0BnbWFpbC5jb20+XG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IENhbGxUeXBlLCBNYXRyaXhDYWxsIH0gZnJvbSAnbWF0cml4LWpzLXNkay9zcmMvd2VicnRjL2NhbGwnO1xuaW1wb3J0IGNsYXNzTmFtZXMgZnJvbSAnY2xhc3NuYW1lcyc7XG5pbXBvcnQgeyByZXBsYWNlYWJsZUNvbXBvbmVudCB9IGZyb20gJy4uL3V0aWxzL3JlcGxhY2VhYmxlQ29tcG9uZW50JztcbmltcG9ydCBDYWxsSGFuZGxlciwgeyBDYWxsSGFuZGxlckV2ZW50IH0gZnJvbSAnLi4vQ2FsbEhhbmRsZXInO1xuaW1wb3J0IGRpcyBmcm9tICcuLi9kaXNwYXRjaGVyL2Rpc3BhdGNoZXInO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSAnLi4vTWF0cml4Q2xpZW50UGVnJztcbmltcG9ydCB7IF90IH0gZnJvbSAnLi4vbGFuZ3VhZ2VIYW5kbGVyJztcbmltcG9ydCBSb29tQXZhdGFyIGZyb20gJy4uL2NvbXBvbmVudHMvdmlld3MvYXZhdGFycy9Sb29tQXZhdGFyJztcbmltcG9ydCBBY2Nlc3NpYmxlVG9vbHRpcEJ1dHRvbiBmcm9tICcuLi9jb21wb25lbnRzL3ZpZXdzL2VsZW1lbnRzL0FjY2Vzc2libGVUb29sdGlwQnV0dG9uJztcbmltcG9ydCBBY2Nlc3NpYmxlQnV0dG9uIGZyb20gJy4uL2NvbXBvbmVudHMvdmlld3MvZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvbic7XG5cbmV4cG9ydCBjb25zdCBnZXRJbmNvbWluZ0NhbGxUb2FzdEtleSA9IChjYWxsSWQ6IHN0cmluZykgPT4gYGNhbGxfJHtjYWxsSWR9YDtcblxuaW50ZXJmYWNlIElQcm9wcyB7XG4gICAgY2FsbDogTWF0cml4Q2FsbDtcbn1cblxuaW50ZXJmYWNlIElTdGF0ZSB7XG4gICAgc2lsZW5jZWQ6IGJvb2xlYW47XG59XG5cbkByZXBsYWNlYWJsZUNvbXBvbmVudChcInZpZXdzLnZvaXAuSW5jb21pbmdDYWxsVG9hc3RcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEluY29taW5nQ2FsbFRvYXN0IGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PElQcm9wcywgSVN0YXRlPiB7XG4gICAgY29uc3RydWN0b3IocHJvcHM6IElQcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG5cbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIHNpbGVuY2VkOiBDYWxsSGFuZGxlci5zaGFyZWRJbnN0YW5jZSgpLmlzQ2FsbFNpbGVuY2VkKHRoaXMucHJvcHMuY2FsbC5jYWxsSWQpLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHB1YmxpYyBjb21wb25lbnREaWRNb3VudCA9ICgpOiB2b2lkID0+IHtcbiAgICAgICAgQ2FsbEhhbmRsZXIuc2hhcmVkSW5zdGFuY2UoKS5hZGRMaXN0ZW5lcihDYWxsSGFuZGxlckV2ZW50LlNpbGVuY2VkQ2FsbHNDaGFuZ2VkLCB0aGlzLm9uU2lsZW5jZWRDYWxsc0NoYW5nZWQpO1xuICAgIH07XG5cbiAgICBwdWJsaWMgY29tcG9uZW50V2lsbFVubW91bnQoKTogdm9pZCB7XG4gICAgICAgIENhbGxIYW5kbGVyLnNoYXJlZEluc3RhbmNlKCkucmVtb3ZlTGlzdGVuZXIoQ2FsbEhhbmRsZXJFdmVudC5TaWxlbmNlZENhbGxzQ2hhbmdlZCwgdGhpcy5vblNpbGVuY2VkQ2FsbHNDaGFuZ2VkKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uU2lsZW5jZWRDYWxsc0NoYW5nZWQgPSAoKTogdm9pZCA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBzaWxlbmNlZDogQ2FsbEhhbmRsZXIuc2hhcmVkSW5zdGFuY2UoKS5pc0NhbGxTaWxlbmNlZCh0aGlzLnByb3BzLmNhbGwuY2FsbElkKSB9KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkFuc3dlckNsaWNrID0gKGU6IFJlYWN0Lk1vdXNlRXZlbnQpOiB2b2lkID0+IHtcbiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgZGlzLmRpc3BhdGNoKHtcbiAgICAgICAgICAgIGFjdGlvbjogJ2Fuc3dlcicsXG4gICAgICAgICAgICByb29tX2lkOiBDYWxsSGFuZGxlci5zaGFyZWRJbnN0YW5jZSgpLnJvb21JZEZvckNhbGwodGhpcy5wcm9wcy5jYWxsKSxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25SZWplY3RDbGljaz0gKGU6IFJlYWN0Lk1vdXNlRXZlbnQpOiB2b2lkID0+IHtcbiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgZGlzLmRpc3BhdGNoKHtcbiAgICAgICAgICAgIGFjdGlvbjogJ3JlamVjdCcsXG4gICAgICAgICAgICByb29tX2lkOiBDYWxsSGFuZGxlci5zaGFyZWRJbnN0YW5jZSgpLnJvb21JZEZvckNhbGwodGhpcy5wcm9wcy5jYWxsKSxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25TaWxlbmNlQ2xpY2sgPSAoZTogUmVhY3QuTW91c2VFdmVudCk6IHZvaWQgPT4ge1xuICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBjb25zdCBjYWxsSWQgPSB0aGlzLnByb3BzLmNhbGwuY2FsbElkO1xuICAgICAgICB0aGlzLnN0YXRlLnNpbGVuY2VkID9cbiAgICAgICAgICAgIENhbGxIYW5kbGVyLnNoYXJlZEluc3RhbmNlKCkudW5TaWxlbmNlQ2FsbChjYWxsSWQpIDpcbiAgICAgICAgICAgIENhbGxIYW5kbGVyLnNoYXJlZEluc3RhbmNlKCkuc2lsZW5jZUNhbGwoY2FsbElkKTtcbiAgICB9O1xuXG4gICAgcHVibGljIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3QgY2FsbCA9IHRoaXMucHJvcHMuY2FsbDtcbiAgICAgICAgY29uc3Qgcm9vbSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRSb29tKENhbGxIYW5kbGVyLnNoYXJlZEluc3RhbmNlKCkucm9vbUlkRm9yQ2FsbChjYWxsKSk7XG4gICAgICAgIGNvbnN0IGlzVm9pY2UgPSBjYWxsLnR5cGUgPT09IENhbGxUeXBlLlZvaWNlO1xuXG4gICAgICAgIGNvbnN0IGNvbnRlbnRDbGFzcyA9IGNsYXNzTmFtZXMoXCJteF9JbmNvbWluZ0NhbGxUb2FzdF9jb250ZW50XCIsIHtcbiAgICAgICAgICAgIFwibXhfSW5jb21pbmdDYWxsVG9hc3RfY29udGVudF92b2ljZVwiOiBpc1ZvaWNlLFxuICAgICAgICAgICAgXCJteF9JbmNvbWluZ0NhbGxUb2FzdF9jb250ZW50X3ZpZGVvXCI6ICFpc1ZvaWNlLFxuICAgICAgICB9KTtcbiAgICAgICAgY29uc3Qgc2lsZW5jZUNsYXNzID0gY2xhc3NOYW1lcyhcIm14X0luY29taW5nQ2FsbFRvYXN0X2ljb25CdXR0b25cIiwge1xuICAgICAgICAgICAgXCJteF9JbmNvbWluZ0NhbGxUb2FzdF91blNpbGVuY2VcIjogdGhpcy5zdGF0ZS5zaWxlbmNlZCxcbiAgICAgICAgICAgIFwibXhfSW5jb21pbmdDYWxsVG9hc3Rfc2lsZW5jZVwiOiAhdGhpcy5zdGF0ZS5zaWxlbmNlZCxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIDxSZWFjdC5GcmFnbWVudD5cbiAgICAgICAgICAgIDxSb29tQXZhdGFyXG4gICAgICAgICAgICAgICAgcm9vbT17cm9vbX1cbiAgICAgICAgICAgICAgICBoZWlnaHQ9ezMyfVxuICAgICAgICAgICAgICAgIHdpZHRoPXszMn1cbiAgICAgICAgICAgIC8+XG4gICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT17Y29udGVudENsYXNzfT5cbiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9XCJteF9DYWxsRXZlbnRfY2FsbGVyXCI+XG4gICAgICAgICAgICAgICAgICAgIHsgcm9vbSA/IHJvb20ubmFtZSA6IF90KFwiVW5rbm93biBjYWxsZXJcIikgfVxuICAgICAgICAgICAgICAgIDwvc3Bhbj5cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0NhbGxFdmVudF90eXBlXCI+XG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfQ2FsbEV2ZW50X3R5cGVfaWNvblwiIC8+XG4gICAgICAgICAgICAgICAgICAgIHsgaXNWb2ljZSA/IF90KFwiVm9pY2UgY2FsbFwiKSA6IF90KFwiVmlkZW8gY2FsbFwiKSB9XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9JbmNvbWluZ0NhbGxUb2FzdF9idXR0b25zXCI+XG4gICAgICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uXG4gICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9JbmNvbWluZ0NhbGxUb2FzdF9idXR0b24gbXhfSW5jb21pbmdDYWxsVG9hc3RfYnV0dG9uX2RlY2xpbmVcIlxuICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5vblJlamVjdENsaWNrfVxuICAgICAgICAgICAgICAgICAgICAgICAga2luZD1cImRhbmdlclwiXG4gICAgICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuPiB7IF90KFwiRGVjbGluZVwiKSB9IDwvc3Bhbj5cbiAgICAgICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvblxuICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfSW5jb21pbmdDYWxsVG9hc3RfYnV0dG9uIG14X0luY29taW5nQ2FsbFRvYXN0X2J1dHRvbl9hY2NlcHRcIlxuICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5vbkFuc3dlckNsaWNrfVxuICAgICAgICAgICAgICAgICAgICAgICAga2luZD1cInByaW1hcnlcIlxuICAgICAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICAgICAgICA8c3Bhbj4geyBfdChcIkFjY2VwdFwiKSB9IDwvc3Bhbj5cbiAgICAgICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICA8QWNjZXNzaWJsZVRvb2x0aXBCdXR0b25cbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9e3NpbGVuY2VDbGFzc31cbiAgICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLm9uU2lsZW5jZUNsaWNrfVxuICAgICAgICAgICAgICAgIHRpdGxlPXt0aGlzLnN0YXRlLnNpbGVuY2VkID8gX3QoXCJTb3VuZCBvblwiKSA6IF90KFwiU2lsZW5jZSBjYWxsXCIpfVxuICAgICAgICAgICAgLz5cbiAgICAgICAgPC9SZWFjdC5GcmFnbWVudD47XG4gICAgfVxufVxuIl19