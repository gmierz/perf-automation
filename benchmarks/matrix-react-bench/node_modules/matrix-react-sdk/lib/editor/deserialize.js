"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.parseEvent = parseEvent;
exports.parsePlainTextMessage = parsePlainTextMessage;

var _dom = require("./dom");

var _HtmlUtils = require("../HtmlUtils");

var _Permalinks = require("../utils/permalinks/Permalinks");

var _parts = require("./parts");

var _SdkConfig = _interopRequireDefault(require("../SdkConfig"));

var _colour = require("../utils/colour");

/*
Copyright 2019 New Vector Ltd
Copyright 2019, 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
function parseAtRoomMentions(text, partCreator) {
  const ATROOM = "@room";
  const parts = [];
  text.split(ATROOM).forEach((textPart, i, arr) => {
    if (textPart.length) {
      parts.push(partCreator.plain(textPart));
    } // it's safe to never append @room after the last textPart
    // as split will report an empty string at the end if
    // `text` ended in @room.


    const isLast = i === arr.length - 1;

    if (!isLast) {
      parts.push(partCreator.atRoomPill(ATROOM));
    }
  });
  return parts;
}

function parseLink(a, partCreator) {
  const {
    href
  } = a;
  const resourceId = (0, _Permalinks.getPrimaryPermalinkEntity)(href); // The room/user ID

  const prefix = resourceId ? resourceId[0] : undefined; // First character of ID

  switch (prefix) {
    case "@":
      return partCreator.userPill(a.textContent, resourceId);

    case "#":
      return partCreator.roomPill(resourceId);

    default:
      {
        if (href === a.textContent) {
          return partCreator.plain(a.textContent);
        } else {
          return partCreator.plain(`[${a.textContent.replace(/[[\\\]]/g, c => "\\" + c)}](${href})`);
        }
      }
  }
}

function parseImage(img, partCreator) {
  const {
    src
  } = img;
  return partCreator.plain(`![${img.alt.replace(/[[\\\]]/g, c => "\\" + c)}](${src})`);
}

function parseCodeBlock(n, partCreator) {
  const parts = [];
  let language = "";

  if (n.firstChild && n.firstChild.nodeName === "CODE") {
    for (const className of n.firstChild.classList) {
      if (className.startsWith("language-") && !className.startsWith("language-_")) {
        language = className.substr("language-".length);
        break;
      }
    }
  }

  const preLines = ("```" + language + "\n" + n.textContent + "```").split("\n");
  preLines.forEach((l, i) => {
    parts.push(partCreator.plain(l));

    if (i < preLines.length - 1) {
      parts.push(partCreator.newline());
    }
  });
  return parts;
}

function parseHeader(el, partCreator) {
  const depth = parseInt(el.nodeName.substr(1), 10);
  return partCreator.plain("#".repeat(depth) + " ");
}

function parseElement(n, partCreator, lastNode, state) {
  switch (n.nodeName) {
    case "H1":
    case "H2":
    case "H3":
    case "H4":
    case "H5":
    case "H6":
      return parseHeader(n, partCreator);

    case "A":
      return parseLink(n, partCreator);

    case "IMG":
      return parseImage(n, partCreator);

    case "BR":
      return partCreator.newline();

    case "EM":
      return partCreator.plain(`_${n.textContent}_`);

    case "STRONG":
      return partCreator.plain(`**${n.textContent}**`);

    case "PRE":
      return parseCodeBlock(n, partCreator);

    case "CODE":
      return partCreator.plain(`\`${n.textContent}\``);

    case "DEL":
      return partCreator.plain(`<del>${n.textContent}</del>`);

    case "SUB":
      return partCreator.plain(`<sub>${n.textContent}</sub>`);

    case "SUP":
      return partCreator.plain(`<sup>${n.textContent}</sup>`);

    case "U":
      return partCreator.plain(`<u>${n.textContent}</u>`);

    case "LI":
      {
        const indent = "  ".repeat(state.listDepth - 1);

        if (n.parentElement.nodeName === "OL") {
          // The markdown parser doesn't do nested indexed lists at all, but this supports it anyway.
          const index = state.listIndex[state.listIndex.length - 1];
          state.listIndex[state.listIndex.length - 1] += 1;
          return partCreator.plain(`${indent}${index}. `);
        } else {
          return partCreator.plain(`${indent}- `);
        }
      }

    case "P":
      {
        if (lastNode) {
          return partCreator.newline();
        }

        break;
      }

    case "DIV":
    case "SPAN":
      {
        // math nodes are translated back into delimited latex strings
        if (n.hasAttribute("data-mx-maths")) {
          const delimLeft = n.nodeName == "SPAN" ? ((_SdkConfig.default.get()['latex_maths_delims'] || {})['inline'] || {})['left'] || "\\(" : ((_SdkConfig.default.get()['latex_maths_delims'] || {})['display'] || {})['left'] || "\\[";
          const delimRight = n.nodeName == "SPAN" ? ((_SdkConfig.default.get()['latex_maths_delims'] || {})['inline'] || {})['right'] || "\\)" : ((_SdkConfig.default.get()['latex_maths_delims'] || {})['display'] || {})['right'] || "\\]";
          const tex = n.getAttribute("data-mx-maths");
          return partCreator.plain(delimLeft + tex + delimRight);
        } else if (!checkDescendInto(n)) {
          return partCreator.plain(n.textContent);
        }

        break;
      }

    case "OL":
      state.listIndex.push(n.start || 1);

    /* falls through */

    case "UL":
      state.listDepth = (state.listDepth || 0) + 1;

    /* falls through */

    default:
      // don't textify block nodes we'll descend into
      if (!checkDescendInto(n)) {
        return partCreator.plain(n.textContent);
      }

  }
}

function checkDescendInto(node) {
  switch (node.nodeName) {
    case "PRE":
      // a code block is textified in parseCodeBlock
      // as we don't want to preserve markup in it,
      // so no need to descend into it
      return false;

    default:
      return (0, _HtmlUtils.checkBlockNode)(node);
  }
}

function checkIgnored(n) {
  if (n.nodeType === Node.TEXT_NODE) {
    // Element adds \n text nodes in a lot of places,
    // which should be ignored
    return n.nodeValue === "\n";
  } else if (n.nodeType === Node.ELEMENT_NODE) {
    return n.nodeName === "MX-REPLY";
  }

  return true;
}

const QUOTE_LINE_PREFIX = "> ";

function prefixQuoteLines(isFirstNode, parts, partCreator) {
  // a newline (to append a > to) wouldn't be added to parts for the first line
  // if there was no content before the BLOCKQUOTE, so handle that
  if (isFirstNode) {
    parts.splice(0, 0, partCreator.plain(QUOTE_LINE_PREFIX));
  }

  for (let i = 0; i < parts.length; i += 1) {
    if (parts[i].type === _parts.Type.Newline) {
      parts.splice(i + 1, 0, partCreator.plain(QUOTE_LINE_PREFIX));
      i += 1;
    }
  }
}

function parseHtmlMessage(html, partCreator, isQuotedMessage) {
  // no nodes from parsing here should be inserted in the document,
  // as scripts in event handlers, etc would be executed then.
  // we're only taking text, so that is fine
  const rootNode = new DOMParser().parseFromString(html, "text/html").body;
  const parts = [];
  let lastNode;
  let inQuote = isQuotedMessage;
  const state = {
    listIndex: []
  };

  function onNodeEnter(n) {
    if (checkIgnored(n)) {
      return false;
    }

    if (n.nodeName === "BLOCKQUOTE") {
      inQuote = true;
    }

    const newParts = [];

    if (lastNode && ((0, _HtmlUtils.checkBlockNode)(lastNode) || (0, _HtmlUtils.checkBlockNode)(n))) {
      newParts.push(partCreator.newline());
    }

    if (n.nodeType === Node.TEXT_NODE) {
      newParts.push(...parseAtRoomMentions(n.nodeValue, partCreator));
    } else if (n.nodeType === Node.ELEMENT_NODE) {
      const parseResult = parseElement(n, partCreator, lastNode, state);

      if (parseResult) {
        if (Array.isArray(parseResult)) {
          newParts.push(...parseResult);
        } else {
          newParts.push(parseResult);
        }
      }
    }

    if (newParts.length && inQuote) {
      const isFirstPart = parts.length === 0;
      prefixQuoteLines(isFirstPart, newParts, partCreator);
    }

    parts.push(...newParts);
    const descend = checkDescendInto(n); // when not descending (like for PRE), onNodeLeave won't be called to set lastNode
    // so do that here.

    lastNode = descend ? null : n;
    return descend;
  }

  function onNodeLeave(n) {
    if (checkIgnored(n)) {
      return;
    }

    switch (n.nodeName) {
      case "BLOCKQUOTE":
        inQuote = false;
        break;

      case "OL":
        state.listIndex.pop();

      /* falls through */

      case "UL":
        state.listDepth -= 1;
        break;
    }

    lastNode = n;
  }

  (0, _dom.walkDOMDepthFirst)(rootNode, onNodeEnter, onNodeLeave);
  return parts;
}

function parsePlainTextMessage(body, partCreator, isQuotedMessage) {
  const lines = body.split(/\r\n|\r|\n/g); // split on any new-line combination not just \n, collapses \r\n

  return lines.reduce((parts, line, i) => {
    if (isQuotedMessage) {
      parts.push(partCreator.plain(QUOTE_LINE_PREFIX));
    }

    parts.push(...parseAtRoomMentions(line, partCreator));
    const isLast = i === lines.length - 1;

    if (!isLast) {
      parts.push(partCreator.newline());
    }

    return parts;
  }, []);
}

function parseEvent(event, partCreator, {
  isQuotedMessage = false
} = {}) {
  const content = event.getContent();
  let parts;
  const isEmote = content.msgtype === "m.emote";
  let isRainbow = false;

  if (content.format === "org.matrix.custom.html") {
    parts = parseHtmlMessage(content.formatted_body || "", partCreator, isQuotedMessage);

    if (content.body && content.formatted_body && (0, _colour.textToHtmlRainbow)(content.body) === content.formatted_body) {
      isRainbow = true;
    }
  } else {
    parts = parsePlainTextMessage(content.body || "", partCreator, isQuotedMessage);
  }

  if (isEmote && isRainbow) {
    parts.unshift(partCreator.plain("/rainbowme "));
  } else if (isRainbow) {
    parts.unshift(partCreator.plain("/rainbow "));
  } else if (isEmote) {
    parts.unshift(partCreator.plain("/me "));
  }

  return parts;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lZGl0b3IvZGVzZXJpYWxpemUudHMiXSwibmFtZXMiOlsicGFyc2VBdFJvb21NZW50aW9ucyIsInRleHQiLCJwYXJ0Q3JlYXRvciIsIkFUUk9PTSIsInBhcnRzIiwic3BsaXQiLCJmb3JFYWNoIiwidGV4dFBhcnQiLCJpIiwiYXJyIiwibGVuZ3RoIiwicHVzaCIsInBsYWluIiwiaXNMYXN0IiwiYXRSb29tUGlsbCIsInBhcnNlTGluayIsImEiLCJocmVmIiwicmVzb3VyY2VJZCIsInByZWZpeCIsInVuZGVmaW5lZCIsInVzZXJQaWxsIiwidGV4dENvbnRlbnQiLCJyb29tUGlsbCIsInJlcGxhY2UiLCJjIiwicGFyc2VJbWFnZSIsImltZyIsInNyYyIsImFsdCIsInBhcnNlQ29kZUJsb2NrIiwibiIsImxhbmd1YWdlIiwiZmlyc3RDaGlsZCIsIm5vZGVOYW1lIiwiY2xhc3NOYW1lIiwiY2xhc3NMaXN0Iiwic3RhcnRzV2l0aCIsInN1YnN0ciIsInByZUxpbmVzIiwibCIsIm5ld2xpbmUiLCJwYXJzZUhlYWRlciIsImVsIiwiZGVwdGgiLCJwYXJzZUludCIsInJlcGVhdCIsInBhcnNlRWxlbWVudCIsImxhc3ROb2RlIiwic3RhdGUiLCJpbmRlbnQiLCJsaXN0RGVwdGgiLCJwYXJlbnRFbGVtZW50IiwiaW5kZXgiLCJsaXN0SW5kZXgiLCJoYXNBdHRyaWJ1dGUiLCJkZWxpbUxlZnQiLCJTZGtDb25maWciLCJnZXQiLCJkZWxpbVJpZ2h0IiwidGV4IiwiZ2V0QXR0cmlidXRlIiwiY2hlY2tEZXNjZW5kSW50byIsInN0YXJ0Iiwibm9kZSIsImNoZWNrSWdub3JlZCIsIm5vZGVUeXBlIiwiTm9kZSIsIlRFWFRfTk9ERSIsIm5vZGVWYWx1ZSIsIkVMRU1FTlRfTk9ERSIsIlFVT1RFX0xJTkVfUFJFRklYIiwicHJlZml4UXVvdGVMaW5lcyIsImlzRmlyc3ROb2RlIiwic3BsaWNlIiwidHlwZSIsIlR5cGUiLCJOZXdsaW5lIiwicGFyc2VIdG1sTWVzc2FnZSIsImh0bWwiLCJpc1F1b3RlZE1lc3NhZ2UiLCJyb290Tm9kZSIsIkRPTVBhcnNlciIsInBhcnNlRnJvbVN0cmluZyIsImJvZHkiLCJpblF1b3RlIiwib25Ob2RlRW50ZXIiLCJuZXdQYXJ0cyIsInBhcnNlUmVzdWx0IiwiQXJyYXkiLCJpc0FycmF5IiwiaXNGaXJzdFBhcnQiLCJkZXNjZW5kIiwib25Ob2RlTGVhdmUiLCJwb3AiLCJwYXJzZVBsYWluVGV4dE1lc3NhZ2UiLCJsaW5lcyIsInJlZHVjZSIsImxpbmUiLCJwYXJzZUV2ZW50IiwiZXZlbnQiLCJjb250ZW50IiwiZ2V0Q29udGVudCIsImlzRW1vdGUiLCJtc2d0eXBlIiwiaXNSYWluYm93IiwiZm9ybWF0IiwiZm9ybWF0dGVkX2JvZHkiLCJ1bnNoaWZ0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBbUJBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQXhCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQVdBLFNBQVNBLG1CQUFULENBQTZCQyxJQUE3QixFQUEyQ0MsV0FBM0MsRUFBcUU7QUFDakUsUUFBTUMsTUFBTSxHQUFHLE9BQWY7QUFDQSxRQUFNQyxLQUFLLEdBQUcsRUFBZDtBQUNBSCxFQUFBQSxJQUFJLENBQUNJLEtBQUwsQ0FBV0YsTUFBWCxFQUFtQkcsT0FBbkIsQ0FBMkIsQ0FBQ0MsUUFBRCxFQUFXQyxDQUFYLEVBQWNDLEdBQWQsS0FBc0I7QUFDN0MsUUFBSUYsUUFBUSxDQUFDRyxNQUFiLEVBQXFCO0FBQ2pCTixNQUFBQSxLQUFLLENBQUNPLElBQU4sQ0FBV1QsV0FBVyxDQUFDVSxLQUFaLENBQWtCTCxRQUFsQixDQUFYO0FBQ0gsS0FINEMsQ0FJN0M7QUFDQTtBQUNBOzs7QUFDQSxVQUFNTSxNQUFNLEdBQUdMLENBQUMsS0FBS0MsR0FBRyxDQUFDQyxNQUFKLEdBQWEsQ0FBbEM7O0FBQ0EsUUFBSSxDQUFDRyxN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QUFPLENBQUNqQixJQUFSLElBQWdCLEVBQWpCLEVBQXFCbEYsV0FBckIsRUFBa0M4RSxlQUFsQyxDQUE3QjtBQUNIOztBQUVELE1BQUl1QixPQUFPLElBQUlFLFNBQWYsRUFBMEI7QUFDdEJyRyxJQUFBQSxLQUFLLENBQUN3RyxPQUFOLENBQWMxRyxXQUFXLENBQUNVLEtBQVosQ0FBa0IsYUFBbEIsQ0FBZDtBQUNILEdBRkQsTUFFTyxJQUFJNkYsU0FBSixFQUFlO0FBQ2xCckcsSUFBQUEsS0FBSyxDQUFDd0csT0FBTixDQUFjMUcsV0FBVyxDQUFDVSxLQUFaLENBQWtCLFdBQWxCLENBQWQ7QUFDSCxHQUZNLE1BRUEsSUFBSTJGLE9BQUosRUFBYTtBQUNoQm5HLElBQUFBLEtBQUssQ0FBQ3dHLE9BQU4sQ0FBYzFHLFdBQVcsQ0FBQ1UsS0FBWixDQUFrQixNQUFsQixDQUFkO0FBQ0g7O0FBRUQsU0FBT1IsS0FBUDtBQUNIIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE5IE5ldyBWZWN0b3IgTHRkXG5Db3B5cmlnaHQgMjAxOSwgMjAyMCBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCB7IE1hdHJpeEV2ZW50IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9ldmVudFwiO1xuXG5pbXBvcnQgeyB3YWxrRE9NRGVwdGhGaXJzdCB9IGZyb20gXCIuL2RvbVwiO1xuaW1wb3J0IHsgY2hlY2tCbG9ja05vZGUgfSBmcm9tIFwiLi4vSHRtbFV0aWxzXCI7XG5pbXBvcnQgeyBnZXRQcmltYXJ5UGVybWFsaW5rRW50aXR5IH0gZnJvbSBcIi4uL3V0aWxzL3Blcm1hbGlua3MvUGVybWFsaW5rc1wiO1xuaW1wb3J0IHsgUGFydCwgUGFydENyZWF0b3IsIFR5cGUgfSBmcm9tIFwiLi9wYXJ0c1wiO1xuaW1wb3J0IFNka0NvbmZpZyBmcm9tIFwiLi4vU2RrQ29uZmlnXCI7XG5pbXBvcnQgeyB0ZXh0VG9IdG1sUmFpbmJvdyB9IGZyb20gXCIuLi91dGlscy9jb2xvdXJcIjtcblxuZnVuY3Rpb24gcGFyc2VBdFJvb21NZW50aW9ucyh0ZXh0OiBzdHJpbmcsIHBhcnRDcmVhdG9yOiBQYXJ0Q3JlYXRvcikge1xuICAgIGNvbnN0IEFUUk9PTSA9IFwiQHJvb21cIjtcbiAgICBjb25zdCBwYXJ0cyA9IFtdO1xuICAgIHRleHQuc3BsaXQoQVRST09NKS5mb3JFYWNoKCh0ZXh0UGFydCwgaSwgYXJyKSA9PiB7XG4gICAgICAgIGlmICh0ZXh0UGFydC5sZW5ndGgpIHtcbiAgICAgICAgICAgIHBhcnRzLnB1c2gocGFydENyZWF0b3IucGxhaW4odGV4dFBhcnQpKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBpdCdzIHNhZmUgdG8gbmV2ZXIgYXBwZW5kIEByb29tIGFmdGVyIHRoZSBsYXN0IHRleHRQYXJ0XG4gICAgICAgIC8vIGFzIHNwbGl0IHdpbGwgcmVwb3J0IGFuIGVtcHR5IHN0cmluZyBhdCB0aGUgZW5kIGlmXG4gICAgICAgIC8vIGB0ZXh0YCBlbmRlZCBpbiBAcm9vbS5cbiAgICAgICAgY29uc3QgaXNMYXN0ID0gaSA9PT0gYXJyLmxlbmd0aCAtIDE7XG4gICAgICAgIGlmICghaXNMYXN0KSB7XG4gICAgICAgICAgICBwYXJ0cy5wdXNoKHBhcnRDcmVhdG9yLmF0Um9vbVBpbGwoQVRST09NKSk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gcGFydHM7XG59XG5cbmZ1bmN0aW9uIHBhcnNlTGluayhhOiBIVE1MQW5jaG9yRWxlbWVudCwgcGFydENyZWF0b3I6IFBhcnRDcmVhdG9yKSB7XG4gICAgY29uc3QgeyBocmVmIH0gPSBhO1xuICAgIGNvbnN0IHJlc291cmNlSWQgPSBnZXRQcmltYXJ5UGVybWFsaW5rRW50aXR5KGhyZWYpOyAvLyBUaGUgcm9vbS91c2VyIElEXG4gICAgY29uc3QgcHJlZml4ID0gcmVzb3VyY2VJZCA/IHJlc291cmNlSWRbMF0gOiB1bmRlZmluZWQ7IC8vIEZpcnN0IGNoYXJhY3RlciBvZiBJRFxuICAgIHN3aXRjaCAocHJlZml4KSB7XG4gICAgICAgIGNhc2UgXCJAXCI6XG4gICAgICAgICAgICByZXR1cm4gcGFydENyZWF0b3IudXNlclBpbGwoYS50ZXh0Q29udGVudCwgcmVzb3VyY2VJZCk7XG4gICAgICAgIGNhc2UgXCIjXCI6XG4gICAgICAgICAgICByZXR1cm4gcGFydENyZWF0b3Iucm9vbVBpbGwocmVzb3VyY2VJZCk7XG4gICAgICAgIGRlZmF1bHQ6IHtcbiAgICAgICAgICAgIGlmIChocmVmID09PSBhLnRleHRDb250ZW50KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHBhcnRDcmVhdG9yLnBsYWluKGEudGV4dENvbnRlbnQpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcGFydENyZWF0b3IucGxhaW4oYFske2EudGV4dENvbnRlbnQucmVwbGFjZSgvW1tcXFxcXFxdXS9nLCBjID0+IFwiXFxcXFwiICsgYyl9XSgke2hyZWZ9KWApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuXG5mdW5jdGlvbiBwYXJzZUltYWdlKGltZzogSFRNTEltYWdlRWxlbWVudCwgcGFydENyZWF0b3I6IFBhcnRDcmVhdG9yKSB7XG4gICAgY29uc3QgeyBzcmMgfSA9IGltZztcbiAgICByZXR1cm4gcGFydENyZWF0b3IucGxhaW4oYCFbJHtpbWcuYWx0LnJlcGxhY2UoL1tbXFxcXFxcXV0vZywgYyA9PiBcIlxcXFxcIiArIGMpfV0oJHtzcmN9KWApO1xufVxuXG5mdW5jdGlvbiBwYXJzZUNvZGVCbG9jayhuOiBIVE1MRWxlbWVudCwgcGFydENyZWF0b3I6IFBhcnRDcmVhdG9yKSB7XG4gICAgY29uc3QgcGFydHMgPSBbXTtcbiAgICBsZXQgbGFuZ3VhZ2UgPSBcIlwiO1xuICAgIGlmIChuLmZpcnN0Q2hpbGQgJiYgbi5maXJzdENoaWxkLm5vZGVOYW1lID09PSBcIkNPREVcIikge1xuICAgICAgICBmb3IgKGNvbnN0IGNsYXNzTmFtZSBvZiAoPEhUTUxFbGVtZW50Pm4uZmlyc3RDaGlsZCkuY2xhc3NMaXN0KSB7XG4gICAgICAgICAgICBpZiAoY2xhc3NOYW1lLnN0YXJ0c1dpdGgoXCJsYW5ndWFnZS1cIikgJiYgIWNsYXNzTmFtZS5zdGFydHNXaXRoKFwibGFuZ3VhZ2UtX1wiKSkge1xuICAgICAgICAgICAgICAgIGxhbmd1YWdlID0gY2xhc3NOYW1lLnN1YnN0cihcImxhbmd1YWdlLVwiLmxlbmd0aCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgcHJlTGluZXMgPSAoXCJgYGBcIiArIGxhbmd1YWdlICsgXCJcXG5cIiArIG4udGV4dENvbnRlbnQgKyBcImBgYFwiKS5zcGxpdChcIlxcblwiKTtcbiAgICBwcmVMaW5lcy5mb3JFYWNoKChsLCBpKSA9PiB7XG4gICAgICAgIHBhcnRzLnB1c2gocGFydENyZWF0b3IucGxhaW4obCkpO1xuICAgICAgICBpZiAoaSA8IHByZUxpbmVzLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICAgIHBhcnRzLnB1c2gocGFydENyZWF0b3IubmV3bGluZSgpKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBwYXJ0cztcbn1cblxuZnVuY3Rpb24gcGFyc2VIZWFkZXIoZWw6IEhUTUxFbGVtZW50LCBwYXJ0Q3JlYXRvcjogUGFydENyZWF0b3IpIHtcbiAgICBjb25zdCBkZXB0aCA9IHBhcnNlSW50KGVsLm5vZGVOYW1lLnN1YnN0cigxKSwgMTApO1xuICAgIHJldHVybiBwYXJ0Q3JlYXRvci5wbGFpbihcIiNcIi5yZXBlYXQoZGVwdGgpICsgXCIgXCIpO1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBsaXN0SW5kZXg6IG51bWJlcltdO1xuICAgIGxpc3REZXB0aD86IG51bWJlcjtcbn1cblxuZnVuY3Rpb24gcGFyc2VFbGVtZW50KG46IEhUTUxFbGVtZW50LCBwYXJ0Q3JlYXRvcjogUGFydENyZWF0b3IsIGxhc3ROb2RlOiBIVE1MRWxlbWVudCB8IHVuZGVmaW5lZCwgc3RhdGU6IElTdGF0ZSkge1xuICAgIHN3aXRjaCAobi5ub2RlTmFtZSkge1xuICAgICAgICBjYXNlIFwiSDFcIjpcbiAgICAgICAgY2FzZSBcIkgyXCI6XG4gICAgICAgIGNhc2UgXCJIM1wiOlxuICAgICAgICBjYXNlIFwiSDRcIjpcbiAgICAgICAgY2FzZSBcIkg1XCI6XG4gICAgICAgIGNhc2UgXCJINlwiOlxuICAgICAgICAgICAgcmV0dXJuIHBhcnNlSGVhZGVyKG4sIHBhcnRDcmVhdG9yKTtcbiAgICAgICAgY2FzZSBcIkFcIjpcbiAgICAgICAgICAgIHJldHVybiBwYXJzZUxpbmsoPEhUTUxBbmNob3JFbGVtZW50Pm4sIHBhcnRDcmVhdG9yKTtcbiAgICAgICAgY2FzZSBcIklNR1wiOlxuICAgICAgICAgICAgcmV0dXJuIHBhcnNlSW1hZ2UoPEhUTUxJbWFnZUVsZW1lbnQ+biwgcGFydENyZWF0b3IpO1xuICAgICAgICBjYXNlIFwiQlJcIjpcbiAgICAgICAgICAgIHJldHVybiBwYXJ0Q3JlYXRvci5uZXdsaW5lKCk7XG4gICAgICAgIGNhc2UgXCJFTVwiOlxuICAgICAgICAgICAgcmV0dXJuIHBhcnRDcmVhdG9yLnBsYWluKGBfJHtuLnRleHRDb250ZW50fV9gKTtcbiAgICAgICAgY2FzZSBcIlNUUk9OR1wiOlxuICAgICAgICAgICAgcmV0dXJuIHBhcnRDcmVhdG9yLnBsYWluKGAqKiR7bi50ZXh0Q29udGVudH0qKmApO1xuICAgICAgICBjYXNlIFwiUFJFXCI6XG4gICAgICAgICAgICByZXR1cm4gcGFyc2VDb2RlQmxvY2sobiwgcGFydENyZWF0b3IpO1xuICAgICAgICBjYXNlIFwiQ09ERVwiOlxuICAgICAgICAgICAgcmV0dXJuIHBhcnRDcmVhdG9yLnBsYWluKGBcXGAke24udGV4dENvbnRlbnR9XFxgYCk7XG4gICAgICAgIGNhc2UgXCJERUxcIjpcbiAgICAgICAgICAgIHJldHVybiBwYXJ0Q3JlYXRvci5wbGFpbihgPGRlbD4ke24udGV4dENvbnRlbnR9PC9kZWw+YCk7XG4gICAgICAgIGNhc2UgXCJTVUJcIjpcbiAgICAgICAgICAgIHJldHVybiBwYXJ0Q3JlYXRvci5wbGFpbihgPHN1Yj4ke24udGV4dENvbnRlbnR9PC9zdWI+YCk7XG4gICAgICAgIGNhc2UgXCJTVVBcIjpcbiAgICAgICAgICAgIHJldHVybiBwYXJ0Q3JlYXRvci5wbGFpbihgPHN1cD4ke24udGV4dENvbnRlbnR9PC9zdXA+YCk7XG4gICAgICAgIGNhc2UgXCJVXCI6XG4gICAgICAgICAgICByZXR1cm4gcGFydENyZWF0b3IucGxhaW4oYDx1PiR7bi50ZXh0Q29udGVudH08L3U+YCk7XG4gICAgICAgIGNhc2UgXCJMSVwiOiB7XG4gICAgICAgICAgICBjb25zdCBpbmRlbnQgPSBcIiAgXCIucmVwZWF0KHN0YXRlLmxpc3REZXB0aCAtIDEpO1xuICAgICAgICAgICAgaWYgKG4ucGFyZW50RWxlbWVudC5ub2RlTmFtZSA9PT0gXCJPTFwiKSB7XG4gICAgICAgICAgICAgICAgLy8gVGhlIG1hcmtkb3duIHBhcnNlciBkb2Vzbid0IGRvIG5lc3RlZCBpbmRleGVkIGxpc3RzIGF0IGFsbCwgYnV0IHRoaXMgc3VwcG9ydHMgaXQgYW55d2F5LlxuICAgICAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gc3RhdGUubGlzdEluZGV4W3N0YXRlLmxpc3RJbmRleC5sZW5ndGggLSAxXTtcbiAgICAgICAgICAgICAgICBzdGF0ZS5saXN0SW5kZXhbc3RhdGUubGlzdEluZGV4Lmxlbmd0aCAtIDFdICs9IDE7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHBhcnRDcmVhdG9yLnBsYWluKGAke2luZGVudH0ke2luZGV4fS4gYCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBwYXJ0Q3JlYXRvci5wbGFpbihgJHtpbmRlbnR9LSBgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBjYXNlIFwiUFwiOiB7XG4gICAgICAgICAgICBpZiAobGFzdE5vZGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcGFydENyZWF0b3IubmV3bGluZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgY2FzZSBcIkRJVlwiOlxuICAgICAgICBjYXNlIFwiU1BBTlwiOiB7XG4gICAgICAgICAgICAvLyBtYXRoIG5vZGVzIGFyZSB0cmFuc2xhdGVkIGJhY2sgaW50byBkZWxpbWl0ZWQgbGF0ZXggc3RyaW5nc1xuICAgICAgICAgICAgaWYgKG4uaGFzQXR0cmlidXRlKFwiZGF0YS1teC1tYXRoc1wiKSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGRlbGltTGVmdCA9IChuLm5vZGVOYW1lID09IFwiU1BBTlwiKSA/XG4gICAgICAgICAgICAgICAgICAgICgoU2RrQ29uZmlnLmdldCgpWydsYXRleF9tYXRoc19kZWxpbXMnXSB8fCB7fSlbJ2lubGluZSddIHx8IHt9KVsnbGVmdCddIHx8IFwiXFxcXChcIiA6XG4gICAgICAgICAgICAgICAgICAgICgoU2RrQ29uZmlnLmdldCgpWydsYXRleF9tYXRoc19kZWxpbXMnXSB8fCB7fSlbJ2Rpc3BsYXknXSB8fCB7fSlbJ2xlZnQnXSB8fCBcIlxcXFxbXCI7XG4gICAgICAgICAgICAgICAgY29uc3QgZGVsaW1SaWdodCA9IChuLm5vZGVOYW1lID09IFwiU1BBTlwiKSA/XG4gICAgICAgICAgICAgICAgICAgICgoU2RrQ29uZmlnLmdldCgpWydsYXRleF9tYXRoc19kZWxpbXMnXSB8fCB7fSlbJ2lubGluZSddIHx8IHt9KVsncmlnaHQnXSB8fCBcIlxcXFwpXCIgOlxuICAgICAgICAgICAgICAgICAgICAoKFNka0NvbmZpZy5nZXQoKVsnbGF0ZXhfbWF0aHNfZGVsaW1zJ10gfHwge30pWydkaXNwbGF5J10gfHwge30pWydyaWdodCddIHx8IFwiXFxcXF1cIjtcbiAgICAgICAgICAgICAgICBjb25zdCB0ZXggPSBuLmdldEF0dHJpYnV0ZShcImRhdGEtbXgtbWF0aHNcIik7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHBhcnRDcmVhdG9yLnBsYWluKGRlbGltTGVmdCArIHRleCArIGRlbGltUmlnaHQpO1xuICAgICAgICAgICAgfSBlbHNlIGlmICghY2hlY2tEZXNjZW5kSW50byhuKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBwYXJ0Q3JlYXRvci5wbGFpbihuLnRleHRDb250ZW50KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGNhc2UgXCJPTFwiOlxuICAgICAgICAgICAgc3RhdGUubGlzdEluZGV4LnB1c2goKDxIVE1MT0xpc3RFbGVtZW50Pm4pLnN0YXJ0IHx8IDEpO1xuICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqL1xuICAgICAgICBjYXNlIFwiVUxcIjpcbiAgICAgICAgICAgIHN0YXRlLmxpc3REZXB0aCA9IChzdGF0ZS5saXN0RGVwdGggfHwgMCkgKyAxO1xuICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqL1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgLy8gZG9uJ3QgdGV4dGlmeSBibG9jayBub2RlcyB3ZSdsbCBkZXNjZW5kIGludG9cbiAgICAgICAgICAgIGlmICghY2hlY2tEZXNjZW5kSW50byhuKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBwYXJ0Q3JlYXRvci5wbGFpbihuLnRleHRDb250ZW50KTtcbiAgICAgICAgICAgIH1cbiAgICB9XG59XG5cbmZ1bmN0aW9uIGNoZWNrRGVzY2VuZEludG8obm9kZSkge1xuICAgIHN3aXRjaCAobm9kZS5ub2RlTmFtZSkge1xuICAgICAgICBjYXNlIFwiUFJFXCI6XG4gICAgICAgICAgICAvLyBhIGNvZGUgYmxvY2sgaXMgdGV4dGlmaWVkIGluIHBhcnNlQ29kZUJsb2NrXG4gICAgICAgICAgICAvLyBhcyB3ZSBkb24ndCB3YW50IHRvIHByZXNlcnZlIG1hcmt1cCBpbiBpdCxcbiAgICAgICAgICAgIC8vIHNvIG5vIG5lZWQgdG8gZGVzY2VuZCBpbnRvIGl0XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICByZXR1cm4gY2hlY2tCbG9ja05vZGUobm9kZSk7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBjaGVja0lnbm9yZWQobikge1xuICAgIGlmIChuLm5vZGVUeXBlID09PSBOb2RlLlRFWFRfTk9ERSkge1xuICAgICAgICAvLyBFbGVtZW50IGFkZHMgXFxuIHRleHQgbm9kZXMgaW4gYSBsb3Qgb2YgcGxhY2VzLFxuICAgICAgICAvLyB3aGljaCBzaG91bGQgYmUgaWdub3JlZFxuICAgICAgICByZXR1cm4gbi5ub2RlVmFsdWUgPT09IFwiXFxuXCI7XG4gICAgfSBlbHNlIGlmIChuLm5vZGVUeXBlID09PSBOb2RlLkVMRU1FTlRfTk9ERSkge1xuICAgICAgICByZXR1cm4gbi5ub2RlTmFtZSA9PT0gXCJNWC1SRVBMWVwiO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbn1cblxuY29uc3QgUVVPVEVfTElORV9QUkVGSVggPSBcIj4gXCI7XG5mdW5jdGlvbiBwcmVmaXhRdW90ZUxpbmVzKGlzRmlyc3ROb2RlLCBwYXJ0cywgcGFydENyZWF0b3IpIHtcbiAgICAvLyBhIG5ld2xpbmUgKHRvIGFwcGVuZCBhID4gdG8pIHdvdWxkbid0IGJlIGFkZGVkIHRvIHBhcnRzIGZvciB0aGUgZmlyc3QgbGluZVxuICAgIC8vIGlmIHRoZXJlIHdhcyBubyBjb250ZW50IGJlZm9yZSB0aGUgQkxPQ0tRVU9URSwgc28gaGFuZGxlIHRoYXRcbiAgICBpZiAoaXNGaXJzdE5vZGUpIHtcbiAgICAgICAgcGFydHMuc3BsaWNlKDAsIDAsIHBhcnRDcmVhdG9yLnBsYWluKFFVT1RFX0xJTkVfUFJFRklYKSk7XG4gICAgfVxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyBpICs9IDEpIHtcbiAgICAgICAgaWYgKHBhcnRzW2ldLnR5cGUgPT09IFR5cGUuTmV3bGluZSkge1xuICAgICAgICAgICAgcGFydHMuc3BsaWNlKGkgKyAxLCAwLCBwYXJ0Q3JlYXRvci5wbGFpbihRVU9URV9MSU5FX1BSRUZJWCkpO1xuICAgICAgICAgICAgaSArPSAxO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5mdW5jdGlvbiBwYXJzZUh0bWxNZXNzYWdlKGh0bWw6IHN0cmluZywgcGFydENyZWF0b3I6IFBhcnRDcmVhdG9yLCBpc1F1b3RlZE1lc3NhZ2U6IGJvb2xlYW4pOiBQYXJ0W10ge1xuICAgIC8vIG5vIG5vZGVzIGZyb20gcGFyc2luZyBoZXJlIHNob3VsZCBiZSBpbnNlcnRlZCBpbiB0aGUgZG9jdW1lbnQsXG4gICAgLy8gYXMgc2NyaXB0cyBpbiBldmVudCBoYW5kbGVycywgZXRjIHdvdWxkIGJlIGV4ZWN1dGVkIHRoZW4uXG4gICAgLy8gd2UncmUgb25seSB0YWtpbmcgdGV4dCwgc28gdGhhdCBpcyBmaW5lXG4gICAgY29uc3Qgcm9vdE5vZGUgPSBuZXcgRE9NUGFyc2VyKCkucGFyc2VGcm9tU3RyaW5nKGh0bWwsIFwidGV4dC9odG1sXCIpLmJvZHk7XG4gICAgY29uc3QgcGFydHM6IFBhcnRbXSA9IFtdO1xuICAgIGxldCBsYXN0Tm9kZTtcbiAgICBsZXQgaW5RdW90ZSA9IGlzUXVvdGVkTWVzc2FnZTtcbiAgICBjb25zdCBzdGF0ZTogSVN0YXRlID0ge1xuICAgICAgICBsaXN0SW5kZXg6IFtdLFxuICAgIH07XG5cbiAgICBmdW5jdGlvbiBvbk5vZGVFbnRlcihuKSB7XG4gICAgICAgIGlmIChjaGVja0lnbm9yZWQobikpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobi5ub2RlTmFtZSA9PT0gXCJCTE9DS1FVT1RFXCIpIHtcbiAgICAgICAgICAgIGluUXVvdGUgPSB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgbmV3UGFydHM6IFBhcnRbXSA9IFtdO1xuICAgICAgICBpZiAobGFzdE5vZGUgJiYgKGNoZWNrQmxvY2tOb2RlKGxhc3ROb2RlKSB8fCBjaGVja0Jsb2NrTm9kZShuKSkpIHtcbiAgICAgICAgICAgIG5ld1BhcnRzLnB1c2gocGFydENyZWF0b3IubmV3bGluZSgpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChuLm5vZGVUeXBlID09PSBOb2RlLlRFWFRfTk9ERSkge1xuICAgICAgICAgICAgbmV3UGFydHMucHVzaCguLi5wYXJzZUF0Um9vbU1lbnRpb25zKG4ubm9kZVZhbHVlLCBwYXJ0Q3JlYXRvcikpO1xuICAgICAgICB9IGVsc2UgaWYgKG4ubm9kZVR5cGUgPT09IE5vZGUuRUxFTUVOVF9OT0RFKSB7XG4gICAgICAgICAgICBjb25zdCBwYXJzZVJlc3VsdCA9IHBhcnNlRWxlbWVudChuLCBwYXJ0Q3JlYXRvciwgbGFzdE5vZGUsIHN0YXRlKTtcbiAgICAgICAgICAgIGlmIChwYXJzZVJlc3VsdCkge1xuICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHBhcnNlUmVzdWx0KSkge1xuICAgICAgICAgICAgICAgICAgICBuZXdQYXJ0cy5wdXNoKC4uLnBhcnNlUmVzdWx0KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBuZXdQYXJ0cy5wdXNoKHBhcnNlUmVzdWx0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAobmV3UGFydHMubGVuZ3RoICYmIGluUXVvdGUpIHtcbiAgICAgICAgICAgIGNvbnN0IGlzRmlyc3RQYXJ0ID0gcGFydHMubGVuZ3RoID09PSAwO1xuICAgICAgICAgICAgcHJlZml4UXVvdGVMaW5lcyhpc0ZpcnN0UGFydCwgbmV3UGFydHMsIHBhcnRDcmVhdG9yKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHBhcnRzLnB1c2goLi4ubmV3UGFydHMpO1xuXG4gICAgICAgIGNvbnN0IGRlc2NlbmQgPSBjaGVja0Rlc2NlbmRJbnRvKG4pO1xuICAgICAgICAvLyB3aGVuIG5vdCBkZXNjZW5kaW5nIChsaWtlIGZvciBQUkUpLCBvbk5vZGVMZWF2ZSB3b24ndCBiZSBjYWxsZWQgdG8gc2V0IGxhc3ROb2RlXG4gICAgICAgIC8vIHNvIGRvIHRoYXQgaGVyZS5cbiAgICAgICAgbGFzdE5vZGUgPSBkZXNjZW5kID8gbnVsbCA6IG47XG4gICAgICAgIHJldHVybiBkZXNjZW5kO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIG9uTm9kZUxlYXZlKG4pIHtcbiAgICAgICAgaWYgKGNoZWNrSWdub3JlZChuKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHN3aXRjaCAobi5ub2RlTmFtZSkge1xuICAgICAgICAgICAgY2FzZSBcIkJMT0NLUVVPVEVcIjpcbiAgICAgICAgICAgICAgICBpblF1b3RlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFwiT0xcIjpcbiAgICAgICAgICAgICAgICBzdGF0ZS5saXN0SW5kZXgucG9wKCk7XG4gICAgICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqL1xuICAgICAgICAgICAgY2FzZSBcIlVMXCI6XG4gICAgICAgICAgICAgICAgc3RhdGUubGlzdERlcHRoIC09IDE7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgbGFzdE5vZGUgPSBuO1xuICAgIH1cblxuICAgIHdhbGtET01EZXB0aEZpcnN0KHJvb3ROb2RlLCBvbk5vZGVFbnRlciwgb25Ob2RlTGVhdmUpO1xuXG4gICAgcmV0dXJuIHBhcnRzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VQbGFpblRleHRNZXNzYWdlKGJvZHk6IHN0cmluZywgcGFydENyZWF0b3I6IFBhcnRDcmVhdG9yLCBpc1F1b3RlZE1lc3NhZ2U/OiBib29sZWFuKTogUGFydFtdIHtcbiAgICBjb25zdCBsaW5lcyA9IGJvZHkuc3BsaXQoL1xcclxcbnxcXHJ8XFxuL2cpOyAvLyBzcGxpdCBvbiBhbnkgbmV3LWxpbmUgY29tYmluYXRpb24gbm90IGp1c3QgXFxuLCBjb2xsYXBzZXMgXFxyXFxuXG4gICAgcmV0dXJuIGxpbmVzLnJlZHVjZSgocGFydHMsIGxpbmUsIGkpID0+IHtcbiAgICAgICAgaWYgKGlzUXVvdGVkTWVzc2FnZSkge1xuICAgICAgICAgICAgcGFydHMucHVzaChwYXJ0Q3JlYXRvci5wbGFpbihRVU9URV9MSU5FX1BSRUZJWCkpO1xuICAgICAgICB9XG4gICAgICAgIHBhcnRzLnB1c2goLi4ucGFyc2VBdFJvb21NZW50aW9ucyhsaW5lLCBwYXJ0Q3JlYXRvcikpO1xuICAgICAgICBjb25zdCBpc0xhc3QgPSBpID09PSBsaW5lcy5sZW5ndGggLSAxO1xuICAgICAgICBpZiAoIWlzTGFzdCkge1xuICAgICAgICAgICAgcGFydHMucHVzaChwYXJ0Q3JlYXRvci5uZXdsaW5lKCkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBwYXJ0cztcbiAgICB9LCBbXSBhcyBQYXJ0W10pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VFdmVudChldmVudDogTWF0cml4RXZlbnQsIHBhcnRDcmVhdG9yOiBQYXJ0Q3JlYXRvciwgeyBpc1F1b3RlZE1lc3NhZ2UgPSBmYWxzZSB9ID0ge30pIHtcbiAgICBjb25zdCBjb250ZW50ID0gZXZlbnQuZ2V0Q29udGVudCgpO1xuICAgIGxldCBwYXJ0czogUGFydFtdO1xuICAgIGNvbnN0IGlzRW1vdGUgPSBjb250ZW50Lm1zZ3R5cGUgPT09IFwibS5lbW90ZVwiO1xuICAgIGxldCBpc1JhaW5ib3cgPSBmYWxzZTtcblxuICAgIGlmIChjb250ZW50LmZvcm1hdCA9PT0gXCJvcmcubWF0cml4LmN1c3RvbS5odG1sXCIpIHtcbiAgICAgICAgcGFydHMgPSBwYXJzZUh0bWxNZXNzYWdlKGNvbnRlbnQuZm9ybWF0dGVkX2JvZHkgfHwgXCJcIiwgcGFydENyZWF0b3IsIGlzUXVvdGVkTWVzc2FnZSk7XG4gICAgICAgIGlmIChjb250ZW50LmJvZHkgJiYgY29udGVudC5mb3JtYXR0ZWRfYm9keSAmJiB0ZXh0VG9IdG1sUmFpbmJvdyhjb250ZW50LmJvZHkpID09PSBjb250ZW50LmZvcm1hdHRlZF9ib2R5KSB7XG4gICAgICAgICAgICBpc1JhaW5ib3cgPSB0cnVlO1xuICAgICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcGFydHMgPSBwYXJzZVBsYWluVGV4dE1lc3NhZ2UoY29udGVudC5ib2R5IHx8IFwiXCIsIHBhcnRDcmVhdG9yLCBpc1F1b3RlZE1lc3NhZ2UpO1xuICAgIH1cblxuICAgIGlmIChpc0Vtb3RlICYmIGlzUmFpbmJvdykge1xuICAgICAgICBwYXJ0cy51bnNoaWZ0KHBhcnRDcmVhdG9yLnBsYWluKFwiL3JhaW5ib3dtZSBcIikpO1xuICAgIH0gZWxzZSBpZiAoaXNSYWluYm93KSB7XG4gICAgICAgIHBhcnRzLnVuc2hpZnQocGFydENyZWF0b3IucGxhaW4oXCIvcmFpbmJvdyBcIikpO1xuICAgIH0gZWxzZSBpZiAoaXNFbW90ZSkge1xuICAgICAgICBwYXJ0cy51bnNoaWZ0KHBhcnRDcmVhdG9yLnBsYWluKFwiL21lIFwiKSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHBhcnRzO1xufVxuIl19