"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.formatRangeAsCode = formatRangeAsCode;
exports.formatRangeAsLink = formatRangeAsLink;
exports.formatRangeAsQuote = formatRangeAsQuote;
exports.rangeEndsAtEndOfLine = rangeEndsAtEndOfLine;
exports.rangeStartsAtBeginningOfLine = rangeStartsAtBeginningOfLine;
exports.replaceRangeAndExpandSelection = replaceRangeAndExpandSelection;
exports.replaceRangeAndMoveCaret = replaceRangeAndMoveCaret;
exports.toggleInlineFormat = toggleInlineFormat;

var _parts = require("./parts");

/*
Copyright 2019 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

/**
 * Some common queries and transformations on the editor model
 */
function replaceRangeAndExpandSelection(range, newParts) {
  const {
    model
  } = range;
  model.transform(() => {
    const oldLen = range.length;
    const addedLen = range.replace(newParts);
    const firstOffset = range.start.asOffset(model);
    const lastOffset = firstOffset.add(oldLen + addedLen);
    return model.startRange(firstOffset.asPosition(model), lastOffset.asPosition(model));
  });
}

function replaceRangeAndMoveCaret(range, newParts, offset = 0) {
  const {
    model
  } = range;
  model.transform(() => {
    const oldLen = range.length;
    const addedLen = range.replace(newParts);
    const firstOffset = range.start.asOffset(model);
    const lastOffset = firstOffset.add(oldLen + addedLen + offset);
    return lastOffset.asPosition(model);
  });
}

function rangeStartsAtBeginningOfLine(range) {
  const {
    model
  } = range;
  const startsWithPartial = range.start.offset !== 0;
  const isFirstPart = range.start.index === 0;
  const previousIsNewline = !isFirstPart && model.parts[range.start.index - 1].type === _parts.Type.Newline;
  return !startsWithPartial && (isFirstPart || previousIsNewline);
}

function rangeEndsAtEndOfLine(range) {
  const {
    model
  } = range;
  const lastPart = model.parts[range.end.index];
  const endsWithPartial = range.end.offset !== lastPart.text.length;
  const isLastPart = range.end.index === model.parts.length - 1;
  const nextIsNewline = !isLastPart && model.parts[range.end.index + 1].type === _parts.Type.Newline;
  return !endsWithPartial && (isLastPart || nextIsNewline);
}

function formatRangeAsQuote(range) {
  const {
    model,
    parts
  } = range;
  const {
    partCreator
  } = model;

  for (let i = 0; i < parts.length; ++i) {
    const part = parts[i];

    if (part.type === _parts.Type.Newline) {
      parts.splice(i + 1, 0, partCreator.plain("> "));
    }
  }

  parts.unshift(partCreator.plain("> "));

  if (!rangeStartsAtBeginningOfLine(range)) {
    parts.unshift(partCreator.newline());
  }

  if (!rangeEndsAtEndOfLine(range)) {
    parts.push(partCreator.newline());
  }

  parts.push(partCreator.newline());
  replaceRangeAndExpandSelection(range, parts);
}

function formatRangeAsCode(range) {
  const {
    model,
    parts
  } = range;
  const {
    partCreator
  } = model;
  const needsBlock = parts.some(p => p.type === _parts.Type.Newline);

  if (needsBlock) {
    parts.unshift(partCreator.plain("```"), partCreator.newline());

    if (!rangeStartsAtBeginningOfLine(range)) {
      parts.unshift(partCreator.newline());
    }

    parts.push(partCreator.newline(), partCreator.plain("```"));

    if (!rangeEndsAtEndOfLine(range)) {
      parts.push(partCreator.newline());
    }
  } else {
    parts.unshift(partCreator.plain("`"));
    parts.push(partCreator.plain("`"));
  }

  replaceRangeAndExpandSelection(range, parts);
}

function formatRangeAsLink(range) {
  const {
    model,
    parts
  } = range;
  const {
    partCreator
  } = model;
  parts.unshift(partCreator.plain("["));
  parts.push(partCreator.plain("]()")); // We set offset to -1 here so that the caret lands between the brackets

  replaceRangeAndMoveCaret(range, parts, -1);
} // parts helper methods


const isBlank = part => !part.text || !/\S/.test(part.text);

const isNL = part => part.type === _parts.Type.Newline;

function toggleInlineFormat(range, prefix, suffix = prefix) {
  const {
    model,
    parts
  } = range;
  const {
    partCreator
  } = model; // compute paragraph [start, end] indexes

  const paragraphIndexes = [];
  let startIndex = 0; // start at i=2 because we look at i and up to two parts behind to detect paragraph breaks at their end

  for (let i = 2; i < parts.length; i++) {
    // paragraph breaks can be denoted in a multitude of ways,
    // - 2 newline parts in sequence
    // - newline part, plain(<empty or just spaces>), newline part
    // bump startIndex onto the first non-blank after the paragraph ending
    if (isBlank(parts[i - 2]) && isNL(parts[i - 1]) && !isNL(parts[i]) && !isBlank(parts[i])) {
      startIndex = i;
    } // if at a paragraph break, store the indexes of the paragraph


    if (isNL(parts[i - 1]) && isNL(parts[i])) {
      paragraphIndexes.push([startIndex, i - 1]);
      startIndex = i + 1;
    } else if (isNL(parts[i - 2]) && isBlank(parts[i - 1]) && isNL(parts[i])) {
      paragraphIndexes.push([startIndex, i - 2]);
      startIndex = i + 1;
    }
  }

  const lastNonEmptyPart = parts.map(isBlank).lastIndexOf(false); // If we have not yet included the final paragraph then add it now

  if (startIndex <= lastNonEmptyPart) {
    paragraphIndexes.push([startIndex, lastNonEmptyPart + 1]);
  } // keep track of how many things we have inserted as an offset:=0


  let offset = 0;
  paragraphIndexes.forEach(([startIdx, endIdx]) => {
    // for each paragraph apply the same rule
    const base = startIdx + offset;
    const index = endIdx + offset;
    const isFormatted = index - base > 0 && parts[base].text.startsWith(prefix) && parts[index - 1].text.endsWith(suffix);

    if (isFormatted) {
      // remove prefix and suffix
      const partWithoutPrefix = parts[base].serialize();
      partWithoutPrefix.text = partWithoutPrefix.text.substr(prefix.length);
      parts[base] = partCreator.deserializePart(partWithoutPrefix);
      const partWithoutSuffix = parts[index - 1].serialize();
      const suffixPartText = partWithoutSuffix.text;
      partWithoutSuffix.text = suffixPartText.substring(0, suffixPartText.length - suffix.length);
      parts[index - 1] = partCreator.deserializePart(partWithoutSuffix);
    } else {
      parts.splice(index, 0, partCreator.plain(suffix)); // splice in the later one first to not change offset

      parts.splice(base, 0, partCreator.plain(prefix));
      offset += 2; // offset index to account for the two items we just spliced in
    }
  });
  replaceRangeAndExpandSelection(range, parts);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lZGl0b3Ivb3BlcmF0aW9ucy50cyJdLCJuYW1lcyI6WyJyZXBsYWNlUmFuZ2VBbmRFeHBhbmRTZWxlY3Rpb24iLCJyYW5nZSIsIm5ld1BhcnRzIiwibW9kZWwiLCJ0cmFuc2Zvcm0iLCJvbGRMZW4iLCJsZW5ndGgiLCJhZGRlZExlbiIsInJlcGxhY2UiLCJmaXJzdE9mZnNldCIsInN0YXJ0IiwiYXNPZmZzZXQiLCJsYXN0T2Zmc2V0IiwiYWRkIiwic3RhcnRSYW5nZSIsImFzUG9zaXRpb24iLCJyZXBsYWNlUmFuZ2VBbmRNb3ZlQ2FyZXQiLCJvZmZzZXQiLCJyYW5nZVN0YXJ0c0F0QmVnaW5uaW5nT2ZMaW5lIiwic3RhcnRzV2l0aFBhcnRpYWwiLCJpc0ZpcnN0UGFydCIsImluZGV4IiwicHJldmlvdXNJc05ld2xpbmUiLCJwYXJ0cyIsInR5cGUiLCJUeXBlIiwiTmV3bGluZSIsInJhbmdlRW5kc0F0RW5kT2ZMaW5lIiwibGFzdFBhcnQiLCJlbmQiLCJlbmRzV2l0aFBhcnRpYWwiLCJ0ZXh0IiwiaXNMYXN0UGFydCIsIm5leHRJc05ld2xpbmUiLCJmb3JtYXRSYW5nZUFzUXVvdGUiLCJwYXJ0Q3JlYXRvciIsImkiLCJwYXJ0Iiwic3BsaWNlIiwicGxhaW4iLCJ1bnNoaWZ0IiwibmV3bGluZSIsInB1c2giLCJmb3JtYXRSYW5nZUFzQ29kZSIsIm5lZWRzQmxvY2siLCJzb21lIiwicCIsImZvcm1hdFJhbmdlQXNMaW5rIiwiaXNCbGFuayIsInRlc3QiLCJpc05MIiwidG9nZ2xlSW5saW5lRm9ybWF0IiwicHJlZml4Iiwic3VmZml4IiwicGFyYWdyYXBoSW5kZXhlcyIsInN0YXJ0SW5kZXgiLCJsYXN0Tm9uRW1wdHlQYXJ0IiwibWFwIiwibGFzdEluZGV4T2YiLCJmb3JFYWNoIiwic3RhcnRJZHgiLCJlbmRJZHgiLCJiYXNlIiwiaXNGb3JtYXR0ZWQiLCJzdGFydHNXaXRoIiwiZW5kc1dpdGgiLCJwYXJ0V2l0aG91dFByZWZpeCIsInNlcmlhbGl6ZSIsInN1YnN0ciIsImRlc2VyaWFsaXplUGFydCIsInBhcnRXaXRob3V0U3VmZml4Iiwic3VmZml4UGFydFRleHQiLCJzdWJzdHJpbmciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBaUJBOztBQWpCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBS0E7QUFDQTtBQUNBO0FBRU8sU0FBU0EsOEJBQVQsQ0FBd0NDLEtBQXhDLEVBQXNEQyxRQUF0RCxFQUE4RTtBQUNqRixRQUFNO0FBQUVDLElBQUFBO0FBQUYsTUFBWUYsS0FBbEI7QUFDQUUsRUFBQUEsS0FBSyxDQUFDQyxTQUFOLENBQWdCLE1BQU07QUFDbEIsVUFBTUMsTUFBTSxHQUFHSixLQUFLLENBQUNLLE1BQXJCO0FBQ0EsVUFBTUMsUUFBUSxHQUFHTixLQUFLLENBQUNPLE9BQU4sQ0FBY04sUUFBZCxDQUFqQjtBQUNBLFVBQU1PLFdBQVcsR0FBR1IsS0FBSyxDQUFDUyxLQUFOLENBQVlDLFFBQVosQ0FBcUJSLEtBQXJCLENBQXBCO0FBQ0EsVUFBTVMsVUFBVSxHQUFHSCxXQUFXLENBQUNJLEdBQVosQ0FBZ0JSLE1BQU0sR0FBR0UsUUFBekIsQ0FBbkI7QUFDQSxXQUFPSixLQUFLLENBQUNXLFVBQU4sQ0FBaUJMLFdBQVcsQ0FBQ00sVUFBWixDQUF1QlosS0FBdkIsQ0FBakIsRUFBZ0RTLFVBQVUsQ0FBQ0csVUFBWCxDQUFzQlosS0FBdEIsQ0FBaEQsQ0FBUDtBQUNILEdBTkQ7QUFPSDs7QUFFTSxTQUFTYSx3QkFBVCxDQUFrQ2YsS0FBbEMsRUFBZ0RDLFFBQWhELEVBQWtFZSxNQUFNLEdBQUcsQ0FBM0UsRUFBb0Y7QUFDdkYsUUFBTTtBQUFFZCxJQUFBQTtBQUFGLE1BQVlGLEtBQWxCO0FBQ0FFLEVBQUFBLEtBQUssQ0FBQ0MsU0FBTixDQUFnQixNQUFNO0FBQ2xCLFVBQU1DLE1BQU0sR0FBR0osS0FBSyxDQUFDSyxNQUFyQjtBQUNBLFVBQU1DLFFBQVEsR0FBR04sS0FBSyxDQUFDTyxPQUFOLENBQWNOLFFBQWQsQ0FBakI7QUFDQSxVQUFNTyxXQUFXLEdBQUdSLEtBQUssQ0FBQ1MsS0FBTixDQUFZQyxRQUFaLENBQXFCUixLQUFyQixDQUFwQjtBQUNBLFVBQU1TLFVBQVUsR0FBR0gsV0FBVyxDQUFDSSxHQUFaLENBQWdCUixNQUFNLEdBQUdFLFFBQVQsR0FBb0JVLE1BQXBDLENBQW5CO0FBQ0EsV0FBT0wsVUFBVSxDQUFDRyxVQUFYLENBQXNCWixLQUF0QixDQUFQO0FBQ0gsR0FORDtBQU9IOztBQUVNLFNBQVNlLDRCQUFULENBQXNDakIsS0FBdEMsRUFBNkQ7QUFDaEUsUUFBTTtBQUFFRSxJQUFBQTtBQUFGLE1BQVlGLEtBQWxCO0FBQ0EsUUFBTWtCLGlCQUFpQixHQUFHbEIsS0FBSyxDQUFDUyxLQUFOLENBQVlPLE1BQVosS0FBdUIsQ0FBakQ7QUFDQSxRQUFNRyxXQUFXLEdBQUduQixLQUFLLENBQUNTLEtBQU4sQ0FBWVcsS0FBWixLQUFzQixDQUExQztBQUNBLFFBQU1DLGlCQUFpQixHQUFHLENBQUNGLFdBQUQsSUFBZ0JqQixLQUFLLENBQUNvQixLQUFOLENBQVl0QixLQUFLLENBQUNTLEtBQU4sQ0FBWVcsS0FBWixHQUFvQixDQUFoQyxFQUFtQ0csSUFBbkMsS0FBNENDLFlBQUtDLE9BQTNGO0FBQ0EsU0FBTyxDQUFDUCxpQkFBRCxLQUF1QkMsV0FBVyxJQUFJRSxpQkFBdEMsQ0FBUDtBQUNIOztBQUVNLFNBQVNLLG9CQUFULENBQThCMUIsS0FBOUIsRUFBcUQ7QUFDeEQsUUFBTTtBQUFFRSxJQUFBQTtBQUFGLE1BQVlGLEtBQWxCO0FBQ0EsUUFBTTJCLFFBQVEsR0FBR3pCLEtBQUssQ0FBQ29CLEtBQU4sQ0FBWXRCLEtBQUssQ0FBQzRCLEdBQU4sQ0FBVVIsS0FBdEIsQ0FBakI7QUFDQSxRQUFNUyxlQUFlLEdBQUc3QixLQUFLLENBQUM0QixHQUFOLENBQVVaLE1BQVYsS0FBcUJXLFFBQVEsQ0FBQ0csSUFBVCxDQUFjekIsTUFBM0Q7QUFDQSxRQUFNMEIsVUFBVSxHQUFHL0IsS0FBSyxDQUFDNEIsR0FBTixDQUFVUixLQUFWLEtBQW9CbEIsS0FBSyxDQUFDb0IsS0FBTixDQUFZakIsTUFBWixHQUFxQixDQUE1RDtBQUNBLFFBQU0yQixhQUFhLEdBQUcsQ0FBQ0QsVUFBRCxJQUFlN0IsS0FBSyxDQUFDb0IsS0FBTixDQUFZdEIsS0FBSyxDQUFDNEIsR0FBTixDQUFVUixLQUFWLEdBQWtCLENBQTlCLEVBQWlDRyxJQUFqQyxLQUEwQ0MsWUFBS0MsT0FBcEY7QUFDQSxTQUFPLENBQUNJLGVBQUQsS0FBcUJFLFVBQVUsSUFBSUMsYUFBbkMsQ0FBUDtBQUNIOztBQUVNLFNBQVNDLGtCQUFULENBQTRCakMsS0FBNUIsRUFBZ0Q7QUFDbkQsUUFBTTtBQUFFRSxJQUFBQSxLQUFGO0FBQVNvQixJQUFBQTtBQUFULE1BQW1CdEIsS0FBekI7QUFDQSxRQUFNO0FBQUVrQyxJQUFBQTtBQUFGLE1BQWtCaEMsS0FBeEI7O0FBQ0EsT0FBSyxJQUFJaUMsQ0FBQyxHQUFHLENBQWIsRUFBZ0JBLENBQUMsR0FBR2IsS0FBSyxDQUFDakIsTUFBMUIsRUFBa0MsRUFBRThCLENBQXBDLEVBQXVDO0FBQ25DLFVBQU1DLElBQUksR0FBR2QsS0FBSyxDQUFDYSxDQUFELENBQWxCOztBQUNBLFFBQUlDLElBQUksQ0FBQ2IsSUFBTCxLQUFjQyxZQUFLQyxPQUF2QixFQUFnQztBQUM1QkgsTUFBQUEsS0FBSyxDQUFDZSxNQUFOLENBQWFGLENBQUMsR0FBRyxDQUFqQixFQUFvQixDQUFwQixFQUF1QkQsV0FBVyxDQUFDSSxLQUFaLENBQWtCLElBQWxCLENBQXZCO0FBQ0g7QUFDSjs7QUFDRGhCLEVBQUFBLEtBQUssQ0FBQ2lCLE9BQU4sQ0FBY0wsV0FBVyxDQUFDSSxLQUFaLENBQWtCLElBQWxCLENBQWQ7O0FBQ0EsTUFBSSxDQUFDckIsNEJBQTRCLENBQUNqQixLQUFELENBQWpDLEVBQTBDO0FBQ3RDc0IsSUFBQUEsS0FBSyxDQUFDaUIsT0FBTixDQUFjTCxXQUFXLENBQUNNLE9BQVosRUFBZDtBQUNIOztBQUNELE1BQUksQ0FBQ2Qsb0JBQW9CLENBQUMxQixLQUFELENBQXpCLEVBQWtDO0FBQzlCc0IsSUFBQUEsS0FBSyxDQUFDbUIsSUFBTixDQUFXUCxXQUFXLENBQUNNLE9BQVosRUFBWDtBQUNIOztBQUVEbEIsRUFBQUEsS0FBSyxDQUFDbUIsSUFBTixDQUFXUCxXQUFXLENBQUNNLE9BQVosRUFBWDtBQUNBekMsRUFBQUEsOEJBQThCLENBQUNDLEtBQUQsRUFBUXNCLEtBQVIsQ0FBOUI7QUFDSDs7QUFFTSxTQUFTb0IsaUJBQVQsQ0FBMkIxQyxLQUEzQixFQUErQztBQUNsRCxRQUFNO0FBQUVFLElBQUFBLEtBQUY7QUFBU29CLElBQUFBO0FBQVQsTUFBbUJ0QixLQUF6QjtBQUNBLFFBQU07QUFBRWtDLElBQUFBO0FBQUYsTUFBa0JoQyxLQUF4QjtBQUNBLFFBQU15QyxVQUFVLEdBQUdyQixLQUFLLENBQUNzQixJQUFOLENBQVdDLENBQUMsSUFBSUEsQ0FBQyxDQUFDdEIsSUFBRixLQUFXQyxZQUFLQyxPQUFoQyxDQUFuQjs7QUFDQSxNQUFJa0IsVUFBSixFQUFnQjtBQUNackIsSUFBQUEsS0FBSyxDQUFDaUIsT0FBTixDQUFjTCxXQUFXLENBQUNJLEtBQVosQ0FBa0IsS0FBbEIsQ0FBZCxFQUF3Q0osV0FBVyxDQUFDTSxPQUFaLEVBQXhDOztBQUNBLFFBQUksQ0FBQ3ZCLDRCQUE0QixDQUFDakIsS0FBRCxDQUFqQyxFQUEwQztBQUN0Q3NCLE1BQUFBLEtBQUssQ0FBQ2lCLE9BQU4sQ0FBY0wsV0FBVyxDQUFDTSxPQUFaLEVBQWQ7QUFDSDs7QUFDRGxCLElBQUFBLEtBQUssQ0FBQ21CLElBQU4sQ0FDSVAsV0FBVyxDQUFDTSxPQUFaLEVBREosRUFFSU4sV0FBVyxDQUFDSSxLQUFaLENBQWtCLEtBQWxCLENBRko7O0FBR0EsUUFBSSxDQUFDWixvQkFBb0IsQ0FBQzFCLEtBQUQsQ0FBekIsRUFBa0M7QUFDOUJzQixNQUFBQSxLQUFLLENBQUNtQixJQUFOLENBQVdQLFdBQVcsQ0FBQ00sT0FBWixFQUFYO0FBQ0g7QUFDSixHQVhELE1BV087QUFDSGxCLElBQUFBLEtBQUssQ0FBQ2lCLE9BQU4sQ0FBY0wsV0FBVyxDQUFDSSxLQUFaLENBQWtCLEdBQWxCLENBQWQ7QUFDQWhCLElBQUFBLEtBQUssQ0FBQ21CLElBQU4sQ0FBV1AsV0FBVyxDQUFDSSxLQUFaLENBQWtCLEdBQWxCLENBQVg7QUFDSDs7QUFDRHZDLEVBQUFBLDhCQUE4QixDQUFDQyxLQUFELEVBQVFzQixLQUFSLENBQTlCO0FBQ0g7O0FBRU0sU0FBU3dCLGlCQUFULENBQTJCOUMsS0FBM0IsRUFBeUM7QUFDNUMsUUFBTTtBQUFFRSxJQUFBQSxLQUFGO0FBQVNvQixJQUFBQTtBQUFULE1BQW1CdEIsS0FBekI7QUFDQSxRQUFNO0FBQUVrQyxJQUFBQTtBQUFGLE1BQWtCaEMsS0FBeEI7QUFDQW9CLEVBQUFBLEtBQUssQ0FBQ2lCLE9BQU4sQ0FBY0wsV0FBVyxDQUFDSSxLQUFaLENBQWtCLEdBQWxCLENBQWQ7QUFDQWhCLEVBQUFBLEtBQUssQ0FBQ21CLElBQU4sQ0FBV1AsV0FBVyxDQUFDSSxLQUFaLENBQWtCLEtBQWxCLENBQVgsRUFKNEMsQ0FLNUM7O0FBQ0F2QixFQUFBQSx3QkFBd0IsQ0FBQ2YsS0FBRCxFQUFRc0IsS0FBUixFQUFlLENBQUMsQ0FBaEIsQ0FBeEI7QUFDSCxDLENBRUQ7OztBQUNBLE1BQU15QixPQUFPLEdBQUdYLElBQUksSUFBSSxDQUFDQSxJQUFJLENBQUNOLElBQU4sSUFBYyxDQUFDLEtBQUtrQixJQUFMLENBQVVaLElBQUksQ0FBQ04sSUFBZixDQUF2Qzs7QUFDQSxNQUFNbUIsSUFBSSxHQUFHYixJQUFJLElBQUlBLElBQUksQ0FBQ2IsSUFBTCxLQUFjQyxZQUFLQyxPQUF4Qzs7QUFFTyxTQUFTeUIsa0JBQVQsQ0FBNEJsRCxLQUE1QixFQUEwQ21ELE1BQTFDLEVBQTBEQyxNQUFNLEdBQUdELE1BQW5FLEVBQWlGO0FBQ3BGLFFBQU07QUFBRWpELElBQUFBLEtBQUY7QUFBU29CLElBQUFBO0FBQVQsTUFBbUJ0QixLQUF6QjtBQUNBLFFBQU07QUFBRWtDLElBQUFBO0FBQUYsTUFBa0JoQyxLQUF4QixDQUZvRixDQUlwRjs7QUFDQSxRQUFNbUQsZ0JBQWdCLEdBQUcsRUFBekI7QUFDQSxNQUFJQyxVQUFVLEdBQUcsQ0FBakIsQ0FOb0YsQ0FPcEY7O0FBQ0EsT0FBSyxJQUFJbkIsQ0FBQyxHQUFHLENBQWIsRUFBZ0JBLENBQUMsR0FBR2IsS0FBSyxDQUFDakIsTUFBMUIsRUFBa0M4QixDQUFDLEVBQW5DLEVBQXVDO0FBQ25DO0FBQ0E7QUFDQTtBQUVBO0FBQ0EsUUFBSVksT0FBTyxDQUFDekIsS0FBSyxDQUFDYSxDQUFDLEdBQUcsQ0FBTCxDQUFOLENBQVAsSUFBeUJjLElBQUksQ0FBQzNCLEtBQUssQ0FBQ2EsQ0FBQyxHQUFHLENBQUwsQ0FBTixDQUE3QixJQUErQyxDQUFDYyxJQUFJLENBQUMzQixLQUFLLENBQUNhLENBQUQsQ0FBTixDQUFwRCxJQUFrRSxDQUFDWSxPQUFPLENBQUN6QixLQUFLLENBQUNhLENBQUQsQ0FBTixDQUE5RSxFQUEwRjtBQUN0Rm1CLE1BQUFBLFVBQVUsR0FBR25CLENBQWI7QUFDSCxLQVJrQyxDQVVuQzs7O0FBQ0EsUUFBSWMsSUFBSSxDQUFDM0IsS0FBSyxDQUFDYSxDQUFDLEdBQUcsQ0FBTCxDQUFOLENBQUosSUFBc0JjLElBQUksQ0FBQzNCLEtBQUssQ0FBQ2EsQ0FBRCxDQUFOLENBQTlCLEVBQTBDO0FBQ3RDa0IsTUFBQUEsZ0JBQWdCLENBQUNaLElBQWpCLENBQXNCLENBQUNhLFVBQUQsRUFBYW5CLENBQUMsR0FBRyxDQUFqQixDQUF0QjtBQUNBbUIsTUFBQUEsVUFBVSxHQUFHbkIsQ0FBQyxHQUFHLENBQWpCO0FBQ0gsS0FIRCxNQUdPLElBQUljLElBQUksQ0FBQzNCLEtBQUssQ0FBQ2EsQ0FBQyxHQUFHLENBQUwsQ0FBTixDQUFKLElBQXNCWSxPQUFPLENBQUN6QixLQUFLLENBQUNhLENBQUMsR0FBRyxDQUFMLENBQU4sQ0FBN0IsSUFBK0NjLElBQUksQ0FBQzNCLEtBQUssQ0FBQ2EsQ0FBRCxDQUFOLENBQXZELEVBQW1FO0FBQ3RFa0IsTUFBQUEsZ0JBQWdCLENBQUNaLElBQWpCLENBQXNCLENBQUNhLFVBQUQsRUFBYW5CLENBQUMsR0FBRyxDQUFqQixDQUF0QjtBQUNBbUIsTUFBQUEsVUFBVSxHQUFHbkIsQ0FBQyxHQUFHLENBQWpCO0FBQ0g7QUFDSjs7QUFFRCxRQUFNb0IsZ0JBQWdCLEdBQUdqQyxLQUFLLENBQUNrQyxHQUFOLENBQVVULE9BQVYsRUFBbUJVLFdBQW5CLENBQStCLEtBQS9CLENBQXpCLENBNUJvRixDQTZCcEY7O0FBQ0EsTUFBSUgsVUFBVSxJQUFJQyxnQkFBbEIsRUFBb0M7QUFDaENGLElBQUFBLGdCQUFnQixDQUFDWixJQUFqQixDQUFzQixDQUFDYSxVQUFELEVBQWFDLGdCQUFnQixHQUFHLENBQWhDLENBQXRCO0FBQ0gsR0FoQ21GLENBa0NwRjs7O0FBQ0EsTUFBSXZDLE1BQU0sR0FBRyxDQUFiO0FBQ0FxQyxFQUFBQSxnQkFBZ0IsQ0FBQ0ssT0FBakIsQ0FBeUIsQ0FBQyxDQUFDQyxRQUFELEVBQVdDLE1BQVgsQ0FBRCxLQUF3QjtBQUM3QztBQUNBLFVBQU1DLElBQUksR0FBR0YsUUFBUSxHQUFHM0MsTUFBeEI7QUFDQSxVQUFNSSxLQUFLLEdBQUd3QyxNQUFNLEdBQUc1QyxNQUF2QjtBQUVBLFVBQU04QyxXQUFXLEdBQUkxQyxLQUFLLEdBQUd5QyxJQUFSLEdBQWUsQ0FBaEIsSUFDaEJ2QyxLQUFLLENBQUN1QyxJQUFELENBQUwsQ0FBWS9CLElBQVosQ0FBaUJpQyxVQUFqQixDQUE0QlosTUFBNUIsQ0FEZ0IsSUFFaEI3QixLQUFLLENBQUNGLEtBQUssR0FBRyxDQUFULENBQUwsQ0FBaUJVLElBQWpCLENBQXNCa0MsUUFBdEIsQ0FBK0JaLE1BQS9CLENBRko7O0FBSUEsUUFBSVUsV0FBSixFQUFpQjtBQUNiO0FBQ0EsWUFBTUcsaUJBQWlCLEdBQUczQyxLQUFLLENBQUN1QyxJQUFELENBQUwsQ0FBWUssU0FBWixFQUExQjtBQUNBRCxNQUFBQSxpQkFBaUIsQ0FBQ25DLElBQWxCLEdBQXlCbUMsaUJBQWlCLENBQUNuQyxJQUFsQixDQUF1QnFDLE1BQXZCLENBQThCaEIsTUFBTSxDQUFDOUMsTUFBckMsQ0FBekI7QUFDQWlCLE1BQUFBLEtBQUssQ0FBQ3VDLElBQUQsQ0FBTCxHQUFjM0IsV0FBVyxDQUFDa0MsZUFBWixDQUE0QkgsaUJBQTVCLENBQWQ7QUFFQSxZQUFNSSxpQkFBaUIsR0FBRy9DLEtBQUssQ0FBQ0YsS0FBSyxHQUFHLENBQVQsQ0FBTCxDQUFpQjhDLFNBQWpCLEVBQTFCO0FBQ0EsWUFBTUksY0FBYyxHQUFHRCxpQkFBaUIsQ0FBQ3ZDLElBQXpDO0FBQ0F1QyxNQUFBQSxpQkFBaUIsQ0FBQ3ZDLElBQWxCLEdBQXlCd0MsY0FBYyxDQUFDQyxTQUFmLENBQXlCLENBQXpCLEVBQTRCRCxjQUFjLENBQUNqRSxNQUFmLEdBQXdCK0MsTUFBTSxDQUFDL0MsTUFBM0QsQ0FBekI7QUFDQWlCLE1BQUFBLEtBQUssQ0FBQ0YsS0FBSyxHQUFHLENBQVQsQ0FBTCxHQUFtQmMsV0FBVyxDQUFDa0MsZUFBWixDQUE0QkMsaUJBQTVCLENBQW5CO0FBQ0gsS0FWRCxNQVVPO0FBQ0gvQyxNQUFBQSxLQUFLLENBQUNlLE1BQU4sQ0FBYWpCLEtBQWIsRUFBb0IsQ0FBcEIsRUFBdUJjLFdBQVcsQ0FBQ0ksS0FBWixDQUFrQmMsTUFBbEIsQ0FBdkIsRUFERyxDQUNnRDs7QUFDbkQ5QixNQUFBQSxLQUFLLENBQUNlLE1BQU4sQ0FBYXdCLElBQWIsRUFBbUIsQ0FBbkIsRUFBc0IzQixXQUFXLENBQUNJLEtBQVosQ0FBa0JhLE1BQWxCLENBQXRCO0FBQ0FuQyxNQUFBQSxNQUFNLElBQUksQ0FBVixDQUhHLENBR1U7QUFDaEI7QUFDSixHQXhCRDtBQTBCQWpCLEVBQUFBLDhCQUE4QixDQUFDQyxLQUFELEVBQVFzQixLQUFSLENBQTlCO0FBQ0giLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTkgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmFuZ2UgZnJvbSBcIi4vcmFuZ2VcIjtcbmltcG9ydCB7IFBhcnQsIFR5cGUgfSBmcm9tIFwiLi9wYXJ0c1wiO1xuXG4vKipcbiAqIFNvbWUgY29tbW9uIHF1ZXJpZXMgYW5kIHRyYW5zZm9ybWF0aW9ucyBvbiB0aGUgZWRpdG9yIG1vZGVsXG4gKi9cblxuZXhwb3J0IGZ1bmN0aW9uIHJlcGxhY2VSYW5nZUFuZEV4cGFuZFNlbGVjdGlvbihyYW5nZTogUmFuZ2UsIG5ld1BhcnRzOiBQYXJ0W10pOiB2b2lkIHtcbiAgICBjb25zdCB7IG1vZGVsIH0gPSByYW5nZTtcbiAgICBtb2RlbC50cmFuc2Zvcm0oKCkgPT4ge1xuICAgICAgICBjb25zdCBvbGRMZW4gPSByYW5nZS5sZW5ndGg7XG4gICAgICAgIGNvbnN0IGFkZGVkTGVuID0gcmFuZ2UucmVwbGFjZShuZXdQYXJ0cyk7XG4gICAgICAgIGNvbnN0IGZpcnN0T2Zmc2V0ID0gcmFuZ2Uuc3RhcnQuYXNPZmZzZXQobW9kZWwpO1xuICAgICAgICBjb25zdCBsYXN0T2Zmc2V0ID0gZmlyc3RPZmZzZXQuYWRkKG9sZExlbiArIGFkZGVkTGVuKTtcbiAgICAgICAgcmV0dXJuIG1vZGVsLnN0YXJ0UmFuZ2UoZmlyc3RPZmZzZXQuYXNQb3NpdGlvbihtb2RlbCksIGxhc3RPZmZzZXQuYXNQb3NpdGlvbihtb2RlbCkpO1xuICAgIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVwbGFjZVJhbmdlQW5kTW92ZUNhcmV0KHJhbmdlOiBSYW5nZSwgbmV3UGFydHM6IFBhcnRbXSwgb2Zmc2V0ID0gMCk6IHZvaWQge1xuICAgIGNvbnN0IHsgbW9kZWwgfSA9IHJhbmdlO1xuICAgIG1vZGVsLnRyYW5zZm9ybSgoKSA9PiB7XG4gICAgICAgIGNvbnN0IG9sZExlbiA9IHJhbmdlLmxlbmd0aDtcbiAgICAgICAgY29uc3QgYWRkZWRMZW4gPSByYW5nZS5yZXBsYWNlKG5ld1BhcnRzKTtcbiAgICAgICAgY29uc3QgZmlyc3RPZmZzZXQgPSByYW5nZS5zdGFydC5hc09mZnNldChtb2RlbCk7XG4gICAgICAgIGNvbnN0IGxhc3RPZmZzZXQgPSBmaXJzdE9mZnNldC5hZGQob2xkTGVuICsgYWRkZWRMZW4gKyBvZmZzZXQpO1xuICAgICAgICByZXR1cm4gbGFzdE9mZnNldC5hc1Bvc2l0aW9uKG1vZGVsKTtcbiAgICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJhbmdlU3RhcnRzQXRCZWdpbm5pbmdPZkxpbmUocmFuZ2U6IFJhbmdlKTogYm9vbGVhbiB7XG4gICAgY29uc3QgeyBtb2RlbCB9ID0gcmFuZ2U7XG4gICAgY29uc3Qgc3RhcnRzV2l0aFBhcnRpYWwgPSByYW5nZS5zdGFydC5vZmZzZXQgIT09IDA7XG4gICAgY29uc3QgaXNGaXJzdFBhcnQgPSByYW5nZS5zdGFydC5pbmRleCA9PT0gMDtcbiAgICBjb25zdCBwcmV2aW91c0lzTmV3bGluZSA9ICFpc0ZpcnN0UGFydCAmJiBtb2RlbC5wYXJ0c1tyYW5nZS5zdGFydC5pbmRleCAtIDFdLnR5cGUgPT09IFR5cGUuTmV3bGluZTtcbiAgICByZXR1cm4gIXN0YXJ0c1dpdGhQYXJ0aWFsICYmIChpc0ZpcnN0UGFydCB8fCBwcmV2aW91c0lzTmV3bGluZSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByYW5nZUVuZHNBdEVuZE9mTGluZShyYW5nZTogUmFuZ2UpOiBib29sZWFuIHtcbiAgICBjb25zdCB7IG1vZGVsIH0gPSByYW5nZTtcbiAgICBjb25zdCBsYXN0UGFydCA9IG1vZGVsLnBhcnRzW3JhbmdlLmVuZC5pbmRleF07XG4gICAgY29uc3QgZW5kc1dpdGhQYXJ0aWFsID0gcmFuZ2UuZW5kLm9mZnNldCAhPT0gbGFzdFBhcnQudGV4dC5sZW5ndGg7XG4gICAgY29uc3QgaXNMYXN0UGFydCA9IHJhbmdlLmVuZC5pbmRleCA9PT0gbW9kZWwucGFydHMubGVuZ3RoIC0gMTtcbiAgICBjb25zdCBuZXh0SXNOZXdsaW5lID0gIWlzTGFzdFBhcnQgJiYgbW9kZWwucGFydHNbcmFuZ2UuZW5kLmluZGV4ICsgMV0udHlwZSA9PT0gVHlwZS5OZXdsaW5lO1xuICAgIHJldHVybiAhZW5kc1dpdGhQYXJ0aWFsICYmIChpc0xhc3RQYXJ0IHx8IG5leHRJc05ld2xpbmUpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZm9ybWF0UmFuZ2VBc1F1b3RlKHJhbmdlOiBSYW5nZSk6IHZvaWQge1xuICAgIGNvbnN0IHsgbW9kZWwsIHBhcnRzIH0gPSByYW5nZTtcbiAgICBjb25zdCB7IHBhcnRDcmVhdG9yIH0gPSBtb2RlbDtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aDsgKytpKSB7XG4gICAgICAgIGNvbnN0IHBhcnQgPSBwYXJ0c1tpXTtcbiAgICAgICAgaWYgKHBhcnQudHlwZSA9PT0gVHlwZS5OZXdsaW5lKSB7XG4gICAgICAgICAgICBwYXJ0cy5zcGxpY2UoaSArIDEsIDAsIHBhcnRDcmVhdG9yLnBsYWluKFwiPiBcIikpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHBhcnRzLnVuc2hpZnQocGFydENyZWF0b3IucGxhaW4oXCI+IFwiKSk7XG4gICAgaWYgKCFyYW5nZVN0YXJ0c0F0QmVnaW5uaW5nT2ZMaW5lKHJhbmdlKSkge1xuICAgICAgICBwYXJ0cy51bnNoaWZ0KHBhcnRDcmVhdG9yLm5ld2xpbmUoKSk7XG4gICAgfVxuICAgIGlmICghcmFuZ2VFbmRzQXRFbmRPZkxpbmUocmFuZ2UpKSB7XG4gICAgICAgIHBhcnRzLnB1c2gocGFydENyZWF0b3IubmV3bGluZSgpKTtcbiAgICB9XG5cbiAgICBwYXJ0cy5wdXNoKHBhcnRDcmVhdG9yLm5ld2xpbmUoKSk7XG4gICAgcmVwbGFjZVJhbmdlQW5kRXhwYW5kU2VsZWN0aW9uKHJhbmdlLCBwYXJ0cyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmb3JtYXRSYW5nZUFzQ29kZShyYW5nZTogUmFuZ2UpOiB2b2lkIHtcbiAgICBjb25zdCB7IG1vZGVsLCBwYXJ0cyB9ID0gcmFuZ2U7XG4gICAgY29uc3QgeyBwYXJ0Q3JlYXRvciB9ID0gbW9kZWw7XG4gICAgY29uc3QgbmVlZHNCbG9jayA9IHBhcnRzLnNvbWUocCA9PiBwLnR5cGUgPT09IFR5cGUuTmV3bGluZSk7XG4gICAgaWYgKG5lZWRzQmxvY2spIHtcbiAgICAgICAgcGFydHMudW5zaGlmdChwYXJ0Q3JlYXRvci5wbGFpbihcImBgYFwiKSwgcGFydENyZWF0b3IubmV3bGluZSgpKTtcbiAgICAgICAgaWYgKCFyYW5nZVN0YXJ0c0F0QmVnaW5uaW5nT2ZMaW5lKHJhbmdlKSkge1xuICAgICAgICAgICAgcGFydHMudW5zaGlmdChwYXJ0Q3JlYXRvci5uZXdsaW5lKCkpO1xuICAgICAgICB9XG4gICAgICAgIHBhcnRzLnB1c2goXG4gICAgICAgICAgICBwYXJ0Q3JlYXRvci5uZXdsaW5lKCksXG4gICAgICAgICAgICBwYXJ0Q3JlYXRvci5wbGFpbihcImBgYFwiKSk7XG4gICAgICAgIGlmICghcmFuZ2VFbmRzQXRFbmRPZkxpbmUocmFuZ2UpKSB7XG4gICAgICAgICAgICBwYXJ0cy5wdXNoKHBhcnRDcmVhdG9yLm5ld2xpbmUoKSk7XG4gICAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgICBwYXJ0cy51bnNoaWZ0KHBhcnRDcmVhdG9yLnBsYWluKFwiYFwiKSk7XG4gICAgICAgIHBhcnRzLnB1c2gocGFydENyZWF0b3IucGxhaW4oXCJgXCIpKTtcbiAgICB9XG4gICAgcmVwbGFjZVJhbmdlQW5kRXhwYW5kU2VsZWN0aW9uKHJhbmdlLCBwYXJ0cyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmb3JtYXRSYW5nZUFzTGluayhyYW5nZTogUmFuZ2UpIHtcbiAgICBjb25zdCB7IG1vZGVsLCBwYXJ0cyB9ID0gcmFuZ2U7XG4gICAgY29uc3QgeyBwYXJ0Q3JlYXRvciB9ID0gbW9kZWw7XG4gICAgcGFydHMudW5zaGlmdChwYXJ0Q3JlYXRvci5wbGFpbihcIltcIikpO1xuICAgIHBhcnRzLnB1c2gocGFydENyZWF0b3IucGxhaW4oXCJdKClcIikpO1xuICAgIC8vIFdlIHNldCBvZmZzZXQgdG8gLTEgaGVyZSBzbyB0aGF0IHRoZSBjYXJldCBsYW5kcyBiZXR3ZWVuIHRoZSBicmFja2V0c1xuICAgIHJlcGxhY2VSYW5nZUFuZE1vdmVDYXJldChyYW5nZSwgcGFydHMsIC0xKTtcbn1cblxuLy8gcGFydHMgaGVscGVyIG1ldGhvZHNcbmNvbnN0IGlzQmxhbmsgPSBwYXJ0ID0+ICFwYXJ0LnRleHQgfHwgIS9cXFMvLnRlc3QocGFydC50ZXh0KTtcbmNvbnN0IGlzTkwgPSBwYXJ0ID0+IHBhcnQudHlwZSA9PT0gVHlwZS5OZXdsaW5lO1xuXG5leHBvcnQgZnVuY3Rpb24gdG9nZ2xlSW5saW5lRm9ybWF0KHJhbmdlOiBSYW5nZSwgcHJlZml4OiBzdHJpbmcsIHN1ZmZpeCA9IHByZWZpeCk6IHZvaWQge1xuICAgIGNvbnN0IHsgbW9kZWwsIHBhcnRzIH0gPSByYW5nZTtcbiAgICBjb25zdCB7IHBhcnRDcmVhdG9yIH0gPSBtb2RlbDtcblxuICAgIC8vIGNvbXB1dGUgcGFyYWdyYXBoIFtzdGFydCwgZW5kXSBpbmRleGVzXG4gICAgY29uc3QgcGFyYWdyYXBoSW5kZXhlcyA9IFtdO1xuICAgIGxldCBzdGFydEluZGV4ID0gMDtcbiAgICAvLyBzdGFydCBhdCBpPTIgYmVjYXVzZSB3ZSBsb29rIGF0IGkgYW5kIHVwIHRvIHR3byBwYXJ0cyBiZWhpbmQgdG8gZGV0ZWN0IHBhcmFncmFwaCBicmVha3MgYXQgdGhlaXIgZW5kXG4gICAgZm9yIChsZXQgaSA9IDI7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAvLyBwYXJhZ3JhcGggYnJlYWtzIGNhbiBiZSBkZW5vdGVkIGluIGEgbXVsdGl0dWRlIG9mIHdheXMsXG4gICAgICAgIC8vIC0gMiBuZXdsaW5lIHBhcnRzIGluIHNlcXVlbmNlXG4gICAgICAgIC8vIC0gbmV3bGluZSBwYXJ0LCBwbGFpbig8ZW1wdHkgb3IganVzdCBzcGFjZXM+KSwgbmV3bGluZSBwYXJ0XG5cbiAgICAgICAgLy8gYnVtcCBzdGFydEluZGV4IG9udG8gdGhlIGZpcnN0IG5vbi1ibGFuayBhZnRlciB0aGUgcGFyYWdyYXBoIGVuZGluZ1xuICAgICAgICBpZiAoaXNCbGFuayhwYXJ0c1tpIC0gMl0pICYmIGlzTkwocGFydHNbaSAtIDFdKSAmJiAhaXNOTChwYXJ0c1tpXSkgJiYgIWlzQmxhbmsocGFydHNbaV0pKSB7XG4gICAgICAgICAgICBzdGFydEluZGV4ID0gaTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGlmIGF0IGEgcGFyYWdyYXBoIGJyZWFrLCBzdG9yZSB0aGUgaW5kZXhlcyBvZiB0aGUgcGFyYWdyYXBoXG4gICAgICAgIGlmIChpc05MKHBhcnRzW2kgLSAxXSkgJiYgaXNOTChwYXJ0c1tpXSkpIHtcbiAgICAgICAgICAgIHBhcmFncmFwaEluZGV4ZXMucHVzaChbc3RhcnRJbmRleCwgaSAtIDFdKTtcbiAgICAgICAgICAgIHN0YXJ0SW5kZXggPSBpICsgMTtcbiAgICAgICAgfSBlbHNlIGlmIChpc05MKHBhcnRzW2kgLSAyXSkgJiYgaXNCbGFuayhwYXJ0c1tpIC0gMV0pICYmIGlzTkwocGFydHNbaV0pKSB7XG4gICAgICAgICAgICBwYXJhZ3JhcGhJbmRleGVzLnB1c2goW3N0YXJ0SW5kZXgsIGkgLSAyXSk7XG4gICAgICAgICAgICBzdGFydEluZGV4ID0gaSArIDE7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBsYXN0Tm9uRW1wdHlQYXJ0ID0gcGFydHMubWFwKGlzQmxhbmspLmxhc3RJbmRleE9mKGZhbHNlKTtcbiAgICAvLyBJZiB3ZSBoYXZlIG5vdCB5ZXQgaW5jbHVkZWQgdGhlIGZpbmFsIHBhcmFncmFwaCB0aGVuIGFkZCBpdCBub3dcbiAgICBpZiAoc3RhcnRJbmRleCA8PSBsYXN0Tm9uRW1wdHlQYXJ0KSB7XG4gICAgICAgIHBhcmFncmFwaEluZGV4ZXMucHVzaChbc3RhcnRJbmRleCwgbGFzdE5vbkVtcHR5UGFydCArIDFdKTtcbiAgICB9XG5cbiAgICAvLyBrZWVwIHRyYWNrIG9mIGhvdyBtYW55IHRoaW5ncyB3ZSBoYXZlIGluc2VydGVkIGFzIGFuIG9mZnNldDo9MFxuICAgIGxldCBvZmZzZXQgPSAwO1xuICAgIHBhcmFncmFwaEluZGV4ZXMuZm9yRWFjaCgoW3N0YXJ0SWR4LCBlbmRJZHhdKSA9PiB7XG4gICAgICAgIC8vIGZvciBlYWNoIHBhcmFncmFwaCBhcHBseSB0aGUgc2FtZSBydWxlXG4gICAgICAgIGNvbnN0IGJhc2UgPSBzdGFydElkeCArIG9mZnNldDtcbiAgICAgICAgY29uc3QgaW5kZXggPSBlbmRJZHggKyBvZmZzZXQ7XG5cbiAgICAgICAgY29uc3QgaXNGb3JtYXR0ZWQgPSAoaW5kZXggLSBiYXNlID4gMCkgJiZcbiAgICAgICAgICAgIHBhcnRzW2Jhc2VdLnRleHQuc3RhcnRzV2l0aChwcmVmaXgpICYmXG4gICAgICAgICAgICBwYXJ0c1tpbmRleCAtIDFdLnRleHQuZW5kc1dpdGgoc3VmZml4KTtcblxuICAgICAgICBpZiAoaXNGb3JtYXR0ZWQpIHtcbiAgICAgICAgICAgIC8vIHJlbW92ZSBwcmVmaXggYW5kIHN1ZmZpeFxuICAgICAgICAgICAgY29uc3QgcGFydFdpdGhvdXRQcmVmaXggPSBwYXJ0c1tiYXNlXS5zZXJpYWxpemUoKTtcbiAgICAgICAgICAgIHBhcnRXaXRob3V0UHJlZml4LnRleHQgPSBwYXJ0V2l0aG91dFByZWZpeC50ZXh0LnN1YnN0cihwcmVmaXgubGVuZ3RoKTtcbiAgICAgICAgICAgIHBhcnRzW2Jhc2VdID0gcGFydENyZWF0b3IuZGVzZXJpYWxpemVQYXJ0KHBhcnRXaXRob3V0UHJlZml4KTtcblxuICAgICAgICAgICAgY29uc3QgcGFydFdpdGhvdXRTdWZmaXggPSBwYXJ0c1tpbmRleCAtIDFdLnNlcmlhbGl6ZSgpO1xuICAgICAgICAgICAgY29uc3Qgc3VmZml4UGFydFRleHQgPSBwYXJ0V2l0aG91dFN1ZmZpeC50ZXh0O1xuICAgICAgICAgICAgcGFydFdpdGhvdXRTdWZmaXgudGV4dCA9IHN1ZmZpeFBhcnRUZXh0LnN1YnN0cmluZygwLCBzdWZmaXhQYXJ0VGV4dC5sZW5ndGggLSBzdWZmaXgubGVuZ3RoKTtcbiAgICAgICAgICAgIHBhcnRzW2luZGV4IC0gMV0gPSBwYXJ0Q3JlYXRvci5kZXNlcmlhbGl6ZVBhcnQocGFydFdpdGhvdXRTdWZmaXgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcGFydHMuc3BsaWNlKGluZGV4LCAwLCBwYXJ0Q3JlYXRvci5wbGFpbihzdWZmaXgpKTsgLy8gc3BsaWNlIGluIHRoZSBsYXRlciBvbmUgZmlyc3QgdG8gbm90IGNoYW5nZSBvZmZzZXRcbiAgICAgICAgICAgIHBhcnRzLnNwbGljZShiYXNlLCAwLCBwYXJ0Q3JlYXRvci5wbGFpbihwcmVmaXgpKTtcbiAgICAgICAgICAgIG9mZnNldCArPSAyOyAvLyBvZmZzZXQgaW5kZXggdG8gYWNjb3VudCBmb3IgdGhlIHR3byBpdGVtcyB3ZSBqdXN0IHNwbGljZWQgaW5cbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmVwbGFjZVJhbmdlQW5kRXhwYW5kU2VsZWN0aW9uKHJhbmdlLCBwYXJ0cyk7XG59XG4iXX0=