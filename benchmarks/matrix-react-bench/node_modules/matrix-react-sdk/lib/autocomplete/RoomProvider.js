"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _lodash = require("lodash");

var _languageHandler = require("../languageHandler");

var _AutocompleteProvider = _interopRequireDefault(require("./AutocompleteProvider"));

var _MatrixClientPeg = require("../MatrixClientPeg");

var _QueryMatcher = _interopRequireDefault(require("./QueryMatcher"));

var _Components = require("./Components");

var _Permalinks = require("../utils/permalinks/Permalinks");

var _RoomAvatar = _interopRequireDefault(require("../components/views/avatars/RoomAvatar"));

var _SpaceStore = _interopRequireDefault(require("../stores/spaces/SpaceStore"));

/*
Copyright 2016 Aviral Dasgupta
Copyright 2018 Michael Telatynski <7t3chguy@gmail.com>
Copyright 2017, 2018, 2021 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const ROOM_REGEX = /\B#\S*/g; // Prefer canonical aliases over non-canonical ones

function canonicalScore(displayedAlias, room) {
  return displayedAlias === room.getCanonicalAlias() ? 0 : 1;
}

function matcherObject(room, displayedAlias, matchName = "") {
  return {
    room,
    matchName,
    displayedAlias
  };
}

class RoomProvider extends _AutocompleteProvider.default {
  constructor(room, renderingType) {
    super({
      commandRegex: ROOM_REGEX,
      renderingType
    });
    (0, _defineProperty2.default)(this, "matcher", void 0);
    this.matcher = new _QueryMatcher.default([], {
      keys: ['displayedAlias', 'matchName']
    });
  }

  getRooms() {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    let rooms = cli.getVisibleRooms(); // if spaces are enabled then filter them out here as they get their own autocomplete provider

    if (_SpaceStore.default.spacesEnabled) {
      rooms = rooms.filter(r => !r.isSpaceRoom());
    }

    return rooms;
  }

  async getCompletions(query, selection, force = false, limit = -1) {
    let completions = [];
    const {
      command,
      range
    } = this.getCurrentCommand(query, selection, force);

    if (command) {
      // the only reason we need to do this is because Fuse only matches on properties
      let matcherObjects = this.getRooms().reduce((aliases, room) => {
        if (room.getCanonicalAlias()) {
          aliases = aliases.concat(matcherObject(room, room.getCanonicalAlias(), room.name));
        }

        if (room.getAltAliases().length) {
          const altAliases = room.getAltAliases().map(alias => matcherObject(room, alias));
          aliases = aliases.concat(altAliases);
        }

        return aliases;
      }, []); // Filter out any matches where the user will have also autocompleted new rooms

      matcherObjects = matcherObjects.filter(r => {
        const tombstone = r.room.currentState.getStateEvents("m.room.tombstone", "");

        if (tombstone && tombstone.getContent() && tombstone.getContent()['replacement_room']) {
          const hasReplacementRoom = matcherObjects.some(r2 => r2.room.roomId === tombstone.getContent()['replacement_room']);
          return !hasReplacementRoom;
        }

        return true;
      });
      this.matcher.setObjects(matcherObjects);
      const matchedString = command[0];
      completions = this.matcher.match(matchedString, limit);
      completions = (0, _lodash.sortBy)(completions, [c => canonicalScore(c.displayedAlias, c.room), c => c.displayedAlias.length]);
      completions = (0, _lodash.uniqBy)(completions, match => match.room);
      completions = completions.map(room => {
        return {
          completion: room.displayedAlias,
          completionId: room.room.roomId,
          type: "room",
          suffix: ' ',
          href: (0, _Permalinks.makeRoomPermalink)(room.displayedAlias),
          component: /*#__PURE__*/_react.default.createElement(_Components.PillCompletion, {
            title: room.room.name,
            description: room.displayedAlias
          }, /*#__PURE__*/_react.default.createElement(_RoomAvatar.default, {
            width: 24,
            height: 24,
            room: room.room
          })),
          range
        };
      }).filter(completion => !!completion.completion && completion.completion.length > 0);
    }

    return completions;
  }

  getName() {
    return (0, _languageHandler._t)('Rooms');
  }

  renderCompletions(completions) {
    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_Autocomplete_Completion_container_pill mx_Autocomplete_Completion_container_truncate",
      role: "presentation",
      "aria-label": (0, _languageHandler._t)("Room Autocomplete")
    }, completions);
  }

}

exports.default = RoomProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hdXRvY29tcGxldGUvUm9vbVByb3ZpZGVyLnRzeCJdLCJuYW1lcyI6WyJST09NX1JFR0VYIiwiY2Fub25pY2FsU2NvcmUiLCJkaXNwbGF5ZWRBbGlhcyIsInJvb20iLCJnZXRDYW5vbmljYWxBbGlhcyIsIm1hdGNoZXJPYmplY3QiLCJtYXRjaE5hbWUiLCJSb29tUHJvdmlkZXIiLCJBdXRvY29tcGxldGVQcm92aWRlciIsImNvbnN0cnVjdG9yIiwicmVuZGVyaW5nVHlwZSIsImNvbW1hbmRSZWdleCIsIm1hdGNoZXIiLCJRdWVyeU1hdGNoZXIiLCJrZXlzIiwiZ2V0Um9vbXMiLCJjbGkiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJyb29tcyIsImdldFZpc2libGVSb29tcyIsIlNwYWNlU3RvcmUiLCJzcGFjZXNFbmFibGVkIiwiZmlsdGVyIiwiciIsImlzU3BhY2VSb29tIiwiZ2V0Q29tcGxldGlvbnMiLCJxdWVyeSIsInNlbGVjdGlvbiIsImZvcmNlIiwibGltaXQiLCJjb21wbGV0aW9ucyIsImNvbW1hbmQiLCJyYW5nZSIsImdldEN1cnJlbnRDb21tYW5kIiwibWF0Y2hlck9iamVjdHMiLCJyZWR1Y2UiLCJhbGlhc2VzIiwiY29uY2F0IiwibmFtZSIsImdldEFsdEFsaWFzZXMiLCJsZW5ndGgiLCJhbHRBbGlhc2VzIiwibWFwIiwiYWxpYXMiLCJ0b21ic3RvbmUiLCJjdXJyZW50U3RhdGUiLCJnZXRTdGF0ZUV2ZW50cyIsImdldENvbnRlbnQiLCJoYXNSZXBsYWNlbWVudFJvb20iLCJzb21lIiwicjIiLCJyb29tSWQiLCJzZXRPYmplY3RzIiwibWF0Y2hlZFN0cmluZyIsIm1hdGNoIiwiYyIsImNvbXBsZXRpb24iLCJjb21wbGV0aW9uSWQiLCJ0eXBlIiwic3VmZml4IiwiaHJlZiIsImNvbXBvbmVudCIsImdldE5hbWUiLCJyZW5kZXJDb21wbGV0aW9ucyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFrQkE7O0FBQ0E7O0FBR0E7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MjAxOCBNaWNoYWVsIFRlbGF0eW5za2kgPDd0M2NoZ3V5QGdtYWlsLmNvbT5cbkNvcHlyaWdodCAyMDE3LCAyMDE4LCAyMDIxIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0IGZyb20gXCJyZWFjdFwiO1xuaW1wb3J0IHsgdW5pcUJ5LCBzb3J0QnkgfSBmcm9tIFwibG9kYXNoXCI7XG5pbXBvcnQgeyBSb29tIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yb29tXCI7XG5cbmltcG9ydCB7IF90IH0gZnJvbSAnLi4vbGFuZ3VhZ2VIYW5kbGVyJztcbmltcG9ydCBBdXRvY29tcGxldGVQcm92aWRlciBmcm9tICcuL0F1dG9jb21wbGV0ZVByb3ZpZGVyJztcbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gJy4uL01hdHJpeENsaWVudFBlZyc7XG5pbXBvcnQgUXVlcnlNYXRjaGVyIGZyb20gJy4vUXVlcnlNYXRjaGVyJztcbmltcG9ydCB7IFBpbGxDb21wbGV0aW9uIH0gZnJvbSAnLi9Db21wb25lbnRzJztcbmltcG9ydCB7IG1ha2VSb29tUGVybWFsaW5rIH0gZnJvbSBcIi4uL3V0aWxzL3Blcm1hbGlua3MvUGVybWFsaW5rc1wiO1xuaW1wb3J0IHsgSUNvbXBsZXRpb24sIElTZWxlY3Rpb25SYW5nZSB9IGZyb20gXCIuL0F1dG9jb21wbGV0ZXJcIjtcbmltcG9ydCBSb29tQXZhdGFyIGZyb20gJy4uL2NvbXBvbmVudHMvdmlld3MvYXZhdGFycy9Sb29tQXZhdGFyJztcbmltcG9ydCBTcGFjZVN0b3JlIGZyb20gXCIuLi9zdG9yZXMvc3BhY2VzL1NwYWNlU3RvcmVcIjtcbmltcG9ydCB7IFRpbWVsaW5lUmVuZGVyaW5nVHlwZSB9IGZyb20gXCIuLi9jb250ZXh0cy9Sb29tQ29udGV4dFwiO1xuXG5jb25zdCBST09NX1JFR0VYID0gL1xcQiNcXFMqL2c7XG5cbi8vIFByZWZlciBjYW5vbmljYWwgYWxpYXNlcyBvdmVyIG5vbi1jYW5vbmljYWwgb25lc1xuZnVuY3Rpb24gY2Fub25pY2FsU2NvcmUoZGlzcGxheWVkQWxpYXM6IHN0cmluZywgcm9vbTogUm9vbSk6IG51bWJlciB7XG4gICAgcmV0dXJuIGRpc3BsYXllZEFsaWFzID09PSByb29tLmdldENhbm9uaWNhbEFsaWFzKCkgPyAwIDogMTtcbn1cblxuZnVuY3Rpb24gbWF0Y2hlck9iamVjdChyb29tOiBSb29tLCBkaXNwbGF5ZWRBbGlhczogc3RyaW5nLCBtYXRjaE5hbWUgPSBcIlwiKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgcm9vbSxcbiAgICAgICAgbWF0Y2hOYW1lLFxuICAgICAgICBkaXNwbGF5ZWRBbGlhcyxcbiAgICB9O1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSb29tUHJvdmlkZXIgZXh0ZW5kcyBBdXRvY29tcGxldGVQcm92aWRlciB7XG4gICAgcHJvdGVjdGVkIG1hdGNoZXI6IFF1ZXJ5TWF0Y2hlcjxSb29tPjtcblxuICAgIGNvbnN0cnVjdG9yKHJvb206IFJvb20sIHJlbmRlcmluZ1R5cGU/OiBUaW1lbGluZVJlbmRlcmluZ1R5cGUpIHtcbiAgICAgICAgc3VwZXIoeyBjb21tYW5kUmVnZXg6IFJPT01fUkVHRVgsIHJlbmRlcmluZ1R5cGUgfSk7XG4gICAgICAgIHRoaXMubWF0Y2hlciA9IG5ldyBRdWVyeU1hdGNoZXIoW10sIHtcbiAgICAgICAgICAgIGtleXM6IFsnZGlzcGxheWVkQWxpYXMnLCAnbWF0Y2hOYW1lJ10sXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBnZXRSb29tcygpIHtcbiAgICAgICAgY29uc3QgY2xpID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuICAgICAgICBsZXQgcm9vbXMgPSBjbGkuZ2V0VmlzaWJsZVJvb21zKCk7XG5cbiAgICAgICAgLy8gaWYgc3BhY2VzIGFyZSBlbmFibGVkIHRoZW4gZmlsdGVyIHRoZW0gb3V0IGhlcmUgYXMgdGhleSBnZXQgdGhlaXIgb3duIGF1dG9jb21wbGV0ZSBwcm92aWRlclxuICAgICAgICBpZiAoU3BhY2VTdG9yZS5zcGFjZXNFbmFibGVkKSB7XG4gICAgICAgICAgICByb29tcyA9IHJvb21zLmZpbHRlcihyID0+ICFyLmlzU3BhY2VSb29tKCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJvb21zO1xuICAgIH1cblxuICAgIGFzeW5jIGdldENvbXBsZXRpb25zKFxuICAgICAgICBxdWVyeTogc3RyaW5nLFxuICAgICAgICBzZWxlY3Rpb246IElTZWxlY3Rpb25SYW5nZSxcbiAgICAgICAgZm9yY2UgPSBmYWxzZSxcbiAgICAgICAgbGltaXQgPSAtMSxcbiAgICApOiBQcm9taXNlPElDb21wbGV0aW9uW10+IHtcbiAgICAgICAgbGV0IGNvbXBsZXRpb25zID0gW107XG4gICAgICAgIGNvbnN0IHsgY29tbWFuZCwgcmFuZ2UgfSA9IHRoaXMuZ2V0Q3VycmVudENvbW1hbmQocXVlcnksIHNlbGVjdGlvbiwgZm9yY2UpO1xuICAgICAgICBpZiAoY29tbWFuZCkge1xuICAgICAgICAgICAgLy8gdGhlIG9ubHkgcmVhc29uIHdlIG5lZWQgdG8gZG8gdGhpcyBpcyBiZWNhdXNlIEZ1c2Ugb25seSBtYXRjaGVzIG9uIHByb3BlcnRpZXNcbiAgICAgICAgICAgIGxldCBtYXRjaGVyT2JqZWN0cyA9IHRoaXMuZ2V0Um9vbXMoKS5yZWR1Y2UoKGFsaWFzZXMsIHJvb20pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocm9vbS5nZXRDYW5vbmljYWxBbGlhcygpKSB7XG4gICAgICAgICAgICAgICAgICAgIGFsaWFzZXMgPSBhbGlhc2VzLmNvbmNhdChtYXRjaGVyT2JqZWN0KHJvb20sIHJvb20uZ2V0Q2Fub25pY2FsQWxpYXMoKSwgcm9vbS5uYW1lKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChyb29tLmdldEFsdEFsaWFzZXMoKS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWx0QWxpYXNlcyA9IHJvb20uZ2V0QWx0QWxpYXNlcygpLm1hcChhbGlhcyA9PiBtYXRjaGVyT2JqZWN0KHJvb20sIGFsaWFzKSk7XG4gICAgICAgICAgICAgICAgICAgIGFsaWFzZXMgPSBhbGlhc2VzLmNvbmNhdChhbHRBbGlhc2VzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGFsaWFzZXM7XG4gICAgICAgICAgICB9LCBbXSk7XG4gICAgICAgICAgICAvLyBGaWx0ZXIgb3V0IGFueSBtYXRjaGVzIHdoZXJlIHRoZSB1c2VyIHdpbGwgaGF2ZSBhbHNvIGF1dG9jb21wbGV0ZWQgbmV3IHJvb21zXG4gICAgICAgICAgICBtYXRjaGVyT2JqZWN0cyA9IG1hdGNoZXJPYmplY3RzLmZpbHRlcigocikgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHRvbWJzdG9uZSA9IHIucm9vbS5jdXJyZW50U3RhdGUuZ2V0U3RhdGVFdmVudHMoXCJtLnJvb20udG9tYnN0b25lXCIsIFwiXCIpO1xuICAgICAgICAgICAgICAgIGlmICh0b21ic3RvbmUgJiYgdG9tYnN0b25lLmdldENvbnRlbnQoKSAmJiB0b21ic3RvbmUuZ2V0Q29udGVudCgpWydyZXBsYWNlbWVudF9yb29tJ10pIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaGFzUmVwbGFjZW1lbnRSb29tID0gbWF0Y2hlck9iamVjdHMuc29tZShcbiAgICAgICAgICAgICAgICAgICAgICAgIChyMikgPT4gcjIucm9vbS5yb29tSWQgPT09IHRvbWJzdG9uZS5nZXRDb250ZW50KClbJ3JlcGxhY2VtZW50X3Jvb20nXSxcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICFoYXNSZXBsYWNlbWVudFJvb207XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHRoaXMubWF0Y2hlci5zZXRPYmplY3RzKG1hdGNoZXJPYmplY3RzKTtcbiAgICAgICAgICAgIGNvbnN0IG1hdGNoZWRTdHJpbmcgPSBjb21tYW5kWzBdO1xuICAgICAgICAgICAgY29tcGxldGlvbnMgPSB0aGlzLm1hdGNoZXIubWF0Y2gobWF0Y2hlZFN0cmluZywgbGltaXQpO1xuICAgICAgICAgICAgY29tcGxldGlvbnMgPSBzb3J0QnkoY29tcGxldGlvbnMsIFtcbiAgICAgICAgICAgICAgICAoYykgPT4gY2Fub25pY2FsU2NvcmUoYy5kaXNwbGF5ZWRBbGlhcywgYy5yb29tKSxcbiAgICAgICAgICAgICAgICAoYykgPT4gYy5kaXNwbGF5ZWRBbGlhcy5sZW5ndGgsXG4gICAgICAgICAgICBdKTtcbiAgICAgICAgICAgIGNvbXBsZXRpb25zID0gdW5pcUJ5KGNvbXBsZXRpb25zLCAobWF0Y2gpID0+IG1hdGNoLnJvb20pO1xuICAgICAgICAgICAgY29tcGxldGlvbnMgPSBjb21wbGV0aW9ucy5tYXAoKHJvb20pID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBjb21wbGV0aW9uOiByb29tLmRpc3BsYXllZEFsaWFzLFxuICAgICAgICAgICAgICAgICAgICBjb21wbGV0aW9uSWQ6IHJvb20ucm9vbS5yb29tSWQsXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IFwicm9vbVwiLFxuICAgICAgICAgICAgICAgICAgICBzdWZmaXg6ICcgJyxcbiAgICAgICAgICAgICAgICAgICAgaHJlZjogbWFrZVJvb21QZXJtYWxpbmsocm9vbS5kaXNwbGF5ZWRBbGlhcyksXG4gICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudDogKFxuICAgICAgICAgICAgICAgICAgICAgICAgPFBpbGxDb21wbGV0aW9uIHRpdGxlPXtyb29tLnJvb20ubmFtZX0gZGVzY3JpcHRpb249e3Jvb20uZGlzcGxheWVkQWxpYXN9PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxSb29tQXZhdGFyIHdpZHRoPXsyNH0gaGVpZ2h0PXsyNH0gcm9vbT17cm9vbS5yb29tfSAvPlxuICAgICAgICAgICAgICAgICAgICAgICAgPC9QaWxsQ29tcGxldGlvbj5cbiAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgcmFuZ2UsXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0pLmZpbHRlcigoY29tcGxldGlvbikgPT4gISFjb21wbGV0aW9uLmNvbXBsZXRpb24gJiYgY29tcGxldGlvbi5jb21wbGV0aW9uLmxlbmd0aCA+IDApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjb21wbGV0aW9ucztcbiAgICB9XG5cbiAgICBnZXROYW1lKCkge1xuICAgICAgICByZXR1cm4gX3QoJ1Jvb21zJyk7XG4gICAgfVxuXG4gICAgcmVuZGVyQ29tcGxldGlvbnMoY29tcGxldGlvbnM6IFJlYWN0LlJlYWN0Tm9kZVtdKTogUmVhY3QuUmVhY3ROb2RlIHtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXZcbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9BdXRvY29tcGxldGVfQ29tcGxldGlvbl9jb250YWluZXJfcGlsbCBteF9BdXRvY29tcGxldGVfQ29tcGxldGlvbl9jb250YWluZXJfdHJ1bmNhdGVcIlxuICAgICAgICAgICAgICAgIHJvbGU9XCJwcmVzZW50YXRpb25cIlxuICAgICAgICAgICAgICAgIGFyaWEtbGFiZWw9e190KFwiUm9vbSBBdXRvY29tcGxldGVcIil9XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgeyBjb21wbGV0aW9ucyB9XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=