"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _languageHandler = require("../languageHandler");

var _AutocompleteProvider = _interopRequireDefault(require("./AutocompleteProvider"));

var _QueryMatcher = _interopRequireDefault(require("./QueryMatcher"));

var _Components = require("./Components");

var _lodash = require("lodash");

var _SettingsStore = _interopRequireDefault(require("../settings/SettingsStore"));

var _emoji = require("../emoji");

var _emoticon = _interopRequireDefault(require("emojibase-regex/emoticon"));

/*
Copyright 2016 Aviral Dasgupta
Copyright 2017 Vector Creations Ltd
Copyright 2017, 2018 New Vector Ltd
Copyright 2019 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const LIMIT = 20; // Match for ascii-style ";-)" emoticons or ":wink:" shortcodes provided by emojibase
// anchored to only match from the start of parts otherwise it'll show emoji suggestions whilst typing matrix IDs

const EMOJI_REGEX = new RegExp('(' + _emoticon.default.source + '|(?:^|\\s):[+-\\w]*:?)$', 'g');

const SORTED_EMOJI = _emoji.EMOJI.sort((a, b) => {
  if (a.group === b.group) {
    return a.order - b.order;
  }

  return a.group - b.group;
}).map((emoji, index) => ({
  emoji,
  // Include the index so that we can preserve the original order
  _orderBy: index
}));

function score(query, space) {
  const index = space.indexOf(query);

  if (index === -1) {
    return Infinity;
  } else {
    return index;
  }
}

class EmojiProvider extends _AutocompleteProvider.default {
  constructor(room, renderingType) {
    super({
      commandRegex: EMOJI_REGEX,
      renderingType
    });
    (0, _defineProperty2.default)(this, "matcher", void 0);
    (0, _defineProperty2.default)(this, "nameMatcher", void 0);
    this.matcher = new _QueryMatcher.default(SORTED_EMOJI, {
      keys: [],
      funcs: [o => o.emoji.shortcodes.map(s => `:${s}:`)],
      // For matching against ascii equivalents
      shouldMatchWordsOnly: false
    });
    this.nameMatcher = new _QueryMatcher.default(SORTED_EMOJI, {
      keys: ['emoji.annotation'],
      // For removing punctuation
      shouldMatchWordsOnly: true
    });
  }

  async getCompletions(query, selection, force, limit = -1) {
    if (!_SettingsStore.default.getValue("MessageComposerInput.suggestEmoji")) {
      return []; // don't give any suggestions if the user doesn't want them
    }

    let completions = [];
    const {
      command,
      range
    } = this.getCurrentCommand(query, selection);

    if (command && command[0].length > 2) {
      const matchedString = command[0];
      completions = this.matcher.match(matchedString, limit); // Do second match with shouldMatchWordsOnly in order to match against 'name'

      completions = completions.concat(this.nameMatcher.match(matchedString));
      const sorters = []; // make sure that emoticons come first

      sorters.push(c => score(matchedString, c.emoji.emoticon || "")); // then sort by score (Infinity if matchedString not in shortcode)

      sorters.push(c => score(matchedString, c.emoji.shortcodes[0])); // then sort by max score of all shortcodes, trim off the `:`

      sorters.push(c => Math.min(...c.emoji.shortcodes.map(s => score(matchedString.substring(1), s)))); // If the matchedString is not empty, sort by length of shortcode. Example:
      //  matchedString = ":bookmark"
      //  completions = [":bookmark:", ":bookmark_tabs:", ...]

      if (matchedString.length > 1) {
        sorters.push(c => c.emoji.shortcodes[0].length);
      } // Finally, sort by original ordering


      sorters.push(c => c._orderBy);
      completions = (0, _lodash.sortBy)((0, _lodash.uniq)(completions), sorters);
      completions = completions.map(c => ({
        completion: c.emoji.unicode,
        component: /*#__PURE__*/_react.default.createElement(_Components.PillCompletion, {
          title: `:${c.emoji.shortcodes[0]}:`,
          "aria-label": c.emoji.unicode
        }, /*#__PURE__*/_react.default.createElement("span", null, c.emoji.unicode)),
        range
      })).slice(0, LIMIT);
    }

    return completions;
  }

  getName() {
    return 'ðŸ˜ƒ ' + (0, _languageHandler._t)('Emoji');
  }

  renderCompletions(completions) {
    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_Autocomplete_Completion_container_pill",
      role: "presentation",
      "aria-label": (0, _languageHandler._t)("Emoji Autocomplete")
    }, completions);
  }

}

exports.default = EmojiProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hdXRvY29tcGxldGUvRW1vamlQcm92aWRlci50c3giXSwibmFtZXMiOlsiTElNSVQiLCJFTU9KSV9SRUdFWCIsIlJlZ0V4cCIsIkVNT1RJQ09OX1JFR0VYIiwic291cmNlIiwiU09SVEVEX0VNT0pJIiwiRU1PSkkiLCJzb3J0IiwiYSIsImIiLCJncm91cCIsIm9yZGVyIiwibWFwIiwiZW1vamkiLCJpbmRleCIsIl9vcmRlckJ5Iiwic2NvcmUiLCJxdWVyeSIsInNwYWNlIiwiaW5kZXhPZiIsIkluZmluaXR5IiwiRW1vamlQcm92aWRlciIsIkF1dG9jb21wbGV0ZVByb3ZpZGVyIiwiY29uc3RydWN0b3IiLCJyb29tIiwicmVuZGVyaW5nVHlwZSIsImNvbW1hbmRSZWdleCIsIm1hdGNoZXIiLCJRdWVyeU1hdGNoZXIiLCJrZXlzIiwiZnVuY3MiLCJvIiwic2hvcnRjb2RlcyIsInMiLCJzaG91bGRNYXRjaFdvcmRzT25seSIsIm5hbWVNYXRjaGVyIiwiZ2V0Q29tcGxldGlvbnMiLCJzZWxlY3Rpb24iLCJmb3JjZSIsImxpbWl0IiwiU2V0dGluZ3NTdG9yZSIsImdldFZhbHVlIiwiY29tcGxldGlvbnMiLCJjb21tYW5kIiwicmFuZ2UiLCJnZXRDdXJyZW50Q29tbWFuZCIsImxlbmd0aCIsIm1hdGNoZWRTdHJpbmciLCJtYXRjaCIsImNvbmNhdCIsInNvcnRlcnMiLCJwdXNoIiwiYyIsImVtb3RpY29uIiwiTWF0aCIsIm1pbiIsInN1YnN0cmluZyIsImNvbXBsZXRpb24iLCJ1bmljb2RlIiwiY29tcG9uZW50Iiwic2xpY2UiLCJnZXROYW1lIiwicmVuZGVyQ29tcGxldGlvbnMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBbUJBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUVBOztBQTdCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNB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QixDQUFkO0FBRUFSLE1BQUFBLFdBQVcsR0FBR0EsV0FBVyxDQUFDOUIsR0FBWixDQUFnQndDLENBQUMsS0FBSztBQUNoQ0ssUUFBQUEsVUFBVSxFQUFFTCxDQUFDLENBQUN2QyxLQUFGLENBQVE2QyxPQURZO0FBRWhDQyxRQUFBQSxTQUFTLGVBQ0wsNkJBQUMsMEJBQUQ7QUFBZ0IsVUFBQSxLQUFLLEVBQUcsSUFBR1AsQ0FBQyxDQUFDdkMsS0FBRixDQUFRbUIsVUFBUixDQUFtQixDQUFuQixDQUFzQixHQUFqRDtBQUFxRCx3QkFBWW9CLENBQUMsQ0FBQ3ZDLEtBQUYsQ0FBUTZDO0FBQXpFLHdCQUNJLDJDQUFRTixDQUFDLENBQUN2QyxLQUFGLENBQVE2QyxPQUFoQixDQURKLENBSDRCO0FBT2hDZCxRQUFBQTtBQVBnQyxPQUFMLENBQWpCLEVBUVZnQixLQVJVLENBUUosQ0FSSSxFQVFENUQsS0FSQyxDQUFkO0FBU0g7O0FBQ0QsV0FBTzBDLFdBQVA7QUFDSDs7QUFFRG1CLEVBQUFBLE9BQU8sR0FBRztBQUNOLFdBQU8sUUFBUSx5QkFBRyxPQUFILENBQWY7QUFDSDs7QUFFREMsRUFBQUEsaUJBQWlCLENBQUNwQixXQUFELEVBQWtEO0FBQy9ELHdCQUNJO0FBQ0ksTUFBQSxTQUFTLEVBQUMsMkNBRGQ7QUFFSSxNQUFBLElBQUksRUFBQyxjQUZUO0FBR0ksb0JBQVkseUJBQUcsb0JBQUg7QUFIaEIsT0FLTUEsV0FMTixDQURKO0FBU0g7O0FBdEYyRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNiBBdmlyYWwgRGFzZ3VwdGFcbkNvcHlyaWdodCAyMDE3IFZlY3RvciBDcmVhdGlvbnMgTHRkXG5Db3B5cmlnaHQgMjAxNywgMjAxOCBOZXcgVmVjdG9yIEx0ZFxuQ29weXJpZ2h0IDIwMTkgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgX3QgfSBmcm9tICcuLi9sYW5ndWFnZUhhbmRsZXInO1xuaW1wb3J0IEF1dG9jb21wbGV0ZVByb3ZpZGVyIGZyb20gJy4vQXV0b2NvbXBsZXRlUHJvdmlkZXInO1xuaW1wb3J0IFF1ZXJ5TWF0Y2hlciBmcm9tICcuL1F1ZXJ5TWF0Y2hlcic7XG5pbXBvcnQgeyBQaWxsQ29tcGxldGlvbiB9IGZyb20gJy4vQ29tcG9uZW50cyc7XG5pbXBvcnQgeyBJQ29tcGxldGlvbiwgSVNlbGVjdGlvblJhbmdlIH0gZnJvbSAnLi9BdXRvY29tcGxldGVyJztcbmltcG9ydCB7IHVuaXEsIHNvcnRCeSB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgU2V0dGluZ3NTdG9yZSBmcm9tIFwiLi4vc2V0dGluZ3MvU2V0dGluZ3NTdG9yZVwiO1xuaW1wb3J0IHsgRU1PSkksIElFbW9qaSB9IGZyb20gJy4uL2Vtb2ppJztcblxuaW1wb3J0IEVNT1RJQ09OX1JFR0VYIGZyb20gJ2Vtb2ppYmFzZS1yZWdleC9lbW90aWNvbic7XG5pbXBvcnQgeyBSb29tIH0gZnJvbSAnbWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3Jvb20nO1xuaW1wb3J0IHsgVGltZWxpbmVSZW5kZXJpbmdUeXBlIH0gZnJvbSAnLi4vY29udGV4dHMvUm9vbUNvbnRleHQnO1xuXG5jb25zdCBMSU1JVCA9IDIwO1xuXG4vLyBNYXRjaCBmb3IgYXNjaWktc3R5bGUgXCI7LSlcIiBlbW90aWNvbnMgb3IgXCI6d2luazpcIiBzaG9ydGNvZGVzIHByb3ZpZGVkIGJ5IGVtb2ppYmFzZVxuLy8gYW5jaG9yZWQgdG8gb25seSBtYXRjaCBmcm9tIHRoZSBzdGFydCBvZiBwYXJ0cyBvdGhlcndpc2UgaXQnbGwgc2hvdyBlbW9qaSBzdWdnZXN0aW9ucyB3aGlsc3QgdHlwaW5nIG1hdHJpeCBJRHNcbmNvbnN0IEVNT0pJX1JFR0VYID0gbmV3IFJlZ0V4cCgnKCcgKyBFTU9USUNPTl9SRUdFWC5zb3VyY2UgKyAnfCg/Ol58XFxcXHMpOlsrLVxcXFx3XSo6PykkJywgJ2cnKTtcblxuaW50ZXJmYWNlIElTb3J0ZWRFbW9qaSB7XG4gICAgZW1vamk6IElFbW9qaTtcbiAgICBfb3JkZXJCeTogbnVtYmVyO1xufVxuXG5jb25zdCBTT1JURURfRU1PSkk6IElTb3J0ZWRFbW9qaVtdID0gRU1PSkkuc29ydCgoYSwgYikgPT4ge1xuICAgIGlmIChhLmdyb3VwID09PSBiLmdyb3VwKSB7XG4gICAgICAgIHJldHVybiBhLm9yZGVyIC0gYi5vcmRlcjtcbiAgICB9XG4gICAgcmV0dXJuIGEuZ3JvdXAgLSBiLmdyb3VwO1xufSkubWFwKChlbW9qaSwgaW5kZXgpID0+ICh7XG4gICAgZW1vamksXG4gICAgLy8gSW5jbHVkZSB0aGUgaW5kZXggc28gdGhhdCB3ZSBjYW4gcHJlc2VydmUgdGhlIG9yaWdpbmFsIG9yZGVyXG4gICAgX29yZGVyQnk6IGluZGV4LFxufSkpO1xuXG5mdW5jdGlvbiBzY29yZShxdWVyeSwgc3BhY2UpIHtcbiAgICBjb25zdCBpbmRleCA9IHNwYWNlLmluZGV4T2YocXVlcnkpO1xuICAgIGlmIChpbmRleCA9PT0gLTEpIHtcbiAgICAgICAgcmV0dXJuIEluZmluaXR5O1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBpbmRleDtcbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEVtb2ppUHJvdmlkZXIgZXh0ZW5kcyBBdXRvY29tcGxldGVQcm92aWRlciB7XG4gICAgbWF0Y2hlcjogUXVlcnlNYXRjaGVyPElTb3J0ZWRFbW9qaT47XG4gICAgbmFtZU1hdGNoZXI6IFF1ZXJ5TWF0Y2hlcjxJU29ydGVkRW1vamk+O1xuXG4gICAgY29uc3RydWN0b3Iocm9vbTogUm9vbSwgcmVuZGVyaW5nVHlwZT86IFRpbWVsaW5lUmVuZGVyaW5nVHlwZSkge1xuICAgICAgICBzdXBlcih7IGNvbW1hbmRSZWdleDogRU1PSklfUkVHRVgsIHJlbmRlcmluZ1R5cGUgfSk7XG4gICAgICAgIHRoaXMubWF0Y2hlciA9IG5ldyBRdWVyeU1hdGNoZXI8SVNvcnRlZEVtb2ppPihTT1JURURfRU1PSkksIHtcbiAgICAgICAgICAgIGtleXM6IFtdLFxuICAgICAgICAgICAgZnVuY3M6IFtvID0+IG8uZW1vamkuc2hvcnRjb2Rlcy5tYXAocyA9PiBgOiR7c306YCldLFxuICAgICAgICAgICAgLy8gRm9yIG1hdGNoaW5nIGFnYWluc3QgYXNjaWkgZXF1aXZhbGVudHNcbiAgICAgICAgICAgIHNob3VsZE1hdGNoV29yZHNPbmx5OiBmYWxzZSxcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMubmFtZU1hdGNoZXIgPSBuZXcgUXVlcnlNYXRjaGVyKFNPUlRFRF9FTU9KSSwge1xuICAgICAgICAgICAga2V5czogWydlbW9qaS5hbm5vdGF0aW9uJ10sXG4gICAgICAgICAgICAvLyBGb3IgcmVtb3ZpbmcgcHVuY3R1YXRpb25cbiAgICAgICAgICAgIHNob3VsZE1hdGNoV29yZHNPbmx5OiB0cnVlLFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBhc3luYyBnZXRDb21wbGV0aW9ucyhcbiAgICAgICAgcXVlcnk6IHN0cmluZyxcbiAgICAgICAgc2VsZWN0aW9uOiBJU2VsZWN0aW9uUmFuZ2UsXG4gICAgICAgIGZvcmNlPzogYm9vbGVhbixcbiAgICAgICAgbGltaXQgPSAtMSxcbiAgICApOiBQcm9taXNlPElDb21wbGV0aW9uW10+IHtcbiAgICAgICAgaWYgKCFTZXR0aW5nc1N0b3JlLmdldFZhbHVlKFwiTWVzc2FnZUNvbXBvc2VySW5wdXQuc3VnZ2VzdEVtb2ppXCIpKSB7XG4gICAgICAgICAgICByZXR1cm4gW107IC8vIGRvbid0IGdpdmUgYW55IHN1Z2dlc3Rpb25zIGlmIHRoZSB1c2VyIGRvZXNuJ3Qgd2FudCB0aGVtXG4gICAgICAgIH1cblxuICAgICAgICBsZXQgY29tcGxldGlvbnMgPSBbXTtcbiAgICAgICAgY29uc3QgeyBjb21tYW5kLCByYW5nZSB9ID0gdGhpcy5nZXRDdXJyZW50Q29tbWFuZChxdWVyeSwgc2VsZWN0aW9uKTtcblxuICAgICAgICBpZiAoY29tbWFuZCAmJiBjb21tYW5kWzBdLmxlbmd0aCA+IDIpIHtcbiAgICAgICAgICAgIGNvbnN0IG1hdGNoZWRTdHJpbmcgPSBjb21tYW5kWzBdO1xuICAgICAgICAgICAgY29tcGxldGlvbnMgPSB0aGlzLm1hdGNoZXIubWF0Y2gobWF0Y2hlZFN0cmluZywgbGltaXQpO1xuXG4gICAgICAgICAgICAvLyBEbyBzZWNvbmQgbWF0Y2ggd2l0aCBzaG91bGRNYXRjaFdvcmRzT25seSBpbiBvcmRlciB0byBtYXRjaCBhZ2FpbnN0ICduYW1lJ1xuICAgICAgICAgICAgY29tcGxldGlvbnMgPSBjb21wbGV0aW9ucy5jb25jYXQodGhpcy5uYW1lTWF0Y2hlci5tYXRjaChtYXRjaGVkU3RyaW5nKSk7XG5cbiAgICAgICAgICAgIGNvbnN0IHNvcnRlcnMgPSBbXTtcbiAgICAgICAgICAgIC8vIG1ha2Ugc3VyZSB0aGF0IGVtb3RpY29ucyBjb21lIGZpcnN0XG4gICAgICAgICAgICBzb3J0ZXJzLnB1c2goYyA9PiBzY29yZShtYXRjaGVkU3RyaW5nLCBjLmVtb2ppLmVtb3RpY29uIHx8IFwiXCIpKTtcblxuICAgICAgICAgICAgLy8gdGhlbiBzb3J0IGJ5IHNjb3JlIChJbmZpbml0eSBpZiBtYXRjaGVkU3RyaW5nIG5vdCBpbiBzaG9ydGNvZGUpXG4gICAgICAgICAgICBzb3J0ZXJzLnB1c2goYyA9PiBzY29yZShtYXRjaGVkU3RyaW5nLCBjLmVtb2ppLnNob3J0Y29kZXNbMF0pKTtcbiAgICAgICAgICAgIC8vIHRoZW4gc29ydCBieSBtYXggc2NvcmUgb2YgYWxsIHNob3J0Y29kZXMsIHRyaW0gb2ZmIHRoZSBgOmBcbiAgICAgICAgICAgIHNvcnRlcnMucHVzaChjID0+IE1hdGgubWluKFxuICAgICAgICAgICAgICAgIC4uLmMuZW1vamkuc2hvcnRjb2Rlcy5tYXAocyA9PiBzY29yZShtYXRjaGVkU3RyaW5nLnN1YnN0cmluZygxKSwgcykpLFxuICAgICAgICAgICAgKSk7XG4gICAgICAgICAgICAvLyBJZiB0aGUgbWF0Y2hlZFN0cmluZyBpcyBub3QgZW1wdHksIHNvcnQgYnkgbGVuZ3RoIG9mIHNob3J0Y29kZS4gRXhhbXBsZTpcbiAgICAgICAgICAgIC8vICBtYXRjaGVkU3RyaW5nID0gXCI6Ym9va21hcmtcIlxuICAgICAgICAgICAgLy8gIGNvbXBsZXRpb25zID0gW1wiOmJvb2ttYXJrOlwiLCBcIjpib29rbWFya190YWJzOlwiLCAuLi5dXG4gICAgICAgICAgICBpZiAobWF0Y2hlZFN0cmluZy5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgc29ydGVycy5wdXNoKGMgPT4gYy5lbW9qaS5zaG9ydGNvZGVzWzBdLmxlbmd0aCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBGaW5hbGx5LCBzb3J0IGJ5IG9yaWdpbmFsIG9yZGVyaW5nXG4gICAgICAgICAgICBzb3J0ZXJzLnB1c2goYyA9PiBjLl9vcmRlckJ5KTtcbiAgICAgICAgICAgIGNvbXBsZXRpb25zID0gc29ydEJ5KHVuaXEoY29tcGxldGlvbnMpLCBzb3J0ZXJzKTtcblxuICAgICAgICAgICAgY29tcGxldGlvbnMgPSBjb21wbGV0aW9ucy5tYXAoYyA9PiAoe1xuICAgICAgICAgICAgICAgIGNvbXBsZXRpb246IGMuZW1vamkudW5pY29kZSxcbiAgICAgICAgICAgICAgICBjb21wb25lbnQ6IChcbiAgICAgICAgICAgICAgICAgICAgPFBpbGxDb21wbGV0aW9uIHRpdGxlPXtgOiR7Yy5lbW9qaS5zaG9ydGNvZGVzWzBdfTpgfSBhcmlhLWxhYmVsPXtjLmVtb2ppLnVuaWNvZGV9PlxuICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4+eyBjLmVtb2ppLnVuaWNvZGUgfTwvc3Bhbj5cbiAgICAgICAgICAgICAgICAgICAgPC9QaWxsQ29tcGxldGlvbj5cbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgIHJhbmdlLFxuICAgICAgICAgICAgfSkpLnNsaWNlKDAsIExJTUlUKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY29tcGxldGlvbnM7XG4gICAgfVxuXG4gICAgZ2V0TmFtZSgpIHtcbiAgICAgICAgcmV0dXJuICfwn5iDICcgKyBfdCgnRW1vamknKTtcbiAgICB9XG5cbiAgICByZW5kZXJDb21wbGV0aW9ucyhjb21wbGV0aW9uczogUmVhY3QuUmVhY3ROb2RlW10pOiBSZWFjdC5SZWFjdE5vZGUge1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPGRpdlxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X0F1dG9jb21wbGV0ZV9Db21wbGV0aW9uX2NvbnRhaW5lcl9waWxsXCJcbiAgICAgICAgICAgICAgICByb2xlPVwicHJlc2VudGF0aW9uXCJcbiAgICAgICAgICAgICAgICBhcmlhLWxhYmVsPXtfdChcIkVtb2ppIEF1dG9jb21wbGV0ZVwiKX1cbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICB7IGNvbXBsZXRpb25zIH1cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICApO1xuICAgIH1cbn1cbiJdfQ==