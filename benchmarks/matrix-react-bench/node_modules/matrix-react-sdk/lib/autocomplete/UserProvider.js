"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _languageHandler = require("../languageHandler");

var _AutocompleteProvider = _interopRequireDefault(require("./AutocompleteProvider"));

var _Components = require("./Components");

var _QueryMatcher = _interopRequireDefault(require("./QueryMatcher"));

var _lodash = require("lodash");

var _MatrixClientPeg = require("../MatrixClientPeg");

var _Permalinks = require("../utils/permalinks/Permalinks");

var _MemberAvatar = _interopRequireDefault(require("../components/views/avatars/MemberAvatar"));

/*
Copyright 2016 Aviral Dasgupta
Copyright 2017 Vector Creations Ltd
Copyright 2017, 2018 New Vector Ltd
Copyright 2018 Michael Telatynski <7t3chguy@gmail.com>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const USER_REGEX = /\B@\S*/g; // used when you hit 'tab' - we allow some separator chars at the beginning
// to allow you to tab-complete /mat into /(matthew)

const FORCED_USER_REGEX = /[^/,:; \t\n]\S*/g;

class UserProvider extends _AutocompleteProvider.default {
  constructor(_room, renderingType) {
    super({
      commandRegex: USER_REGEX,
      forcedCommandRegex: FORCED_USER_REGEX,
      renderingType
    });
    (0, _defineProperty2.default)(this, "matcher", void 0);
    (0, _defineProperty2.default)(this, "users", void 0);
    (0, _defineProperty2.default)(this, "room", void 0);
    (0, _defineProperty2.default)(this, "onRoomTimeline", (ev, room, toStartOfTimeline, removed, data) => {
      if (!room) return;
      if (removed) return;
      if (room.roomId !== this.room.roomId) return; // ignore events from filtered timelines

      if (data.timeline.getTimelineSet() !== room.getUnfilteredTimelineSet()) return; // ignore anything but real-time updates at the end of the room:
      // updates from pagination will happen when the paginate completes.

      if (toStartOfTimeline || !data || !data.liveEvent) return; // TODO: lazyload if we have no ev.sender room member?

      this.onUserSpoke(ev.sender);
    });
    (0, _defineProperty2.default)(this, "onRoomStateMember", (ev, state, member) => {
      // ignore members in other rooms
      if (member.roomId !== this.room.roomId) {
        return;
      } // blow away the users cache


      this.users = null;
    });
    this.room = _room;
    this.matcher = new _QueryMatcher.default([], {
      keys: ['name'],
      funcs: [obj => obj.userId.slice(1)],
      // index by user id minus the leading '@'
      shouldMatchWordsOnly: false
    });

    _MatrixClientPeg.MatrixClientPeg.get().on("Room.timeline", this.onRoomTimeline);

    _MatrixClientPeg.MatrixClientPeg.get().on("RoomState.members", this.onRoomStateMember);
  }

  destroy() {
    if (_MatrixClientPeg.MatrixClientPeg.get()) {
      _MatrixClientPeg.MatrixClientPeg.get().removeListener("Room.timeline", this.onRoomTimeline);

      _MatrixClientPeg.MatrixClientPeg.get().removeListener("RoomState.members", this.onRoomStateMember);
    }
  }

  async getCompletions(rawQuery, selection, force = false, limit = -1) {
    // lazy-load user list into matcher
    if (!this.users) this.makeUsers();
    let completions = [];
    const {
      command,
      range
    } = this.getCurrentCommand(rawQuery, selection, force);
    if (!command) return completions;
    const fullMatch = command[0]; // Don't search if the query is a single "@"

    if (fullMatch && fullMatch !== '@') {
      // Don't include the '@' in our search query - it's only used as a way to trigger completion
      const query = fullMatch.startsWith('@') ? fullMatch.substring(1) : fullMatch;
      completions = this.matcher.match(query, limit).map(user => {
        const displayName = user.name || user.userId || '';
        return {
          // Length of completion should equal length of text in decorator. draft-js
          // relies on the length of the entity === length of the text in the decoration.
          completion: user.rawDisplayName,
          completionId: user.userId,
          type: "user",
          suffix: selection.beginning && range.start === 0 ? ': ' : ' ',
          href: (0, _Permalinks.makeUserPermalink)(user.userId),
          component: /*#__PURE__*/_react.default.createElement(_Components.PillCompletion, {
            title: displayName,
            description: user.userId
          }, /*#__PURE__*/_react.default.createElement(_MemberAvatar.default, {
            member: user,
            width: 24,
            height: 24
          })),
          range
        };
      });
    }

    return completions;
  }

  getName() {
    return (0, _languageHandler._t)('Users');
  }

  makeUsers() {
    const events = this.room.getLiveTimeline().getEvents();
    const lastSpoken = {};

    for (const event of events) {
      lastSpoken[event.getSender()] = event.getTs();
    }

    const currentUserId = _MatrixClientPeg.MatrixClientPeg.get().credentials.userId;

    this.users = this.room.getJoinedMembers().filter(({
      userId
    }) => userId !== currentUserId);
    this.users = this.users.concat(this.room.getMembersWithMembership("invite"));
    this.users = (0, _lodash.sortBy)(this.users, member => 1E20 - lastSpoken[member.userId] || 1E20);
    this.matcher.setObjects(this.users);
  }

  onUserSpoke(user) {
    if (!this.users) return;
    if (!user) return;
    if (user.userId === _MatrixClientPeg.MatrixClientPeg.get().credentials.userId) return; // Move the user that spoke to the front of the array

    this.users.splice(this.users.findIndex(user2 => user2.userId === user.userId), 1);
    this.users = [user, ...this.users];
    this.matcher.setObjects(this.users);
  }

  renderCompletions(completions) {
    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_Autocomplete_Completion_container_pill",
      role: "presentation",
      "aria-label": (0, _languageHandler._t)("User Autocomplete")
    }, completions);
  }

  shouldForceComplete() {
    return true;
  }

}

exports.default = UserProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hdXRvY29tcGxldGUvVXNlclByb3ZpZGVyLnRzeCJdLCJuYW1lcyI6WyJVU0VSX1JFR0VYIiwiRk9SQ0VEX1VTRVJfUkVHRVgiLCJVc2VyUHJvdmlkZXIiLCJBdXRvY29tcGxldGVQcm92aWRlciIsImNvbnN0cnVjdG9yIiwicm9vbSIsInJlbmRlcmluZ1R5cGUiLCJjb21tYW5kUmVnZXgiLCJmb3JjZWRDb21tYW5kUmVnZXgiLCJldiIsInRvU3RhcnRPZlRpbWVsaW5lIiwicmVtb3ZlZCIsImRhdGEiLCJyb29tSWQiLCJ0aW1lbGluZSIsImdldFRpbWVsaW5lU2V0IiwiZ2V0VW5maWx0ZXJlZFRpbWVsaW5lU2V0IiwibGl2ZUV2ZW50Iiwib25Vc2VyU3Bva2UiLCJzZW5kZXIiLCJzdGF0ZSIsIm1lbWJlciIsInVzZXJzIiwibWF0Y2hlciIsIlF1ZXJ5TWF0Y2hlciIsImtleXMiLCJmdW5jcyIsIm9iaiIsInVzZXJJZCIsInNsaWNlIiwic2hvdWxkTWF0Y2hXb3Jkc09ubHkiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJvbiIsIm9uUm9vbVRpbWVsaW5lIiwib25Sb29tU3RhdGVNZW1iZXIiLCJkZXN0cm95IiwicmVtb3ZlTGlzdGVuZXIiLCJnZXRDb21wbGV0aW9ucyIsInJhd1F1ZXJ5Iiwic2VsZWN0aW9uIiwiZm9yY2UiLCJsaW1pdCIsIm1ha2VVc2VycyIsImNvbXBsZXRpb25zIiwiY29tbWFuZCIsInJhbmdlIiwiZ2V0Q3VycmVudENvbW1hbmQiLCJmdWxsTWF0Y2giLCJxdWVyeSIsInN0YXJ0c1dpdGgiLCJzdWJzdHJpbmciLCJtYXRjaCIsIm1hcCIsInVzZXIiLCJkaXNwbGF5TmFtZSIsIm5hbWUiLCJjb21wbGV0aW9uIiwicmF3RGlzcGxheU5hbWUiLCJjb21wbGV0aW9uSWQiLCJ0eXBlIiwic3VmZml4IiwiYmVnaW5uaW5nIiwic3RhcnQiLCJocmVmIiwiY29tcG9uZW50IiwiZ2V0TmFtZSIsImV2ZW50cyIsImdldExpdmVUaW1lbGluZSIsImdldEV2ZW50cyIsImxhc3RTcG9rZW4iLCJldmVudCIsImdldFNlbmRlciIsImdldFRzIiwiY3VycmVudFVzZXJJZCIsImNyZWRlbnRpYWxzIiwiZ2V0Sm9pbmVkTWVtYmVycyIsImZpbHRlciIsImNvbmNhdCIsImdldE1lbWJlcnNXaXRoTWVtYmVyc2hpcCIsInNldE9iamVjdHMiLCJzcGxpY2UiLCJmaW5kSW5kZXgiLCJ1c2VyMiIsInJlbmRlckNvbXBsZXRpb25zIiwic2hvdWxkRm9yY2VDb21wbGV0ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFtQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBT0E7O0FBRUE7O0FBbENBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQW9CQSxNQUFNQSxVQUFVLEdBQUcsU0FBbkIsQyxDQUVBO0FBQ0E7O0FBQ0EsTUFBTUMsaUJBQWlCLEdBQUcsa0JBQTFCOztBQU9lLE1BQU1DLFlBQU4sU0FBMkJDLDZCQUEzQixDQUFnRDtBQUszREMsRUFBQUEsV0FBVyxDQUFDQyxLQUFELEVBQWFDLGFBQWIsRUFBb0Q7QUFDM0QsVUFBTTtBQUNGQyxNQUFBQSxZQUFZLEVBQUVQLFVBRFo7QUFFRlEsTUFBQUEsa0JBQWtCLEVBQUVQLGlCQUZsQjtBQUdGSyxNQUFBQTtBQUhFLEtBQU47QUFEMkQ7QUFBQTtBQUFBO0FBQUEsMERBd0J0QyxDQUNyQkcsRUFEcUIsRUFFckJKLElBRnFCLEVBR3JCSyxpQkFIcUIsRUFJckJDLE9BSnFCLEVBS3JCQyxJQUxxQixLQU1wQjtBQUNELFVBQUksQ0FBQ1AsSUFBTCxFQUFXO0FBQ1gsVUFBSU0sT0FBSixFQUFhO0FBQ2IsVUFBSU4sSUFBSSxDQUFDUSxNQUFMLEtBQWdCLEtBQUtSLElBQUwsQ0FBVVEsTUFBOUIsRUFBc0MsT0FIckMsQ0FLRDs7QUFDQSxVQUFJRCxJQUFJLENBQUNF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RUR5QyxFQUFBQSxtQkFBbUIsR0FBWTtBQUMzQixXQUFPLElBQVA7QUFDSDs7QUF0SjBEIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE2IEF2aXJhbCBEYXNndXB0YVxuQ29weXJpZ2h0IDIwMTcgVmVjdG9yIENyZWF0aW9ucyBMdGRcbkNvcHlyaWdodCAyMDE3LCAyMDE4IE5ldyBWZWN0b3IgTHRkXG5Db3B5cmlnaHQgMjAxOCBNaWNoYWVsIFRlbGF0eW5za2kgPDd0M2NoZ3V5QGdtYWlsLmNvbT5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgX3QgfSBmcm9tICcuLi9sYW5ndWFnZUhhbmRsZXInO1xuaW1wb3J0IEF1dG9jb21wbGV0ZVByb3ZpZGVyIGZyb20gJy4vQXV0b2NvbXBsZXRlUHJvdmlkZXInO1xuaW1wb3J0IHsgUGlsbENvbXBsZXRpb24gfSBmcm9tICcuL0NvbXBvbmVudHMnO1xuaW1wb3J0IFF1ZXJ5TWF0Y2hlciBmcm9tICcuL1F1ZXJ5TWF0Y2hlcic7XG5pbXBvcnQgeyBzb3J0QnkgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSAnLi4vTWF0cml4Q2xpZW50UGVnJztcblxuaW1wb3J0IHsgTWF0cml4RXZlbnQgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL2V2ZW50XCI7XG5pbXBvcnQgeyBSb29tIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yb29tXCI7XG5pbXBvcnQgeyBSb29tTWVtYmVyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yb29tLW1lbWJlclwiO1xuaW1wb3J0IHsgUm9vbVN0YXRlIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yb29tLXN0YXRlXCI7XG5pbXBvcnQgeyBFdmVudFRpbWVsaW5lIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9ldmVudC10aW1lbGluZVwiO1xuaW1wb3J0IHsgbWFrZVVzZXJQZXJtYWxpbmsgfSBmcm9tIFwiLi4vdXRpbHMvcGVybWFsaW5rcy9QZXJtYWxpbmtzXCI7XG5pbXBvcnQgeyBJQ29tcGxldGlvbiwgSVNlbGVjdGlvblJhbmdlIH0gZnJvbSBcIi4vQXV0b2NvbXBsZXRlclwiO1xuaW1wb3J0IE1lbWJlckF2YXRhciBmcm9tICcuLi9jb21wb25lbnRzL3ZpZXdzL2F2YXRhcnMvTWVtYmVyQXZhdGFyJztcbmltcG9ydCB7IFRpbWVsaW5lUmVuZGVyaW5nVHlwZSB9IGZyb20gJy4uL2NvbnRleHRzL1Jvb21Db250ZXh0JztcblxuY29uc3QgVVNFUl9SRUdFWCA9IC9cXEJAXFxTKi9nO1xuXG4vLyB1c2VkIHdoZW4geW91IGhpdCAndGFiJyAtIHdlIGFsbG93IHNvbWUgc2VwYXJhdG9yIGNoYXJzIGF0IHRoZSBiZWdpbm5pbmdcbi8vIHRvIGFsbG93IHlvdSB0byB0YWItY29tcGxldGUgL21hdCBpbnRvIC8obWF0dGhldylcbmNvbnN0IEZPUkNFRF9VU0VSX1JFR0VYID0gL1teLyw6OyBcXHRcXG5dXFxTKi9nO1xuXG5pbnRlcmZhY2UgSVJvb21UaW1lbGluZURhdGEge1xuICAgIHRpbWVsaW5lOiBFdmVudFRpbWVsaW5lO1xuICAgIGxpdmVFdmVudD86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFVzZXJQcm92aWRlciBleHRlbmRzIEF1dG9jb21wbGV0ZVByb3ZpZGVyIHtcbiAgICBtYXRjaGVyOiBRdWVyeU1hdGNoZXI8Um9vbU1lbWJlcj47XG4gICAgdXNlcnM6IFJvb21NZW1iZXJbXTtcbiAgICByb29tOiBSb29tO1xuXG4gICAgY29uc3RydWN0b3Iocm9vbTogUm9vbSwgcmVuZGVyaW5nVHlwZT86IFRpbWVsaW5lUmVuZGVyaW5nVHlwZSkge1xuICAgICAgICBzdXBlcih7XG4gICAgICAgICAgICBjb21tYW5kUmVnZXg6IFVTRVJfUkVHRVgsXG4gICAgICAgICAgICBmb3JjZWRDb21tYW5kUmVnZXg6IEZPUkNFRF9VU0VSX1JFR0VYLFxuICAgICAgICAgICAgcmVuZGVyaW5nVHlwZSxcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMucm9vbSA9IHJvb207XG4gICAgICAgIHRoaXMubWF0Y2hlciA9IG5ldyBRdWVyeU1hdGNoZXIoW10sIHtcbiAgICAgICAgICAgIGtleXM6IFsnbmFtZSddLFxuICAgICAgICAgICAgZnVuY3M6IFtvYmogPT4gb2JqLnVzZXJJZC5zbGljZSgxKV0sIC8vIGluZGV4IGJ5IHVzZXIgaWQgbWludXMgdGhlIGxlYWRpbmcgJ0AnXG4gICAgICAgICAgICBzaG91bGRNYXRjaFdvcmRzT25seTogZmFsc2UsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIE1hdHJpeENsaWVudFBlZy5nZXQoKS5vbihcIlJvb20udGltZWxpbmVcIiwgdGhpcy5vblJvb21UaW1lbGluZSk7XG4gICAgICAgIE1hdHJpeENsaWVudFBlZy5nZXQoKS5vbihcIlJvb21TdGF0ZS5tZW1iZXJzXCIsIHRoaXMub25Sb29tU3RhdGVNZW1iZXIpO1xuICAgIH1cblxuICAgIGRlc3Ryb3koKSB7XG4gICAgICAgIGlmIChNYXRyaXhDbGllbnRQZWcuZ2V0KCkpIHtcbiAgICAgICAgICAgIE1hdHJpeENsaWVudFBlZy5nZXQoKS5yZW1vdmVMaXN0ZW5lcihcIlJvb20udGltZWxpbmVcIiwgdGhpcy5vblJvb21UaW1lbGluZSk7XG4gICAgICAgICAgICBNYXRyaXhDbGllbnRQZWcuZ2V0KCkucmVtb3ZlTGlzdGVuZXIoXCJSb29tU3RhdGUubWVtYmVyc1wiLCB0aGlzLm9uUm9vbVN0YXRlTWVtYmVyKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgb25Sb29tVGltZWxpbmUgPSAoXG4gICAgICAgIGV2OiBNYXRyaXhFdmVudCxcbiAgICAgICAgcm9vbTogUm9vbSxcbiAgICAgICAgdG9TdGFydE9mVGltZWxpbmU6IGJvb2xlYW4sXG4gICAgICAgIHJlbW92ZWQ6IGJvb2xlYW4sXG4gICAgICAgIGRhdGE6IElSb29tVGltZWxpbmVEYXRhLFxuICAgICkgPT4ge1xuICAgICAgICBpZiAoIXJvb20pIHJldHVybjtcbiAgICAgICAgaWYgKHJlbW92ZWQpIHJldHVybjtcbiAgICAgICAgaWYgKHJvb20ucm9vbUlkICE9PSB0aGlzLnJvb20ucm9vbUlkKSByZXR1cm47XG5cbiAgICAgICAgLy8gaWdub3JlIGV2ZW50cyBmcm9tIGZpbHRlcmVkIHRpbWVsaW5lc1xuICAgICAgICBpZiAoZGF0YS50aW1lbGluZS5nZXRUaW1lbGluZVNldCgpICE9PSByb29tLmdldFVuZmlsdGVyZWRUaW1lbGluZVNldCgpKSByZXR1cm47XG5cbiAgICAgICAgLy8gaWdub3JlIGFueXRoaW5nIGJ1dCByZWFsLXRpbWUgdXBkYXRlcyBhdCB0aGUgZW5kIG9mIHRoZSByb29tOlxuICAgICAgICAvLyB1cGRhdGVzIGZyb20gcGFnaW5hdGlvbiB3aWxsIGhhcHBlbiB3aGVuIHRoZSBwYWdpbmF0ZSBjb21wbGV0ZXMuXG4gICAgICAgIGlmICh0b1N0YXJ0T2ZUaW1lbGluZSB8fCAhZGF0YSB8fCAhZGF0YS5saXZlRXZlbnQpIHJldHVybjtcblxuICAgICAgICAvLyBUT0RPOiBsYXp5bG9hZCBpZiB3ZSBoYXZlIG5vIGV2LnNlbmRlciByb29tIG1lbWJlcj9cbiAgICAgICAgdGhpcy5vblVzZXJTcG9rZShldi5zZW5kZXIpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uUm9vbVN0YXRlTWVtYmVyID0gKGV2OiBNYXRyaXhFdmVudCwgc3RhdGU6IFJvb21TdGF0ZSwgbWVtYmVyOiBSb29tTWVtYmVyKSA9PiB7XG4gICAgICAgIC8vIGlnbm9yZSBtZW1iZXJzIGluIG90aGVyIHJvb21zXG4gICAgICAgIGlmIChtZW1iZXIucm9vbUlkICE9PSB0aGlzLnJvb20ucm9vbUlkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICAvLyBibG93IGF3YXkgdGhlIHVzZXJzIGNhY2hlXG4gICAgICAgIHRoaXMudXNlcnMgPSBudWxsO1xuICAgIH07XG5cbiAgICBhc3luYyBnZXRDb21wbGV0aW9ucyhcbiAgICAgICAgcmF3UXVlcnk6IHN0cmluZyxcbiAgICAgICAgc2VsZWN0aW9uOiBJU2VsZWN0aW9uUmFuZ2UsXG4gICAgICAgIGZvcmNlID0gZmFsc2UsXG4gICAgICAgIGxpbWl0ID0gLTEsXG4gICAgKTogUHJvbWlzZTxJQ29tcGxldGlvbltdPiB7XG4gICAgICAgIC8vIGxhenktbG9hZCB1c2VyIGxpc3QgaW50byBtYXRjaGVyXG4gICAgICAgIGlmICghdGhpcy51c2VycykgdGhpcy5tYWtlVXNlcnMoKTtcblxuICAgICAgICBsZXQgY29tcGxldGlvbnMgPSBbXTtcbiAgICAgICAgY29uc3QgeyBjb21tYW5kLCByYW5nZSB9ID0gdGhpcy5nZXRDdXJyZW50Q29tbWFuZChyYXdRdWVyeSwgc2VsZWN0aW9uLCBmb3JjZSk7XG5cbiAgICAgICAgaWYgKCFjb21tYW5kKSByZXR1cm4gY29tcGxldGlvbnM7XG5cbiAgICAgICAgY29uc3QgZnVsbE1hdGNoID0gY29tbWFuZFswXTtcbiAgICAgICAgLy8gRG9uJ3Qgc2VhcmNoIGlmIHRoZSBxdWVyeSBpcyBhIHNpbmdsZSBcIkBcIlxuICAgICAgICBpZiAoZnVsbE1hdGNoICYmIGZ1bGxNYXRjaCAhPT0gJ0AnKSB7XG4gICAgICAgICAgICAvLyBEb24ndCBpbmNsdWRlIHRoZSAnQCcgaW4gb3VyIHNlYXJjaCBxdWVyeSAtIGl0J3Mgb25seSB1c2VkIGFzIGEgd2F5IHRvIHRyaWdnZXIgY29tcGxldGlvblxuICAgICAgICAgICAgY29uc3QgcXVlcnkgPSBmdWxsTWF0Y2guc3RhcnRzV2l0aCgnQCcpID8gZnVsbE1hdGNoLnN1YnN0cmluZygxKSA6IGZ1bGxNYXRjaDtcbiAgICAgICAgICAgIGNvbXBsZXRpb25zID0gdGhpcy5tYXRjaGVyLm1hdGNoKHF1ZXJ5LCBsaW1pdCkubWFwKCh1c2VyKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgZGlzcGxheU5hbWUgPSAodXNlci5uYW1lIHx8IHVzZXIudXNlcklkIHx8ICcnKTtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAvLyBMZW5ndGggb2YgY29tcGxldGlvbiBzaG91bGQgZXF1YWwgbGVuZ3RoIG9mIHRleHQgaW4gZGVjb3JhdG9yLiBkcmFmdC1qc1xuICAgICAgICAgICAgICAgICAgICAvLyByZWxpZXMgb24gdGhlIGxlbmd0aCBvZiB0aGUgZW50aXR5ID09PSBsZW5ndGggb2YgdGhlIHRleHQgaW4gdGhlIGRlY29yYXRpb24uXG4gICAgICAgICAgICAgICAgICAgIGNvbXBsZXRpb246IHVzZXIucmF3RGlzcGxheU5hbWUsXG4gICAgICAgICAgICAgICAgICAgIGNvbXBsZXRpb25JZDogdXNlci51c2VySWQsXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IFwidXNlclwiLFxuICAgICAgICAgICAgICAgICAgICBzdWZmaXg6IChzZWxlY3Rpb24uYmVnaW5uaW5nICYmIHJhbmdlLnN0YXJ0ID09PSAwKSA/ICc6ICcgOiAnICcsXG4gICAgICAgICAgICAgICAgICAgIGhyZWY6IG1ha2VVc2VyUGVybWFsaW5rKHVzZXIudXNlcklkKSxcbiAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50OiAoXG4gICAgICAgICAgICAgICAgICAgICAgICA8UGlsbENvbXBsZXRpb24gdGl0bGU9e2Rpc3BsYXlOYW1lfSBkZXNjcmlwdGlvbj17dXNlci51c2VySWR9PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxNZW1iZXJBdmF0YXIgbWVtYmVyPXt1c2VyfSB3aWR0aD17MjR9IGhlaWdodD17MjR9IC8+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L1BpbGxDb21wbGV0aW9uPlxuICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICByYW5nZSxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGNvbXBsZXRpb25zO1xuICAgIH1cblxuICAgIGdldE5hbWUoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIF90KCdVc2VycycpO1xuICAgIH1cblxuICAgIHByaXZhdGUgbWFrZVVzZXJzKCkge1xuICAgICAgICBjb25zdCBldmVudHMgPSB0aGlzLnJvb20uZ2V0TGl2ZVRpbWVsaW5lKCkuZ2V0RXZlbnRzKCk7XG4gICAgICAgIGNvbnN0IGxhc3RTcG9rZW4gPSB7fTtcblxuICAgICAgICBmb3IgKGNvbnN0IGV2ZW50IG9mIGV2ZW50cykge1xuICAgICAgICAgICAgbGFzdFNwb2tlbltldmVudC5nZXRTZW5kZXIoKV0gPSBldmVudC5nZXRUcygpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY3VycmVudFVzZXJJZCA9IE1hdHJpeENsaWVudFBlZy5nZXQoKS5jcmVkZW50aWFscy51c2VySWQ7XG4gICAgICAgIHRoaXMudXNlcnMgPSB0aGlzLnJvb20uZ2V0Sm9pbmVkTWVtYmVycygpLmZpbHRlcigoeyB1c2VySWQgfSkgPT4gdXNlcklkICE9PSBjdXJyZW50VXNlcklkKTtcbiAgICAgICAgdGhpcy51c2VycyA9IHRoaXMudXNlcnMuY29uY2F0KHRoaXMucm9vbS5nZXRNZW1iZXJzV2l0aE1lbWJlcnNoaXAoXCJpbnZpdGVcIikpO1xuXG4gICAgICAgIHRoaXMudXNlcnMgPSBzb3J0QnkodGhpcy51c2VycywgKG1lbWJlcikgPT4gMUUyMCAtIGxhc3RTcG9rZW5bbWVtYmVyLnVzZXJJZF0gfHwgMUUyMCk7XG5cbiAgICAgICAgdGhpcy5tYXRjaGVyLnNldE9iamVjdHModGhpcy51c2Vycyk7XG4gICAgfVxuXG4gICAgb25Vc2VyU3Bva2UodXNlcjogUm9vbU1lbWJlcikge1xuICAgICAgICBpZiAoIXRoaXMudXNlcnMpIHJldHVybjtcbiAgICAgICAgaWYgKCF1c2VyKSByZXR1cm47XG4gICAgICAgIGlmICh1c2VyLnVzZXJJZCA9PT0gTWF0cml4Q2xpZW50UGVnLmdldCgpLmNyZWRlbnRpYWxzLnVzZXJJZCkgcmV0dXJuO1xuXG4gICAgICAgIC8vIE1vdmUgdGhlIHVzZXIgdGhhdCBzcG9rZSB0byB0aGUgZnJvbnQgb2YgdGhlIGFycmF5XG4gICAgICAgIHRoaXMudXNlcnMuc3BsaWNlKFxuICAgICAgICAgICAgdGhpcy51c2Vycy5maW5kSW5kZXgoKHVzZXIyKSA9PiB1c2VyMi51c2VySWQgPT09IHVzZXIudXNlcklkKSwgMSk7XG4gICAgICAgIHRoaXMudXNlcnMgPSBbdXNlciwgLi4udGhpcy51c2Vyc107XG5cbiAgICAgICAgdGhpcy5tYXRjaGVyLnNldE9iamVjdHModGhpcy51c2Vycyk7XG4gICAgfVxuXG4gICAgcmVuZGVyQ29tcGxldGlvbnMoY29tcGxldGlvbnM6IFJlYWN0LlJlYWN0Tm9kZVtdKTogUmVhY3QuUmVhY3ROb2RlIHtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXZcbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9BdXRvY29tcGxldGVfQ29tcGxldGlvbl9jb250YWluZXJfcGlsbFwiXG4gICAgICAgICAgICAgICAgcm9sZT1cInByZXNlbnRhdGlvblwiXG4gICAgICAgICAgICAgICAgYXJpYS1sYWJlbD17X3QoXCJVc2VyIEF1dG9jb21wbGV0ZVwiKX1cbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICB7IGNvbXBsZXRpb25zIH1cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICApO1xuICAgIH1cblxuICAgIHNob3VsZEZvcmNlQ29tcGxldGUoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbn1cbiJdfQ==