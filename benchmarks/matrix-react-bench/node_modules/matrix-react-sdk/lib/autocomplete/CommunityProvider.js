"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _languageHandler = require("../languageHandler");

var _AutocompleteProvider = _interopRequireDefault(require("./AutocompleteProvider"));

var _MatrixClientPeg = require("../MatrixClientPeg");

var _QueryMatcher = _interopRequireDefault(require("./QueryMatcher"));

var _Components = require("./Components");

var _lodash = require("lodash");

var _Permalinks = require("../utils/permalinks/Permalinks");

var _FlairStore = _interopRequireDefault(require("../stores/FlairStore"));

var _Media = require("../customisations/Media");

var _BaseAvatar = _interopRequireDefault(require("../components/views/avatars/BaseAvatar"));

/*
Copyright 2018 New Vector Ltd
Copyright 2018 Michael Telatynski <7t3chguy@gmail.com>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const COMMUNITY_REGEX = /\B\+\S*/g;

function score(query, space) {
  const index = space.indexOf(query);

  if (index === -1) {
    return Infinity;
  } else {
    return index;
  }
}

class CommunityProvider extends _AutocompleteProvider.default {
  constructor(room, renderingType) {
    super({
      commandRegex: COMMUNITY_REGEX,
      renderingType
    });
    (0, _defineProperty2.default)(this, "matcher", void 0);
    this.matcher = new _QueryMatcher.default([], {
      keys: ['groupId', 'name', 'shortDescription']
    });
  }

  async getCompletions(query, selection, force = false, limit = -1) {
    // Disable autocompletions when composing commands because of various issues
    // (see https://github.com/vector-im/element-web/issues/4762)
    if (/^(\/join|\/leave)/.test(query)) {
      return [];
    }

    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    let completions = [];
    const {
      command,
      range
    } = this.getCurrentCommand(query, selection, force);

    if (command) {
      const joinedGroups = cli.getGroups().filter(({
        myMembership
      }) => myMembership === 'join');
      const groups = await Promise.all(joinedGroups.map(async ({
        groupId
      }) => {
        try {
          return _FlairStore.default.getGroupProfileCached(cli, groupId);
        } catch (e) {
          // if FlairStore failed, fall back to just groupId
          return Promise.resolve({
            name: '',
            groupId,
            avatarUrl: '',
            shortDescription: ''
          });
        }
      }));
      this.matcher.setObjects(groups);
      const matchedString = command[0];
      completions = this.matcher.match(matchedString, limit);
      completions = (0, _lodash.sortBy)(completions, [c => score(matchedString, c.groupId), c => c.groupId.length]).map(({
        avatarUrl,
        groupId,
        name
      }) => ({
        completion: groupId,
        suffix: ' ',
        type: "community",
        href: (0, _Permalinks.makeGroupPermalink)(groupId),
        component: /*#__PURE__*/_react.default.createElement(_Components.PillCompletion, {
          title: name,
          description: groupId
        }, /*#__PURE__*/_react.default.createElement(_BaseAvatar.default, {
          name: name || groupId,
          width: 24,
          height: 24,
          url: avatarUrl ? (0, _Media.mediaFromMxc)(avatarUrl).getSquareThumbnailHttp(24) : null
        })),
        range
      })).slice(0, 4);
    }

    return completions;
  }

  getName() {
    return 'ðŸ’¬ ' + (0, _languageHandler._t)('Communities');
  }

  renderCompletions(completions) {
    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_Autocomplete_Completion_container_pill mx_Autocomplete_Completion_container_truncate",
      role: "presentation",
      "aria-label": (0, _languageHandler._t)("Community Autocomplete")
    }, completions);
  }

}

exports.default = CommunityProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hdXRvY29tcGxldGUvQ29tbXVuaXR5UHJvdmlkZXIudHN4Il0sIm5hbWVzIjpbIkNPTU1VTklUWV9SRUdFWCIsInNjb3JlIiwicXVlcnkiLCJzcGFjZSIsImluZGV4IiwiaW5kZXhPZiIsIkluZmluaXR5IiwiQ29tbXVuaXR5UHJvdmlkZXIiLCJBdXRvY29tcGxldGVQcm92aWRlciIsImNvbnN0cnVjdG9yIiwicm9vbSIsInJlbmRlcmluZ1R5cGUiLCJjb21tYW5kUmVnZXgiLCJtYXRjaGVyIiwiUXVlcnlNYXRjaGVyIiwia2V5cyIsImdldENvbXBsZXRpb25zIiwic2VsZWN0aW9uIiwiZm9yY2UiLCJsaW1pdCIsInRlc3QiLCJjbGkiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJjb21wbGV0aW9ucyIsImNvbW1hbmQiLCJyYW5nZSIsImdldEN1cnJlbnRDb21tYW5kIiwiam9pbmVkR3JvdXBzIiwiZ2V0R3JvdXBzIiwiZmlsdGVyIiwibXlNZW1iZXJzaGlwIiwiZ3JvdXBzIiwiUHJvbWlzZSIsImFsbCIsIm1hcCIsImdyb3VwSWQiLCJGbGFpclN0b3JlIiwiZ2V0R3JvdXBQcm9maWxlQ2FjaGVkIiwiZSIsInJlc29sdmUiLCJuYW1lIiwiYXZhdGFyVXJsIiwic2hvcnREZXNjcmlwdGlvbiIsInNldE9iamVjdHMiLCJtYXRjaGVkU3RyaW5nIiwibWF0Y2giLCJjIiwibGVuZ3RoIiwiY29tcGxldGlvbiIsInN1ZmZpeCIsInR5cGUiLCJocmVmIiwiY29tcG9uZW50IiwiZ2V0U3F1YXJlVGh1bWJuYWlsSHR0cCIsInNsaWNlIiwiZ2V0TmFtZSIsInJlbmRlckNvbXBsZXRpb25zIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWlCQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUE3QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFD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QUE7QUFBdEIsT0FBRCxNQUFtQztBQUN0Q1EsUUFBQUEsVUFBVSxFQUFFYixPQUQwQjtBQUV0Q2MsUUFBQUEsTUFBTSxFQUFFLEdBRjhCO0FBR3RDQyxRQUFBQSxJQUFJLEVBQUUsV0FIZ0M7QUFJdENDLFFBQUFBLElBQUksRUFBRSxvQ0FBbUJoQixPQUFuQixDQUpnQztBQUt0Q2lCLFFBQUFBLFNBQVMsZUFDTCw2QkFBQywwQkFBRDtBQUFnQixVQUFBLEtBQUssRUFBRVosSUFBdkI7QUFBNkIsVUFBQSxXQUFXLEVBQUVMO0FBQTFDLHdCQUNJLDZCQUFDLG1CQUFEO0FBQ0ksVUFBQSxJQUFJLEVBQUVLLElBQUksSUFBSUwsT0FEbEI7QUFFSSxVQUFBLEtBQUssRUFBRSxFQUZYO0FBR0ksVUFBQSxNQUFNLEVBQUUsRUFIWjtBQUlJLFVBQUEsR0FBRyxFQUFFTSxTQUFTLEdBQUcseUJBQWFBLFNBQWIsRUFBd0JZLHNCQUF4QixDQUErQyxFQUEvQyxDQUFILEdBQXdEO0FBSjFFLFVBREosQ0FOa0M7QUFjdEM1QixRQUFBQTtBQWRzQyxPQUFuQyxDQUhPLEVBa0JWNkIsS0FsQlUsQ0FrQkosQ0FsQkksRUFrQkQsQ0FsQkMsQ0FBZDtBQW1CSDs7QUFDRCxXQUFPL0IsV0FBUDtBQUNIOztBQUVEZ0MsRUFBQUEsT0FBTyxHQUFHO0FBQ04sV0FBTyxRQUFRLHlCQUFHLGFBQUgsQ0FBZjtBQUNIOztBQUVEQyxFQUFBQSxpQkFBaUIsQ0FBQ2pDLFdBQUQsRUFBa0Q7QUFDL0Qsd0JBQ0k7QUFDSSxNQUFBLFNBQVMsRUFBQyx5RkFEZDtBQUVJLE1BQUEsSUFBSSxFQUFDLGNBRlQ7QUFHSSxvQkFBWSx5QkFBRyx3QkFBSDtBQUhoQixPQUtNQSxXQUxOLENBREo7QUFTSDs7QUFsRitEIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE4IE5ldyBWZWN0b3IgTHRkXG5Db3B5cmlnaHQgMjAxOCBNaWNoYWVsIFRlbGF0eW5za2kgPDd0M2NoZ3V5QGdtYWlsLmNvbT5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IEdyb3VwIGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvZ3JvdXBcIjtcbmltcG9ydCB7IF90IH0gZnJvbSAnLi4vbGFuZ3VhZ2VIYW5kbGVyJztcbmltcG9ydCBBdXRvY29tcGxldGVQcm92aWRlciBmcm9tICcuL0F1dG9jb21wbGV0ZVByb3ZpZGVyJztcbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gJy4uL01hdHJpeENsaWVudFBlZyc7XG5pbXBvcnQgUXVlcnlNYXRjaGVyIGZyb20gJy4vUXVlcnlNYXRjaGVyJztcbmltcG9ydCB7IFBpbGxDb21wbGV0aW9uIH0gZnJvbSAnLi9Db21wb25lbnRzJztcbmltcG9ydCB7IHNvcnRCeSB9IGZyb20gXCJsb2Rhc2hcIjtcbmltcG9ydCB7IG1ha2VHcm91cFBlcm1hbGluayB9IGZyb20gXCIuLi91dGlscy9wZXJtYWxpbmtzL1Blcm1hbGlua3NcIjtcbmltcG9ydCB7IElDb21wbGV0aW9uLCBJU2VsZWN0aW9uUmFuZ2UgfSBmcm9tIFwiLi9BdXRvY29tcGxldGVyXCI7XG5pbXBvcnQgRmxhaXJTdG9yZSBmcm9tIFwiLi4vc3RvcmVzL0ZsYWlyU3RvcmVcIjtcbmltcG9ydCB7IG1lZGlhRnJvbU14YyB9IGZyb20gXCIuLi9jdXN0b21pc2F0aW9ucy9NZWRpYVwiO1xuaW1wb3J0IEJhc2VBdmF0YXIgZnJvbSAnLi4vY29tcG9uZW50cy92aWV3cy9hdmF0YXJzL0Jhc2VBdmF0YXInO1xuaW1wb3J0IHsgUm9vbSB9IGZyb20gJ21hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yb29tJztcbmltcG9ydCB7IFRpbWVsaW5lUmVuZGVyaW5nVHlwZSB9IGZyb20gJy4uL2NvbnRleHRzL1Jvb21Db250ZXh0JztcblxuY29uc3QgQ09NTVVOSVRZX1JFR0VYID0gL1xcQlxcK1xcUyovZztcblxuZnVuY3Rpb24gc2NvcmUocXVlcnksIHNwYWNlKSB7XG4gICAgY29uc3QgaW5kZXggPSBzcGFjZS5pbmRleE9mKHF1ZXJ5KTtcbiAgICBpZiAoaW5kZXggPT09IC0xKSB7XG4gICAgICAgIHJldHVybiBJbmZpbml0eTtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gaW5kZXg7XG4gICAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDb21tdW5pdHlQcm92aWRlciBleHRlbmRzIEF1dG9jb21wbGV0ZVByb3ZpZGVyIHtcbiAgICBtYXRjaGVyOiBRdWVyeU1hdGNoZXI8R3JvdXA+O1xuXG4gICAgY29uc3RydWN0b3Iocm9vbTogUm9vbSwgcmVuZGVyaW5nVHlwZT86IFRpbWVsaW5lUmVuZGVyaW5nVHlwZSkge1xuICAgICAgICBzdXBlcih7IGNvbW1hbmRSZWdleDogQ09NTVVOSVRZX1JFR0VYLCByZW5kZXJpbmdUeXBlIH0pO1xuICAgICAgICB0aGlzLm1hdGNoZXIgPSBuZXcgUXVlcnlNYXRjaGVyKFtdLCB7XG4gICAgICAgICAgICBrZXlzOiBbJ2dyb3VwSWQnLCAnbmFtZScsICdzaG9ydERlc2NyaXB0aW9uJ10sXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIGdldENvbXBsZXRpb25zKFxuICAgICAgICBxdWVyeTogc3RyaW5nLFxuICAgICAgICBzZWxlY3Rpb246IElTZWxlY3Rpb25SYW5nZSxcbiAgICAgICAgZm9yY2UgPSBmYWxzZSxcbiAgICAgICAgbGltaXQgPSAtMSxcbiAgICApOiBQcm9taXNlPElDb21wbGV0aW9uW10+IHtcbiAgICAgICAgLy8gRGlzYWJsZSBhdXRvY29tcGxldGlvbnMgd2hlbiBjb21wb3NpbmcgY29tbWFuZHMgYmVjYXVzZSBvZiB2YXJpb3VzIGlzc3Vlc1xuICAgICAgICAvLyAoc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS92ZWN0b3ItaW0vZWxlbWVudC13ZWIvaXNzdWVzLzQ3NjIpXG4gICAgICAgIGlmICgvXihcXC9qb2lufFxcL2xlYXZlKS8udGVzdChxdWVyeSkpIHtcbiAgICAgICAgICAgIHJldHVybiBbXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICAgICAgbGV0IGNvbXBsZXRpb25zID0gW107XG4gICAgICAgIGNvbnN0IHsgY29tbWFuZCwgcmFuZ2UgfSA9IHRoaXMuZ2V0Q3VycmVudENvbW1hbmQocXVlcnksIHNlbGVjdGlvbiwgZm9yY2UpO1xuICAgICAgICBpZiAoY29tbWFuZCkge1xuICAgICAgICAgICAgY29uc3Qgam9pbmVkR3JvdXBzID0gY2xpLmdldEdyb3VwcygpLmZpbHRlcigoeyBteU1lbWJlcnNoaXAgfSkgPT4gbXlNZW1iZXJzaGlwID09PSAnam9pbicpO1xuXG4gICAgICAgICAgICBjb25zdCBncm91cHMgPSAoYXdhaXQgUHJvbWlzZS5hbGwoam9pbmVkR3JvdXBzLm1hcChhc3luYyAoeyBncm91cElkIH0pID0+IHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmxhaXJTdG9yZS5nZXRHcm91cFByb2ZpbGVDYWNoZWQoY2xpLCBncm91cElkKTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7IC8vIGlmIEZsYWlyU3RvcmUgZmFpbGVkLCBmYWxsIGJhY2sgdG8ganVzdCBncm91cElkXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogJycsXG4gICAgICAgICAgICAgICAgICAgICAgICBncm91cElkLFxuICAgICAgICAgICAgICAgICAgICAgICAgYXZhdGFyVXJsOiAnJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHNob3J0RGVzY3JpcHRpb246ICcnLFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KSkpO1xuXG4gICAgICAgICAgICB0aGlzLm1hdGNoZXIuc2V0T2JqZWN0cyhncm91cHMpO1xuXG4gICAgICAgICAgICBjb25zdCBtYXRjaGVkU3RyaW5nID0gY29tbWFuZFswXTtcbiAgICAgICAgICAgIGNvbXBsZXRpb25zID0gdGhpcy5tYXRjaGVyLm1hdGNoKG1hdGNoZWRTdHJpbmcsIGxpbWl0KTtcbiAgICAgICAgICAgIGNvbXBsZXRpb25zID0gc29ydEJ5KGNvbXBsZXRpb25zLCBbXG4gICAgICAgICAgICAgICAgKGMpID0+IHNjb3JlKG1hdGNoZWRTdHJpbmcsIGMuZ3JvdXBJZCksXG4gICAgICAgICAgICAgICAgKGMpID0+IGMuZ3JvdXBJZC5sZW5ndGgsXG4gICAgICAgICAgICBdKS5tYXAoKHsgYXZhdGFyVXJsLCBncm91cElkLCBuYW1lIH0pID0+ICh7XG4gICAgICAgICAgICAgICAgY29tcGxldGlvbjogZ3JvdXBJZCxcbiAgICAgICAgICAgICAgICBzdWZmaXg6ICcgJyxcbiAgICAgICAgICAgICAgICB0eXBlOiBcImNvbW11bml0eVwiLFxuICAgICAgICAgICAgICAgIGhyZWY6IG1ha2VHcm91cFBlcm1hbGluayhncm91cElkKSxcbiAgICAgICAgICAgICAgICBjb21wb25lbnQ6IChcbiAgICAgICAgICAgICAgICAgICAgPFBpbGxDb21wbGV0aW9uIHRpdGxlPXtuYW1lfSBkZXNjcmlwdGlvbj17Z3JvdXBJZH0+XG4gICAgICAgICAgICAgICAgICAgICAgICA8QmFzZUF2YXRhclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU9e25hbWUgfHwgZ3JvdXBJZH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWR0aD17MjR9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0PXsyNH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmw9e2F2YXRhclVybCA/IG1lZGlhRnJvbU14YyhhdmF0YXJVcmwpLmdldFNxdWFyZVRodW1ibmFpbEh0dHAoMjQpIDogbnVsbH0gLz5cbiAgICAgICAgICAgICAgICAgICAgPC9QaWxsQ29tcGxldGlvbj5cbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgIHJhbmdlLFxuICAgICAgICAgICAgfSkpLnNsaWNlKDAsIDQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjb21wbGV0aW9ucztcbiAgICB9XG5cbiAgICBnZXROYW1lKCkge1xuICAgICAgICByZXR1cm4gJ/CfkqwgJyArIF90KCdDb21tdW5pdGllcycpO1xuICAgIH1cblxuICAgIHJlbmRlckNvbXBsZXRpb25zKGNvbXBsZXRpb25zOiBSZWFjdC5SZWFjdE5vZGVbXSk6IFJlYWN0LlJlYWN0Tm9kZSB7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8ZGl2XG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfQXV0b2NvbXBsZXRlX0NvbXBsZXRpb25fY29udGFpbmVyX3BpbGwgbXhfQXV0b2NvbXBsZXRlX0NvbXBsZXRpb25fY29udGFpbmVyX3RydW5jYXRlXCJcbiAgICAgICAgICAgICAgICByb2xlPVwicHJlc2VudGF0aW9uXCJcbiAgICAgICAgICAgICAgICBhcmlhLWxhYmVsPXtfdChcIkNvbW11bml0eSBBdXRvY29tcGxldGVcIil9XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgeyBjb21wbGV0aW9ucyB9XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=