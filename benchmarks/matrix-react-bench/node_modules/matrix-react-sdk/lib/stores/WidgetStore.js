"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _AsyncStoreWithClient = require("./AsyncStoreWithClient");

var _dispatcher = _interopRequireDefault(require("../dispatcher/dispatcher"));

var _WidgetEchoStore = _interopRequireDefault(require("../stores/WidgetEchoStore"));

var _ActiveWidgetStore = _interopRequireDefault(require("../stores/ActiveWidgetStore"));

var _WidgetUtils = _interopRequireDefault(require("../utils/WidgetUtils"));

var _WidgetType = require("../widgets/WidgetType");

var _AsyncStore = require("./AsyncStore");

var _MatrixClientPeg = require("../MatrixClientPeg");

var _logger = require("matrix-js-sdk/src/logger");

/*
Copyright 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
function widgetUid(app) {
  return `${app.roomId ?? _MatrixClientPeg.MatrixClientPeg.get().getUserId()}::${app.id}`;
} // TODO consolidate WidgetEchoStore into this
// TODO consolidate ActiveWidgetStore into this


class WidgetStore extends _AsyncStoreWithClient.AsyncStoreWithClient {
  // Key is widget Unique ID (UID)
  // Key is room ID
  constructor() {
    super(_dispatcher.default, {});
    (0, _defineProperty2.default)(this, "widgetMap", new Map());
    (0, _defineProperty2.default)(this, "roomMap", new Map());
    (0, _defineProperty2.default)(this, "onWidgetEchoStoreUpdate", (roomId, widgetId) => {
      this.initRoom(roomId);
      this.loadRoomWidgets(this.matrixClient.getRoom(roomId));
      this.emit(_AsyncStore.UPDATE_EVENT, roomId);
    });
    (0, _defineProperty2.default)(this, "onRoom", room => {
      this.initRoom(room.roomId);
      this.loadRoomWidgets(room);
      this.emit(_AsyncStore.UPDATE_EVENT, room.roomId);
    });
    (0, _defineProperty2.default)(this, "onRoomStateEvents", ev => {
      if (ev.getType() !== "im.vector.modular.widgets") return; // TODO: Support m.widget too

      const roomId = ev.getRoomId();
      this.initRoom(roomId);
      this.loadRoomWidgets(this.matrixClient.getRoom(roomId));
      this.emit(_AsyncStore.UPDATE_EVENT, roomId);
    });
    (0, _defineProperty2.default)(this, "getRoom", (roomId, initIfNeeded = false) => {
      if (initIfNeeded) this.initRoom(roomId); // internally handles "if needed"

      return this.roomMap.get(roomId);
    });

    _WidgetEchoStore.default.on("update", this.onWidgetEchoStoreUpdate);
  }

  static get instance() {
    return WidgetStore.internalInstance;
  }

  initRoom(roomId) {
    if (!this.roomMap.has(roomId)) {
      this.roomMap.set(roomId, {
        widgets: []
      });
    }
  }

  async onReady() {
    this.matrixClient.on("Room", this.onRoom);
    this.matrixClient.on("RoomState.events", this.onRoomStateEvents);
    this.matrixClient.getRooms().forEach(room => {
      this.loadRoomWidgets(room);
    });
    this.emit(_AsyncStore.UPDATE_EVENT, null); // emit for all rooms
  }

  async onNotReady() {
    this.matrixClient.off("Room", this.onRoom);
    this.matrixClient.off("RoomState.events", this.onRoomStateEvents);
    this.widgetMap = new Map();
    this.roomMap = new Map();
    await this.reset({});
  } // We don't need this, but our contract says we do.


  async onAction(payload) {
    return;
  }

  generateApps(room) {
    return _WidgetEchoStore.default.getEchoedRoomWidgets(room.roomId, _WidgetUtils.default.getRoomWidgets(room)).map(ev => {
      return _WidgetUtils.default.makeAppConfig(ev.getStateKey(), ev.getContent(), ev.getSender(), ev.getRoomId(), ev.getId());
    });
  }

  loadRoomWidgets(room) {
    if (!room) return;
    const roomInfo = this.roomMap.get(room.roomId) || {};
    roomInfo.widgets = []; // first clean out old widgets from the map which originate from this room
    // otherwise we are out of sync with the rest of the app with stale widget events during removal

    Array.from(this.widgetMap.values()).forEach(app => {
      if (app.roomId !== room.roomId) return; // skip - wrong room

      this.widgetMap.delete(widgetUid(app));
    });
    let edited = false;
    this.generateApps(room).forEach(app => {
      // Sanity check for https://github.com/vector-im/element-web/issues/15705
      const existingApp = this.widgetMap.get(widgetUid(app));

      if (existingApp) {
        _logger.logger.warn(`Possible widget ID conflict for ${app.id} - wants to store in room ${app.roomId} ` + `but is currently stored as ${existingApp.roomId} - letting the want win`);
      }

      this.widgetMap.set(widgetUid(app), app);
      roomInfo.widgets.push(app);
      edited = true;
    });

    if (edited && !this.roomMap.has(room.roomId)) {
      this.roomMap.set(room.roomId, roomInfo);
    } // If a persistent widget is active, check to see if it's just been removed.
    // If it has, it needs to destroyed otherwise unmounting the node won't kill it


    const persistentWidgetId = _ActiveWidgetStore.default.instance.getPersistentWidgetId();

    if (persistentWidgetId) {
      if (_ActiveWidgetStore.default.instance.getRoomId(persistentWidgetId) === room.roomId && !roomInfo.widgets.some(w => w.id === persistentWidgetId)) {
        _logger.logger.log(`Persistent widget ${persistentWidgetId} removed from room ${room.roomId}: destroying.`);

        _ActiveWidgetStore.default.instance.destroyPersistentWidget(persistentWidgetId);
      }
    }

    this.emit(room.roomId);
  }

  getApps(roomId) {
    const roomInfo = this.getRoom(roomId);
    return (roomInfo === null || roomInfo === void 0 ? void 0 : roomInfo.widgets) || [];
  }

  doesRoomHaveConference(room) {
    const roomInfo = this.getRoom(room.roomId);
    if (!roomInfo) return false;
    const currentWidgets = roomInfo.widgets.filter(w => _WidgetType.WidgetType.JITSI.matches(w.type));

    const hasPendingWidgets = _WidgetEchoStore.default.roomHasPendingWidgetsOfType(room.roomId, [], _WidgetType.WidgetType.JITSI);

    return currentWidgets.length > 0 || hasPendingWidgets;
  }

  isJoinedToConferenceIn(room) {
    const roomInfo = this.getRoom(room.roomId);
    if (!roomInfo) return false; // A persistent conference widget indicates that we're participating

    const widgets = roomInfo.widgets.filter(w => _WidgetType.WidgetType.JITSI.matches(w.type));
    return widgets.some(w => _ActiveWidgetStore.default.instance.getWidgetPersistence(w.id));
  }

}

exports.default = WidgetStore;
(0, _defineProperty2.default)(WidgetStore, "internalInstance", new WidgetStore());
window.mxWidgetStore = WidgetStore.instance;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdG9yZXMvV2lkZ2V0U3RvcmUudHMiXSwibmFtZXMiOlsid2lkZ2V0VWlkIiwiYXBwIiwicm9vbUlkIiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0IiwiZ2V0VXNlcklkIiwiaWQiLCJXaWRnZXRTdG9yZSIsIkFzeW5jU3RvcmVXaXRoQ2xpZW50IiwiY29uc3RydWN0b3IiLCJkZWZhdWx0RGlzcGF0Y2hlciIsIk1hcCIsIndpZGdldElkIiwiaW5pdFJvb20iLCJsb2FkUm9vbVdpZGdldHMiLCJtYXRyaXhDbGllbnQiLCJnZXRSb29tIiwiZW1pdCIsIlVQREFURV9FVkVOVCIsInJvb20iLCJldiIsImdldFR5cGUiLCJnZXRSb29tSWQiLCJpbml0SWZOZWVkZWQiLCJyb29tTWFwIiwiV2lkZ2V0RWNob1N0b3JlIiwib24iLCJvbldpZGdldEVjaG9TdG9yZVVwZGF0ZSIsImluc3RhbmNlIiwiaW50ZXJuYWxJbnN0YW5jZSIsImhhcyIsInNldCIsIndpZGdldHMiLCJvblJlYWR5Iiwib25Sb29tIiwib25Sb29tU3RhdGVFdmVudHMiLCJnZXRSb29tcyIsImZvckVhY2giLCJvbk5vdFJlYWR5Iiwib2ZmIiwid2lkZ2V0TWFwIiwicmVzZXQiLCJvbkFjdGlvbiIsInBheWxvYWQiLCJnZW5lcmF0ZUFwcHMiLCJnZXRFY2hvZWRSb29tV2lkZ2V0cyIsIldpZGdldFV0aWxzIiwiZ2V0Um9vbVdpZGdldHMiLCJtYXAiLCJtYWtlQXBwQ29uZmlnIiwiZ2V0U3RhdGVLZXkiLCJnZXRDb250ZW50IiwiZ2V0U2VuZGVyIiwiZ2V0SWQiLCJyb29tSW5mbyIsIkFycmF5IiwiZnJvbSIsInZhbHVlcyIsImRlbGV0ZSIsImVkaXRlZCIsImV4aXN0aW5nQXBwIiwibG9nZ2VyIiwid2FybiIsInB1c2giLCJwZXJzaXN0ZW50V2lkZ2V0SWQiLCJBY3RpdmVXaWRnZXRTdG9yZSIsImdldFBlcnNpc3RlbnRXaWRnZXRJZCIsInNvbWUiLCJ3IiwibG9nIiwiZGVzdHJveVBlcnNpc3RlbnRXaWRnZXQiLCJnZXRBcHBzIiwiZG9lc1Jvb21IYXZlQ29uZmVyZW5jZSIsImN1cnJlbnRXaWRnZXRzIiwiZmlsdGVyIiwiV2lkZ2V0VHlwZSIsIkpJVFNJIiwibWF0Y2hlcyIsInR5cGUiLCJoYXNQZW5kaW5nV2lkZ2V0cyIsInJvb21IYXNQZW5kaW5nV2lkZ2V0c09mVHlwZSIsImxlbmd0aCIsImlzSm9pbmVkVG9Db25mZXJlbmNlSW4iLCJnZXRXaWRnZXRQZXJzaXN0ZW5jZSIsIndpbmRvdyIsIm14V2lkZ2V0U3RvcmUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBcUJBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQTlCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUErQkEsU0FBU0EsU0FBVCxDQUFtQkMsR0FBbkIsRUFBc0M7QUFDbEMsU0FBUSxHQUFFQSxHQUFHLENBQUNDLE1BQUosSUFBY0MsaUNBQWdCQyxHQUFoQixHQUFzQkMsU0FBdEIsRUFBa0MsS0FBSUosR0FBRyxDQUFDSyxFQUFHLEVBQXJFO0FBQ0gsQyxDQUVEO0FBQ0E7OztBQUNlLE1BQU1DLFdBQU4sU0FBMEJDLDBDQUExQixDQUF1RDtBQUdyQjtBQUNNO0FBRTNDQyxFQUFBQSxXQUFXLEdBQUc7QUFDbEIsVUFBTUMsbUJBQU4sRUFBeUIsRUFBekI7QUFEa0IscURBSEYsSUFBSUMsR0FBSixFQUdFO0FBQUEsbURBRkosSUFBSUEsR0FBSixFQUVJO0FBQUEsbUVBd0NZLENBQUNULE1BQUQsRUFBaUJVLFFBQWpCLEtBQXNDO0FBQ3BFLFdBQUtDLFFBQUwsQ0FBY1gsTUFBZDtBQUNBLFdBQUtZLGVBQUwsQ0FBcUIsS0FBS0MsWUFBTCxDQUFrQkMsT0FBbEIsQ0FBMEJkLE1BQTFCLENBQXJCO0FBQ0EsV0FBS2UsSUFBTCxDQUFVQyx3QkFBVixFQUF3QmhCLE1BQXhCO0FBQ0gsS0E1Q3FC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aUU7Ozs4QkFBakRDLFcsc0JBQ2lCLElBQUlBLFdBQUosRTtBQXFKdEM2RSxNQUFNLENBQUNDLGFBQVAsR0FBdUI5RSxXQUFXLENBQUNxQixRQUFuQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAyMCBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCB7IFJvb20gfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3Jvb21cIjtcbmltcG9ydCB7IE1hdHJpeEV2ZW50IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9ldmVudFwiO1xuaW1wb3J0IHsgSVdpZGdldCB9IGZyb20gXCJtYXRyaXgtd2lkZ2V0LWFwaVwiO1xuXG5pbXBvcnQgeyBBY3Rpb25QYXlsb2FkIH0gZnJvbSBcIi4uL2Rpc3BhdGNoZXIvcGF5bG9hZHNcIjtcbmltcG9ydCB7IEFzeW5jU3RvcmVXaXRoQ2xpZW50IH0gZnJvbSBcIi4vQXN5bmNTdG9yZVdpdGhDbGllbnRcIjtcbmltcG9ydCBkZWZhdWx0RGlzcGF0Y2hlciBmcm9tIFwiLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyXCI7XG5pbXBvcnQgV2lkZ2V0RWNob1N0b3JlIGZyb20gXCIuLi9zdG9yZXMvV2lkZ2V0RWNob1N0b3JlXCI7XG5pbXBvcnQgQWN0aXZlV2lkZ2V0U3RvcmUgZnJvbSBcIi4uL3N0b3Jlcy9BY3RpdmVXaWRnZXRTdG9yZVwiO1xuaW1wb3J0IFdpZGdldFV0aWxzIGZyb20gXCIuLi91dGlscy9XaWRnZXRVdGlsc1wiO1xuaW1wb3J0IHsgV2lkZ2V0VHlwZSB9IGZyb20gXCIuLi93aWRnZXRzL1dpZGdldFR5cGVcIjtcbmltcG9ydCB7IFVQREFURV9FVkVOVCB9IGZyb20gXCIuL0FzeW5jU3RvcmVcIjtcbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gXCIuLi9NYXRyaXhDbGllbnRQZWdcIjtcblxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2xvZ2dlclwiO1xuXG5pbnRlcmZhY2UgSVN0YXRlIHt9XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUFwcCBleHRlbmRzIElXaWRnZXQge1xuICAgIHJvb21JZDogc3RyaW5nO1xuICAgIGV2ZW50SWQ6IHN0cmluZztcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgY2FtZWxjYXNlXG4gICAgYXZhdGFyX3VybDogc3RyaW5nOyAvLyBNU0MyNzY1IGh0dHBzOi8vZ2l0aHViLmNvbS9tYXRyaXgtb3JnL21hdHJpeC1kb2MvcHVsbC8yNzY1XG59XG5cbmludGVyZmFjZSBJUm9vbVdpZGdldHMge1xuICAgIHdpZGdldHM6IElBcHBbXTtcbn1cblxuZnVuY3Rpb24gd2lkZ2V0VWlkKGFwcDogSUFwcCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGAke2FwcC5yb29tSWQgPz8gTWF0cml4Q2xpZW50UGVnLmdldCgpLmdldFVzZXJJZCgpfTo6JHthcHAuaWR9YDtcbn1cblxuLy8gVE9ETyBjb25zb2xpZGF0ZSBXaWRnZXRFY2hvU3RvcmUgaW50byB0aGlzXG4vLyBUT0RPIGNvbnNvbGlkYXRlIEFjdGl2ZVdpZGdldFN0b3JlIGludG8gdGhpc1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgV2lkZ2V0U3RvcmUgZXh0ZW5kcyBBc3luY1N0b3JlV2l0aENsaWVudDxJU3RhdGU+IHtcbiAgICBwcml2YXRlIHN0YXRpYyBpbnRlcm5hbEluc3RhbmNlID0gbmV3IFdpZGdldFN0b3JlKCk7XG5cbiAgICBwcml2YXRlIHdpZGdldE1hcCA9IG5ldyBNYXA8c3RyaW5nLCBJQXBwPigpOyAvLyBLZXkgaXMgd2lkZ2V0IFVuaXF1ZSBJRCAoVUlEKVxuICAgIHByaXZhdGUgcm9vbU1hcCA9IG5ldyBNYXA8c3RyaW5nLCBJUm9vbVdpZGdldHM+KCk7IC8vIEtleSBpcyByb29tIElEXG5cbiAgICBwcml2YXRlIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcihkZWZhdWx0RGlzcGF0Y2hlciwge30pO1xuXG4gICAgICAgIFdpZGdldEVjaG9TdG9yZS5vbihcInVwZGF0ZVwiLCB0aGlzLm9uV2lkZ2V0RWNob1N0b3JlVXBkYXRlKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGdldCBpbnN0YW5jZSgpOiBXaWRnZXRTdG9yZSB7XG4gICAgICAgIHJldHVybiBXaWRnZXRTdG9yZS5pbnRlcm5hbEluc3RhbmNlO1xuICAgIH1cblxuICAgIHByaXZhdGUgaW5pdFJvb20ocm9vbUlkOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKCF0aGlzLnJvb21NYXAuaGFzKHJvb21JZCkpIHtcbiAgICAgICAgICAgIHRoaXMucm9vbU1hcC5zZXQocm9vbUlkLCB7XG4gICAgICAgICAgICAgICAgd2lkZ2V0czogW10sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBhc3luYyBvblJlYWR5KCk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIHRoaXMubWF0cml4Q2xpZW50Lm9uKFwiUm9vbVwiLCB0aGlzLm9uUm9vbSk7XG4gICAgICAgIHRoaXMubWF0cml4Q2xpZW50Lm9uKFwiUm9vbVN0YXRlLmV2ZW50c1wiLCB0aGlzLm9uUm9vbVN0YXRlRXZlbnRzKTtcbiAgICAgICAgdGhpcy5tYXRyaXhDbGllbnQuZ2V0Um9vbXMoKS5mb3JFYWNoKChyb29tOiBSb29tKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmxvYWRSb29tV2lkZ2V0cyhyb29tKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuZW1pdChVUERBVEVfRVZFTlQsIG51bGwpOyAvLyBlbWl0IGZvciBhbGwgcm9vbXNcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgYXN5bmMgb25Ob3RSZWFkeSgpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICB0aGlzLm1hdHJpeENsaWVudC5vZmYoXCJSb29tXCIsIHRoaXMub25Sb29tKTtcbiAgICAgICAgdGhpcy5tYXRyaXhDbGllbnQub2ZmKFwiUm9vbVN0YXRlLmV2ZW50c1wiLCB0aGlzLm9uUm9vbVN0YXRlRXZlbnRzKTtcbiAgICAgICAgdGhpcy53aWRnZXRNYXAgPSBuZXcgTWFwKCk7XG4gICAgICAgIHRoaXMucm9vbU1hcCA9IG5ldyBNYXAoKTtcbiAgICAgICAgYXdhaXQgdGhpcy5yZXNldCh7fSk7XG4gICAgfVxuXG4gICAgLy8gV2UgZG9uJ3QgbmVlZCB0aGlzLCBidXQgb3VyIGNvbnRyYWN0IHNheXMgd2UgZG8uXG4gICAgcHJvdGVjdGVkIGFzeW5jIG9uQWN0aW9uKHBheWxvYWQ6IEFjdGlvblBheWxvYWQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25XaWRnZXRFY2hvU3RvcmVVcGRhdGUgPSAocm9vbUlkOiBzdHJpbmcsIHdpZGdldElkOiBzdHJpbmcpID0+IHtcbiAgICAgICAgdGhpcy5pbml0Um9vbShyb29tSWQpO1xuICAgICAgICB0aGlzLmxvYWRSb29tV2lkZ2V0cyh0aGlzLm1hdHJpeENsaWVudC5nZXRSb29tKHJvb21JZCkpO1xuICAgICAgICB0aGlzLmVtaXQoVVBEQVRFX0VWRU5ULCByb29tSWQpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIGdlbmVyYXRlQXBwcyhyb29tOiBSb29tKTogSUFwcFtdIHtcbiAgICAgICAgcmV0dXJuIFdpZGdldEVjaG9TdG9yZS5nZXRFY2hvZWRSb29tV2lkZ2V0cyhyb29tLnJvb21JZCwgV2lkZ2V0VXRpbHMuZ2V0Um9vbVdpZGdldHMocm9vbSkpLm1hcCgoZXYpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBXaWRnZXRVdGlscy5tYWtlQXBwQ29uZmlnKFxuICAgICAgICAgICAgICAgIGV2LmdldFN0YXRlS2V5KCksIGV2LmdldENvbnRlbnQoKSwgZXYuZ2V0U2VuZGVyKCksIGV2LmdldFJvb21JZCgpLCBldi5nZXRJZCgpLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBsb2FkUm9vbVdpZGdldHMocm9vbTogUm9vbSkge1xuICAgICAgICBpZiAoIXJvb20pIHJldHVybjtcbiAgICAgICAgY29uc3Qgcm9vbUluZm8gPSB0aGlzLnJvb21NYXAuZ2V0KHJvb20ucm9vbUlkKSB8fCA8SVJvb21XaWRnZXRzPnt9O1xuICAgICAgICByb29tSW5mby53aWRnZXRzID0gW107XG5cbiAgICAgICAgLy8gZmlyc3QgY2xlYW4gb3V0IG9sZCB3aWRnZXRzIGZyb20gdGhlIG1hcCB3aGljaCBvcmlnaW5hdGUgZnJvbSB0aGlzIHJvb21cbiAgICAgICAgLy8gb3RoZXJ3aXNlIHdlIGFyZSBvdXQgb2Ygc3luYyB3aXRoIHRoZSByZXN0IG9mIHRoZSBhcHAgd2l0aCBzdGFsZSB3aWRnZXQgZXZlbnRzIGR1cmluZyByZW1vdmFsXG4gICAgICAgIEFycmF5LmZyb20odGhpcy53aWRnZXRNYXAudmFsdWVzKCkpLmZvckVhY2goYXBwID0+IHtcbiAgICAgICAgICAgIGlmIChhcHAucm9vbUlkICE9PSByb29tLnJvb21JZCkgcmV0dXJuOyAvLyBza2lwIC0gd3Jvbmcgcm9vbVxuICAgICAgICAgICAgdGhpcy53aWRnZXRNYXAuZGVsZXRlKHdpZGdldFVpZChhcHApKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgbGV0IGVkaXRlZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLmdlbmVyYXRlQXBwcyhyb29tKS5mb3JFYWNoKGFwcCA9PiB7XG4gICAgICAgICAgICAvLyBTYW5pdHkgY2hlY2sgZm9yIGh0dHBzOi8vZ2l0aHViLmNvbS92ZWN0b3ItaW0vZWxlbWVudC13ZWIvaXNzdWVzLzE1NzA1XG4gICAgICAgICAgICBjb25zdCBleGlzdGluZ0FwcCA9IHRoaXMud2lkZ2V0TWFwLmdldCh3aWRnZXRVaWQoYXBwKSk7XG4gICAgICAgICAgICBpZiAoZXhpc3RpbmdBcHApIHtcbiAgICAgICAgICAgICAgICBsb2dnZXIud2FybihcbiAgICAgICAgICAgICAgICAgICAgYFBvc3NpYmxlIHdpZGdldCBJRCBjb25mbGljdCBmb3IgJHthcHAuaWR9IC0gd2FudHMgdG8gc3RvcmUgaW4gcm9vbSAke2FwcC5yb29tSWR9IGAgK1xuICAgICAgICAgICAgICAgICAgICBgYnV0IGlzIGN1cnJlbnRseSBzdG9yZWQgYXMgJHtleGlzdGluZ0FwcC5yb29tSWR9IC0gbGV0dGluZyB0aGUgd2FudCB3aW5gLFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMud2lkZ2V0TWFwLnNldCh3aWRnZXRVaWQoYXBwKSwgYXBwKTtcbiAgICAgICAgICAgIHJvb21JbmZvLndpZGdldHMucHVzaChhcHApO1xuICAgICAgICAgICAgZWRpdGVkID0gdHJ1ZTtcbiAgICAgICAgfSk7XG4gICAgICAgIGlmIChlZGl0ZWQgJiYgIXRoaXMucm9vbU1hcC5oYXMocm9vbS5yb29tSWQpKSB7XG4gICAgICAgICAgICB0aGlzLnJvb21NYXAuc2V0KHJvb20ucm9vbUlkLCByb29tSW5mbyk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBJZiBhIHBlcnNpc3RlbnQgd2lkZ2V0IGlzIGFjdGl2ZSwgY2hlY2sgdG8gc2VlIGlmIGl0J3MganVzdCBiZWVuIHJlbW92ZWQuXG4gICAgICAgIC8vIElmIGl0IGhhcywgaXQgbmVlZHMgdG8gZGVzdHJveWVkIG90aGVyd2lzZSB1bm1vdW50aW5nIHRoZSBub2RlIHdvbid0IGtpbGwgaXRcbiAgICAgICAgY29uc3QgcGVyc2lzdGVudFdpZGdldElkID0gQWN0aXZlV2lkZ2V0U3RvcmUuaW5zdGFuY2UuZ2V0UGVyc2lzdGVudFdpZGdldElkKCk7XG4gICAgICAgIGlmIChwZXJzaXN0ZW50V2lkZ2V0SWQpIHtcbiAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICBBY3RpdmVXaWRnZXRTdG9yZS5pbnN0YW5jZS5nZXRSb29tSWQocGVyc2lzdGVudFdpZGdldElkKSA9PT0gcm9vbS5yb29tSWQgJiZcbiAgICAgICAgICAgICAgICAhcm9vbUluZm8ud2lkZ2V0cy5zb21lKHcgPT4gdy5pZCA9PT0gcGVyc2lzdGVudFdpZGdldElkKVxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgbG9nZ2VyLmxvZyhgUGVyc2lzdGVudCB3aWRnZXQgJHtwZXJzaXN0ZW50V2lkZ2V0SWR9IHJlbW92ZWQgZnJvbSByb29tICR7cm9vbS5yb29tSWR9OiBkZXN0cm95aW5nLmApO1xuICAgICAgICAgICAgICAgIEFjdGl2ZVdpZGdldFN0b3JlLmluc3RhbmNlLmRlc3Ryb3lQZXJzaXN0ZW50V2lkZ2V0KHBlcnNpc3RlbnRXaWRnZXRJZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmVtaXQocm9vbS5yb29tSWQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25Sb29tID0gKHJvb206IFJvb20pID0+IHtcbiAgICAgICAgdGhpcy5pbml0Um9vbShyb29tLnJvb21JZCk7XG4gICAgICAgIHRoaXMubG9hZFJvb21XaWRnZXRzKHJvb20pO1xuICAgICAgICB0aGlzLmVtaXQoVVBEQVRFX0VWRU5ULCByb29tLnJvb21JZCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25Sb29tU3RhdGVFdmVudHMgPSAoZXY6IE1hdHJpeEV2ZW50KSA9PiB7XG4gICAgICAgIGlmIChldi5nZXRUeXBlKCkgIT09IFwiaW0udmVjdG9yLm1vZHVsYXIud2lkZ2V0c1wiKSByZXR1cm47IC8vIFRPRE86IFN1cHBvcnQgbS53aWRnZXQgdG9vXG4gICAgICAgIGNvbnN0IHJvb21JZCA9IGV2LmdldFJvb21JZCgpO1xuICAgICAgICB0aGlzLmluaXRSb29tKHJvb21JZCk7XG4gICAgICAgIHRoaXMubG9hZFJvb21XaWRnZXRzKHRoaXMubWF0cml4Q2xpZW50LmdldFJvb20ocm9vbUlkKSk7XG4gICAgICAgIHRoaXMuZW1pdChVUERBVEVfRVZFTlQsIHJvb21JZCk7XG4gICAgfTtcblxuICAgIHB1YmxpYyBnZXRSb29tID0gKHJvb21JZDogc3RyaW5nLCBpbml0SWZOZWVkZWQgPSBmYWxzZSkgPT4ge1xuICAgICAgICBpZiAoaW5pdElmTmVlZGVkKSB0aGlzLmluaXRSb29tKHJvb21JZCk7IC8vIGludGVybmFsbHkgaGFuZGxlcyBcImlmIG5lZWRlZFwiXG4gICAgICAgIHJldHVybiB0aGlzLnJvb21NYXAuZ2V0KHJvb21JZCk7XG4gICAgfTtcblxuICAgIHB1YmxpYyBnZXRBcHBzKHJvb21JZDogc3RyaW5nKTogSUFwcFtdIHtcbiAgICAgICAgY29uc3Qgcm9vbUluZm8gPSB0aGlzLmdldFJvb20ocm9vbUlkKTtcbiAgICAgICAgcmV0dXJuIHJvb21JbmZvPy53aWRnZXRzIHx8IFtdO1xuICAgIH1cblxuICAgIHB1YmxpYyBkb2VzUm9vbUhhdmVDb25mZXJlbmNlKHJvb206IFJvb20pOiBib29sZWFuIHtcbiAgICAgICAgY29uc3Qgcm9vbUluZm8gPSB0aGlzLmdldFJvb20ocm9vbS5yb29tSWQpO1xuICAgICAgICBpZiAoIXJvb21JbmZvKSByZXR1cm4gZmFsc2U7XG5cbiAgICAgICAgY29uc3QgY3VycmVudFdpZGdldHMgPSByb29tSW5mby53aWRnZXRzLmZpbHRlcih3ID0+IFdpZGdldFR5cGUuSklUU0kubWF0Y2hlcyh3LnR5cGUpKTtcbiAgICAgICAgY29uc3QgaGFzUGVuZGluZ1dpZGdldHMgPSBXaWRnZXRFY2hvU3RvcmUucm9vbUhhc1BlbmRpbmdXaWRnZXRzT2ZUeXBlKHJvb20ucm9vbUlkLCBbXSwgV2lkZ2V0VHlwZS5KSVRTSSk7XG4gICAgICAgIHJldHVybiBjdXJyZW50V2lkZ2V0cy5sZW5ndGggPiAwIHx8IGhhc1BlbmRpbmdXaWRnZXRzO1xuICAgIH1cblxuICAgIHB1YmxpYyBpc0pvaW5lZFRvQ29uZmVyZW5jZUluKHJvb206IFJvb20pOiBib29sZWFuIHtcbiAgICAgICAgY29uc3Qgcm9vbUluZm8gPSB0aGlzLmdldFJvb20ocm9vbS5yb29tSWQpO1xuICAgICAgICBpZiAoIXJvb21JbmZvKSByZXR1cm4gZmFsc2U7XG5cbiAgICAgICAgLy8gQSBwZXJzaXN0ZW50IGNvbmZlcmVuY2Ugd2lkZ2V0IGluZGljYXRlcyB0aGF0IHdlJ3JlIHBhcnRpY2lwYXRpbmdcbiAgICAgICAgY29uc3Qgd2lkZ2V0cyA9IHJvb21JbmZvLndpZGdldHMuZmlsdGVyKHcgPT4gV2lkZ2V0VHlwZS5KSVRTSS5tYXRjaGVzKHcudHlwZSkpO1xuICAgICAgICByZXR1cm4gd2lkZ2V0cy5zb21lKHcgPT4gQWN0aXZlV2lkZ2V0U3RvcmUuaW5zdGFuY2UuZ2V0V2lkZ2V0UGVyc2lzdGVuY2Uody5pZCkpO1xuICAgIH1cbn1cblxud2luZG93Lm14V2lkZ2V0U3RvcmUgPSBXaWRnZXRTdG9yZS5pbnN0YW5jZTtcbiJdfQ==