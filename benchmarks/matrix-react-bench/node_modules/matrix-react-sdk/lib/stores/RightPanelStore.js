"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _dispatcher = _interopRequireDefault(require("../dispatcher/dispatcher"));

var _verification = require("../verification");

var _utils = require("flux/utils");

var _SettingsStore = _interopRequireDefault(require("../settings/SettingsStore"));

var _RightPanelStorePhases = require("./RightPanelStorePhases");

var _actions = require("../dispatcher/actions");

var _SettingLevel = require("../settings/SettingLevel");

var _logger = require("matrix-js-sdk/src/logger");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

const INITIAL_STATE = {
  showRoomPanel: _SettingsStore.default.getValue("showRightPanelInRoom"),
  showGroupPanel: _SettingsStore.default.getValue("showRightPanelInGroup"),
  lastRoomPhase: _SettingsStore.default.getValue("lastRightPanelPhaseForRoom"),
  lastGroupPhase: _SettingsStore.default.getValue("lastRightPanelPhaseForGroup"),
  lastRoomPhaseParams: {}
};
const GROUP_PHASES = [_RightPanelStorePhases.RightPanelPhases.GroupMemberList, _RightPanelStorePhases.RightPanelPhases.GroupRoomList, _RightPanelStorePhases.RightPanelPhases.GroupRoomInfo, _RightPanelStorePhases.RightPanelPhases.GroupMemberInfo];
const MEMBER_INFO_PHASES = [_RightPanelStorePhases.RightPanelPhases.RoomMemberInfo, _RightPanelStorePhases.RightPanelPhases.Room3pidMemberInfo, _RightPanelStorePhases.RightPanelPhases.EncryptionPanel];
/**
 * A class for tracking the state of the right panel between layouts and
 * sessions.
 */

class RightPanelStore extends _utils.Store {
  constructor() {
    super(_dispatcher.default); // Initialise state

    (0, _defineProperty2.default)(this, "state", void 0);
    (0, _defineProperty2.default)(this, "lastRoomId", void 0);
    this.state = INITIAL_STATE;
  }

  get isOpenForRoom() {
    return this.state.showRoomPanel;
  }

  get isOpenForGroup() {
    return this.state.showGroupPanel;
  }

  get roomPanelPhase() {
    return this.state.lastRoomPhase;
  }

  get groupPanelPhase() {
    return this.state.lastGroupPhase;
  }

  get previousPhase() {
    return _RightPanelStorePhases.RIGHT_PANEL_PHASES_NO_ARGS.includes(this.state.previousPhase) ? this.state.previousPhase : null;
  }

  get visibleRoomPanelPhase() {
    return this.isOpenForRoom ? this.roomPanelPhase : null;
  }

  get visibleGroupPanelPhase() {
    return this.isOpenForGroup ? this.groupPanelPhase : null;
  }

  get roomPanelPhaseParams() {
    return this.state.lastRoomPhaseParams || {};
  }

  setState(newState) {
    this.state = Object.assign(this.state, newState);

    _SettingsStore.default.setValue("showRightPanelInRoom", null, _SettingLevel.SettingLevel.DEVICE, this.state.showRoomPanel);

    _SettingsStore.default.setValue("showRightPanelInGroup", null, _SettingLevel.SettingLevel.DEVICE, this.state.showGroupPanel);

    if (_RightPanelStorePhases.RIGHT_PANEL_PHASES_NO_ARGS.includes(this.state.lastRoomPhase)) {
      _SettingsStore.default.setValue("lastRightPanelPhaseForRoom", null, _SettingLevel.SettingLevel.DEVICE, this.state.lastRoomPhase);
    }

    if (_RightPanelStorePhases.RIGHT_PANEL_PHASES_NO_ARGS.includes(this.state.lastGroupPhase)) {
      _SettingsStore.default.setValue("lastRightPanelPhaseForGroup", null, _SettingLevel.SettingLevel.DEVICE, this.state.lastGroupPhase);
    }

    this.__emitChange();
  }

  __onDispatch(payload) {
    // eslint-disable-line @typescript-eslint/naming-convention
    switch (payload.action) {
      case _actions.Action.ViewRoom:
        if (payload.room_id === this.lastRoomId) break;
      // skip this transition, probably a permalink
      // fallthrough

      case 'view_group':
        this.lastRoomId = payload.room_id; // Reset to the member list if we're viewing member info

        if (MEMBER_INFO_PHASES.includes(this.state.lastRoomPhase)) {
          this.setState({
            lastRoomPhase: _RightPanelStorePhases.RightPanelPhases.RoomMemberList,
            lastRoomPhaseParams: {}
          });
        } // Do the same for groups


        if (this.state.lastGroupPhase === _RightPanelStorePhases.RightPanelPhases.GroupMemberInfo) {
          this.setState({
            lastGroupPhase: _RightPanelStorePhases.RightPanelPhases.GroupMemberList
          });
        }

        break;

      case _actions.Action.SetRightPanelPhase:
        {
          let targetPhase = payload.phase;
          let refireParams = payload.refireParams;
          const allowClose = payload.allowClose ?? true; // redirect to EncryptionPanel if there is an ongoing verification request

          if (targetPhase === _RightPanelStorePhases.RightPanelPhases.RoomMemberInfo && payload.refireParams) {
            const {
              member
            } = payload.refireParams;
            const pendingRequest = (0, _verification.pendingVerificationRequestForUser)(member);

            if (pendingRequest) {
              targetPhase = _RightPanelStorePhases.RightPanelPhases.EncryptionPanel;
              refireParams = {
                verificationRequest: pendingRequest,
                member
              };
            }
          }

          if (!_RightPanelStorePhases.RightPanelPhases[targetPhase]) {
            _logger.logger.warn(`Tried to switch right panel to unknown phase: ${targetPhase}`);

            return;
          }

          if (GROUP_PHASES.includes(targetPhase)) {
            if (targetPhase === this.state.lastGroupPhase) {
              this.setState({
                showGroupPanel: !this.state.showGroupPanel,
                previousPhase: null
              });
            } else {
              this.setState({
                lastGroupPhase: targetPhase,
                showGroupPanel: true,
                previousPhase: this.state.lastGroupPhase
              });
            }
          } else {
            if (targetPhase === this.state.lastRoomPhase && !refireParams && allowClose) {
              this.setState({
                showRoomPanel: !this.state.showRoomPanel,
                previousPhase: null
              });
            } else {
              this.setState({
                lastRoomPhase: targetPhase,
                showRoomPanel: true,
                lastRoomPhaseParams: refireParams || {},
                previousPhase: this.state.lastRoomPhase
              });
            }
          } // Let things like the member info panel actually open to the right member.


          _dispatcher.default.dispatch(_objectSpread({
            action: _actions.Action.AfterRightPanelPhaseChange,
            phase: targetPhase
          }, refireParams || {}));

          break;
        }

      case _actions.Action.ToggleRightPanel:
        if (payload.type === "room") {
          this.setState({
            showRoomPanel: !this.state.showRoomPanel
          });
        } else {
          // group
          this.setState({
            showGroupPanel: !this.state.showGroupPanel
          });
        }

        break;
    }
  }

  static getSharedInstance() {
    if (!RightPanelStore.instance) {
      RightPanelStore.instance = new RightPanelStore();
    }

    return RightPanelStore.instance;
  }

}

exports.default = RightPanelStore;
(0, _defineProperty2.default)(RightPanelStore, "instance", void 0);
window.mxRightPanelStore = RightPanelStore.getSharedInstance();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdG9yZXMvUmlnaHRQYW5lbFN0b3JlLnRzIl0sIm5hbWVzIjpbIklOSVRJQUxfU1RBVEUiLCJzaG93Um9vbVBhbmVsIiwiU2V0dGluZ3NTdG9yZSIsImdldFZhbHVlIiwic2hvd0dyb3VwUGFuZWwiLCJsYXN0Um9vbVBoYXNlIiwibGFzdEdyb3VwUGhhc2UiLCJsYXN0Um9vbVBoYXNlUGFyYW1zIiwiR1JPVVBfUEhBU0VTIiwiUmlnaHRQYW5lbFBoYXNlcyIsIkdyb3VwTWVtYmVyTGlzdCIsIkdyb3VwUm9vbUxpc3QiLCJHcm91cFJvb21JbmZvIiwiR3JvdXBNZW1iZXJJbmZvIiwiTUVNQkVSX0lORk9fUEhBU0VTIiwiUm9vbU1lbWJlckluZm8iLCJSb29tM3BpZE1lbWJlckluZm8iLCJFbmNyeXB0aW9uUGFuZWwiLCJSaWdodFBhbmVsU3RvcmUiLCJTdG9yZSIsImNvbnN0cnVjdG9yIiwiZGlzIiwic3RhdGUiLCJpc09wZW5Gb3JSb29tIiwiaXNPcGVuRm9yR3JvdXAiLCJyb29tUGFuZWxQaGFzZSIsImdyb3VwUGFuZWxQaGFzZSIsInByZXZpb3VzUGhhc2UiLCJSSUdIVF9QQU5FTF9QSEFTRVNfTk9fQVJHUyIsImluY2x1ZGVzIiwidmlzaWJsZVJvb21QYW5lbFBoYXNlIiwidmlzaWJsZUdyb3VwUGFuZWxQaGFzZSIsInJvb21QYW5lbFBoYXNlUGFyYW1zIiwic2V0U3RhdGUiLCJuZXdTdGF0ZSIsIk9iamVjdCIsImFzc2lnbiIsInNldFZhbHVlIiwiU2V0dGluZ0xldmVsIiwiREVWSUNFIiwiX19lbWl0Q2hhbmdlIiwiX19vbkRpc3BhdGNoIiwicGF5bG9hZCIsImFjdGlvbiIsIkFjdGlvbiIsIlZpZXdSb29tIiwicm9vbV9pZCIsImxhc3RSb29tSWQiLCJSb29tTWVtYmVyTGlzdCIsIlNldFJpZ2h0UGFuZWxQaGFzZSIsInRhcmdldFBoYXNlIiwicGhhc2UiLCJyZWZpcmVQYXJhbXMiLCJhbGxvd0Nsb3NlIiwibWVtYmVyIiwicGVuZGluZ1JlcXVlc3QiLCJ2ZXJpZmljYXRpb25SZXF1ZXN0IiwibG9nZ2VyIiwid2FybiIsImRpc3BhdGNoIiwiQWZ0ZXJSaWdodFBhbmVsUGhhc2VDaGFuZ2UiLCJUb2dnbGVSaWdodFBhbmVsIiwidHlwZSIsImdldFNoYXJlZEluc3RhbmNlIiwiaW5zdGFuY2UiLCJ3aW5kb3ciLCJteFJpZ2h0UGFuZWxTdG9yZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFnQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBRUE7Ozs7OztBQWtCQSxNQUFNQSxhQUFtQyxHQUFHO0FBQ3hDQyxFQUFBQSxhQUFhLEVBQUVDLHVCQUFjQyxRQUFkLENBQXVCLHNCQUF2QixDQUR5QjtBQUV4Q0MsRUFBQUEsY0FBYyxFQUFFRix1QkFBY0MsUUFBZCxDQUF1Qix1QkFBdkIsQ0FGd0I7QUFHeENFLEVBQUFBLGFBQWEsRUFBRUgsdUJBQWNDLFFBQWQsQ0FBdUIsNEJBQXZCLENBSHlCO0FBSXhDRyxFQUFBQSxjQUFjLEVBQUVKLHVCQUFjQyxRQUFkLENBQXVCLDZCQUF2QixDQUp3QjtBQUt4Q0ksRUFBQUEsbUJBQW1CLEVBQUU7QUFMbUIsQ0FBNUM7QUFRQSxNQUFNQyxZQUFZLEdBQUcsQ0FDakJDLHdDQUFpQkMsZUFEQSxFQUVqQkQsd0NBQWlCRSxhQUZBLEVBR2pCRix3Q0FBaUJHLGFBSEEsRUFJakJILHdDQUFpQkksZUFKQSxDQUFyQjtBQU9BLE1BQU1DLGtCQUFrQixHQUFHLENBQ3ZCTCx3Q0FBaUJNLGNBRE0sRUFFdkJOLHdDQUFpQk8sa0JBRk0sRUFHdkJQLHdDQUFpQlEsZUFITSxDQUEzQjtBQU1BO0FBQ0E7QUFDQTtBQUNBOztBQUNlLE1BQU1DLGVBQU4sU0FBOEJDLFlBQTlCLENBQW1EO0FBSzlEQyxFQUFBQSxXQUFXLEdBQUc7QUFDVixVQUFNQyxtQkFBTixFQURVLENBR1Y7O0FBSFU7QUFBQTtBQUlWLFNBQUtDLEtBQUwsR0FBYXRCLGFBQWI7QUFDSDs7QUFFZ0IsTUFBYnVCLGFBQWEs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QUFpQixHQUFvQjtBQUN4QyxRQUFJLENBQUM3QyxlQUFlLENBQUM4QyxRQUFyQixFQUErQjtBQUMzQjlDLE1BQUFBLGVBQWUsQ0FBQzhDLFFBQWhCLEdBQTJCLElBQUk5QyxlQUFKLEVBQTNCO0FBQ0g7O0FBQ0QsV0FBT0EsZUFBZSxDQUFDOEMsUUFBdkI7QUFDSDs7QUE3SzZEOzs7OEJBQTdDOUMsZTtBQWdMckIrQyxNQUFNLENBQUNDLGlCQUFQLEdBQTJCaEQsZUFBZSxDQUFDNkMsaUJBQWhCLEVBQTNCIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE5IFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IGRpcyBmcm9tICcuLi9kaXNwYXRjaGVyL2Rpc3BhdGNoZXInO1xuaW1wb3J0IHsgcGVuZGluZ1ZlcmlmaWNhdGlvblJlcXVlc3RGb3JVc2VyIH0gZnJvbSAnLi4vdmVyaWZpY2F0aW9uJztcbmltcG9ydCB7IFN0b3JlIH0gZnJvbSAnZmx1eC91dGlscyc7XG5pbXBvcnQgU2V0dGluZ3NTdG9yZSBmcm9tIFwiLi4vc2V0dGluZ3MvU2V0dGluZ3NTdG9yZVwiO1xuaW1wb3J0IHsgUmlnaHRQYW5lbFBoYXNlcywgUklHSFRfUEFORUxfUEhBU0VTX05PX0FSR1MgfSBmcm9tIFwiLi9SaWdodFBhbmVsU3RvcmVQaGFzZXNcIjtcbmltcG9ydCB7IEFjdGlvblBheWxvYWQgfSBmcm9tIFwiLi4vZGlzcGF0Y2hlci9wYXlsb2Fkc1wiO1xuaW1wb3J0IHsgQWN0aW9uIH0gZnJvbSAnLi4vZGlzcGF0Y2hlci9hY3Rpb25zJztcbmltcG9ydCB7IFNldHRpbmdMZXZlbCB9IGZyb20gXCIuLi9zZXR0aW5ncy9TZXR0aW5nTGV2ZWxcIjtcblxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2xvZ2dlclwiO1xuXG5pbnRlcmZhY2UgUmlnaHRQYW5lbFN0b3JlU3RhdGUge1xuICAgIC8vIFdoZXRoZXIgb3Igbm90IHRvIHNob3cgdGhlIHJpZ2h0IHBhbmVsIGF0IGFsbC4gV2Ugc3BsaXQgb3V0IHJvb21zIGFuZCBncm91cHNcbiAgICAvLyBiZWNhdXNlIHRoZXkncmUgZGlmZmVyZW50IGZsb3dzIGZvciB0aGUgdXNlciB0byBmb2xsb3cuXG4gICAgc2hvd1Jvb21QYW5lbDogYm9vbGVhbjtcbiAgICBzaG93R3JvdXBQYW5lbDogYm9vbGVhbjtcblxuICAgIC8vIFRoZSBsYXN0IHBoYXNlIChzY3JlZW4pIHRoZSByaWdodCBwYW5lbCB3YXMgc2hvd2luZ1xuICAgIGxhc3RSb29tUGhhc2U6IFJpZ2h0UGFuZWxQaGFzZXM7XG4gICAgbGFzdEdyb3VwUGhhc2U6IFJpZ2h0UGFuZWxQaGFzZXM7XG5cbiAgICBwcmV2aW91c1BoYXNlPzogUmlnaHRQYW5lbFBoYXNlcztcblxuICAgIC8vIEV4dHJhIGluZm9ybWF0aW9uIGFib3V0IHRoZSBsYXN0IHBoYXNlXG4gICAgbGFzdFJvb21QaGFzZVBhcmFtczoge1trZXk6IHN0cmluZ106IGFueX07XG59XG5cbmNvbnN0IElOSVRJQUxfU1RBVEU6IFJpZ2h0UGFuZWxTdG9yZVN0YXRlID0ge1xuICAgIHNob3dSb29tUGFuZWw6IFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJzaG93UmlnaHRQYW5lbEluUm9vbVwiKSxcbiAgICBzaG93R3JvdXBQYW5lbDogU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcInNob3dSaWdodFBhbmVsSW5Hcm91cFwiKSxcbiAgICBsYXN0Um9vbVBoYXNlOiBTZXR0aW5nc1N0b3JlLmdldFZhbHVlKFwibGFzdFJpZ2h0UGFuZWxQaGFzZUZvclJvb21cIiksXG4gICAgbGFzdEdyb3VwUGhhc2U6IFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJsYXN0UmlnaHRQYW5lbFBoYXNlRm9yR3JvdXBcIiksXG4gICAgbGFzdFJvb21QaGFzZVBhcmFtczoge30sXG59O1xuXG5jb25zdCBHUk9VUF9QSEFTRVMgPSBbXG4gICAgUmlnaHRQYW5lbFBoYXNlcy5Hcm91cE1lbWJlckxpc3QsXG4gICAgUmlnaHRQYW5lbFBoYXNlcy5Hcm91cFJvb21MaXN0LFxuICAgIFJpZ2h0UGFuZWxQaGFzZXMuR3JvdXBSb29tSW5mbyxcbiAgICBSaWdodFBhbmVsUGhhc2VzLkdyb3VwTWVtYmVySW5mbyxcbl07XG5cbmNvbnN0IE1FTUJFUl9JTkZPX1BIQVNFUyA9IFtcbiAgICBSaWdodFBhbmVsUGhhc2VzLlJvb21NZW1iZXJJbmZvLFxuICAgIFJpZ2h0UGFuZWxQaGFzZXMuUm9vbTNwaWRNZW1iZXJJbmZvLFxuICAgIFJpZ2h0UGFuZWxQaGFzZXMuRW5jcnlwdGlvblBhbmVsLFxuXTtcblxuLyoqXG4gKiBBIGNsYXNzIGZvciB0cmFja2luZyB0aGUgc3RhdGUgb2YgdGhlIHJpZ2h0IHBhbmVsIGJldHdlZW4gbGF5b3V0cyBhbmRcbiAqIHNlc3Npb25zLlxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSaWdodFBhbmVsU3RvcmUgZXh0ZW5kcyBTdG9yZTxBY3Rpb25QYXlsb2FkPiB7XG4gICAgcHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IFJpZ2h0UGFuZWxTdG9yZTtcbiAgICBwcml2YXRlIHN0YXRlOiBSaWdodFBhbmVsU3RvcmVTdGF0ZTtcbiAgICBwcml2YXRlIGxhc3RSb29tSWQ6IHN0cmluZztcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcihkaXMpO1xuXG4gICAgICAgIC8vIEluaXRpYWxpc2Ugc3RhdGVcbiAgICAgICAgdGhpcy5zdGF0ZSA9IElOSVRJQUxfU1RBVEU7XG4gICAgfVxuXG4gICAgZ2V0IGlzT3BlbkZvclJvb20oKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlLnNob3dSb29tUGFuZWw7XG4gICAgfVxuXG4gICAgZ2V0IGlzT3BlbkZvckdyb3VwKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZS5zaG93R3JvdXBQYW5lbDtcbiAgICB9XG5cbiAgICBnZXQgcm9vbVBhbmVsUGhhc2UoKTogUmlnaHRQYW5lbFBoYXNlcyB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlLmxhc3RSb29tUGhhc2U7XG4gICAgfVxuXG4gICAgZ2V0IGdyb3VwUGFuZWxQaGFzZSgpOiBSaWdodFBhbmVsUGhhc2VzIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGUubGFzdEdyb3VwUGhhc2U7XG4gICAgfVxuXG4gICAgZ2V0IHByZXZpb3VzUGhhc2UoKTogUmlnaHRQYW5lbFBoYXNlcyB8IG51bGwge1xuICAgICAgICByZXR1cm4gUklHSFRfUEFORUxfUEhBU0VTX05PX0FSR1MuaW5jbHVkZXModGhpcy5zdGF0ZS5wcmV2aW91c1BoYXNlKSA/IHRoaXMuc3RhdGUucHJldmlvdXNQaGFzZSA6IG51bGw7XG4gICAgfVxuXG4gICAgZ2V0IHZpc2libGVSb29tUGFuZWxQaGFzZSgpOiBSaWdodFBhbmVsUGhhc2VzIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaXNPcGVuRm9yUm9vbSA/IHRoaXMucm9vbVBhbmVsUGhhc2UgOiBudWxsO1xuICAgIH1cblxuICAgIGdldCB2aXNpYmxlR3JvdXBQYW5lbFBoYXNlKCk6IFJpZ2h0UGFuZWxQaGFzZXMge1xuICAgICAgICByZXR1cm4gdGhpcy5pc09wZW5Gb3JHcm91cCA/IHRoaXMuZ3JvdXBQYW5lbFBoYXNlIDogbnVsbDtcbiAgICB9XG5cbiAgICBnZXQgcm9vbVBhbmVsUGhhc2VQYXJhbXMoKTogYW55IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGUubGFzdFJvb21QaGFzZVBhcmFtcyB8fCB7fTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNldFN0YXRlKG5ld1N0YXRlOiBQYXJ0aWFsPFJpZ2h0UGFuZWxTdG9yZVN0YXRlPikge1xuICAgICAgICB0aGlzLnN0YXRlID0gT2JqZWN0LmFzc2lnbih0aGlzLnN0YXRlLCBuZXdTdGF0ZSk7XG5cbiAgICAgICAgU2V0dGluZ3NTdG9yZS5zZXRWYWx1ZShcbiAgICAgICAgICAgIFwic2hvd1JpZ2h0UGFuZWxJblJvb21cIixcbiAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICBTZXR0aW5nTGV2ZWwuREVWSUNFLFxuICAgICAgICAgICAgdGhpcy5zdGF0ZS5zaG93Um9vbVBhbmVsLFxuICAgICAgICApO1xuICAgICAgICBTZXR0aW5nc1N0b3JlLnNldFZhbHVlKFxuICAgICAgICAgICAgXCJzaG93UmlnaHRQYW5lbEluR3JvdXBcIixcbiAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICBTZXR0aW5nTGV2ZWwuREVWSUNFLFxuICAgICAgICAgICAgdGhpcy5zdGF0ZS5zaG93R3JvdXBQYW5lbCxcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAoUklHSFRfUEFORUxfUEhBU0VTX05PX0FSR1MuaW5jbHVkZXModGhpcy5zdGF0ZS5sYXN0Um9vbVBoYXNlKSkge1xuICAgICAgICAgICAgU2V0dGluZ3NTdG9yZS5zZXRWYWx1ZShcbiAgICAgICAgICAgICAgICBcImxhc3RSaWdodFBhbmVsUGhhc2VGb3JSb29tXCIsXG4gICAgICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgICAgICBTZXR0aW5nTGV2ZWwuREVWSUNFLFxuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUubGFzdFJvb21QaGFzZSxcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFJJR0hUX1BBTkVMX1BIQVNFU19OT19BUkdTLmluY2x1ZGVzKHRoaXMuc3RhdGUubGFzdEdyb3VwUGhhc2UpKSB7XG4gICAgICAgICAgICBTZXR0aW5nc1N0b3JlLnNldFZhbHVlKFxuICAgICAgICAgICAgICAgIFwibGFzdFJpZ2h0UGFuZWxQaGFzZUZvckdyb3VwXCIsXG4gICAgICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgICAgICBTZXR0aW5nTGV2ZWwuREVWSUNFLFxuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUubGFzdEdyb3VwUGhhc2UsXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fX2VtaXRDaGFuZ2UoKTtcbiAgICB9XG5cbiAgICBfX29uRGlzcGF0Y2gocGF5bG9hZDogQWN0aW9uUGF5bG9hZCkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uYW1pbmctY29udmVudGlvblxuICAgICAgICBzd2l0Y2ggKHBheWxvYWQuYWN0aW9uKSB7XG4gICAgICAgICAgICBjYXNlIEFjdGlvbi5WaWV3Um9vbTpcbiAgICAgICAgICAgICAgICBpZiAocGF5bG9hZC5yb29tX2lkID09PSB0aGlzLmxhc3RSb29tSWQpIGJyZWFrOyAvLyBza2lwIHRoaXMgdHJhbnNpdGlvbiwgcHJvYmFibHkgYSBwZXJtYWxpbmtcbiAgICAgICAgICAgICAgICAvLyBmYWxsdGhyb3VnaFxuICAgICAgICAgICAgY2FzZSAndmlld19ncm91cCc6XG4gICAgICAgICAgICAgICAgdGhpcy5sYXN0Um9vbUlkID0gcGF5bG9hZC5yb29tX2lkO1xuXG4gICAgICAgICAgICAgICAgLy8gUmVzZXQgdG8gdGhlIG1lbWJlciBsaXN0IGlmIHdlJ3JlIHZpZXdpbmcgbWVtYmVyIGluZm9cbiAgICAgICAgICAgICAgICBpZiAoTUVNQkVSX0lORk9fUEhBU0VTLmluY2x1ZGVzKHRoaXMuc3RhdGUubGFzdFJvb21QaGFzZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGxhc3RSb29tUGhhc2U6IFJpZ2h0UGFuZWxQaGFzZXMuUm9vbU1lbWJlckxpc3QsIGxhc3RSb29tUGhhc2VQYXJhbXM6IHt9IH0pO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIERvIHRoZSBzYW1lIGZvciBncm91cHNcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0ZS5sYXN0R3JvdXBQaGFzZSA9PT0gUmlnaHRQYW5lbFBoYXNlcy5Hcm91cE1lbWJlckluZm8pIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGxhc3RHcm91cFBoYXNlOiBSaWdodFBhbmVsUGhhc2VzLkdyb3VwTWVtYmVyTGlzdCB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgQWN0aW9uLlNldFJpZ2h0UGFuZWxQaGFzZToge1xuICAgICAgICAgICAgICAgIGxldCB0YXJnZXRQaGFzZSA9IHBheWxvYWQucGhhc2U7XG4gICAgICAgICAgICAgICAgbGV0IHJlZmlyZVBhcmFtcyA9IHBheWxvYWQucmVmaXJlUGFyYW1zO1xuICAgICAgICAgICAgICAgIGNvbnN0IGFsbG93Q2xvc2UgPSBwYXlsb2FkLmFsbG93Q2xvc2UgPz8gdHJ1ZTtcbiAgICAgICAgICAgICAgICAvLyByZWRpcmVjdCB0byBFbmNyeXB0aW9uUGFuZWwgaWYgdGhlcmUgaXMgYW4gb25nb2luZyB2ZXJpZmljYXRpb24gcmVxdWVzdFxuICAgICAgICAgICAgICAgIGlmICh0YXJnZXRQaGFzZSA9PT0gUmlnaHRQYW5lbFBoYXNlcy5Sb29tTWVtYmVySW5mbyAmJiBwYXlsb2FkLnJlZmlyZVBhcmFtcykge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB7IG1lbWJlciB9ID0gcGF5bG9hZC5yZWZpcmVQYXJhbXM7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHBlbmRpbmdSZXF1ZXN0ID0gcGVuZGluZ1ZlcmlmaWNhdGlvblJlcXVlc3RGb3JVc2VyKG1lbWJlcik7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwZW5kaW5nUmVxdWVzdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UGhhc2UgPSBSaWdodFBhbmVsUGhhc2VzLkVuY3J5cHRpb25QYW5lbDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlZmlyZVBhcmFtcyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2ZXJpZmljYXRpb25SZXF1ZXN0OiBwZW5kaW5nUmVxdWVzdCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZW1iZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghUmlnaHRQYW5lbFBoYXNlc1t0YXJnZXRQaGFzZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm4oYFRyaWVkIHRvIHN3aXRjaCByaWdodCBwYW5lbCB0byB1bmtub3duIHBoYXNlOiAke3RhcmdldFBoYXNlfWApO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKEdST1VQX1BIQVNFUy5pbmNsdWRlcyh0YXJnZXRQaGFzZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldFBoYXNlID09PSB0aGlzLnN0YXRlLmxhc3RHcm91cFBoYXNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaG93R3JvdXBQYW5lbDogIXRoaXMuc3RhdGUuc2hvd0dyb3VwUGFuZWwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNQaGFzZTogbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEdyb3VwUGhhc2U6IHRhcmdldFBoYXNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNob3dHcm91cFBhbmVsOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZpb3VzUGhhc2U6IHRoaXMuc3RhdGUubGFzdEdyb3VwUGhhc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXRQaGFzZSA9PT0gdGhpcy5zdGF0ZS5sYXN0Um9vbVBoYXNlICYmICFyZWZpcmVQYXJhbXMgJiYgYWxsb3dDbG9zZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvd1Jvb21QYW5lbDogIXRoaXMuc3RhdGUuc2hvd1Jvb21QYW5lbCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c1BoYXNlOiBudWxsLFxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0Um9vbVBoYXNlOiB0YXJnZXRQaGFzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaG93Um9vbVBhbmVsOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RSb29tUGhhc2VQYXJhbXM6IHJlZmlyZVBhcmFtcyB8fCB7fSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c1BoYXNlOiB0aGlzLnN0YXRlLmxhc3RSb29tUGhhc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIExldCB0aGluZ3MgbGlrZSB0aGUgbWVtYmVyIGluZm8gcGFuZWwgYWN0dWFsbHkgb3BlbiB0byB0aGUgcmlnaHQgbWVtYmVyLlxuICAgICAgICAgICAgICAgIGRpcy5kaXNwYXRjaCh7XG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbjogQWN0aW9uLkFmdGVyUmlnaHRQYW5lbFBoYXNlQ2hhbmdlLFxuICAgICAgICAgICAgICAgICAgICBwaGFzZTogdGFyZ2V0UGhhc2UsXG4gICAgICAgICAgICAgICAgICAgIC4uLihyZWZpcmVQYXJhbXMgfHwge30pLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjYXNlIEFjdGlvbi5Ub2dnbGVSaWdodFBhbmVsOlxuICAgICAgICAgICAgICAgIGlmIChwYXlsb2FkLnR5cGUgPT09IFwicm9vbVwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBzaG93Um9vbVBhbmVsOiAhdGhpcy5zdGF0ZS5zaG93Um9vbVBhbmVsIH0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7IC8vIGdyb3VwXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBzaG93R3JvdXBQYW5lbDogIXRoaXMuc3RhdGUuc2hvd0dyb3VwUGFuZWwgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc3RhdGljIGdldFNoYXJlZEluc3RhbmNlKCk6IFJpZ2h0UGFuZWxTdG9yZSB7XG4gICAgICAgIGlmICghUmlnaHRQYW5lbFN0b3JlLmluc3RhbmNlKSB7XG4gICAgICAgICAgICBSaWdodFBhbmVsU3RvcmUuaW5zdGFuY2UgPSBuZXcgUmlnaHRQYW5lbFN0b3JlKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFJpZ2h0UGFuZWxTdG9yZS5pbnN0YW5jZTtcbiAgICB9XG59XG5cbndpbmRvdy5teFJpZ2h0UGFuZWxTdG9yZSA9IFJpZ2h0UGFuZWxTdG9yZS5nZXRTaGFyZWRJbnN0YW5jZSgpO1xuIl19