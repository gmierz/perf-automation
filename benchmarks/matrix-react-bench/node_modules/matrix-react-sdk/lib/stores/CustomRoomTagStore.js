"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _dispatcher = _interopRequireDefault(require("../dispatcher/dispatcher"));

var _events = _interopRequireDefault(require("events"));

var _lodash = require("lodash");

var _SettingsStore = _interopRequireDefault(require("../settings/SettingsStore"));

var _RoomListStore = _interopRequireWildcard(require("./room-list/RoomListStore"));

var _RoomNotificationStateStore = require("./notifications/RoomNotificationStateStore");

var _models = require("./room-list/models");

var _objects = require("../utils/objects");

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/*
Copyright 2019 New Vector Ltd
Copyright 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
function commonPrefix(a, b) {
  const len = Math.min(a.length, b.length);
  let prefix;

  for (let i = 0; i < len; ++i) {
    if (a.charAt(i) !== b.charAt(i)) {
      prefix = a.substr(0, i);
      break;
    }
  }

  if (prefix === undefined) {
    prefix = a.substr(0, len);
  }

  const spaceIdx = prefix.indexOf(' ');

  if (spaceIdx !== -1) {
    prefix = prefix.substr(0, spaceIdx + 1);
  }

  if (prefix.length >= 2) {
    return prefix;
  }

  return "";
}
/**
 * A class for storing application state for ordering tags in the GroupFilterPanel.
 */


class CustomRoomTagStore extends _events.default {
  constructor() {
    super(); // Initialise state

    (0, _defineProperty2.default)(this, "_onListsUpdated", () => {
      const newTags = this._getUpdatedTags();

      if (!this._state.tags || (0, _objects.objectHasDiff)(this._state.tags, newTags)) {
        this._setState({
          tags: newTags
        });
      }
    });
    this._state = {
      tags: {}
    }; // as RoomListStore gets updated by every timeline event
    // throttle this to only run every 500ms

    this._getUpdatedTags = (0, _lodash.throttle)(this._getUpdatedTags, 500, {
      leading: true,
      trailing: true
    });

    _RoomListStore.default.instance.on(_RoomListStore.LISTS_UPDATE_EVENT, this._onListsUpdated);

    _dispatcher.default.register(payload => this._onDispatch(payload));
  }

  getTags() {
    return this._state.tags;
  }

  _setState(newState) {
    this._state = Object.assign(this._state, newState);
    this.emit("change");
  }

  addListener(callback) {
    this.on("change", callback);
    return {
      remove: () => {
        this.removeListener("change", callback);
      }
    };
  }

  getSortedTags() {
    const tagNames = Object.keys(this._state.tags).sort();
    const prefixes = tagNames.map((name, i) => {
      const isFirst = i === 0;
      const isLast = i === tagNames.length - 1;
      const backwardsPrefix = !isFirst ? commonPrefix(name, tagNames[i - 1]) : "";
      const forwardsPrefix = !isLast ? commonPrefix(name, tagNames[i + 1]) : "";
      const longestPrefix = backwardsPrefix.length > forwardsPrefix.length ? backwardsPrefix : forwardsPrefix;
      return longestPrefix;
    });
    return tagNames.map((name, i) => {
      const notifs = _RoomNotificationStateStore.RoomNotificationStateStore.instance.getListState(name);

      let badgeNotifState;

      if (notifs.hasUnreadCount) {
        badgeNotifState = notifs;
      }

      const avatarLetter = name.substr(prefixes[i].length, 1);
      const selected = this._state.tags[name];
      return {
        name,
        avatarLetter,
        badgeNotifState,
        selected
      };
    });
  }

  _onDispatch(payload) {
    switch (payload.action) {
      case 'select_custom_room_tag':
        {
          const oldTags = this._state.tags;

          if (oldTags.hasOwnProperty(payload.tag)) {
            const tag = {};
            tag[payload.tag] = !oldTags[payload.tag];
            const tags = Object.assign({}, oldTags, tag);

            this._setState({
              tags
            });
          }

          break;
        }

      case 'on_client_not_viable':
      case 'on_logged_out':
        {
          // we assume to always have a tags object in the state
          this._state = {
            tags: {}
          };

          _RoomListStore.default.instance.off(_RoomListStore.LISTS_UPDATE_EVENT, this._onListsUpdated);

          break;
        }
    }
  }

  _getUpdatedTags() {
    if (!_SettingsStore.default.getValue("feature_custom_tags")) {
      return {}; // none
    }

    const newTagNames = Object.keys(_RoomListStore.default.instance.orderedLists).filter(t => (0, _models.isCustomTag)(t)).sort();
    const prevTags = this._state && this._state.tags;
    return newTagNames.reduce((c, tagName) => {
      c[tagName] = prevTags && prevTags[tagName] || false;
      return c;
    }, {});
  }

}

if (global.singletonCustomRoomTagStore === undefined) {
  global.singletonCustomRoomTagStore = new CustomRoomTagStore();
}

var _default = global.singletonCustomRoomTagStore;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdG9yZXMvQ3VzdG9tUm9vbVRhZ1N0b3JlLmpzIl0sIm5hbWVzIjpbImNvbW1vblByZWZpeCIsImEiLCJiIiwibGVuIiwiTWF0aCIsIm1pbiIsImxlbmd0aCIsInByZWZpeCIsImkiLCJjaGFyQXQiLCJzdWJzdHIiLCJ1bmRlZmluZWQiLCJzcGFjZUlkeCIsImluZGV4T2YiLCJDdXN0b21Sb29tVGFnU3RvcmUiLCJFdmVudEVtaXR0ZXIiLCJjb25zdHJ1Y3RvciIsIm5ld1RhZ3MiLCJfZ2V0VXBkYXRlZFRhZ3MiLCJfc3RhdGUiLCJ0YWdzIiwiX3NldFN0YXRlIiwibGVhZGluZyIsInRyYWlsaW5nIiwiUm9vbUxpc3RTdG9yZSIsImluc3RhbmNlIiwib24iLCJMSVNUU19VUERBVEVfRVZFTlQiLCJfb25MaXN0c1VwZGF0ZWQiLCJkaXMiLCJyZWdpc3RlciIsInBheWxvYWQiLCJfb25EaXNwYXRjaCIsImdldFRhZ3MiLCJuZXdTdGF0ZSIsIk9iamVjdCIsImFzc2lnbiIsImVtaXQiLCJhZGRMaXN0ZW5lciIsImNhbGxiYWNrIiwicmVtb3ZlIiwicmVtb3ZlTGlzdGVuZXIiLCJnZXRTb3J0ZWRUYWdzIiwidGFnTmFtZXMiLCJrZXlzIiwic29ydCIsInByZWZpeGVzIiwibWFwIiwibmFtZSIsImlzRmlyc3QiLCJpc0xhc3QiLCJiYWNrd2FyZHNQcmVmaXgiLCJmb3J3YXJkc1ByZWZpeCIsImxvbmdlc3RQcmVmaXgiLCJub3RpZnMiLCJSb29tTm90aWZpY2F0aW9uU3RhdGVTdG9yZSIsImdldExpc3RTdGF0ZSIsImJhZGdlTm90aWZTdGF0ZSIsImhhc1VucmVhZENvdW50IiwiYXZhdGFyTGV0dGVyIiwic2VsZWN0ZWQiLCJhY3Rpb24iLCJvbGRUYWdzIiwiaGFzT3duUHJvcGVydHkiLCJ0YWciLCJvZmYiLCJTZXR0aW5nc1N0b3JlIiwiZ2V0VmFsdWUiLCJuZXdUYWdOYW1lcyIsIm9yZGVyZWRMaXN0cyIsImZpbHRlciIsInQiLCJwcmV2VGFn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MjAyMCBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBkaXMgZnJvbSAnLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyJztcbmltcG9ydCBFdmVudEVtaXR0ZXIgZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IHRocm90dGxlIH0gZnJvbSBcImxvZGFzaFwiO1xuaW1wb3J0IFNldHRpbmdzU3RvcmUgZnJvbSBcIi4uL3NldHRpbmdzL1NldHRpbmdzU3RvcmVcIjtcbmltcG9ydCBSb29tTGlzdFN0b3JlLCB7IExJU1RTX1VQREFURV9FVkVOVCB9IGZyb20gXCIuL3Jvb20tbGlzdC9Sb29tTGlzdFN0b3JlXCI7XG5pbXBvcnQgeyBSb29tTm90aWZpY2F0aW9uU3RhdGVTdG9yZSB9IGZyb20gXCIuL25vdGlmaWNhdGlvbnMvUm9vbU5vdGlmaWNhdGlvblN0YXRlU3RvcmVcIjtcbmltcG9ydCB7IGlzQ3VzdG9tVGFnIH0gZnJvbSBcIi4vcm9vbS1saXN0L21vZGVsc1wiO1xuaW1wb3J0IHsgb2JqZWN0SGFzRGlmZiB9IGZyb20gXCIuLi91dGlscy9vYmplY3RzXCI7XG5cbmZ1bmN0aW9uIGNvbW1vblByZWZpeChhLCBiKSB7XG4gICAgY29uc3QgbGVuID0gTWF0aC5taW4oYS5sZW5ndGgsIGIubGVuZ3RoKTtcbiAgICBsZXQgcHJlZml4O1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyArK2kpIHtcbiAgICAgICAgaWYgKGEuY2hhckF0KGkpICE9PSBiLmNoYXJBdChpKSkge1xuICAgICAgICAgICAgcHJlZml4ID0gYS5zdWJzdHIoMCwgaSk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAocHJlZml4ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcHJlZml4ID0gYS5zdWJzdHIoMCwgbGVuKTtcbiAgICB9XG4gICAgY29uc3Qgc3BhY2VJZHggPSBwcmVmaXguaW5kZXhPZignICcpO1xuICAgIGlmIChzcGFjZUlkeCAhPT0gLTEpIHtcbiAgICAgICAgcHJlZml4ID0gcHJlZml4LnN1YnN0cigwLCBzcGFjZUlkeCArIDEpO1xuICAgIH1cbiAgICBpZiAocHJlZml4Lmxlbmd0aCA+PSAyKSB7XG4gICAgICAgIHJldHVybiBwcmVmaXg7XG4gICAgfVxuICAgIHJldHVybiBcIlwiO1xufVxuLyoqXG4gKiBBIGNsYXNzIGZvciBzdG9yaW5nIGFwcGxpY2F0aW9uIHN0YXRlIGZvciBvcmRlcmluZyB0YWdzIGluIHRoZSBHcm91cEZpbHRlclBhbmVsLlxuICovXG5jbGFzcyBDdXN0b21Sb29tVGFnU3RvcmUgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcigpO1xuICAgICAgICAvLyBJbml0aWFsaXNlIHN0YXRlXG4gICAgICAgIHRoaXMuX3N0YXRlID0geyB0YWdzOiB7fSB9O1xuXG4gICAgICAgIC8vIGFzIFJvb21MaXN0U3RvcmUgZ2V0cyB1cGRhdGVkIGJ5IGV2ZXJ5IHRpbWVsaW5lIGV2ZW50XG4gICAgICAgIC8vIHRocm90dGxlIHRoaXMgdG8gb25seSBydW4gZXZlcnkgNTAwbXNcbiAgICAgICAgdGhpcy5fZ2V0VXBkYXRlZFRhZ3MgPSB0aHJvdHRsZShcbiAgICAgICAgICAgIHRoaXMuX2dldFVwZGF0ZWRUYWdzLCA1MDAsIHtcbiAgICAgICAgICAgICAgICBsZWFkaW5nOiB0cnVlLFxuICAgICAgICAgICAgICAgIHRyYWlsaW5nOiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgKTtcbiAgICAgICAgUm9vbUxpc3RTdG9yZS5pbnN0YW5jZS5vbihMSVNUU19VUERBVEVfRVZFTlQsIHRoaXMuX29uTGlzdHNVcGRhdGVkKTtcbiAgICAgICAgZGlzLnJlZ2lzdGVyKHBheWxvYWQgPT4gdGhpcy5fb25EaXNwYXRjaChwYXlsb2FkKSk7XG4gICAgfVxuXG4gICAgZ2V0VGFncygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3N0YXRlLnRhZ3M7XG4gICAgfVxuXG4gICAgX3NldFN0YXRlKG5ld1N0YXRlKSB7XG4gICAgICAgIHRoaXMuX3N0YXRlID0gT2JqZWN0LmFzc2lnbih0aGlzLl9zdGF0ZSwgbmV3U3RhdGUpO1xuICAgICAgICB0aGlzLmVtaXQoXCJjaGFuZ2VcIik7XG4gICAgfVxuXG4gICAgYWRkTGlzdGVuZXIoY2FsbGJhY2spIHtcbiAgICAgICAgdGhpcy5vbihcImNoYW5nZVwiLCBjYWxsYmFjayk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICByZW1vdmU6ICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKFwiY2hhbmdlXCIsIGNhbGxiYWNrKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgZ2V0U29ydGVkVGFncygpIHtcbiAgICAgICAgY29uc3QgdGFnTmFtZXMgPSBPYmplY3Qua2V5cyh0aGlzLl9zdGF0ZS50YWdzKS5zb3J0KCk7XG4gICAgICAgIGNvbnN0IHByZWZpeGVzID0gdGFnTmFtZXMubWFwKChuYW1lLCBpKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBpc0ZpcnN0ID0gaSA9PT0gMDtcbiAgICAgICAgICAgIGNvbnN0IGlzTGFzdCA9IGkgPT09IHRhZ05hbWVzLmxlbmd0aCAtIDE7XG4gICAgICAgICAgICBjb25zdCBiYWNrd2FyZHNQcmVmaXggPSAhaXNGaXJzdCA/IGNvbW1vblByZWZpeChuYW1lLCB0YWdOYW1lc1tpIC0gMV0pIDogXCJcIjtcbiAgICAgICAgICAgIGNvbnN0IGZvcndhcmRzUHJlZml4ID0gIWlzTGFzdCA/IGNvbW1vblByZWZpeChuYW1lLCB0YWdOYW1lc1tpICsgMV0pIDogXCJcIjtcbiAgICAgICAgICAgIGNvbnN0IGxvbmdlc3RQcmVmaXggPSBiYWNrd2FyZHNQcmVmaXgubGVuZ3RoID4gZm9yd2FyZHNQcmVmaXgubGVuZ3RoID9cbiAgICAgICAgICAgICAgICBiYWNrd2FyZHNQcmVmaXggOiBmb3J3YXJkc1ByZWZpeDtcbiAgICAgICAgICAgIHJldHVybiBsb25nZXN0UHJlZml4O1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHRhZ05hbWVzLm1hcCgobmFtZSwgaSkgPT4ge1xuICAgICAgICAgICAgY29uc3Qgbm90aWZzID0gUm9vbU5vdGlmaWNhdGlvblN0YXRlU3RvcmUuaW5zdGFuY2UuZ2V0TGlzdFN0YXRlKG5hbWUpO1xuICAgICAgICAgICAgbGV0IGJhZGdlTm90aWZTdGF0ZTtcbiAgICAgICAgICAgIGlmIChub3RpZnMuaGFzVW5yZWFkQ291bnQpIHtcbiAgICAgICAgICAgICAgICBiYWRnZU5vdGlmU3RhdGUgPSBub3RpZnM7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBhdmF0YXJMZXR0ZXIgPSBuYW1lLnN1YnN0cihwcmVmaXhlc1tpXS5sZW5ndGgsIDEpO1xuICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWQgPSB0aGlzLl9zdGF0ZS50YWdzW25hbWVdO1xuICAgICAgICAgICAgcmV0dXJuIHsgbmFtZSwgYXZhdGFyTGV0dGVyLCBiYWRnZU5vdGlmU3RhdGUsIHNlbGVjdGVkIH07XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIF9vbkxpc3RzVXBkYXRlZCA9ICgpID0+IHtcbiAgICAgICAgY29uc3QgbmV3VGFncyA9IHRoaXMuX2dldFVwZGF0ZWRUYWdzKCk7XG4gICAgICAgIGlmICghdGhpcy5fc3RhdGUudGFncyB8fCBvYmplY3RIYXNEaWZmKHRoaXMuX3N0YXRlLnRhZ3MsIG5ld1RhZ3MpKSB7XG4gICAgICAgICAgICB0aGlzLl9zZXRTdGF0ZSh7IHRhZ3M6IG5ld1RhZ3MgfSk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgX29uRGlzcGF0Y2gocGF5bG9hZCkge1xuICAgICAgICBzd2l0Y2ggKHBheWxvYWQuYWN0aW9uKSB7XG4gICAgICAgICAgICBjYXNlICdzZWxlY3RfY3VzdG9tX3Jvb21fdGFnJzoge1xuICAgICAgICAgICAgICAgIGNvbnN0IG9sZFRhZ3MgPSB0aGlzLl9zdGF0ZS50YWdzO1xuICAgICAgICAgICAgICAgIGlmIChvbGRUYWdzLmhhc093blByb3BlcnR5KHBheWxvYWQudGFnKSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB0YWcgPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgdGFnW3BheWxvYWQudGFnXSA9ICFvbGRUYWdzW3BheWxvYWQudGFnXTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFncyA9IE9iamVjdC5hc3NpZ24oe30sIG9sZFRhZ3MsIHRhZyk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3NldFN0YXRlKHsgdGFncyB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYXNlICdvbl9jbGllbnRfbm90X3ZpYWJsZSc6XG4gICAgICAgICAgICBjYXNlICdvbl9sb2dnZWRfb3V0Jzoge1xuICAgICAgICAgICAgICAgIC8vIHdlIGFzc3VtZSB0byBhbHdheXMgaGF2ZSBhIHRhZ3Mgb2JqZWN0IGluIHRoZSBzdGF0ZVxuICAgICAgICAgICAgICAgIHRoaXMuX3N0YXRlID0geyB0YWdzOiB7fSB9O1xuICAgICAgICAgICAgICAgIFJvb21MaXN0U3RvcmUuaW5zdGFuY2Uub2ZmKExJU1RTX1VQREFURV9FVkVOVCwgdGhpcy5fb25MaXN0c1VwZGF0ZWQpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgX2dldFVwZGF0ZWRUYWdzKCkge1xuICAgICAgICBpZiAoIVNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJmZWF0dXJlX2N1c3RvbV90YWdzXCIpKSB7XG4gICAgICAgICAgICByZXR1cm4ge307IC8vIG5vbmVcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG5ld1RhZ05hbWVzID0gT2JqZWN0LmtleXMoUm9vbUxpc3RTdG9yZS5pbnN0YW5jZS5vcmRlcmVkTGlzdHMpLmZpbHRlcih0ID0+IGlzQ3VzdG9tVGFnKHQpKS5zb3J0KCk7XG4gICAgICAgIGNvbnN0IHByZXZUYWdzID0gdGhpcy5fc3RhdGUgJiYgdGhpcy5fc3RhdGUudGFncztcbiAgICAgICAgcmV0dXJuIG5ld1RhZ05hbWVzLnJlZHVjZSgoYywgdGFnTmFtZSkgPT4ge1xuICAgICAgICAgICAgY1t0YWdOYW1lXSA9IChwcmV2VGFncyAmJiBwcmV2VGFnc1t0YWdOYW1lXSkgfHwgZmFsc2U7XG4gICAgICAgICAgICByZXR1cm4gYztcbiAgICAgICAgfSwge30pO1xuICAgIH1cbn1cblxuaWYgKGdsb2JhbC5zaW5nbGV0b25DdXN0b21Sb29tVGFnU3RvcmUgPT09IHVuZGVmaW5lZCkge1xuICAgIGdsb2JhbC5zaW5nbGV0b25DdXN0b21Sb29tVGFnU3RvcmUgPSBuZXcgQ3VzdG9tUm9vbVRhZ1N0b3JlKCk7XG59XG5leHBvcnQgZGVmYXVsdCBnbG9iYWwuc2luZ2xldG9uQ3VzdG9tUm9vbVRhZ1N0b3JlO1xuIl19