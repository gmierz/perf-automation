"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.BreadcrumbsStore = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _SettingsStore = _interopRequireDefault(require("../settings/SettingsStore"));

var _AsyncStoreWithClient = require("./AsyncStoreWithClient");

var _dispatcher = _interopRequireDefault(require("../dispatcher/dispatcher"));

var _arrays = require("../utils/arrays");

var _utils = require("matrix-js-sdk/src/utils");

var _SettingLevel = require("../settings/SettingLevel");

var _SpaceStore = _interopRequireDefault(require("./spaces/SpaceStore"));

var _actions = require("../dispatcher/actions");

/*
Copyright 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const MAX_ROOMS = 20; // arbitrary

const AUTOJOIN_WAIT_THRESHOLD_MS = 90000; // 90s, the time we wait for an autojoined room to show up

class BreadcrumbsStore extends _AsyncStoreWithClient.AsyncStoreWithClient {
  constructor() {
    super(_dispatcher.default);
    (0, _defineProperty2.default)(this, "waitingRooms", []);
    (0, _defineProperty2.default)(this, "onMyMembership", async room => {
      // Only turn on breadcrumbs is the user hasn't explicitly turned it off again.
      const settingValueRaw = _SettingsStore.default.getValue("breadcrumbs", null,
      /*excludeDefault=*/
      true);

      if (this.meetsRoomRequirement && (0, _utils.isNullOrUndefined)(settingValueRaw)) {
        await _SettingsStore.default.setValue("breadcrumbs", null, _SettingLevel.SettingLevel.ACCOUNT, true);
      }
    });
    (0, _defineProperty2.default)(this, "onRoom", async room => {
      const waitingRoom = this.waitingRooms.find(r => r.roomId === room.roomId);
      if (!waitingRoom) return;
      this.waitingRooms.splice(this.waitingRooms.indexOf(waitingRoom), 1);
      if (Date.now() - waitingRoom.addedTs > AUTOJOIN_WAIT_THRESHOLD_MS) return; // Too long ago.

      await this.appendRoom(room);
    });

    _SettingsStore.default.monitorSetting("breadcrumb_rooms", null);

    _SettingsStore.default.monitorSetting("breadcrumbs", null);
  }

  static get instance() {
    return BreadcrumbsStore.internalInstance;
  }

  get rooms() {
    return this.state.rooms || [];
  }

  get visible() {
    return this.state.enabled && this.meetsRoomRequirement;
  }

  get meetsRoomRequirement() {
    return this.matrixClient && this.matrixClient.getVisibleRooms().length >= 20;
  }

  async onAction(payload) {
    if (!this.matrixClient) return;

    if (payload.action === _actions.Action.SettingUpdated) {
      const settingUpdatedPayload = payload;

      if (settingUpdatedPayload.settingName === 'breadcrumb_rooms') {
        await this.updateRooms();
      } else if (settingUpdatedPayload.settingName === 'breadcrumbs') {
        await this.updateState({
          enabled: _SettingsStore.default.getValue("breadcrumbs", null)
        });
      }
    } else if (payload.action === _actions.Action.ViewRoom) {
      if (payload.auto_join && !this.matrixClient.getRoom(payload.room_id)) {
        // Queue the room instead of pushing it immediately. We're probably just
        // waiting for a room join to complete.
        this.waitingRooms.push({
          roomId: payload.room_id,
          addedTs: Date.now()
        });
      } else {
        // The tests might not result in a valid room object.
        const room = this.matrixClient.getRoom(payload.room_id);
        if (room) await this.appendRoom(room);
      }
    }
  }

  async onReady() {
    await this.updateRooms();
    await this.updateState({
      enabled: _SettingsStore.default.getValue("breadcrumbs", null)
    });
    this.matrixClient.on("Room.myMembership", this.onMyMembership);
    this.matrixClient.on("Room", this.onRoom);
  }

  async onNotReady() {
    this.matrixClient.removeListener("Room.myMembership", this.onMyMembership);
    this.matrixClient.removeListener("Room", this.onRoom);
  }

  async updateRooms() {
    let roomIds = _SettingsStore.default.getValue("breadcrumb_rooms");

    if (!roomIds || roomIds.length === 0) roomIds = [];
    const rooms = roomIds.map(r => this.matrixClient.getRoom(r)).filter(r => !!r);
    const currentRooms = this.state.rooms || [];
    if (!(0, _arrays.arrayHasDiff)(rooms, currentRooms)) return; // no change (probably echo)

    await this.updateState({
      rooms
    });
  }

  async appendRoom(room) {
    if (_SpaceStore.default.spacesEnabled && room.isSpaceRoom()) return; // hide space rooms

    let updated = false;
    const rooms = (this.state.rooms || []).slice(); // cheap clone
    // If the room is upgraded, use that room instead. We'll also splice out
    // any children of the room.

    const history = this.matrixClient.getRoomUpgradeHistory(room.roomId);

    if (history.length > 1) {
      room = history[history.length - 1]; // Last room is most recent in history
      // Take out any room that isn't the most recent room

      for (let i = 0; i < history.length - 1; i++) {
        const idx = rooms.findIndex(r => r.roomId === history[i].roomId);

        if (idx !== -1) {
          rooms.splice(idx, 1);
          updated = true;
        }
      }
    } // Remove the existing room, if it is present


    const existingIdx = rooms.findIndex(r => r.roomId === room.roomId); // If we're focusing on the first room no-op

    if (existingIdx !== 0) {
      if (existingIdx !== -1) {
        rooms.splice(existingIdx, 1);
      } // Splice the room to the start of the list


      rooms.splice(0, 0, room);
      updated = true;
    }

    if (rooms.length > MAX_ROOMS) {
      // This looks weird, but it's saying to start at the MAX_ROOMS point in the
      // list and delete everything after it.
      rooms.splice(MAX_ROOMS, rooms.length - MAX_ROOMS);
      updated = true;
    }

    if (updated) {
      // Update the breadcrumbs
      await this.updateState({
        rooms
      });
      const roomIds = rooms.map(r => r.roomId);

      if (roomIds.length > 0) {
        await _SettingsStore.default.setValue("breadcrumb_rooms", null, _SettingLevel.SettingLevel.ACCOUNT, roomIds);
      }
    }
  }

}

exports.BreadcrumbsStore = BreadcrumbsStore;
(0, _defineProperty2.default)(BreadcrumbsStore, "internalInstance", new BreadcrumbsStore());
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdG9yZXMvQnJlYWRjcnVtYnNTdG9yZS50cyJdLCJuYW1lcyI6WyJNQVhfUk9PTVMiLCJBVVRPSk9JTl9XQUlUX1RIUkVTSE9MRF9NUyIsIkJyZWFkY3J1bWJzU3RvcmUiLCJBc3luY1N0b3JlV2l0aENsaWVudCIsImNvbnN0cnVjdG9yIiwiZGVmYXVsdERpc3BhdGNoZXIiLCJyb29tIiwic2V0dGluZ1ZhbHVlUmF3IiwiU2V0dGluZ3NTdG9yZSIsImdldFZhbHVlIiwibWVldHNSb29tUmVxdWlyZW1lbnQiLCJzZXRWYWx1ZSIsIlNldHRpbmdMZXZlbCIsIkFDQ09VTlQiLCJ3YWl0aW5nUm9vbSIsIndhaXRpbmdSb29tcyIsImZpbmQiLCJyIiwicm9vbUlkIiwic3BsaWNlIiwiaW5kZXhPZiIsIkRhdGUiLCJub3ciLCJhZGRlZFRzIiwiYXBwZW5kUm9vbSIsIm1vbml0b3JTZXR0aW5nIiwiaW5zdGFuY2UiLCJpbnRlcm5hbEluc3RhbmNlIiwicm9vbXMiLCJzdGF0ZSIsInZpc2libGUiLCJlbmFibGVkIiwibWF0cml4Q2xpZW50IiwiZ2V0VmlzaWJsZVJvb21zIiwibGVuZ3RoIiwib25BY3Rpb24iLCJwYXlsb2FkIiwiYWN0aW9uIiwiQWN0aW9uIiwiU2V0dGluZ1VwZGF0ZWQiLCJzZXR0aW5nVXBkYXRlZFBheWxvYWQiLCJzZXR0aW5nTmFtZSIsInVwZGF0ZVJvb21zIiwidXBkYXRlU3RhdGUiLCJWaWV3Um9vbSIsImF1dG9fam9pbiIsImdldFJvb20iLCJyb29tX2lkIiwicHVzaCIsIm9uUmVhZHkiLCJvbiIsIm9uTXlNZW1iZXJzaGlwIiwib25Sb29tIiwib25Ob3RSZWFkeSIsInJlbW92ZUxpc3RlbmVyIiwicm9vbUlkcyIsIm1hcCIsImZpbHRlciIsImN1cnJlbnRSb29tcyIsIlNwYWNlU3RvcmUiLCJzcGFjZXNFbmFibGVkIiwiaXNTcGFjZVJvb20iLCJ1cGRhdGVkIiwic2xpY2UiLCJoaXN0b3J5IiwiZ2V0Um9vbVVwZ3JhZGVI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OEI7QUFDMUI7QUFDQTtBQUNBNEIsTUFBQUEsS0FBSyxDQUFDVCxNQUFOLENBQWFuQixTQUFiLEVBQXdCNEIsS0FBSyxDQUFDTSxNQUFOLEdBQWVsQyxTQUF2QztBQUNBOEQsTUFBQUEsT0FBTyxHQUFHLElBQVY7QUFDSDs7QUFFRCxRQUFJQSxPQUFKLEVBQWE7QUFDVDtBQUNBLFlBQU0sS0FBS25CLFdBQUwsQ0FBaUI7QUFBRWYsUUFBQUE7QUFBRixPQUFqQixDQUFOO0FBQ0EsWUFBTTJCLE9BQU8sR0FBRzNCLEtBQUssQ0FBQzRCLEdBQU4sQ0FBVXZDLENBQUMsSUFBSUEsQ0FBQyxDQUFDQyxNQUFqQixDQUFoQjs7QUFDQSxVQUFJcUMsT0FBTyxDQUFDckIsTUFBUixHQUFpQixDQUFyQixFQUF3QjtBQUNwQixjQUFNMUIsdUJBQWNHLFFBQWQsQ0FBdUIsa0JBQXZCLEVBQTJDLElBQTNDLEVBQWlEQywyQkFBYUMsT0FBOUQsRUFBdUUwQyxPQUF2RSxDQUFOO0FBQ0g7QUFDSjtBQUNKOztBQTdJOEQ7Ozs4QkFBdERyRCxnQixzQkFDeUIsSUFBSUEsZ0JBQUosRSIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAyMCBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBTZXR0aW5nc1N0b3JlIGZyb20gXCIuLi9zZXR0aW5ncy9TZXR0aW5nc1N0b3JlXCI7XG5pbXBvcnQgeyBSb29tIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yb29tXCI7XG5pbXBvcnQgeyBBY3Rpb25QYXlsb2FkIH0gZnJvbSBcIi4uL2Rpc3BhdGNoZXIvcGF5bG9hZHNcIjtcbmltcG9ydCB7IEFzeW5jU3RvcmVXaXRoQ2xpZW50IH0gZnJvbSBcIi4vQXN5bmNTdG9yZVdpdGhDbGllbnRcIjtcbmltcG9ydCBkZWZhdWx0RGlzcGF0Y2hlciBmcm9tIFwiLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyXCI7XG5pbXBvcnQgeyBhcnJheUhhc0RpZmYgfSBmcm9tIFwiLi4vdXRpbHMvYXJyYXlzXCI7XG5pbXBvcnQgeyBpc051bGxPclVuZGVmaW5lZCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy91dGlsc1wiO1xuaW1wb3J0IHsgU2V0dGluZ0xldmVsIH0gZnJvbSBcIi4uL3NldHRpbmdzL1NldHRpbmdMZXZlbFwiO1xuaW1wb3J0IFNwYWNlU3RvcmUgZnJvbSBcIi4vc3BhY2VzL1NwYWNlU3RvcmVcIjtcbmltcG9ydCB7IEFjdGlvbiB9IGZyb20gXCIuLi9kaXNwYXRjaGVyL2FjdGlvbnNcIjtcbmltcG9ydCB7IFNldHRpbmdVcGRhdGVkUGF5bG9hZCB9IGZyb20gXCIuLi9kaXNwYXRjaGVyL3BheWxvYWRzL1NldHRpbmdVcGRhdGVkUGF5bG9hZFwiO1xuXG5jb25zdCBNQVhfUk9PTVMgPSAyMDsgLy8gYXJiaXRyYXJ5XG5jb25zdCBBVVRPSk9JTl9XQUlUX1RIUkVTSE9MRF9NUyA9IDkwMDAwOyAvLyA5MHMsIHRoZSB0aW1lIHdlIHdhaXQgZm9yIGFuIGF1dG9qb2luZWQgcm9vbSB0byBzaG93IHVwXG5cbmludGVyZmFjZSBJU3RhdGUge1xuICAgIGVuYWJsZWQ/OiBib29sZWFuO1xuICAgIHJvb21zPzogUm9vbVtdO1xufVxuXG5leHBvcnQgY2xhc3MgQnJlYWRjcnVtYnNTdG9yZSBleHRlbmRzIEFzeW5jU3RvcmVXaXRoQ2xpZW50PElTdGF0ZT4ge1xuICAgIHByaXZhdGUgc3RhdGljIGludGVybmFsSW5zdGFuY2UgPSBuZXcgQnJlYWRjcnVtYnNTdG9yZSgpO1xuXG4gICAgcHJpdmF0ZSB3YWl0aW5nUm9vbXM6IHsgcm9vbUlkOiBzdHJpbmcsIGFkZGVkVHM6IG51bWJlciB9W10gPSBbXTtcblxuICAgIHByaXZhdGUgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHN1cGVyKGRlZmF1bHREaXNwYXRjaGVyKTtcblxuICAgICAgICBTZXR0aW5nc1N0b3JlLm1vbml0b3JTZXR0aW5nKFwiYnJlYWRjcnVtYl9yb29tc1wiLCBudWxsKTtcbiAgICAgICAgU2V0dGluZ3NTdG9yZS5tb25pdG9yU2V0dGluZyhcImJyZWFkY3J1bWJzXCIsIG51bGwpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0IGluc3RhbmNlKCk6IEJyZWFkY3J1bWJzU3RvcmUge1xuICAgICAgICByZXR1cm4gQnJlYWRjcnVtYnNTdG9yZS5pbnRlcm5hbEluc3RhbmNlO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgcm9vbXMoKTogUm9vbVtdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGUucm9vbXMgfHwgW107XG4gICAgfVxuXG4gICAgcHVibGljIGdldCB2aXNpYmxlKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZS5lbmFibGVkICYmIHRoaXMubWVldHNSb29tUmVxdWlyZW1lbnQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXQgbWVldHNSb29tUmVxdWlyZW1lbnQoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLm1hdHJpeENsaWVudCAmJiB0aGlzLm1hdHJpeENsaWVudC5nZXRWaXNpYmxlUm9vbXMoKS5sZW5ndGggPj0gMjA7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGFzeW5jIG9uQWN0aW9uKHBheWxvYWQ6IEFjdGlvblBheWxvYWQpIHtcbiAgICAgICAgaWYgKCF0aGlzLm1hdHJpeENsaWVudCkgcmV0dXJuO1xuXG4gICAgICAgIGlmIChwYXlsb2FkLmFjdGlvbiA9PT0gQWN0aW9uLlNldHRpbmdVcGRhdGVkKSB7XG4gICAgICAgICAgICBjb25zdCBzZXR0aW5nVXBkYXRlZFBheWxvYWQgPSBwYXlsb2FkIGFzIFNldHRpbmdVcGRhdGVkUGF5bG9hZDtcbiAgICAgICAgICAgIGlmIChzZXR0aW5nVXBkYXRlZFBheWxvYWQuc2V0dGluZ05hbWUgPT09ICdicmVhZGNydW1iX3Jvb21zJykge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMudXBkYXRlUm9vbXMoKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoc2V0dGluZ1VwZGF0ZWRQYXlsb2FkLnNldHRpbmdOYW1lID09PSAnYnJlYWRjcnVtYnMnKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVTdGF0ZSh7IGVuYWJsZWQ6IFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJicmVhZGNydW1ic1wiLCBudWxsKSB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChwYXlsb2FkLmFjdGlvbiA9PT0gQWN0aW9uLlZpZXdSb29tKSB7XG4gICAgICAgICAgICBpZiAocGF5bG9hZC5hdXRvX2pvaW4gJiYgIXRoaXMubWF0cml4Q2xpZW50LmdldFJvb20ocGF5bG9hZC5yb29tX2lkKSkge1xuICAgICAgICAgICAgICAgIC8vIFF1ZXVlIHRoZSByb29tIGluc3RlYWQgb2YgcHVzaGluZyBpdCBpbW1lZGlhdGVseS4gV2UncmUgcHJvYmFibHkganVzdFxuICAgICAgICAgICAgICAgIC8vIHdhaXRpbmcgZm9yIGEgcm9vbSBqb2luIHRvIGNvbXBsZXRlLlxuICAgICAgICAgICAgICAgIHRoaXMud2FpdGluZ1Jvb21zLnB1c2goeyByb29tSWQ6IHBheWxvYWQucm9vbV9pZCwgYWRkZWRUczogRGF0ZS5ub3coKSB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gVGhlIHRlc3RzIG1pZ2h0IG5vdCByZXN1bHQgaW4gYSB2YWxpZCByb29tIG9iamVjdC5cbiAgICAgICAgICAgICAgICBjb25zdCByb29tID0gdGhpcy5tYXRyaXhDbGllbnQuZ2V0Um9vbShwYXlsb2FkLnJvb21faWQpO1xuICAgICAgICAgICAgICAgIGlmIChyb29tKSBhd2FpdCB0aGlzLmFwcGVuZFJvb20ocm9vbSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgYXN5bmMgb25SZWFkeSgpIHtcbiAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVSb29tcygpO1xuICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZVN0YXRlKHsgZW5hYmxlZDogU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcImJyZWFkY3J1bWJzXCIsIG51bGwpIH0pO1xuXG4gICAgICAgIHRoaXMubWF0cml4Q2xpZW50Lm9uKFwiUm9vbS5teU1lbWJlcnNoaXBcIiwgdGhpcy5vbk15TWVtYmVyc2hpcCk7XG4gICAgICAgIHRoaXMubWF0cml4Q2xpZW50Lm9uKFwiUm9vbVwiLCB0aGlzLm9uUm9vbSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGFzeW5jIG9uTm90UmVhZHkoKSB7XG4gICAgICAgIHRoaXMubWF0cml4Q2xpZW50LnJlbW92ZUxpc3RlbmVyKFwiUm9vbS5teU1lbWJlcnNoaXBcIiwgdGhpcy5vbk15TWVtYmVyc2hpcCk7XG4gICAgICAgIHRoaXMubWF0cml4Q2xpZW50LnJlbW92ZUxpc3RlbmVyKFwiUm9vbVwiLCB0aGlzLm9uUm9vbSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbk15TWVtYmVyc2hpcCA9IGFzeW5jIChyb29tOiBSb29tKSA9PiB7XG4gICAgICAgIC8vIE9ubHkgdHVybiBvbiBicmVhZGNydW1icyBpcyB0aGUgdXNlciBoYXNuJ3QgZXhwbGljaXRseSB0dXJuZWQgaXQgb2ZmIGFnYWluLlxuICAgICAgICBjb25zdCBzZXR0aW5nVmFsdWVSYXcgPSBTZXR0aW5nc1N0b3JlLmdldFZhbHVlKFwiYnJlYWRjcnVtYnNcIiwgbnVsbCwgLypleGNsdWRlRGVmYXVsdD0qL3RydWUpO1xuICAgICAgICBpZiAodGhpcy5tZWV0c1Jvb21SZXF1aXJlbWVudCAmJiBpc051bGxPclVuZGVmaW5lZChzZXR0aW5nVmFsdWVSYXcpKSB7XG4gICAgICAgICAgICBhd2FpdCBTZXR0aW5nc1N0b3JlLnNldFZhbHVlKFwiYnJlYWRjcnVtYnNcIiwgbnVsbCwgU2V0dGluZ0xldmVsLkFDQ09VTlQsIHRydWUpO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25Sb29tID0gYXN5bmMgKHJvb206IFJvb20pID0+IHtcbiAgICAgICAgY29uc3Qgd2FpdGluZ1Jvb20gPSB0aGlzLndhaXRpbmdSb29tcy5maW5kKHIgPT4gci5yb29tSWQgPT09IHJvb20ucm9vbUlkKTtcbiAgICAgICAgaWYgKCF3YWl0aW5nUm9vbSkgcmV0dXJuO1xuICAgICAgICB0aGlzLndhaXRpbmdSb29tcy5zcGxpY2UodGhpcy53YWl0aW5nUm9vbXMuaW5kZXhPZih3YWl0aW5nUm9vbSksIDEpO1xuXG4gICAgICAgIGlmICgoRGF0ZS5ub3coKSAtIHdhaXRpbmdSb29tLmFkZGVkVHMpID4gQVVUT0pPSU5fV0FJVF9USFJFU0hPTERfTVMpIHJldHVybjsgLy8gVG9vIGxvbmcgYWdvLlxuICAgICAgICBhd2FpdCB0aGlzLmFwcGVuZFJvb20ocm9vbSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgYXN5bmMgdXBkYXRlUm9vbXMoKSB7XG4gICAgICAgIGxldCByb29tSWRzID0gU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcImJyZWFkY3J1bWJfcm9vbXNcIik7XG4gICAgICAgIGlmICghcm9vbUlkcyB8fCByb29tSWRzLmxlbmd0aCA9PT0gMCkgcm9vbUlkcyA9IFtdO1xuXG4gICAgICAgIGNvbnN0IHJvb21zID0gcm9vbUlkcy5tYXAociA9PiB0aGlzLm1hdHJpeENsaWVudC5nZXRSb29tKHIpKS5maWx0ZXIociA9PiAhIXIpO1xuICAgICAgICBjb25zdCBjdXJyZW50Um9vbXMgPSB0aGlzLnN0YXRlLnJvb21zIHx8IFtdO1xuICAgICAgICBpZiAoIWFycmF5SGFzRGlmZihyb29tcywgY3VycmVudFJvb21zKSkgcmV0dXJuOyAvLyBubyBjaGFuZ2UgKHByb2JhYmx5IGVjaG8pXG4gICAgICAgIGF3YWl0IHRoaXMudXBkYXRlU3RhdGUoeyByb29tcyB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIGFwcGVuZFJvb20ocm9vbTogUm9vbSkge1xuICAgICAgICBpZiAoU3BhY2VTdG9yZS5zcGFjZXNFbmFibGVkICYmIHJvb20uaXNTcGFjZVJvb20oKSkgcmV0dXJuOyAvLyBoaWRlIHNwYWNlIHJvb21zXG4gICAgICAgIGxldCB1cGRhdGVkID0gZmFsc2U7XG4gICAgICAgIGNvbnN0IHJvb21zID0gKHRoaXMuc3RhdGUucm9vbXMgfHwgW10pLnNsaWNlKCk7IC8vIGNoZWFwIGNsb25lXG5cbiAgICAgICAgLy8gSWYgdGhlIHJvb20gaXMgdXBncmFkZWQsIHVzZSB0aGF0IHJvb20gaW5zdGVhZC4gV2UnbGwgYWxzbyBzcGxpY2Ugb3V0XG4gICAgICAgIC8vIGFueSBjaGlsZHJlbiBvZiB0aGUgcm9vbS5cbiAgICAgICAgY29uc3QgaGlzdG9yeSA9IHRoaXMubWF0cml4Q2xpZW50LmdldFJvb21VcGdyYWRlSGlzdG9yeShyb29tLnJvb21JZCk7XG4gICAgICAgIGlmIChoaXN0b3J5Lmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgIHJvb20gPSBoaXN0b3J5W2hpc3RvcnkubGVuZ3RoIC0gMV07IC8vIExhc3Qgcm9vbSBpcyBtb3N0IHJlY2VudCBpbiBoaXN0b3J5XG5cbiAgICAgICAgICAgIC8vIFRha2Ugb3V0IGFueSByb29tIHRoYXQgaXNuJ3QgdGhlIG1vc3QgcmVjZW50IHJvb21cbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaGlzdG9yeS5sZW5ndGggLSAxOyBpKyspIHtcbiAgICAgICAgICAgICAgICBjb25zdCBpZHggPSByb29tcy5maW5kSW5kZXgociA9PiByLnJvb21JZCA9PT0gaGlzdG9yeVtpXS5yb29tSWQpO1xuICAgICAgICAgICAgICAgIGlmIChpZHggIT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIHJvb21zLnNwbGljZShpZHgsIDEpO1xuICAgICAgICAgICAgICAgICAgICB1cGRhdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBSZW1vdmUgdGhlIGV4aXN0aW5nIHJvb20sIGlmIGl0IGlzIHByZXNlbnRcbiAgICAgICAgY29uc3QgZXhpc3RpbmdJZHggPSByb29tcy5maW5kSW5kZXgociA9PiByLnJvb21JZCA9PT0gcm9vbS5yb29tSWQpO1xuXG4gICAgICAgIC8vIElmIHdlJ3JlIGZvY3VzaW5nIG9uIHRoZSBmaXJzdCByb29tIG5vLW9wXG4gICAgICAgIGlmIChleGlzdGluZ0lkeCAhPT0gMCkge1xuICAgICAgICAgICAgaWYgKGV4aXN0aW5nSWR4ICE9PSAtMSkge1xuICAgICAgICAgICAgICAgIHJvb21zLnNwbGljZShleGlzdGluZ0lkeCwgMSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIFNwbGljZSB0aGUgcm9vbSB0byB0aGUgc3RhcnQgb2YgdGhlIGxpc3RcbiAgICAgICAgICAgIHJvb21zLnNwbGljZSgwLCAwLCByb29tKTtcbiAgICAgICAgICAgIHVwZGF0ZWQgPSB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHJvb21zLmxlbmd0aCA+IE1BWF9ST09NUykge1xuICAgICAgICAgICAgLy8gVGhpcyBsb29rcyB3ZWlyZCwgYnV0IGl0J3Mgc2F5aW5nIHRvIHN0YXJ0IGF0IHRoZSBNQVhfUk9PTVMgcG9pbnQgaW4gdGhlXG4gICAgICAgICAgICAvLyBsaXN0IGFuZCBkZWxldGUgZXZlcnl0aGluZyBhZnRlciBpdC5cbiAgICAgICAgICAgIHJvb21zLnNwbGljZShNQVhfUk9PTVMsIHJvb21zLmxlbmd0aCAtIE1BWF9ST09NUyk7XG4gICAgICAgICAgICB1cGRhdGVkID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh1cGRhdGVkKSB7XG4gICAgICAgICAgICAvLyBVcGRhdGUgdGhlIGJyZWFkY3J1bWJzXG4gICAgICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZVN0YXRlKHsgcm9vbXMgfSk7XG4gICAgICAgICAgICBjb25zdCByb29tSWRzID0gcm9vbXMubWFwKHIgPT4gci5yb29tSWQpO1xuICAgICAgICAgICAgaWYgKHJvb21JZHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIGF3YWl0IFNldHRpbmdzU3RvcmUuc2V0VmFsdWUoXCJicmVhZGNydW1iX3Jvb21zXCIsIG51bGwsIFNldHRpbmdMZXZlbC5BQ0NPVU5ULCByb29tSWRzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==