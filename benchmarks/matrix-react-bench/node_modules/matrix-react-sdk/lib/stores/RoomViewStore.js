"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _utils = require("flux/utils");

var _dispatcher = _interopRequireDefault(require("../dispatcher/dispatcher"));

var _MatrixClientPeg = require("../MatrixClientPeg");

var sdk = _interopRequireWildcard(require("../index"));

var _Modal = _interopRequireDefault(require("../Modal"));

var _languageHandler = require("../languageHandler");

var _RoomAliasCache = require("../RoomAliasCache");

var _actions = require("../dispatcher/actions");

var _promise = require("../utils/promise");

var _CountlyAnalytics = _interopRequireDefault(require("../CountlyAnalytics"));

var _logger = require("matrix-js-sdk/src/logger");

var _RoomContext = require("../contexts/RoomContext");

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

const NUM_JOIN_RETRY = 5;
const INITIAL_STATE = {
  // Whether we're joining the currently viewed room (see isJoining())
  joining: false,
  // Any error that has occurred during joining
  joinError: null,
  // The room ID of the room currently being viewed
  roomId: null,
  // The event to scroll to when the room is first viewed
  initialEventId: null,
  initialEventPixelOffset: null,
  // Whether to highlight the initial event
  isInitialEventHighlighted: false,
  // The room alias of the room (or null if not originally specified in view_room)
  roomAlias: null,
  // Whether the current room is loading
  roomLoading: false,
  // Any error that has occurred during loading
  roomLoadError: null,
  quotingEvent: null,
  replyingToEvent: null,
  shouldPeek: false,
  viaServers: [],
  wasContextSwitch: false
};
/**
 * A class for storing application state for RoomView. This is the RoomView's interface
*  with a subset of the js-sdk.
 *  ```
 */

class RoomViewStore extends _utils.Store {
  // initialize state
  constructor() {
    super(_dispatcher.default);
    (0, _defineProperty2.default)(this, "state", INITIAL_STATE);
  }

  setState(newState) {
    // If values haven't changed, there's nothing to do.
    // This only tries a shallow comparison, so unchanged objects will slip
    // through, but that's probably okay for now.
    let stateChanged = false;

    for (const key of Object.keys(newState)) {
      if (this.state[key] !== newState[key]) {
        stateChanged = true;
        break;
      }
    }

    if (!stateChanged) {
      return;
    }

    this.state = Object.assign(this.state, newState);

    this.__emitChange();
  }

  __onDispatch(payload) {
    // eslint-disable-line @typescript-eslint/naming-convention
    switch (payload.action) {
      // view_room:
      //      - room_alias:   '#somealias:matrix.org'
      //      - room_id:      '!roomid123:matrix.org'
      //      - event_id:     '$213456782:matrix.org'
      //      - event_offset: 100
      //      - highlighted:  true
      case _actions.Action.ViewRoom:
        this.viewRoom(payload);
        break;
      // for these events blank out the roomId as we are no longer in the RoomView

      case 'view_create_group':
      case 'view_welcome_page':
      case 'view_home_page':
      case 'view_my_groups':
      case 'view_group':
        this.setState({
          roomId: null,
          roomAlias: null,
          viaServers: [],
          wasContextSwitch: false
        });
        break;

      case 'view_room_error':
        this.viewRoomError(payload);
        break;

      case 'will_join':
        this.setState({
          joining: true
        });
        break;

      case 'cancel_join':
        this.setState({
          joining: false
        });
        break;
      // join_room:
      //      - opts: options for joinRoom

      case _actions.Action.JoinRoom:
        this.joinRoom(payload);
        break;

      case _actions.Action.JoinRoomError:
        this.joinRoomError(payload);
        break;

      case _actions.Action.JoinRoomReady:
        this.setState({
          shouldPeek: false
        });
        break;

      case 'on_client_not_viable':
      case 'on_logged_out':
        this.reset();
        break;

      case 'reply_to_event':
        // If currently viewed room does not match the room in which we wish to reply then change rooms
        // this can happen when performing a search across all rooms
        if (payload.context === _RoomContext.TimelineRenderingType.Room) {
          if (payload.event && payload.event.getRoomId() !== this.state.roomId) {
            _dispatcher.default.dispatch({
              action: _actions.Action.ViewRoom,
              room_id: payload.event.getRoomId(),
              replyingToEvent: payload.event
            });
          } else {
            this.setState({
              replyingToEvent: payload.event
            });
          }
        }

        break;

      case 'open_room_settings':
        {
          // FIXME: Using an import will result in test failures
          const RoomSettingsDialog = sdk.getComponent("dialogs.RoomSettingsDialog");

          _Modal.default.createTrackedDialog('Room settings', '', RoomSettingsDialog, {
            roomId: payload.room_id || this.state.roomId,
            initialTabId: payload.initial_tab_id
          },
          /*className=*/
          null,
          /*isPriority=*/
          false,
          /*isStatic=*/
          true);

          break;
        }
    }
  }

  async viewRoom(payload) {
    if (payload.room_id) {
      const newState = {
        roomId: payload.room_id,
        roomAlias: payload.room_alias,
        initialEventId: payload.event_id,
        isInitialEventHighlighted: payload.highlighted,
        roomLoading: false,
        roomLoadError: null,
        // should peek by default
        shouldPeek: payload.should_peek === undefined ? true : payload.should_peek,
        // have we sent a join request for this room and are waiting for a response?
        joining: payload.joining || false,
        // Reset replyingToEvent because we don't want cross-room because bad UX
        replyingToEvent: null,
        // pull the user out of Room Settings
        isEditingSettings: false,
        viaServers: payload.via_servers,
        wasContextSwitch: payload.context_switch
      }; // Allow being given an event to be replied to when switching rooms but sanity check its for this room

      if (payload.replyingToEvent && payload.replyingToEvent.getRoomId() === payload.room_id) {
        newState.replyingToEvent = payload.replyingToEvent;
      }

      this.setState(newState);

      if (payload.auto_join) {
        _dispatcher.default.dispatch(_objectSpread(_objectSpread({}, payload), {}, {
          action: _actions.Action.JoinRoom,
          roomId: payload.room_id
        }));
      }
    } else if (payload.room_alias) {
      // Try the room alias to room ID navigation cache first to avoid
      // blocking room navigation on the homeserver.
      let roomId = (0, _RoomAliasCache.getCachedRoomIDForAlias)(payload.room_alias);

      if (!roomId) {
        // Room alias cache miss, so let's ask the homeserver. Resolve the alias
        // and then do a second dispatch with the room ID acquired.
        this.setState({
          roomId: null,
          initialEventId: null,
          initialEventPixelOffset: null,
          isInitialEventHighlighted: null,
          roomAlias: payload.room_alias,
          roomLoading: true,
          roomLoadError: null,
          viaServers: payload.via_servers,
          wasContextSwitch: payload.context_switch
        });

        try {
          const result = await _MatrixClientPeg.MatrixClientPeg.get().getRoomIdForAlias(payload.room_alias);
          (0, _RoomAliasCache.storeRoomAliasInCache)(payload.room_alias, result.room_id);
          roomId = result.room_id;
        } catch (err) {
          _logger.logger.error("RVS failed to get room id for alias: ", err);

          _dispatcher.default.dispatch({
            action: 'view_room_error',
            room_id: null,
            room_alias: payload.room_alias,
            err
          });

          return;
        }
      }

      _dispatcher.default.dispatch({
        action: _actions.Action.ViewRoom,
        room_id: roomId,
        event_id: payload.event_id,
        highlighted: payload.highlighted,
        room_alias: payload.room_alias,
        auto_join: payload.auto_join,
        oob_data: payload.oob_data,
        viaServers: payload.via_servers,
        wasContextSwitch: payload.context_switch
      });
    }
  }

  viewRoomError(payload) {
    this.setState({
      roomId: payload.room_id,
      roomAlias: payload.room_alias,
      roomLoading: false,
      roomLoadError: payload.err
    });
  }

  async joinRoom(payload) {
    const startTime = _CountlyAnalytics.default.getTimestamp();

    this.setState({
      joining: true
    });

    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    const address = this.state.roomAlias || this.state.roomId;
    const viaServers = this.state.viaServers || [];

    try {
      await (0, _promise.retry)(() => cli.joinRoom(address, _objectSpread({
        viaServers
      }, payload.opts)), NUM_JOIN_RETRY, err => {
        // if we received a Gateway timeout then retry
        return err.httpStatus === 504;
      });

      _CountlyAnalytics.default.instance.trackRoomJoin(startTime, this.state.roomId, payload._type); // We do *not* clear the 'joining' flag because the Room object and/or our 'joined' member event may not
      // have come down the sync stream yet, and that's the point at which we'd consider the user joined to the
      // room.


      _dispatcher.default.dispatch({
        action: _actions.Action.JoinRoomReady,
        roomId: this.state.roomId
      });
    } catch (err) {
      _dispatcher.default.dispatch({
        action: _actions.Action.JoinRoomError,
        roomId: this.state.roomId,
        err: err
      });
    }
  }

  static getInvitingUserId(roomId) {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    const room = cli.getRoom(roomId);

    if (room && room.getMyMembership() === "invite") {
      const myMember = room.getMember(cli.getUserId());
      const inviteEvent = myMember ? myMember.events.member : null;
      return inviteEvent && inviteEvent.getSender();
    }
  }

  showJoinRoomError(err, roomId) {
    let msg = err.message ? err.message : JSON.stringify(err);

    _logger.logger.log("Failed to join room:", msg);

    if (err.name === "ConnectionError") {
      msg = (0, _languageHandler._t)("There was an error joining the room");
    } else if (err.errcode === 'M_INCOMPATIBLE_ROOM_VERSION') {
      msg = /*#__PURE__*/_react.default.createElement("div", null, (0, _languageHandler._t)("Sorry, your homeserver is too old to participate in this room."), /*#__PURE__*/_react.default.createElement("br", null), (0, _languageHandler._t)("Please contact your homeserver administrator."));
    } else if (err.httpStatus === 404) {
      const invitingUserId = RoomViewStore.getInvitingUserId(roomId); // only provide a better error message for invites

      if (invitingUserId) {
        // if the inviting user is on the same HS, there can only be one cause: they left.
        if (invitingUserId.endsWith(`:${_MatrixClientPeg.MatrixClientPeg.get().getDomain()}`)) {
          msg = (0, _languageHandler._t)("The person who invited you already left the room.");
        } else {
          msg = (0, _languageHandler._t)("The person who invited you already left the room, or their server is offline.");
        }
      }
    } // FIXME: Using an import will result in test failures


    const ErrorDialog = sdk.getComponent("dialogs.ErrorDialog");

    _Modal.default.createTrackedDialog('Failed to join room', '', ErrorDialog, {
      title: (0, _languageHandler._t)("Failed to join room"),
      description: msg
    });
  }

  joinRoomError(payload) {
    this.setState({
      joining: false,
      joinError: payload.err
    });
    this.showJoinRoomError(payload.err, this.state.roomId);
  }

  reset() {
    this.state = Object.assign({}, INITIAL_STATE);
  } // The room ID of the room currently being viewed


  getRoomId() {
    return this.state.roomId;
  } // The event to scroll to when the room is first viewed


  getInitialEventId() {
    return this.state.initialEventId;
  } // Whether to highlight the initial event


  isInitialEventHighlighted() {
    return this.state.isInitialEventHighlighted;
  } // The room alias of the room (or null if not originally specified in view_room)


  getRoomAlias() {
    return this.state.roomAlias;
  } // Whether the current room is loading (true whilst resolving an alias)


  isRoomLoading() {
    return this.state.roomLoading;
  } // Any error that has occurred during loading


  getRoomLoadError() {
    return this.state.roomLoadError;
  } // True if we're expecting the user to be joined to the room currently being
  // viewed. Note that this is left true after the join request has finished,
  // since we should still consider a join to be in progress until the room
  // & member events come down the sync.
  //
  // This flag remains true after the room has been sucessfully joined,
  // (this store doesn't listen for the appropriate member events)
  // so you should always observe the joined state from the member event
  // if a room object is present.
  // ie. The correct logic is:
  // if (room) {
  //     if (myMember.membership == 'joined') {
  //         // user is joined to the room
  //     } else {
  //         // Not joined
  //     }
  // } else {
  //     if (RoomViewStore.isJoining()) {
  //         // show spinner
  //     } else {
  //         // show join prompt
  //     }
  // }


  isJoining() {
    return this.state.joining;
  } // Any error that has occurred during joining


  getJoinError() {
    return this.state.joinError;
  } // The mxEvent if one is currently being replied to/quoted


  getQuotingEvent() {
    return this.state.replyingToEvent;
  }

  shouldPeek() {
    return this.state.shouldPeek;
  }

  getWasContextSwitch() {
    return this.state.wasContextSwitch;
  }

}

let singletonRoomViewStore = null;

if (!singletonRoomViewStore) {
  singletonRoomViewStore = new RoomViewStore();
}

var _default = singletonRoomViewStore;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdG9yZXMvUm9vbVZpZXdTdG9yZS50c3giXSwibmFtZXMiOlsiTlVNX0pPSU5fUkVUUlkiLCJJTklUSUFMX1NUQVRFIiwiam9pbmluZyIsImpvaW5FcnJvciIsInJvb21JZCIsImluaXRpYWxFdmVudElkIiwiaW5pdGlhbEV2ZW50UGl4ZWxPZmZzZXQiLCJpc0luaXRpYWxFdmVudEhpZ2hsaWdodGVkIiwicm9vbUFsaWFzIiwicm9vbUxvYWRpbmciLCJyb29tTG9hZEVycm9yIiwicXVvdGluZ0V2ZW50IiwicmVwbHlpbmdUb0V2ZW50Iiwic2hvdWxkUGVlayIsInZpYVNlcnZlcnMiLCJ3YXNDb250ZXh0U3dpdGNoIiwiUm9vbVZpZXdTdG9yZSIsIlN0b3JlIiwiY29uc3RydWN0b3IiLCJkaXMiLCJzZXRTdGF0ZSIsIm5ld1N0YXRlIiwic3RhdGVDaGFuZ2VkIiwia2V5IiwiT2JqZWN0Iiwia2V5cyIsInN0YXRlIiwiYXNzaWduIiwiX19lbWl0Q2hhbmdlIiwiX19vbkRpc3BhdGNoIiwicGF5bG9hZCIsImFjdGlvbiIsIkFjdGlvbiIsIlZpZXdSb29tIiwidmlld1Jvb20iLCJ2aWV3Um9vbUVycm9yIiwiSm9pblJvb20iLCJqb2luUm9vbSIsIkpvaW5Sb29tRXJyb3IiLCJqb2luUm9vbUVycm9yIiwiSm9pblJvb21SZWFkeSIsInJlc2V0IiwiY29udGV4dCIsIlRpbWVsaW5lUmVuZGVyaW5nVHlwZSIsIlJvb20iLCJldmVudCIsImdldFJvb21JZCIsImRpc3BhdGNoIiwicm9vbV9pZCIsIlJvb21TZXR0aW5nc0RpYWxvZyIsInNkayIsImdldENvbXBvbmVudCIsIk1vZGFsIiwiY3JlYXRlVHJhY2tlZERpYWxvZyIsImluaXRpYWxUYWJJZCIsImluaXRpYWxfdGFiX2lkIiwicm9vbV9hbGlhcyIsImV2ZW50X2lkIiwiaGlnaGxpZ2h0ZWQiLCJzaG91bGRfcGVlayIsInVuZGVmaW5lZCIsImlzRWRpdGluZ1NldHRpbmdzIiwidmlhX3NlcnZlcnMiLCJjb250ZXh0X3N3aXRjaCIsImF1dG9fam9pbiIsInJlc3VsdCIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsImdldFJvb21JZEZvckFsaWFzIiwiZXJyIiwibG9nZ2VyIiwiZXJyb3IiLCJvb2JfZGF0YSIsInN0YXJ0VGltZSIsIkNvdW50bHlBbmFseXRpY3MiLCJnZXRUaW1lc3RhbXAiLCJjbGkiLCJhZGRyZXNzIiwib3B0cyIsImh0dHBTdGF0dXMiLCJpbnN0YW5jZSIsInRyYWNrUm9vbUpvaW4iLCJfdHlwZSIsImdldEludml0aW5nVXNlcklkIiwicm9vbSIsImdldFJvb20iLCJnZXRNeU1lbWJlcnNoaXAiLCJteU1lbWJlciIsImdldE1lbWJlciIsImdldFVzZXJJZCIsImludml0ZUV2ZW50IiwiZXZlbnRzIiwibWVtYmVyIiwiZ2V0U2VuZGVyIiwic2hvd0pvaW5Sb29tRXJyb3IiLCJtc2ciLCJtZXNzYWdlIiwiSlNPTiIsInN0cmluZ2lmeSIsImxvZyIsIm5hbWUiLCJlcnJjb2RlIiwiaW52aXRpbmdVc2VySWQiLCJlbmRzV2l0aCIsImdldERvbWFpbiIsIkVycm9yRGlhbG9nIiwidGl0bGUiLCJkZXNjcmlwdGlvbiIsImdldEluaXRpYWxFdmVudElkIiwiZ2V0Um9vbUFsaWFzIiwiaXNSb29tTG9hZGluZyIsImdldFJvb21Mb2FkRXJyb3IiLCJpc0pvaW5pbmciLCJnZXRKb2luRXJyb3IiLCJnZXRRdW90aW5nRXZlbnQiLCJnZXRXYXNDb250ZXh0U3dpdGNoIiwic2luZ2xldG9uUm9vbVZpZXdTdG9yZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFrQkE7O0FBQ0E7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7Ozs7Ozs7Ozs7QUFFQSxNQUFNQSxjQUFjLEdBQUcsQ0FBdkI7QUFFQSxNQUFNQyxhQUFhLEdBQUc7QUFDbEI7QUFDQUMsRUFBQUEsT0FBTyxFQUFFLEtBRlM7QUFHbEI7QUFDQUMsRUFBQUEsU0FB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YSxHQUFHO0FBQ25CLFdBQU8sS0FBS3BGLEtBQUwsQ0FBV2pCLFdBQWxCO0FBQ0gsR0F4VDRDLENBMFQ3Qzs7O0FBQ09zRyxFQUFBQSxnQkFBZ0IsR0FBRztBQUN0QixXQUFPLEtBQUtyRixLQUFMLENBQVdoQixhQUFsQjtBQUNILEdBN1Q0QyxDQStUN0M7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FBQ09zRyxFQUFBQSxTQUFTLEdBQUc7QUFDZixXQUFPLEtBQUt0RixLQUFMLENBQVd4QixPQUFsQjtBQUNILEdBeFY0QyxDQTBWN0M7OztBQUNPK0csRUFBQUEsWUFBWSxHQUFHO0FBQ2xCLFdBQU8sS0FBS3ZGLEtBQUwsQ0FBV3ZCLFNBQWxCO0FBQ0gsR0E3VjRDLENBK1Y3Qzs7O0FBQ08rRyxFQUFBQSxlQUFlLEdBQUc7QUFDckIsV0FBTyxLQUFLeEYsS0FBTCxDQUFXZCxlQUFsQjtBQUNIOztBQUVNQyxFQUFBQSxVQUFVLEdBQUc7QUFDaEIsV0FBTyxLQUFLYSxLQUFMLENBQVdiLFVBQWxCO0FBQ0g7O0FBRU1zRyxFQUFBQSxtQkFBbUIsR0FBRztBQUN6QixXQUFPLEtBQUt6RixLQUFMLENBQVdYLGdCQUFsQjtBQUNIOztBQTFXNEM7O0FBNldqRCxJQUFJcUcsc0JBQXFDLEdBQUcsSUFBNUM7O0FBQ0EsSUFBSSxDQUFDQSxzQkFBTCxFQUE2QjtBQUN6QkEsRUFBQUEsc0JBQXNCLEdBQUcsSUFBSXBHLGFBQUosRUFBekI7QUFDSDs7ZUFDY29HLHNCIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE3IFZlY3RvciBDcmVhdGlvbnMgTHRkXG5Db3B5cmlnaHQgMjAxNywgMjAxOCBOZXcgVmVjdG9yIEx0ZFxuQ29weXJpZ2h0IDIwMTkgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSBcInJlYWN0XCI7XG5pbXBvcnQgeyBTdG9yZSB9IGZyb20gJ2ZsdXgvdXRpbHMnO1xuaW1wb3J0IHsgTWF0cml4RXJyb3IgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvaHR0cC1hcGlcIjtcblxuaW1wb3J0IGRpcyBmcm9tICcuLi9kaXNwYXRjaGVyL2Rpc3BhdGNoZXInO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSAnLi4vTWF0cml4Q2xpZW50UGVnJztcbmltcG9ydCAqIGFzIHNkayBmcm9tICcuLi9pbmRleCc7XG5pbXBvcnQgTW9kYWwgZnJvbSAnLi4vTW9kYWwnO1xuaW1wb3J0IHsgX3QgfSBmcm9tICcuLi9sYW5ndWFnZUhhbmRsZXInO1xuaW1wb3J0IHsgZ2V0Q2FjaGVkUm9vbUlERm9yQWxpYXMsIHN0b3JlUm9vbUFsaWFzSW5DYWNoZSB9IGZyb20gJy4uL1Jvb21BbGlhc0NhY2hlJztcbmltcG9ydCB7IEFjdGlvblBheWxvYWQgfSBmcm9tIFwiLi4vZGlzcGF0Y2hlci9wYXlsb2Fkc1wiO1xuaW1wb3J0IHsgQWN0aW9uIH0gZnJvbSBcIi4uL2Rpc3BhdGNoZXIvYWN0aW9uc1wiO1xuaW1wb3J0IHsgcmV0cnkgfSBmcm9tIFwiLi4vdXRpbHMvcHJvbWlzZVwiO1xuaW1wb3J0IENvdW50bHlBbmFseXRpY3MgZnJvbSBcIi4uL0NvdW50bHlBbmFseXRpY3NcIjtcblxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2xvZ2dlclwiO1xuaW1wb3J0IHsgVGltZWxpbmVSZW5kZXJpbmdUeXBlIH0gZnJvbSBcIi4uL2NvbnRleHRzL1Jvb21Db250ZXh0XCI7XG5cbmNvbnN0IE5VTV9KT0lOX1JFVFJZID0gNTtcblxuY29uc3QgSU5JVElBTF9TVEFURSA9IHtcbiAgICAvLyBXaGV0aGVyIHdlJ3JlIGpvaW5pbmcgdGhlIGN1cnJlbnRseSB2aWV3ZWQgcm9vbSAoc2VlIGlzSm9pbmluZygpKVxuICAgIGpvaW5pbmc6IGZhbHNlLFxuICAgIC8vIEFueSBlcnJvciB0aGF0IGhhcyBvY2N1cnJlZCBkdXJpbmcgam9pbmluZ1xuICAgIGpvaW5FcnJvcjogbnVsbCxcbiAgICAvLyBUaGUgcm9vbSBJRCBvZiB0aGUgcm9vbSBjdXJyZW50bHkgYmVpbmcgdmlld2VkXG4gICAgcm9vbUlkOiBudWxsLFxuXG4gICAgLy8gVGhlIGV2ZW50IHRvIHNjcm9sbCB0byB3aGVuIHRoZSByb29tIGlzIGZpcnN0IHZpZXdlZFxuICAgIGluaXRpYWxFdmVudElkOiBudWxsLFxuICAgIGluaXRpYWxFdmVudFBpeGVsT2Zmc2V0OiBudWxsLFxuICAgIC8vIFdoZXRoZXIgdG8gaGlnaGxpZ2h0IHRoZSBpbml0aWFsIGV2ZW50XG4gICAgaXNJbml0aWFsRXZlbnRIaWdobGlnaHRlZDogZmFsc2UsXG5cbiAgICAvLyBUaGUgcm9vbSBhbGlhcyBvZiB0aGUgcm9vbSAob3IgbnVsbCBpZiBub3Qgb3JpZ2luYWxseSBzcGVjaWZpZWQgaW4gdmlld19yb29tKVxuICAgIHJvb21BbGlhczogbnVsbCxcbiAgICAvLyBXaGV0aGVyIHRoZSBjdXJyZW50IHJvb20gaXMgbG9hZGluZ1xuICAgIHJvb21Mb2FkaW5nOiBmYWxzZSxcbiAgICAvLyBBbnkgZXJyb3IgdGhhdCBoYXMgb2NjdXJyZWQgZHVyaW5nIGxvYWRpbmdcbiAgICByb29tTG9hZEVycm9yOiBudWxsLFxuXG4gICAgcXVvdGluZ0V2ZW50OiBudWxsLFxuXG4gICAgcmVwbHlpbmdUb0V2ZW50OiBudWxsLFxuXG4gICAgc2hvdWxkUGVlazogZmFsc2UsXG5cbiAgICB2aWFTZXJ2ZXJzOiBbXSxcblxuICAgIHdhc0NvbnRleHRTd2l0Y2g6IGZhbHNlLFxufTtcblxuLyoqXG4gKiBBIGNsYXNzIGZvciBzdG9yaW5nIGFwcGxpY2F0aW9uIHN0YXRlIGZvciBSb29tVmlldy4gVGhpcyBpcyB0aGUgUm9vbVZpZXcncyBpbnRlcmZhY2VcbiogIHdpdGggYSBzdWJzZXQgb2YgdGhlIGpzLXNkay5cbiAqICBgYGBcbiAqL1xuY2xhc3MgUm9vbVZpZXdTdG9yZSBleHRlbmRzIFN0b3JlPEFjdGlvblBheWxvYWQ+IHtcbiAgICBwcml2YXRlIHN0YXRlID0gSU5JVElBTF9TVEFURTsgLy8gaW5pdGlhbGl6ZSBzdGF0ZVxuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHN1cGVyKGRpcyk7XG4gICAgfVxuXG4gICAgc2V0U3RhdGUobmV3U3RhdGU6IFBhcnRpYWw8dHlwZW9mIElOSVRJQUxfU1RBVEU+KSB7XG4gICAgICAgIC8vIElmIHZhbHVlcyBoYXZlbid0IGNoYW5nZWQsIHRoZXJlJ3Mgbm90aGluZyB0byBkby5cbiAgICAgICAgLy8gVGhpcyBvbmx5IHRyaWVzIGEgc2hhbGxvdyBjb21wYXJpc29uLCBzbyB1bmNoYW5nZWQgb2JqZWN0cyB3aWxsIHNsaXBcbiAgICAgICAgLy8gdGhyb3VnaCwgYnV0IHRoYXQncyBwcm9iYWJseSBva2F5IGZvciBub3cuXG4gICAgICAgIGxldCBzdGF0ZUNoYW5nZWQgPSBmYWxzZTtcbiAgICAgICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXMobmV3U3RhdGUpKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5zdGF0ZVtrZXldICE9PSBuZXdTdGF0ZVtrZXldKSB7XG4gICAgICAgICAgICAgICAgc3RhdGVDaGFuZ2VkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoIXN0YXRlQ2hhbmdlZCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zdGF0ZSA9IE9iamVjdC5hc3NpZ24odGhpcy5zdGF0ZSwgbmV3U3RhdGUpO1xuICAgICAgICB0aGlzLl9fZW1pdENoYW5nZSgpO1xuICAgIH1cblxuICAgIF9fb25EaXNwYXRjaChwYXlsb2FkKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25hbWluZy1jb252ZW50aW9uXG4gICAgICAgIHN3aXRjaCAocGF5bG9hZC5hY3Rpb24pIHtcbiAgICAgICAgICAgIC8vIHZpZXdfcm9vbTpcbiAgICAgICAgICAgIC8vICAgICAgLSByb29tX2FsaWFzOiAgICcjc29tZWFsaWFzOm1hdHJpeC5vcmcnXG4gICAgICAgICAgICAvLyAgICAgIC0gcm9vbV9pZDogICAgICAnIXJvb21pZDEyMzptYXRyaXgub3JnJ1xuICAgICAgICAgICAgLy8gICAgICAtIGV2ZW50X2lkOiAgICAgJyQyMTM0NTY3ODI6bWF0cml4Lm9yZydcbiAgICAgICAgICAgIC8vICAgICAgLSBldmVudF9vZmZzZXQ6IDEwMFxuICAgICAgICAgICAgLy8gICAgICAtIGhpZ2hsaWdodGVkOiAgdHJ1ZVxuICAgICAgICAgICAgY2FzZSBBY3Rpb24uVmlld1Jvb206XG4gICAgICAgICAgICAgICAgdGhpcy52aWV3Um9vbShwYXlsb2FkKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIC8vIGZvciB0aGVzZSBldmVudHMgYmxhbmsgb3V0IHRoZSByb29tSWQgYXMgd2UgYXJlIG5vIGxvbmdlciBpbiB0aGUgUm9vbVZpZXdcbiAgICAgICAgICAgIGNhc2UgJ3ZpZXdfY3JlYXRlX2dyb3VwJzpcbiAgICAgICAgICAgIGNhc2UgJ3ZpZXdfd2VsY29tZV9wYWdlJzpcbiAgICAgICAgICAgIGNhc2UgJ3ZpZXdfaG9tZV9wYWdlJzpcbiAgICAgICAgICAgIGNhc2UgJ3ZpZXdfbXlfZ3JvdXBzJzpcbiAgICAgICAgICAgIGNhc2UgJ3ZpZXdfZ3JvdXAnOlxuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgICAgICByb29tSWQ6IG51bGwsXG4gICAgICAgICAgICAgICAgICAgIHJvb21BbGlhczogbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgdmlhU2VydmVyczogW10sXG4gICAgICAgICAgICAgICAgICAgIHdhc0NvbnRleHRTd2l0Y2g6IGZhbHNlLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAndmlld19yb29tX2Vycm9yJzpcbiAgICAgICAgICAgICAgICB0aGlzLnZpZXdSb29tRXJyb3IocGF5bG9hZCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICd3aWxsX2pvaW4nOlxuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgICAgICBqb2luaW5nOiB0cnVlLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnY2FuY2VsX2pvaW4nOlxuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgICAgICBqb2luaW5nOiBmYWxzZSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIC8vIGpvaW5fcm9vbTpcbiAgICAgICAgICAgIC8vICAgICAgLSBvcHRzOiBvcHRpb25zIGZvciBqb2luUm9vbVxuICAgICAgICAgICAgY2FzZSBBY3Rpb24uSm9pblJvb206XG4gICAgICAgICAgICAgICAgdGhpcy5qb2luUm9vbShwYXlsb2FkKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgQWN0aW9uLkpvaW5Sb29tRXJyb3I6XG4gICAgICAgICAgICAgICAgdGhpcy5qb2luUm9vbUVycm9yKHBheWxvYWQpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBBY3Rpb24uSm9pblJvb21SZWFkeTpcbiAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgc2hvdWxkUGVlazogZmFsc2UgfSk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdvbl9jbGllbnRfbm90X3ZpYWJsZSc6XG4gICAgICAgICAgICBjYXNlICdvbl9sb2dnZWRfb3V0JzpcbiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0KCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdyZXBseV90b19ldmVudCc6XG4gICAgICAgICAgICAgICAgLy8gSWYgY3VycmVudGx5IHZpZXdlZCByb29tIGRvZXMgbm90IG1hdGNoIHRoZSByb29tIGluIHdoaWNoIHdlIHdpc2ggdG8gcmVwbHkgdGhlbiBjaGFuZ2Ugcm9vbXNcbiAgICAgICAgICAgICAgICAvLyB0aGlzIGNhbiBoYXBwZW4gd2hlbiBwZXJmb3JtaW5nIGEgc2VhcmNoIGFjcm9zcyBhbGwgcm9vbXNcbiAgICAgICAgICAgICAgICBpZiAocGF5bG9hZC5jb250ZXh0ID09PSBUaW1lbGluZVJlbmRlcmluZ1R5cGUuUm9vbSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAocGF5bG9hZC5ldmVudFxuICAgICAgICAgICAgICAgICAgICAgICAgJiYgcGF5bG9hZC5ldmVudC5nZXRSb29tSWQoKSAhPT0gdGhpcy5zdGF0ZS5yb29tSWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpcy5kaXNwYXRjaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uOiBBY3Rpb24uVmlld1Jvb20sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcm9vbV9pZDogcGF5bG9hZC5ldmVudC5nZXRSb29tSWQoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXBseWluZ1RvRXZlbnQ6IHBheWxvYWQuZXZlbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGx5aW5nVG9FdmVudDogcGF5bG9hZC5ldmVudCxcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnb3Blbl9yb29tX3NldHRpbmdzJzoge1xuICAgICAgICAgICAgICAgIC8vIEZJWE1FOiBVc2luZyBhbiBpbXBvcnQgd2lsbCByZXN1bHQgaW4gdGVzdCBmYWlsdXJlc1xuICAgICAgICAgICAgICAgIGNvbnN0IFJvb21TZXR0aW5nc0RpYWxvZyA9IHNkay5nZXRDb21wb25lbnQoXCJkaWFsb2dzLlJvb21TZXR0aW5nc0RpYWxvZ1wiKTtcbiAgICAgICAgICAgICAgICBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nKCdSb29tIHNldHRpbmdzJywgJycsIFJvb21TZXR0aW5nc0RpYWxvZywge1xuICAgICAgICAgICAgICAgICAgICByb29tSWQ6IHBheWxvYWQucm9vbV9pZCB8fCB0aGlzLnN0YXRlLnJvb21JZCxcbiAgICAgICAgICAgICAgICAgICAgaW5pdGlhbFRhYklkOiBwYXlsb2FkLmluaXRpYWxfdGFiX2lkLFxuICAgICAgICAgICAgICAgIH0sIC8qY2xhc3NOYW1lPSovbnVsbCwgLyppc1ByaW9yaXR5PSovZmFsc2UsIC8qaXNTdGF0aWM9Ki90cnVlKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgdmlld1Jvb20ocGF5bG9hZDogQWN0aW9uUGF5bG9hZCkge1xuICAgICAgICBpZiAocGF5bG9hZC5yb29tX2lkKSB7XG4gICAgICAgICAgICBjb25zdCBuZXdTdGF0ZSA9IHtcbiAgICAgICAgICAgICAgICByb29tSWQ6IHBheWxvYWQucm9vbV9pZCxcbiAgICAgICAgICAgICAgICByb29tQWxpYXM6IHBheWxvYWQucm9vbV9hbGlhcyxcbiAgICAgICAgICAgICAgICBpbml0aWFsRXZlbnRJZDogcGF5bG9hZC5ldmVudF9pZCxcbiAgICAgICAgICAgICAgICBpc0luaXRpYWxFdmVudEhpZ2hsaWdodGVkOiBwYXlsb2FkLmhpZ2hsaWdodGVkLFxuICAgICAgICAgICAgICAgIHJvb21Mb2FkaW5nOiBmYWxzZSxcbiAgICAgICAgICAgICAgICByb29tTG9hZEVycm9yOiBudWxsLFxuICAgICAgICAgICAgICAgIC8vIHNob3VsZCBwZWVrIGJ5IGRlZmF1bHRcbiAgICAgICAgICAgICAgICBzaG91bGRQZWVrOiBwYXlsb2FkLnNob3VsZF9wZWVrID09PSB1bmRlZmluZWQgPyB0cnVlIDogcGF5bG9hZC5zaG91bGRfcGVlayxcbiAgICAgICAgICAgICAgICAvLyBoYXZlIHdlIHNlbnQgYSBqb2luIHJlcXVlc3QgZm9yIHRoaXMgcm9vbSBhbmQgYXJlIHdhaXRpbmcgZm9yIGEgcmVzcG9uc2U/XG4gICAgICAgICAgICAgICAgam9pbmluZzogcGF5bG9hZC5qb2luaW5nIHx8IGZhbHNlLFxuICAgICAgICAgICAgICAgIC8vIFJlc2V0IHJlcGx5aW5nVG9FdmVudCBiZWNhdXNlIHdlIGRvbid0IHdhbnQgY3Jvc3Mtcm9vbSBiZWNhdXNlIGJhZCBVWFxuICAgICAgICAgICAgICAgIHJlcGx5aW5nVG9FdmVudDogbnVsbCxcbiAgICAgICAgICAgICAgICAvLyBwdWxsIHRoZSB1c2VyIG91dCBvZiBSb29tIFNldHRpbmdzXG4gICAgICAgICAgICAgICAgaXNFZGl0aW5nU2V0dGluZ3M6IGZhbHNlLFxuICAgICAgICAgICAgICAgIHZpYVNlcnZlcnM6IHBheWxvYWQudmlhX3NlcnZlcnMsXG4gICAgICAgICAgICAgICAgd2FzQ29udGV4dFN3aXRjaDogcGF5bG9hZC5jb250ZXh0X3N3aXRjaCxcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIC8vIEFsbG93IGJlaW5nIGdpdmVuIGFuIGV2ZW50IHRvIGJlIHJlcGxpZWQgdG8gd2hlbiBzd2l0Y2hpbmcgcm9vbXMgYnV0IHNhbml0eSBjaGVjayBpdHMgZm9yIHRoaXMgcm9vbVxuICAgICAgICAgICAgaWYgKHBheWxvYWQucmVwbHlpbmdUb0V2ZW50ICYmIHBheWxvYWQucmVwbHlpbmdUb0V2ZW50LmdldFJvb21JZCgpID09PSBwYXlsb2FkLnJvb21faWQpIHtcbiAgICAgICAgICAgICAgICBuZXdTdGF0ZS5yZXBseWluZ1RvRXZlbnQgPSBwYXlsb2FkLnJlcGx5aW5nVG9FdmVudDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZShuZXdTdGF0ZSk7XG5cbiAgICAgICAgICAgIGlmIChwYXlsb2FkLmF1dG9fam9pbikge1xuICAgICAgICAgICAgICAgIGRpcy5kaXNwYXRjaCh7XG4gICAgICAgICAgICAgICAgICAgIC4uLnBheWxvYWQsXG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbjogQWN0aW9uLkpvaW5Sb29tLFxuICAgICAgICAgICAgICAgICAgICByb29tSWQ6IHBheWxvYWQucm9vbV9pZCxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChwYXlsb2FkLnJvb21fYWxpYXMpIHtcbiAgICAgICAgICAgIC8vIFRyeSB0aGUgcm9vbSBhbGlhcyB0byByb29tIElEIG5hdmlnYXRpb24gY2FjaGUgZmlyc3QgdG8gYXZvaWRcbiAgICAgICAgICAgIC8vIGJsb2NraW5nIHJvb20gbmF2aWdhdGlvbiBvbiB0aGUgaG9tZXNlcnZlci5cbiAgICAgICAgICAgIGxldCByb29tSWQgPSBnZXRDYWNoZWRSb29tSURGb3JBbGlhcyhwYXlsb2FkLnJvb21fYWxpYXMpO1xuICAgICAgICAgICAgaWYgKCFyb29tSWQpIHtcbiAgICAgICAgICAgICAgICAvLyBSb29tIGFsaWFzIGNhY2hlIG1pc3MsIHNvIGxldCdzIGFzayB0aGUgaG9tZXNlcnZlci4gUmVzb2x2ZSB0aGUgYWxpYXNcbiAgICAgICAgICAgICAgICAvLyBhbmQgdGhlbiBkbyBhIHNlY29uZCBkaXNwYXRjaCB3aXRoIHRoZSByb29tIElEIGFjcXVpcmVkLlxuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgICAgICByb29tSWQ6IG51bGwsXG4gICAgICAgICAgICAgICAgICAgIGluaXRpYWxFdmVudElkOiBudWxsLFxuICAgICAgICAgICAgICAgICAgICBpbml0aWFsRXZlbnRQaXhlbE9mZnNldDogbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgaXNJbml0aWFsRXZlbnRIaWdobGlnaHRlZDogbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgcm9vbUFsaWFzOiBwYXlsb2FkLnJvb21fYWxpYXMsXG4gICAgICAgICAgICAgICAgICAgIHJvb21Mb2FkaW5nOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICByb29tTG9hZEVycm9yOiBudWxsLFxuICAgICAgICAgICAgICAgICAgICB2aWFTZXJ2ZXJzOiBwYXlsb2FkLnZpYV9zZXJ2ZXJzLFxuICAgICAgICAgICAgICAgICAgICB3YXNDb250ZXh0U3dpdGNoOiBwYXlsb2FkLmNvbnRleHRfc3dpdGNoLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRSb29tSWRGb3JBbGlhcyhwYXlsb2FkLnJvb21fYWxpYXMpO1xuICAgICAgICAgICAgICAgICAgICBzdG9yZVJvb21BbGlhc0luQ2FjaGUocGF5bG9hZC5yb29tX2FsaWFzLCByZXN1bHQucm9vbV9pZCk7XG4gICAgICAgICAgICAgICAgICAgIHJvb21JZCA9IHJlc3VsdC5yb29tX2lkO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoXCJSVlMgZmFpbGVkIHRvIGdldCByb29tIGlkIGZvciBhbGlhczogXCIsIGVycik7XG4gICAgICAgICAgICAgICAgICAgIGRpcy5kaXNwYXRjaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb246ICd2aWV3X3Jvb21fZXJyb3InLFxuICAgICAgICAgICAgICAgICAgICAgICAgcm9vbV9pZDogbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvb21fYWxpYXM6IHBheWxvYWQucm9vbV9hbGlhcyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycixcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGRpcy5kaXNwYXRjaCh7XG4gICAgICAgICAgICAgICAgYWN0aW9uOiBBY3Rpb24uVmlld1Jvb20sXG4gICAgICAgICAgICAgICAgcm9vbV9pZDogcm9vbUlkLFxuICAgICAgICAgICAgICAgIGV2ZW50X2lkOiBwYXlsb2FkLmV2ZW50X2lkLFxuICAgICAgICAgICAgICAgIGhpZ2hsaWdodGVkOiBwYXlsb2FkLmhpZ2hsaWdodGVkLFxuICAgICAgICAgICAgICAgIHJvb21fYWxpYXM6IHBheWxvYWQucm9vbV9hbGlhcyxcbiAgICAgICAgICAgICAgICBhdXRvX2pvaW46IHBheWxvYWQuYXV0b19qb2luLFxuICAgICAgICAgICAgICAgIG9vYl9kYXRhOiBwYXlsb2FkLm9vYl9kYXRhLFxuICAgICAgICAgICAgICAgIHZpYVNlcnZlcnM6IHBheWxvYWQudmlhX3NlcnZlcnMsXG4gICAgICAgICAgICAgICAgd2FzQ29udGV4dFN3aXRjaDogcGF5bG9hZC5jb250ZXh0X3N3aXRjaCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB2aWV3Um9vbUVycm9yKHBheWxvYWQ6IEFjdGlvblBheWxvYWQpIHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICByb29tSWQ6IHBheWxvYWQucm9vbV9pZCxcbiAgICAgICAgICAgIHJvb21BbGlhczogcGF5bG9hZC5yb29tX2FsaWFzLFxuICAgICAgICAgICAgcm9vbUxvYWRpbmc6IGZhbHNlLFxuICAgICAgICAgICAgcm9vbUxvYWRFcnJvcjogcGF5bG9hZC5lcnIsXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgam9pblJvb20ocGF5bG9hZDogQWN0aW9uUGF5bG9hZCkge1xuICAgICAgICBjb25zdCBzdGFydFRpbWUgPSBDb3VudGx5QW5hbHl0aWNzLmdldFRpbWVzdGFtcCgpO1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIGpvaW5pbmc6IHRydWUsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICAgICAgY29uc3QgYWRkcmVzcyA9IHRoaXMuc3RhdGUucm9vbUFsaWFzIHx8IHRoaXMuc3RhdGUucm9vbUlkO1xuICAgICAgICBjb25zdCB2aWFTZXJ2ZXJzID0gdGhpcy5zdGF0ZS52aWFTZXJ2ZXJzIHx8IFtdO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgcmV0cnk8YW55LCBNYXRyaXhFcnJvcj4oKCkgPT4gY2xpLmpvaW5Sb29tKGFkZHJlc3MsIHtcbiAgICAgICAgICAgICAgICB2aWFTZXJ2ZXJzLFxuICAgICAgICAgICAgICAgIC4uLnBheWxvYWQub3B0cyxcbiAgICAgICAgICAgIH0pLCBOVU1fSk9JTl9SRVRSWSwgKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIC8vIGlmIHdlIHJlY2VpdmVkIGEgR2F0ZXdheSB0aW1lb3V0IHRoZW4gcmV0cnlcbiAgICAgICAgICAgICAgICByZXR1cm4gZXJyLmh0dHBTdGF0dXMgPT09IDUwNDtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgQ291bnRseUFuYWx5dGljcy5pbnN0YW5jZS50cmFja1Jvb21Kb2luKHN0YXJ0VGltZSwgdGhpcy5zdGF0ZS5yb29tSWQsIHBheWxvYWQuX3R5cGUpO1xuXG4gICAgICAgICAgICAvLyBXZSBkbyAqbm90KiBjbGVhciB0aGUgJ2pvaW5pbmcnIGZsYWcgYmVjYXVzZSB0aGUgUm9vbSBvYmplY3QgYW5kL29yIG91ciAnam9pbmVkJyBtZW1iZXIgZXZlbnQgbWF5IG5vdFxuICAgICAgICAgICAgLy8gaGF2ZSBjb21lIGRvd24gdGhlIHN5bmMgc3RyZWFtIHlldCwgYW5kIHRoYXQncyB0aGUgcG9pbnQgYXQgd2hpY2ggd2UnZCBjb25zaWRlciB0aGUgdXNlciBqb2luZWQgdG8gdGhlXG4gICAgICAgICAgICAvLyByb29tLlxuICAgICAgICAgICAgZGlzLmRpc3BhdGNoKHtcbiAgICAgICAgICAgICAgICBhY3Rpb246IEFjdGlvbi5Kb2luUm9vbVJlYWR5LFxuICAgICAgICAgICAgICAgIHJvb21JZDogdGhpcy5zdGF0ZS5yb29tSWQsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBkaXMuZGlzcGF0Y2goe1xuICAgICAgICAgICAgICAgIGFjdGlvbjogQWN0aW9uLkpvaW5Sb29tRXJyb3IsXG4gICAgICAgICAgICAgICAgcm9vbUlkOiB0aGlzLnN0YXRlLnJvb21JZCxcbiAgICAgICAgICAgICAgICBlcnI6IGVycixcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgZ2V0SW52aXRpbmdVc2VySWQocm9vbUlkOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICBjb25zdCBjbGkgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIGNvbnN0IHJvb20gPSBjbGkuZ2V0Um9vbShyb29tSWQpO1xuICAgICAgICBpZiAocm9vbSAmJiByb29tLmdldE15TWVtYmVyc2hpcCgpID09PSBcImludml0ZVwiKSB7XG4gICAgICAgICAgICBjb25zdCBteU1lbWJlciA9IHJvb20uZ2V0TWVtYmVyKGNsaS5nZXRVc2VySWQoKSk7XG4gICAgICAgICAgICBjb25zdCBpbnZpdGVFdmVudCA9IG15TWVtYmVyID8gbXlNZW1iZXIuZXZlbnRzLm1lbWJlciA6IG51bGw7XG4gICAgICAgICAgICByZXR1cm4gaW52aXRlRXZlbnQgJiYgaW52aXRlRXZlbnQuZ2V0U2VuZGVyKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc2hvd0pvaW5Sb29tRXJyb3IoZXJyOiBFcnJvciB8IE1hdHJpeEVycm9yLCByb29tSWQ6IHN0cmluZykge1xuICAgICAgICBsZXQgbXNnID0gZXJyLm1lc3NhZ2UgPyBlcnIubWVzc2FnZSA6IEpTT04uc3RyaW5naWZ5KGVycik7XG4gICAgICAgIGxvZ2dlci5sb2coXCJGYWlsZWQgdG8gam9pbiByb29tOlwiLCBtc2cpO1xuXG4gICAgICAgIGlmIChlcnIubmFtZSA9PT0gXCJDb25uZWN0aW9uRXJyb3JcIikge1xuICAgICAgICAgICAgbXNnID0gX3QoXCJUaGVyZSB3YXMgYW4gZXJyb3Igam9pbmluZyB0aGUgcm9vbVwiKTtcbiAgICAgICAgfSBlbHNlIGlmIChlcnIuZXJyY29kZSA9PT0gJ01fSU5DT01QQVRJQkxFX1JPT01fVkVSU0lPTicpIHtcbiAgICAgICAgICAgIG1zZyA9IDxkaXY+XG4gICAgICAgICAgICAgICAgeyBfdChcIlNvcnJ5LCB5b3VyIGhvbWVzZXJ2ZXIgaXMgdG9vIG9sZCB0byBwYXJ0aWNpcGF0ZSBpbiB0aGlzIHJvb20uXCIpIH08YnIgLz5cbiAgICAgICAgICAgICAgICB7IF90KFwiUGxlYXNlIGNvbnRhY3QgeW91ciBob21lc2VydmVyIGFkbWluaXN0cmF0b3IuXCIpIH1cbiAgICAgICAgICAgIDwvZGl2PjtcbiAgICAgICAgfSBlbHNlIGlmIChlcnIuaHR0cFN0YXR1cyA9PT0gNDA0KSB7XG4gICAgICAgICAgICBjb25zdCBpbnZpdGluZ1VzZXJJZCA9IFJvb21WaWV3U3RvcmUuZ2V0SW52aXRpbmdVc2VySWQocm9vbUlkKTtcbiAgICAgICAgICAgIC8vIG9ubHkgcHJvdmlkZSBhIGJldHRlciBlcnJvciBtZXNzYWdlIGZvciBpbnZpdGVzXG4gICAgICAgICAgICBpZiAoaW52aXRpbmdVc2VySWQpIHtcbiAgICAgICAgICAgICAgICAvLyBpZiB0aGUgaW52aXRpbmcgdXNlciBpcyBvbiB0aGUgc2FtZSBIUywgdGhlcmUgY2FuIG9ubHkgYmUgb25lIGNhdXNlOiB0aGV5IGxlZnQuXG4gICAgICAgICAgICAgICAgaWYgKGludml0aW5nVXNlcklkLmVuZHNXaXRoKGA6JHtNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZ2V0RG9tYWluKCl9YCkpIHtcbiAgICAgICAgICAgICAgICAgICAgbXNnID0gX3QoXCJUaGUgcGVyc29uIHdobyBpbnZpdGVkIHlvdSBhbHJlYWR5IGxlZnQgdGhlIHJvb20uXCIpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG1zZyA9IF90KFwiVGhlIHBlcnNvbiB3aG8gaW52aXRlZCB5b3UgYWxyZWFkeSBsZWZ0IHRoZSByb29tLCBvciB0aGVpciBzZXJ2ZXIgaXMgb2ZmbGluZS5cIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gRklYTUU6IFVzaW5nIGFuIGltcG9ydCB3aWxsIHJlc3VsdCBpbiB0ZXN0IGZhaWx1cmVzXG4gICAgICAgIGNvbnN0IEVycm9yRGlhbG9nID0gc2RrLmdldENvbXBvbmVudChcImRpYWxvZ3MuRXJyb3JEaWFsb2dcIik7XG4gICAgICAgIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coJ0ZhaWxlZCB0byBqb2luIHJvb20nLCAnJywgRXJyb3JEaWFsb2csIHtcbiAgICAgICAgICAgIHRpdGxlOiBfdChcIkZhaWxlZCB0byBqb2luIHJvb21cIiksXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogbXNnLFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGpvaW5Sb29tRXJyb3IocGF5bG9hZDogQWN0aW9uUGF5bG9hZCkge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIGpvaW5pbmc6IGZhbHNlLFxuICAgICAgICAgICAgam9pbkVycm9yOiBwYXlsb2FkLmVycixcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuc2hvd0pvaW5Sb29tRXJyb3IocGF5bG9hZC5lcnIsIHRoaXMuc3RhdGUucm9vbUlkKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVzZXQoKSB7XG4gICAgICAgIHRoaXMuc3RhdGUgPSBPYmplY3QuYXNzaWduKHt9LCBJTklUSUFMX1NUQVRFKTtcbiAgICB9XG5cbiAgICAvLyBUaGUgcm9vbSBJRCBvZiB0aGUgcm9vbSBjdXJyZW50bHkgYmVpbmcgdmlld2VkXG4gICAgcHVibGljIGdldFJvb21JZCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGUucm9vbUlkO1xuICAgIH1cblxuICAgIC8vIFRoZSBldmVudCB0byBzY3JvbGwgdG8gd2hlbiB0aGUgcm9vbSBpcyBmaXJzdCB2aWV3ZWRcbiAgICBwdWJsaWMgZ2V0SW5pdGlhbEV2ZW50SWQoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlLmluaXRpYWxFdmVudElkO1xuICAgIH1cblxuICAgIC8vIFdoZXRoZXIgdG8gaGlnaGxpZ2h0IHRoZSBpbml0aWFsIGV2ZW50XG4gICAgcHVibGljIGlzSW5pdGlhbEV2ZW50SGlnaGxpZ2h0ZWQoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlLmlzSW5pdGlhbEV2ZW50SGlnaGxpZ2h0ZWQ7XG4gICAgfVxuXG4gICAgLy8gVGhlIHJvb20gYWxpYXMgb2YgdGhlIHJvb20gKG9yIG51bGwgaWYgbm90IG9yaWdpbmFsbHkgc3BlY2lmaWVkIGluIHZpZXdfcm9vbSlcbiAgICBwdWJsaWMgZ2V0Um9vbUFsaWFzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZS5yb29tQWxpYXM7XG4gICAgfVxuXG4gICAgLy8gV2hldGhlciB0aGUgY3VycmVudCByb29tIGlzIGxvYWRpbmcgKHRydWUgd2hpbHN0IHJlc29sdmluZyBhbiBhbGlhcylcbiAgICBwdWJsaWMgaXNSb29tTG9hZGluZygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGUucm9vbUxvYWRpbmc7XG4gICAgfVxuXG4gICAgLy8gQW55IGVycm9yIHRoYXQgaGFzIG9jY3VycmVkIGR1cmluZyBsb2FkaW5nXG4gICAgcHVibGljIGdldFJvb21Mb2FkRXJyb3IoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlLnJvb21Mb2FkRXJyb3I7XG4gICAgfVxuXG4gICAgLy8gVHJ1ZSBpZiB3ZSdyZSBleHBlY3RpbmcgdGhlIHVzZXIgdG8gYmUgam9pbmVkIHRvIHRoZSByb29tIGN1cnJlbnRseSBiZWluZ1xuICAgIC8vIHZpZXdlZC4gTm90ZSB0aGF0IHRoaXMgaXMgbGVmdCB0cnVlIGFmdGVyIHRoZSBqb2luIHJlcXVlc3QgaGFzIGZpbmlzaGVkLFxuICAgIC8vIHNpbmNlIHdlIHNob3VsZCBzdGlsbCBjb25zaWRlciBhIGpvaW4gdG8gYmUgaW4gcHJvZ3Jlc3MgdW50aWwgdGhlIHJvb21cbiAgICAvLyAmIG1lbWJlciBldmVudHMgY29tZSBkb3duIHRoZSBzeW5jLlxuICAgIC8vXG4gICAgLy8gVGhpcyBmbGFnIHJlbWFpbnMgdHJ1ZSBhZnRlciB0aGUgcm9vbSBoYXMgYmVlbiBzdWNlc3NmdWxseSBqb2luZWQsXG4gICAgLy8gKHRoaXMgc3RvcmUgZG9lc24ndCBsaXN0ZW4gZm9yIHRoZSBhcHByb3ByaWF0ZSBtZW1iZXIgZXZlbnRzKVxuICAgIC8vIHNvIHlvdSBzaG91bGQgYWx3YXlzIG9ic2VydmUgdGhlIGpvaW5lZCBzdGF0ZSBmcm9tIHRoZSBtZW1iZXIgZXZlbnRcbiAgICAvLyBpZiBhIHJvb20gb2JqZWN0IGlzIHByZXNlbnQuXG4gICAgLy8gaWUuIFRoZSBjb3JyZWN0IGxvZ2ljIGlzOlxuICAgIC8vIGlmIChyb29tKSB7XG4gICAgLy8gICAgIGlmIChteU1lbWJlci5tZW1iZXJzaGlwID09ICdqb2luZWQnKSB7XG4gICAgLy8gICAgICAgICAvLyB1c2VyIGlzIGpvaW5lZCB0byB0aGUgcm9vbVxuICAgIC8vICAgICB9IGVsc2Uge1xuICAgIC8vICAgICAgICAgLy8gTm90IGpvaW5lZFxuICAgIC8vICAgICB9XG4gICAgLy8gfSBlbHNlIHtcbiAgICAvLyAgICAgaWYgKFJvb21WaWV3U3RvcmUuaXNKb2luaW5nKCkpIHtcbiAgICAvLyAgICAgICAgIC8vIHNob3cgc3Bpbm5lclxuICAgIC8vICAgICB9IGVsc2Uge1xuICAgIC8vICAgICAgICAgLy8gc2hvdyBqb2luIHByb21wdFxuICAgIC8vICAgICB9XG4gICAgLy8gfVxuICAgIHB1YmxpYyBpc0pvaW5pbmcoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlLmpvaW5pbmc7XG4gICAgfVxuXG4gICAgLy8gQW55IGVycm9yIHRoYXQgaGFzIG9jY3VycmVkIGR1cmluZyBqb2luaW5nXG4gICAgcHVibGljIGdldEpvaW5FcnJvcigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGUuam9pbkVycm9yO1xuICAgIH1cblxuICAgIC8vIFRoZSBteEV2ZW50IGlmIG9uZSBpcyBjdXJyZW50bHkgYmVpbmcgcmVwbGllZCB0by9xdW90ZWRcbiAgICBwdWJsaWMgZ2V0UXVvdGluZ0V2ZW50KCkge1xuICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZS5yZXBseWluZ1RvRXZlbnQ7XG4gICAgfVxuXG4gICAgcHVibGljIHNob3VsZFBlZWsoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlLnNob3VsZFBlZWs7XG4gICAgfVxuXG4gICAgcHVibGljIGdldFdhc0NvbnRleHRTd2l0Y2goKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlLndhc0NvbnRleHRTd2l0Y2g7XG4gICAgfVxufVxuXG5sZXQgc2luZ2xldG9uUm9vbVZpZXdTdG9yZTogUm9vbVZpZXdTdG9yZSA9IG51bGw7XG5pZiAoIXNpbmdsZXRvblJvb21WaWV3U3RvcmUpIHtcbiAgICBzaW5nbGV0b25Sb29tVmlld1N0b3JlID0gbmV3IFJvb21WaWV3U3RvcmUoKTtcbn1cbmV4cG9ydCBkZWZhdWx0IHNpbmdsZXRvblJvb21WaWV3U3RvcmU7XG4iXX0=