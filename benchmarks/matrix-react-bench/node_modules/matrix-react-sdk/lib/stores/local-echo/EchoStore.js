"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.EchoStore = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _RoomEchoChamber = require("./RoomEchoChamber");

var _RoomEchoContext = require("./RoomEchoContext");

var _AsyncStoreWithClient = require("../AsyncStoreWithClient");

var _dispatcher = _interopRequireDefault(require("../../dispatcher/dispatcher"));

var _EchoContext = require("./EchoContext");

var _NonUrgentToastStore = _interopRequireDefault(require("../NonUrgentToastStore"));

var _NonUrgentEchoFailureToast = _interopRequireDefault(require("../../components/views/toasts/NonUrgentEchoFailureToast"));

/*
Copyright 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const roomContextKey = room => `room-${room.roomId}`;

class EchoStore extends _AsyncStoreWithClient.AsyncStoreWithClient {
  constructor() {
    super(_dispatcher.default);
    (0, _defineProperty2.default)(this, "caches", new Map());
  }

  static get instance() {
    if (!EchoStore._instance) {
      EchoStore._instance = new EchoStore();
    }

    return EchoStore._instance;
  }

  get contexts() {
    return Array.from(this.caches.values()).map(e => e.context);
  }

  getOrCreateChamberForRoom(room) {
    if (this.caches.has(roomContextKey(room))) {
      return this.caches.get(roomContextKey(room));
    }

    const context = new _RoomEchoContext.RoomEchoContext(room);
    context.whenAnything(() => this.checkContexts());
    const echo = new _RoomEchoChamber.RoomEchoChamber(context);
    echo.setClient(this.matrixClient);
    this.caches.set(roomContextKey(room), echo);
    return echo;
  }

  async checkContexts() {
    let hasOrHadError = false;

    for (const echo of this.caches.values()) {
      hasOrHadError = echo.context.state === _EchoContext.ContextTransactionState.PendingErrors;
      if (hasOrHadError) break;
    }

    if (hasOrHadError && !this.state.toastRef) {
      const ref = _NonUrgentToastStore.default.instance.addToast(_NonUrgentEchoFailureToast.default);

      await this.updateState({
        toastRef: ref
      });
    } else if (!hasOrHadError && this.state.toastRef) {
      _NonUrgentToastStore.default.instance.removeToast(this.state.toastRef);

      await this.updateState({
        toastRef: null
      });
    }
  }

  async onReady() {
    if (!this.caches) return; // can only happen during initialization

    for (const echo of this.caches.values()) {
      echo.setClient(this.matrixClient);
    }
  }

  async onNotReady() {
    for (const echo of this.caches.values()) {
      echo.setClient(null);
    }
  }

  async onAction(payload) {
    // We have nothing to actually listen for
    return Promise.resolve();
  }

}

exports.EchoStore = EchoStore;
(0, _defineProperty2.default)(EchoStore, "_instance", void 0);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zdG9yZXMvbG9jYWwtZWNoby9FY2hvU3RvcmUudHMiXSwibmFtZXMiOlsicm9vbUNvbnRleHRLZXkiLCJyb29tIiwicm9vbUlkIiwiRWNob1N0b3JlIiwiQXN5bmNTdG9yZVdpdGhDbGllbnQiLCJjb25zdHJ1Y3RvciIsImRlZmF1bHREaXNwYXRjaGVyIiwiTWFwIiwiaW5zdGFuY2UiLCJfaW5zdGFuY2UiLCJjb250ZXh0cyIsIkFycmF5IiwiZnJvbSIsImNhY2hlcyIsInZhbHVlcyIsIm1hcCIsImUiLCJjb250ZXh0IiwiZ2V0T3JDcmVhdGVDaGFtYmVyRm9yUm9vbSIsImhhcyIsImdldCIsIlJvb21FY2hvQ29udGV4dCIsIndoZW5Bbnl0aGluZyIsImNoZWNrQ29udGV4dHMiLCJlY2hvIiwiUm9vbUVjaG9DaGFtYmVyIiwic2V0Q2xpZW50IiwibWF0cml4Q2xpZW50Iiwic2V0IiwiaGFzT3JIYWRFcnJvciIsInN0YXRlIiwiQ29udGV4dFRyYW5zYWN0aW9uU3RhdGUiLCJQZW5kaW5nRXJyb3JzIiwidG9hc3RSZWYiLCJyZWYiLCJOb25VcmdlbnRUb2FzdFN0b3JlIiwiYWRkVG9hc3QiLCJOb25VcmdlbnRFY2hvRmFpbHVyZVRvYXN0IiwidXBkYXRlU3RhdGUiLCJyZW1vdmVUb2FzdCIsIm9uUmVhZHkiLCJvbk5vdFJlYWR5Iiwib25BY3Rpb24iLCJwYXlsb2FkIiwiUHJvbWlzZSIsInJlc29sdmUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBa0JBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQXpCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFtQkEsTUFBTUEsY0FBYyxHQUFJQyxJQUFELElBQTZCLFFBQU9BLElBQUksQ0FBQ0MsTUFBTyxFQUF2RTs7QUFFTyxNQUFNQyxTQUFOLFNBQXdCQywwQ0FBeEIsQ0FBcUQ7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UmdCLFFBQVEsQ0FBQ0MsT0FBRCxFQUF1QztBQUMzRDtBQUNBLFdBQU9DLE9BQU8sQ0FBQ0MsT0FBUixFQUFQO0FBQ0g7O0FBbkV1RDs7OzhCQUEvQzFDLFMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMjAgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCB7IEdlbmVyaWNFY2hvQ2hhbWJlciB9IGZyb20gXCIuL0dlbmVyaWNFY2hvQ2hhbWJlclwiO1xuaW1wb3J0IHsgUm9vbSB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvcm9vbVwiO1xuaW1wb3J0IHsgUm9vbUVjaG9DaGFtYmVyIH0gZnJvbSBcIi4vUm9vbUVjaG9DaGFtYmVyXCI7XG5pbXBvcnQgeyBSb29tRWNob0NvbnRleHQgfSBmcm9tIFwiLi9Sb29tRWNob0NvbnRleHRcIjtcbmltcG9ydCB7IEFzeW5jU3RvcmVXaXRoQ2xpZW50IH0gZnJvbSBcIi4uL0FzeW5jU3RvcmVXaXRoQ2xpZW50XCI7XG5pbXBvcnQgZGVmYXVsdERpc3BhdGNoZXIgZnJvbSBcIi4uLy4uL2Rpc3BhdGNoZXIvZGlzcGF0Y2hlclwiO1xuaW1wb3J0IHsgQWN0aW9uUGF5bG9hZCB9IGZyb20gXCIuLi8uLi9kaXNwYXRjaGVyL3BheWxvYWRzXCI7XG5pbXBvcnQgeyBDb250ZXh0VHJhbnNhY3Rpb25TdGF0ZSwgRWNob0NvbnRleHQgfSBmcm9tIFwiLi9FY2hvQ29udGV4dFwiO1xuaW1wb3J0IE5vblVyZ2VudFRvYXN0U3RvcmUsIHsgVG9hc3RSZWZlcmVuY2UgfSBmcm9tIFwiLi4vTm9uVXJnZW50VG9hc3RTdG9yZVwiO1xuaW1wb3J0IE5vblVyZ2VudEVjaG9GYWlsdXJlVG9hc3QgZnJvbSBcIi4uLy4uL2NvbXBvbmVudHMvdmlld3MvdG9hc3RzL05vblVyZ2VudEVjaG9GYWlsdXJlVG9hc3RcIjtcblxuaW50ZXJmYWNlIElTdGF0ZSB7XG4gICAgdG9hc3RSZWY6IFRvYXN0UmVmZXJlbmNlO1xufVxuXG50eXBlIENvbnRleHRLZXkgPSBzdHJpbmc7XG5cbmNvbnN0IHJvb21Db250ZXh0S2V5ID0gKHJvb206IFJvb20pOiBDb250ZXh0S2V5ID0+IGByb29tLSR7cm9vbS5yb29tSWR9YDtcblxuZXhwb3J0IGNsYXNzIEVjaG9TdG9yZSBleHRlbmRzIEFzeW5jU3RvcmVXaXRoQ2xpZW50PElTdGF0ZT4ge1xuICAgIHByaXZhdGUgc3RhdGljIF9pbnN0YW5jZTogRWNob1N0b3JlO1xuXG4gICAgcHJpdmF0ZSBjYWNoZXMgPSBuZXcgTWFwPENvbnRleHRLZXksIEdlbmVyaWNFY2hvQ2hhbWJlcjxhbnksIGFueSwgYW55Pj4oKTtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcihkZWZhdWx0RGlzcGF0Y2hlcik7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBnZXQgaW5zdGFuY2UoKTogRWNob1N0b3JlIHtcbiAgICAgICAgaWYgKCFFY2hvU3RvcmUuX2luc3RhbmNlKSB7XG4gICAgICAgICAgICBFY2hvU3RvcmUuX2luc3RhbmNlID0gbmV3IEVjaG9TdG9yZSgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBFY2hvU3RvcmUuX2luc3RhbmNlO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgY29udGV4dHMoKTogRWNob0NvbnRleHRbXSB7XG4gICAgICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMuY2FjaGVzLnZhbHVlcygpKS5tYXAoZSA9PiBlLmNvbnRleHQpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRPckNyZWF0ZUNoYW1iZXJGb3JSb29tKHJvb206IFJvb20pOiBSb29tRWNob0NoYW1iZXIge1xuICAgICAgICBpZiAodGhpcy5jYWNoZXMuaGFzKHJvb21Db250ZXh0S2V5KHJvb20pKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2FjaGVzLmdldChyb29tQ29udGV4dEtleShyb29tKSkgYXMgUm9vbUVjaG9DaGFtYmVyO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY29udGV4dCA9IG5ldyBSb29tRWNob0NvbnRleHQocm9vbSk7XG4gICAgICAgIGNvbnRleHQud2hlbkFueXRoaW5nKCgpID0+IHRoaXMuY2hlY2tDb250ZXh0cygpKTtcblxuICAgICAgICBjb25zdCBlY2hvID0gbmV3IFJvb21FY2hvQ2hhbWJlcihjb250ZXh0KTtcbiAgICAgICAgZWNoby5zZXRDbGllbnQodGhpcy5tYXRyaXhDbGllbnQpO1xuICAgICAgICB0aGlzLmNhY2hlcy5zZXQocm9vbUNvbnRleHRLZXkocm9vbSksIGVjaG8pO1xuXG4gICAgICAgIHJldHVybiBlY2hvO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgY2hlY2tDb250ZXh0cygpIHtcbiAgICAgICAgbGV0IGhhc09ySGFkRXJyb3IgPSBmYWxzZTtcbiAgICAgICAgZm9yIChjb25zdCBlY2hvIG9mIHRoaXMuY2FjaGVzLnZhbHVlcygpKSB7XG4gICAgICAgICAgICBoYXNPckhhZEVycm9yID0gZWNoby5jb250ZXh0LnN0YXRlID09PSBDb250ZXh0VHJhbnNhY3Rpb25TdGF0ZS5QZW5kaW5nRXJyb3JzO1xuICAgICAgICAgICAgaWYgKGhhc09ySGFkRXJyb3IpIGJyZWFrO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGhhc09ySGFkRXJyb3IgJiYgIXRoaXMuc3RhdGUudG9hc3RSZWYpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlZiA9IE5vblVyZ2VudFRvYXN0U3RvcmUuaW5zdGFuY2UuYWRkVG9hc3QoTm9uVXJnZW50RWNob0ZhaWx1cmVUb2FzdCk7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZVN0YXRlKHsgdG9hc3RSZWY6IHJlZiB9KTtcbiAgICAgICAgfSBlbHNlIGlmICghaGFzT3JIYWRFcnJvciAmJiB0aGlzLnN0YXRlLnRvYXN0UmVmKSB7XG4gICAgICAgICAgICBOb25VcmdlbnRUb2FzdFN0b3JlLmluc3RhbmNlLnJlbW92ZVRvYXN0KHRoaXMuc3RhdGUudG9hc3RSZWYpO1xuICAgICAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVTdGF0ZSh7IHRvYXN0UmVmOiBudWxsIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGFzeW5jIG9uUmVhZHkoKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgaWYgKCF0aGlzLmNhY2hlcykgcmV0dXJuOyAvLyBjYW4gb25seSBoYXBwZW4gZHVyaW5nIGluaXRpYWxpemF0aW9uXG4gICAgICAgIGZvciAoY29uc3QgZWNobyBvZiB0aGlzLmNhY2hlcy52YWx1ZXMoKSkge1xuICAgICAgICAgICAgZWNoby5zZXRDbGllbnQodGhpcy5tYXRyaXhDbGllbnQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGFzeW5jIG9uTm90UmVhZHkoKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgZm9yIChjb25zdCBlY2hvIG9mIHRoaXMuY2FjaGVzLnZhbHVlcygpKSB7XG4gICAgICAgICAgICBlY2hvLnNldENsaWVudChudWxsKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBhc3luYyBvbkFjdGlvbihwYXlsb2FkOiBBY3Rpb25QYXlsb2FkKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgLy8gV2UgaGF2ZSBub3RoaW5nIHRvIGFjdHVhbGx5IGxpc3RlbiBmb3JcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgIH1cbn1cbiJdfQ==