"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.WidgetLayoutStore = exports.WIDGET_LAYOUT_EVENT_TYPE = exports.MAX_PINNED = exports.Container = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _SettingsStore = _interopRequireDefault(require("../../settings/SettingsStore"));

var _WidgetStore = _interopRequireDefault(require("../WidgetStore"));

var _WidgetType = require("../../widgets/WidgetType");

var _numbers = require("../../utils/numbers");

var _dispatcher = _interopRequireDefault(require("../../dispatcher/dispatcher"));

var _ReadyWatchingStore = require("../ReadyWatchingStore");

var _SettingLevel = require("../../settings/SettingLevel");

var _arrays = require("../../utils/arrays");

var _AsyncStore = require("../AsyncStore");

var _strings = require("../../utils/strings");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

const WIDGET_LAYOUT_EVENT_TYPE = "io.element.widgets.layout";
exports.WIDGET_LAYOUT_EVENT_TYPE = WIDGET_LAYOUT_EVENT_TYPE;
let Container;
exports.Container = Container;

(function (Container) {
  Container["Top"] = "top";
  Container["Right"] = "right";
  Container["Center"] = "center";
})(Container || (exports.Container = Container = {}));

// Dev note: "Pinned" widgets are ones in the top container.
const MAX_PINNED = 3; // These two are whole percentages and don't really mean anything. Later values will decide
// minimum, but these help determine proportions during our calculations here. In fact, these
// values should be *smaller* than the actual minimums imposed by later components.

exports.MAX_PINNED = MAX_PINNED;
const MIN_WIDGET_WIDTH_PCT = 10; // 10%

const MIN_WIDGET_HEIGHT_PCT = 2; // 2%

class WidgetLayoutStore extends _ReadyWatchingStore.ReadyWatchingStore {
  constructor() {
    super(_dispatcher.default);
    (0, _defineProperty2.default)(this, "byRoom", {});
    (0, _defineProperty2.default)(this, "pinnedRef", void 0);
    (0, _defineProperty2.default)(this, "layoutRef", void 0);
    (0, _defineProperty2.default)(this, "updateAllRooms", () => {
      this.byRoom = {};

      for (const room of this.matrixClient.getVisibleRooms()) {
        this.recalculateRoom(room);
      }
    });
    (0, _defineProperty2.default)(this, "updateFromWidgetStore", roomId => {
      if (roomId) {
        const room = this.matrixClient.getRoom(roomId);
        if (room) this.recalculateRoom(room);
      } else {
        this.updateAllRooms();
      }
    });
    (0, _defineProperty2.default)(this, "updateRoomFromState", ev => {
      if (ev.getType() !== WIDGET_LAYOUT_EVENT_TYPE) return;
      const room = this.matrixClient.getRoom(ev.getRoomId());
      if (room) this.recalculateRoom(room);
    });
    (0, _defineProperty2.default)(this, "updateFromSettings", (settingName, roomId) => {
      if (roomId) {
        const room = this.matrixClient.getRoom(roomId);
        if (room) this.recalculateRoom(room);
      } else {
        this.updateAllRooms();
      }
    });
  }

  static get instance() {
    if (!WidgetLayoutStore.internalInstance) {
      WidgetLayoutStore.internalInstance = new WidgetLayoutStore();
    }

    return WidgetLayoutStore.internalInstance;
  }

  static emissionForRoom(room) {
    return `update_${room.roomId}`;
  }

  emitFor(room) {
    this.emit(WidgetLayoutStore.emissionForRoom(room));
  }

  async onReady() {
    this.updateAllRooms();
    this.matrixClient.on("RoomState.events", this.updateRoomFromState);
    this.pinnedRef = _SettingsStore.default.watchSetting("Widgets.pinned", null, this.updateFromSettings);
    this.layoutRef = _SettingsStore.default.watchSetting("Widgets.layout", null, this.updateFromSettings);

    _WidgetStore.default.instance.on(_AsyncStore.UPDATE_EVENT, this.updateFromWidgetStore);
  }

  async onNotReady() {
    this.byRoom = {};

    _SettingsStore.default.unwatchSetting(this.pinnedRef);

    _SettingsStore.default.unwatchSetting(this.layoutRef);

    _WidgetStore.default.instance.off(_AsyncStore.UPDATE_EVENT, this.updateFromWidgetStore);
  }

  recalculateRoom(room) {
    const widgets = _WidgetStore.default.instance.getApps(room.roomId);

    if (!(widgets !== null && widgets !== void 0 && widgets.length)) {
      this.byRoom[room.roomId] = {};
      this.emitFor(room);
      return;
    }

    const beforeChanges = JSON.stringify(this.byRoom[room.roomId]);
    const layoutEv = room.currentState.getStateEvents(WIDGET_LAYOUT_EVENT_TYPE, "");

    const legacyPinned = _SettingsStore.default.getValue("Widgets.pinned", room.roomId);

    let userLayout = _SettingsStore.default.getValue("Widgets.layout", room.roomId);

    if (layoutEv && userLayout && userLayout.overrides !== layoutEv.getId()) {
      // For some other layout that we don't really care about. The user can reset this
      // by updating their personal layout.
      userLayout = null;
    }

    const roomLayout = layoutEv ? layoutEv.getContent() : null; // We filter for the center container first.
    // (An error is raised, if there are multiple widgets marked for the center container)
    // For the right and top container multiple widgets are allowed.

    const topWidgets = [];
    const rightWidgets = [];
    const centerWidgets = [];

    for (const widget of widgets) {
      var _roomLayout$widgets, _roomLayout$widgets$w, _userLayout, _userLayout$widgets, _userLayout$widgets$w;

      const stateContainer = roomLayout === null || roomLayout === void 0 ? void 0 : (_roomLayout$widgets = roomLayout.widgets) === null || _roomLayout$widgets === void 0 ? void 0 : (_roomLayout$widgets$w = _roomLayout$widgets[widget.id]) === null || _roomLayout$widgets$w === void 0 ? void 0 : _roomLayout$widgets$w.container;
      const manualContainer = (_userLayout = userLayout) === null || _userLayout === void 0 ? void 0 : (_userLayout$widgets = _userLayout.widgets) === null || _userLayout$widgets === void 0 ? void 0 : (_userLayout$widgets$w = _userLayout$widgets[widget.id]) === null || _userLayout$widgets$w === void 0 ? void 0 : _userLayout$widgets$w.container;
      const isLegacyPinned = !!(legacyPinned !== null && legacyPinned !== void 0 && legacyPinned[widget.id]);
      const defaultContainer = _WidgetType.WidgetType.JITSI.matches(widget.type) ? Container.Top : Container.Right;

      if (manualContainer ? manualContainer === Container.Center : stateContainer === Container.Center) {
        if (centerWidgets.length) {
          console.error("Tried to push a second widget into the center container");
        } else {
          centerWidgets.push(widget);
        } // The widget won't need to be put in any other container.


        continue;
      }

      let targetContainer = defaultContainer;

      if (!!manualContainer || !!stateContainer) {
        targetContainer = manualContainer ? manualContainer : stateContainer;
      } else if (isLegacyPinned && !stateContainer) {
        // Special legacy case
        targetContainer = Container.Top;
      }

      (targetContainer === Container.Top ? topWidgets : rightWidgets).push(widget);
    } // Trim to MAX_PINNED


    const runoff = topWidgets.slice(MAX_PINNED);
    rightWidgets.push(...runoff); // Order the widgets in the top container, putting autopinned Jitsi widgets first
    // unless they have a specific order in mind

    topWidgets.sort((a, b) => {
      var _roomLayout$widgets2, _roomLayout$widgets3, _userLayout2, _userLayout2$widgets, _userLayout3, _userLayout3$widgets;

      const layoutA = roomLayout === null || roomLayout === void 0 ? void 0 : (_roomLayout$widgets2 = roomLayout.widgets) === null || _roomLayout$widgets2 === void 0 ? void 0 : _roomLayout$widgets2[a.id];
      const layoutB = roomLayout === null || roomLayout === void 0 ? void 0 : (_roomLayout$widgets3 = roomLayout.widgets) === null || _roomLayout$widgets3 === void 0 ? void 0 : _roomLayout$widgets3[b.id];
      const userLayoutA = (_userLayout2 = userLayout) === null || _userLayout2 === void 0 ? void 0 : (_userLayout2$widgets = _userLayout2.widgets) === null || _userLayout2$widgets === void 0 ? void 0 : _userLayout2$widgets[a.id];
      const userLayoutB = (_userLayout3 = userLayout) === null || _userLayout3 === void 0 ? void 0 : (_userLayout3$widgets = _userLayout3.widgets) === null || _userLayout3$widgets === void 0 ? void 0 : _userLayout3$widgets[b.id]; // Jitsi widgets are defaulted to be the leftmost widget whereas other widgets
      // default to the right side.

      const defaultA = _WidgetType.WidgetType.JITSI.matches(a.type) ? Number.MIN_SAFE_INTEGER : Number.MAX_SAFE_INTEGER;
      const defaultB = _WidgetType.WidgetType.JITSI.matches(b.type) ? Number.MIN_SAFE_INTEGER : Number.MAX_SAFE_INTEGER;
      const orderA = (0, _numbers.defaultNumber)(userLayoutA === null || userLayoutA === void 0 ? void 0 : userLayoutA.index, (0, _numbers.defaultNumber)(layoutA === null || layoutA === void 0 ? void 0 : layoutA.index, defaultA));
      const orderB = (0, _numbers.defaultNumber)(userLayoutB === null || userLayoutB === void 0 ? void 0 : userLayoutB.index, (0, _numbers.defaultNumber)(layoutB === null || layoutB === void 0 ? void 0 : layoutB.index, defaultB));

      if (orderA === orderB) {
        // We just need a tiebreak
        return (0, _strings.compare)(a.id, b.id);
      }

      return orderA - orderB;
    }); // Determine width distribution and height of the top container now (the only relevant one)

    const widths = [];
    let maxHeight = null; // null == default

    let doAutobalance = true;

    for (let i = 0; i < topWidgets.length; i++) {
      var _roomLayout$widgets4, _userLayout4, _userLayout4$widgets;

      const widget = topWidgets[i];
      const widgetLayout = roomLayout === null || roomLayout === void 0 ? void 0 : (_roomLayout$widgets4 = roomLayout.widgets) === null || _roomLayout$widgets4 === void 0 ? void 0 : _roomLayout$widgets4[widget.id];
      const userWidgetLayout = (_userLayout4 = userLayout) === null || _userLayout4 === void 0 ? void 0 : (_userLayout4$widgets = _userLayout4.widgets) === null || _userLayout4$widgets === void 0 ? void 0 : _userLayout4$widgets[widget.id];

      if (Number.isFinite(userWidgetLayout === null || userWidgetLayout === void 0 ? void 0 : userWidgetLayout.width) || Number.isFinite(widgetLayout === null || widgetLayout === void 0 ? void 0 : widgetLayout.width)) {
        const val = (userWidgetLayout === null || userWidgetLayout === void 0 ? void 0 : userWidgetLayout.width) || (widgetLayout === null || widgetLayout === void 0 ? void 0 : widgetLayout.width);
        const normalized = (0, _numbers.clamp)(val, MIN_WIDGET_WIDTH_PCT, 100);
        widths.push(normalized);
        doAutobalance = false; // a manual width was specified
      } else {
        widths.push(100); // we'll figure this out later
      }

      if (widgetLayout !== null && widgetLayout !== void 0 && widgetLayout.height || userWidgetLayout !== null && userWidgetLayout !== void 0 && userWidgetLayout.height) {
        const defRoomHeight = (0, _numbers.defaultNumber)(widgetLayout === null || widgetLayout === void 0 ? void 0 : widgetLayout.height, MIN_WIDGET_HEIGHT_PCT);
        const h = (0, _numbers.defaultNumber)(userWidgetLayout === null || userWidgetLayout === void 0 ? void 0 : userWidgetLayout.height, defRoomHeight);
        maxHeight = Math.max(maxHeight, (0, _numbers.clamp)(h, MIN_WIDGET_HEIGHT_PCT, 100));
      }
    }

    if (doAutobalance) {
      for (let i = 0; i < widths.length; i++) {
        widths[i] = 100 / widths.length;
      }
    } else {
      // If we're not autobalancing then it means that we're trying to make
      // sure that widgets make up exactly 100% of space (not over, not under)
      const difference = (0, _numbers.sum)(...widths) - 100; // positive = over, negative = under

      if (difference < 0) {
        // For a deficit we just fill everything in equally
        for (let i = 0; i < widths.length; i++) {
          widths[i] += Math.abs(difference) / widths.length;
        }
      } else if (difference > 0) {
        // When we're over, we try to scale all the widgets within range first.
        // We clamp values to try and keep ourselves sane and within range.
        for (let i = 0; i < widths.length; i++) {
          widths[i] = (0, _numbers.clamp)(widths[i] - difference / widths.length, MIN_WIDGET_WIDTH_PCT, 100);
        } // If we're still over, find the widgets which have more width than the minimum
        // and balance them out until we're at 100%. This should keep us as close as possible
        // to the intended distributions.
        //
        // Note: if we ever decide to set a minimum which is larger than 100%/MAX_WIDGETS then
        // we probably have other issues - this code assumes we don't do that.


        const toReclaim = (0, _numbers.sum)(...widths) - 100;

        if (toReclaim > 0) {
          const largeIndices = widths.map((v, i) => [i, v]).filter(p => p[1] > MIN_WIDGET_WIDTH_PCT).map(p => p[0]);

          for (const idx of largeIndices) {
            widths[idx] -= toReclaim / largeIndices.length;
          }
        }
      }
    } // Finally, fill in our cache and update


    this.byRoom[room.roomId] = {};

    if (topWidgets.length) {
      this.byRoom[room.roomId][Container.Top] = {
        ordered: topWidgets,
        distributions: widths,
        height: maxHeight
      };
    }

    if (rightWidgets.length) {
      this.byRoom[room.roomId][Container.Right] = {
        ordered: rightWidgets
      };
    }

    if (centerWidgets.length) {
      this.byRoom[room.roomId][Container.Center] = {
        ordered: centerWidgets
      };
    }

    const afterChanges = JSON.stringify(this.byRoom[room.roomId]);

    if (afterChanges !== beforeChanges) {
      this.emitFor(room);
    }
  }

  getContainerWidgets(room, container) {
    var _this$byRoom$room$roo, _this$byRoom$room$roo2;

    return ((_this$byRoom$room$roo = this.byRoom[room === null || room === void 0 ? void 0 : room.roomId]) === null || _this$byRoom$room$roo === void 0 ? void 0 : (_this$byRoom$room$roo2 = _this$byRoom$room$roo[container]) === null || _this$byRoom$room$roo2 === void 0 ? void 0 : _this$byRoom$room$roo2.ordered) || [];
  }

  isInContainer(room, widget, container) {
    return this.getContainerWidgets(room, container).some(w => w.id === widget.id);
  }

  canAddToContainer(room, container) {
    switch (container) {
      case Container.Top:
        return this.getContainerWidgets(room, container).length < MAX_PINNED;

      case Container.Right:
        return this.getContainerWidgets(room, container).length < MAX_PINNED;

      case Container.Center:
        return this.getContainerWidgets(room, container).length < 1;
    }
  }

  getResizerDistributions(room, container) {
    var _this$byRoom$room$roo3, _this$byRoom$room$roo4;

    // yes, string.
    let distributions = (_this$byRoom$room$roo3 = this.byRoom[room.roomId]) === null || _this$byRoom$room$roo3 === void 0 ? void 0 : (_this$byRoom$room$roo4 = _this$byRoom$room$roo3[container]) === null || _this$byRoom$room$roo4 === void 0 ? void 0 : _this$byRoom$room$roo4.distributions;
    if (!distributions || distributions.length < 2) return []; // The distributor actually expects to be fed N-1 sizes and expands the middle section
    // instead of the edges. Therefore, we need to return [0] when there's two widgets or
    // [0, 2] when there's three (skipping [1] because it's irrelevant).

    if (distributions.length === 2) distributions = [distributions[0]];
    if (distributions.length === 3) distributions = [distributions[0], distributions[2]];
    return distributions.map(d => `${d.toFixed(1)}%`); // actual percents - these are decoded later
  }

  setResizerDistributions(room, container, distributions) {
    if (container !== Container.Top) return; // ignore - not relevant

    const numbers = distributions.map(d => Number(Number(d.substring(0, d.length - 1)).toFixed(1)));
    const widgets = this.getContainerWidgets(room, container); // From getResizerDistributions, we need to fill in the middle size if applicable.

    const remaining = 100 - (0, _numbers.sum)(...numbers);
    if (numbers.length === 2) numbers.splice(1, 0, remaining);
    if (numbers.length === 1) numbers.push(remaining);
    const localLayout = {};
    widgets.forEach((w, i) => {
      var _this$byRoom$room$roo5, _this$byRoom$room$roo6;

      localLayout[w.id] = {
        container: container,
        width: numbers[i],
        index: i,
        height: ((_this$byRoom$room$roo5 = this.byRoom[room.roomId]) === null || _this$byRoom$room$roo5 === void 0 ? void 0 : (_this$byRoom$room$roo6 = _this$byRoom$room$roo5[container]) === null || _this$byRoom$room$roo6 === void 0 ? void 0 : _this$byRoom$room$roo6.height) || MIN_WIDGET_HEIGHT_PCT
      };
    });
    this.updateUserLayout(room, localLayout);
  }

  getContainerHeight(room, container) {
    var _this$byRoom$room$roo7, _this$byRoom$room$roo8;

    return (_this$byRoom$room$roo7 = this.byRoom[room.roomId]) === null || _this$byRoom$room$roo7 === void 0 ? void 0 : (_this$byRoom$room$roo8 = _this$byRoom$room$roo7[container]) === null || _this$byRoom$room$roo8 === void 0 ? void 0 : _this$byRoom$room$roo8.height; // let the default get returned if needed
  }

  setContainerHeight(room, container, height) {
    var _this$byRoom$room$roo9, _this$byRoom$room$roo10;

    const widgets = this.getContainerWidgets(room, container);
    const widths = (_this$byRoom$room$roo9 = this.byRoom[room.roomId]) === null || _this$byRoom$room$roo9 === void 0 ? void 0 : (_this$byRoom$room$roo10 = _this$byRoom$room$roo9[container]) === null || _this$byRoom$room$roo10 === void 0 ? void 0 : _this$byRoom$room$roo10.distributions;
    const localLayout = {};
    widgets.forEach((w, i) => {
      localLayout[w.id] = {
        container: container,
        width: widths[i],
        index: i,
        height: height
      };
    });
    this.updateUserLayout(room, localLayout);
  }

  moveWithinContainer(room, container, widget, delta) {
    var _this$byRoom$room$roo11, _this$byRoom$room$roo12, _this$byRoom$room$roo13, _this$byRoom$room$roo14;

    const widgets = (0, _arrays.arrayFastClone)(this.getContainerWidgets(room, container));
    const currentIdx = widgets.findIndex(w => w.id === widget.id);
    if (currentIdx < 0) return; // no change needed

    widgets.splice(currentIdx, 1); // remove existing widget

    const newIdx = (0, _numbers.clamp)(currentIdx + delta, 0, widgets.length);
    widgets.splice(newIdx, 0, widget);
    const widths = (_this$byRoom$room$roo11 = this.byRoom[room.roomId]) === null || _this$byRoom$room$roo11 === void 0 ? void 0 : (_this$byRoom$room$roo12 = _this$byRoom$room$roo11[container]) === null || _this$byRoom$room$roo12 === void 0 ? void 0 : _this$byRoom$room$roo12.distributions;
    const height = (_this$byRoom$room$roo13 = this.byRoom[room.roomId]) === null || _this$byRoom$room$roo13 === void 0 ? void 0 : (_this$byRoom$room$roo14 = _this$byRoom$room$roo13[container]) === null || _this$byRoom$room$roo14 === void 0 ? void 0 : _this$byRoom$room$roo14.height;
    const localLayout = {};
    widgets.forEach((w, i) => {
      localLayout[w.id] = {
        container: container,
        width: widths[i],
        index: i,
        height: height
      };
    });
    this.updateUserLayout(room, localLayout);
  }

  moveToContainer(room, widget, toContainer) {
    const allWidgets = this.getAllWidgets(room);
    if (!allWidgets.some(([w]) => w.id === widget.id)) return; // invalid
    // Prepare other containers (potentially move widgets to obay the following rules)

    switch (toContainer) {
      case Container.Right:
        // new "right" widget
        break;

      case Container.Center:
        // new "center" widget => all other widgets go into "right"
        for (const w of this.getContainerWidgets(room, Container.Top)) {
          this.moveToContainer(room, w, Container.Right);
        }

        for (const w of this.getContainerWidgets(room, Container.Center)) {
          this.moveToContainer(room, w, Container.Right);
        }

        break;

      case Container.Top:
        // new "top" widget => the center widget moves into "right"
        if (this.hasMaximisedWidget(room)) {
          this.moveToContainer(room, this.getContainerWidgets(room, Container.Center)[0], Container.Right);
        }

        break;
    } // move widgets into requested container.


    this.updateUserLayout(room, {
      [widget.id]: {
        container: toContainer
      }
    });
  }

  hasMaximisedWidget(room) {
    return this.getContainerWidgets(room, Container.Center).length > 0;
  }

  hasPinnedWidgets(room) {
    return this.getContainerWidgets(room, Container.Top).length > 0;
  }

  canCopyLayoutToRoom(room) {
    if (!this.matrixClient) return false; // not ready yet

    return room.currentState.maySendStateEvent(WIDGET_LAYOUT_EVENT_TYPE, this.matrixClient.getUserId());
  }

  copyLayoutToRoom(room) {
    const allWidgets = this.getAllWidgets(room);
    const evContent = {
      widgets: {}
    };

    for (const [widget, container] of allWidgets) {
      evContent.widgets[widget.id] = {
        container
      };

      if (container === Container.Top) {
        var _this$byRoom$room$roo15, _this$byRoom$room$roo16, _this$byRoom$room$roo17, _this$byRoom$room$roo18;

        const containerWidgets = this.getContainerWidgets(room, container);
        const idx = containerWidgets.findIndex(w => w.id === widget.id);
        const widths = (_this$byRoom$room$roo15 = this.byRoom[room.roomId]) === null || _this$byRoom$room$roo15 === void 0 ? void 0 : (_this$byRoom$room$roo16 = _this$byRoom$room$roo15[container]) === null || _this$byRoom$room$roo16 === void 0 ? void 0 : _this$byRoom$room$roo16.distributions;
        const height = (_this$byRoom$room$roo17 = this.byRoom[room.roomId]) === null || _this$byRoom$room$roo17 === void 0 ? void 0 : (_this$byRoom$room$roo18 = _this$byRoom$room$roo17[container]) === null || _this$byRoom$room$roo18 === void 0 ? void 0 : _this$byRoom$room$roo18.height;
        evContent.widgets[widget.id] = _objectSpread(_objectSpread({}, evContent.widgets[widget.id]), {}, {
          height: height ? Math.round(height) : null,
          width: widths[idx] ? Math.round(widths[idx]) : null,
          index: idx
        });
      }
    }

    this.matrixClient.sendStateEvent(room.roomId, WIDGET_LAYOUT_EVENT_TYPE, evContent, "");
  }

  getAllWidgets(room) {
    const containers = this.byRoom[room.roomId];
    if (!containers) return [];
    const ret = [];

    for (const container of Object.keys(containers)) {
      const widgets = containers[container].ordered;

      for (const widget of widgets) {
        ret.push([widget, container]);
      }
    }

    return ret;
  }

  updateUserLayout(room, newLayout) {
    // Polyfill any missing widgets
    const allWidgets = this.getAllWidgets(room);

    for (const [widget, container] of allWidgets) {
      var _this$byRoom$room$roo19, _this$byRoom$room$roo20;

      const containerWidgets = this.getContainerWidgets(room, container);
      const idx = containerWidgets.findIndex(w => w.id === widget.id);
      const widths = (_this$byRoom$room$roo19 = this.byRoom[room.roomId]) === null || _this$byRoom$room$roo19 === void 0 ? void 0 : (_this$byRoom$room$roo20 = _this$byRoom$room$roo19[container]) === null || _this$byRoom$room$roo20 === void 0 ? void 0 : _this$byRoom$room$roo20.distributions;

      if (!newLayout[widget.id]) {
        var _this$byRoom$room$roo21, _this$byRoom$room$roo22;

        newLayout[widget.id] = {
          container: container,
          index: idx,
          height: (_this$byRoom$room$roo21 = this.byRoom[room.roomId]) === null || _this$byRoom$room$roo21 === void 0 ? void 0 : (_this$byRoom$room$roo22 = _this$byRoom$room$roo21[container]) === null || _this$byRoom$room$roo22 === void 0 ? void 0 : _this$byRoom$room$roo22.height,
          width: widths === null || widths === void 0 ? void 0 : widths[idx]
        };
      }
    }

    const layoutEv = room.currentState.getStateEvents(WIDGET_LAYOUT_EVENT_TYPE, "");

    _SettingsStore.default.setValue("Widgets.layout", room.roomId, _SettingLevel.SettingLevel.ROOM_ACCOUNT, {
      overrides: layoutEv === null || layoutEv === void 0 ? void 0 : layoutEv.getId(),
      widgets: newLayout
    }).catch(() => this.recalculateRoom(room));

    this.recalculateRoom(room); // call to try local echo on changes (the catch above undoes any errors)
  }

}

exports.WidgetLayoutStore = WidgetLayoutStore;
(0, _defineProperty2.default)(WidgetLayoutStore, "internalInstance", void 0);
window.mxWidgetLayoutStore = WidgetLayoutStore.instance;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zdG9yZXMvd2lkZ2V0cy9XaWRnZXRMYXlvdXRTdG9yZS50cyJdLCJuYW1lcyI6WyJXSURHRVRfTEFZT1VUX0VWRU5UX1RZUEUiLCJDb250YWluZXIiLCJNQVhfUElOTkVEIiwiTUlOX1dJREdFVF9XSURUSF9QQ1QiLCJNSU5fV0lER0VUX0hFSUdIVF9QQ1QiLCJXaWRnZXRMYXlvdXRTdG9yZSIsIlJlYWR5V2F0Y2hpbmdTdG9yZSIsImNvbnN0cnVjdG9yIiwiZGVmYXVsdERpc3BhdGNoZXIiLCJieVJvb20iLCJyb29tIiwibWF0cml4Q2xpZW50IiwiZ2V0VmlzaWJsZVJvb21zIiwicmVjYWxjdWxhdGVSb29tIiwicm9vbUlkIiwiZ2V0Um9vbSIsInVwZGF0ZUFsbFJvb21zIiwiZXYiLCJnZXRUeXBlIiwiZ2V0Um9vbUlkIiwic2V0dGluZ05hbWUiLCJpbnN0YW5jZSIsImludGVybmFsSW5zdGFuY2UiLCJlbWlzc2lvbkZvclJvb20iLCJlbWl0Rm9yIiwiZW1pdCIsIm9uUmVhZHkiLCJvbiIsInVwZGF0ZVJvb21Gcm9tU3RhdGUiLCJwaW5uZWRSZWYiLCJTZXR0aW5nc1N0b3JlIiwid2F0Y2hTZXR0aW5nIiwidXBkYXRlRnJvbVNldHRpbmdzIiwibGF5b3V0UmVmIiwiV2lkZ2V0U3RvcmUiLCJVUERBVEVfRVZFTlQiLCJ1cGRhdGVGcm9tV2lkZ2V0U3RvcmUiLCJvbk5vdFJlYWR5IiwidW53YXRjaFNldHRpbmciLCJvZmYiLCJ3aWRnZXRzIiwiZ2V0QXBwcyIsImxlbmd0aCIsImJlZm9yZUNoYW5nZXMiLCJKU09OIiwic3RyaW5naWZ5IiwibGF5b3V0RXYiLCJjdXJyZW50U3RhdGUiLCJnZXRTdGF0ZUV2ZW50cyIsImxlZ2FjeVBpbm5lZCIsImdldFZhbHVlIiwidXNlckxheW91dCIsIm92ZXJyaWRlcyIsImdldElkIiwicm9vbUxheW91dCIsImdldENvbnRlbnQiLCJ0b3BXaWRnZXRzIiwicmlnaHRXaWRnZXRzIiwiY2VudGVyV2lkZ2V0cyIsIndpZGdldCIsInN0YXRlQ29udGFpbmVyIiwiaWQiLCJjb250YWluZXIiLCJtYW51YWxDb250YWluZXIiLCJpc0xlZ2FjeVBpbm5lZCIsImRlZmF1bHRDb250YWluZXIiLCJXaWRnZXRUeXBlIiwiSklUU0kiLCJtYXRjaGVzIiwidHlwZSIsIlRvcCIsIlJpZ2h0IiwiQ2VudGVyIiwiY29uc29sZSIsImVycm9yIiwicHVzaCIsInRhcmdldENvbnRhaW5lciIsInJ1bm9mZiIsInNsaWNlIiwic29ydCIsImEiLCJiIiwibGF5b3V0QSIsImxheW91dEIiLCJ1c2VyTGF5b3V0QSIsInVzZXJMYXlvdXRCIiwiZGVmYXVsdEEiLCJOdW1iZXIiLCJNSU5fU0FGRV9JTlRFR0VSIiwiTUFYX1NBRkVfSU5URUdFUiIsImRlZmF1bHRCIiwib3JkZXJBIiwiaW5kZXgiLCJvcmRlckIiLCJ3aWR0aHMiLCJtYXhIZWlnaHQiLCJkb0F1dG9iYWxhbmNlIiwiaSIsIndpZGdldExheW91dCIsInVzZXJXaWRnZXRMYXlvdXQiLCJpc0Zpbml0ZSIsIndpZHRoIiwidmFsIiwibm9ybWFsaXplZCIsImhlaWdodCIsImRlZlJvb21IZWlnaHQiLCJoIiwiTWF0aCIsIm1heCIsImRpZmZlcmVuY2UiLCJhYnMiLCJ0b1JlY2xhaW0iLCJsYXJnZUluZGljZXMiLCJtYXAiLCJ2IiwiZmlsdGVyIiwicCIsImlkeCIsIm9yZGVyZWQiLCJkaXN0cmlidXRpb25zIiwiYWZ0ZXJDaGFuZ2VzIiwiZ2V0Q29udGFpbmVyV2lkZ2V0cyIsImlzSW5Db250YWluZXIiLCJzb21lIiwidyIsImNhbkFkZFRvQ29udGFpbmVyIiwiZ2V0UmVzaXplckRpc3RyaWJ1dGlvbnMiLCJkIiwidG9GaXhlZCIsInNldFJlc2l6ZXJEaXN0cmlidXRpb25zIiwibnVtYmVycyIsInN1YnN0cmluZyIsInJlbWFpbmluZyIsInNwbGljZSIsImxvY2FsTGF5b3V0IiwiZm9yRWFjaCIsInVwZGF0ZVVzZXJMYXlvdXQiLCJnZXRDb250YWluZXJIZWlnaHQiLCJzZXRDb250YWluZXJIZWlnaHQiLCJtb3ZlV2l0aGluQ29udGFpbmVyIiwiZGVsdGEiLCJjdXJyZW50SWR4IiwiZmluZEluZGV4IiwibmV3SWR4IiwibW92ZVRvQ29udGFpbmVyIiwidG9Db250YWluZXIiLCJhbGxXaWRnZXRzIiwiZ2V0QWxsV2lkZ2V0cyIsImhhc01heGltaXNlZFdpZGdldCIsImhhc1Bpbm5lZFdpZGdldHMiLCJjYW5Db3B5TGF5b3V0VG9Sb29tIiwibWF5U2VuZFN0YXRlRXZlbnQiLCJnZXRVc2VySWQiLCJjb3B5TGF5b3V0VG9Sb29tIiwiZXZDb250ZW50IiwiY29udGFpbmVyV2lkZ2V0cyIsInJvdW5kIiwic2VuZFN0YXRlRXZlbnQiLCJjb250YWluZXJzIiwicmV0IiwiT2JqZWN0Iiwia2V5cyIsIm5ld0xheW91dCIsInNldFZhbHVlIiwiU2V0dGluZ0xldmVsIiwiUk9PTV9BQ0NPVU5UIiwiY2F0Y2giLCJ3aW5kb3ciLCJteFdpZGdldExheW91dFN0b3JlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWdCQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7O0FBRU8sTUFBTUEsd0JBQXdCLEdBQUcsMkJBQWpDOztJQUVLQyxTOzs7V0FBQUEsUztBQUFBQSxFQUFBQSxTO0FBQUFBLEVBQUFBLFM7QUFBQUEsRUFBQUEsUztHQUFBQSxTLHlCQUFBQSxTOztBQW1EWjtBQUNPLE1BQU1DLFVBQVUsR0FBRyxDQUFuQixDLENBRVA7QUFDQTtBQUNBOzs7QUFDQSxNQUFNQyxvQkFBb0IsR0FBRyxFQUE3QixDLENBQWlDOztBQUNqQyxNQUFNQyxxQkFBcUIsR0FBRyxDQUE5QixDLENBQWlDOztBQUUxQixNQUFNQyxpQkFBTixTQUFnQ0Msc0NBQWhDLENBQW1EO0FBaUI5Q0MsRUFBQUEsV0FBVyxHQUFHO0FBQ2xCLFVBQU1DLG1CQUFOO0FBRGtCLGtEQUxsQixFQUtrQjtBQUFBO0FBQUE7QUFBQSwwREFvQ0csTUFBTTtBQUMzQixXQUFL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LENBQUNnQixRQUEvQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgMjAyMSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IFNldHRpbmdzU3RvcmUgZnJvbSBcIi4uLy4uL3NldHRpbmdzL1NldHRpbmdzU3RvcmVcIjtcbmltcG9ydCB7IFJvb20gfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3Jvb21cIjtcbmltcG9ydCBXaWRnZXRTdG9yZSwgeyBJQXBwIH0gZnJvbSBcIi4uL1dpZGdldFN0b3JlXCI7XG5pbXBvcnQgeyBXaWRnZXRUeXBlIH0gZnJvbSBcIi4uLy4uL3dpZGdldHMvV2lkZ2V0VHlwZVwiO1xuaW1wb3J0IHsgY2xhbXAsIGRlZmF1bHROdW1iZXIsIHN1bSB9IGZyb20gXCIuLi8uLi91dGlscy9udW1iZXJzXCI7XG5pbXBvcnQgZGVmYXVsdERpc3BhdGNoZXIgZnJvbSBcIi4uLy4uL2Rpc3BhdGNoZXIvZGlzcGF0Y2hlclwiO1xuaW1wb3J0IHsgUmVhZHlXYXRjaGluZ1N0b3JlIH0gZnJvbSBcIi4uL1JlYWR5V2F0Y2hpbmdTdG9yZVwiO1xuaW1wb3J0IHsgTWF0cml4RXZlbnQgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL2V2ZW50XCI7XG5pbXBvcnQgeyBTZXR0aW5nTGV2ZWwgfSBmcm9tIFwiLi4vLi4vc2V0dGluZ3MvU2V0dGluZ0xldmVsXCI7XG5pbXBvcnQgeyBhcnJheUZhc3RDbG9uZSB9IGZyb20gXCIuLi8uLi91dGlscy9hcnJheXNcIjtcbmltcG9ydCB7IFVQREFURV9FVkVOVCB9IGZyb20gXCIuLi9Bc3luY1N0b3JlXCI7XG5pbXBvcnQgeyBjb21wYXJlIH0gZnJvbSBcIi4uLy4uL3V0aWxzL3N0cmluZ3NcIjtcblxuZXhwb3J0IGNvbnN0IFdJREdFVF9MQVlPVVRfRVZFTlRfVFlQRSA9IFwiaW8uZWxlbWVudC53aWRnZXRzLmxheW91dFwiO1xuXG5leHBvcnQgZW51bSBDb250YWluZXIge1xuICAgIC8vIFwiVG9wXCIgaXMgdGhlIGFwcCBkcmF3ZXIsIGFuZCBjdXJyZW50bHkgdGhlIG9ubHkgc2Vuc2libGUgdmFsdWUuXG4gICAgVG9wID0gXCJ0b3BcIixcblxuICAgIC8vIFwiUmlnaHRcIiBpcyB0aGUgcmlnaHQgcGFuZWwsIGFuZCB0aGUgZGVmYXVsdCBmb3Igd2lkZ2V0cy4gU2V0dGluZ1xuICAgIC8vIHRoaXMgYXMgYSBjb250YWluZXIgb24gYSB3aWRnZXQgaXMgZXNzZW50aWFsbHkgbGlrZSBzYXlpbmcgXCJub1xuICAgIC8vIGNoYW5nZXMgbmVlZGVkXCIsIHRob3VnaCB0aGlzIG1heSBjaGFuZ2UgaW4gdGhlIGZ1dHVyZS5cbiAgICBSaWdodCA9IFwicmlnaHRcIixcblxuICAgIENlbnRlciA9IFwiY2VudGVyXCJcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJU3RvcmVkTGF5b3V0IHtcbiAgICAvLyBXaGVyZSB0byBzdG9yZSB0aGUgd2lkZ2V0LiBSZXF1aXJlZC5cbiAgICBjb250YWluZXI6IENvbnRhaW5lcjtcblxuICAgIC8vIFRoZSBpbmRleCAob3JkZXIpIHRvIHBvc2l0aW9uIHRoZSB3aWRnZXRzIGluLiBPbmx5IGFwcGxpZXMgZm9yXG4gICAgLy8gb3JkZXJlZCBjb250YWluZXJzIChsaWtlIHRoZSB0b3AgY29udGFpbmVyKS4gU21hbGxlciBudW1iZXJzIGZpcnN0LFxuICAgIC8vIGFuZCBjb25mbGljdHMgcmVzb2x2ZWQgYnkgY29tcGFyaW5nIHdpZGdldCBJRHMuXG4gICAgaW5kZXg/OiBudW1iZXI7XG5cbiAgICAvLyBQZXJjZW50YWdlIChpbnRlZ2VyKSBmb3IgcmVsYXRpdmUgd2lkdGggb2YgdGhlIGNvbnRhaW5lciB0byBjb25zdW1lLlxuICAgIC8vIENsYW1wZWQgdG8gMC0xMDAgYW5kIG1heSBoYXZlIG1pbmltdW1zIGltcG9zZWQgdXBvbiBpdC4gT25seSBhcHBsaWVzXG4gICAgLy8gdG8gY29udGFpbmVycyB3aGljaCBzdXBwb3J0IGlubmVyIHJlc2l6aW5nIChjdXJyZW50bHkgb25seSB0aGUgdG9wXG4gICAgLy8gY29udGFpbmVyKS5cbiAgICB3aWR0aD86IG51bWJlcjtcblxuICAgIC8vIFBlcmNlbnRhZ2UgKGludGVnZXIpIGZvciByZWxhdGl2ZSBoZWlnaHQgb2YgdGhlIGNvbnRhaW5lci4gTm90ZSB0aGF0XG4gICAgLy8gdGhpcyBvbmx5IGFwcGxpZXMgdG8gdGhlIHRvcCBjb250YWluZXIgY3VycmVudGx5LCBhbmQgdGhhdCBjb250YWluZXJcbiAgICAvLyB3aWxsIHRha2UgdGhlIGhpZ2hlc3QgdmFsdWUgYW1vbmcgd2lkZ2V0cyBpbiB0aGUgY29udGFpbmVyLiBDbGFtcGVkXG4gICAgLy8gdG8gMC0xMDAgYW5kIG1heSBoYXZlIG1pbmltdW1zIGltcG9zZWQgb24gaXQuXG4gICAgaGVpZ2h0PzogbnVtYmVyO1xuXG4gICAgLy8gVE9ETzogW0RlZmVycmVkXSBNYXhpbWl6aW5nIChmdWxsc2NyZWVuKSB3aWRnZXRzIGJ5IGRlZmF1bHQuXG59XG5cbmludGVyZmFjZSBJV2lkZ2V0TGF5b3V0cyB7XG4gICAgW3dpZGdldElkOiBzdHJpbmddOiBJU3RvcmVkTGF5b3V0O1xufVxuXG5pbnRlcmZhY2UgSUxheW91dFN0YXRlRXZlbnQge1xuICAgIC8vIFRPRE86IFtEZWZlcnJlZF0gRm9yY2VkIGxheW91dCAoZml4ZWQgd2l0aCBubyBjaGFuZ2VzKVxuXG4gICAgLy8gVGhlIHdpZGdldCBsYXlvdXRzLlxuICAgIHdpZGdldHM6IElXaWRnZXRMYXlvdXRzO1xufVxuXG5pbnRlcmZhY2UgSUxheW91dFNldHRpbmdzIGV4dGVuZHMgSUxheW91dFN0YXRlRXZlbnQge1xuICAgIG92ZXJyaWRlcz86IHN0cmluZzsgLy8gZXZlbnQgSUQgZm9yIGxheW91dCBzdGF0ZSBldmVudCwgaWYgcHJlc2VudFxufVxuXG4vLyBEZXYgbm90ZTogXCJQaW5uZWRcIiB3aWRnZXRzIGFyZSBvbmVzIGluIHRoZSB0b3AgY29udGFpbmVyLlxuZXhwb3J0IGNvbnN0IE1BWF9QSU5ORUQgPSAzO1xuXG4vLyBUaGVzZSB0d28gYXJlIHdob2xlIHBlcmNlbnRhZ2VzIGFuZCBkb24ndCByZWFsbHkgbWVhbiBhbnl0aGluZy4gTGF0ZXIgdmFsdWVzIHdpbGwgZGVjaWRlXG4vLyBtaW5pbXVtLCBidXQgdGhlc2UgaGVscCBkZXRlcm1pbmUgcHJvcG9ydGlvbnMgZHVyaW5nIG91ciBjYWxjdWxhdGlvbnMgaGVyZS4gSW4gZmFjdCwgdGhlc2Vcbi8vIHZhbHVlcyBzaG91bGQgYmUgKnNtYWxsZXIqIHRoYW4gdGhlIGFjdHVhbCBtaW5pbXVtcyBpbXBvc2VkIGJ5IGxhdGVyIGNvbXBvbmVudHMuXG5jb25zdCBNSU5fV0lER0VUX1dJRFRIX1BDVCA9IDEwOyAvLyAxMCVcbmNvbnN0IE1JTl9XSURHRVRfSEVJR0hUX1BDVCA9IDI7IC8vIDIlXG5cbmV4cG9ydCBjbGFzcyBXaWRnZXRMYXlvdXRTdG9yZSBleHRlbmRzIFJlYWR5V2F0Y2hpbmdTdG9yZSB7XG4gICAgcHJpdmF0ZSBzdGF0aWMgaW50ZXJuYWxJbnN0YW5jZTogV2lkZ2V0TGF5b3V0U3RvcmU7XG5cbiAgICBwcml2YXRlIGJ5Um9vbToge1xuICAgICAgICBbcm9vbUlkOiBzdHJpbmddOiB7XG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlIC0gVFMgd2FudHMgYSBzdHJpbmcga2V5LCBidXQgd2Uga25vdyBiZXR0ZXJcbiAgICAgICAgICAgIFtjb250YWluZXI6IENvbnRhaW5lcl06IHtcbiAgICAgICAgICAgICAgICBvcmRlcmVkOiBJQXBwW107XG4gICAgICAgICAgICAgICAgaGVpZ2h0PzogbnVtYmVyO1xuICAgICAgICAgICAgICAgIGRpc3RyaWJ1dGlvbnM/OiBudW1iZXJbXTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIH07XG4gICAgfSA9IHt9O1xuXG4gICAgcHJpdmF0ZSBwaW5uZWRSZWY6IHN0cmluZztcbiAgICBwcml2YXRlIGxheW91dFJlZjogc3RyaW5nO1xuXG4gICAgcHJpdmF0ZSBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoZGVmYXVsdERpc3BhdGNoZXIpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0IGluc3RhbmNlKCk6IFdpZGdldExheW91dFN0b3JlIHtcbiAgICAgICAgaWYgKCFXaWRnZXRMYXlvdXRTdG9yZS5pbnRlcm5hbEluc3RhbmNlKSB7XG4gICAgICAgICAgICBXaWRnZXRMYXlvdXRTdG9yZS5pbnRlcm5hbEluc3RhbmNlID0gbmV3IFdpZGdldExheW91dFN0b3JlKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFdpZGdldExheW91dFN0b3JlLmludGVybmFsSW5zdGFuY2U7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBlbWlzc2lvbkZvclJvb20ocm9vbTogUm9vbSk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBgdXBkYXRlXyR7cm9vbS5yb29tSWR9YDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGVtaXRGb3Iocm9vbTogUm9vbSkge1xuICAgICAgICB0aGlzLmVtaXQoV2lkZ2V0TGF5b3V0U3RvcmUuZW1pc3Npb25Gb3JSb29tKHJvb20pKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgYXN5bmMgb25SZWFkeSgpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICB0aGlzLnVwZGF0ZUFsbFJvb21zKCk7XG5cbiAgICAgICAgdGhpcy5tYXRyaXhDbGllbnQub24oXCJSb29tU3RhdGUuZXZlbnRzXCIsIHRoaXMudXBkYXRlUm9vbUZyb21TdGF0ZSk7XG4gICAgICAgIHRoaXMucGlubmVkUmVmID0gU2V0dGluZ3NTdG9yZS53YXRjaFNldHRpbmcoXCJXaWRnZXRzLnBpbm5lZFwiLCBudWxsLCB0aGlzLnVwZGF0ZUZyb21TZXR0aW5ncyk7XG4gICAgICAgIHRoaXMubGF5b3V0UmVmID0gU2V0dGluZ3NTdG9yZS53YXRjaFNldHRpbmcoXCJXaWRnZXRzLmxheW91dFwiLCBudWxsLCB0aGlzLnVwZGF0ZUZyb21TZXR0aW5ncyk7XG4gICAgICAgIFdpZGdldFN0b3JlLmluc3RhbmNlLm9uKFVQREFURV9FVkVOVCwgdGhpcy51cGRhdGVGcm9tV2lkZ2V0U3RvcmUpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBhc3luYyBvbk5vdFJlYWR5KCk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIHRoaXMuYnlSb29tID0ge307XG5cbiAgICAgICAgU2V0dGluZ3NTdG9yZS51bndhdGNoU2V0dGluZyh0aGlzLnBpbm5lZFJlZik7XG4gICAgICAgIFNldHRpbmdzU3RvcmUudW53YXRjaFNldHRpbmcodGhpcy5sYXlvdXRSZWYpO1xuICAgICAgICBXaWRnZXRTdG9yZS5pbnN0YW5jZS5vZmYoVVBEQVRFX0VWRU5ULCB0aGlzLnVwZGF0ZUZyb21XaWRnZXRTdG9yZSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB1cGRhdGVBbGxSb29tcyA9ICgpID0+IHtcbiAgICAgICAgdGhpcy5ieVJvb20gPSB7fTtcbiAgICAgICAgZm9yIChjb25zdCByb29tIG9mIHRoaXMubWF0cml4Q2xpZW50LmdldFZpc2libGVSb29tcygpKSB7XG4gICAgICAgICAgICB0aGlzLnJlY2FsY3VsYXRlUm9vbShyb29tKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwcml2YXRlIHVwZGF0ZUZyb21XaWRnZXRTdG9yZSA9IChyb29tSWQ/OiBzdHJpbmcpID0+IHtcbiAgICAgICAgaWYgKHJvb21JZCkge1xuICAgICAgICAgICAgY29uc3Qgcm9vbSA9IHRoaXMubWF0cml4Q2xpZW50LmdldFJvb20ocm9vbUlkKTtcbiAgICAgICAgICAgIGlmIChyb29tKSB0aGlzLnJlY2FsY3VsYXRlUm9vbShyb29tKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlQWxsUm9vbXMoKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwcml2YXRlIHVwZGF0ZVJvb21Gcm9tU3RhdGUgPSAoZXY6IE1hdHJpeEV2ZW50KSA9PiB7XG4gICAgICAgIGlmIChldi5nZXRUeXBlKCkgIT09IFdJREdFVF9MQVlPVVRfRVZFTlRfVFlQRSkgcmV0dXJuO1xuICAgICAgICBjb25zdCByb29tID0gdGhpcy5tYXRyaXhDbGllbnQuZ2V0Um9vbShldi5nZXRSb29tSWQoKSk7XG4gICAgICAgIGlmIChyb29tKSB0aGlzLnJlY2FsY3VsYXRlUm9vbShyb29tKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSB1cGRhdGVGcm9tU2V0dGluZ3MgPSAoc2V0dGluZ05hbWU6IHN0cmluZywgcm9vbUlkOiBzdHJpbmcgLyogYW5kIG90aGVyIHN0dWZmICovKSA9PiB7XG4gICAgICAgIGlmIChyb29tSWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHJvb20gPSB0aGlzLm1hdHJpeENsaWVudC5nZXRSb29tKHJvb21JZCk7XG4gICAgICAgICAgICBpZiAocm9vbSkgdGhpcy5yZWNhbGN1bGF0ZVJvb20ocm9vbSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZUFsbFJvb21zKCk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHVibGljIHJlY2FsY3VsYXRlUm9vbShyb29tOiBSb29tKSB7XG4gICAgICAgIGNvbnN0IHdpZGdldHMgPSBXaWRnZXRTdG9yZS5pbnN0YW5jZS5nZXRBcHBzKHJvb20ucm9vbUlkKTtcbiAgICAgICAgaWYgKCF3aWRnZXRzPy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoaXMuYnlSb29tW3Jvb20ucm9vbUlkXSA9IHt9O1xuICAgICAgICAgICAgdGhpcy5lbWl0Rm9yKHJvb20pO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgYmVmb3JlQ2hhbmdlcyA9IEpTT04uc3RyaW5naWZ5KHRoaXMuYnlSb29tW3Jvb20ucm9vbUlkXSk7XG5cbiAgICAgICAgY29uc3QgbGF5b3V0RXYgPSByb29tLmN1cnJlbnRTdGF0ZS5nZXRTdGF0ZUV2ZW50cyhXSURHRVRfTEFZT1VUX0VWRU5UX1RZUEUsIFwiXCIpO1xuICAgICAgICBjb25zdCBsZWdhY3lQaW5uZWQgPSBTZXR0aW5nc1N0b3JlLmdldFZhbHVlKFwiV2lkZ2V0cy5waW5uZWRcIiwgcm9vbS5yb29tSWQpO1xuICAgICAgICBsZXQgdXNlckxheW91dCA9IFNldHRpbmdzU3RvcmUuZ2V0VmFsdWU8SUxheW91dFNldHRpbmdzPihcIldpZGdldHMubGF5b3V0XCIsIHJvb20ucm9vbUlkKTtcblxuICAgICAgICBpZiAobGF5b3V0RXYgJiYgdXNlckxheW91dCAmJiB1c2VyTGF5b3V0Lm92ZXJyaWRlcyAhPT0gbGF5b3V0RXYuZ2V0SWQoKSkge1xuICAgICAgICAgICAgLy8gRm9yIHNvbWUgb3RoZXIgbGF5b3V0IHRoYXQgd2UgZG9uJ3QgcmVhbGx5IGNhcmUgYWJvdXQuIFRoZSB1c2VyIGNhbiByZXNldCB0aGlzXG4gICAgICAgICAgICAvLyBieSB1cGRhdGluZyB0aGVpciBwZXJzb25hbCBsYXlvdXQuXG4gICAgICAgICAgICB1c2VyTGF5b3V0ID0gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJvb21MYXlvdXQ6IElMYXlvdXRTdGF0ZUV2ZW50ID0gbGF5b3V0RXYgPyBsYXlvdXRFdi5nZXRDb250ZW50KCkgOiBudWxsO1xuICAgICAgICAvLyBXZSBmaWx0ZXIgZm9yIHRoZSBjZW50ZXIgY29udGFpbmVyIGZpcnN0LlxuICAgICAgICAvLyAoQW4gZXJyb3IgaXMgcmFpc2VkLCBpZiB0aGVyZSBhcmUgbXVsdGlwbGUgd2lkZ2V0cyBtYXJrZWQgZm9yIHRoZSBjZW50ZXIgY29udGFpbmVyKVxuICAgICAgICAvLyBGb3IgdGhlIHJpZ2h0IGFuZCB0b3AgY29udGFpbmVyIG11bHRpcGxlIHdpZGdldHMgYXJlIGFsbG93ZWQuXG4gICAgICAgIGNvbnN0IHRvcFdpZGdldHM6IElBcHBbXSA9IFtdO1xuICAgICAgICBjb25zdCByaWdodFdpZGdldHM6IElBcHBbXSA9IFtdO1xuICAgICAgICBjb25zdCBjZW50ZXJXaWRnZXRzOiBJQXBwW10gPSBbXTtcbiAgICAgICAgZm9yIChjb25zdCB3aWRnZXQgb2Ygd2lkZ2V0cykge1xuICAgICAgICAgICAgY29uc3Qgc3RhdGVDb250YWluZXIgPSByb29tTGF5b3V0Py53aWRnZXRzPy5bd2lkZ2V0LmlkXT8uY29udGFpbmVyO1xuICAgICAgICAgICAgY29uc3QgbWFudWFsQ29udGFpbmVyID0gdXNlckxheW91dD8ud2lkZ2V0cz8uW3dpZGdldC5pZF0/LmNvbnRhaW5lcjtcbiAgICAgICAgICAgIGNvbnN0IGlzTGVnYWN5UGlubmVkID0gISFsZWdhY3lQaW5uZWQ/Llt3aWRnZXQuaWRdO1xuICAgICAgICAgICAgY29uc3QgZGVmYXVsdENvbnRhaW5lciA9IFdpZGdldFR5cGUuSklUU0kubWF0Y2hlcyh3aWRnZXQudHlwZSkgPyBDb250YWluZXIuVG9wIDogQ29udGFpbmVyLlJpZ2h0O1xuICAgICAgICAgICAgaWYgKChtYW51YWxDb250YWluZXIpID8gbWFudWFsQ29udGFpbmVyID09PSBDb250YWluZXIuQ2VudGVyIDogc3RhdGVDb250YWluZXIgPT09IENvbnRhaW5lci5DZW50ZXIpIHtcbiAgICAgICAgICAgICAgICBpZiAoY2VudGVyV2lkZ2V0cy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIlRyaWVkIHRvIHB1c2ggYSBzZWNvbmQgd2lkZ2V0IGludG8gdGhlIGNlbnRlciBjb250YWluZXJcIik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY2VudGVyV2lkZ2V0cy5wdXNoKHdpZGdldCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIFRoZSB3aWRnZXQgd29uJ3QgbmVlZCB0byBiZSBwdXQgaW4gYW55IG90aGVyIGNvbnRhaW5lci5cbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxldCB0YXJnZXRDb250YWluZXIgPSBkZWZhdWx0Q29udGFpbmVyO1xuICAgICAgICAgICAgaWYgKCEhbWFudWFsQ29udGFpbmVyIHx8ICEhc3RhdGVDb250YWluZXIpIHtcbiAgICAgICAgICAgICAgICB0YXJnZXRDb250YWluZXIgPSAobWFudWFsQ29udGFpbmVyKSA/IG1hbnVhbENvbnRhaW5lciA6IHN0YXRlQ29udGFpbmVyO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChpc0xlZ2FjeVBpbm5lZCAmJiAhc3RhdGVDb250YWluZXIpIHtcbiAgICAgICAgICAgICAgICAvLyBTcGVjaWFsIGxlZ2FjeSBjYXNlXG4gICAgICAgICAgICAgICAgdGFyZ2V0Q29udGFpbmVyID0gQ29udGFpbmVyLlRvcDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgICh0YXJnZXRDb250YWluZXIgPT09IENvbnRhaW5lci5Ub3AgPyB0b3BXaWRnZXRzIDogcmlnaHRXaWRnZXRzKS5wdXNoKHdpZGdldCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBUcmltIHRvIE1BWF9QSU5ORURcbiAgICAgICAgY29uc3QgcnVub2ZmID0gdG9wV2lkZ2V0cy5zbGljZShNQVhfUElOTkVEKTtcbiAgICAgICAgcmlnaHRXaWRnZXRzLnB1c2goLi4ucnVub2ZmKTtcblxuICAgICAgICAvLyBPcmRlciB0aGUgd2lkZ2V0cyBpbiB0aGUgdG9wIGNvbnRhaW5lciwgcHV0dGluZyBhdXRvcGlubmVkIEppdHNpIHdpZGdldHMgZmlyc3RcbiAgICAgICAgLy8gdW5sZXNzIHRoZXkgaGF2ZSBhIHNwZWNpZmljIG9yZGVyIGluIG1pbmRcbiAgICAgICAgdG9wV2lkZ2V0cy5zb3J0KChhLCBiKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBsYXlvdXRBID0gcm9vbUxheW91dD8ud2lkZ2V0cz8uW2EuaWRdO1xuICAgICAgICAgICAgY29uc3QgbGF5b3V0QiA9IHJvb21MYXlvdXQ/LndpZGdldHM/LltiLmlkXTtcblxuICAgICAgICAgICAgY29uc3QgdXNlckxheW91dEEgPSB1c2VyTGF5b3V0Py53aWRnZXRzPy5bYS5pZF07XG4gICAgICAgICAgICBjb25zdCB1c2VyTGF5b3V0QiA9IHVzZXJMYXlvdXQ/LndpZGdldHM/LltiLmlkXTtcblxuICAgICAgICAgICAgLy8gSml0c2kgd2lkZ2V0cyBhcmUgZGVmYXVsdGVkIHRvIGJlIHRoZSBsZWZ0bW9zdCB3aWRnZXQgd2hlcmVhcyBvdGhlciB3aWRnZXRzXG4gICAgICAgICAgICAvLyBkZWZhdWx0IHRvIHRoZSByaWdodCBzaWRlLlxuICAgICAgICAgICAgY29uc3QgZGVmYXVsdEEgPSBXaWRnZXRUeXBlLkpJVFNJLm1hdGNoZXMoYS50eXBlKSA/IE51bWJlci5NSU5fU0FGRV9JTlRFR0VSIDogTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVI7XG4gICAgICAgICAgICBjb25zdCBkZWZhdWx0QiA9IFdpZGdldFR5cGUuSklUU0kubWF0Y2hlcyhiLnR5cGUpID8gTnVtYmVyLk1JTl9TQUZFX0lOVEVHRVIgOiBOdW1iZXIuTUFYX1NBRkVfSU5URUdFUjtcblxuICAgICAgICAgICAgY29uc3Qgb3JkZXJBID0gZGVmYXVsdE51bWJlcih1c2VyTGF5b3V0QT8uaW5kZXgsIGRlZmF1bHROdW1iZXIobGF5b3V0QT8uaW5kZXgsIGRlZmF1bHRBKSk7XG4gICAgICAgICAgICBjb25zdCBvcmRlckIgPSBkZWZhdWx0TnVtYmVyKHVzZXJMYXlvdXRCPy5pbmRleCwgZGVmYXVsdE51bWJlcihsYXlvdXRCPy5pbmRleCwgZGVmYXVsdEIpKTtcblxuICAgICAgICAgICAgaWYgKG9yZGVyQSA9PT0gb3JkZXJCKSB7XG4gICAgICAgICAgICAgICAgLy8gV2UganVzdCBuZWVkIGEgdGllYnJlYWtcbiAgICAgICAgICAgICAgICByZXR1cm4gY29tcGFyZShhLmlkLCBiLmlkKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIG9yZGVyQSAtIG9yZGVyQjtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gRGV0ZXJtaW5lIHdpZHRoIGRpc3RyaWJ1dGlvbiBhbmQgaGVpZ2h0IG9mIHRoZSB0b3AgY29udGFpbmVyIG5vdyAodGhlIG9ubHkgcmVsZXZhbnQgb25lKVxuICAgICAgICBjb25zdCB3aWR0aHM6IG51bWJlcltdID0gW107XG4gICAgICAgIGxldCBtYXhIZWlnaHQgPSBudWxsOyAvLyBudWxsID09IGRlZmF1bHRcbiAgICAgICAgbGV0IGRvQXV0b2JhbGFuY2UgPSB0cnVlO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRvcFdpZGdldHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IHdpZGdldCA9IHRvcFdpZGdldHNbaV07XG4gICAgICAgICAgICBjb25zdCB3aWRnZXRMYXlvdXQgPSByb29tTGF5b3V0Py53aWRnZXRzPy5bd2lkZ2V0LmlkXTtcbiAgICAgICAgICAgIGNvbnN0IHVzZXJXaWRnZXRMYXlvdXQgPSB1c2VyTGF5b3V0Py53aWRnZXRzPy5bd2lkZ2V0LmlkXTtcblxuICAgICAgICAgICAgaWYgKE51bWJlci5pc0Zpbml0ZSh1c2VyV2lkZ2V0TGF5b3V0Py53aWR0aCkgfHwgTnVtYmVyLmlzRmluaXRlKHdpZGdldExheW91dD8ud2lkdGgpKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdmFsID0gdXNlcldpZGdldExheW91dD8ud2lkdGggfHwgd2lkZ2V0TGF5b3V0Py53aWR0aDtcbiAgICAgICAgICAgICAgICBjb25zdCBub3JtYWxpemVkID0gY2xhbXAodmFsLCBNSU5fV0lER0VUX1dJRFRIX1BDVCwgMTAwKTtcbiAgICAgICAgICAgICAgICB3aWR0aHMucHVzaChub3JtYWxpemVkKTtcbiAgICAgICAgICAgICAgICBkb0F1dG9iYWxhbmNlID0gZmFsc2U7IC8vIGEgbWFudWFsIHdpZHRoIHdhcyBzcGVjaWZpZWRcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgd2lkdGhzLnB1c2goMTAwKTsgLy8gd2UnbGwgZmlndXJlIHRoaXMgb3V0IGxhdGVyXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICh3aWRnZXRMYXlvdXQ/LmhlaWdodCB8fCB1c2VyV2lkZ2V0TGF5b3V0Py5oZWlnaHQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBkZWZSb29tSGVpZ2h0ID0gZGVmYXVsdE51bWJlcih3aWRnZXRMYXlvdXQ/LmhlaWdodCwgTUlOX1dJREdFVF9IRUlHSFRfUENUKTtcbiAgICAgICAgICAgICAgICBjb25zdCBoID0gZGVmYXVsdE51bWJlcih1c2VyV2lkZ2V0TGF5b3V0Py5oZWlnaHQsIGRlZlJvb21IZWlnaHQpO1xuICAgICAgICAgICAgICAgIG1heEhlaWdodCA9IE1hdGgubWF4KG1heEhlaWdodCwgY2xhbXAoaCwgTUlOX1dJREdFVF9IRUlHSFRfUENULCAxMDApKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoZG9BdXRvYmFsYW5jZSkge1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB3aWR0aHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICB3aWR0aHNbaV0gPSAxMDAgLyB3aWR0aHMubGVuZ3RoO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gSWYgd2UncmUgbm90IGF1dG9iYWxhbmNpbmcgdGhlbiBpdCBtZWFucyB0aGF0IHdlJ3JlIHRyeWluZyB0byBtYWtlXG4gICAgICAgICAgICAvLyBzdXJlIHRoYXQgd2lkZ2V0cyBtYWtlIHVwIGV4YWN0bHkgMTAwJSBvZiBzcGFjZSAobm90IG92ZXIsIG5vdCB1bmRlcilcbiAgICAgICAgICAgIGNvbnN0IGRpZmZlcmVuY2UgPSBzdW0oLi4ud2lkdGhzKSAtIDEwMDsgLy8gcG9zaXRpdmUgPSBvdmVyLCBuZWdhdGl2ZSA9IHVuZGVyXG4gICAgICAgICAgICBpZiAoZGlmZmVyZW5jZSA8IDApIHtcbiAgICAgICAgICAgICAgICAvLyBGb3IgYSBkZWZpY2l0IHdlIGp1c3QgZmlsbCBldmVyeXRoaW5nIGluIGVxdWFsbHlcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHdpZHRocy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB3aWR0aHNbaV0gKz0gTWF0aC5hYnMoZGlmZmVyZW5jZSkgLyB3aWR0aHMubGVuZ3RoO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZGlmZmVyZW5jZSA+IDApIHtcbiAgICAgICAgICAgICAgICAvLyBXaGVuIHdlJ3JlIG92ZXIsIHdlIHRyeSB0byBzY2FsZSBhbGwgdGhlIHdpZGdldHMgd2l0aGluIHJhbmdlIGZpcnN0LlxuICAgICAgICAgICAgICAgIC8vIFdlIGNsYW1wIHZhbHVlcyB0byB0cnkgYW5kIGtlZXAgb3Vyc2VsdmVzIHNhbmUgYW5kIHdpdGhpbiByYW5nZS5cbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHdpZHRocy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB3aWR0aHNbaV0gPSBjbGFtcCh3aWR0aHNbaV0gLSAoZGlmZmVyZW5jZSAvIHdpZHRocy5sZW5ndGgpLCBNSU5fV0lER0VUX1dJRFRIX1BDVCwgMTAwKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvLyBJZiB3ZSdyZSBzdGlsbCBvdmVyLCBmaW5kIHRoZSB3aWRnZXRzIHdoaWNoIGhhdmUgbW9yZSB3aWR0aCB0aGFuIHRoZSBtaW5pbXVtXG4gICAgICAgICAgICAgICAgLy8gYW5kIGJhbGFuY2UgdGhlbSBvdXQgdW50aWwgd2UncmUgYXQgMTAwJS4gVGhpcyBzaG91bGQga2VlcCB1cyBhcyBjbG9zZSBhcyBwb3NzaWJsZVxuICAgICAgICAgICAgICAgIC8vIHRvIHRoZSBpbnRlbmRlZCBkaXN0cmlidXRpb25zLlxuICAgICAgICAgICAgICAgIC8vXG4gICAgICAgICAgICAgICAgLy8gTm90ZTogaWYgd2UgZXZlciBkZWNpZGUgdG8gc2V0IGEgbWluaW11bSB3aGljaCBpcyBsYXJnZXIgdGhhbiAxMDAlL01BWF9XSURHRVRTIHRoZW5cbiAgICAgICAgICAgICAgICAvLyB3ZSBwcm9iYWJseSBoYXZlIG90aGVyIGlzc3VlcyAtIHRoaXMgY29kZSBhc3N1bWVzIHdlIGRvbid0IGRvIHRoYXQuXG4gICAgICAgICAgICAgICAgY29uc3QgdG9SZWNsYWltID0gc3VtKC4uLndpZHRocykgLSAxMDA7XG4gICAgICAgICAgICAgICAgaWYgKHRvUmVjbGFpbSA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGFyZ2VJbmRpY2VzID0gd2lkdGhzXG4gICAgICAgICAgICAgICAgICAgICAgICAubWFwKCh2LCBpKSA9PiAoW2ksIHZdKSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIocCA9PiBwWzFdID4gTUlOX1dJREdFVF9XSURUSF9QQ1QpXG4gICAgICAgICAgICAgICAgICAgICAgICAubWFwKHAgPT4gcFswXSk7XG4gICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgaWR4IG9mIGxhcmdlSW5kaWNlcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGhzW2lkeF0gLT0gdG9SZWNsYWltIC8gbGFyZ2VJbmRpY2VzLmxlbmd0aDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEZpbmFsbHksIGZpbGwgaW4gb3VyIGNhY2hlIGFuZCB1cGRhdGVcbiAgICAgICAgdGhpcy5ieVJvb21bcm9vbS5yb29tSWRdID0ge307XG4gICAgICAgIGlmICh0b3BXaWRnZXRzLmxlbmd0aCkge1xuICAgICAgICAgICAgdGhpcy5ieVJvb21bcm9vbS5yb29tSWRdW0NvbnRhaW5lci5Ub3BdID0ge1xuICAgICAgICAgICAgICAgIG9yZGVyZWQ6IHRvcFdpZGdldHMsXG4gICAgICAgICAgICAgICAgZGlzdHJpYnV0aW9uczogd2lkdGhzLFxuICAgICAgICAgICAgICAgIGhlaWdodDogbWF4SGVpZ2h0LFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmlnaHRXaWRnZXRzLmxlbmd0aCkge1xuICAgICAgICAgICAgdGhpcy5ieVJvb21bcm9vbS5yb29tSWRdW0NvbnRhaW5lci5SaWdodF0gPSB7XG4gICAgICAgICAgICAgICAgb3JkZXJlZDogcmlnaHRXaWRnZXRzLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoY2VudGVyV2lkZ2V0cy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoaXMuYnlSb29tW3Jvb20ucm9vbUlkXVtDb250YWluZXIuQ2VudGVyXSA9IHtcbiAgICAgICAgICAgICAgICBvcmRlcmVkOiBjZW50ZXJXaWRnZXRzLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGFmdGVyQ2hhbmdlcyA9IEpTT04uc3RyaW5naWZ5KHRoaXMuYnlSb29tW3Jvb20ucm9vbUlkXSk7XG4gICAgICAgIGlmIChhZnRlckNoYW5nZXMgIT09IGJlZm9yZUNoYW5nZXMpIHtcbiAgICAgICAgICAgIHRoaXMuZW1pdEZvcihyb29tKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBnZXRDb250YWluZXJXaWRnZXRzKHJvb206IFJvb20sIGNvbnRhaW5lcjogQ29udGFpbmVyKTogSUFwcFtdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYnlSb29tW3Jvb20/LnJvb21JZF0/Lltjb250YWluZXJdPy5vcmRlcmVkIHx8IFtdO1xuICAgIH1cblxuICAgIHB1YmxpYyBpc0luQ29udGFpbmVyKHJvb206IFJvb20sIHdpZGdldDogSUFwcCwgY29udGFpbmVyOiBDb250YWluZXIpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Q29udGFpbmVyV2lkZ2V0cyhyb29tLCBjb250YWluZXIpLnNvbWUodyA9PiB3LmlkID09PSB3aWRnZXQuaWQpO1xuICAgIH1cblxuICAgIHB1YmxpYyBjYW5BZGRUb0NvbnRhaW5lcihyb29tOiBSb29tLCBjb250YWluZXI6IENvbnRhaW5lcik6IGJvb2xlYW4ge1xuICAgICAgICBzd2l0Y2ggKGNvbnRhaW5lcikge1xuICAgICAgICAgICAgY2FzZSBDb250YWluZXIuVG9wOiByZXR1cm4gdGhpcy5nZXRDb250YWluZXJXaWRnZXRzKHJvb20sIGNvbnRhaW5lcikubGVuZ3RoIDwgTUFYX1BJTk5FRDtcbiAgICAgICAgICAgIGNhc2UgQ29udGFpbmVyLlJpZ2h0OiByZXR1cm4gdGhpcy5nZXRDb250YWluZXJXaWRnZXRzKHJvb20sIGNvbnRhaW5lcikubGVuZ3RoIDwgTUFYX1BJTk5FRDtcbiAgICAgICAgICAgIGNhc2UgQ29udGFpbmVyLkNlbnRlcjogcmV0dXJuIHRoaXMuZ2V0Q29udGFpbmVyV2lkZ2V0cyhyb29tLCBjb250YWluZXIpLmxlbmd0aCA8IDE7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0UmVzaXplckRpc3RyaWJ1dGlvbnMocm9vbTogUm9vbSwgY29udGFpbmVyOiBDb250YWluZXIpOiBzdHJpbmdbXSB7IC8vIHllcywgc3RyaW5nLlxuICAgICAgICBsZXQgZGlzdHJpYnV0aW9ucyA9IHRoaXMuYnlSb29tW3Jvb20ucm9vbUlkXT8uW2NvbnRhaW5lcl0/LmRpc3RyaWJ1dGlvbnM7XG4gICAgICAgIGlmICghZGlzdHJpYnV0aW9ucyB8fCBkaXN0cmlidXRpb25zLmxlbmd0aCA8IDIpIHJldHVybiBbXTtcblxuICAgICAgICAvLyBUaGUgZGlzdHJpYnV0b3IgYWN0dWFsbHkgZXhwZWN0cyB0byBiZSBmZWQgTi0xIHNpemVzIGFuZCBleHBhbmRzIHRoZSBtaWRkbGUgc2VjdGlvblxuICAgICAgICAvLyBpbnN0ZWFkIG9mIHRoZSBlZGdlcy4gVGhlcmVmb3JlLCB3ZSBuZWVkIHRvIHJldHVybiBbMF0gd2hlbiB0aGVyZSdzIHR3byB3aWRnZXRzIG9yXG4gICAgICAgIC8vIFswLCAyXSB3aGVuIHRoZXJlJ3MgdGhyZWUgKHNraXBwaW5nIFsxXSBiZWNhdXNlIGl0J3MgaXJyZWxldmFudCkuXG5cbiAgICAgICAgaWYgKGRpc3RyaWJ1dGlvbnMubGVuZ3RoID09PSAyKSBkaXN0cmlidXRpb25zID0gW2Rpc3RyaWJ1dGlvbnNbMF1dO1xuICAgICAgICBpZiAoZGlzdHJpYnV0aW9ucy5sZW5ndGggPT09IDMpIGRpc3RyaWJ1dGlvbnMgPSBbZGlzdHJpYnV0aW9uc1swXSwgZGlzdHJpYnV0aW9uc1syXV07XG4gICAgICAgIHJldHVybiBkaXN0cmlidXRpb25zLm1hcChkID0+IGAke2QudG9GaXhlZCgxKX0lYCk7IC8vIGFjdHVhbCBwZXJjZW50cyAtIHRoZXNlIGFyZSBkZWNvZGVkIGxhdGVyXG4gICAgfVxuXG4gICAgcHVibGljIHNldFJlc2l6ZXJEaXN0cmlidXRpb25zKHJvb206IFJvb20sIGNvbnRhaW5lcjogQ29udGFpbmVyLCBkaXN0cmlidXRpb25zOiBzdHJpbmdbXSkge1xuICAgICAgICBpZiAoY29udGFpbmVyICE9PSBDb250YWluZXIuVG9wKSByZXR1cm47IC8vIGlnbm9yZSAtIG5vdCByZWxldmFudFxuXG4gICAgICAgIGNvbnN0IG51bWJlcnMgPSBkaXN0cmlidXRpb25zLm1hcChkID0+IE51bWJlcihOdW1iZXIoZC5zdWJzdHJpbmcoMCwgZC5sZW5ndGggLSAxKSkudG9GaXhlZCgxKSkpO1xuICAgICAgICBjb25zdCB3aWRnZXRzID0gdGhpcy5nZXRDb250YWluZXJXaWRnZXRzKHJvb20sIGNvbnRhaW5lcik7XG5cbiAgICAgICAgLy8gRnJvbSBnZXRSZXNpemVyRGlzdHJpYnV0aW9ucywgd2UgbmVlZCB0byBmaWxsIGluIHRoZSBtaWRkbGUgc2l6ZSBpZiBhcHBsaWNhYmxlLlxuICAgICAgICBjb25zdCByZW1haW5pbmcgPSAxMDAgLSBzdW0oLi4ubnVtYmVycyk7XG4gICAgICAgIGlmIChudW1iZXJzLmxlbmd0aCA9PT0gMikgbnVtYmVycy5zcGxpY2UoMSwgMCwgcmVtYWluaW5nKTtcbiAgICAgICAgaWYgKG51bWJlcnMubGVuZ3RoID09PSAxKSBudW1iZXJzLnB1c2gocmVtYWluaW5nKTtcblxuICAgICAgICBjb25zdCBsb2NhbExheW91dCA9IHt9O1xuICAgICAgICB3aWRnZXRzLmZvckVhY2goKHcsIGkpID0+IHtcbiAgICAgICAgICAgIGxvY2FsTGF5b3V0W3cuaWRdID0ge1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lcjogY29udGFpbmVyLFxuICAgICAgICAgICAgICAgIHdpZHRoOiBudW1iZXJzW2ldLFxuICAgICAgICAgICAgICAgIGluZGV4OiBpLFxuICAgICAgICAgICAgICAgIGhlaWdodDogdGhpcy5ieVJvb21bcm9vbS5yb29tSWRdPy5bY29udGFpbmVyXT8uaGVpZ2h0IHx8IE1JTl9XSURHRVRfSEVJR0hUX1BDVCxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnVwZGF0ZVVzZXJMYXlvdXQocm9vbSwgbG9jYWxMYXlvdXQpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRDb250YWluZXJIZWlnaHQocm9vbTogUm9vbSwgY29udGFpbmVyOiBDb250YWluZXIpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5ieVJvb21bcm9vbS5yb29tSWRdPy5bY29udGFpbmVyXT8uaGVpZ2h0OyAvLyBsZXQgdGhlIGRlZmF1bHQgZ2V0IHJldHVybmVkIGlmIG5lZWRlZFxuICAgIH1cblxuICAgIHB1YmxpYyBzZXRDb250YWluZXJIZWlnaHQocm9vbTogUm9vbSwgY29udGFpbmVyOiBDb250YWluZXIsIGhlaWdodDogbnVtYmVyKSB7XG4gICAgICAgIGNvbnN0IHdpZGdldHMgPSB0aGlzLmdldENvbnRhaW5lcldpZGdldHMocm9vbSwgY29udGFpbmVyKTtcbiAgICAgICAgY29uc3Qgd2lkdGhzID0gdGhpcy5ieVJvb21bcm9vbS5yb29tSWRdPy5bY29udGFpbmVyXT8uZGlzdHJpYnV0aW9ucztcbiAgICAgICAgY29uc3QgbG9jYWxMYXlvdXQgPSB7fTtcbiAgICAgICAgd2lkZ2V0cy5mb3JFYWNoKCh3LCBpKSA9PiB7XG4gICAgICAgICAgICBsb2NhbExheW91dFt3LmlkXSA9IHtcbiAgICAgICAgICAgICAgICBjb250YWluZXI6IGNvbnRhaW5lcixcbiAgICAgICAgICAgICAgICB3aWR0aDogd2lkdGhzW2ldLFxuICAgICAgICAgICAgICAgIGluZGV4OiBpLFxuICAgICAgICAgICAgICAgIGhlaWdodDogaGVpZ2h0LFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMudXBkYXRlVXNlckxheW91dChyb29tLCBsb2NhbExheW91dCk7XG4gICAgfVxuXG4gICAgcHVibGljIG1vdmVXaXRoaW5Db250YWluZXIocm9vbTogUm9vbSwgY29udGFpbmVyOiBDb250YWluZXIsIHdpZGdldDogSUFwcCwgZGVsdGE6IG51bWJlcikge1xuICAgICAgICBjb25zdCB3aWRnZXRzID0gYXJyYXlGYXN0Q2xvbmUodGhpcy5nZXRDb250YWluZXJXaWRnZXRzKHJvb20sIGNvbnRhaW5lcikpO1xuICAgICAgICBjb25zdCBjdXJyZW50SWR4ID0gd2lkZ2V0cy5maW5kSW5kZXgodyA9PiB3LmlkID09PSB3aWRnZXQuaWQpO1xuICAgICAgICBpZiAoY3VycmVudElkeCA8IDApIHJldHVybjsgLy8gbm8gY2hhbmdlIG5lZWRlZFxuXG4gICAgICAgIHdpZGdldHMuc3BsaWNlKGN1cnJlbnRJZHgsIDEpOyAvLyByZW1vdmUgZXhpc3Rpbmcgd2lkZ2V0XG4gICAgICAgIGNvbnN0IG5ld0lkeCA9IGNsYW1wKGN1cnJlbnRJZHggKyBkZWx0YSwgMCwgd2lkZ2V0cy5sZW5ndGgpO1xuICAgICAgICB3aWRnZXRzLnNwbGljZShuZXdJZHgsIDAsIHdpZGdldCk7XG5cbiAgICAgICAgY29uc3Qgd2lkdGhzID0gdGhpcy5ieVJvb21bcm9vbS5yb29tSWRdPy5bY29udGFpbmVyXT8uZGlzdHJpYnV0aW9ucztcbiAgICAgICAgY29uc3QgaGVpZ2h0ID0gdGhpcy5ieVJvb21bcm9vbS5yb29tSWRdPy5bY29udGFpbmVyXT8uaGVpZ2h0O1xuICAgICAgICBjb25zdCBsb2NhbExheW91dCA9IHt9O1xuICAgICAgICB3aWRnZXRzLmZvckVhY2goKHcsIGkpID0+IHtcbiAgICAgICAgICAgIGxvY2FsTGF5b3V0W3cuaWRdID0ge1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lcjogY29udGFpbmVyLFxuICAgICAgICAgICAgICAgIHdpZHRoOiB3aWR0aHNbaV0sXG4gICAgICAgICAgICAgICAgaW5kZXg6IGksXG4gICAgICAgICAgICAgICAgaGVpZ2h0OiBoZWlnaHQsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy51cGRhdGVVc2VyTGF5b3V0KHJvb20sIGxvY2FsTGF5b3V0KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgbW92ZVRvQ29udGFpbmVyKHJvb206IFJvb20sIHdpZGdldDogSUFwcCwgdG9Db250YWluZXI6IENvbnRhaW5lcikge1xuICAgICAgICBjb25zdCBhbGxXaWRnZXRzID0gdGhpcy5nZXRBbGxXaWRnZXRzKHJvb20pO1xuICAgICAgICBpZiAoIWFsbFdpZGdldHMuc29tZSgoW3ddKSA9PiB3LmlkID09PSB3aWRnZXQuaWQpKSByZXR1cm47IC8vIGludmFsaWRcbiAgICAgICAgLy8gUHJlcGFyZSBvdGhlciBjb250YWluZXJzIChwb3RlbnRpYWxseSBtb3ZlIHdpZGdldHMgdG8gb2JheSB0aGUgZm9sbG93aW5nIHJ1bGVzKVxuICAgICAgICBzd2l0Y2ggKHRvQ29udGFpbmVyKSB7XG4gICAgICAgICAgICBjYXNlIENvbnRhaW5lci5SaWdodDpcbiAgICAgICAgICAgICAgICAvLyBuZXcgXCJyaWdodFwiIHdpZGdldFxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBDb250YWluZXIuQ2VudGVyOlxuICAgICAgICAgICAgICAgIC8vIG5ldyBcImNlbnRlclwiIHdpZGdldCA9PiBhbGwgb3RoZXIgd2lkZ2V0cyBnbyBpbnRvIFwicmlnaHRcIlxuICAgICAgICAgICAgICAgIGZvciAoY29uc3QgdyBvZiB0aGlzLmdldENvbnRhaW5lcldpZGdldHMocm9vbSwgQ29udGFpbmVyLlRvcCkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb3ZlVG9Db250YWluZXIocm9vbSwgdywgQ29udGFpbmVyLlJpZ2h0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCB3IG9mIHRoaXMuZ2V0Q29udGFpbmVyV2lkZ2V0cyhyb29tLCBDb250YWluZXIuQ2VudGVyKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm1vdmVUb0NvbnRhaW5lcihyb29tLCB3LCBDb250YWluZXIuUmlnaHQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgQ29udGFpbmVyLlRvcDpcbiAgICAgICAgICAgICAgICAvLyBuZXcgXCJ0b3BcIiB3aWRnZXQgPT4gdGhlIGNlbnRlciB3aWRnZXQgbW92ZXMgaW50byBcInJpZ2h0XCJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNNYXhpbWlzZWRXaWRnZXQocm9vbSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb3ZlVG9Db250YWluZXIocm9vbSwgdGhpcy5nZXRDb250YWluZXJXaWRnZXRzKHJvb20sIENvbnRhaW5lci5DZW50ZXIpWzBdLCBDb250YWluZXIuUmlnaHQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIG1vdmUgd2lkZ2V0cyBpbnRvIHJlcXVlc3RlZCBjb250YWluZXIuXG4gICAgICAgIHRoaXMudXBkYXRlVXNlckxheW91dChyb29tLCB7XG4gICAgICAgICAgICBbd2lkZ2V0LmlkXTogeyBjb250YWluZXI6IHRvQ29udGFpbmVyIH0sXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBoYXNNYXhpbWlzZWRXaWRnZXQocm9vbTogUm9vbSkge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRDb250YWluZXJXaWRnZXRzKHJvb20sIENvbnRhaW5lci5DZW50ZXIpLmxlbmd0aCA+IDA7XG4gICAgfVxuXG4gICAgcHVibGljIGhhc1Bpbm5lZFdpZGdldHMocm9vbTogUm9vbSkge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRDb250YWluZXJXaWRnZXRzKHJvb20sIENvbnRhaW5lci5Ub3ApLmxlbmd0aCA+IDA7XG4gICAgfVxuXG4gICAgcHVibGljIGNhbkNvcHlMYXlvdXRUb1Jvb20ocm9vbTogUm9vbSk6IGJvb2xlYW4ge1xuICAgICAgICBpZiAoIXRoaXMubWF0cml4Q2xpZW50KSByZXR1cm4gZmFsc2U7IC8vIG5vdCByZWFkeSB5ZXRcbiAgICAgICAgcmV0dXJuIHJvb20uY3VycmVudFN0YXRlLm1heVNlbmRTdGF0ZUV2ZW50KFdJREdFVF9MQVlPVVRfRVZFTlRfVFlQRSwgdGhpcy5tYXRyaXhDbGllbnQuZ2V0VXNlcklkKCkpO1xuICAgIH1cblxuICAgIHB1YmxpYyBjb3B5TGF5b3V0VG9Sb29tKHJvb206IFJvb20pIHtcbiAgICAgICAgY29uc3QgYWxsV2lkZ2V0cyA9IHRoaXMuZ2V0QWxsV2lkZ2V0cyhyb29tKTtcbiAgICAgICAgY29uc3QgZXZDb250ZW50OiBJTGF5b3V0U3RhdGVFdmVudCA9IHsgd2lkZ2V0czoge30gfTtcbiAgICAgICAgZm9yIChjb25zdCBbd2lkZ2V0LCBjb250YWluZXJdIG9mIGFsbFdpZGdldHMpIHtcbiAgICAgICAgICAgIGV2Q29udGVudC53aWRnZXRzW3dpZGdldC5pZF0gPSB7IGNvbnRhaW5lciB9O1xuICAgICAgICAgICAgaWYgKGNvbnRhaW5lciA9PT0gQ29udGFpbmVyLlRvcCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lcldpZGdldHMgPSB0aGlzLmdldENvbnRhaW5lcldpZGdldHMocm9vbSwgY29udGFpbmVyKTtcbiAgICAgICAgICAgICAgICBjb25zdCBpZHggPSBjb250YWluZXJXaWRnZXRzLmZpbmRJbmRleCh3ID0+IHcuaWQgPT09IHdpZGdldC5pZCk7XG4gICAgICAgICAgICAgICAgY29uc3Qgd2lkdGhzID0gdGhpcy5ieVJvb21bcm9vbS5yb29tSWRdPy5bY29udGFpbmVyXT8uZGlzdHJpYnV0aW9ucztcbiAgICAgICAgICAgICAgICBjb25zdCBoZWlnaHQgPSB0aGlzLmJ5Um9vbVtyb29tLnJvb21JZF0/Lltjb250YWluZXJdPy5oZWlnaHQ7XG4gICAgICAgICAgICAgICAgZXZDb250ZW50LndpZGdldHNbd2lkZ2V0LmlkXSA9IHtcbiAgICAgICAgICAgICAgICAgICAgLi4uZXZDb250ZW50LndpZGdldHNbd2lkZ2V0LmlkXSxcbiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiBoZWlnaHQgPyBNYXRoLnJvdW5kKGhlaWdodCkgOiBudWxsLFxuICAgICAgICAgICAgICAgICAgICB3aWR0aDogd2lkdGhzW2lkeF0gPyBNYXRoLnJvdW5kKHdpZHRoc1tpZHhdKSA6IG51bGwsXG4gICAgICAgICAgICAgICAgICAgIGluZGV4OiBpZHgsXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLm1hdHJpeENsaWVudC5zZW5kU3RhdGVFdmVudChyb29tLnJvb21JZCwgV0lER0VUX0xBWU9VVF9FVkVOVF9UWVBFLCBldkNvbnRlbnQsIFwiXCIpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0QWxsV2lkZ2V0cyhyb29tOiBSb29tKTogW0lBcHAsIENvbnRhaW5lcl1bXSB7XG4gICAgICAgIGNvbnN0IGNvbnRhaW5lcnMgPSB0aGlzLmJ5Um9vbVtyb29tLnJvb21JZF07XG4gICAgICAgIGlmICghY29udGFpbmVycykgcmV0dXJuIFtdO1xuXG4gICAgICAgIGNvbnN0IHJldCA9IFtdO1xuICAgICAgICBmb3IgKGNvbnN0IGNvbnRhaW5lciBvZiBPYmplY3Qua2V5cyhjb250YWluZXJzKSkge1xuICAgICAgICAgICAgY29uc3Qgd2lkZ2V0cyA9IGNvbnRhaW5lcnNbY29udGFpbmVyXS5vcmRlcmVkO1xuICAgICAgICAgICAgZm9yIChjb25zdCB3aWRnZXQgb2Ygd2lkZ2V0cykge1xuICAgICAgICAgICAgICAgIHJldC5wdXNoKFt3aWRnZXQsIGNvbnRhaW5lcl0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB1cGRhdGVVc2VyTGF5b3V0KHJvb206IFJvb20sIG5ld0xheW91dDogSVdpZGdldExheW91dHMpIHtcbiAgICAgICAgLy8gUG9seWZpbGwgYW55IG1pc3Npbmcgd2lkZ2V0c1xuICAgICAgICBjb25zdCBhbGxXaWRnZXRzID0gdGhpcy5nZXRBbGxXaWRnZXRzKHJvb20pO1xuICAgICAgICBmb3IgKGNvbnN0IFt3aWRnZXQsIGNvbnRhaW5lcl0gb2YgYWxsV2lkZ2V0cykge1xuICAgICAgICAgICAgY29uc3QgY29udGFpbmVyV2lkZ2V0cyA9IHRoaXMuZ2V0Q29udGFpbmVyV2lkZ2V0cyhyb29tLCBjb250YWluZXIpO1xuICAgICAgICAgICAgY29uc3QgaWR4ID0gY29udGFpbmVyV2lkZ2V0cy5maW5kSW5kZXgodyA9PiB3LmlkID09PSB3aWRnZXQuaWQpO1xuICAgICAgICAgICAgY29uc3Qgd2lkdGhzID0gdGhpcy5ieVJvb21bcm9vbS5yb29tSWRdPy5bY29udGFpbmVyXT8uZGlzdHJpYnV0aW9ucztcbiAgICAgICAgICAgIGlmICghbmV3TGF5b3V0W3dpZGdldC5pZF0pIHtcbiAgICAgICAgICAgICAgICBuZXdMYXlvdXRbd2lkZ2V0LmlkXSA9IHtcbiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyOiBjb250YWluZXIsXG4gICAgICAgICAgICAgICAgICAgIGluZGV4OiBpZHgsXG4gICAgICAgICAgICAgICAgICAgIGhlaWdodDogdGhpcy5ieVJvb21bcm9vbS5yb29tSWRdPy5bY29udGFpbmVyXT8uaGVpZ2h0LFxuICAgICAgICAgICAgICAgICAgICB3aWR0aDogd2lkdGhzPy5baWR4XSxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgbGF5b3V0RXYgPSByb29tLmN1cnJlbnRTdGF0ZS5nZXRTdGF0ZUV2ZW50cyhXSURHRVRfTEFZT1VUX0VWRU5UX1RZUEUsIFwiXCIpO1xuICAgICAgICBTZXR0aW5nc1N0b3JlLnNldFZhbHVlKFwiV2lkZ2V0cy5sYXlvdXRcIiwgcm9vbS5yb29tSWQsIFNldHRpbmdMZXZlbC5ST09NX0FDQ09VTlQsIHtcbiAgICAgICAgICAgIG92ZXJyaWRlczogbGF5b3V0RXY/LmdldElkKCksXG4gICAgICAgICAgICB3aWRnZXRzOiBuZXdMYXlvdXQsXG4gICAgICAgIH0pLmNhdGNoKCgpID0+IHRoaXMucmVjYWxjdWxhdGVSb29tKHJvb20pKTtcbiAgICAgICAgdGhpcy5yZWNhbGN1bGF0ZVJvb20ocm9vbSk7IC8vIGNhbGwgdG8gdHJ5IGxvY2FsIGVjaG8gb24gY2hhbmdlcyAodGhlIGNhdGNoIGFib3ZlIHVuZG9lcyBhbnkgZXJyb3JzKVxuICAgIH1cbn1cblxud2luZG93Lm14V2lkZ2V0TGF5b3V0U3RvcmUgPSBXaWRnZXRMYXlvdXRTdG9yZS5pbnN0YW5jZTtcbiJdfQ==