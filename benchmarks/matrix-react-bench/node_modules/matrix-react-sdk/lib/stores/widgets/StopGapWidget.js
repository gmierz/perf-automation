"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.StopGapWidget = exports.ElementWidget = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _matrixWidgetApi = require("matrix-widget-api");

var _StopGapWidgetDriver = require("./StopGapWidgetDriver");

var _events = require("events");

var _WidgetMessagingStore = require("./WidgetMessagingStore");

var _RoomViewStore = _interopRequireDefault(require("../RoomViewStore"));

var _MatrixClientPeg = require("../../MatrixClientPeg");

var _OwnProfileStore = require("../OwnProfileStore");

var _WidgetUtils = _interopRequireDefault(require("../../utils/WidgetUtils"));

var _IntegrationManagers = require("../../integrations/IntegrationManagers");

var _SettingsStore = _interopRequireDefault(require("../../settings/SettingsStore"));

var _WidgetType = require("../../widgets/WidgetType");

var _ActiveWidgetStore = _interopRequireDefault(require("../ActiveWidgetStore"));

var _objects = require("../../utils/objects");

var _dispatcher = _interopRequireDefault(require("../../dispatcher/dispatcher"));

var _actions = require("../../dispatcher/actions");

var _ElementWidgetActions = require("./ElementWidgetActions");

var _ModalWidgetStore = require("../ModalWidgetStore");

var _ThemeWatcher = _interopRequireDefault(require("../../settings/watchers/ThemeWatcher"));

var _theme = require("../../theme");

var _CountlyAnalytics = _interopRequireDefault(require("../../CountlyAnalytics"));

var _ElementWidgetCapabilities = require("./ElementWidgetCapabilities");

var _identifiers = require("../../identifiers");

var _languageHandler = require("../../languageHandler");

var _WidgetVariables = require("../../customisations/WidgetVariables");

var _arrays = require("../../utils/arrays");

var _logger = require("matrix-js-sdk/src/logger");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

// TODO: Don't use this because it's wrong
class ElementWidget extends _matrixWidgetApi.Widget {
  constructor(rawDefinition) {
    super(rawDefinition);
    this.rawDefinition = rawDefinition;
  }

  get templateUrl() {
    if (_WidgetType.WidgetType.JITSI.matches(this.type)) {
      var _super$rawData;

      return _WidgetUtils.default.getLocalJitsiWrapperUrl({
        forLocalRender: true,
        auth: (_super$rawData = super.rawData) === null || _super$rawData === void 0 ? void 0 : _super$rawData.auth // this.rawData can call templateUrl, do this to prevent looping

      });
    }

    return super.templateUrl;
  }

  get popoutTemplateUrl() {
    if (_WidgetType.WidgetType.JITSI.matches(this.type)) {
      var _super$rawData2;

      return _WidgetUtils.default.getLocalJitsiWrapperUrl({
        forLocalRender: false,
        // The only important difference between this and templateUrl()
        auth: (_super$rawData2 = super.rawData) === null || _super$rawData2 === void 0 ? void 0 : _super$rawData2.auth
      });
    }

    return this.templateUrl; // use this instead of super to ensure we get appropriate templating
  }

  get rawData() {
    let conferenceId = super.rawData['conferenceId'];

    if (conferenceId === undefined) {
      // we'll need to parse the conference ID out of the URL for v1 Jitsi widgets
      const parsedUrl = new URL(super.templateUrl); // use super to get the raw widget URL

      conferenceId = parsedUrl.searchParams.get("confId");
    }

    let domain = super.rawData['domain'];

    if (domain === undefined) {
      // v1 widgets default to jitsi.riot.im regardless of user settings
      domain = "jitsi.riot.im";
    }

    let theme = new _ThemeWatcher.default().getEffectiveTheme();

    if (theme.startsWith("custom-")) {
      const customTheme = (0, _theme.getCustomTheme)(theme.substr(7)); // Jitsi only understands light/dark

      theme = customTheme.is_dark ? "dark" : "light";
    } // only allow light/dark through, defaulting to dark as that was previously the only state
    // accounts for legacy-light/legacy-dark themes too


    if (theme.includes("light")) {
      theme = "light";
    } else {
      theme = "dark";
    }

    return _objectSpread(_objectSpread({}, super.rawData), {}, {
      theme,
      conferenceId,
      domain
    });
  }

  getCompleteUrl(params, asPopout = false) {
    return (0, _matrixWidgetApi.runTemplate)(asPopout ? this.popoutTemplateUrl : this.templateUrl, _objectSpread(_objectSpread({}, this.rawDefinition), {}, {
      data: this.rawData
    }), params);
  }

}

exports.ElementWidget = ElementWidget;

class StopGapWidget extends _events.EventEmitter {
  // room ID to event ID
  constructor(appTileProps) {
    var _appTileProps$room;

    super();
    this.appTileProps = appTileProps;
    (0, _defineProperty2.default)(this, "messaging", void 0);
    (0, _defineProperty2.default)(this, "mockWidget", void 0);
    (0, _defineProperty2.default)(this, "scalarToken", void 0);
    (0, _defineProperty2.default)(this, "roomId", void 0);
    (0, _defineProperty2.default)(this, "kind", void 0);
    (0, _defineProperty2.default)(this, "readUpToMap", {});
    (0, _defineProperty2.default)(this, "onOpenModal", async ev => {
      ev.preventDefault();

      if (_ModalWidgetStore.ModalWidgetStore.instance.canOpenModalWidget()) {
        _ModalWidgetStore.ModalWidgetStore.instance.openModalWidget(ev.detail.data, this.mockWidget);

        this.messaging.transport.reply(ev.detail, {}); // ack
      } else {
        this.messaging.transport.reply(ev.detail, {
          error: {
            message: "Unable to open modal at this time"
          }
        });
      }
    });
    (0, _defineProperty2.default)(this, "onEvent", ev => {
      _MatrixClientPeg.MatrixClientPeg.get().decryptEventIfNeeded(ev);

      if (ev.isBeingDecrypted() || ev.isDecryptionFailure()) return;
      this.feedEvent(ev);
    });
    (0, _defineProperty2.default)(this, "onEventDecrypted", ev => {
      if (ev.isDecryptionFailure()) return;
      this.feedEvent(ev);
    });
    let app = appTileProps.app; // Backwards compatibility: not all old widgets have a creatorUserId

    if (!app.creatorUserId) {
      app = (0, _objects.objectShallowClone)(app); // clone to prevent accidental mutation

      app.creatorUserId = _MatrixClientPeg.MatrixClientPeg.get().getUserId();
    }

    this.mockWidget = new ElementWidget(app);
    this.roomId = (_appTileProps$room = appTileProps.room) === null || _appTileProps$room === void 0 ? void 0 : _appTileProps$room.roomId;
    this.kind = appTileProps.userWidget ? _matrixWidgetApi.WidgetKind.Account : _matrixWidgetApi.WidgetKind.Room; // probably
  }

  get eventListenerRoomId() {
    // When widgets are listening to events, we need to make sure they're only
    // receiving events for the right room. In particular, room widgets get locked
    // to the room they were added in while account widgets listen to the currently
    // active room.
    if (this.roomId) return this.roomId;
    return _RoomViewStore.default.getRoomId();
  }

  get widgetApi() {
    return this.messaging;
  }
  /**
   * The URL to use in the iframe
   */


  get embedUrl() {
    return this.runUrlTemplate({
      asPopout: false
    });
  }
  /**
   * The URL to use in the popout
   */


  get popoutUrl() {
    return this.runUrlTemplate({
      asPopout: true
    });
  }

  runUrlTemplate(opts = {
    asPopout: false
  }) {
    var _WidgetVariableCustom;

    const fromCustomisation = (_WidgetVariables.WidgetVariableCustomisations === null || _WidgetVariables.WidgetVariableCustomisations === void 0 ? void 0 : (_WidgetVariableCustom = _WidgetVariables.WidgetVariableCustomisations.provideVariables) === null || _WidgetVariableCustom === void 0 ? void 0 : _WidgetVariableCustom.call(_WidgetVariables.WidgetVariableCustomisations)) ?? {};
    const defaults = {
      widgetRoomId: this.roomId,
      currentUserId: _MatrixClientPeg.MatrixClientPeg.get().getUserId(),
      userDisplayName: _OwnProfileStore.OwnProfileStore.instance.displayName,
      userHttpAvatarUrl: _OwnProfileStore.OwnProfileStore.instance.getHttpAvatarUrl(),
      clientId: _identifiers.ELEMENT_CLIENT_ID,
      clientTheme: _SettingsStore.default.getValue("theme"),
      clientLanguage: (0, _languageHandler.getUserLanguage)()
    };
    const templated = this.mockWidget.getCompleteUrl(Object.assign(defaults, fromCustomisation), opts === null || opts === void 0 ? void 0 : opts.asPopout);
    const parsed = new URL(templated); // Add in some legacy support sprinkles (for non-popout widgets)
    // TODO: Replace these with proper widget params
    // See https://github.com/matrix-org/matrix-doc/pull/1958/files#r405714833

    if (!(opts !== null && opts !== void 0 && opts.asPopout)) {
      parsed.searchParams.set('widgetId', this.mockWidget.id);
      parsed.searchParams.set('parentUrl', window.location.href.split('#', 2)[0]); // Give the widget a scalar token if we're supposed to (more legacy)
      // TODO: Stop doing this

      if (this.scalarToken) {
        parsed.searchParams.set('scalar_token', this.scalarToken);
      }
    } // Replace the encoded dollar signs back to dollar signs. They have no special meaning
    // in HTTP, but URL parsers encode them anyways.


    return parsed.toString().replace(/%24/g, '$');
  }

  get isManagedByManager() {
    return !!this.scalarToken;
  }

  get started() {
    return !!this.messaging;
  }

  get widgetId() {
    return this.messaging.widget.id;
  }

  start(iframe) {
    if (this.started) return;
    const allowedCapabilities = this.appTileProps.whitelistCapabilities || [];
    const driver = new _StopGapWidgetDriver.StopGapWidgetDriver(allowedCapabilities, this.mockWidget, this.kind, this.roomId);
    this.messaging = new _matrixWidgetApi.ClientWidgetApi(this.mockWidget, iframe, driver);
    this.messaging.on("preparing", () => this.emit("preparing"));
    this.messaging.on("ready", () => this.emit("ready"));
    this.messaging.on("capabilitiesNotified", () => this.emit("capabilitiesNotified"));
    this.messaging.on(`action:${_matrixWidgetApi.WidgetApiFromWidgetAction.OpenModalWidget}`, this.onOpenModal);

    _WidgetMessagingStore.WidgetMessagingStore.instance.storeMessaging(this.mockWidget, this.messaging);

    if (!this.appTileProps.userWidget && this.appTileProps.room) {
      _ActiveWidgetStore.default.instance.setRoomId(this.mockWidget.id, this.appTileProps.room.roomId);
    } // Always attach a handler for ViewRoom, but permission check it internally


    this.messaging.on(`action:${_ElementWidgetActions.ElementWidgetActions.ViewRoom}`, ev => {
      ev.preventDefault(); // stop the widget API from auto-rejecting this
      // Check up front if this is even a valid request

      const targetRoomId = (ev.detail.data || {}).room_id;

      if (!targetRoomId) {
        return this.messaging.transport.reply(ev.detail, {
          error: {
            message: "Room ID not supplied."
          }
        });
      } // Check the widget's permission


      if (!this.messaging.hasCapability(_ElementWidgetCapabilities.ElementWidgetCapabilities.CanChangeViewedRoom)) {
        return this.messaging.transport.reply(ev.detail, {
          error: {
            message: "This widget does not have permission for this action (denied)."
          }
        });
      } // at this point we can change rooms, so do that


      _dispatcher.default.dispatch({
        action: _actions.Action.ViewRoom,
        room_id: targetRoomId
      }); // acknowledge so the widget doesn't freak out


      this.messaging.transport.reply(ev.detail, {});
    }); // Populate the map of "read up to" events for this widget with the current event in every room.
    // This is a bit inefficient, but should be okay. We do this for all rooms in case the widget
    // requests timeline capabilities in other rooms down the road. It's just easier to manage here.

    for (const room of _MatrixClientPeg.MatrixClientPeg.get().getRooms()) {
      var _room$getLiveTimeline;

      // Timelines are most recent last
      const events = ((_room$getLiveTimeline = room.getLiveTimeline()) === null || _room$getLiveTimeline === void 0 ? void 0 : _room$getLiveTimeline.getEvents()) || [];
      const roomEvent = events[events.length - 1];
      if (!roomEvent) continue; // force later code to think the room is fresh

      this.readUpToMap[room.roomId] = roomEvent.getId();
    } // Attach listeners for feeding events - the underlying widget classes handle permissions for us


    _MatrixClientPeg.MatrixClientPeg.get().on('event', this.onEvent);

    _MatrixClientPeg.MatrixClientPeg.get().on('Event.decrypted', this.onEventDecrypted);

    this.messaging.on(`action:${_matrixWidgetApi.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen}`, ev => {
      if (this.messaging.hasCapability(_matrixWidgetApi.MatrixCapabilities.AlwaysOnScreen)) {
        if (_WidgetType.WidgetType.JITSI.matches(this.mockWidget.type)) {
          _CountlyAnalytics.default.instance.trackJoinCall(this.appTileProps.room.roomId, true, true);
        }

        _ActiveWidgetStore.default.instance.setWidgetPersistence(this.mockWidget.id, ev.detail.data.value);

        ev.preventDefault();
        this.messaging.transport.reply(ev.detail, {}); // ack
      }
    }); // TODO: Replace this event listener with appropriate driver functionality once the API
    // establishes a sane way to send events back and forth.

    this.messaging.on(`action:${_matrixWidgetApi.WidgetApiFromWidgetAction.SendSticker}`, ev => {
      if (this.messaging.hasCapability(_matrixWidgetApi.MatrixCapabilities.StickerSending)) {
        // Acknowledge first
        ev.preventDefault();
        this.messaging.transport.reply(ev.detail, {}); // Send the sticker

        _dispatcher.default.dispatch({
          action: 'm.sticker',
          data: ev.detail.data,
          widgetId: this.mockWidget.id
        });
      }
    });

    if (_WidgetType.WidgetType.STICKERPICKER.matches(this.mockWidget.type)) {
      this.messaging.on(`action:${_ElementWidgetActions.ElementWidgetActions.OpenIntegrationManager}`, ev => {
        // Acknowledge first
        ev.preventDefault();
        this.messaging.transport.reply(ev.detail, {}); // First close the stickerpicker

        _dispatcher.default.dispatch({
          action: "stickerpicker_close"
        }); // Now open the integration manager
        // TODO: Spec this interaction.


        const data = ev.detail.data;
        const integType = data === null || data === void 0 ? void 0 : data.integType;
        const integId = data === null || data === void 0 ? void 0 : data.integId; // TODO: Open the right integration manager for the widget

        if (_SettingsStore.default.getValue("feature_many_integration_managers")) {
          _IntegrationManagers.IntegrationManagers.sharedInstance().openAll(_MatrixClientPeg.MatrixClientPeg.get().getRoom(_RoomViewStore.default.getRoomId()), `type_${integType}`, integId);
        } else {
          _IntegrationManagers.IntegrationManagers.sharedInstance().getPrimaryManager().open(_MatrixClientPeg.MatrixClientPeg.get().getRoom(_RoomViewStore.default.getRoomId()), `type_${integType}`, integId);
        }
      });
    }
  }

  async prepare() {
    var _WidgetVariableCustom2;

    // Ensure the variables are ready for us to be rendered before continuing
    await ((_WidgetVariables.WidgetVariableCustomisations === null || _WidgetVariables.WidgetVariableCustomisations === void 0 ? void 0 : (_WidgetVariableCustom2 = _WidgetVariables.WidgetVariableCustomisations.isReady) === null || _WidgetVariableCustom2 === void 0 ? void 0 : _WidgetVariableCustom2.call(_WidgetVariables.WidgetVariableCustomisations)) ?? Promise.resolve());
    if (this.scalarToken) return;

    const existingMessaging = _WidgetMessagingStore.WidgetMessagingStore.instance.getMessaging(this.mockWidget);

    if (existingMessaging) this.messaging = existingMessaging;

    try {
      if (_WidgetUtils.default.isScalarUrl(this.mockWidget.templateUrl)) {
        const managers = _IntegrationManagers.IntegrationManagers.sharedInstance();

        if (managers.hasManager()) {
          // TODO: Pick the right manager for the widget
          const defaultManager = managers.getPrimaryManager();

          if (_WidgetUtils.default.isScalarUrl(defaultManager.apiUrl)) {
            const scalar = defaultManager.getScalarClient();
            this.scalarToken = await scalar.getScalarToken();
          }
        }
      }
    } catch (e) {
      // All errors are non-fatal
      _logger.logger.error("Error preparing widget communications: ", e);
    }
  }

  stop(opts = {
    forceDestroy: false
  }) {
    if (!(opts !== null && opts !== void 0 && opts.forceDestroy) && _ActiveWidgetStore.default.instance.getPersistentWidgetId() === this.mockWidget.id) {
      _logger.logger.log("Skipping destroy - persistent widget");

      return;
    }

    if (!this.started) return;

    _WidgetMessagingStore.WidgetMessagingStore.instance.stopMessaging(this.mockWidget);

    _ActiveWidgetStore.default.instance.delRoomId(this.mockWidget.id);

    if (_MatrixClientPeg.MatrixClientPeg.get()) {
      _MatrixClientPeg.MatrixClientPeg.get().off('event', this.onEvent);

      _MatrixClientPeg.MatrixClientPeg.get().off('Event.decrypted', this.onEventDecrypted);
    }
  }

  feedEvent(ev) {
    if (!this.messaging) return; // Check to see if this event would be before or after our "read up to" marker. If it's
    // before, or we can't decide, then we assume the widget will have already seen the event.
    // If the event is after, or we don't have a marker for the room, then we'll send it through.
    //
    // This approach of "read up to" prevents widgets receiving decryption spam from startup or
    // receiving out-of-order events from backfill and such.

    const upToEventId = this.readUpToMap[ev.getRoomId()];

    if (upToEventId) {
      // Small optimization for exact match (prevent search)
      if (upToEventId === ev.getId()) {
        return;
      }

      let isBeforeMark = true; // Timelines are most recent last, so reverse the order and limit ourselves to 100 events
      // to avoid overusing the CPU.

      const timeline = _MatrixClientPeg.MatrixClientPeg.get().getRoom(ev.getRoomId()).getLiveTimeline();

      const events = (0, _arrays.arrayFastClone)(timeline.getEvents()).reverse().slice(0, 100);

      for (const timelineEvent of events) {
        if (timelineEvent.getId() === upToEventId) {
          break;
        } else if (timelineEvent.getId() === ev.getId()) {
          isBeforeMark = false;
          break;
        }
      }

      if (isBeforeMark) {
        // Ignore the event: it is before our interest.
        return;
      }
    }

    this.readUpToMap[ev.getRoomId()] = ev.getId();
    const raw = ev.getEffectiveEvent();
    this.messaging.feedEvent(raw, this.eventListenerRoomId).catch(e => {
      _logger.logger.error("Error sending event to widget: ", e);
    });
  }

}

exports.StopGapWidget = StopGapWidget;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zdG9yZXMvd2lkZ2V0cy9TdG9wR2FwV2lkZ2V0LnRzIl0sIm5hbWVzIjpbIkVsZW1lbnRXaWRnZXQiLCJXaWRnZXQiLCJjb25zdHJ1Y3RvciIsInJhd0RlZmluaXRpb24iLCJ0ZW1wbGF0ZVVybCIsIldpZGdldFR5cGUiLCJKSVRTSSIsIm1hdGNoZXMiLCJ0eXBlIiwiV2lkZ2V0VXRpbHMiLCJnZXRMb2NhbEppdHNpV3JhcHBlclVybCIsImZvckxvY2FsUmVuZGVyIiwiYXV0aCIsInJhd0RhdGEiLCJwb3BvdXRUZW1wbGF0ZVVybCIsImNvbmZlcmVuY2VJZCIsInVuZGVmaW5lZCIsInBhcnNlZFVybCIsIlVSTCIsInNlYXJjaFBhcmFtcyIsImdldCIsImRvbWFpbiIsInRoZW1lIiwiVGhlbWVXYXRjaGVyIiwiZ2V0RWZmZWN0aXZlVGhlbWUiLCJzdGFydHNXaXRoIiwiY3VzdG9tVGhlbWUiLCJzdWJzdHIiLCJpc19kYXJrIiwiaW5jbHVkZXMiLCJnZXRDb21wbGV0ZVVybCIsInBhcmFtcyIsImFzUG9wb3V0IiwiZGF0YSIsIlN0b3BHYXBXaWRnZXQiLCJFdmVudEVtaXR0ZXIiLCJhcHBUaWxlUHJvcHMiLCJldiIsInByZXZlbnREZWZhdWx0IiwiTW9kYWxXaWRnZXRTdG9yZSIsImluc3RhbmNlIiwiY2FuT3Blbk1vZGFsV2lkZ2V0Iiwib3Blbk1vZGFsV2lkZ2V0IiwiZGV0YWlsIiwibW9ja1dpZGdldCIsIm1lc3NhZ2luZyIsInRyYW5zcG9ydCIsInJlcGx5IiwiZXJyb3IiLCJtZXNzYWdlIiwiTWF0cml4Q2xpZW50UGVnIiwiZGVjcnlwdEV2ZW50SWZOZWVkZWQiLCJpc0JlaW5nRGVjcnlwdGVkIiwiaXNEZWNyeXB0aW9uRmFpbHVyZSIsImZlZWRFdmVudCIsImFwcCIsImNyZWF0b3JVc2VySWQiLCJnZXRVc2VySWQiLCJyb29tSWQiLCJyb29tIiwia2luZCIsInVzZXJXaWRnZXQiLCJXaWRnZXRLaW5kIiwiQWNjb3VudCIsIlJvb20iLCJldmVudExpc3RlbmVyUm9vbUlkIiwiUm9vbVZpZXdTdG9yZSIsImdldFJvb21JZCIsIndpZGdldEFwaSIsImVtYmVkVXJsIiwicnVuVXJsVGVtcGxhdGUiLCJwb3BvdXRVcmwiLCJvcHRzIiwiZnJvbUN1c3RvbWlzYXRpb24iLCJwcm92aWRlVmFyaWFibGVzIiwiZGVmYXVsdHMiLCJ3aWRnZXRSb29tSWQiLCJjdXJyZW50VXNlcklkIiwidXNlckRpc3BsYXlOYW1lIiwiT3duUHJvZmlsZVN0b3JlIiwiZGlzcGxheU5hbWUiLCJ1c2VySHR0cEF2YXRhclVybCIsImdldEh0dHBBdmF0YXJVcmwiLCJjbGllbnRJZCIsIkVMRU1FTlRfQ0xJRU5UX0lEIiwiY2xpZW50VGhlbWUiLCJTZXR0aW5nc1N0b3JlIiwiZ2V0VmFsdWUiLCJjbGllbnRMYW5ndWFnZSIsInRlbXBsYXRlZCIsIk9iamVjdCIsImFzc2lnbiIsInBhcnNlZCIsInNldCIsImlkIiwid2luZG93IiwibG9jYXRpb24iLCJocmVmIiwic3BsaXQiLCJzY2FsYXJUb2tlbiIsInRvU3RyaW5nIiwicmVwbGFjZSIsImlzTWFuYWdlZEJ5TWFuYWdlciIsInN0YXJ0ZWQiLCJ3aWRnZXRJZCIsIndpZGdldCIsInN0YXJ0IiwiaWZyYW1lIiwiYWxsb3dlZENhcGFiaWxpdGllcyIsIndoaXRlbGlzdENhcGFiaWxpdGllcyIsImRyaXZlciIsIlN0b3BHYXBXaWRnZXREcml2ZXIiLCJDbGllbnRXaWRnZXRBcGkiLCJvbiIsImVtaXQiLCJXaWRnZXRBcGlGcm9tV2lkZ2V0QWN0aW9uIiwiT3Blbk1vZGFsV2lkZ2V0Iiwib25PcGVuTW9kYWwiLCJXaWRnZXRNZXNzYWdpbmdTdG9yZSIsInN0b3JlTWVzc2FnaW5nIiwiQWN0aXZlV2lkZ2V0U3RvcmUiLCJzZXRSb29tSWQiLCJFbGVtZW50V2lkZ2V0QWN0aW9ucyIsIlZpZXdSb29tIiwidGFyZ2V0Um9vbUlkIiwicm9vbV9pZCIsImhhc0NhcGFiaWxpdHkiLCJFbGVtZW50V2lkZ2V0Q2FwYWJpbGl0aWVzIiwiQ2FuQ2hhbmdlVmlld2VkUm9vbSIsImRlZmF1bHREaXNwYXRjaGVyIiwiZGlzcGF0Y2giLCJhY3Rpb24iLCJBY3Rpb24iLCJnZXRSb29tcyIsImV2ZW50cyIsImdldExpdmVUaW1lbGluZSIsImdldEV2ZW50cyIsInJvb21FdmVudCIsImxlbmd0aCIsInJlYWRVcFRvTWFwIiwiZ2V0SWQiLCJvbkV2ZW50Iiwib25FdmVudERlY3J5cHRlZCIsIlVwZGF0ZUFsd2F5c09uU2NyZWVuIiwiTWF0cml4Q2FwYWJpbGl0aWVzIiwiQWx3YXlzT25TY3JlZW4iLCJDb3VudGx5QW5hbHl0aWNzIiwidHJhY2tKb2luQ2FsbCIsInNldFdpZGdldFBlcnNpc3RlbmNlIiwidmFsdWUiLCJTZW5kU3RpY2tlciIsIlN0aWNrZXJTZW5kaW5nIiwiU1RJQ0tFUlBJQ0tFUiIsIk9wZW5JbnRlZ3JhdGlvbk1hbmFnZXIiLCJpbnRlZ1R5cGUiLCJpbnRlZ0lkIiwiSW50ZWdyYXRpb25NYW5hZ2VycyIsInNoYXJlZEluc3RhbmNlIiwib3BlbkFsbCIsImdldFJvb20iLCJnZXRQcmltYXJ5TWFuYWdlciIsIm9wZW4iLCJwcmVwYXJlIiwiaXNSZWFkeSIsIlByb21pc2UiLCJyZXNvbHZlIiwiZXhpc3RpbmdNZXNzYWdpbmciLCJnZXRNZXNzYWdpbmciLCJpc1NjYWxhclVybCIsIm1hbmFnZXJzIiwiaGFzTWFuYWdlciIsImRlZmF1bHRNYW5hZ2VyIiwiYXBpVXJsIiwic2NhbGFyIiwiZ2V0U2NhbGFyQ2xpZW50IiwiZ2V0U2NhbGFyVG9rZW4iLCJlIiwibG9nZ2VyIiwic3RvcCIsImZvcmNlRGVzdHJveSIsImdldFBlcnNpc3RlbnRXaWRnZXRJZCIsImxvZyIsInN0b3BNZXNzYWdpbmciLCJkZWxSb29tSWQiLCJvZmYiLCJ1cFRvRXZlbnRJZCIsImlzQmVmb3JlTWFyayIsInRpbWVsaW5lIiwicmV2ZXJzZSIsInNsaWNlIiwidGltZWxpbmVFdmVudCIsInJhdyIsImdldEVmZmVjdGl2ZUV2ZW50IiwiY2F0Y2giXSwibWFwcGlu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akksS0FBUCxDQUFhLGlDQUFiLEVBQWdEZ0ksQ0FBaEQ7QUFDSCxLQUZEO0FBR0g7O0FBN1UyQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgMjAyMCAtIDIwMjEgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IFJvb20gfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3Jvb21cIjtcbmltcG9ydCB7XG4gICAgQ2xpZW50V2lkZ2V0QXBpLFxuICAgIElTdGlja2VyQWN0aW9uUmVxdWVzdCxcbiAgICBJU3RpY2t5QWN0aW9uUmVxdWVzdCxcbiAgICBJVGVtcGxhdGVQYXJhbXMsXG4gICAgSVdpZGdldCxcbiAgICBJV2lkZ2V0QXBpUmVxdWVzdCxcbiAgICBJV2lkZ2V0QXBpUmVxdWVzdEVtcHR5RGF0YSxcbiAgICBJV2lkZ2V0RGF0YSxcbiAgICBNYXRyaXhDYXBhYmlsaXRpZXMsXG4gICAgcnVuVGVtcGxhdGUsXG4gICAgV2lkZ2V0LFxuICAgIFdpZGdldEFwaUZyb21XaWRnZXRBY3Rpb24sXG4gICAgSU1vZGFsV2lkZ2V0T3BlblJlcXVlc3QsXG4gICAgSVdpZGdldEFwaUVycm9yUmVzcG9uc2VEYXRhLFxuICAgIFdpZGdldEtpbmQsXG59IGZyb20gXCJtYXRyaXgtd2lkZ2V0LWFwaVwiO1xuaW1wb3J0IHsgU3RvcEdhcFdpZGdldERyaXZlciB9IGZyb20gXCIuL1N0b3BHYXBXaWRnZXREcml2ZXJcIjtcbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gXCJldmVudHNcIjtcbmltcG9ydCB7IFdpZGdldE1lc3NhZ2luZ1N0b3JlIH0gZnJvbSBcIi4vV2lkZ2V0TWVzc2FnaW5nU3RvcmVcIjtcbmltcG9ydCBSb29tVmlld1N0b3JlIGZyb20gXCIuLi9Sb29tVmlld1N0b3JlXCI7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tIFwiLi4vLi4vTWF0cml4Q2xpZW50UGVnXCI7XG5pbXBvcnQgeyBPd25Qcm9maWxlU3RvcmUgfSBmcm9tIFwiLi4vT3duUHJvZmlsZVN0b3JlXCI7XG5pbXBvcnQgV2lkZ2V0VXRpbHMgZnJvbSAnLi4vLi4vdXRpbHMvV2lkZ2V0VXRpbHMnO1xuaW1wb3J0IHsgSW50ZWdyYXRpb25NYW5hZ2VycyB9IGZyb20gXCIuLi8uLi9pbnRlZ3JhdGlvbnMvSW50ZWdyYXRpb25NYW5hZ2Vyc1wiO1xuaW1wb3J0IFNldHRpbmdzU3RvcmUgZnJvbSBcIi4uLy4uL3NldHRpbmdzL1NldHRpbmdzU3RvcmVcIjtcbmltcG9ydCB7IFdpZGdldFR5cGUgfSBmcm9tIFwiLi4vLi4vd2lkZ2V0cy9XaWRnZXRUeXBlXCI7XG5pbXBvcnQgQWN0aXZlV2lkZ2V0U3RvcmUgZnJvbSBcIi4uL0FjdGl2ZVdpZGdldFN0b3JlXCI7XG5pbXBvcnQgeyBvYmplY3RTaGFsbG93Q2xvbmUgfSBmcm9tIFwiLi4vLi4vdXRpbHMvb2JqZWN0c1wiO1xuaW1wb3J0IGRlZmF1bHREaXNwYXRjaGVyIGZyb20gXCIuLi8uLi9kaXNwYXRjaGVyL2Rpc3BhdGNoZXJcIjtcbmltcG9ydCB7IEFjdGlvbiB9IGZyb20gXCIuLi8uLi9kaXNwYXRjaGVyL2FjdGlvbnNcIjtcbmltcG9ydCB7IEVsZW1lbnRXaWRnZXRBY3Rpb25zLCBJVmlld1Jvb21BcGlSZXF1ZXN0IH0gZnJvbSBcIi4vRWxlbWVudFdpZGdldEFjdGlvbnNcIjtcbmltcG9ydCB7IE1vZGFsV2lkZ2V0U3RvcmUgfSBmcm9tIFwiLi4vTW9kYWxXaWRnZXRTdG9yZVwiO1xuaW1wb3J0IFRoZW1lV2F0Y2hlciBmcm9tIFwiLi4vLi4vc2V0dGluZ3Mvd2F0Y2hlcnMvVGhlbWVXYXRjaGVyXCI7XG5pbXBvcnQgeyBnZXRDdXN0b21UaGVtZSB9IGZyb20gXCIuLi8uLi90aGVtZVwiO1xuaW1wb3J0IENvdW50bHlBbmFseXRpY3MgZnJvbSBcIi4uLy4uL0NvdW50bHlBbmFseXRpY3NcIjtcbmltcG9ydCB7IEVsZW1lbnRXaWRnZXRDYXBhYmlsaXRpZXMgfSBmcm9tIFwiLi9FbGVtZW50V2lkZ2V0Q2FwYWJpbGl0aWVzXCI7XG5pbXBvcnQgeyBNYXRyaXhFdmVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvZXZlbnRcIjtcbmltcG9ydCB7IEVMRU1FTlRfQ0xJRU5UX0lEIH0gZnJvbSBcIi4uLy4uL2lkZW50aWZpZXJzXCI7XG5pbXBvcnQgeyBnZXRVc2VyTGFuZ3VhZ2UgfSBmcm9tIFwiLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyXCI7XG5pbXBvcnQgeyBXaWRnZXRWYXJpYWJsZUN1c3RvbWlzYXRpb25zIH0gZnJvbSBcIi4uLy4uL2N1c3RvbWlzYXRpb25zL1dpZGdldFZhcmlhYmxlc1wiO1xuaW1wb3J0IHsgYXJyYXlGYXN0Q2xvbmUgfSBmcm9tIFwiLi4vLi4vdXRpbHMvYXJyYXlzXCI7XG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcblxuLy8gVE9ETzogRGVzdHJveSBhbGwgb2YgdGhpcyBjb2RlXG5cbmludGVyZmFjZSBJQXBwVGlsZVByb3BzIHtcbiAgICAvLyBOb3RlOiB0aGVzZSBhcmUgb25seSB0aGUgcHJvcHMgd2UgY2FyZSBhYm91dFxuXG4gICAgYXBwOiBJV2lkZ2V0O1xuICAgIHJvb206IFJvb207XG4gICAgdXNlcklkOiBzdHJpbmc7XG4gICAgY3JlYXRvclVzZXJJZDogc3RyaW5nO1xuICAgIHdhaXRGb3JJZnJhbWVMb2FkOiBib29sZWFuO1xuICAgIHdoaXRlbGlzdENhcGFiaWxpdGllcz86IHN0cmluZ1tdO1xuICAgIHVzZXJXaWRnZXQ6IGJvb2xlYW47XG59XG5cbi8vIFRPRE86IERvbid0IHVzZSB0aGlzIGJlY2F1c2UgaXQncyB3cm9uZ1xuZXhwb3J0IGNsYXNzIEVsZW1lbnRXaWRnZXQgZXh0ZW5kcyBXaWRnZXQge1xuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcmF3RGVmaW5pdGlvbjogSVdpZGdldCkge1xuICAgICAgICBzdXBlcihyYXdEZWZpbml0aW9uKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IHRlbXBsYXRlVXJsKCk6IHN0cmluZyB7XG4gICAgICAgIGlmIChXaWRnZXRUeXBlLkpJVFNJLm1hdGNoZXModGhpcy50eXBlKSkge1xuICAgICAgICAgICAgcmV0dXJuIFdpZGdldFV0aWxzLmdldExvY2FsSml0c2lXcmFwcGVyVXJsKHtcbiAgICAgICAgICAgICAgICBmb3JMb2NhbFJlbmRlcjogdHJ1ZSxcbiAgICAgICAgICAgICAgICBhdXRoOiBzdXBlci5yYXdEYXRhPy5hdXRoIGFzIHN0cmluZywgLy8gdGhpcy5yYXdEYXRhIGNhbiBjYWxsIHRlbXBsYXRlVXJsLCBkbyB0aGlzIHRvIHByZXZlbnQgbG9vcGluZ1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHN1cGVyLnRlbXBsYXRlVXJsO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgcG9wb3V0VGVtcGxhdGVVcmwoKTogc3RyaW5nIHtcbiAgICAgICAgaWYgKFdpZGdldFR5cGUuSklUU0kubWF0Y2hlcyh0aGlzLnR5cGUpKSB7XG4gICAgICAgICAgICByZXR1cm4gV2lkZ2V0VXRpbHMuZ2V0TG9jYWxKaXRzaVdyYXBwZXJVcmwoe1xuICAgICAgICAgICAgICAgIGZvckxvY2FsUmVuZGVyOiBmYWxzZSwgLy8gVGhlIG9ubHkgaW1wb3J0YW50IGRpZmZlcmVuY2UgYmV0d2VlbiB0aGlzIGFuZCB0ZW1wbGF0ZVVybCgpXG4gICAgICAgICAgICAgICAgYXV0aDogc3VwZXIucmF3RGF0YT8uYXV0aCBhcyBzdHJpbmcsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy50ZW1wbGF0ZVVybDsgLy8gdXNlIHRoaXMgaW5zdGVhZCBvZiBzdXBlciB0byBlbnN1cmUgd2UgZ2V0IGFwcHJvcHJpYXRlIHRlbXBsYXRpbmdcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IHJhd0RhdGEoKTogSVdpZGdldERhdGEge1xuICAgICAgICBsZXQgY29uZmVyZW5jZUlkID0gc3VwZXIucmF3RGF0YVsnY29uZmVyZW5jZUlkJ107XG4gICAgICAgIGlmIChjb25mZXJlbmNlSWQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgLy8gd2UnbGwgbmVlZCB0byBwYXJzZSB0aGUgY29uZmVyZW5jZSBJRCBvdXQgb2YgdGhlIFVSTCBmb3IgdjEgSml0c2kgd2lkZ2V0c1xuICAgICAgICAgICAgY29uc3QgcGFyc2VkVXJsID0gbmV3IFVSTChzdXBlci50ZW1wbGF0ZVVybCk7IC8vIHVzZSBzdXBlciB0byBnZXQgdGhlIHJhdyB3aWRnZXQgVVJMXG4gICAgICAgICAgICBjb25mZXJlbmNlSWQgPSBwYXJzZWRVcmwuc2VhcmNoUGFyYW1zLmdldChcImNvbmZJZFwiKTtcbiAgICAgICAgfVxuICAgICAgICBsZXQgZG9tYWluID0gc3VwZXIucmF3RGF0YVsnZG9tYWluJ107XG4gICAgICAgIGlmIChkb21haW4gPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgLy8gdjEgd2lkZ2V0cyBkZWZhdWx0IHRvIGppdHNpLnJpb3QuaW0gcmVnYXJkbGVzcyBvZiB1c2VyIHNldHRpbmdzXG4gICAgICAgICAgICBkb21haW4gPSBcImppdHNpLnJpb3QuaW1cIjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCB0aGVtZSA9IG5ldyBUaGVtZVdhdGNoZXIoKS5nZXRFZmZlY3RpdmVUaGVtZSgpO1xuICAgICAgICBpZiAodGhlbWUuc3RhcnRzV2l0aChcImN1c3RvbS1cIikpIHtcbiAgICAgICAgICAgIGNvbnN0IGN1c3RvbVRoZW1lID0gZ2V0Q3VzdG9tVGhlbWUodGhlbWUuc3Vic3RyKDcpKTtcbiAgICAgICAgICAgIC8vIEppdHNpIG9ubHkgdW5kZXJzdGFuZHMgbGlnaHQvZGFya1xuICAgICAgICAgICAgdGhlbWUgPSBjdXN0b21UaGVtZS5pc19kYXJrID8gXCJkYXJrXCIgOiBcImxpZ2h0XCI7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBvbmx5IGFsbG93IGxpZ2h0L2RhcmsgdGhyb3VnaCwgZGVmYXVsdGluZyB0byBkYXJrIGFzIHRoYXQgd2FzIHByZXZpb3VzbHkgdGhlIG9ubHkgc3RhdGVcbiAgICAgICAgLy8gYWNjb3VudHMgZm9yIGxlZ2FjeS1saWdodC9sZWdhY3ktZGFyayB0aGVtZXMgdG9vXG4gICAgICAgIGlmICh0aGVtZS5pbmNsdWRlcyhcImxpZ2h0XCIpKSB7XG4gICAgICAgICAgICB0aGVtZSA9IFwibGlnaHRcIjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoZW1lID0gXCJkYXJrXCI7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgLi4uc3VwZXIucmF3RGF0YSxcbiAgICAgICAgICAgIHRoZW1lLFxuICAgICAgICAgICAgY29uZmVyZW5jZUlkLFxuICAgICAgICAgICAgZG9tYWluLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRDb21wbGV0ZVVybChwYXJhbXM6IElUZW1wbGF0ZVBhcmFtcywgYXNQb3BvdXQgPSBmYWxzZSk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBydW5UZW1wbGF0ZShhc1BvcG91dCA/IHRoaXMucG9wb3V0VGVtcGxhdGVVcmwgOiB0aGlzLnRlbXBsYXRlVXJsLCB7XG4gICAgICAgICAgICAuLi50aGlzLnJhd0RlZmluaXRpb24sXG4gICAgICAgICAgICBkYXRhOiB0aGlzLnJhd0RhdGEsXG4gICAgICAgIH0sIHBhcmFtcyk7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgU3RvcEdhcFdpZGdldCBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG4gICAgcHJpdmF0ZSBtZXNzYWdpbmc6IENsaWVudFdpZGdldEFwaTtcbiAgICBwcml2YXRlIG1vY2tXaWRnZXQ6IEVsZW1lbnRXaWRnZXQ7XG4gICAgcHJpdmF0ZSBzY2FsYXJUb2tlbjogc3RyaW5nO1xuICAgIHByaXZhdGUgcm9vbUlkPzogc3RyaW5nO1xuICAgIHByaXZhdGUga2luZDogV2lkZ2V0S2luZDtcbiAgICBwcml2YXRlIHJlYWRVcFRvTWFwOiB7IFtyb29tSWQ6IHN0cmluZ106IHN0cmluZyB9ID0ge307IC8vIHJvb20gSUQgdG8gZXZlbnQgSURcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgYXBwVGlsZVByb3BzOiBJQXBwVGlsZVByb3BzKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIGxldCBhcHAgPSBhcHBUaWxlUHJvcHMuYXBwO1xuXG4gICAgICAgIC8vIEJhY2t3YXJkcyBjb21wYXRpYmlsaXR5OiBub3QgYWxsIG9sZCB3aWRnZXRzIGhhdmUgYSBjcmVhdG9yVXNlcklkXG4gICAgICAgIGlmICghYXBwLmNyZWF0b3JVc2VySWQpIHtcbiAgICAgICAgICAgIGFwcCA9IG9iamVjdFNoYWxsb3dDbG9uZShhcHApOyAvLyBjbG9uZSB0byBwcmV2ZW50IGFjY2lkZW50YWwgbXV0YXRpb25cbiAgICAgICAgICAgIGFwcC5jcmVhdG9yVXNlcklkID0gTWF0cml4Q2xpZW50UGVnLmdldCgpLmdldFVzZXJJZCgpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5tb2NrV2lkZ2V0ID0gbmV3IEVsZW1lbnRXaWRnZXQoYXBwKTtcbiAgICAgICAgdGhpcy5yb29tSWQgPSBhcHBUaWxlUHJvcHMucm9vbT8ucm9vbUlkO1xuICAgICAgICB0aGlzLmtpbmQgPSBhcHBUaWxlUHJvcHMudXNlcldpZGdldCA/IFdpZGdldEtpbmQuQWNjb3VudCA6IFdpZGdldEtpbmQuUm9vbTsgLy8gcHJvYmFibHlcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldCBldmVudExpc3RlbmVyUm9vbUlkKCk6IHN0cmluZyB7XG4gICAgICAgIC8vIFdoZW4gd2lkZ2V0cyBhcmUgbGlzdGVuaW5nIHRvIGV2ZW50cywgd2UgbmVlZCB0byBtYWtlIHN1cmUgdGhleSdyZSBvbmx5XG4gICAgICAgIC8vIHJlY2VpdmluZyBldmVudHMgZm9yIHRoZSByaWdodCByb29tLiBJbiBwYXJ0aWN1bGFyLCByb29tIHdpZGdldHMgZ2V0IGxvY2tlZFxuICAgICAgICAvLyB0byB0aGUgcm9vbSB0aGV5IHdlcmUgYWRkZWQgaW4gd2hpbGUgYWNjb3VudCB3aWRnZXRzIGxpc3RlbiB0byB0aGUgY3VycmVudGx5XG4gICAgICAgIC8vIGFjdGl2ZSByb29tLlxuXG4gICAgICAgIGlmICh0aGlzLnJvb21JZCkgcmV0dXJuIHRoaXMucm9vbUlkO1xuXG4gICAgICAgIHJldHVybiBSb29tVmlld1N0b3JlLmdldFJvb21JZCgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgd2lkZ2V0QXBpKCk6IENsaWVudFdpZGdldEFwaSB7XG4gICAgICAgIHJldHVybiB0aGlzLm1lc3NhZ2luZztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGUgVVJMIHRvIHVzZSBpbiB0aGUgaWZyYW1lXG4gICAgICovXG4gICAgcHVibGljIGdldCBlbWJlZFVybCgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5ydW5VcmxUZW1wbGF0ZSh7IGFzUG9wb3V0OiBmYWxzZSB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGUgVVJMIHRvIHVzZSBpbiB0aGUgcG9wb3V0XG4gICAgICovXG4gICAgcHVibGljIGdldCBwb3BvdXRVcmwoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucnVuVXJsVGVtcGxhdGUoeyBhc1BvcG91dDogdHJ1ZSB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJ1blVybFRlbXBsYXRlKG9wdHMgPSB7IGFzUG9wb3V0OiBmYWxzZSB9KTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgZnJvbUN1c3RvbWlzYXRpb24gPSBXaWRnZXRWYXJpYWJsZUN1c3RvbWlzYXRpb25zPy5wcm92aWRlVmFyaWFibGVzPy4oKSA/PyB7fTtcbiAgICAgICAgY29uc3QgZGVmYXVsdHM6IElUZW1wbGF0ZVBhcmFtcyA9IHtcbiAgICAgICAgICAgIHdpZGdldFJvb21JZDogdGhpcy5yb29tSWQsXG4gICAgICAgICAgICBjdXJyZW50VXNlcklkOiBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZ2V0VXNlcklkKCksXG4gICAgICAgICAgICB1c2VyRGlzcGxheU5hbWU6IE93blByb2ZpbGVTdG9yZS5pbnN0YW5jZS5kaXNwbGF5TmFtZSxcbiAgICAgICAgICAgIHVzZXJIdHRwQXZhdGFyVXJsOiBPd25Qcm9maWxlU3RvcmUuaW5zdGFuY2UuZ2V0SHR0cEF2YXRhclVybCgpLFxuICAgICAgICAgICAgY2xpZW50SWQ6IEVMRU1FTlRfQ0xJRU5UX0lELFxuICAgICAgICAgICAgY2xpZW50VGhlbWU6IFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJ0aGVtZVwiKSxcbiAgICAgICAgICAgIGNsaWVudExhbmd1YWdlOiBnZXRVc2VyTGFuZ3VhZ2UoKSxcbiAgICAgICAgfTtcbiAgICAgICAgY29uc3QgdGVtcGxhdGVkID0gdGhpcy5tb2NrV2lkZ2V0LmdldENvbXBsZXRlVXJsKE9iamVjdC5hc3NpZ24oZGVmYXVsdHMsIGZyb21DdXN0b21pc2F0aW9uKSwgb3B0cz8uYXNQb3BvdXQpO1xuXG4gICAgICAgIGNvbnN0IHBhcnNlZCA9IG5ldyBVUkwodGVtcGxhdGVkKTtcblxuICAgICAgICAvLyBBZGQgaW4gc29tZSBsZWdhY3kgc3VwcG9ydCBzcHJpbmtsZXMgKGZvciBub24tcG9wb3V0IHdpZGdldHMpXG4gICAgICAgIC8vIFRPRE86IFJlcGxhY2UgdGhlc2Ugd2l0aCBwcm9wZXIgd2lkZ2V0IHBhcmFtc1xuICAgICAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL21hdHJpeC1vcmcvbWF0cml4LWRvYy9wdWxsLzE5NTgvZmlsZXMjcjQwNTcxNDgzM1xuICAgICAgICBpZiAoIW9wdHM/LmFzUG9wb3V0KSB7XG4gICAgICAgICAgICBwYXJzZWQuc2VhcmNoUGFyYW1zLnNldCgnd2lkZ2V0SWQnLCB0aGlzLm1vY2tXaWRnZXQuaWQpO1xuICAgICAgICAgICAgcGFyc2VkLnNlYXJjaFBhcmFtcy5zZXQoJ3BhcmVudFVybCcsIHdpbmRvdy5sb2NhdGlvbi5ocmVmLnNwbGl0KCcjJywgMilbMF0pO1xuXG4gICAgICAgICAgICAvLyBHaXZlIHRoZSB3aWRnZXQgYSBzY2FsYXIgdG9rZW4gaWYgd2UncmUgc3VwcG9zZWQgdG8gKG1vcmUgbGVnYWN5KVxuICAgICAgICAgICAgLy8gVE9ETzogU3RvcCBkb2luZyB0aGlzXG4gICAgICAgICAgICBpZiAodGhpcy5zY2FsYXJUb2tlbikge1xuICAgICAgICAgICAgICAgIHBhcnNlZC5zZWFyY2hQYXJhbXMuc2V0KCdzY2FsYXJfdG9rZW4nLCB0aGlzLnNjYWxhclRva2VuKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFJlcGxhY2UgdGhlIGVuY29kZWQgZG9sbGFyIHNpZ25zIGJhY2sgdG8gZG9sbGFyIHNpZ25zLiBUaGV5IGhhdmUgbm8gc3BlY2lhbCBtZWFuaW5nXG4gICAgICAgIC8vIGluIEhUVFAsIGJ1dCBVUkwgcGFyc2VycyBlbmNvZGUgdGhlbSBhbnl3YXlzLlxuICAgICAgICByZXR1cm4gcGFyc2VkLnRvU3RyaW5nKCkucmVwbGFjZSgvJTI0L2csICckJyk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBpc01hbmFnZWRCeU1hbmFnZXIoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAhIXRoaXMuc2NhbGFyVG9rZW47XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBzdGFydGVkKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gISF0aGlzLm1lc3NhZ2luZztcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldCB3aWRnZXRJZCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubWVzc2FnaW5nLndpZGdldC5pZDtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uT3Blbk1vZGFsID0gYXN5bmMgKGV2OiBDdXN0b21FdmVudDxJTW9kYWxXaWRnZXRPcGVuUmVxdWVzdD4pID0+IHtcbiAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgaWYgKE1vZGFsV2lkZ2V0U3RvcmUuaW5zdGFuY2UuY2FuT3Blbk1vZGFsV2lkZ2V0KCkpIHtcbiAgICAgICAgICAgIE1vZGFsV2lkZ2V0U3RvcmUuaW5zdGFuY2Uub3Blbk1vZGFsV2lkZ2V0KGV2LmRldGFpbC5kYXRhLCB0aGlzLm1vY2tXaWRnZXQpO1xuICAgICAgICAgICAgdGhpcy5tZXNzYWdpbmcudHJhbnNwb3J0LnJlcGx5KGV2LmRldGFpbCwge30pOyAvLyBhY2tcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMubWVzc2FnaW5nLnRyYW5zcG9ydC5yZXBseShldi5kZXRhaWwsIHtcbiAgICAgICAgICAgICAgICBlcnJvcjoge1xuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBcIlVuYWJsZSB0byBvcGVuIG1vZGFsIGF0IHRoaXMgdGltZVwiLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwdWJsaWMgc3RhcnQoaWZyYW1lOiBIVE1MSUZyYW1lRWxlbWVudCkge1xuICAgICAgICBpZiAodGhpcy5zdGFydGVkKSByZXR1cm47XG4gICAgICAgIGNvbnN0IGFsbG93ZWRDYXBhYmlsaXRpZXMgPSB0aGlzLmFwcFRpbGVQcm9wcy53aGl0ZWxpc3RDYXBhYmlsaXRpZXMgfHwgW107XG4gICAgICAgIGNvbnN0IGRyaXZlciA9IG5ldyBTdG9wR2FwV2lkZ2V0RHJpdmVyKGFsbG93ZWRDYXBhYmlsaXRpZXMsIHRoaXMubW9ja1dpZGdldCwgdGhpcy5raW5kLCB0aGlzLnJvb21JZCk7XG4gICAgICAgIHRoaXMubWVzc2FnaW5nID0gbmV3IENsaWVudFdpZGdldEFwaSh0aGlzLm1vY2tXaWRnZXQsIGlmcmFtZSwgZHJpdmVyKTtcbiAgICAgICAgdGhpcy5tZXNzYWdpbmcub24oXCJwcmVwYXJpbmdcIiwgKCkgPT4gdGhpcy5lbWl0KFwicHJlcGFyaW5nXCIpKTtcbiAgICAgICAgdGhpcy5tZXNzYWdpbmcub24oXCJyZWFkeVwiLCAoKSA9PiB0aGlzLmVtaXQoXCJyZWFkeVwiKSk7XG4gICAgICAgIHRoaXMubWVzc2FnaW5nLm9uKFwiY2FwYWJpbGl0aWVzTm90aWZpZWRcIiwgKCkgPT4gdGhpcy5lbWl0KFwiY2FwYWJpbGl0aWVzTm90aWZpZWRcIikpO1xuICAgICAgICB0aGlzLm1lc3NhZ2luZy5vbihgYWN0aW9uOiR7V2lkZ2V0QXBpRnJvbVdpZGdldEFjdGlvbi5PcGVuTW9kYWxXaWRnZXR9YCwgdGhpcy5vbk9wZW5Nb2RhbCk7XG4gICAgICAgIFdpZGdldE1lc3NhZ2luZ1N0b3JlLmluc3RhbmNlLnN0b3JlTWVzc2FnaW5nKHRoaXMubW9ja1dpZGdldCwgdGhpcy5tZXNzYWdpbmcpO1xuXG4gICAgICAgIGlmICghdGhpcy5hcHBUaWxlUHJvcHMudXNlcldpZGdldCAmJiB0aGlzLmFwcFRpbGVQcm9wcy5yb29tKSB7XG4gICAgICAgICAgICBBY3RpdmVXaWRnZXRTdG9yZS5pbnN0YW5jZS5zZXRSb29tSWQodGhpcy5tb2NrV2lkZ2V0LmlkLCB0aGlzLmFwcFRpbGVQcm9wcy5yb29tLnJvb21JZCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBBbHdheXMgYXR0YWNoIGEgaGFuZGxlciBmb3IgVmlld1Jvb20sIGJ1dCBwZXJtaXNzaW9uIGNoZWNrIGl0IGludGVybmFsbHlcbiAgICAgICAgdGhpcy5tZXNzYWdpbmcub24oYGFjdGlvbjoke0VsZW1lbnRXaWRnZXRBY3Rpb25zLlZpZXdSb29tfWAsIChldjogQ3VzdG9tRXZlbnQ8SVZpZXdSb29tQXBpUmVxdWVzdD4pID0+IHtcbiAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7IC8vIHN0b3AgdGhlIHdpZGdldCBBUEkgZnJvbSBhdXRvLXJlamVjdGluZyB0aGlzXG5cbiAgICAgICAgICAgIC8vIENoZWNrIHVwIGZyb250IGlmIHRoaXMgaXMgZXZlbiBhIHZhbGlkIHJlcXVlc3RcbiAgICAgICAgICAgIGNvbnN0IHRhcmdldFJvb21JZCA9IChldi5kZXRhaWwuZGF0YSB8fCB7fSkucm9vbV9pZDtcbiAgICAgICAgICAgIGlmICghdGFyZ2V0Um9vbUlkKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubWVzc2FnaW5nLnRyYW5zcG9ydC5yZXBseShldi5kZXRhaWwsIDxJV2lkZ2V0QXBpRXJyb3JSZXNwb25zZURhdGE+e1xuICAgICAgICAgICAgICAgICAgICBlcnJvcjogeyBtZXNzYWdlOiBcIlJvb20gSUQgbm90IHN1cHBsaWVkLlwiIH0sXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIENoZWNrIHRoZSB3aWRnZXQncyBwZXJtaXNzaW9uXG4gICAgICAgICAgICBpZiAoIXRoaXMubWVzc2FnaW5nLmhhc0NhcGFiaWxpdHkoRWxlbWVudFdpZGdldENhcGFiaWxpdGllcy5DYW5DaGFuZ2VWaWV3ZWRSb29tKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm1lc3NhZ2luZy50cmFuc3BvcnQucmVwbHkoZXYuZGV0YWlsLCA8SVdpZGdldEFwaUVycm9yUmVzcG9uc2VEYXRhPntcbiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IHsgbWVzc2FnZTogXCJUaGlzIHdpZGdldCBkb2VzIG5vdCBoYXZlIHBlcm1pc3Npb24gZm9yIHRoaXMgYWN0aW9uIChkZW5pZWQpLlwiIH0sXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIGF0IHRoaXMgcG9pbnQgd2UgY2FuIGNoYW5nZSByb29tcywgc28gZG8gdGhhdFxuICAgICAgICAgICAgZGVmYXVsdERpc3BhdGNoZXIuZGlzcGF0Y2goe1xuICAgICAgICAgICAgICAgIGFjdGlvbjogQWN0aW9uLlZpZXdSb29tLFxuICAgICAgICAgICAgICAgIHJvb21faWQ6IHRhcmdldFJvb21JZCxcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAvLyBhY2tub3dsZWRnZSBzbyB0aGUgd2lkZ2V0IGRvZXNuJ3QgZnJlYWsgb3V0XG4gICAgICAgICAgICB0aGlzLm1lc3NhZ2luZy50cmFuc3BvcnQucmVwbHkoZXYuZGV0YWlsLCA8SVdpZGdldEFwaVJlcXVlc3RFbXB0eURhdGE+e30pO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBQb3B1bGF0ZSB0aGUgbWFwIG9mIFwicmVhZCB1cCB0b1wiIGV2ZW50cyBmb3IgdGhpcyB3aWRnZXQgd2l0aCB0aGUgY3VycmVudCBldmVudCBpbiBldmVyeSByb29tLlxuICAgICAgICAvLyBUaGlzIGlzIGEgYml0IGluZWZmaWNpZW50LCBidXQgc2hvdWxkIGJlIG9rYXkuIFdlIGRvIHRoaXMgZm9yIGFsbCByb29tcyBpbiBjYXNlIHRoZSB3aWRnZXRcbiAgICAgICAgLy8gcmVxdWVzdHMgdGltZWxpbmUgY2FwYWJpbGl0aWVzIGluIG90aGVyIHJvb21zIGRvd24gdGhlIHJvYWQuIEl0J3MganVzdCBlYXNpZXIgdG8gbWFuYWdlIGhlcmUuXG4gICAgICAgIGZvciAoY29uc3Qgcm9vbSBvZiBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZ2V0Um9vbXMoKSkge1xuICAgICAgICAgICAgLy8gVGltZWxpbmVzIGFyZSBtb3N0IHJlY2VudCBsYXN0XG4gICAgICAgICAgICBjb25zdCBldmVudHMgPSByb29tLmdldExpdmVUaW1lbGluZSgpPy5nZXRFdmVudHMoKSB8fCBbXTtcbiAgICAgICAgICAgIGNvbnN0IHJvb21FdmVudCA9IGV2ZW50c1tldmVudHMubGVuZ3RoIC0gMV07XG4gICAgICAgICAgICBpZiAoIXJvb21FdmVudCkgY29udGludWU7IC8vIGZvcmNlIGxhdGVyIGNvZGUgdG8gdGhpbmsgdGhlIHJvb20gaXMgZnJlc2hcbiAgICAgICAgICAgIHRoaXMucmVhZFVwVG9NYXBbcm9vbS5yb29tSWRdID0gcm9vbUV2ZW50LmdldElkKCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBBdHRhY2ggbGlzdGVuZXJzIGZvciBmZWVkaW5nIGV2ZW50cyAtIHRoZSB1bmRlcmx5aW5nIHdpZGdldCBjbGFzc2VzIGhhbmRsZSBwZXJtaXNzaW9ucyBmb3IgdXNcbiAgICAgICAgTWF0cml4Q2xpZW50UGVnLmdldCgpLm9uKCdldmVudCcsIHRoaXMub25FdmVudCk7XG4gICAgICAgIE1hdHJpeENsaWVudFBlZy5nZXQoKS5vbignRXZlbnQuZGVjcnlwdGVkJywgdGhpcy5vbkV2ZW50RGVjcnlwdGVkKTtcblxuICAgICAgICB0aGlzLm1lc3NhZ2luZy5vbihgYWN0aW9uOiR7V2lkZ2V0QXBpRnJvbVdpZGdldEFjdGlvbi5VcGRhdGVBbHdheXNPblNjcmVlbn1gLFxuICAgICAgICAgICAgKGV2OiBDdXN0b21FdmVudDxJU3RpY2t5QWN0aW9uUmVxdWVzdD4pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5tZXNzYWdpbmcuaGFzQ2FwYWJpbGl0eShNYXRyaXhDYXBhYmlsaXRpZXMuQWx3YXlzT25TY3JlZW4pKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChXaWRnZXRUeXBlLkpJVFNJLm1hdGNoZXModGhpcy5tb2NrV2lkZ2V0LnR5cGUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBDb3VudGx5QW5hbHl0aWNzLmluc3RhbmNlLnRyYWNrSm9pbkNhbGwodGhpcy5hcHBUaWxlUHJvcHMucm9vbS5yb29tSWQsIHRydWUsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIEFjdGl2ZVdpZGdldFN0b3JlLmluc3RhbmNlLnNldFdpZGdldFBlcnNpc3RlbmNlKHRoaXMubW9ja1dpZGdldC5pZCwgZXYuZGV0YWlsLmRhdGEudmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc3NhZ2luZy50cmFuc3BvcnQucmVwbHkoZXYuZGV0YWlsLCA8SVdpZGdldEFwaVJlcXVlc3RFbXB0eURhdGE+e30pOyAvLyBhY2tcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICApO1xuXG4gICAgICAgIC8vIFRPRE86IFJlcGxhY2UgdGhpcyBldmVudCBsaXN0ZW5lciB3aXRoIGFwcHJvcHJpYXRlIGRyaXZlciBmdW5jdGlvbmFsaXR5IG9uY2UgdGhlIEFQSVxuICAgICAgICAvLyBlc3RhYmxpc2hlcyBhIHNhbmUgd2F5IHRvIHNlbmQgZXZlbnRzIGJhY2sgYW5kIGZvcnRoLlxuICAgICAgICB0aGlzLm1lc3NhZ2luZy5vbihgYWN0aW9uOiR7V2lkZ2V0QXBpRnJvbVdpZGdldEFjdGlvbi5TZW5kU3RpY2tlcn1gLFxuICAgICAgICAgICAgKGV2OiBDdXN0b21FdmVudDxJU3RpY2tlckFjdGlvblJlcXVlc3Q+KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMubWVzc2FnaW5nLmhhc0NhcGFiaWxpdHkoTWF0cml4Q2FwYWJpbGl0aWVzLlN0aWNrZXJTZW5kaW5nKSkge1xuICAgICAgICAgICAgICAgICAgICAvLyBBY2tub3dsZWRnZSBmaXJzdFxuICAgICAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc3NhZ2luZy50cmFuc3BvcnQucmVwbHkoZXYuZGV0YWlsLCA8SVdpZGdldEFwaVJlcXVlc3RFbXB0eURhdGE+e30pO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIFNlbmQgdGhlIHN0aWNrZXJcbiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdERpc3BhdGNoZXIuZGlzcGF0Y2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uOiAnbS5zdGlja2VyJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IGV2LmRldGFpbC5kYXRhLFxuICAgICAgICAgICAgICAgICAgICAgICAgd2lkZ2V0SWQ6IHRoaXMubW9ja1dpZGdldC5pZCxcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAoV2lkZ2V0VHlwZS5TVElDS0VSUElDS0VSLm1hdGNoZXModGhpcy5tb2NrV2lkZ2V0LnR5cGUpKSB7XG4gICAgICAgICAgICB0aGlzLm1lc3NhZ2luZy5vbihgYWN0aW9uOiR7RWxlbWVudFdpZGdldEFjdGlvbnMuT3BlbkludGVncmF0aW9uTWFuYWdlcn1gLFxuICAgICAgICAgICAgICAgIChldjogQ3VzdG9tRXZlbnQ8SVdpZGdldEFwaVJlcXVlc3Q+KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIC8vIEFja25vd2xlZGdlIGZpcnN0XG4gICAgICAgICAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubWVzc2FnaW5nLnRyYW5zcG9ydC5yZXBseShldi5kZXRhaWwsIDxJV2lkZ2V0QXBpUmVxdWVzdEVtcHR5RGF0YT57fSk7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gRmlyc3QgY2xvc2UgdGhlIHN0aWNrZXJwaWNrZXJcbiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdERpc3BhdGNoZXIuZGlzcGF0Y2goeyBhY3Rpb246IFwic3RpY2tlcnBpY2tlcl9jbG9zZVwiIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIE5vdyBvcGVuIHRoZSBpbnRlZ3JhdGlvbiBtYW5hZ2VyXG4gICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IFNwZWMgdGhpcyBpbnRlcmFjdGlvbi5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IGV2LmRldGFpbC5kYXRhO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnRlZ1R5cGUgPSBkYXRhPy5pbnRlZ1R5cGU7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGludGVnSWQgPSA8c3RyaW5nPmRhdGE/LmludGVnSWQ7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogT3BlbiB0aGUgcmlnaHQgaW50ZWdyYXRpb24gbWFuYWdlciBmb3IgdGhlIHdpZGdldFxuICAgICAgICAgICAgICAgICAgICBpZiAoU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcImZlYXR1cmVfbWFueV9pbnRlZ3JhdGlvbl9tYW5hZ2Vyc1wiKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgSW50ZWdyYXRpb25NYW5hZ2Vycy5zaGFyZWRJbnN0YW5jZSgpLm9wZW5BbGwoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgTWF0cml4Q2xpZW50UGVnLmdldCgpLmdldFJvb20oUm9vbVZpZXdTdG9yZS5nZXRSb29tSWQoKSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYHR5cGVfJHtpbnRlZ1R5cGV9YCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnRlZ0lkLFxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIEludGVncmF0aW9uTWFuYWdlcnMuc2hhcmVkSW5zdGFuY2UoKS5nZXRQcmltYXJ5TWFuYWdlcigpLm9wZW4oXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgTWF0cml4Q2xpZW50UGVnLmdldCgpLmdldFJvb20oUm9vbVZpZXdTdG9yZS5nZXRSb29tSWQoKSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYHR5cGVfJHtpbnRlZ1R5cGV9YCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnRlZ0lkLFxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIHByZXBhcmUoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIC8vIEVuc3VyZSB0aGUgdmFyaWFibGVzIGFyZSByZWFkeSBmb3IgdXMgdG8gYmUgcmVuZGVyZWQgYmVmb3JlIGNvbnRpbnVpbmdcbiAgICAgICAgYXdhaXQgKFdpZGdldFZhcmlhYmxlQ3VzdG9taXNhdGlvbnM/LmlzUmVhZHk/LigpID8/IFByb21pc2UucmVzb2x2ZSgpKTtcblxuICAgICAgICBpZiAodGhpcy5zY2FsYXJUb2tlbikgcmV0dXJuO1xuICAgICAgICBjb25zdCBleGlzdGluZ01lc3NhZ2luZyA9IFdpZGdldE1lc3NhZ2luZ1N0b3JlLmluc3RhbmNlLmdldE1lc3NhZ2luZyh0aGlzLm1vY2tXaWRnZXQpO1xuICAgICAgICBpZiAoZXhpc3RpbmdNZXNzYWdpbmcpIHRoaXMubWVzc2FnaW5nID0gZXhpc3RpbmdNZXNzYWdpbmc7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAoV2lkZ2V0VXRpbHMuaXNTY2FsYXJVcmwodGhpcy5tb2NrV2lkZ2V0LnRlbXBsYXRlVXJsKSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1hbmFnZXJzID0gSW50ZWdyYXRpb25NYW5hZ2Vycy5zaGFyZWRJbnN0YW5jZSgpO1xuICAgICAgICAgICAgICAgIGlmIChtYW5hZ2Vycy5oYXNNYW5hZ2VyKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogUGljayB0aGUgcmlnaHQgbWFuYWdlciBmb3IgdGhlIHdpZGdldFxuICAgICAgICAgICAgICAgICAgICBjb25zdCBkZWZhdWx0TWFuYWdlciA9IG1hbmFnZXJzLmdldFByaW1hcnlNYW5hZ2VyKCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChXaWRnZXRVdGlscy5pc1NjYWxhclVybChkZWZhdWx0TWFuYWdlci5hcGlVcmwpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzY2FsYXIgPSBkZWZhdWx0TWFuYWdlci5nZXRTY2FsYXJDbGllbnQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2NhbGFyVG9rZW4gPSBhd2FpdCBzY2FsYXIuZ2V0U2NhbGFyVG9rZW4oKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgLy8gQWxsIGVycm9ycyBhcmUgbm9uLWZhdGFsXG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoXCJFcnJvciBwcmVwYXJpbmcgd2lkZ2V0IGNvbW11bmljYXRpb25zOiBcIiwgZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RvcChvcHRzID0geyBmb3JjZURlc3Ryb3k6IGZhbHNlIH0pIHtcbiAgICAgICAgaWYgKCFvcHRzPy5mb3JjZURlc3Ryb3kgJiYgQWN0aXZlV2lkZ2V0U3RvcmUuaW5zdGFuY2UuZ2V0UGVyc2lzdGVudFdpZGdldElkKCkgPT09IHRoaXMubW9ja1dpZGdldC5pZCkge1xuICAgICAgICAgICAgbG9nZ2VyLmxvZyhcIlNraXBwaW5nIGRlc3Ryb3kgLSBwZXJzaXN0ZW50IHdpZGdldFwiKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRoaXMuc3RhcnRlZCkgcmV0dXJuO1xuICAgICAgICBXaWRnZXRNZXNzYWdpbmdTdG9yZS5pbnN0YW5jZS5zdG9wTWVzc2FnaW5nKHRoaXMubW9ja1dpZGdldCk7XG4gICAgICAgIEFjdGl2ZVdpZGdldFN0b3JlLmluc3RhbmNlLmRlbFJvb21JZCh0aGlzLm1vY2tXaWRnZXQuaWQpO1xuXG4gICAgICAgIGlmIChNYXRyaXhDbGllbnRQZWcuZ2V0KCkpIHtcbiAgICAgICAgICAgIE1hdHJpeENsaWVudFBlZy5nZXQoKS5vZmYoJ2V2ZW50JywgdGhpcy5vbkV2ZW50KTtcbiAgICAgICAgICAgIE1hdHJpeENsaWVudFBlZy5nZXQoKS5vZmYoJ0V2ZW50LmRlY3J5cHRlZCcsIHRoaXMub25FdmVudERlY3J5cHRlZCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIG9uRXZlbnQgPSAoZXY6IE1hdHJpeEV2ZW50KSA9PiB7XG4gICAgICAgIE1hdHJpeENsaWVudFBlZy5nZXQoKS5kZWNyeXB0RXZlbnRJZk5lZWRlZChldik7XG4gICAgICAgIGlmIChldi5pc0JlaW5nRGVjcnlwdGVkKCkgfHwgZXYuaXNEZWNyeXB0aW9uRmFpbHVyZSgpKSByZXR1cm47XG4gICAgICAgIHRoaXMuZmVlZEV2ZW50KGV2KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkV2ZW50RGVjcnlwdGVkID0gKGV2OiBNYXRyaXhFdmVudCkgPT4ge1xuICAgICAgICBpZiAoZXYuaXNEZWNyeXB0aW9uRmFpbHVyZSgpKSByZXR1cm47XG4gICAgICAgIHRoaXMuZmVlZEV2ZW50KGV2KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBmZWVkRXZlbnQoZXY6IE1hdHJpeEV2ZW50KSB7XG4gICAgICAgIGlmICghdGhpcy5tZXNzYWdpbmcpIHJldHVybjtcblxuICAgICAgICAvLyBDaGVjayB0byBzZWUgaWYgdGhpcyBldmVudCB3b3VsZCBiZSBiZWZvcmUgb3IgYWZ0ZXIgb3VyIFwicmVhZCB1cCB0b1wiIG1hcmtlci4gSWYgaXQnc1xuICAgICAgICAvLyBiZWZvcmUsIG9yIHdlIGNhbid0IGRlY2lkZSwgdGhlbiB3ZSBhc3N1bWUgdGhlIHdpZGdldCB3aWxsIGhhdmUgYWxyZWFkeSBzZWVuIHRoZSBldmVudC5cbiAgICAgICAgLy8gSWYgdGhlIGV2ZW50IGlzIGFmdGVyLCBvciB3ZSBkb24ndCBoYXZlIGEgbWFya2VyIGZvciB0aGUgcm9vbSwgdGhlbiB3ZSdsbCBzZW5kIGl0IHRocm91Z2guXG4gICAgICAgIC8vXG4gICAgICAgIC8vIFRoaXMgYXBwcm9hY2ggb2YgXCJyZWFkIHVwIHRvXCIgcHJldmVudHMgd2lkZ2V0cyByZWNlaXZpbmcgZGVjcnlwdGlvbiBzcGFtIGZyb20gc3RhcnR1cCBvclxuICAgICAgICAvLyByZWNlaXZpbmcgb3V0LW9mLW9yZGVyIGV2ZW50cyBmcm9tIGJhY2tmaWxsIGFuZCBzdWNoLlxuICAgICAgICBjb25zdCB1cFRvRXZlbnRJZCA9IHRoaXMucmVhZFVwVG9NYXBbZXYuZ2V0Um9vbUlkKCldO1xuICAgICAgICBpZiAodXBUb0V2ZW50SWQpIHtcbiAgICAgICAgICAgIC8vIFNtYWxsIG9wdGltaXphdGlvbiBmb3IgZXhhY3QgbWF0Y2ggKHByZXZlbnQgc2VhcmNoKVxuICAgICAgICAgICAgaWYgKHVwVG9FdmVudElkID09PSBldi5nZXRJZCgpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgaXNCZWZvcmVNYXJrID0gdHJ1ZTtcblxuICAgICAgICAgICAgLy8gVGltZWxpbmVzIGFyZSBtb3N0IHJlY2VudCBsYXN0LCBzbyByZXZlcnNlIHRoZSBvcmRlciBhbmQgbGltaXQgb3Vyc2VsdmVzIHRvIDEwMCBldmVudHNcbiAgICAgICAgICAgIC8vIHRvIGF2b2lkIG92ZXJ1c2luZyB0aGUgQ1BVLlxuICAgICAgICAgICAgY29uc3QgdGltZWxpbmUgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZ2V0Um9vbShldi5nZXRSb29tSWQoKSkuZ2V0TGl2ZVRpbWVsaW5lKCk7XG4gICAgICAgICAgICBjb25zdCBldmVudHMgPSBhcnJheUZhc3RDbG9uZSh0aW1lbGluZS5nZXRFdmVudHMoKSkucmV2ZXJzZSgpLnNsaWNlKDAsIDEwMCk7XG5cbiAgICAgICAgICAgIGZvciAoY29uc3QgdGltZWxpbmVFdmVudCBvZiBldmVudHMpIHtcbiAgICAgICAgICAgICAgICBpZiAodGltZWxpbmVFdmVudC5nZXRJZCgpID09PSB1cFRvRXZlbnRJZCkge1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRpbWVsaW5lRXZlbnQuZ2V0SWQoKSA9PT0gZXYuZ2V0SWQoKSkge1xuICAgICAgICAgICAgICAgICAgICBpc0JlZm9yZU1hcmsgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoaXNCZWZvcmVNYXJrKSB7XG4gICAgICAgICAgICAgICAgLy8gSWdub3JlIHRoZSBldmVudDogaXQgaXMgYmVmb3JlIG91ciBpbnRlcmVzdC5cbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnJlYWRVcFRvTWFwW2V2LmdldFJvb21JZCgpXSA9IGV2LmdldElkKCk7XG5cbiAgICAgICAgY29uc3QgcmF3ID0gZXYuZ2V0RWZmZWN0aXZlRXZlbnQoKTtcbiAgICAgICAgdGhpcy5tZXNzYWdpbmcuZmVlZEV2ZW50KHJhdywgdGhpcy5ldmVudExpc3RlbmVyUm9vbUlkKS5jYXRjaChlID0+IHtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihcIkVycm9yIHNlbmRpbmcgZXZlbnQgdG8gd2lkZ2V0OiBcIiwgZSk7XG4gICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==