"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.WidgetPermissionStore = exports.OIDCState = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _SettingsStore = _interopRequireDefault(require("../../settings/SettingsStore"));

var _matrixWidgetApi = require("matrix-widget-api");

var _MatrixClientPeg = require("../../MatrixClientPeg");

var _SettingLevel = require("../../settings/SettingLevel");

/*
 * Copyright 2020 The Matrix.org Foundation C.I.C.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
let OIDCState;
exports.OIDCState = OIDCState;

(function (OIDCState) {
  OIDCState[OIDCState["Allowed"] = 0] = "Allowed";
  OIDCState[OIDCState["Denied"] = 1] = "Denied";
  OIDCState[OIDCState["Unknown"] = 2] = "Unknown";
})(OIDCState || (exports.OIDCState = OIDCState = {}));

class WidgetPermissionStore {
  constructor() {}

  static get instance() {
    if (!WidgetPermissionStore.internalInstance) {
      WidgetPermissionStore.internalInstance = new WidgetPermissionStore();
    }

    return WidgetPermissionStore.internalInstance;
  } // TODO (all functions here): Merge widgetKind with the widget definition


  packSettingKey(widget, kind, roomId) {
    let location = roomId;

    if (kind !== _matrixWidgetApi.WidgetKind.Room) {
      location = _MatrixClientPeg.MatrixClientPeg.get().getUserId();
    }

    if (kind === _matrixWidgetApi.WidgetKind.Modal) {
      location = '*MODAL*-' + location; // to guarantee differentiation from whatever spawned it
    }

    if (!location) {
      throw new Error("Failed to determine a location to check the widget's OIDC state with");
    }

    return encodeURIComponent(`${location}::${widget.templateUrl}`);
  }

  getOIDCState(widget, kind, roomId) {
    var _settings$deny, _settings$allow;

    const settingsKey = this.packSettingKey(widget, kind, roomId);

    const settings = _SettingsStore.default.getValue("widgetOpenIDPermissions");

    if (settings !== null && settings !== void 0 && (_settings$deny = settings.deny) !== null && _settings$deny !== void 0 && _settings$deny.includes(settingsKey)) {
      return OIDCState.Denied;
    }

    if (settings !== null && settings !== void 0 && (_settings$allow = settings.allow) !== null && _settings$allow !== void 0 && _settings$allow.includes(settingsKey)) {
      return OIDCState.Allowed;
    }

    return OIDCState.Unknown;
  }

  setOIDCState(widget, kind, roomId, newState) {
    const settingsKey = this.packSettingKey(widget, kind, roomId);

    const currentValues = _SettingsStore.default.getValue("widgetOpenIDPermissions");

    if (!currentValues.allow) currentValues.allow = [];
    if (!currentValues.deny) currentValues.deny = [];

    if (newState === OIDCState.Allowed) {
      currentValues.allow.push(settingsKey);
    } else if (newState === OIDCState.Denied) {
      currentValues.deny.push(settingsKey);
    } else {
      currentValues.allow = currentValues.allow.filter(c => c !== settingsKey);
      currentValues.deny = currentValues.deny.filter(c => c !== settingsKey);
    }

    _SettingsStore.default.setValue("widgetOpenIDPermissions", null, _SettingLevel.SettingLevel.DEVICE, currentValues);
  }

}

exports.WidgetPermissionStore = WidgetPermissionStore;
(0, _defineProperty2.default)(WidgetPermissionStore, "internalInstance", void 0);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zdG9yZXMvd2lkZ2V0cy9XaWRnZXRQZXJtaXNzaW9uU3RvcmUudHMiXSwibmFtZXMiOlsiT0lEQ1N0YXRlIiwiV2lkZ2V0UGVybWlzc2lvblN0b3JlIiwiY29uc3RydWN0b3IiLCJpbnN0YW5jZSIsImludGVybmFsSW5zdGFuY2UiLCJwYWNrU2V0dGluZ0tleSIsIndpZGdldCIsImtpbmQiLCJyb29tSWQiLCJsb2NhdGlvbiIsIldpZGdldEtpbmQiLCJSb29tIiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0IiwiZ2V0VXNlcklkIiwiTW9kYWwiLCJFcnJvciIsImVuY29kZVVSSUNvbXBvbmVudCIsInRlbXBsYXRlVXJsIiwiZ2V0T0lEQ1N0YXRlIiwic2V0dGluZ3NLZXkiLCJzZXR0aW5ncyIsIlNldHRpbmdzU3RvcmUiLCJnZXRWYWx1ZSIsImRlbnkiLCJpbmNsdWRlcyIsIkRlbmllZCIsImFsbG93IiwiQWxsb3dlZCIsIlVua25vd24iLCJzZXRPSURDU3RhdGUiLCJuZXdTdGF0ZSIsImN1cnJlbnRWYWx1ZXMiLCJwdXNoIiwiZmlsdGVyIiwiYyIsInNldFZhbHVlIiwiU2V0dGluZ0xldmVsIiwiREVWSUNFIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWdCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFuQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0lBT1lBLFM7OztXQUFBQSxTO0FBQUFBLEVBQUFBLFMsQ0FBQUEsUztBQUFBQSxFQUFBQSxTLENBQUFBLFM7QUFBQUEsRUFBQUEsUyxDQUFBQSxTO0dBQUFBLFMseUJBQUFBLFM7O0FBTUwsTUFBTUMscUJBQU4sQ0FBNEI7QUFHdkJDLEVBQUFBLFdBQVcsR0FBRyxDQUNyQjs7QUFFeUIsYUFBUkMsUUFBUSxHQUEwQjtBQUNoRCxRQUFJLENBQUNGLHFCQUFxQixDQUFDRyxnQkFBM0IsRUFBNkM7QUFDekNI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LEtBQUtmLFdBQXJDLENBQXJCO0FBQ0g7O0FBRURFLDJCQUFjYyxRQUFkLENBQXVCLHlCQUF2QixFQUFrRCxJQUFsRCxFQUF3REMsMkJBQWFDLE1BQXJFLEVBQTZFTixhQUE3RTtBQUNIOztBQTNEOEI7Ozs4QkFBdEIvQixxQiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgMjAyMCBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IFNldHRpbmdzU3RvcmUgZnJvbSBcIi4uLy4uL3NldHRpbmdzL1NldHRpbmdzU3RvcmVcIjtcbmltcG9ydCB7IFdpZGdldCwgV2lkZ2V0S2luZCB9IGZyb20gXCJtYXRyaXgtd2lkZ2V0LWFwaVwiO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSBcIi4uLy4uL01hdHJpeENsaWVudFBlZ1wiO1xuaW1wb3J0IHsgU2V0dGluZ0xldmVsIH0gZnJvbSBcIi4uLy4uL3NldHRpbmdzL1NldHRpbmdMZXZlbFwiO1xuXG5leHBvcnQgZW51bSBPSURDU3RhdGUge1xuICAgIEFsbG93ZWQsIC8vIHVzZXIgaGFzIHNldCB0aGUgcmVtZW1iZXJlZCB2YWx1ZSBhcyBhbGxvd2VkXG4gICAgRGVuaWVkLCAvLyB1c2VyIGhhcyBzZXQgdGhlIHJlbWVtYmVyZWQgdmFsdWUgYXMgZGlzYWxsb3dlZFxuICAgIFVua25vd24sIC8vIHVzZXIgaGFzIG5vdCBzZXQgYSByZW1lbWJlcmVkIHZhbHVlXG59XG5cbmV4cG9ydCBjbGFzcyBXaWRnZXRQZXJtaXNzaW9uU3RvcmUge1xuICAgIHByaXZhdGUgc3RhdGljIGludGVybmFsSW5zdGFuY2U6IFdpZGdldFBlcm1pc3Npb25TdG9yZTtcblxuICAgIHByaXZhdGUgY29uc3RydWN0b3IoKSB7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBnZXQgaW5zdGFuY2UoKTogV2lkZ2V0UGVybWlzc2lvblN0b3JlIHtcbiAgICAgICAgaWYgKCFXaWRnZXRQZXJtaXNzaW9uU3RvcmUuaW50ZXJuYWxJbnN0YW5jZSkge1xuICAgICAgICAgICAgV2lkZ2V0UGVybWlzc2lvblN0b3JlLmludGVybmFsSW5zdGFuY2UgPSBuZXcgV2lkZ2V0UGVybWlzc2lvblN0b3JlKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFdpZGdldFBlcm1pc3Npb25TdG9yZS5pbnRlcm5hbEluc3RhbmNlO1xuICAgIH1cblxuICAgIC8vIFRPRE8gKGFsbCBmdW5jdGlvbnMgaGVyZSk6IE1lcmdlIHdpZGdldEtpbmQgd2l0aCB0aGUgd2lkZ2V0IGRlZmluaXRpb25cblxuICAgIHByaXZhdGUgcGFja1NldHRpbmdLZXkod2lkZ2V0OiBXaWRnZXQsIGtpbmQ6IFdpZGdldEtpbmQsIHJvb21JZD86IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIGxldCBsb2NhdGlvbiA9IHJvb21JZDtcbiAgICAgICAgaWYgKGtpbmQgIT09IFdpZGdldEtpbmQuUm9vbSkge1xuICAgICAgICAgICAgbG9jYXRpb24gPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZ2V0VXNlcklkKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGtpbmQgPT09IFdpZGdldEtpbmQuTW9kYWwpIHtcbiAgICAgICAgICAgIGxvY2F0aW9uID0gJypNT0RBTCotJyArIGxvY2F0aW9uOyAvLyB0byBndWFyYW50ZWUgZGlmZmVyZW50aWF0aW9uIGZyb20gd2hhdGV2ZXIgc3Bhd25lZCBpdFxuICAgICAgICB9XG4gICAgICAgIGlmICghbG9jYXRpb24pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkZhaWxlZCB0byBkZXRlcm1pbmUgYSBsb2NhdGlvbiB0byBjaGVjayB0aGUgd2lkZ2V0J3MgT0lEQyBzdGF0ZSB3aXRoXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudChgJHtsb2NhdGlvbn06OiR7d2lkZ2V0LnRlbXBsYXRlVXJsfWApO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRPSURDU3RhdGUod2lkZ2V0OiBXaWRnZXQsIGtpbmQ6IFdpZGdldEtpbmQsIHJvb21JZD86IHN0cmluZyk6IE9JRENTdGF0ZSB7XG4gICAgICAgIGNvbnN0IHNldHRpbmdzS2V5ID0gdGhpcy5wYWNrU2V0dGluZ0tleSh3aWRnZXQsIGtpbmQsIHJvb21JZCk7XG4gICAgICAgIGNvbnN0IHNldHRpbmdzID0gU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcIndpZGdldE9wZW5JRFBlcm1pc3Npb25zXCIpO1xuICAgICAgICBpZiAoc2V0dGluZ3M/LmRlbnk/LmluY2x1ZGVzKHNldHRpbmdzS2V5KSkge1xuICAgICAgICAgICAgcmV0dXJuIE9JRENTdGF0ZS5EZW5pZWQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHNldHRpbmdzPy5hbGxvdz8uaW5jbHVkZXMoc2V0dGluZ3NLZXkpKSB7XG4gICAgICAgICAgICByZXR1cm4gT0lEQ1N0YXRlLkFsbG93ZWQ7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIE9JRENTdGF0ZS5Vbmtub3duO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXRPSURDU3RhdGUod2lkZ2V0OiBXaWRnZXQsIGtpbmQ6IFdpZGdldEtpbmQsIHJvb21JZDogc3RyaW5nLCBuZXdTdGF0ZTogT0lEQ1N0YXRlKSB7XG4gICAgICAgIGNvbnN0IHNldHRpbmdzS2V5ID0gdGhpcy5wYWNrU2V0dGluZ0tleSh3aWRnZXQsIGtpbmQsIHJvb21JZCk7XG5cbiAgICAgICAgY29uc3QgY3VycmVudFZhbHVlcyA9IFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJ3aWRnZXRPcGVuSURQZXJtaXNzaW9uc1wiKTtcbiAgICAgICAgaWYgKCFjdXJyZW50VmFsdWVzLmFsbG93KSBjdXJyZW50VmFsdWVzLmFsbG93ID0gW107XG4gICAgICAgIGlmICghY3VycmVudFZhbHVlcy5kZW55KSBjdXJyZW50VmFsdWVzLmRlbnkgPSBbXTtcblxuICAgICAgICBpZiAobmV3U3RhdGUgPT09IE9JRENTdGF0ZS5BbGxvd2VkKSB7XG4gICAgICAgICAgICBjdXJyZW50VmFsdWVzLmFsbG93LnB1c2goc2V0dGluZ3NLZXkpO1xuICAgICAgICB9IGVsc2UgaWYgKG5ld1N0YXRlID09PSBPSURDU3RhdGUuRGVuaWVkKSB7XG4gICAgICAgICAgICBjdXJyZW50VmFsdWVzLmRlbnkucHVzaChzZXR0aW5nc0tleSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjdXJyZW50VmFsdWVzLmFsbG93ID0gY3VycmVudFZhbHVlcy5hbGxvdy5maWx0ZXIoYyA9PiBjICE9PSBzZXR0aW5nc0tleSk7XG4gICAgICAgICAgICBjdXJyZW50VmFsdWVzLmRlbnkgPSBjdXJyZW50VmFsdWVzLmRlbnkuZmlsdGVyKGMgPT4gYyAhPT0gc2V0dGluZ3NLZXkpO1xuICAgICAgICB9XG5cbiAgICAgICAgU2V0dGluZ3NTdG9yZS5zZXRWYWx1ZShcIndpZGdldE9wZW5JRFBlcm1pc3Npb25zXCIsIG51bGwsIFNldHRpbmdMZXZlbC5ERVZJQ0UsIGN1cnJlbnRWYWx1ZXMpO1xuICAgIH1cbn1cbiJdfQ==