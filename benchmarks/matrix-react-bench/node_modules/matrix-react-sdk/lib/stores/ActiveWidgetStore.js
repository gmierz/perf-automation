"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.ActiveWidgetStoreEvent = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _events = _interopRequireDefault(require("events"));

var _MatrixClientPeg = require("../MatrixClientPeg");

var _WidgetMessagingStore = require("./widgets/WidgetMessagingStore");

/*
Copyright 2018 New Vector Ltd

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
let ActiveWidgetStoreEvent;
/**
 * Stores information about the widgets active in the app right now:
 *  * What widget is set to remain always-on-screen, if any
 *    Only one widget may be 'always on screen' at any one time.
 *  * Negotiated capabilities for active apps
 */

exports.ActiveWidgetStoreEvent = ActiveWidgetStoreEvent;

(function (ActiveWidgetStoreEvent) {
  ActiveWidgetStoreEvent["Update"] = "update";
})(ActiveWidgetStoreEvent || (exports.ActiveWidgetStoreEvent = ActiveWidgetStoreEvent = {}));

class ActiveWidgetStore extends _events.default {
  constructor(...args) {
    super(...args);
    (0, _defineProperty2.default)(this, "persistentWidgetId", void 0);
    (0, _defineProperty2.default)(this, "roomIdByWidgetId", new Map());
    (0, _defineProperty2.default)(this, "onRoomStateEvents", ev => {
      // XXX: This listens for state events in order to remove the active widget.
      // Everything else relies on views listening for events and calling setters
      // on this class which is terrible. This store should just listen for events
      // and keep itself up to date.
      // TODO: Enable support for m.widget event type (https://github.com/vector-im/element-web/issues/13111)
      if (ev.getType() !== 'im.vector.modular.widgets') return;

      if (ev.getStateKey() === this.persistentWidgetId) {
        this.destroyPersistentWidget(this.persistentWidgetId);
      }
    });
  }

  static get instance() {
    if (!ActiveWidgetStore.internalInstance) {
      ActiveWidgetStore.internalInstance = new ActiveWidgetStore();
    }

    return ActiveWidgetStore.internalInstance;
  }

  start() {
    _MatrixClientPeg.MatrixClientPeg.get().on('RoomState.events', this.onRoomStateEvents);
  }

  stop() {
    if (_MatrixClientPeg.MatrixClientPeg.get()) {
      _MatrixClientPeg.MatrixClientPeg.get().removeListener('RoomState.events', this.onRoomStateEvents);
    }

    this.roomIdByWidgetId.clear();
  }

  destroyPersistentWidget(id) {
    if (id !== this.persistentWidgetId) return;
    const toDeleteId = this.persistentWidgetId;

    _WidgetMessagingStore.WidgetMessagingStore.instance.stopMessagingById(id);

    this.setWidgetPersistence(toDeleteId, false);
    this.delRoomId(toDeleteId);
  }

  setWidgetPersistence(widgetId, val) {
    if (this.persistentWidgetId === widgetId && !val) {
      this.persistentWidgetId = null;
    } else if (this.persistentWidgetId !== widgetId && val) {
      this.persistentWidgetId = widgetId;
    }

    this.emit(ActiveWidgetStoreEvent.Update);
  }

  getWidgetPersistence(widgetId) {
    return this.persistentWidgetId === widgetId;
  }

  getPersistentWidgetId() {
    return this.persistentWidgetId;
  }

  getRoomId(widgetId) {
    return this.roomIdByWidgetId.get(widgetId);
  }

  setRoomId(widgetId, roomId) {
    this.roomIdByWidgetId.set(widgetId, roomId);
    this.emit(ActiveWidgetStoreEvent.Update);
  }

  delRoomId(widgetId) {
    this.roomIdByWidgetId.delete(widgetId);
    this.emit(ActiveWidgetStoreEvent.Update);
  }

}

exports.default = ActiveWidgetStore;
(0, _defineProperty2.default)(ActiveWidgetStore, "internalInstance", void 0);
window.mxActiveWidgetStore = ActiveWidgetStore.instance;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdG9yZXMvQWN0aXZlV2lkZ2V0U3RvcmUudHMiXSwibmFtZXMiOlsiQWN0aXZlV2lkZ2V0U3RvcmVFdmVudCIsIkFjdGl2ZVdpZGdldFN0b3JlIiwiRXZlbnRFbWl0dGVyIiwiTWFwIiwiZXYiLCJnZXRUeXBlIiwiZ2V0U3RhdGVLZXkiLCJwZXJzaXN0ZW50V2lkZ2V0SWQiLCJkZXN0cm95UGVyc2lzdGVudFdpZGdldCIsImluc3RhbmNlIiwiaW50ZXJuYWxJbnN0YW5jZSIsInN0YXJ0IiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0Iiwib24iLCJvblJvb21TdGF0ZUV2ZW50cyIsInN0b3AiLCJyZW1vdmVMaXN0ZW5lciIsInJvb21JZEJ5V2lkZ2V0SWQiLCJjbGVhciIsImlkIiwidG9EZWxldGVJZCIsIldpZGdldE1lc3NhZ2luZ1N0b3JlIiwic3RvcE1lc3NhZ2luZ0J5SWQiLCJzZXRXaWRnZXRQZXJzaXN0ZW5jZSIsImRlbFJvb21JZCIsIndpZGdldElkIiwidmFsIiwiZW1pdCIsIlVwZGF0ZSIsImdldFdpZGdldFBlcnNpc3RlbmNlIiwiZ2V0UGVyc2lzdGVudFdpZGdldElkIiwiZ2V0Um9vbUlkIiwic2V0Um9vbUlkIiwicm9vbUlkIiwic2V0IiwiZGVsZXRlIiwid2luZG93IiwibXhBY3RpdmVXaWRnZXRTdG9yZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFnQkE7O0FBR0E7O0FBQ0E7O0FBcEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtJQVFZQSxzQjtBQUlaO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7OztXQVRZQSxzQjtBQUFBQSxFQUFBQSxzQjtHQUFBQSxzQixzQ0FBQUEsc0I7O0FBVUcsTUFBTUMsaUJBQU4sU0FBZ0NDLGVBQWhDLENBQTZDO0FBQUE7QUFBQTtBQUFBO0FBQUEsNERBSTdCLElBQUlDLEdBQUosRUFKNkI7QUFBQSw2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dGRcblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgRXZlbnRFbWl0dGVyIGZyb20gJ2V2ZW50cyc7XG5pbXBvcnQgeyBNYXRyaXhFdmVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyY1wiO1xuXG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tICcuLi9NYXRyaXhDbGllbnRQZWcnO1xuaW1wb3J0IHsgV2lkZ2V0TWVzc2FnaW5nU3RvcmUgfSBmcm9tIFwiLi93aWRnZXRzL1dpZGdldE1lc3NhZ2luZ1N0b3JlXCI7XG5cbmV4cG9ydCBlbnVtIEFjdGl2ZVdpZGdldFN0b3JlRXZlbnQge1xuICAgIFVwZGF0ZSA9IFwidXBkYXRlXCIsXG59XG5cbi8qKlxuICogU3RvcmVzIGluZm9ybWF0aW9uIGFib3V0IHRoZSB3aWRnZXRzIGFjdGl2ZSBpbiB0aGUgYXBwIHJpZ2h0IG5vdzpcbiAqICAqIFdoYXQgd2lkZ2V0IGlzIHNldCB0byByZW1haW4gYWx3YXlzLW9uLXNjcmVlbiwgaWYgYW55XG4gKiAgICBPbmx5IG9uZSB3aWRnZXQgbWF5IGJlICdhbHdheXMgb24gc2NyZWVuJyBhdCBhbnkgb25lIHRpbWUuXG4gKiAgKiBOZWdvdGlhdGVkIGNhcGFiaWxpdGllcyBmb3IgYWN0aXZlIGFwcHNcbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQWN0aXZlV2lkZ2V0U3RvcmUgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICAgIHByaXZhdGUgc3RhdGljIGludGVybmFsSW5zdGFuY2U6IEFjdGl2ZVdpZGdldFN0b3JlO1xuICAgIHByaXZhdGUgcGVyc2lzdGVudFdpZGdldElkOiBzdHJpbmc7XG4gICAgLy8gV2hhdCByb29tIElEIGVhY2ggd2lkZ2V0IGlzIGFzc29jaWF0ZWQgd2l0aCAoaWYgaXQncyBhIHJvb20gd2lkZ2V0KVxuICAgIHByaXZhdGUgcm9vbUlkQnlXaWRnZXRJZCA9IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KCk7XG5cbiAgICBwdWJsaWMgc3RhdGljIGdldCBpbnN0YW5jZSgpOiBBY3RpdmVXaWRnZXRTdG9yZSB7XG4gICAgICAgIGlmICghQWN0aXZlV2lkZ2V0U3RvcmUuaW50ZXJuYWxJbnN0YW5jZSkge1xuICAgICAgICAgICAgQWN0aXZlV2lkZ2V0U3RvcmUuaW50ZXJuYWxJbnN0YW5jZSA9IG5ldyBBY3RpdmVXaWRnZXRTdG9yZSgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBBY3RpdmVXaWRnZXRTdG9yZS5pbnRlcm5hbEluc3RhbmNlO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGFydCgpOiB2b2lkIHtcbiAgICAgICAgTWF0cml4Q2xpZW50UGVnLmdldCgpLm9uKCdSb29tU3RhdGUuZXZlbnRzJywgdGhpcy5vblJvb21TdGF0ZUV2ZW50cyk7XG4gICAgfVxuXG4gICAgcHVibGljIHN0b3AoKTogdm9pZCB7XG4gICAgICAgIGlmIChNYXRyaXhDbGllbnRQZWcuZ2V0KCkpIHtcbiAgICAgICAgICAgIE1hdHJpeENsaWVudFBlZy5nZXQoKS5yZW1vdmVMaXN0ZW5lcignUm9vbVN0YXRlLmV2ZW50cycsIHRoaXMub25Sb29tU3RhdGVFdmVudHMpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucm9vbUlkQnlXaWRnZXRJZC5jbGVhcigpO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25Sb29tU3RhdGVFdmVudHMgPSAoZXY6IE1hdHJpeEV2ZW50KTogdm9pZCA9PiB7XG4gICAgICAgIC8vIFhYWDogVGhpcyBsaXN0ZW5zIGZvciBzdGF0ZSBldmVudHMgaW4gb3JkZXIgdG8gcmVtb3ZlIHRoZSBhY3RpdmUgd2lkZ2V0LlxuICAgICAgICAvLyBFdmVyeXRoaW5nIGVsc2UgcmVsaWVzIG9uIHZpZXdzIGxpc3RlbmluZyBmb3IgZXZlbnRzIGFuZCBjYWxsaW5nIHNldHRlcnNcbiAgICAgICAgLy8gb24gdGhpcyBjbGFzcyB3aGljaCBpcyB0ZXJyaWJsZS4gVGhpcyBzdG9yZSBzaG91bGQganVzdCBsaXN0ZW4gZm9yIGV2ZW50c1xuICAgICAgICAvLyBhbmQga2VlcCBpdHNlbGYgdXAgdG8gZGF0ZS5cbiAgICAgICAgLy8gVE9ETzogRW5hYmxlIHN1cHBvcnQgZm9yIG0ud2lkZ2V0IGV2ZW50IHR5cGUgKGh0dHBzOi8vZ2l0aHViLmNvbS92ZWN0b3ItaW0vZWxlbWVudC13ZWIvaXNzdWVzLzEzMTExKVxuICAgICAgICBpZiAoZXYuZ2V0VHlwZSgpICE9PSAnaW0udmVjdG9yLm1vZHVsYXIud2lkZ2V0cycpIHJldHVybjtcblxuICAgICAgICBpZiAoZXYuZ2V0U3RhdGVLZXkoKSA9PT0gdGhpcy5wZXJzaXN0ZW50V2lkZ2V0SWQpIHtcbiAgICAgICAgICAgIHRoaXMuZGVzdHJveVBlcnNpc3RlbnRXaWRnZXQodGhpcy5wZXJzaXN0ZW50V2lkZ2V0SWQpO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIHB1YmxpYyBkZXN0cm95UGVyc2lzdGVudFdpZGdldChpZDogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIGlmIChpZCAhPT0gdGhpcy5wZXJzaXN0ZW50V2lkZ2V0SWQpIHJldHVybjtcbiAgICAgICAgY29uc3QgdG9EZWxldGVJZCA9IHRoaXMucGVyc2lzdGVudFdpZGdldElkO1xuXG4gICAgICAgIFdpZGdldE1lc3NhZ2luZ1N0b3JlLmluc3RhbmNlLnN0b3BNZXNzYWdpbmdCeUlkKGlkKTtcblxuICAgICAgICB0aGlzLnNldFdpZGdldFBlcnNpc3RlbmNlKHRvRGVsZXRlSWQsIGZhbHNlKTtcbiAgICAgICAgdGhpcy5kZWxSb29tSWQodG9EZWxldGVJZCk7XG4gICAgfVxuXG4gICAgcHVibGljIHNldFdpZGdldFBlcnNpc3RlbmNlKHdpZGdldElkOiBzdHJpbmcsIHZhbDogYm9vbGVhbik6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5wZXJzaXN0ZW50V2lkZ2V0SWQgPT09IHdpZGdldElkICYmICF2YWwpIHtcbiAgICAgICAgICAgIHRoaXMucGVyc2lzdGVudFdpZGdldElkID0gbnVsbDtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLnBlcnNpc3RlbnRXaWRnZXRJZCAhPT0gd2lkZ2V0SWQgJiYgdmFsKSB7XG4gICAgICAgICAgICB0aGlzLnBlcnNpc3RlbnRXaWRnZXRJZCA9IHdpZGdldElkO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZW1pdChBY3RpdmVXaWRnZXRTdG9yZUV2ZW50LlVwZGF0ZSk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldFdpZGdldFBlcnNpc3RlbmNlKHdpZGdldElkOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucGVyc2lzdGVudFdpZGdldElkID09PSB3aWRnZXRJZDtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0UGVyc2lzdGVudFdpZGdldElkKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLnBlcnNpc3RlbnRXaWRnZXRJZDtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0Um9vbUlkKHdpZGdldElkOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5yb29tSWRCeVdpZGdldElkLmdldCh3aWRnZXRJZCk7XG4gICAgfVxuXG4gICAgcHVibGljIHNldFJvb21JZCh3aWRnZXRJZDogc3RyaW5nLCByb29tSWQ6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICB0aGlzLnJvb21JZEJ5V2lkZ2V0SWQuc2V0KHdpZGdldElkLCByb29tSWQpO1xuICAgICAgICB0aGlzLmVtaXQoQWN0aXZlV2lkZ2V0U3RvcmVFdmVudC5VcGRhdGUpO1xuICAgIH1cblxuICAgIHB1YmxpYyBkZWxSb29tSWQod2lkZ2V0SWQ6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICB0aGlzLnJvb21JZEJ5V2lkZ2V0SWQuZGVsZXRlKHdpZGdldElkKTtcbiAgICAgICAgdGhpcy5lbWl0KEFjdGl2ZVdpZGdldFN0b3JlRXZlbnQuVXBkYXRlKTtcbiAgICB9XG59XG5cbndpbmRvdy5teEFjdGl2ZVdpZGdldFN0b3JlID0gQWN0aXZlV2lkZ2V0U3RvcmUuaW5zdGFuY2U7XG4iXX0=