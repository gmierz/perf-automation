"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.UI_EVENTS = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _events = _interopRequireDefault(require("events"));

/*
Copyright 2021 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
// XXX: resize-observer-polyfill has types that now conflict with typescript's
// own DOM types: https://github.com/que-etc/resize-observer-polyfill/issues/80
// Using require here rather than import is a horrenous workaround. We should
// be able to remove the polyfill once Safari 14 is released.
const ResizeObserverPolyfill = require('resize-observer-polyfill'); // eslint-disable-line @typescript-eslint/no-var-requires


let UI_EVENTS;
exports.UI_EVENTS = UI_EVENTS;

(function (UI_EVENTS) {
  UI_EVENTS["Resize"] = "resize";
})(UI_EVENTS || (exports.UI_EVENTS = UI_EVENTS = {}));

class UIStore extends _events.default {
  constructor() {
    super(); // eslint-disable-next-line no-restricted-properties

    (0, _defineProperty2.default)(this, "resizeObserver", void 0);
    (0, _defineProperty2.default)(this, "uiElementDimensions", new Map());
    (0, _defineProperty2.default)(this, "trackedUiElements", new Map());
    (0, _defineProperty2.default)(this, "windowWidth", void 0);
    (0, _defineProperty2.default)(this, "windowHeight", void 0);
    (0, _defineProperty2.default)(this, "resizeObserverCallback", entries => {
      const windowEntry = entries.find(entry => entry.target === document.body);

      if (windowEntry) {
        this.windowWidth = windowEntry.contentRect.width;
        this.windowHeight = windowEntry.contentRect.height;
      }

      entries.forEach(entry => {
        const trackedElementName = this.trackedUiElements.get(entry.target);

        if (trackedElementName) {
          this.uiElementDimensions.set(trackedElementName, entry.contentRect);
          this.emit(trackedElementName, UI_EVENTS.Resize, entry);
        }
      });
      this.emit(UI_EVENTS.Resize, entries);
    });
    this.windowWidth = window.innerWidth; // eslint-disable-next-line no-restricted-properties

    this.windowHeight = window.innerHeight;
    this.resizeObserver = new ResizeObserverPolyfill(this.resizeObserverCallback);
    this.resizeObserver.observe(document.body);
  }

  static get instance() {
    if (!UIStore._instance) {
      UIStore._instance = new UIStore();
    }

    return UIStore._instance;
  }

  static destroy() {
    if (UIStore._instance) {
      UIStore._instance.resizeObserver.disconnect();

      UIStore._instance.removeAllListeners();

      UIStore._instance = null;
    }
  }

  getElementDimensions(name) {
    return this.uiElementDimensions.get(name);
  }

  trackElementDimensions(name, element) {
    this.trackedUiElements.set(element, name);
    this.resizeObserver.observe(element);
  }

  stopTrackingElementDimensions(name) {
    let trackedElement;
    this.trackedUiElements.forEach((trackedElementName, element) => {
      if (trackedElementName === name) {
        trackedElement = element;
      }
    });

    if (trackedElement) {
      this.resizeObserver.unobserve(trackedElement);
      this.uiElementDimensions.delete(name);
      this.trackedUiElements.delete(trackedElement);
    }
  }

  isTrackingElementDimensions(name) {
    return this.uiElementDimensions.has(name);
  }

}

exports.default = UIStore;
(0, _defineProperty2.default)(UIStore, "_instance", null);
window.mxUIStore = UIStore.instance;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdG9yZXMvVUlTdG9yZS50cyJdLCJuYW1lcyI6WyJSZXNpemVPYnNlcnZlclBvbHlmaWxsIiwicmVxdWlyZSIsIlVJX0VWRU5UUyIsIlVJU3RvcmUiLCJFdmVudEVtaXR0ZXIiLCJjb25zdHJ1Y3RvciIsIk1hcCIsImVudHJpZXMiLCJ3aW5kb3dFbnRyeSIsImZpbmQiLCJlbnRyeSIsInRhcmdldCIsImRvY3VtZW50IiwiYm9keSIsIndpbmRvd1dpZHRoIiwiY29udGVudFJlY3QiLCJ3aWR0aCIsIndpbmRvd0hlaWdodCIsImhlaWdodCIsImZvckVhY2giLCJ0cmFja2VkRWxlbWVudE5hbWUiLCJ0cmFja2VkVWlFbGVtZW50cyIsImdldCIsInVpRWxlbWVudERpbWVuc2lvbnMiLCJzZXQiLCJlbWl0IiwiUmVzaXplIiwid2luZG93IiwiaW5uZXJXaWR0aCIsImlubmVySGVpZ2h0IiwicmVzaXplT2JzZXJ2ZXIiLCJyZXNpemVPYnNlcnZlckNhbGxiYWNrIiwib2JzZXJ2ZSIsImluc3RhbmNlIiwiX2luc3RhbmNlIiwiZGVzdHJveSIsImRpc2Nvbm5lY3QiLCJyZW1vdmVBbGxMaXN0ZW5lcnMiLCJnZXRFbGVtZW50RGltZW5zaW9ucyIsIm5hbWUiLCJ0cmFja0VsZW1lbnREaW1lbnNpb25zIiwiZWxlbWVudCIsInN0b3BUcmFja2luZ0VsZW1lbnREaW1lbnNpb25zIiwidHJhY2tlZEVsZW1lbnQiLCJ1bm9ic2VydmUiLCJkZWxldGUiLCJpc1RyYWNraW5nRWxlbWVudERpbWVuc2lvbnMiLCJoYXMiLCJteFVJU3RvcmUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JBOztBQWhCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFHQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQU1BLHNCQUFzQixHQUFHQyxPQUFPLENBQUMsMEJBQUQsQ0FBdEMsQyxDQUFv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QUFrQixLQUFLbUIsSUFBM0IsRUFBaUM7QUFDN0JJLFFBQUFBLGNBQWMsR0FBR0YsT0FBakI7QUFDSDtBQUNKLEtBSkQ7O0FBS0EsUUFBSUUsY0FBSixFQUFvQjtBQUNoQixXQUFLYixjQUFMLENBQW9CYyxTQUFwQixDQUE4QkQsY0FBOUI7QUFDQSxXQUFLcEIsbUJBQUwsQ0FBeUJzQixNQUF6QixDQUFnQ04sSUFBaEM7QUFDQSxXQUFLbEIsaUJBQUwsQ0FBdUJ3QixNQUF2QixDQUE4QkYsY0FBOUI7QUFDSDtBQUNKOztBQUVNRyxFQUFBQSwyQkFBMkIsQ0FBQ1AsSUFBRCxFQUF3QjtBQUN0RCxXQUFPLEtBQUtoQixtQkFBTCxDQUF5QndCLEdBQXpCLENBQTZCUixJQUE3QixDQUFQO0FBQ0g7O0FBL0Q2Qzs7OzhCQUE3QnBDLE8sZUFDbUIsSTtBQW9GeEN3QixNQUFNLENBQUNxQixTQUFQLEdBQW1CN0MsT0FBTyxDQUFDOEIsUUFBM0IiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMjEgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgRXZlbnRFbWl0dGVyIGZyb20gXCJldmVudHNcIjtcbi8vIFhYWDogcmVzaXplLW9ic2VydmVyLXBvbHlmaWxsIGhhcyB0eXBlcyB0aGF0IG5vdyBjb25mbGljdCB3aXRoIHR5cGVzY3JpcHQnc1xuLy8gb3duIERPTSB0eXBlczogaHR0cHM6Ly9naXRodWIuY29tL3F1ZS1ldGMvcmVzaXplLW9ic2VydmVyLXBvbHlmaWxsL2lzc3Vlcy84MFxuLy8gVXNpbmcgcmVxdWlyZSBoZXJlIHJhdGhlciB0aGFuIGltcG9ydCBpcyBhIGhvcnJlbm91cyB3b3JrYXJvdW5kLiBXZSBzaG91bGRcbi8vIGJlIGFibGUgdG8gcmVtb3ZlIHRoZSBwb2x5ZmlsbCBvbmNlIFNhZmFyaSAxNCBpcyByZWxlYXNlZC5cbmNvbnN0IFJlc2l6ZU9ic2VydmVyUG9seWZpbGwgPSByZXF1aXJlKCdyZXNpemUtb2JzZXJ2ZXItcG9seWZpbGwnKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdmFyLXJlcXVpcmVzXG5pbXBvcnQgUmVzaXplT2JzZXJ2ZXJFbnRyeSBmcm9tICdyZXNpemUtb2JzZXJ2ZXItcG9seWZpbGwvc3JjL1Jlc2l6ZU9ic2VydmVyRW50cnknO1xuXG5leHBvcnQgZW51bSBVSV9FVkVOVFMge1xuICAgIFJlc2l6ZSA9IFwicmVzaXplXCJcbn1cblxuZXhwb3J0IHR5cGUgUmVzaXplT2JzZXJ2ZXJDYWxsYmFja0Z1bmN0aW9uID0gKGVudHJpZXM6IFJlc2l6ZU9ic2VydmVyRW50cnlbXSkgPT4gdm9pZDtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVUlTdG9yZSBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG4gICAgcHJpdmF0ZSBzdGF0aWMgX2luc3RhbmNlOiBVSVN0b3JlID0gbnVsbDtcblxuICAgIHByaXZhdGUgcmVzaXplT2JzZXJ2ZXI6IFJlc2l6ZU9ic2VydmVyO1xuXG4gICAgcHJpdmF0ZSB1aUVsZW1lbnREaW1lbnNpb25zID0gbmV3IE1hcDxzdHJpbmcsIERPTVJlY3RSZWFkT25seT4oKTtcbiAgICBwcml2YXRlIHRyYWNrZWRVaUVsZW1lbnRzID0gbmV3IE1hcDxFbGVtZW50LCBzdHJpbmc+KCk7XG5cbiAgICBwdWJsaWMgd2luZG93V2lkdGg6IG51bWJlcjtcbiAgICBwdWJsaWMgd2luZG93SGVpZ2h0OiBudW1iZXI7XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tcmVzdHJpY3RlZC1wcm9wZXJ0aWVzXG4gICAgICAgIHRoaXMud2luZG93V2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDtcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXJlc3RyaWN0ZWQtcHJvcGVydGllc1xuICAgICAgICB0aGlzLndpbmRvd0hlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodDtcblxuICAgICAgICB0aGlzLnJlc2l6ZU9ic2VydmVyID0gbmV3IFJlc2l6ZU9ic2VydmVyUG9seWZpbGwodGhpcy5yZXNpemVPYnNlcnZlckNhbGxiYWNrKTtcbiAgICAgICAgdGhpcy5yZXNpemVPYnNlcnZlci5vYnNlcnZlKGRvY3VtZW50LmJvZHkpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0IGluc3RhbmNlKCk6IFVJU3RvcmUge1xuICAgICAgICBpZiAoIVVJU3RvcmUuX2luc3RhbmNlKSB7XG4gICAgICAgICAgICBVSVN0b3JlLl9pbnN0YW5jZSA9IG5ldyBVSVN0b3JlKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFVJU3RvcmUuX2luc3RhbmNlO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZGVzdHJveSgpOiB2b2lkIHtcbiAgICAgICAgaWYgKFVJU3RvcmUuX2luc3RhbmNlKSB7XG4gICAgICAgICAgICBVSVN0b3JlLl9pbnN0YW5jZS5yZXNpemVPYnNlcnZlci5kaXNjb25uZWN0KCk7XG4gICAgICAgICAgICBVSVN0b3JlLl9pbnN0YW5jZS5yZW1vdmVBbGxMaXN0ZW5lcnMoKTtcbiAgICAgICAgICAgIFVJU3RvcmUuX2luc3RhbmNlID0gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBnZXRFbGVtZW50RGltZW5zaW9ucyhuYW1lOiBzdHJpbmcpOiBET01SZWN0UmVhZE9ubHkge1xuICAgICAgICByZXR1cm4gdGhpcy51aUVsZW1lbnREaW1lbnNpb25zLmdldChuYW1lKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdHJhY2tFbGVtZW50RGltZW5zaW9ucyhuYW1lOiBzdHJpbmcsIGVsZW1lbnQ6IEVsZW1lbnQpOiB2b2lkIHtcbiAgICAgICAgdGhpcy50cmFja2VkVWlFbGVtZW50cy5zZXQoZWxlbWVudCwgbmFtZSk7XG4gICAgICAgIHRoaXMucmVzaXplT2JzZXJ2ZXIub2JzZXJ2ZShlbGVtZW50KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RvcFRyYWNraW5nRWxlbWVudERpbWVuc2lvbnMobmFtZTogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIGxldCB0cmFja2VkRWxlbWVudDogRWxlbWVudDtcbiAgICAgICAgdGhpcy50cmFja2VkVWlFbGVtZW50cy5mb3JFYWNoKCh0cmFja2VkRWxlbWVudE5hbWUsIGVsZW1lbnQpID0+IHtcbiAgICAgICAgICAgIGlmICh0cmFja2VkRWxlbWVudE5hbWUgPT09IG5hbWUpIHtcbiAgICAgICAgICAgICAgICB0cmFja2VkRWxlbWVudCA9IGVsZW1lbnQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBpZiAodHJhY2tlZEVsZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMucmVzaXplT2JzZXJ2ZXIudW5vYnNlcnZlKHRyYWNrZWRFbGVtZW50KTtcbiAgICAgICAgICAgIHRoaXMudWlFbGVtZW50RGltZW5zaW9ucy5kZWxldGUobmFtZSk7XG4gICAgICAgICAgICB0aGlzLnRyYWNrZWRVaUVsZW1lbnRzLmRlbGV0ZSh0cmFja2VkRWxlbWVudCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgaXNUcmFja2luZ0VsZW1lbnREaW1lbnNpb25zKG5hbWU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy51aUVsZW1lbnREaW1lbnNpb25zLmhhcyhuYW1lKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlc2l6ZU9ic2VydmVyQ2FsbGJhY2sgPSAoZW50cmllczogUmVzaXplT2JzZXJ2ZXJFbnRyeVtdKSA9PiB7XG4gICAgICAgIGNvbnN0IHdpbmRvd0VudHJ5ID0gZW50cmllcy5maW5kKGVudHJ5ID0+IGVudHJ5LnRhcmdldCA9PT0gZG9jdW1lbnQuYm9keSk7XG5cbiAgICAgICAgaWYgKHdpbmRvd0VudHJ5KSB7XG4gICAgICAgICAgICB0aGlzLndpbmRvd1dpZHRoID0gd2luZG93RW50cnkuY29udGVudFJlY3Qud2lkdGg7XG4gICAgICAgICAgICB0aGlzLndpbmRvd0hlaWdodCA9IHdpbmRvd0VudHJ5LmNvbnRlbnRSZWN0LmhlaWdodDtcbiAgICAgICAgfVxuXG4gICAgICAgIGVudHJpZXMuZm9yRWFjaChlbnRyeSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0cmFja2VkRWxlbWVudE5hbWUgPSB0aGlzLnRyYWNrZWRVaUVsZW1lbnRzLmdldChlbnRyeS50YXJnZXQpO1xuICAgICAgICAgICAgaWYgKHRyYWNrZWRFbGVtZW50TmFtZSkge1xuICAgICAgICAgICAgICAgIHRoaXMudWlFbGVtZW50RGltZW5zaW9ucy5zZXQodHJhY2tlZEVsZW1lbnROYW1lLCBlbnRyeS5jb250ZW50UmVjdCk7XG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KHRyYWNrZWRFbGVtZW50TmFtZSwgVUlfRVZFTlRTLlJlc2l6ZSwgZW50cnkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmVtaXQoVUlfRVZFTlRTLlJlc2l6ZSwgZW50cmllcyk7XG4gICAgfTtcbn1cblxud2luZG93Lm14VUlTdG9yZSA9IFVJU3RvcmUuaW5zdGFuY2U7XG4iXX0=