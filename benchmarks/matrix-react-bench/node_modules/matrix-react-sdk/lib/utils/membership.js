"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.EffectiveMembership = void 0;
exports.getEffectiveMembership = getEffectiveMembership;
exports.isJoinedOrNearlyJoined = isJoinedOrNearlyJoined;
exports.leaveRoomBehaviour = leaveRoomBehaviour;
exports.splitRoomsByMembership = splitRoomsByMembership;

var _utils = require("matrix-js-sdk/src/utils");

var _MatrixClientPeg = require("../MatrixClientPeg");

var _languageHandler = require("../languageHandler");

var _Modal = _interopRequireDefault(require("../Modal"));

var _ErrorDialog = _interopRequireDefault(require("../components/views/dialogs/ErrorDialog"));

var _react = _interopRequireDefault(require("react"));

var _dispatcher = _interopRequireDefault(require("../dispatcher/dispatcher"));

var _RoomViewStore = _interopRequireDefault(require("../stores/RoomViewStore"));

/*
Copyright 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

/**
 * Approximation of a membership status for a given room.
 */
let EffectiveMembership;
exports.EffectiveMembership = EffectiveMembership;

(function (EffectiveMembership) {
  EffectiveMembership["Join"] = "JOIN";
  EffectiveMembership["Invite"] = "INVITE";
  EffectiveMembership["Leave"] = "LEAVE";
})(EffectiveMembership || (exports.EffectiveMembership = EffectiveMembership = {}));

function splitRoomsByMembership(rooms) {
  const split = {
    [EffectiveMembership.Invite]: [],
    [EffectiveMembership.Join]: [],
    [EffectiveMembership.Leave]: []
  };

  for (const room of rooms) {
    split[getEffectiveMembership(room.getMyMembership())].push(room);
  }

  return split;
}

function getEffectiveMembership(membership) {
  if (membership === 'invite') {
    return EffectiveMembership.Invite;
  } else if (membership === 'join') {
    // TODO: Include knocks? Update docs as needed in the enum. https://github.com/vector-im/element-web/issues/14237
    return EffectiveMembership.Join;
  } else {
    // Probably a leave, kick, or ban
    return EffectiveMembership.Leave;
  }
}

function isJoinedOrNearlyJoined(membership) {
  const effective = getEffectiveMembership(membership);
  return effective === EffectiveMembership.Join || effective === EffectiveMembership.Invite;
}

async function leaveRoomBehaviour(roomId, retry = true) {
  const cli = _MatrixClientPeg.MatrixClientPeg.get();

  let leavingAllVersions = true;
  const history = cli.getRoomUpgradeHistory(roomId);

  if (history && history.length > 0) {
    const currentRoom = history[history.length - 1];

    if (currentRoom.roomId !== roomId) {
      // The user is trying to leave an older version of the room. Let them through
      // without making them leave the current version of the room.
      leavingAllVersions = false;
    }
  }

  let results = {};

  if (!leavingAllVersions) {
    try {
      await cli.leave(roomId);
    } catch (e) {
      var _e$data;

      if (e !== null && e !== void 0 && (_e$data = e.data) !== null && _e$data !== void 0 && _e$data.errcode) {
        const message = e.data.error || (0, _languageHandler._t)("Unexpected server error trying to leave the room");
        results[roomId] = Object.assign(new Error(message), {
          errcode: e.data.errcode,
          data: e.data
        });
      } else {
        results[roomId] = e || new Error("Failed to leave room for unknown causes");
      }
    }
  } else {
    results = await cli.leaveRoomChain(roomId, retry);
  }

  if (retry) {
    const limitExceededError = Object.values(results).find(e => (e === null || e === void 0 ? void 0 : e.errcode) === "M_LIMIT_EXCEEDED");

    if (limitExceededError) {
      await (0, _utils.sleep)(limitExceededError.data.retry_after_ms ?? 100);
      return leaveRoomBehaviour(roomId, false);
    }
  }

  const errors = Object.entries(results).filter(r => !!r[1]);

  if (errors.length > 0) {
    const messages = [];

    for (const roomErr of errors) {
      const err = roomErr[1]; // [0] is the roomId

      let message = (0, _languageHandler._t)("Unexpected server error trying to leave the room");

      if (err.errcode && err.message) {
        if (err.errcode === 'M_CANNOT_LEAVE_SERVER_NOTICE_ROOM') {
          _Modal.default.createTrackedDialog('Error Leaving Room', '', _ErrorDialog.default, {
            title: (0, _languageHandler._t)("Can't leave Server Notices room"),
            description: (0, _languageHandler._t)("This room is used for important messages from the Homeserver, " + "so you cannot leave it.")
          });

          return;
        }

        message = results[roomId].message;
      }

      messages.push(message, /*#__PURE__*/_react.default.createElement('BR')); // createElement to avoid using a tsx file in utils
    }

    _Modal.default.createTrackedDialog('Error Leaving Room', '', _ErrorDialog.default, {
      title: (0, _languageHandler._t)("Error leaving room"),
      description: messages
    });

    return;
  }

  if (_RoomViewStore.default.getRoomId() === roomId) {
    _dispatcher.default.dispatch({
      action: 'view_home_page'
    });
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9tZW1iZXJzaGlwLnRzIl0sIm5hbWVzIjpbIkVmZmVjdGl2ZU1lbWJlcnNoaXAiLCJzcGxpdFJvb21zQnlNZW1iZXJzaGlwIiwicm9vbXMiLCJzcGxpdCIsIkludml0ZSIsIkpvaW4iLCJMZWF2ZSIsInJvb20iLCJnZXRFZmZlY3RpdmVNZW1iZXJzaGlwIiwiZ2V0TXlNZW1iZXJzaGlwIiwicHVzaCIsIm1lbWJlcnNoaXAiLCJpc0pvaW5lZE9yTmVhcmx5Sm9pbmVkIiwiZWZmZWN0aXZlIiwibGVhdmVSb29tQmVoYXZpb3VyIiwicm9vbUlkIiwicmV0cnkiLCJjbGkiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJsZWF2aW5nQWxsVmVyc2lvbnMiLCJoaXN0b3J5IiwiZ2V0Um9vbVVwZ3JhZGVIaXN0b3J5IiwibGVuZ3RoIiwiY3VycmVudFJvb20iLCJyZXN1bHRzIiwibGVhdmUiLCJlIiwiZGF0YSIsImVycmNvZGUiLCJtZXNzYWdlIiwiZXJyb3IiLCJPYmplY3QiLCJhc3NpZ24iLCJFcnJvciIsImxlYXZlUm9vbUNoYWluIiwibGltaXRFeGNlZWRlZEVycm9yIiwidmFsdWVzIiwiZmluZCIsInJldHJ5X2FmdGVyX21zIiwiZXJyb3JzIiwiZW50cmllcyIsImZpbHRlciIsInIiLCJtZXNzYWdlcyIsInJvb21FcnIiLCJlcnIiLCJNb2RhbCIsImNyZWF0ZVRyYWNrZWREaWFsb2ciLCJFcnJvckRpYWxvZyIsInRpdGxlIiwiZGVzY3JpcHRpb24iLCJSZWFjdCIsImNyZWF0ZUVsZW1lbnQiLCJSb29tVmlld1N0b3JlIiwiZ2V0Um9vbUlkIiwiZGlzIiwiZGlzcGF0Y2giLCJhY3Rpb24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFpQkE7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBekJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtB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Z0M7QUFDNUIsWUFBSWdCLEdBQUcsQ0FBQ2pCLE9BQUosS0FBZ0IsbUNBQXBCLEVBQXlEO0FBQ3JEa0IseUJBQU1DLG1CQUFOLENBQTBCLG9CQUExQixFQUFnRCxFQUFoRCxFQUFvREMsb0JBQXBELEVBQWlFO0FBQzdEQyxZQUFBQSxLQUFLLEVBQUUseUJBQUcsaUNBQUgsQ0FEc0Q7QUFFN0RDLFlBQUFBLFdBQVcsRUFBRSx5QkFDVCxtRUFDQSx5QkFGUztBQUZnRCxXQUFqRTs7QUFPQTtBQUNIOztBQUNEckIsUUFBQUEsT0FBTyxHQUFHTCxPQUFPLENBQUNWLE1BQUQsQ0FBUCxDQUFnQmUsT0FBMUI7QUFDSDs7QUFDRGMsTUFBQUEsUUFBUSxDQUFDbEMsSUFBVCxDQUFjb0IsT0FBZCxlQUF1QnNCLGVBQU1DLGFBQU4sQ0FBb0IsSUFBcEIsQ0FBdkIsRUFoQjBCLENBZ0J5QjtBQUN0RDs7QUFDRE4sbUJBQU1DLG1CQUFOLENBQTBCLG9CQUExQixFQUFnRCxFQUFoRCxFQUFvREMsb0JBQXBELEVBQWlFO0FBQzdEQyxNQUFBQSxLQUFLLEVBQUUseUJBQUcsb0JBQUgsQ0FEc0Q7QUFFN0RDLE1BQUFBLFdBQVcsRUFBRVA7QUFGZ0QsS0FBakU7O0FBSUE7QUFDSDs7QUFFRCxNQUFJVSx1QkFBY0MsU0FBZCxPQUE4QnhDLE1BQWxDLEVBQTBDO0FBQ3RDeUMsd0JBQUlDLFFBQUosQ0FBYTtBQUFFQyxNQUFBQSxNQUFNLEVBQUU7QUFBVixLQUFiO0FBQ0g7QUFDSiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAyMCBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCB7IFJvb20gfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3Jvb21cIjtcbmltcG9ydCB7IHNsZWVwIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL3V0aWxzXCI7XG5cbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gXCIuLi9NYXRyaXhDbGllbnRQZWdcIjtcbmltcG9ydCB7IF90IH0gZnJvbSBcIi4uL2xhbmd1YWdlSGFuZGxlclwiO1xuaW1wb3J0IE1vZGFsIGZyb20gXCIuLi9Nb2RhbFwiO1xuaW1wb3J0IEVycm9yRGlhbG9nIGZyb20gXCIuLi9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvRXJyb3JEaWFsb2dcIjtcbmltcG9ydCBSZWFjdCBmcm9tIFwicmVhY3RcIjtcbmltcG9ydCBkaXMgZnJvbSBcIi4uL2Rpc3BhdGNoZXIvZGlzcGF0Y2hlclwiO1xuaW1wb3J0IFJvb21WaWV3U3RvcmUgZnJvbSBcIi4uL3N0b3Jlcy9Sb29tVmlld1N0b3JlXCI7XG5cbi8qKlxuICogQXBwcm94aW1hdGlvbiBvZiBhIG1lbWJlcnNoaXAgc3RhdHVzIGZvciBhIGdpdmVuIHJvb20uXG4gKi9cbmV4cG9ydCBlbnVtIEVmZmVjdGl2ZU1lbWJlcnNoaXAge1xuICAgIC8qKlxuICAgICAqIFRoZSB1c2VyIGlzIGVmZmVjdGl2ZWx5IGpvaW5lZCB0byB0aGUgcm9vbS4gRm9yIGV4YW1wbGUsIGFjdHVhbGx5IGpvaW5lZFxuICAgICAqIG9yIGtub2NraW5nIG9uIHRoZSByb29tICh3aGVuIHRoYXQgYmVjb21lcyBwb3NzaWJsZSkuXG4gICAgICovXG4gICAgSm9pbiA9IFwiSk9JTlwiLFxuXG4gICAgLyoqXG4gICAgICogVGhlIHVzZXIgaXMgZWZmZWN0aXZlbHkgaW52aXRlZCB0byB0aGUgcm9vbS4gQ3VycmVudGx5IHRoaXMgaXMgYSBkaXJlY3QgbWFwXG4gICAgICogdG8gdGhlIGludml0ZSBtZW1iZXJzaGlwIGFzIG5vIG90aGVyIG1lbWJlcnNoaXAgc3RhdGVzIGFyZSBlZmZlY3RpdmVseVxuICAgICAqIGludml0ZXMuXG4gICAgICovXG4gICAgSW52aXRlID0gXCJJTlZJVEVcIixcblxuICAgIC8qKlxuICAgICAqIFRoZSB1c2VyIGlzIGVmZmVjdGl2ZWx5IG5vIGxvbmdlciBpbiB0aGUgcm9vbS4gRm9yIGV4YW1wbGUsIGtpY2tlZCxcbiAgICAgKiBiYW5uZWQsIG9yIHZvbHVudGFyaWx5IGxlZnQuXG4gICAgICovXG4gICAgTGVhdmUgPSBcIkxFQVZFXCIsXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgTWVtYmVyc2hpcFNwbGl0IHtcbiAgICAvLyBAdHMtaWdub3JlIC0gVFMgd2FudHMgdGhpcyB0byBiZSBhIHN0cmluZyBrZXksIGJ1dCB3ZSBrbm93IGJldHRlci5cbiAgICBbc3RhdGU6IEVmZmVjdGl2ZU1lbWJlcnNoaXBdOiBSb29tW107XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzcGxpdFJvb21zQnlNZW1iZXJzaGlwKHJvb21zOiBSb29tW10pOiBNZW1iZXJzaGlwU3BsaXQge1xuICAgIGNvbnN0IHNwbGl0OiBNZW1iZXJzaGlwU3BsaXQgPSB7XG4gICAgICAgIFtFZmZlY3RpdmVNZW1iZXJzaGlwLkludml0ZV06IFtdLFxuICAgICAgICBbRWZmZWN0aXZlTWVtYmVyc2hpcC5Kb2luXTogW10sXG4gICAgICAgIFtFZmZlY3RpdmVNZW1iZXJzaGlwLkxlYXZlXTogW10sXG4gICAgfTtcblxuICAgIGZvciAoY29uc3Qgcm9vbSBvZiByb29tcykge1xuICAgICAgICBzcGxpdFtnZXRFZmZlY3RpdmVNZW1iZXJzaGlwKHJvb20uZ2V0TXlNZW1iZXJzaGlwKCkpXS5wdXNoKHJvb20pO1xuICAgIH1cblxuICAgIHJldHVybiBzcGxpdDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEVmZmVjdGl2ZU1lbWJlcnNoaXAobWVtYmVyc2hpcDogc3RyaW5nKTogRWZmZWN0aXZlTWVtYmVyc2hpcCB7XG4gICAgaWYgKG1lbWJlcnNoaXAgPT09ICdpbnZpdGUnKSB7XG4gICAgICAgIHJldHVybiBFZmZlY3RpdmVNZW1iZXJzaGlwLkludml0ZTtcbiAgICB9IGVsc2UgaWYgKG1lbWJlcnNoaXAgPT09ICdqb2luJykge1xuICAgICAgICAvLyBUT0RPOiBJbmNsdWRlIGtub2Nrcz8gVXBkYXRlIGRvY3MgYXMgbmVlZGVkIGluIHRoZSBlbnVtLiBodHRwczovL2dpdGh1Yi5jb20vdmVjdG9yLWltL2VsZW1lbnQtd2ViL2lzc3Vlcy8xNDIzN1xuICAgICAgICByZXR1cm4gRWZmZWN0aXZlTWVtYmVyc2hpcC5Kb2luO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIFByb2JhYmx5IGEgbGVhdmUsIGtpY2ssIG9yIGJhblxuICAgICAgICByZXR1cm4gRWZmZWN0aXZlTWVtYmVyc2hpcC5MZWF2ZTtcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0pvaW5lZE9yTmVhcmx5Sm9pbmVkKG1lbWJlcnNoaXA6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGVmZmVjdGl2ZSA9IGdldEVmZmVjdGl2ZU1lbWJlcnNoaXAobWVtYmVyc2hpcCk7XG4gICAgcmV0dXJuIGVmZmVjdGl2ZSA9PT0gRWZmZWN0aXZlTWVtYmVyc2hpcC5Kb2luIHx8IGVmZmVjdGl2ZSA9PT0gRWZmZWN0aXZlTWVtYmVyc2hpcC5JbnZpdGU7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsZWF2ZVJvb21CZWhhdmlvdXIocm9vbUlkOiBzdHJpbmcsIHJldHJ5ID0gdHJ1ZSkge1xuICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICBsZXQgbGVhdmluZ0FsbFZlcnNpb25zID0gdHJ1ZTtcbiAgICBjb25zdCBoaXN0b3J5ID0gY2xpLmdldFJvb21VcGdyYWRlSGlzdG9yeShyb29tSWQpO1xuICAgIGlmIChoaXN0b3J5ICYmIGhpc3RvcnkubGVuZ3RoID4gMCkge1xuICAgICAgICBjb25zdCBjdXJyZW50Um9vbSA9IGhpc3RvcnlbaGlzdG9yeS5sZW5ndGggLSAxXTtcbiAgICAgICAgaWYgKGN1cnJlbnRSb29tLnJvb21JZCAhPT0gcm9vbUlkKSB7XG4gICAgICAgICAgICAvLyBUaGUgdXNlciBpcyB0cnlpbmcgdG8gbGVhdmUgYW4gb2xkZXIgdmVyc2lvbiBvZiB0aGUgcm9vbS4gTGV0IHRoZW0gdGhyb3VnaFxuICAgICAgICAgICAgLy8gd2l0aG91dCBtYWtpbmcgdGhlbSBsZWF2ZSB0aGUgY3VycmVudCB2ZXJzaW9uIG9mIHRoZSByb29tLlxuICAgICAgICAgICAgbGVhdmluZ0FsbFZlcnNpb25zID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBsZXQgcmVzdWx0czogeyBbcm9vbUlkOiBzdHJpbmddOiBFcnJvciAmIHsgZXJyY29kZT86IHN0cmluZywgbWVzc2FnZTogc3RyaW5nLCBkYXRhPzogUmVjb3JkPHN0cmluZywgYW55PiB9IH0gPSB7fTtcbiAgICBpZiAoIWxlYXZpbmdBbGxWZXJzaW9ucykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgY2xpLmxlYXZlKHJvb21JZCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGlmIChlPy5kYXRhPy5lcnJjb2RlKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IGUuZGF0YS5lcnJvciB8fCBfdChcIlVuZXhwZWN0ZWQgc2VydmVyIGVycm9yIHRyeWluZyB0byBsZWF2ZSB0aGUgcm9vbVwiKTtcbiAgICAgICAgICAgICAgICByZXN1bHRzW3Jvb21JZF0gPSBPYmplY3QuYXNzaWduKG5ldyBFcnJvcihtZXNzYWdlKSwgeyBlcnJjb2RlOiBlLmRhdGEuZXJyY29kZSwgZGF0YTogZS5kYXRhIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXN1bHRzW3Jvb21JZF0gPSBlIHx8IG5ldyBFcnJvcihcIkZhaWxlZCB0byBsZWF2ZSByb29tIGZvciB1bmtub3duIGNhdXNlc1wiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc3VsdHMgPSBhd2FpdCBjbGkubGVhdmVSb29tQ2hhaW4ocm9vbUlkLCByZXRyeSk7XG4gICAgfVxuXG4gICAgaWYgKHJldHJ5KSB7XG4gICAgICAgIGNvbnN0IGxpbWl0RXhjZWVkZWRFcnJvciA9IE9iamVjdC52YWx1ZXMocmVzdWx0cykuZmluZChlID0+IGU/LmVycmNvZGUgPT09IFwiTV9MSU1JVF9FWENFRURFRFwiKTtcbiAgICAgICAgaWYgKGxpbWl0RXhjZWVkZWRFcnJvcikge1xuICAgICAgICAgICAgYXdhaXQgc2xlZXAobGltaXRFeGNlZWRlZEVycm9yLmRhdGEucmV0cnlfYWZ0ZXJfbXMgPz8gMTAwKTtcbiAgICAgICAgICAgIHJldHVybiBsZWF2ZVJvb21CZWhhdmlvdXIocm9vbUlkLCBmYWxzZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBlcnJvcnMgPSBPYmplY3QuZW50cmllcyhyZXN1bHRzKS5maWx0ZXIociA9PiAhIXJbMV0pO1xuICAgIGlmIChlcnJvcnMubGVuZ3RoID4gMCkge1xuICAgICAgICBjb25zdCBtZXNzYWdlcyA9IFtdO1xuICAgICAgICBmb3IgKGNvbnN0IHJvb21FcnIgb2YgZXJyb3JzKSB7XG4gICAgICAgICAgICBjb25zdCBlcnIgPSByb29tRXJyWzFdOyAvLyBbMF0gaXMgdGhlIHJvb21JZFxuICAgICAgICAgICAgbGV0IG1lc3NhZ2UgPSBfdChcIlVuZXhwZWN0ZWQgc2VydmVyIGVycm9yIHRyeWluZyB0byBsZWF2ZSB0aGUgcm9vbVwiKTtcbiAgICAgICAgICAgIGlmIChlcnIuZXJyY29kZSAmJiBlcnIubWVzc2FnZSkge1xuICAgICAgICAgICAgICAgIGlmIChlcnIuZXJyY29kZSA9PT0gJ01fQ0FOTk9UX0xFQVZFX1NFUlZFUl9OT1RJQ0VfUk9PTScpIHtcbiAgICAgICAgICAgICAgICAgICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZygnRXJyb3IgTGVhdmluZyBSb29tJywgJycsIEVycm9yRGlhbG9nLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogX3QoXCJDYW4ndCBsZWF2ZSBTZXJ2ZXIgTm90aWNlcyByb29tXCIpLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IF90KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiVGhpcyByb29tIGlzIHVzZWQgZm9yIGltcG9ydGFudCBtZXNzYWdlcyBmcm9tIHRoZSBIb21lc2VydmVyLCBcIiArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJzbyB5b3UgY2Fubm90IGxlYXZlIGl0LlwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbWVzc2FnZSA9IHJlc3VsdHNbcm9vbUlkXS5tZXNzYWdlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbWVzc2FnZXMucHVzaChtZXNzYWdlLCBSZWFjdC5jcmVhdGVFbGVtZW50KCdCUicpKTsgLy8gY3JlYXRlRWxlbWVudCB0byBhdm9pZCB1c2luZyBhIHRzeCBmaWxlIGluIHV0aWxzXG4gICAgICAgIH1cbiAgICAgICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZygnRXJyb3IgTGVhdmluZyBSb29tJywgJycsIEVycm9yRGlhbG9nLCB7XG4gICAgICAgICAgICB0aXRsZTogX3QoXCJFcnJvciBsZWF2aW5nIHJvb21cIiksXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogbWVzc2FnZXMsXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKFJvb21WaWV3U3RvcmUuZ2V0Um9vbUlkKCkgPT09IHJvb21JZCkge1xuICAgICAgICBkaXMuZGlzcGF0Y2goeyBhY3Rpb246ICd2aWV3X2hvbWVfcGFnZScgfSk7XG4gICAgfVxufVxuIl19