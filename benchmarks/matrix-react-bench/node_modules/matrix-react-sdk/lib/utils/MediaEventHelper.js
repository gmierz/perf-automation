"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.MediaEventHelper = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _LazyValue = require("./LazyValue");

var _Media = require("../customisations/Media");

var _DecryptFile = require("./DecryptFile");

var _event = require("matrix-js-sdk/src/@types/event");

var _logger = require("matrix-js-sdk/src/logger");

/*
Copyright 2021 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
// TODO: We should consider caching the blobs. https://github.com/vector-im/element-web/issues/17192
class MediaEventHelper {
  // Either an HTTP or Object URL (when encrypted) to the media.
  // Either the raw or decrypted (when encrypted) contents of the file.
  constructor(event) {
    this.event = event;
    (0, _defineProperty2.default)(this, "sourceUrl", void 0);
    (0, _defineProperty2.default)(this, "thumbnailUrl", void 0);
    (0, _defineProperty2.default)(this, "sourceBlob", void 0);
    (0, _defineProperty2.default)(this, "thumbnailBlob", void 0);
    (0, _defineProperty2.default)(this, "media", void 0);
    (0, _defineProperty2.default)(this, "prepareSourceUrl", async () => {
      if (this.media.isEncrypted) {
        const blob = await this.sourceBlob.value;
        return URL.createObjectURL(blob);
      } else {
        return this.media.srcHttp;
      }
    });
    (0, _defineProperty2.default)(this, "prepareThumbnailUrl", async () => {
      if (this.media.isEncrypted) {
        const blob = await this.thumbnailBlob.value;
        if (blob === null) return null;
        return URL.createObjectURL(blob);
      } else {
        return this.media.thumbnailHttp;
      }
    });
    (0, _defineProperty2.default)(this, "fetchSource", () => {
      if (this.media.isEncrypted) {
        const content = this.event.getContent();
        return (0, _DecryptFile.decryptFile)(content.file, content.info);
      }

      return this.media.downloadSource().then(r => r.blob());
    });
    (0, _defineProperty2.default)(this, "fetchThumbnail", () => {
      if (!this.media.hasThumbnail) return Promise.resolve(null);

      if (this.media.isEncrypted) {
        var _content$info;

        const content = this.event.getContent();

        if ((_content$info = content.info) !== null && _content$info !== void 0 && _content$info.thumbnail_file) {
          return (0, _DecryptFile.decryptFile)(content.info.thumbnail_file, content.info.thumbnail_info);
        } else {
          // "Should never happen"
          _logger.logger.warn("Media claims to have thumbnail and is encrypted, but no thumbnail_file found");

          return Promise.resolve(null);
        }
      }

      return fetch(this.media.thumbnailHttp).then(r => r.blob());
    });
    this.sourceUrl = new _LazyValue.LazyValue(this.prepareSourceUrl);
    this.thumbnailUrl = new _LazyValue.LazyValue(this.prepareThumbnailUrl);
    this.sourceBlob = new _LazyValue.LazyValue(this.fetchSource);
    this.thumbnailBlob = new _LazyValue.LazyValue(this.fetchThumbnail);
    this.media = (0, _Media.mediaFromContent)(this.event.getContent());
  }

  get fileName() {
    return this.event.getContent().body || "download";
  }

  destroy() {
    if (this.media.isEncrypted) {
      if (this.sourceUrl.present) URL.revokeObjectURL(this.sourceUrl.cachedValue);
      if (this.thumbnailUrl.present) URL.revokeObjectURL(this.thumbnailUrl.cachedValue);
    }
  }

  static isEligible(event) {
    if (!event) return false;
    if (event.isRedacted()) return false;
    if (event.getType() === _event.EventType.Sticker) return true;
    if (event.getType() !== _event.EventType.RoomMessage) return false;
    const content = event.getContent();
    const mediaMsgTypes = [_event.MsgType.Video, _event.MsgType.Audio, _event.MsgType.Image, _event.MsgType.File];
    if (mediaMsgTypes.includes(content.msgtype)) return true;
    if (typeof content.url === 'string') return true; // Finally, it's probably not media

    return false;
  }

}

exports.MediaEventHelper = MediaEventHelper;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9NZWRpYUV2ZW50SGVscGVyLnRzIl0sIm5hbWVzIjpbIk1lZGlhRXZlbnRIZWxwZXIiLCJjb25zdHJ1Y3RvciIsImV2ZW50IiwibWVkaWEiLCJpc0VuY3J5cHRlZCIsImJsb2IiLCJzb3VyY2VCbG9iIiwidmFsdWUiLCJVUkwiLCJjcmVhdGVPYmplY3RVUkwiLCJzcmNIdHRwIiwidGh1bWJuYWlsQmxvYiIsInRodW1ibmFpbEh0dHAiLCJjb250ZW50IiwiZ2V0Q29udGVudCIsImZpbGUiLCJpbmZvIiwiZG93bmxvYWRTb3VyY2UiLCJ0aGVuIiwiciIsImhhc1RodW1ibmFpbCIsIlByb21pc2UiLCJyZXNvbHZlIiwidGh1bWJuYWlsX2ZpbGUiLCJ0aHVtYm5haWxfaW5mbyIsImxvZ2dlciIsIndhcm4iLCJmZXRjaCIsInNvdXJjZVVybCIsIkxhenlWYWx1ZSIsInByZXBhcmVTb3VyY2VVcmwiLCJ0aHVtYm5haWxVcmwiLCJwcmVwYXJlVGh1bWJuYWlsVXJsIiwiZmV0Y2hTb3VyY2UiLCJmZXRjaFRodW1ibmFpbCIsImZpbGVOYW1lIiwiYm9keSIsImRlc3Ryb3kiLCJwcmVzZW50IiwicmV2b2tlT2JqZWN0VVJMIiwiY2FjaGVkVmFsdWUiLCJpc0VsaWdpYmxlIiwiaXNSZWRhY3RlZCIsImdldFR5cGUiLCJFdmVudFR5cGUiLCJTdGlja2VyIiwiUm9vbU1lc3NhZ2UiLCJtZWRpYU1zZ1R5cGVzIiwiTXNnVHlwZSIsIlZpZGVvIiwiQXVkaW8iLCJJbWFnZSIsIkZpbGUiLCJpbmNsdWRlcyIsIm1zZ3R5cGUiLCJ1cmwiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBaUJBOztBQUNBOztBQUNBOztBQUdBOztBQUVBOztBQXhCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFZQTtBQUVPLE1BQU1BLGdCQUFOLENBQStDO0FBQ2xEO0FBSUE7QUFNT0Ms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LkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgeyBNYXRyaXhFdmVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyY1wiO1xuaW1wb3J0IHsgTGF6eVZhbHVlIH0gZnJvbSBcIi4vTGF6eVZhbHVlXCI7XG5pbXBvcnQgeyBNZWRpYSwgbWVkaWFGcm9tQ29udGVudCB9IGZyb20gXCIuLi9jdXN0b21pc2F0aW9ucy9NZWRpYVwiO1xuaW1wb3J0IHsgZGVjcnlwdEZpbGUgfSBmcm9tIFwiLi9EZWNyeXB0RmlsZVwiO1xuaW1wb3J0IHsgSU1lZGlhRXZlbnRDb250ZW50IH0gZnJvbSBcIi4uL2N1c3RvbWlzYXRpb25zL21vZGVscy9JTWVkaWFFdmVudENvbnRlbnRcIjtcbmltcG9ydCB7IElEZXN0cm95YWJsZSB9IGZyb20gXCIuL0lEZXN0cm95YWJsZVwiO1xuaW1wb3J0IHsgRXZlbnRUeXBlLCBNc2dUeXBlIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL0B0eXBlcy9ldmVudFwiO1xuXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbG9nZ2VyXCI7XG5cbi8vIFRPRE86IFdlIHNob3VsZCBjb25zaWRlciBjYWNoaW5nIHRoZSBibG9icy4gaHR0cHM6Ly9naXRodWIuY29tL3ZlY3Rvci1pbS9lbGVtZW50LXdlYi9pc3N1ZXMvMTcxOTJcblxuZXhwb3J0IGNsYXNzIE1lZGlhRXZlbnRIZWxwZXIgaW1wbGVtZW50cyBJRGVzdHJveWFibGUge1xuICAgIC8vIEVpdGhlciBhbiBIVFRQIG9yIE9iamVjdCBVUkwgKHdoZW4gZW5jcnlwdGVkKSB0byB0aGUgbWVkaWEuXG4gICAgcHVibGljIHJlYWRvbmx5IHNvdXJjZVVybDogTGF6eVZhbHVlPHN0cmluZz47XG4gICAgcHVibGljIHJlYWRvbmx5IHRodW1ibmFpbFVybDogTGF6eVZhbHVlPHN0cmluZz47XG5cbiAgICAvLyBFaXRoZXIgdGhlIHJhdyBvciBkZWNyeXB0ZWQgKHdoZW4gZW5jcnlwdGVkKSBjb250ZW50cyBvZiB0aGUgZmlsZS5cbiAgICBwdWJsaWMgcmVhZG9ubHkgc291cmNlQmxvYjogTGF6eVZhbHVlPEJsb2I+O1xuICAgIHB1YmxpYyByZWFkb25seSB0aHVtYm5haWxCbG9iOiBMYXp5VmFsdWU8QmxvYj47XG5cbiAgICBwdWJsaWMgcmVhZG9ubHkgbWVkaWE6IE1lZGlhO1xuXG4gICAgcHVibGljIGNvbnN0cnVjdG9yKHByaXZhdGUgZXZlbnQ6IE1hdHJpeEV2ZW50KSB7XG4gICAgICAgIHRoaXMuc291cmNlVXJsID0gbmV3IExhenlWYWx1ZSh0aGlzLnByZXBhcmVTb3VyY2VVcmwpO1xuICAgICAgICB0aGlzLnRodW1ibmFpbFVybCA9IG5ldyBMYXp5VmFsdWUodGhpcy5wcmVwYXJlVGh1bWJuYWlsVXJsKTtcbiAgICAgICAgdGhpcy5zb3VyY2VCbG9iID0gbmV3IExhenlWYWx1ZSh0aGlzLmZldGNoU291cmNlKTtcbiAgICAgICAgdGhpcy50aHVtYm5haWxCbG9iID0gbmV3IExhenlWYWx1ZSh0aGlzLmZldGNoVGh1bWJuYWlsKTtcblxuICAgICAgICB0aGlzLm1lZGlhID0gbWVkaWFGcm9tQ29udGVudCh0aGlzLmV2ZW50LmdldENvbnRlbnQoKSk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBmaWxlTmFtZSgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5ldmVudC5nZXRDb250ZW50PElNZWRpYUV2ZW50Q29udGVudD4oKS5ib2R5IHx8IFwiZG93bmxvYWRcIjtcbiAgICB9XG5cbiAgICBwdWJsaWMgZGVzdHJveSgpIHtcbiAgICAgICAgaWYgKHRoaXMubWVkaWEuaXNFbmNyeXB0ZWQpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnNvdXJjZVVybC5wcmVzZW50KSBVUkwucmV2b2tlT2JqZWN0VVJMKHRoaXMuc291cmNlVXJsLmNhY2hlZFZhbHVlKTtcbiAgICAgICAgICAgIGlmICh0aGlzLnRodW1ibmFpbFVybC5wcmVzZW50KSBVUkwucmV2b2tlT2JqZWN0VVJMKHRoaXMudGh1bWJuYWlsVXJsLmNhY2hlZFZhbHVlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgcHJlcGFyZVNvdXJjZVVybCA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgaWYgKHRoaXMubWVkaWEuaXNFbmNyeXB0ZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IGJsb2IgPSBhd2FpdCB0aGlzLnNvdXJjZUJsb2IudmFsdWU7XG4gICAgICAgICAgICByZXR1cm4gVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm1lZGlhLnNyY0h0dHA7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBwcmVwYXJlVGh1bWJuYWlsVXJsID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICBpZiAodGhpcy5tZWRpYS5pc0VuY3J5cHRlZCkge1xuICAgICAgICAgICAgY29uc3QgYmxvYiA9IGF3YWl0IHRoaXMudGh1bWJuYWlsQmxvYi52YWx1ZTtcbiAgICAgICAgICAgIGlmIChibG9iID09PSBudWxsKSByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIHJldHVybiBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMubWVkaWEudGh1bWJuYWlsSHR0cDtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwcml2YXRlIGZldGNoU291cmNlID0gKCkgPT4ge1xuICAgICAgICBpZiAodGhpcy5tZWRpYS5pc0VuY3J5cHRlZCkge1xuICAgICAgICAgICAgY29uc3QgY29udGVudCA9IHRoaXMuZXZlbnQuZ2V0Q29udGVudDxJTWVkaWFFdmVudENvbnRlbnQ+KCk7XG4gICAgICAgICAgICByZXR1cm4gZGVjcnlwdEZpbGUoY29udGVudC5maWxlLCBjb250ZW50LmluZm8pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLm1lZGlhLmRvd25sb2FkU291cmNlKCkudGhlbihyID0+IHIuYmxvYigpKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBmZXRjaFRodW1ibmFpbCA9ICgpID0+IHtcbiAgICAgICAgaWYgKCF0aGlzLm1lZGlhLmhhc1RodW1ibmFpbCkgcmV0dXJuIFByb21pc2UucmVzb2x2ZShudWxsKTtcblxuICAgICAgICBpZiAodGhpcy5tZWRpYS5pc0VuY3J5cHRlZCkge1xuICAgICAgICAgICAgY29uc3QgY29udGVudCA9IHRoaXMuZXZlbnQuZ2V0Q29udGVudDxJTWVkaWFFdmVudENvbnRlbnQ+KCk7XG4gICAgICAgICAgICBpZiAoY29udGVudC5pbmZvPy50aHVtYm5haWxfZmlsZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBkZWNyeXB0RmlsZShjb250ZW50LmluZm8udGh1bWJuYWlsX2ZpbGUsIGNvbnRlbnQuaW5mby50aHVtYm5haWxfaW5mbyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIFwiU2hvdWxkIG5ldmVyIGhhcHBlblwiXG4gICAgICAgICAgICAgICAgbG9nZ2VyLndhcm4oXCJNZWRpYSBjbGFpbXMgdG8gaGF2ZSB0aHVtYm5haWwgYW5kIGlzIGVuY3J5cHRlZCwgYnV0IG5vIHRodW1ibmFpbF9maWxlIGZvdW5kXCIpO1xuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobnVsbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZmV0Y2godGhpcy5tZWRpYS50aHVtYm5haWxIdHRwKS50aGVuKHIgPT4gci5ibG9iKCkpO1xuICAgIH07XG5cbiAgICBwdWJsaWMgc3RhdGljIGlzRWxpZ2libGUoZXZlbnQ6IE1hdHJpeEV2ZW50KTogYm9vbGVhbiB7XG4gICAgICAgIGlmICghZXZlbnQpIHJldHVybiBmYWxzZTtcbiAgICAgICAgaWYgKGV2ZW50LmlzUmVkYWN0ZWQoKSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICBpZiAoZXZlbnQuZ2V0VHlwZSgpID09PSBFdmVudFR5cGUuU3RpY2tlcikgcmV0dXJuIHRydWU7XG4gICAgICAgIGlmIChldmVudC5nZXRUeXBlKCkgIT09IEV2ZW50VHlwZS5Sb29tTWVzc2FnZSkgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgIGNvbnN0IGNvbnRlbnQgPSBldmVudC5nZXRDb250ZW50KCk7XG4gICAgICAgIGNvbnN0IG1lZGlhTXNnVHlwZXM6IHN0cmluZ1tdID0gW1xuICAgICAgICAgICAgTXNnVHlwZS5WaWRlbyxcbiAgICAgICAgICAgIE1zZ1R5cGUuQXVkaW8sXG4gICAgICAgICAgICBNc2dUeXBlLkltYWdlLFxuICAgICAgICAgICAgTXNnVHlwZS5GaWxlLFxuICAgICAgICBdO1xuICAgICAgICBpZiAobWVkaWFNc2dUeXBlcy5pbmNsdWRlcyhjb250ZW50Lm1zZ3R5cGUpKSByZXR1cm4gdHJ1ZTtcbiAgICAgICAgaWYgKHR5cGVvZihjb250ZW50LnVybCkgPT09ICdzdHJpbmcnKSByZXR1cm4gdHJ1ZTtcblxuICAgICAgICAvLyBGaW5hbGx5LCBpdCdzIHByb2JhYmx5IG5vdCBtZWRpYVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxufVxuIl19