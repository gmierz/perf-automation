"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.showSpaceSettings = exports.showSpaceInvite = exports.showCreateNewSubspace = exports.showCreateNewRoom = exports.showAddExistingSubspace = exports.showAddExistingRooms = exports.shouldShowSpaceSettings = exports.makeSpaceParentEvent = exports.leaveSpace = exports.createSpaceFromCommunity = exports.bulkSpaceBehaviour = void 0;

var _react = _interopRequireDefault(require("react"));

var _event = require("matrix-js-sdk/src/@types/event");

var _Permalinks = require("./permalinks/Permalinks");

var _Modal = _interopRequireDefault(require("../Modal"));

var _SpaceSettingsDialog = _interopRequireDefault(require("../components/views/dialogs/SpaceSettingsDialog"));

var _AddExistingToSpaceDialog = _interopRequireDefault(require("../components/views/dialogs/AddExistingToSpaceDialog"));

var _CreateRoomDialog = _interopRequireDefault(require("../components/views/dialogs/CreateRoomDialog"));

var _createRoom = _interopRequireDefault(require("../createRoom"));

var _languageHandler = require("../languageHandler");

var _SpacePublicShare = _interopRequireDefault(require("../components/views/spaces/SpacePublicShare"));

var _InfoDialog = _interopRequireDefault(require("../components/views/dialogs/InfoDialog"));

var _RoomInvite = require("../RoomInvite");

var _CreateSubspaceDialog = _interopRequireDefault(require("../components/views/dialogs/CreateSubspaceDialog"));

var _AddExistingSubspaceDialog = _interopRequireDefault(require("../components/views/dialogs/AddExistingSubspaceDialog"));

var _dispatcher = _interopRequireDefault(require("../dispatcher/dispatcher"));

var _RoomViewStore = _interopRequireDefault(require("../stores/RoomViewStore"));

var _actions = require("../dispatcher/actions");

var _membership = require("./membership");

var _Spinner = _interopRequireDefault(require("../components/views/elements/Spinner"));

var _LeaveSpaceDialog = _interopRequireDefault(require("../components/views/dialogs/LeaveSpaceDialog"));

var _CreateSpaceFromCommunityDialog = _interopRequireDefault(require("../components/views/dialogs/CreateSpaceFromCommunityDialog"));

/*
Copyright 2021 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const shouldShowSpaceSettings = space => {
  const userId = space.client.getUserId();
  return space.getMyMembership() === "join" && (space.currentState.maySendStateEvent(_event.EventType.RoomAvatar, userId) || space.currentState.maySendStateEvent(_event.EventType.RoomName, userId) || space.currentState.maySendStateEvent(_event.EventType.RoomTopic, userId) || space.currentState.maySendStateEvent(_event.EventType.RoomJoinRules, userId));
};

exports.shouldShowSpaceSettings = shouldShowSpaceSettings;

const makeSpaceParentEvent = (room, canonical = false) => ({
  type: _event.EventType.SpaceParent,
  content: {
    "via": (0, _Permalinks.calculateRoomVia)(room),
    "canonical": canonical
  },
  state_key: room.roomId
});

exports.makeSpaceParentEvent = makeSpaceParentEvent;

const showSpaceSettings = space => {
  _Modal.default.createTrackedDialog("Space Settings", "", _SpaceSettingsDialog.default, {
    matrixClient: space.client,
    space
  },
  /*className=*/
  null,
  /*isPriority=*/
  false,
  /*isStatic=*/
  true);
};

exports.showSpaceSettings = showSpaceSettings;

const showAddExistingRooms = space => {
  _Modal.default.createTrackedDialog("Space Landing", "Add Existing", _AddExistingToSpaceDialog.default, {
    onCreateRoomClick: () => showCreateNewRoom(space),
    onAddSubspaceClick: () => showAddExistingSubspace(space),
    space,
    onFinished: added => {
      if (added && _RoomViewStore.default.getRoomId() === space.roomId) {
        _dispatcher.default.fire(_actions.Action.UpdateSpaceHierarchy);
      }
    }
  }, "mx_AddExistingToSpaceDialog_wrapper");
};

exports.showAddExistingRooms = showAddExistingRooms;

const showCreateNewRoom = async space => {
  const modal = _Modal.default.createTrackedDialog("Space Landing", "Create Room", _CreateRoomDialog.default, {
    defaultPublic: space.getJoinRule() === "public",
    parentSpace: space
  });

  const [shouldCreate, opts] = await modal.finished;

  if (shouldCreate) {
    await (0, _createRoom.default)(opts);
  }

  return shouldCreate;
};

exports.showCreateNewRoom = showCreateNewRoom;

const showSpaceInvite = (space, initialText = "") => {
  if (space.getJoinRule() === "public") {
    const modal = _Modal.default.createTrackedDialog("Space Invite", "User Menu", _InfoDialog.default, {
      title: (0, _languageHandler._t)("Invite to %(spaceName)s", {
        spaceName: space.name
      }),
      description: /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement("span", null, (0, _languageHandler._t)("Share your public space")), /*#__PURE__*/_react.default.createElement(_SpacePublicShare.default, {
        space: space,
        onFinished: () => modal.close()
      })),
      fixedWidth: false,
      button: false,
      className: "mx_SpacePanel_sharePublicSpace",
      hasCloseButton: true
    });
  } else {
    (0, _RoomInvite.showRoomInviteDialog)(space.roomId, initialText);
  }
};

exports.showSpaceInvite = showSpaceInvite;

const showAddExistingSubspace = space => {
  _Modal.default.createTrackedDialog("Space Landing", "Create Subspace", _AddExistingSubspaceDialog.default, {
    space,
    onCreateSubspaceClick: () => showCreateNewSubspace(space),
    onFinished: added => {
      if (added && _RoomViewStore.default.getRoomId() === space.roomId) {
        _dispatcher.default.fire(_actions.Action.UpdateSpaceHierarchy);
      }
    }
  }, "mx_AddExistingToSpaceDialog_wrapper");
};

exports.showAddExistingSubspace = showAddExistingSubspace;

const showCreateNewSubspace = space => {
  _Modal.default.createTrackedDialog("Space Landing", "Create Subspace", _CreateSubspaceDialog.default, {
    space,
    onAddExistingSpaceClick: () => showAddExistingSubspace(space),
    onFinished: added => {
      if (added && _RoomViewStore.default.getRoomId() === space.roomId) {
        _dispatcher.default.fire(_actions.Action.UpdateSpaceHierarchy);
      }
    }
  }, "mx_CreateSubspaceDialog_wrapper");
};

exports.showCreateNewSubspace = showCreateNewSubspace;

const bulkSpaceBehaviour = async (space, children, fn) => {
  const modal = _Modal.default.createDialog(_Spinner.default, null, "mx_Dialog_spinner");

  try {
    for (const room of children) {
      await fn(room);
    }

    await fn(space);
  } finally {
    modal.close();
  }
};

exports.bulkSpaceBehaviour = bulkSpaceBehaviour;

const leaveSpace = space => {
  _Modal.default.createTrackedDialog("Leave Space", "", _LeaveSpaceDialog.default, {
    space,
    onFinished: async (leave, rooms) => {
      if (!leave) return;
      await bulkSpaceBehaviour(space, rooms, room => (0, _membership.leaveRoomBehaviour)(room.roomId));

      _dispatcher.default.dispatch({
        action: "after_leave_room",
        room_id: space.roomId
      });
    }
  }, "mx_LeaveSpaceDialog_wrapper");
};

exports.leaveSpace = leaveSpace;

const createSpaceFromCommunity = (cli, groupId) => {
  return _Modal.default.createTrackedDialog('Create Space', 'from community', _CreateSpaceFromCommunityDialog.default, {
    matrixClient: cli,
    groupId
  }, "mx_CreateSpaceFromCommunityDialog_wrapper").finished;
};

exports.createSpaceFromCommunity = createSpaceFromCommunity;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9zcGFjZS50c3giXSwibmFtZXMiOlsic2hvdWxkU2hvd1NwYWNlU2V0dGluZ3MiLCJzcGFjZSIsInVzZXJJZCIsImNsaWVudCIsImdldFVzZXJJZCIsImdldE15TWVtYmVyc2hpcCIsImN1cnJlbnRTdGF0ZSIsIm1heVNlbmRTdGF0ZUV2ZW50IiwiRXZlbnRUeXBlIiwiUm9vbUF2YXRhciIsIlJvb21OYW1lIiwiUm9vbVRvcGljIiwiUm9vbUpvaW5SdWxlcyIsIm1ha2VTcGFjZVBhcmVudEV2ZW50Iiwicm9vbSIsImNhbm9uaWNhbCIsInR5cGUiLCJTcGFjZVBhcmVudCIsImNvbnRlbnQiLCJzdGF0ZV9rZXkiLCJyb29tSWQiLCJzaG93U3BhY2VTZXR0aW5ncyIsIk1vZGFsIiwiY3JlYXRlVHJhY2tlZERpYWxvZyIsIlNwYWNlU2V0dGluZ3NEaWFsb2ciLCJtYXRyaXhDbGllbnQiLCJzaG93QWRkRXhpc3RpbmdSb29tcyIsIkFkZEV4aXN0aW5nVG9TcGFjZURpYWxvZyIsIm9uQ3JlYXRlUm9vbUNsaWNrIiwic2hvd0NyZWF0ZU5ld1Jvb20iLCJvbkFkZFN1YnNwYWNlQ2xpY2siLCJzaG93QWRkRXhpc3RpbmdTdWJzcGFjZSIsIm9uRmluaXNoZWQiLCJhZGRlZCIsIlJvb21WaWV3U3RvcmUiLCJnZXRSb29tSWQiLCJkZWZhdWx0RGlzcGF0Y2hlciIsImZpcmUiLCJBY3Rpb24iLCJVcGRhdGVTcGFjZUhpZXJhcmNoeSIsIm1vZGFsIiwiQ3JlYXRlUm9vbURpYWxvZyIsImRlZmF1bHRQdWJsaWMiLCJnZXRKb2luUnVsZSIsInBhcmVudFNwYWNlIiwic2hvdWxkQ3JlYXRlIiwib3B0cyIsImZpbmlzaGVkIiwic2hvd1NwYWNlSW52aXRlIiwiaW5pdGlhbFRleHQiLCJJbmZvRGlhbG9nIiwidGl0bGUiLCJzcGFjZU5hbWUiLCJuYW1lIiwiZGVzY3JpcHRpb24iLCJjbG9zZSIsImZpeGVkV2lkdGgiLCJidXR0b24iLCJjbGFzc05hbWUiLCJoYXNDbG9zZUJ1dHRvbiIsIkFkZEV4aXN0aW5nU3Vic3BhY2VEaWFsb2ciLCJvbkNyZWF0ZVN1YnNwYWNlQ2xpY2siLCJzaG93Q3JlYXRlTmV3U3Vic3BhY2UiLCJDcmVhdGVTdWJzcGFjZURpYWxvZyIsIm9uQWRkRXhpc3RpbmdTcGFjZUNsaWNrIiwiYnVsa1NwYWNlQmVoYXZpb3VyIiwiY2hpbGRyZW4iLCJmbiIsImNyZWF0ZURpYWxvZyIsIlNwaW5uZXIiLCJsZWF2ZVNwYWNlIiwiTGVhdmVTcGFjZURpYWxvZyIsImxlYXZlIiwicm9vbXMiLCJkaXMiLCJkaXNwYXRjaCIsImFjdGlvbiIsInJvb21faWQiLCJjcmVhdGVTcGFjZUZyb21Db21tdW5pdHkiLCJjbGkiLCJncm91cElkIiwiQ3JlYXRlU3BhY2VGcm9tQ29tbXVuaXR5RGlhbG9nIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFnQkE7O0FBRUE7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBeENBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQTRCTyxNQUFNQSx1QkFBdUIsR0FBSUMsS0FBRCxJQUFpQjtBQUNwRCxRQUFNQyxNQUFNLEdBQUdELEtBQUssQ0FBQ0UsTUFBTixDQUFhQyxTQUFiLEVBQWY7QUFDQSxTQUFPSCxLQUFLLENBQUNJLGVBQU4sT0FBNEIsTUFBNUIsS0FDQ0osS0FBSyxDQUFDSyxZQUFOLENBQW1CQyxpQkFBbkIsQ0FBcUNDLGlCQUFVQyxVQUEvQyxFQUEyRFAsTUFBM0QsS0FDR0QsS0FBSyxDQUFDSyxZQUFOLENBQW1CQyxpQkFBbkIsQ0FBcUNDLGlCQUFVRSxRQUEvQyxFQUF5RFIsTUFBekQsQ0FESCxJQUVHRCxLQUFLLENBQUNLLFlBQU4sQ0FBbUJDLGlCQUFuQixD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RDtBQUNoRyxTQUFPMUQsZUFBTUMsbUJBQU4sQ0FBMEIsY0FBMUIsRUFBMEMsZ0JBQTFDLEVBQTREMEQsdUNBQTVELEVBQTRGO0FBQy9GeEQsSUFBQUEsWUFBWSxFQUFFc0QsR0FEaUY7QUFFL0ZDLElBQUFBO0FBRitGLEdBQTVGLEVBR0osMkNBSEksRUFHeUNqQyxRQUhoRDtBQUlILENBTE0iLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMjEgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSBcInJlYWN0XCI7XG5pbXBvcnQgeyBSb29tIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yb29tXCI7XG5pbXBvcnQgeyBFdmVudFR5cGUgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvQHR5cGVzL2V2ZW50XCI7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnQgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvY2xpZW50XCI7XG5cbmltcG9ydCB7IGNhbGN1bGF0ZVJvb21WaWEgfSBmcm9tIFwiLi9wZXJtYWxpbmtzL1Blcm1hbGlua3NcIjtcbmltcG9ydCBNb2RhbCBmcm9tIFwiLi4vTW9kYWxcIjtcbmltcG9ydCBTcGFjZVNldHRpbmdzRGlhbG9nIGZyb20gXCIuLi9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvU3BhY2VTZXR0aW5nc0RpYWxvZ1wiO1xuaW1wb3J0IEFkZEV4aXN0aW5nVG9TcGFjZURpYWxvZyBmcm9tIFwiLi4vY29tcG9uZW50cy92aWV3cy9kaWFsb2dzL0FkZEV4aXN0aW5nVG9TcGFjZURpYWxvZ1wiO1xuaW1wb3J0IENyZWF0ZVJvb21EaWFsb2cgZnJvbSBcIi4uL2NvbXBvbmVudHMvdmlld3MvZGlhbG9ncy9DcmVhdGVSb29tRGlhbG9nXCI7XG5pbXBvcnQgY3JlYXRlUm9vbSwgeyBJT3B0cyB9IGZyb20gXCIuLi9jcmVhdGVSb29tXCI7XG5pbXBvcnQgeyBfdCB9IGZyb20gXCIuLi9sYW5ndWFnZUhhbmRsZXJcIjtcbmltcG9ydCBTcGFjZVB1YmxpY1NoYXJlIGZyb20gXCIuLi9jb21wb25lbnRzL3ZpZXdzL3NwYWNlcy9TcGFjZVB1YmxpY1NoYXJlXCI7XG5pbXBvcnQgSW5mb0RpYWxvZyBmcm9tIFwiLi4vY29tcG9uZW50cy92aWV3cy9kaWFsb2dzL0luZm9EaWFsb2dcIjtcbmltcG9ydCB7IHNob3dSb29tSW52aXRlRGlhbG9nIH0gZnJvbSBcIi4uL1Jvb21JbnZpdGVcIjtcbmltcG9ydCBDcmVhdGVTdWJzcGFjZURpYWxvZyBmcm9tIFwiLi4vY29tcG9uZW50cy92aWV3cy9kaWFsb2dzL0NyZWF0ZVN1YnNwYWNlRGlhbG9nXCI7XG5pbXBvcnQgQWRkRXhpc3RpbmdTdWJzcGFjZURpYWxvZyBmcm9tIFwiLi4vY29tcG9uZW50cy92aWV3cy9kaWFsb2dzL0FkZEV4aXN0aW5nU3Vic3BhY2VEaWFsb2dcIjtcbmltcG9ydCBkZWZhdWx0RGlzcGF0Y2hlciBmcm9tIFwiLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyXCI7XG5pbXBvcnQgUm9vbVZpZXdTdG9yZSBmcm9tIFwiLi4vc3RvcmVzL1Jvb21WaWV3U3RvcmVcIjtcbmltcG9ydCB7IEFjdGlvbiB9IGZyb20gXCIuLi9kaXNwYXRjaGVyL2FjdGlvbnNcIjtcbmltcG9ydCB7IGxlYXZlUm9vbUJlaGF2aW91ciB9IGZyb20gXCIuL21lbWJlcnNoaXBcIjtcbmltcG9ydCBTcGlubmVyIGZyb20gXCIuLi9jb21wb25lbnRzL3ZpZXdzL2VsZW1lbnRzL1NwaW5uZXJcIjtcbmltcG9ydCBkaXMgZnJvbSBcIi4uL2Rpc3BhdGNoZXIvZGlzcGF0Y2hlclwiO1xuaW1wb3J0IExlYXZlU3BhY2VEaWFsb2cgZnJvbSBcIi4uL2NvbXBvbmVudHMvdmlld3MvZGlhbG9ncy9MZWF2ZVNwYWNlRGlhbG9nXCI7XG5pbXBvcnQgQ3JlYXRlU3BhY2VGcm9tQ29tbXVuaXR5RGlhbG9nIGZyb20gXCIuLi9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvQ3JlYXRlU3BhY2VGcm9tQ29tbXVuaXR5RGlhbG9nXCI7XG5cbmV4cG9ydCBjb25zdCBzaG91bGRTaG93U3BhY2VTZXR0aW5ncyA9IChzcGFjZTogUm9vbSkgPT4ge1xuICAgIGNvbnN0IHVzZXJJZCA9IHNwYWNlLmNsaWVudC5nZXRVc2VySWQoKTtcbiAgICByZXR1cm4gc3BhY2UuZ2V0TXlNZW1iZXJzaGlwKCkgPT09IFwiam9pblwiXG4gICAgICAgICYmIChzcGFjZS5jdXJyZW50U3RhdGUubWF5U2VuZFN0YXRlRXZlbnQoRXZlbnRUeXBlLlJvb21BdmF0YXIsIHVzZXJJZClcbiAgICAgICAgICAgIHx8IHNwYWNlLmN1cnJlbnRTdGF0ZS5tYXlTZW5kU3RhdGVFdmVudChFdmVudFR5cGUuUm9vbU5hbWUsIHVzZXJJZClcbiAgICAgICAgICAgIHx8IHNwYWNlLmN1cnJlbnRTdGF0ZS5tYXlTZW5kU3RhdGVFdmVudChFdmVudFR5cGUuUm9vbVRvcGljLCB1c2VySWQpXG4gICAgICAgICAgICB8fCBzcGFjZS5jdXJyZW50U3RhdGUubWF5U2VuZFN0YXRlRXZlbnQoRXZlbnRUeXBlLlJvb21Kb2luUnVsZXMsIHVzZXJJZCkpO1xufTtcblxuZXhwb3J0IGNvbnN0IG1ha2VTcGFjZVBhcmVudEV2ZW50ID0gKHJvb206IFJvb20sIGNhbm9uaWNhbCA9IGZhbHNlKSA9PiAoe1xuICAgIHR5cGU6IEV2ZW50VHlwZS5TcGFjZVBhcmVudCxcbiAgICBjb250ZW50OiB7XG4gICAgICAgIFwidmlhXCI6IGNhbGN1bGF0ZVJvb21WaWEocm9vbSksXG4gICAgICAgIFwiY2Fub25pY2FsXCI6IGNhbm9uaWNhbCxcbiAgICB9LFxuICAgIHN0YXRlX2tleTogcm9vbS5yb29tSWQsXG59KTtcblxuZXhwb3J0IGNvbnN0IHNob3dTcGFjZVNldHRpbmdzID0gKHNwYWNlOiBSb29tKSA9PiB7XG4gICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZyhcIlNwYWNlIFNldHRpbmdzXCIsIFwiXCIsIFNwYWNlU2V0dGluZ3NEaWFsb2csIHtcbiAgICAgICAgbWF0cml4Q2xpZW50OiBzcGFjZS5jbGllbnQsXG4gICAgICAgIHNwYWNlLFxuICAgIH0sIC8qY2xhc3NOYW1lPSovbnVsbCwgLyppc1ByaW9yaXR5PSovZmFsc2UsIC8qaXNTdGF0aWM9Ki90cnVlKTtcbn07XG5cbmV4cG9ydCBjb25zdCBzaG93QWRkRXhpc3RpbmdSb29tcyA9IChzcGFjZTogUm9vbSk6IHZvaWQgPT4ge1xuICAgIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coXG4gICAgICAgIFwiU3BhY2UgTGFuZGluZ1wiLFxuICAgICAgICBcIkFkZCBFeGlzdGluZ1wiLFxuICAgICAgICBBZGRFeGlzdGluZ1RvU3BhY2VEaWFsb2csXG4gICAgICAgIHtcbiAgICAgICAgICAgIG9uQ3JlYXRlUm9vbUNsaWNrOiAoKSA9PiBzaG93Q3JlYXRlTmV3Um9vbShzcGFjZSksXG4gICAgICAgICAgICBvbkFkZFN1YnNwYWNlQ2xpY2s6ICgpID0+IHNob3dBZGRFeGlzdGluZ1N1YnNwYWNlKHNwYWNlKSxcbiAgICAgICAgICAgIHNwYWNlLFxuICAgICAgICAgICAgb25GaW5pc2hlZDogKGFkZGVkOiBib29sZWFuKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGFkZGVkICYmIFJvb21WaWV3U3RvcmUuZ2V0Um9vbUlkKCkgPT09IHNwYWNlLnJvb21JZCkge1xuICAgICAgICAgICAgICAgICAgICBkZWZhdWx0RGlzcGF0Y2hlci5maXJlKEFjdGlvbi5VcGRhdGVTcGFjZUhpZXJhcmNoeSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgXCJteF9BZGRFeGlzdGluZ1RvU3BhY2VEaWFsb2dfd3JhcHBlclwiLFxuICAgICk7XG59O1xuXG5leHBvcnQgY29uc3Qgc2hvd0NyZWF0ZU5ld1Jvb20gPSBhc3luYyAoc3BhY2U6IFJvb20pOiBQcm9taXNlPGJvb2xlYW4+ID0+IHtcbiAgICBjb25zdCBtb2RhbCA9IE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2c8W2Jvb2xlYW4sIElPcHRzXT4oXG4gICAgICAgIFwiU3BhY2UgTGFuZGluZ1wiLFxuICAgICAgICBcIkNyZWF0ZSBSb29tXCIsXG4gICAgICAgIENyZWF0ZVJvb21EaWFsb2csXG4gICAgICAgIHtcbiAgICAgICAgICAgIGRlZmF1bHRQdWJsaWM6IHNwYWNlLmdldEpvaW5SdWxlKCkgPT09IFwicHVibGljXCIsXG4gICAgICAgICAgICBwYXJlbnRTcGFjZTogc3BhY2UsXG4gICAgICAgIH0sXG4gICAgKTtcbiAgICBjb25zdCBbc2hvdWxkQ3JlYXRlLCBvcHRzXSA9IGF3YWl0IG1vZGFsLmZpbmlzaGVkO1xuICAgIGlmIChzaG91bGRDcmVhdGUpIHtcbiAgICAgICAgYXdhaXQgY3JlYXRlUm9vbShvcHRzKTtcbiAgICB9XG4gICAgcmV0dXJuIHNob3VsZENyZWF0ZTtcbn07XG5cbmV4cG9ydCBjb25zdCBzaG93U3BhY2VJbnZpdGUgPSAoc3BhY2U6IFJvb20sIGluaXRpYWxUZXh0ID0gXCJcIik6IHZvaWQgPT4ge1xuICAgIGlmIChzcGFjZS5nZXRKb2luUnVsZSgpID09PSBcInB1YmxpY1wiKSB7XG4gICAgICAgIGNvbnN0IG1vZGFsID0gTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZyhcIlNwYWNlIEludml0ZVwiLCBcIlVzZXIgTWVudVwiLCBJbmZvRGlhbG9nLCB7XG4gICAgICAgICAgICB0aXRsZTogX3QoXCJJbnZpdGUgdG8gJShzcGFjZU5hbWUpc1wiLCB7IHNwYWNlTmFtZTogc3BhY2UubmFtZSB9KSxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiA8UmVhY3QuRnJhZ21lbnQ+XG4gICAgICAgICAgICAgICAgPHNwYW4+eyBfdChcIlNoYXJlIHlvdXIgcHVibGljIHNwYWNlXCIpIH08L3NwYW4+XG4gICAgICAgICAgICAgICAgPFNwYWNlUHVibGljU2hhcmUgc3BhY2U9e3NwYWNlfSBvbkZpbmlzaGVkPXsoKSA9PiBtb2RhbC5jbG9zZSgpfSAvPlxuICAgICAgICAgICAgPC9SZWFjdC5GcmFnbWVudD4sXG4gICAgICAgICAgICBmaXhlZFdpZHRoOiBmYWxzZSxcbiAgICAgICAgICAgIGJ1dHRvbjogZmFsc2UsXG4gICAgICAgICAgICBjbGFzc05hbWU6IFwibXhfU3BhY2VQYW5lbF9zaGFyZVB1YmxpY1NwYWNlXCIsXG4gICAgICAgICAgICBoYXNDbG9zZUJ1dHRvbjogdHJ1ZSxcbiAgICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgc2hvd1Jvb21JbnZpdGVEaWFsb2coc3BhY2Uucm9vbUlkLCBpbml0aWFsVGV4dCk7XG4gICAgfVxufTtcblxuZXhwb3J0IGNvbnN0IHNob3dBZGRFeGlzdGluZ1N1YnNwYWNlID0gKHNwYWNlOiBSb29tKTogdm9pZCA9PiB7XG4gICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZyhcbiAgICAgICAgXCJTcGFjZSBMYW5kaW5nXCIsXG4gICAgICAgIFwiQ3JlYXRlIFN1YnNwYWNlXCIsXG4gICAgICAgIEFkZEV4aXN0aW5nU3Vic3BhY2VEaWFsb2csXG4gICAgICAgIHtcbiAgICAgICAgICAgIHNwYWNlLFxuICAgICAgICAgICAgb25DcmVhdGVTdWJzcGFjZUNsaWNrOiAoKSA9PiBzaG93Q3JlYXRlTmV3U3Vic3BhY2Uoc3BhY2UpLFxuICAgICAgICAgICAgb25GaW5pc2hlZDogKGFkZGVkOiBib29sZWFuKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGFkZGVkICYmIFJvb21WaWV3U3RvcmUuZ2V0Um9vbUlkKCkgPT09IHNwYWNlLnJvb21JZCkge1xuICAgICAgICAgICAgICAgICAgICBkZWZhdWx0RGlzcGF0Y2hlci5maXJlKEFjdGlvbi5VcGRhdGVTcGFjZUhpZXJhcmNoeSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgXCJteF9BZGRFeGlzdGluZ1RvU3BhY2VEaWFsb2dfd3JhcHBlclwiLFxuICAgICk7XG59O1xuXG5leHBvcnQgY29uc3Qgc2hvd0NyZWF0ZU5ld1N1YnNwYWNlID0gKHNwYWNlOiBSb29tKTogdm9pZCA9PiB7XG4gICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZyhcbiAgICAgICAgXCJTcGFjZSBMYW5kaW5nXCIsXG4gICAgICAgIFwiQ3JlYXRlIFN1YnNwYWNlXCIsXG4gICAgICAgIENyZWF0ZVN1YnNwYWNlRGlhbG9nLFxuICAgICAgICB7XG4gICAgICAgICAgICBzcGFjZSxcbiAgICAgICAgICAgIG9uQWRkRXhpc3RpbmdTcGFjZUNsaWNrOiAoKSA9PiBzaG93QWRkRXhpc3RpbmdTdWJzcGFjZShzcGFjZSksXG4gICAgICAgICAgICBvbkZpbmlzaGVkOiAoYWRkZWQ6IGJvb2xlYW4pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoYWRkZWQgJiYgUm9vbVZpZXdTdG9yZS5nZXRSb29tSWQoKSA9PT0gc3BhY2Uucm9vbUlkKSB7XG4gICAgICAgICAgICAgICAgICAgIGRlZmF1bHREaXNwYXRjaGVyLmZpcmUoQWN0aW9uLlVwZGF0ZVNwYWNlSGllcmFyY2h5KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBcIm14X0NyZWF0ZVN1YnNwYWNlRGlhbG9nX3dyYXBwZXJcIixcbiAgICApO1xufTtcblxuZXhwb3J0IGNvbnN0IGJ1bGtTcGFjZUJlaGF2aW91ciA9IGFzeW5jIChcbiAgICBzcGFjZTogUm9vbSxcbiAgICBjaGlsZHJlbjogUm9vbVtdLFxuICAgIGZuOiAocm9vbTogUm9vbSkgPT4gUHJvbWlzZTx1bmtub3duPixcbik6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIGNvbnN0IG1vZGFsID0gTW9kYWwuY3JlYXRlRGlhbG9nKFNwaW5uZXIsIG51bGwsIFwibXhfRGlhbG9nX3NwaW5uZXJcIik7XG4gICAgdHJ5IHtcbiAgICAgICAgZm9yIChjb25zdCByb29tIG9mIGNoaWxkcmVuKSB7XG4gICAgICAgICAgICBhd2FpdCBmbihyb29tKTtcbiAgICAgICAgfVxuICAgICAgICBhd2FpdCBmbihzcGFjZSk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgICAgbW9kYWwuY2xvc2UoKTtcbiAgICB9XG59O1xuXG5leHBvcnQgY29uc3QgbGVhdmVTcGFjZSA9IChzcGFjZTogUm9vbSkgPT4ge1xuICAgIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coXCJMZWF2ZSBTcGFjZVwiLCBcIlwiLCBMZWF2ZVNwYWNlRGlhbG9nLCB7XG4gICAgICAgIHNwYWNlLFxuICAgICAgICBvbkZpbmlzaGVkOiBhc3luYyAobGVhdmU6IGJvb2xlYW4sIHJvb21zOiBSb29tW10pID0+IHtcbiAgICAgICAgICAgIGlmICghbGVhdmUpIHJldHVybjtcbiAgICAgICAgICAgIGF3YWl0IGJ1bGtTcGFjZUJlaGF2aW91cihzcGFjZSwgcm9vbXMsIHJvb20gPT4gbGVhdmVSb29tQmVoYXZpb3VyKHJvb20ucm9vbUlkKSk7XG5cbiAgICAgICAgICAgIGRpcy5kaXNwYXRjaCh7XG4gICAgICAgICAgICAgICAgYWN0aW9uOiBcImFmdGVyX2xlYXZlX3Jvb21cIixcbiAgICAgICAgICAgICAgICByb29tX2lkOiBzcGFjZS5yb29tSWQsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSxcbiAgICB9LCBcIm14X0xlYXZlU3BhY2VEaWFsb2dfd3JhcHBlclwiKTtcbn07XG5cbmV4cG9ydCBjb25zdCBjcmVhdGVTcGFjZUZyb21Db21tdW5pdHkgPSAoY2xpOiBNYXRyaXhDbGllbnQsIGdyb3VwSWQ6IHN0cmluZyk6IFByb21pc2U8W3N0cmluZz9dPiA9PiB7XG4gICAgcmV0dXJuIE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coJ0NyZWF0ZSBTcGFjZScsICdmcm9tIGNvbW11bml0eScsIENyZWF0ZVNwYWNlRnJvbUNvbW11bml0eURpYWxvZywge1xuICAgICAgICBtYXRyaXhDbGllbnQ6IGNsaSxcbiAgICAgICAgZ3JvdXBJZCxcbiAgICB9LCBcIm14X0NyZWF0ZVNwYWNlRnJvbUNvbW11bml0eURpYWxvZ193cmFwcGVyXCIpLmZpbmlzaGVkIGFzIFByb21pc2U8W3N0cmluZz9dPjtcbn07XG4iXX0=