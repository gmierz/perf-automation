"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _Exporter = _interopRequireDefault(require("./Exporter"));

var _DateUtils = require("../../DateUtils");

var _EventTile = require("../../components/views/rooms/EventTile");

var _event = require("matrix-js-sdk/src/@types/event");

var _logger = require("matrix-js-sdk/src/logger");

/*
Copyright 2021 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
class JSONExporter extends _Exporter.default {
  constructor(room, exportType, exportOptions, setProgressText) {
    super(room, exportType, exportOptions, setProgressText);
    (0, _defineProperty2.default)(this, "totalSize", 0);
    (0, _defineProperty2.default)(this, "messages", []);
  }

  createJSONString() {
    var _this$room$currentSta, _this$room, _this$room$getMember, _this$room$currentSta2, _this$room$currentSta3, _this$room2, _this$room2$getMember;

    const exportDate = (0, _DateUtils.formatFullDateNoDayNoTime)(new Date());
    const creator = (_this$room$currentSta = this.room.currentState.getStateEvents(_event.EventType.RoomCreate, "")) === null || _this$room$currentSta === void 0 ? void 0 : _this$room$currentSta.getSender();
    const creatorName = ((_this$room = this.room) === null || _this$room === void 0 ? void 0 : (_this$room$getMember = _this$room.getMember(creator)) === null || _this$room$getMember === void 0 ? void 0 : _this$room$getMember.rawDisplayName) || creator;
    const topic = ((_this$room$currentSta2 = this.room.currentState.getStateEvents(_event.EventType.RoomTopic, "")) === null || _this$room$currentSta2 === void 0 ? void 0 : (_this$room$currentSta3 = _this$room$currentSta2.getContent()) === null || _this$room$currentSta3 === void 0 ? void 0 : _this$room$currentSta3.topic) || "";
    const exporter = this.client.getUserId();
    const exporterName = ((_this$room2 = this.room) === null || _this$room2 === void 0 ? void 0 : (_this$room2$getMember = _this$room2.getMember(exporter)) === null || _this$room2$getMember === void 0 ? void 0 : _this$room2$getMember.rawDisplayName) || exporter;
    const jsonObject = {
      room_name: this.room.name,
      room_creator: creatorName,
      topic,
      export_date: exportDate,
      exported_by: exporterName,
      messages: this.messages
    };
    return JSON.stringify(jsonObject, null, 2);
  }

  async getJSONString(mxEv) {
    if (this.exportOptions.attachmentsIncluded && this.isAttachment(mxEv)) {
      try {
        const blob = await this.getMediaBlob(mxEv);

        if (this.totalSize + blob.size < this.exportOptions.maxSize) {
          this.totalSize += blob.size;
          const filePath = this.getFilePath(mxEv);

          if (this.totalSize == this.exportOptions.maxSize) {
            this.exportOptions.attachmentsIncluded = false;
          }

          this.addFile(filePath, blob);
        }
      } catch (err) {
        _logger.logger.log("Error fetching file: " + err);
      }
    }

    const jsonEvent = mxEv.toJSON();
    const clearEvent = mxEv.isEncrypted() ? jsonEvent.decrypted : jsonEvent;
    return clearEvent;
  }

  async createOutput(events) {
    for (let i = 0; i < events.length; i++) {
      const event = events[i];
      this.updateProgress(`Processing event ${i + 1} out of ${events.length}`, false, true);
      if (this.cancelled) return this.cleanUp();
      if (!(0, _EventTile.haveTileForEvent)(event)) continue;
      this.messages.push(await this.getJSONString(event));
    }

    return this.createJSONString();
  }

  async export() {
    _logger.logger.info("Starting export process...");

    _logger.logger.info("Fetching events...");

    const fetchStart = performance.now();
    const res = await this.getRequiredEvents();
    const fetchEnd = performance.now();

    _logger.logger.log(`Fetched ${res.length} events in ${(fetchEnd - fetchStart) / 1000}s`);

    _logger.logger.info("Creating output...");

    const text = await this.createOutput(res);

    if (this.files.length) {
      this.addFile("export.json", new Blob([text]));
      await this.downloadZIP();
    } else {
      const fileName = `matrix-export-${(0, _DateUtils.formatFullDateNoDay)(new Date())}.json`;
      this.downloadPlainText(fileName, text);
    }

    const exportEnd = performance.now();

    if (this.cancelled) {
      _logger.logger.info("Export cancelled successfully");
    } else {
      _logger.logger.info("Export successful!");

      _logger.logger.log(`Exported ${res.length} events in ${(exportEnd - fetchStart) / 1000} seconds`);
    }

    this.cleanUp();
  }

}

exports.default = JSONExporter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy91dGlscy9leHBvcnRVdGlscy9KU09ORXhwb3J0LnRzIl0sIm5hbWVzIjpbIkpTT05FeHBvcnRlciIsIkV4cG9ydGVyIiwiY29uc3RydWN0b3IiLCJyb29tIiwiZXhwb3J0VHlwZSIsImV4cG9ydE9wdGlvbnMiLCJzZXRQcm9ncmVzc1RleHQiLCJjcmVhdGVKU09OU3RyaW5nIiwiZXhwb3J0RGF0ZSIsIkRhdGUiLCJjcmVhdG9yIiwiY3VycmVudFN0YXRlIiwiZ2V0U3RhdGVFdmVudHMiLCJFdmVudFR5cGUiLCJSb29tQ3JlYXRlIiwiZ2V0U2VuZGVyIiwiY3JlYXRvck5hbWUiLCJnZXRNZW1iZXIiLCJyYXdEaXNwbGF5TmFtZSIsInRvcGljIiwiUm9vbVRvcGljIiwiZ2V0Q29udGVudCIsImV4cG9ydGVyIiwiY2xpZW50IiwiZ2V0VXNlcklkIiwiZXhwb3J0ZXJOYW1lIiwianNvbk9iamVjdCIsInJvb21fbmFtZSIsIm5hbWUiLCJyb29tX2NyZWF0b3IiLCJleHBvcnRfZGF0ZSIsImV4cG9ydGVkX2J5IiwibWVzc2FnZXMiLCJKU09OIiwic3RyaW5naWZ5IiwiZ2V0SlNPTlN0cmluZyIsIm14RXYiLCJhdHRhY2htZW50c0luY2x1ZGVkIiwiaXNBdHRhY2htZW50IiwiYmxvYiIsImdldE1lZGlhQmxvYiIsInRvdGFsU2l6ZSIsInNpemUiLCJtYXhTaXplIiwiZmlsZVBhdGgiLCJnZXRGaWxlUGF0aCIsImFkZEZpbGUiLCJlcnIiLCJsb2dnZXIiLCJsb2ciLCJqc29uRXZlbnQiLCJ0b0pTT04iLCJjbGVhckV2ZW50IiwiaXNFbmNyeXB0ZWQiLCJkZWNyeXB0ZWQiLCJjcmVhdGVPdXRwdXQiLCJldmVudHMiLCJpIiwibGVuZ3RoIiwiZXZlbnQiLCJ1cGRhdGVQcm9ncmVzcyIsImNhbmNlbGxlZCIsImNsZWFuVXAiLCJwdXNoIiwiZXhwb3J0IiwiaW5mbyIsImZldGNoU3RhcnQiLCJwZXJmb3JtYW5jZSIsIm5vdyIsInJlcyIsImdldFJlcXVpcmVkRXZlbnRzIiwiZmV0Y2hFbmQiLCJ0ZXh0IiwiZmlsZXMiLCJCbG9iIiwiZG93bmxvYWRaSVAiLCJmaWxlTmFtZSIsImRvd25sb2FkUGxhaW5UZXh0IiwiZXhwb3J0RW5kIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWdCQTs7QUFHQTs7QUFDQTs7QUFHQTs7QUFFQTs7QUF6QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBYWUsTUFBTUEsWUFBTixTQUEyQkMsaUJBQTNCLENBQW9DO0FBSS9DQyxFQUFBQSxXQUFXLENBQ1BDLElBRE8sRUFFUEMsVUFGTyxFQUdQQyxhQUhPLEVBSVBDLGVBSk8sRUFLVDtBQUNFLFVBQU1ILElBQU4sRUFBWUMsVUFBWixFQUF3QkMsYUFBeEIsRUFBdUNDLGVBQXZDO0FBREYscURBUm9CLENBUXBCO0FBQUEsb0RBUDBDLEVBTzFDO0FBRUQ7O0FBRVNDLEVBQUFBLGdCQUFnQixHQUFXO0FBQUE7O0FBQ2pDLFVBQU1DLFVBQVUsR0FBRywwQ0FBMEIsSUFBSUMsSUFBSixFQUExQixDQUFuQjtBQUNBLFVBQU1DLE9BQU8sNEJBQUcsS0FBS1AsSUFBTCxDQUFVUSxZQUFWLENBQXVCQyxjQUF2QixDQUFzQ0MsaUJBQVVDLFVBQWhELEVBQTRELEVBQTVELENBQUgsMERBQUcsc0JBQWlFQyxTQUFqRSxFQUFoQjtBQUNBLFVBQU1DLFdBQVcsR0FBRyxvQkFBS2IsSUFBTCxrRkFBV2MsU0FBWCxDQUFxQlAsT0FBckIsK0VBQStCUSxjQUEvQixLQUFpRFIsT0FBckU7QUFDQSxVQUFNUyxLQUFLLEdBQUcsZ0NBQUtoQixJQUFMLENBQVVRLFlBQVYsQ0FBdUJDLGNBQXZCLENBQXNDQyxpQkFBVU8sU0FBaEQsRUFBMkQsRUFBM0QsNkdBQWdFQyxVQUFoRSxvRkFBOEVGLEtBQTlFLEtBQXVGLEVBQXJHO0FBQ0EsVUFBTUcsUUFBUSxHQUFHLEtBQUtDLE1BQUwsQ0FBWUMsU0FBWixFQUFqQjtB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LG1CQUFPQyxHQUFQLENBQVksV0FBVW9CLEdBQUcsQ0FBQ1gsTUFBTyxjQUFhLENBQUNhLFFBQVEsR0FBR0wsVUFBWixJQUF3QixJQUFLLEdBQTNFOztBQUVBbEIsbUJBQU9pQixJQUFQLENBQVksb0JBQVo7O0FBQ0EsVUFBTU8sSUFBSSxHQUFHLE1BQU0sS0FBS2pCLFlBQUwsQ0FBa0JjLEdBQWxCLENBQW5COztBQUVBLFFBQUksS0FBS0ksS0FBTCxDQUFXZixNQUFmLEVBQXVCO0FBQ25CLFdBQUtaLE9BQUwsQ0FBYSxhQUFiLEVBQTRCLElBQUk0QixJQUFKLENBQVMsQ0FBQ0YsSUFBRCxDQUFULENBQTVCO0FBQ0EsWUFBTSxLQUFLRyxXQUFMLEVBQU47QUFDSCxLQUhELE1BR087QUFDSCxZQUFNQyxRQUFRLEdBQUksaUJBQWdCLG9DQUFvQixJQUFJbkUsSUFBSixFQUFwQixDQUFnQyxPQUFsRTtBQUNBLFdBQUtvRSxpQkFBTCxDQUF1QkQsUUFBdkIsRUFBaUNKLElBQWpDO0FBQ0g7O0FBRUQsVUFBTU0sU0FBUyxHQUFHWCxXQUFXLENBQUNDLEdBQVosRUFBbEI7O0FBRUEsUUFBSSxLQUFLUCxTQUFULEVBQW9CO0FBQ2hCYixxQkFBT2lCLElBQVAsQ0FBWSwrQkFBWjtBQUNILEtBRkQsTUFFTztBQUNIakIscUJBQU9pQixJQUFQLENBQVksb0JBQVo7O0FBQ0FqQixxQkFBT0MsR0FBUCxDQUFZLFlBQVdvQixHQUFHLENBQUNYLE1BQU8sY0FBYSxDQUFDb0IsU0FBUyxHQUFHWixVQUFiLElBQXlCLElBQUssVUFBN0U7QUFDSDs7QUFFRCxTQUFLSixPQUFMO0FBQ0g7O0FBOUY4QyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAyMSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBFeHBvcnRlciBmcm9tIFwiLi9FeHBvcnRlclwiO1xuaW1wb3J0IHsgUm9vbSB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvcm9vbVwiO1xuaW1wb3J0IHsgTWF0cml4RXZlbnQgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL2V2ZW50XCI7XG5pbXBvcnQgeyBmb3JtYXRGdWxsRGF0ZU5vRGF5LCBmb3JtYXRGdWxsRGF0ZU5vRGF5Tm9UaW1lIH0gZnJvbSBcIi4uLy4uL0RhdGVVdGlsc1wiO1xuaW1wb3J0IHsgaGF2ZVRpbGVGb3JFdmVudCB9IGZyb20gXCIuLi8uLi9jb21wb25lbnRzL3ZpZXdzL3Jvb21zL0V2ZW50VGlsZVwiO1xuaW1wb3J0IHsgRXhwb3J0VHlwZSB9IGZyb20gXCIuL2V4cG9ydFV0aWxzXCI7XG5pbXBvcnQgeyBJRXhwb3J0T3B0aW9ucyB9IGZyb20gXCIuL2V4cG9ydFV0aWxzXCI7XG5pbXBvcnQgeyBFdmVudFR5cGUgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvQHR5cGVzL2V2ZW50XCI7XG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSlNPTkV4cG9ydGVyIGV4dGVuZHMgRXhwb3J0ZXIge1xuICAgIHByb3RlY3RlZCB0b3RhbFNpemUgPSAwO1xuICAgIHByb3RlY3RlZCBtZXNzYWdlczogUmVjb3JkPHN0cmluZywgYW55PltdID0gW107XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcm9vbTogUm9vbSxcbiAgICAgICAgZXhwb3J0VHlwZTogRXhwb3J0VHlwZSxcbiAgICAgICAgZXhwb3J0T3B0aW9uczogSUV4cG9ydE9wdGlvbnMsXG4gICAgICAgIHNldFByb2dyZXNzVGV4dDogUmVhY3QuRGlzcGF0Y2g8UmVhY3QuU2V0U3RhdGVBY3Rpb248c3RyaW5nPj4sXG4gICAgKSB7XG4gICAgICAgIHN1cGVyKHJvb20sIGV4cG9ydFR5cGUsIGV4cG9ydE9wdGlvbnMsIHNldFByb2dyZXNzVGV4dCk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGNyZWF0ZUpTT05TdHJpbmcoKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgZXhwb3J0RGF0ZSA9IGZvcm1hdEZ1bGxEYXRlTm9EYXlOb1RpbWUobmV3IERhdGUoKSk7XG4gICAgICAgIGNvbnN0IGNyZWF0b3IgPSB0aGlzLnJvb20uY3VycmVudFN0YXRlLmdldFN0YXRlRXZlbnRzKEV2ZW50VHlwZS5Sb29tQ3JlYXRlLCBcIlwiKT8uZ2V0U2VuZGVyKCk7XG4gICAgICAgIGNvbnN0IGNyZWF0b3JOYW1lID0gdGhpcy5yb29tPy5nZXRNZW1iZXIoY3JlYXRvcik/LnJhd0Rpc3BsYXlOYW1lIHx8IGNyZWF0b3I7XG4gICAgICAgIGNvbnN0IHRvcGljID0gdGhpcy5yb29tLmN1cnJlbnRTdGF0ZS5nZXRTdGF0ZUV2ZW50cyhFdmVudFR5cGUuUm9vbVRvcGljLCBcIlwiKT8uZ2V0Q29udGVudCgpPy50b3BpYyB8fCBcIlwiO1xuICAgICAgICBjb25zdCBleHBvcnRlciA9IHRoaXMuY2xpZW50LmdldFVzZXJJZCgpO1xuICAgICAgICBjb25zdCBleHBvcnRlck5hbWUgPSB0aGlzLnJvb20/LmdldE1lbWJlcihleHBvcnRlcik/LnJhd0Rpc3BsYXlOYW1lIHx8IGV4cG9ydGVyO1xuICAgICAgICBjb25zdCBqc29uT2JqZWN0ID0ge1xuICAgICAgICAgICAgcm9vbV9uYW1lOiB0aGlzLnJvb20ubmFtZSxcbiAgICAgICAgICAgIHJvb21fY3JlYXRvcjogY3JlYXRvck5hbWUsXG4gICAgICAgICAgICB0b3BpYyxcbiAgICAgICAgICAgIGV4cG9ydF9kYXRlOiBleHBvcnREYXRlLFxuICAgICAgICAgICAgZXhwb3J0ZWRfYnk6IGV4cG9ydGVyTmFtZSxcbiAgICAgICAgICAgIG1lc3NhZ2VzOiB0aGlzLm1lc3NhZ2VzLFxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoanNvbk9iamVjdCwgbnVsbCwgMik7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGFzeW5jIGdldEpTT05TdHJpbmcobXhFdjogTWF0cml4RXZlbnQpIHtcbiAgICAgICAgaWYgKHRoaXMuZXhwb3J0T3B0aW9ucy5hdHRhY2htZW50c0luY2x1ZGVkICYmIHRoaXMuaXNBdHRhY2htZW50KG14RXYpKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGJsb2IgPSBhd2FpdCB0aGlzLmdldE1lZGlhQmxvYihteEV2KTtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy50b3RhbFNpemUgKyBibG9iLnNpemUgPCB0aGlzLmV4cG9ydE9wdGlvbnMubWF4U2l6ZSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnRvdGFsU2l6ZSArPSBibG9iLnNpemU7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbGVQYXRoID0gdGhpcy5nZXRGaWxlUGF0aChteEV2KTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudG90YWxTaXplID09IHRoaXMuZXhwb3J0T3B0aW9ucy5tYXhTaXplKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmV4cG9ydE9wdGlvbnMuYXR0YWNobWVudHNJbmNsdWRlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkRmlsZShmaWxlUGF0aCwgYmxvYik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgICAgbG9nZ2VyLmxvZyhcIkVycm9yIGZldGNoaW5nIGZpbGU6IFwiICsgZXJyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBjb25zdCBqc29uRXZlbnQ6IGFueSA9IG14RXYudG9KU09OKCk7XG4gICAgICAgIGNvbnN0IGNsZWFyRXZlbnQgPSBteEV2LmlzRW5jcnlwdGVkKCkgPyBqc29uRXZlbnQuZGVjcnlwdGVkIDoganNvbkV2ZW50O1xuICAgICAgICByZXR1cm4gY2xlYXJFdmVudDtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgYXN5bmMgY3JlYXRlT3V0cHV0KGV2ZW50czogTWF0cml4RXZlbnRbXSkge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGV2ZW50cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgY29uc3QgZXZlbnQgPSBldmVudHNbaV07XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVByb2dyZXNzKGBQcm9jZXNzaW5nIGV2ZW50ICR7aSArIDF9IG91dCBvZiAke2V2ZW50cy5sZW5ndGh9YCwgZmFsc2UsIHRydWUpO1xuICAgICAgICAgICAgaWYgKHRoaXMuY2FuY2VsbGVkKSByZXR1cm4gdGhpcy5jbGVhblVwKCk7XG4gICAgICAgICAgICBpZiAoIWhhdmVUaWxlRm9yRXZlbnQoZXZlbnQpKSBjb250aW51ZTtcbiAgICAgICAgICAgIHRoaXMubWVzc2FnZXMucHVzaChhd2FpdCB0aGlzLmdldEpTT05TdHJpbmcoZXZlbnQpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVKU09OU3RyaW5nKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGV4cG9ydCgpIHtcbiAgICAgICAgbG9nZ2VyLmluZm8oXCJTdGFydGluZyBleHBvcnQgcHJvY2Vzcy4uLlwiKTtcbiAgICAgICAgbG9nZ2VyLmluZm8oXCJGZXRjaGluZyBldmVudHMuLi5cIik7XG5cbiAgICAgICAgY29uc3QgZmV0Y2hTdGFydCA9IHBlcmZvcm1hbmNlLm5vdygpO1xuICAgICAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLmdldFJlcXVpcmVkRXZlbnRzKCk7XG4gICAgICAgIGNvbnN0IGZldGNoRW5kID0gcGVyZm9ybWFuY2Uubm93KCk7XG5cbiAgICAgICAgbG9nZ2VyLmxvZyhgRmV0Y2hlZCAke3Jlcy5sZW5ndGh9IGV2ZW50cyBpbiAkeyhmZXRjaEVuZCAtIGZldGNoU3RhcnQpLzEwMDB9c2ApO1xuXG4gICAgICAgIGxvZ2dlci5pbmZvKFwiQ3JlYXRpbmcgb3V0cHV0Li4uXCIpO1xuICAgICAgICBjb25zdCB0ZXh0ID0gYXdhaXQgdGhpcy5jcmVhdGVPdXRwdXQocmVzKTtcblxuICAgICAgICBpZiAodGhpcy5maWxlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoaXMuYWRkRmlsZShcImV4cG9ydC5qc29uXCIsIG5ldyBCbG9iKFt0ZXh0XSkpO1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5kb3dubG9hZFpJUCgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgZmlsZU5hbWUgPSBgbWF0cml4LWV4cG9ydC0ke2Zvcm1hdEZ1bGxEYXRlTm9EYXkobmV3IERhdGUoKSl9Lmpzb25gO1xuICAgICAgICAgICAgdGhpcy5kb3dubG9hZFBsYWluVGV4dChmaWxlTmFtZSwgdGV4dCk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBleHBvcnRFbmQgPSBwZXJmb3JtYW5jZS5ub3coKTtcblxuICAgICAgICBpZiAodGhpcy5jYW5jZWxsZWQpIHtcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKFwiRXhwb3J0IGNhbmNlbGxlZCBzdWNjZXNzZnVsbHlcIik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsb2dnZXIuaW5mbyhcIkV4cG9ydCBzdWNjZXNzZnVsIVwiKTtcbiAgICAgICAgICAgIGxvZ2dlci5sb2coYEV4cG9ydGVkICR7cmVzLmxlbmd0aH0gZXZlbnRzIGluICR7KGV4cG9ydEVuZCAtIGZldGNoU3RhcnQpLzEwMDB9IHNlY29uZHNgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY2xlYW5VcCgpO1xuICAgIH1cbn1cblxuIl19