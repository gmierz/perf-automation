"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _Exporter = _interopRequireDefault(require("./Exporter"));

var _DateUtils = require("../../DateUtils");

var _languageHandler = require("../../languageHandler");

var _EventTile = require("../../components/views/rooms/EventTile");

var _TextForEvent = require("../../TextForEvent");

var _logger = require("matrix-js-sdk/src/logger");

/*
Copyright 2021 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
class PlainTextExporter extends _Exporter.default {
  constructor(room, exportType, exportOptions, setProgressText) {
    super(room, exportType, exportOptions, setProgressText);
    (0, _defineProperty2.default)(this, "totalSize", void 0);
    (0, _defineProperty2.default)(this, "mediaOmitText", void 0);
    (0, _defineProperty2.default)(this, "textForReplyEvent", content => {
      const REPLY_REGEX = /> <(.*?)>(.*?)\n\n(.*)/s;
      const REPLY_SOURCE_MAX_LENGTH = 32;
      const match = REPLY_REGEX.exec(content.body); // if the reply format is invalid, then return the body

      if (!match) return content.body;
      let rplSource;
      const rplName = match[1];
      const rplText = match[3];
      rplSource = match[2].substring(1); // Get the first non-blank line from the source.

      const lines = rplSource.split('\n').filter(line => !/^\s*$/.test(line));

      if (lines.length > 0) {
        // Cut to a maximum length.
        rplSource = lines[0].substring(0, REPLY_SOURCE_MAX_LENGTH); // Ellipsis if needed.

        if (lines[0].length > REPLY_SOURCE_MAX_LENGTH) {
          rplSource = rplSource + "...";
        } // Wrap in formatting


        rplSource = ` "${rplSource}"`;
      } else {
        // Don't show a source because we couldn't format one.
        rplSource = "";
      }

      return `<${rplName}${rplSource}> ${rplText}`;
    });
    (0, _defineProperty2.default)(this, "plainTextForEvent", async mxEv => {
      const senderDisplayName = mxEv.sender && mxEv.sender.name ? mxEv.sender.name : mxEv.getSender();
      let mediaText = "";

      if (this.isAttachment(mxEv)) {
        if (this.exportOptions.attachmentsIncluded) {
          try {
            const blob = await this.getMediaBlob(mxEv);

            if (this.totalSize + blob.size > this.exportOptions.maxSize) {
              mediaText = ` (${this.mediaOmitText})`;
            } else {
              this.totalSize += blob.size;
              const filePath = this.getFilePath(mxEv);
              mediaText = " (" + (0, _languageHandler._t)("File Attached") + ")";
              this.addFile(filePath, blob);

              if (this.totalSize == this.exportOptions.maxSize) {
                this.exportOptions.attachmentsIncluded = false;
              }
            }
          } catch (error) {
            mediaText = " (" + (0, _languageHandler._t)("Error fetching file") + ")";

            _logger.logger.log("Error fetching file " + error);
          }
        } else mediaText = ` (${this.mediaOmitText})`;
      }

      if (this.isReply(mxEv)) return senderDisplayName + ": " + this.textForReplyEvent(mxEv.getContent()) + mediaText;else return (0, _TextForEvent.textForEvent)(mxEv) + mediaText;
    });
    this.totalSize = 0;
    this.mediaOmitText = !this.exportOptions.attachmentsIncluded ? (0, _languageHandler._t)("Media omitted") : (0, _languageHandler._t)("Media omitted - file size limit exceeded");
  }

  async createOutput(events) {
    let content = "";

    for (let i = 0; i < events.length; i++) {
      const event = events[i];
      this.updateProgress(`Processing event ${i + 1} out of ${events.length}`, false, true);
      if (this.cancelled) return this.cleanUp();
      if (!(0, _EventTile.haveTileForEvent)(event)) continue;
      const textForEvent = await this.plainTextForEvent(event);
      content += textForEvent && `${new Date(event.getTs()).toLocaleString()} - ${textForEvent}\n`;
    }

    return content;
  }

  async export() {
    this.updateProgress("Starting export process...");
    this.updateProgress("Fetching events...");
    const fetchStart = performance.now();
    const res = await this.getRequiredEvents();
    const fetchEnd = performance.now();

    _logger.logger.log(`Fetched ${res.length} events in ${(fetchEnd - fetchStart) / 1000}s`);

    this.updateProgress("Creating output...");
    const text = await this.createOutput(res);

    if (this.files.length) {
      this.addFile("export.txt", new Blob([text]));
      await this.downloadZIP();
    } else {
      const fileName = `matrix-export-${(0, _DateUtils.formatFullDateNoDay)(new Date())}.txt`;
      this.downloadPlainText(fileName, text);
    }

    const exportEnd = performance.now();

    if (this.cancelled) {
      _logger.logger.info("Export cancelled successfully");
    } else {
      _logger.logger.info("Export successful!");

      _logger.logger.log(`Exported ${res.length} events in ${(exportEnd - fetchStart) / 1000} seconds`);
    }

    this.cleanUp();
  }

}

exports.default = PlainTextExporter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy91dGlscy9leHBvcnRVdGlscy9QbGFpblRleHRFeHBvcnQudHMiXSwibmFtZXMiOlsiUGxhaW5UZXh0RXhwb3J0ZXIiLCJFeHBvcnRlciIsImNvbnN0cnVjdG9yIiwicm9vbSIsImV4cG9ydFR5cGUiLCJleHBvcnRPcHRpb25zIiwic2V0UHJvZ3Jlc3NUZXh0IiwiY29udGVudCIsIlJFUExZX1JFR0VYIiwiUkVQTFlfU09VUkNFX01BWF9MRU5HVEgiLCJtYXRjaCIsImV4ZWMiLCJib2R5IiwicnBsU291cmNlIiwicnBsTmFtZSIsInJwbFRleHQiLCJzdWJzdHJpbmciLCJsaW5lcyIsInNwbGl0IiwiZmlsdGVyIiwibGluZSIsInRlc3QiLCJsZW5ndGgiLCJteEV2Iiwic2VuZGVyRGlzcGxheU5hbWUiLCJzZW5kZXIiLCJuYW1lIiwiZ2V0U2VuZGVyIiwibWVkaWFUZXh0IiwiaXNBdHRhY2htZW50IiwiYXR0YWNobWVudHNJbmNsdWRlZCIsImJsb2IiLCJnZXRNZWRpYUJsb2IiLCJ0b3RhbFNpemUiLCJzaXplIiwibWF4U2l6ZSIsIm1lZGlhT21pdFRleHQiLCJmaWxlUGF0aCIsImdldEZpbGVQYXRoIiwiYWRkRmlsZSIsImVycm9yIiwibG9nZ2VyIiwibG9nIiwiaXNSZXBseSIsInRleHRGb3JSZXBseUV2ZW50IiwiZ2V0Q29udGVudCIsImNyZWF0ZU91dHB1dCIsImV2ZW50cyIsImkiLCJldmVudCIsInVwZGF0ZVByb2dyZXNzIiwiY2FuY2VsbGVkIiwiY2xlYW5VcCIsInRleHRGb3JFdmVudCIsInBsYWluVGV4dEZvckV2ZW50IiwiRGF0ZSIsImdldFRzIiwidG9Mb2NhbGVTdHJpbmciLCJleHBvcnQiLCJmZXRjaFN0YXJ0IiwicGVyZm9ybWFuY2UiLCJub3ciLCJyZXMiLCJnZXRSZXF1aXJlZEV2ZW50cyIsImZldGNoRW5kIiwidGV4dCIsImZpbGVzIiwiQmxvYiIsImRvd25sb2FkWklQIiwiZmlsZU5hbWUiLCJkb3dubG9hZFBs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ZixFQUF1QjtBQUNuQixXQUFLaUIsT0FBTCxDQUFhLFlBQWIsRUFBMkIsSUFBSTRCLElBQUosQ0FBUyxDQUFDRixJQUFELENBQVQsQ0FBM0I7QUFDQSxZQUFNLEtBQUtHLFdBQUwsRUFBTjtBQUNILEtBSEQsTUFHTztBQUNILFlBQU1DLFFBQVEsR0FBSSxpQkFBZ0Isb0NBQW9CLElBQUlkLElBQUosRUFBcEIsQ0FBZ0MsTUFBbEU7QUFDQSxXQUFLZSxpQkFBTCxDQUF1QkQsUUFBdkIsRUFBaUNKLElBQWpDO0FBQ0g7O0FBRUQsVUFBTU0sU0FBUyxHQUFHWCxXQUFXLENBQUNDLEdBQVosRUFBbEI7O0FBRUEsUUFBSSxLQUFLVixTQUFULEVBQW9CO0FBQ2hCVixxQkFBTytCLElBQVAsQ0FBWSwrQkFBWjtBQUNILEtBRkQsTUFFTztBQUNIL0IscUJBQU8rQixJQUFQLENBQVksb0JBQVo7O0FBQ0EvQixxQkFBT0MsR0FBUCxDQUFZLFlBQVdvQixHQUFHLENBQUN4QyxNQUFPLGNBQWEsQ0FBQ2lELFNBQVMsR0FBR1osVUFBYixJQUF5QixJQUFLLFVBQTdFO0FBQ0g7O0FBRUQsU0FBS1AsT0FBTDtBQUNIOztBQTFIbUQiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMjEgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgRXhwb3J0ZXIgZnJvbSBcIi4vRXhwb3J0ZXJcIjtcbmltcG9ydCB7IFJvb20gfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3Jvb21cIjtcbmltcG9ydCB7IElDb250ZW50LCBNYXRyaXhFdmVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvZXZlbnRcIjtcbmltcG9ydCB7IGZvcm1hdEZ1bGxEYXRlTm9EYXkgfSBmcm9tIFwiLi4vLi4vRGF0ZVV0aWxzXCI7XG5pbXBvcnQgeyBfdCB9IGZyb20gXCIuLi8uLi9sYW5ndWFnZUhhbmRsZXJcIjtcbmltcG9ydCB7IGhhdmVUaWxlRm9yRXZlbnQgfSBmcm9tIFwiLi4vLi4vY29tcG9uZW50cy92aWV3cy9yb29tcy9FdmVudFRpbGVcIjtcbmltcG9ydCB7IEV4cG9ydFR5cGUgfSBmcm9tIFwiLi9leHBvcnRVdGlsc1wiO1xuaW1wb3J0IHsgSUV4cG9ydE9wdGlvbnMgfSBmcm9tIFwiLi9leHBvcnRVdGlsc1wiO1xuaW1wb3J0IHsgdGV4dEZvckV2ZW50IH0gZnJvbSBcIi4uLy4uL1RleHRGb3JFdmVudFwiO1xuXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbG9nZ2VyXCI7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFBsYWluVGV4dEV4cG9ydGVyIGV4dGVuZHMgRXhwb3J0ZXIge1xuICAgIHByb3RlY3RlZCB0b3RhbFNpemU6IG51bWJlcjtcbiAgICBwcm90ZWN0ZWQgbWVkaWFPbWl0VGV4dDogc3RyaW5nO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHJvb206IFJvb20sXG4gICAgICAgIGV4cG9ydFR5cGU6IEV4cG9ydFR5cGUsXG4gICAgICAgIGV4cG9ydE9wdGlvbnM6IElFeHBvcnRPcHRpb25zLFxuICAgICAgICBzZXRQcm9ncmVzc1RleHQ6IFJlYWN0LkRpc3BhdGNoPFJlYWN0LlNldFN0YXRlQWN0aW9uPHN0cmluZz4+LFxuICAgICkge1xuICAgICAgICBzdXBlcihyb29tLCBleHBvcnRUeXBlLCBleHBvcnRPcHRpb25zLCBzZXRQcm9ncmVzc1RleHQpO1xuICAgICAgICB0aGlzLnRvdGFsU2l6ZSA9IDA7XG4gICAgICAgIHRoaXMubWVkaWFPbWl0VGV4dCA9ICF0aGlzLmV4cG9ydE9wdGlvbnMuYXR0YWNobWVudHNJbmNsdWRlZFxuICAgICAgICAgICAgPyBfdChcIk1lZGlhIG9taXR0ZWRcIilcbiAgICAgICAgICAgIDogX3QoXCJNZWRpYSBvbWl0dGVkIC0gZmlsZSBzaXplIGxpbWl0IGV4Y2VlZGVkXCIpO1xuICAgIH1cblxuICAgIHB1YmxpYyB0ZXh0Rm9yUmVwbHlFdmVudCA9IChjb250ZW50OiBJQ29udGVudCkgPT4ge1xuICAgICAgICBjb25zdCBSRVBMWV9SRUdFWCA9IC8+IDwoLio/KT4oLio/KVxcblxcbiguKikvcztcbiAgICAgICAgY29uc3QgUkVQTFlfU09VUkNFX01BWF9MRU5HVEggPSAzMjtcblxuICAgICAgICBjb25zdCBtYXRjaCA9IFJFUExZX1JFR0VYLmV4ZWMoY29udGVudC5ib2R5KTtcblxuICAgICAgICAvLyBpZiB0aGUgcmVwbHkgZm9ybWF0IGlzIGludmFsaWQsIHRoZW4gcmV0dXJuIHRoZSBib2R5XG4gICAgICAgIGlmICghbWF0Y2gpIHJldHVybiBjb250ZW50LmJvZHk7XG5cbiAgICAgICAgbGV0IHJwbFNvdXJjZTogc3RyaW5nO1xuICAgICAgICBjb25zdCBycGxOYW1lID0gbWF0Y2hbMV07XG4gICAgICAgIGNvbnN0IHJwbFRleHQgPSBtYXRjaFszXTtcblxuICAgICAgICBycGxTb3VyY2UgPSBtYXRjaFsyXS5zdWJzdHJpbmcoMSk7XG4gICAgICAgIC8vIEdldCB0aGUgZmlyc3Qgbm9uLWJsYW5rIGxpbmUgZnJvbSB0aGUgc291cmNlLlxuICAgICAgICBjb25zdCBsaW5lcyA9IHJwbFNvdXJjZS5zcGxpdCgnXFxuJykuZmlsdGVyKChsaW5lKSA9PiAhL15cXHMqJC8udGVzdChsaW5lKSk7XG4gICAgICAgIGlmIChsaW5lcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAvLyBDdXQgdG8gYSBtYXhpbXVtIGxlbmd0aC5cbiAgICAgICAgICAgIHJwbFNvdXJjZSA9IGxpbmVzWzBdLnN1YnN0cmluZygwLCBSRVBMWV9TT1VSQ0VfTUFYX0xFTkdUSCk7XG4gICAgICAgICAgICAvLyBFbGxpcHNpcyBpZiBuZWVkZWQuXG4gICAgICAgICAgICBpZiAobGluZXNbMF0ubGVuZ3RoID4gUkVQTFlfU09VUkNFX01BWF9MRU5HVEgpIHtcbiAgICAgICAgICAgICAgICBycGxTb3VyY2UgPSBycGxTb3VyY2UgKyBcIi4uLlwiO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gV3JhcCBpbiBmb3JtYXR0aW5nXG4gICAgICAgICAgICBycGxTb3VyY2UgPSBgIFwiJHtycGxTb3VyY2V9XCJgO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gRG9uJ3Qgc2hvdyBhIHNvdXJjZSBiZWNhdXNlIHdlIGNvdWxkbid0IGZvcm1hdCBvbmUuXG4gICAgICAgICAgICBycGxTb3VyY2UgPSBcIlwiO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGA8JHtycGxOYW1lfSR7cnBsU291cmNlfT4gJHtycGxUZXh0fWA7XG4gICAgfTtcblxuICAgIHByb3RlY3RlZCBwbGFpblRleHRGb3JFdmVudCA9IGFzeW5jIChteEV2OiBNYXRyaXhFdmVudCkgPT4ge1xuICAgICAgICBjb25zdCBzZW5kZXJEaXNwbGF5TmFtZSA9IG14RXYuc2VuZGVyICYmIG14RXYuc2VuZGVyLm5hbWUgPyBteEV2LnNlbmRlci5uYW1lIDogbXhFdi5nZXRTZW5kZXIoKTtcbiAgICAgICAgbGV0IG1lZGlhVGV4dCA9IFwiXCI7XG4gICAgICAgIGlmICh0aGlzLmlzQXR0YWNobWVudChteEV2KSkge1xuICAgICAgICAgICAgaWYgKHRoaXMuZXhwb3J0T3B0aW9ucy5hdHRhY2htZW50c0luY2x1ZGVkKSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmxvYiA9IGF3YWl0IHRoaXMuZ2V0TWVkaWFCbG9iKG14RXYpO1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy50b3RhbFNpemUgKyBibG9iLnNpemUgPiB0aGlzLmV4cG9ydE9wdGlvbnMubWF4U2l6ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWFUZXh0ID0gYCAoJHt0aGlzLm1lZGlhT21pdFRleHR9KWA7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRvdGFsU2l6ZSArPSBibG9iLnNpemU7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmaWxlUGF0aCA9IHRoaXMuZ2V0RmlsZVBhdGgobXhFdik7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZWRpYVRleHQgPSBcIiAoXCIgKyBfdChcIkZpbGUgQXR0YWNoZWRcIikgKyBcIilcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkRmlsZShmaWxlUGF0aCwgYmxvYik7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy50b3RhbFNpemUgPT0gdGhpcy5leHBvcnRPcHRpb25zLm1heFNpemUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmV4cG9ydE9wdGlvbnMuYXR0YWNobWVudHNJbmNsdWRlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgbWVkaWFUZXh0ID0gXCIgKFwiICsgX3QoXCJFcnJvciBmZXRjaGluZyBmaWxlXCIpICsgXCIpXCI7XG4gICAgICAgICAgICAgICAgICAgIGxvZ2dlci5sb2coXCJFcnJvciBmZXRjaGluZyBmaWxlIFwiICsgZXJyb3IpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBtZWRpYVRleHQgPSBgICgke3RoaXMubWVkaWFPbWl0VGV4dH0pYDtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5pc1JlcGx5KG14RXYpKSByZXR1cm4gc2VuZGVyRGlzcGxheU5hbWUgKyBcIjogXCIgKyB0aGlzLnRleHRGb3JSZXBseUV2ZW50KG14RXYuZ2V0Q29udGVudCgpKSArIG1lZGlhVGV4dDtcbiAgICAgICAgZWxzZSByZXR1cm4gdGV4dEZvckV2ZW50KG14RXYpICsgbWVkaWFUZXh0O1xuICAgIH07XG5cbiAgICBwcm90ZWN0ZWQgYXN5bmMgY3JlYXRlT3V0cHV0KGV2ZW50czogTWF0cml4RXZlbnRbXSkge1xuICAgICAgICBsZXQgY29udGVudCA9IFwiXCI7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZXZlbnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBjb25zdCBldmVudCA9IGV2ZW50c1tpXTtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlUHJvZ3Jlc3MoYFByb2Nlc3NpbmcgZXZlbnQgJHtpICsgMX0gb3V0IG9mICR7ZXZlbnRzLmxlbmd0aH1gLCBmYWxzZSwgdHJ1ZSk7XG4gICAgICAgICAgICBpZiAodGhpcy5jYW5jZWxsZWQpIHJldHVybiB0aGlzLmNsZWFuVXAoKTtcbiAgICAgICAgICAgIGlmICghaGF2ZVRpbGVGb3JFdmVudChldmVudCkpIGNvbnRpbnVlO1xuICAgICAgICAgICAgY29uc3QgdGV4dEZvckV2ZW50ID0gYXdhaXQgdGhpcy5wbGFpblRleHRGb3JFdmVudChldmVudCk7XG4gICAgICAgICAgICBjb250ZW50ICs9IHRleHRGb3JFdmVudCAmJiBgJHtuZXcgRGF0ZShldmVudC5nZXRUcygpKS50b0xvY2FsZVN0cmluZygpfSAtICR7dGV4dEZvckV2ZW50fVxcbmA7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGNvbnRlbnQ7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGV4cG9ydCgpIHtcbiAgICAgICAgdGhpcy51cGRhdGVQcm9ncmVzcyhcIlN0YXJ0aW5nIGV4cG9ydCBwcm9jZXNzLi4uXCIpO1xuICAgICAgICB0aGlzLnVwZGF0ZVByb2dyZXNzKFwiRmV0Y2hpbmcgZXZlbnRzLi4uXCIpO1xuXG4gICAgICAgIGNvbnN0IGZldGNoU3RhcnQgPSBwZXJmb3JtYW5jZS5ub3coKTtcbiAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5nZXRSZXF1aXJlZEV2ZW50cygpO1xuICAgICAgICBjb25zdCBmZXRjaEVuZCA9IHBlcmZvcm1hbmNlLm5vdygpO1xuXG4gICAgICAgIGxvZ2dlci5sb2coYEZldGNoZWQgJHtyZXMubGVuZ3RofSBldmVudHMgaW4gJHsoZmV0Y2hFbmQgLSBmZXRjaFN0YXJ0KS8xMDAwfXNgKTtcblxuICAgICAgICB0aGlzLnVwZGF0ZVByb2dyZXNzKFwiQ3JlYXRpbmcgb3V0cHV0Li4uXCIpO1xuICAgICAgICBjb25zdCB0ZXh0ID0gYXdhaXQgdGhpcy5jcmVhdGVPdXRwdXQocmVzKTtcblxuICAgICAgICBpZiAodGhpcy5maWxlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoaXMuYWRkRmlsZShcImV4cG9ydC50eHRcIiwgbmV3IEJsb2IoW3RleHRdKSk7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmRvd25sb2FkWklQKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBmaWxlTmFtZSA9IGBtYXRyaXgtZXhwb3J0LSR7Zm9ybWF0RnVsbERhdGVOb0RheShuZXcgRGF0ZSgpKX0udHh0YDtcbiAgICAgICAgICAgIHRoaXMuZG93bmxvYWRQbGFpblRleHQoZmlsZU5hbWUsIHRleHQpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZXhwb3J0RW5kID0gcGVyZm9ybWFuY2Uubm93KCk7XG5cbiAgICAgICAgaWYgKHRoaXMuY2FuY2VsbGVkKSB7XG4gICAgICAgICAgICBsb2dnZXIuaW5mbyhcIkV4cG9ydCBjYW5jZWxsZWQgc3VjY2Vzc2Z1bGx5XCIpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbG9nZ2VyLmluZm8oXCJFeHBvcnQgc3VjY2Vzc2Z1bCFcIik7XG4gICAgICAgICAgICBsb2dnZXIubG9nKGBFeHBvcnRlZCAke3Jlcy5sZW5ndGh9IGV2ZW50cyBpbiAkeyhleHBvcnRFbmQgLSBmZXRjaFN0YXJ0KS8xMDAwfSBzZWNvbmRzYCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmNsZWFuVXAoKTtcbiAgICB9XG59XG5cbiJdfQ==