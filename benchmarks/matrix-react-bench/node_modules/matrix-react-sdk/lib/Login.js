"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.IdentityProviderBrand = void 0;
exports.sendLoginRequest = sendLoginRequest;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _matrix = require("matrix-js-sdk/src/matrix");

var _Security = _interopRequireDefault(require("./customisations/Security"));

var _logger = require("matrix-js-sdk/src/logger");

/*
Copyright 2015-2021 The Matrix.org Foundation C.I.C.
Copyright 2019 Michael Telatynski <7t3chguy@gmail.com>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
// @ts-ignore - XXX: tsc doesn't like this: our js-sdk imports are complex so this isn't surprising
let IdentityProviderBrand;
exports.IdentityProviderBrand = IdentityProviderBrand;

(function (IdentityProviderBrand) {
  IdentityProviderBrand["Gitlab"] = "gitlab";
  IdentityProviderBrand["Github"] = "github";
  IdentityProviderBrand["Apple"] = "apple";
  IdentityProviderBrand["Google"] = "google";
  IdentityProviderBrand["Facebook"] = "facebook";
  IdentityProviderBrand["Twitter"] = "twitter";
})(IdentityProviderBrand || (exports.IdentityProviderBrand = IdentityProviderBrand = {}));

/* eslint-enable camelcase */
class Login {
  // TODO: Flows need a type in JS SDK
  constructor(hsUrl, isUrl, fallbackHsUrl, opts) {
    (0, _defineProperty2.default)(this, "hsUrl", void 0);
    (0, _defineProperty2.default)(this, "isUrl", void 0);
    (0, _defineProperty2.default)(this, "fallbackHsUrl", void 0);
    (0, _defineProperty2.default)(this, "flows", void 0);
    (0, _defineProperty2.default)(this, "defaultDeviceDisplayName", void 0);
    (0, _defineProperty2.default)(this, "tempClient", void 0);
    this.hsUrl = hsUrl;
    this.isUrl = isUrl;
    this.fallbackHsUrl = fallbackHsUrl;
    this.flows = [];
    this.defaultDeviceDisplayName = opts.defaultDeviceDisplayName;
    this.tempClient = null; // memoize
  }

  getHomeserverUrl() {
    return this.hsUrl;
  }

  getIdentityServerUrl() {
    return this.isUrl;
  }

  setHomeserverUrl(hsUrl) {
    this.tempClient = null; // clear memoization

    this.hsUrl = hsUrl;
  }

  setIdentityServerUrl(isUrl) {
    this.tempClient = null; // clear memoization

    this.isUrl = isUrl;
  }
  /**
   * Get a temporary MatrixClient, which can be used for login or register
   * requests.
   * @returns {MatrixClient}
   */


  createTemporaryClient() {
    if (this.tempClient) return this.tempClient; // use memoization

    return this.tempClient = (0, _matrix.createClient)({
      baseUrl: this.hsUrl,
      idBaseUrl: this.isUrl
    });
  }

  async getFlows() {
    const client = this.createTemporaryClient();
    const {
      flows
    } = await client.loginFlows();
    this.flows = flows;
    return this.flows;
  }

  loginViaPassword(username, phoneCountry, phoneNumber, password) {
    const isEmail = username.indexOf("@") > 0;
    let identifier;

    if (phoneCountry && phoneNumber) {
      identifier = {
        type: 'm.id.phone',
        country: phoneCountry,
        phone: phoneNumber,
        // XXX: Synapse historically wanted `number` and not `phone`
        number: phoneNumber
      };
    } else if (isEmail) {
      identifier = {
        type: 'm.id.thirdparty',
        medium: 'email',
        address: username
      };
    } else {
      identifier = {
        type: 'm.id.user',
        user: username
      };
    }

    const loginParams = {
      password,
      identifier,
      initial_device_display_name: this.defaultDeviceDisplayName
    };

    const tryFallbackHs = originalError => {
      return sendLoginRequest(this.fallbackHsUrl, this.isUrl, 'm.login.password', loginParams).catch(fallbackError => {
        _logger.logger.log("fallback HS login failed", fallbackError); // throw the original error


        throw originalError;
      });
    };

    let originalLoginError = null;
    return sendLoginRequest(this.hsUrl, this.isUrl, 'm.login.password', loginParams).catch(error => {
      originalLoginError = error;

      if (error.httpStatus === 403) {
        if (this.fallbackHsUrl) {
          return tryFallbackHs(originalLoginError);
        }
      }

      throw originalLoginError;
    }).catch(error => {
      _logger.logger.log("Login failed", error);

      throw error;
    });
  }

}
/**
 * Send a login request to the given server, and format the response
 * as a MatrixClientCreds
 *
 * @param {string} hsUrl   the base url of the Homeserver used to log in.
 * @param {string} isUrl   the base url of the default identity server
 * @param {string} loginType the type of login to do
 * @param {ILoginParams} loginParams the parameters for the login
 *
 * @returns {MatrixClientCreds}
 */


exports.default = Login;

async function sendLoginRequest(hsUrl, isUrl, loginType, loginParams) {
  var _SecurityCustomisatio;

  const client = (0, _matrix.createClient)({
    baseUrl: hsUrl,
    idBaseUrl: isUrl
  });
  const data = await client.login(loginType, loginParams);
  const wellknown = data.well_known;

  if (wellknown) {
    if (wellknown["m.homeserver"] && wellknown["m.homeserver"]["base_url"]) {
      hsUrl = wellknown["m.homeserver"]["base_url"];

      _logger.logger.log(`Overrode homeserver setting with ${hsUrl} from login response`);
    }

    if (wellknown["m.identity_server"] && wellknown["m.identity_server"]["base_url"]) {
      // TODO: should we prompt here?
      isUrl = wellknown["m.identity_server"]["base_url"];

      _logger.logger.log(`Overrode IS setting with ${isUrl} from login response`);
    }
  }

  const creds = {
    homeserverUrl: hsUrl,
    identityServerUrl: isUrl,
    userId: data.user_id,
    deviceId: data.device_id,
    accessToken: data.access_token
  };
  (_SecurityCustomisatio = _Security.default.examineLoginResponse) === null || _SecurityCustomisatio === void 0 ? void 0 : _SecurityCustomisatio.call(_Security.default, data, creds);
  return creds;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Mb2dpbi50cyJdLCJuYW1lcyI6WyJJZGVudGl0eVByb3ZpZGVyQnJhbmQiLCJMb2dpbiIsImNvbnN0cnVjdG9yIiwiaHNVcmwiLCJpc1VybCIsImZhbGxiYWNrSHNVcmwiLCJvcHRzIiwiZmxvd3MiLCJkZWZhdWx0RGV2aWNlRGlzcGxheU5hbWUiLCJ0ZW1wQ2xpZW50IiwiZ2V0SG9tZXNlcnZlclVybCIsImdldElkZW50aXR5U2VydmVyVXJsIiwic2V0SG9tZXNlcnZlclVybCIsInNldElkZW50aXR5U2VydmVyVXJsIiwiY3JlYXRlVGVtcG9yYXJ5Q2xpZW50IiwiYmFzZVVybCIsImlkQmFzZVVybCIsImdldEZsb3dzIiwiY2xpZW50IiwibG9naW5GbG93cyIsImxvZ2luVmlhUGFzc3dvcmQiLCJ1c2VybmFtZSIsInBob25lQ291bnRyeSIsInBob25lTnVtYmVyIiwicGFzc3dvcmQiLCJpc0VtYWlsIiwiaW5kZXhPZiIsImlkZW50aWZpZXIiLCJ0eXBlIiwiY291bnRyeSIsInBob25lIiwibnVtYmVyIiwibWVkaXVtIiwiYWRkcmVzcyIsInVzZXIiLCJsb2dpblBhcmFtcyIsImluaXRpYWxfZGV2aWNlX2Rpc3BsYXlfbmFtZSIsInRyeUZhbGxiYWNrSHMiLCJvcmlnaW5hbEVycm9yIiwic2VuZExvZ2luUmVxdWVzdCIsImNhdGNoIiwiZmFsbGJhY2tFcnJvciIsImxvZ2dlciIsImxvZyIsIm9yaWdpbmFsTG9naW5FcnJvciIsImVycm9yIiwiaHR0cFN0YXR1cyIsImxvZ2luVHlwZSIsImRhdGEiLCJsb2dpbiIsIndlbGxrbm93biIsIndlbGxfa25vd24iLCJjcmVkcyIsImhvbWVzZXJ2ZXJVcmwiLCJpZGVudGl0eVNlcnZlclVybCIsInVzZXJJZCIsInVzZXJfaWQiLCJkZXZpY2VJZCIsImRldmljZV9pZCIsImFjY2Vzc1Rva2VuIiwiYWNjZXNzX3Rva2VuIiwiZXhhbWluZUxvZ2luUmVzcG9uc2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7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ZTtBQUs5QkMsSUFBQUEsV0FBVyxFQUFFWCxJQUFJLENBQUNZO0FBTFksR0FBbEM7QUFRQSw2Q0FBdUJDLG9CQUF2Qix3R0FBOENiLElBQTlDLEVBQW9ESSxLQUFwRDtBQUVBLFNBQU9BLEtBQVA7QUFDSCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNS0yMDIxIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5Db3B5cmlnaHQgMjAxOSBNaWNoYWVsIFRlbGF0eW5za2kgPDd0M2NoZ3V5QGdtYWlsLmNvbT5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG4vLyBAdHMtaWdub3JlIC0gWFhYOiB0c2MgZG9lc24ndCBsaWtlIHRoaXM6IG91ciBqcy1zZGsgaW1wb3J0cyBhcmUgY29tcGxleCBzbyB0aGlzIGlzbid0IHN1cnByaXNpbmdcbmltcG9ydCB7IGNyZWF0ZUNsaWVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tYXRyaXhcIjtcbmltcG9ydCB7IE1hdHJpeENsaWVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9jbGllbnRcIjtcbmltcG9ydCB7IElNYXRyaXhDbGllbnRDcmVkcyB9IGZyb20gXCIuL01hdHJpeENsaWVudFBlZ1wiO1xuaW1wb3J0IFNlY3VyaXR5Q3VzdG9taXNhdGlvbnMgZnJvbSBcIi4vY3VzdG9taXNhdGlvbnMvU2VjdXJpdHlcIjtcblxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2xvZ2dlclwiO1xuXG5pbnRlcmZhY2UgSUxvZ2luT3B0aW9ucyB7XG4gICAgZGVmYXVsdERldmljZURpc3BsYXlOYW1lPzogc3RyaW5nO1xufVxuXG4vLyBUT0RPOiBNb3ZlIHRoaXMgdG8gSlMgU0RLXG5pbnRlcmZhY2UgSVBhc3N3b3JkRmxvdyB7XG4gICAgdHlwZTogXCJtLmxvZ2luLnBhc3N3b3JkXCI7XG59XG5cbmV4cG9ydCBlbnVtIElkZW50aXR5UHJvdmlkZXJCcmFuZCB7XG4gICAgR2l0bGFiID0gXCJnaXRsYWJcIixcbiAgICBHaXRodWIgPSBcImdpdGh1YlwiLFxuICAgIEFwcGxlID0gXCJhcHBsZVwiLFxuICAgIEdvb2dsZSA9IFwiZ29vZ2xlXCIsXG4gICAgRmFjZWJvb2sgPSBcImZhY2Vib29rXCIsXG4gICAgVHdpdHRlciA9IFwidHdpdHRlclwiLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElJZGVudGl0eVByb3ZpZGVyIHtcbiAgICBpZDogc3RyaW5nO1xuICAgIG5hbWU6IHN0cmluZztcbiAgICBpY29uPzogc3RyaW5nO1xuICAgIGJyYW5kPzogSWRlbnRpdHlQcm92aWRlckJyYW5kIHwgc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElTU09GbG93IHtcbiAgICB0eXBlOiBcIm0ubG9naW4uc3NvXCIgfCBcIm0ubG9naW4uY2FzXCI7XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNhbWVsY2FzZVxuICAgIGlkZW50aXR5X3Byb3ZpZGVyczogSUlkZW50aXR5UHJvdmlkZXJbXTtcbn1cblxuZXhwb3J0IHR5cGUgTG9naW5GbG93ID0gSVNTT0Zsb3cgfCBJUGFzc3dvcmRGbG93O1xuXG4vLyBUT0RPOiBNb3ZlIHRoaXMgdG8gSlMgU0RLXG4vKiBlc2xpbnQtZGlzYWJsZSBjYW1lbGNhc2UgKi9cbmludGVyZmFjZSBJTG9naW5QYXJhbXMge1xuICAgIGlkZW50aWZpZXI/OiBvYmplY3Q7XG4gICAgcGFzc3dvcmQ/OiBzdHJpbmc7XG4gICAgdG9rZW4/OiBzdHJpbmc7XG4gICAgZGV2aWNlX2lkPzogc3RyaW5nO1xuICAgIGluaXRpYWxfZGV2aWNlX2Rpc3BsYXlfbmFtZT86IHN0cmluZztcbn1cbi8qIGVzbGludC1lbmFibGUgY2FtZWxjYXNlICovXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIExvZ2luIHtcbiAgICBwcml2YXRlIGhzVXJsOiBzdHJpbmc7XG4gICAgcHJpdmF0ZSBpc1VybDogc3RyaW5nO1xuICAgIHByaXZhdGUgZmFsbGJhY2tIc1VybDogc3RyaW5nO1xuICAgIC8vIFRPRE86IEZsb3dzIG5lZWQgYSB0eXBlIGluIEpTIFNES1xuICAgIHByaXZhdGUgZmxvd3M6IEFycmF5PExvZ2luRmxvdz47XG4gICAgcHJpdmF0ZSBkZWZhdWx0RGV2aWNlRGlzcGxheU5hbWU6IHN0cmluZztcbiAgICBwcml2YXRlIHRlbXBDbGllbnQ6IE1hdHJpeENsaWVudDtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBoc1VybDogc3RyaW5nLFxuICAgICAgICBpc1VybDogc3RyaW5nLFxuICAgICAgICBmYWxsYmFja0hzVXJsPzogc3RyaW5nLFxuICAgICAgICBvcHRzPzogSUxvZ2luT3B0aW9ucyxcbiAgICApIHtcbiAgICAgICAgdGhpcy5oc1VybCA9IGhzVXJsO1xuICAgICAgICB0aGlzLmlzVXJsID0gaXNVcmw7XG4gICAgICAgIHRoaXMuZmFsbGJhY2tIc1VybCA9IGZhbGxiYWNrSHNVcmw7XG4gICAgICAgIHRoaXMuZmxvd3MgPSBbXTtcbiAgICAgICAgdGhpcy5kZWZhdWx0RGV2aWNlRGlzcGxheU5hbWUgPSBvcHRzLmRlZmF1bHREZXZpY2VEaXNwbGF5TmFtZTtcbiAgICAgICAgdGhpcy50ZW1wQ2xpZW50ID0gbnVsbDsgLy8gbWVtb2l6ZVxuICAgIH1cblxuICAgIHB1YmxpYyBnZXRIb21lc2VydmVyVXJsKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLmhzVXJsO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRJZGVudGl0eVNlcnZlclVybCgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5pc1VybDtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0SG9tZXNlcnZlclVybChoc1VybDogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIHRoaXMudGVtcENsaWVudCA9IG51bGw7IC8vIGNsZWFyIG1lbW9pemF0aW9uXG4gICAgICAgIHRoaXMuaHNVcmwgPSBoc1VybDtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0SWRlbnRpdHlTZXJ2ZXJVcmwoaXNVcmw6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICB0aGlzLnRlbXBDbGllbnQgPSBudWxsOyAvLyBjbGVhciBtZW1vaXphdGlvblxuICAgICAgICB0aGlzLmlzVXJsID0gaXNVcmw7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGEgdGVtcG9yYXJ5IE1hdHJpeENsaWVudCwgd2hpY2ggY2FuIGJlIHVzZWQgZm9yIGxvZ2luIG9yIHJlZ2lzdGVyXG4gICAgICogcmVxdWVzdHMuXG4gICAgICogQHJldHVybnMge01hdHJpeENsaWVudH1cbiAgICAgKi9cbiAgICBwdWJsaWMgY3JlYXRlVGVtcG9yYXJ5Q2xpZW50KCk6IE1hdHJpeENsaWVudCB7XG4gICAgICAgIGlmICh0aGlzLnRlbXBDbGllbnQpIHJldHVybiB0aGlzLnRlbXBDbGllbnQ7IC8vIHVzZSBtZW1vaXphdGlvblxuICAgICAgICByZXR1cm4gdGhpcy50ZW1wQ2xpZW50ID0gY3JlYXRlQ2xpZW50KHtcbiAgICAgICAgICAgIGJhc2VVcmw6IHRoaXMuaHNVcmwsXG4gICAgICAgICAgICBpZEJhc2VVcmw6IHRoaXMuaXNVcmwsXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBnZXRGbG93cygpOiBQcm9taXNlPEFycmF5PExvZ2luRmxvdz4+IHtcbiAgICAgICAgY29uc3QgY2xpZW50ID0gdGhpcy5jcmVhdGVUZW1wb3JhcnlDbGllbnQoKTtcbiAgICAgICAgY29uc3QgeyBmbG93cyB9ID0gYXdhaXQgY2xpZW50LmxvZ2luRmxvd3MoKTtcbiAgICAgICAgdGhpcy5mbG93cyA9IGZsb3dzO1xuICAgICAgICByZXR1cm4gdGhpcy5mbG93cztcbiAgICB9XG5cbiAgICBwdWJsaWMgbG9naW5WaWFQYXNzd29yZChcbiAgICAgICAgdXNlcm5hbWU6IHN0cmluZyxcbiAgICAgICAgcGhvbmVDb3VudHJ5OiBzdHJpbmcsXG4gICAgICAgIHBob25lTnVtYmVyOiBzdHJpbmcsXG4gICAgICAgIHBhc3N3b3JkOiBzdHJpbmcsXG4gICAgKTogUHJvbWlzZTxJTWF0cml4Q2xpZW50Q3JlZHM+IHtcbiAgICAgICAgY29uc3QgaXNFbWFpbCA9IHVzZXJuYW1lLmluZGV4T2YoXCJAXCIpID4gMDtcblxuICAgICAgICBsZXQgaWRlbnRpZmllcjtcbiAgICAgICAgaWYgKHBob25lQ291bnRyeSAmJiBwaG9uZU51bWJlcikge1xuICAgICAgICAgICAgaWRlbnRpZmllciA9IHtcbiAgICAgICAgICAgICAgICB0eXBlOiAnbS5pZC5waG9uZScsXG4gICAgICAgICAgICAgICAgY291bnRyeTogcGhvbmVDb3VudHJ5LFxuICAgICAgICAgICAgICAgIHBob25lOiBwaG9uZU51bWJlcixcbiAgICAgICAgICAgICAgICAvLyBYWFg6IFN5bmFwc2UgaGlzdG9yaWNhbGx5IHdhbnRlZCBgbnVtYmVyYCBhbmQgbm90IGBwaG9uZWBcbiAgICAgICAgICAgICAgICBudW1iZXI6IHBob25lTnVtYmVyLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSBlbHNlIGlmIChpc0VtYWlsKSB7XG4gICAgICAgICAgICBpZGVudGlmaWVyID0ge1xuICAgICAgICAgICAgICAgIHR5cGU6ICdtLmlkLnRoaXJkcGFydHknLFxuICAgICAgICAgICAgICAgIG1lZGl1bTogJ2VtYWlsJyxcbiAgICAgICAgICAgICAgICBhZGRyZXNzOiB1c2VybmFtZSxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZGVudGlmaWVyID0ge1xuICAgICAgICAgICAgICAgIHR5cGU6ICdtLmlkLnVzZXInLFxuICAgICAgICAgICAgICAgIHVzZXI6IHVzZXJuYW1lLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGxvZ2luUGFyYW1zID0ge1xuICAgICAgICAgICAgcGFzc3dvcmQsXG4gICAgICAgICAgICBpZGVudGlmaWVyLFxuICAgICAgICAgICAgaW5pdGlhbF9kZXZpY2VfZGlzcGxheV9uYW1lOiB0aGlzLmRlZmF1bHREZXZpY2VEaXNwbGF5TmFtZSxcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCB0cnlGYWxsYmFja0hzID0gKG9yaWdpbmFsRXJyb3IpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBzZW5kTG9naW5SZXF1ZXN0KFxuICAgICAgICAgICAgICAgIHRoaXMuZmFsbGJhY2tIc1VybCwgdGhpcy5pc1VybCwgJ20ubG9naW4ucGFzc3dvcmQnLCBsb2dpblBhcmFtcyxcbiAgICAgICAgICAgICkuY2F0Y2goKGZhbGxiYWNrRXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICBsb2dnZXIubG9nKFwiZmFsbGJhY2sgSFMgbG9naW4gZmFpbGVkXCIsIGZhbGxiYWNrRXJyb3IpO1xuICAgICAgICAgICAgICAgIC8vIHRocm93IHRoZSBvcmlnaW5hbCBlcnJvclxuICAgICAgICAgICAgICAgIHRocm93IG9yaWdpbmFsRXJyb3I7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcblxuICAgICAgICBsZXQgb3JpZ2luYWxMb2dpbkVycm9yID0gbnVsbDtcbiAgICAgICAgcmV0dXJuIHNlbmRMb2dpblJlcXVlc3QoXG4gICAgICAgICAgICB0aGlzLmhzVXJsLCB0aGlzLmlzVXJsLCAnbS5sb2dpbi5wYXNzd29yZCcsIGxvZ2luUGFyYW1zLFxuICAgICAgICApLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICAgICAgb3JpZ2luYWxMb2dpbkVycm9yID0gZXJyb3I7XG4gICAgICAgICAgICBpZiAoZXJyb3IuaHR0cFN0YXR1cyA9PT0gNDAzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZmFsbGJhY2tIc1VybCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ5RmFsbGJhY2tIcyhvcmlnaW5hbExvZ2luRXJyb3IpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRocm93IG9yaWdpbmFsTG9naW5FcnJvcjtcbiAgICAgICAgfSkuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICAgICAgICBsb2dnZXIubG9nKFwiTG9naW4gZmFpbGVkXCIsIGVycm9yKTtcbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9KTtcbiAgICB9XG59XG5cbi8qKlxuICogU2VuZCBhIGxvZ2luIHJlcXVlc3QgdG8gdGhlIGdpdmVuIHNlcnZlciwgYW5kIGZvcm1hdCB0aGUgcmVzcG9uc2VcbiAqIGFzIGEgTWF0cml4Q2xpZW50Q3JlZHNcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gaHNVcmwgICB0aGUgYmFzZSB1cmwgb2YgdGhlIEhvbWVzZXJ2ZXIgdXNlZCB0byBsb2cgaW4uXG4gKiBAcGFyYW0ge3N0cmluZ30gaXNVcmwgICB0aGUgYmFzZSB1cmwgb2YgdGhlIGRlZmF1bHQgaWRlbnRpdHkgc2VydmVyXG4gKiBAcGFyYW0ge3N0cmluZ30gbG9naW5UeXBlIHRoZSB0eXBlIG9mIGxvZ2luIHRvIGRvXG4gKiBAcGFyYW0ge0lMb2dpblBhcmFtc30gbG9naW5QYXJhbXMgdGhlIHBhcmFtZXRlcnMgZm9yIHRoZSBsb2dpblxuICpcbiAqIEByZXR1cm5zIHtNYXRyaXhDbGllbnRDcmVkc31cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNlbmRMb2dpblJlcXVlc3QoXG4gICAgaHNVcmw6IHN0cmluZyxcbiAgICBpc1VybDogc3RyaW5nLFxuICAgIGxvZ2luVHlwZTogc3RyaW5nLFxuICAgIGxvZ2luUGFyYW1zOiBJTG9naW5QYXJhbXMsXG4pOiBQcm9taXNlPElNYXRyaXhDbGllbnRDcmVkcz4ge1xuICAgIGNvbnN0IGNsaWVudCA9IGNyZWF0ZUNsaWVudCh7XG4gICAgICAgIGJhc2VVcmw6IGhzVXJsLFxuICAgICAgICBpZEJhc2VVcmw6IGlzVXJsLFxuICAgIH0pO1xuXG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IGNsaWVudC5sb2dpbihsb2dpblR5cGUsIGxvZ2luUGFyYW1zKTtcblxuICAgIGNvbnN0IHdlbGxrbm93biA9IGRhdGEud2VsbF9rbm93bjtcbiAgICBpZiAod2VsbGtub3duKSB7XG4gICAgICAgIGlmICh3ZWxsa25vd25bXCJtLmhvbWVzZXJ2ZXJcIl0gJiYgd2VsbGtub3duW1wibS5ob21lc2VydmVyXCJdW1wiYmFzZV91cmxcIl0pIHtcbiAgICAgICAgICAgIGhzVXJsID0gd2VsbGtub3duW1wibS5ob21lc2VydmVyXCJdW1wiYmFzZV91cmxcIl07XG4gICAgICAgICAgICBsb2dnZXIubG9nKGBPdmVycm9kZSBob21lc2VydmVyIHNldHRpbmcgd2l0aCAke2hzVXJsfSBmcm9tIGxvZ2luIHJlc3BvbnNlYCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHdlbGxrbm93bltcIm0uaWRlbnRpdHlfc2VydmVyXCJdICYmIHdlbGxrbm93bltcIm0uaWRlbnRpdHlfc2VydmVyXCJdW1wiYmFzZV91cmxcIl0pIHtcbiAgICAgICAgICAgIC8vIFRPRE86IHNob3VsZCB3ZSBwcm9tcHQgaGVyZT9cbiAgICAgICAgICAgIGlzVXJsID0gd2VsbGtub3duW1wibS5pZGVudGl0eV9zZXJ2ZXJcIl1bXCJiYXNlX3VybFwiXTtcbiAgICAgICAgICAgIGxvZ2dlci5sb2coYE92ZXJyb2RlIElTIHNldHRpbmcgd2l0aCAke2lzVXJsfSBmcm9tIGxvZ2luIHJlc3BvbnNlYCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBjcmVkczogSU1hdHJpeENsaWVudENyZWRzID0ge1xuICAgICAgICBob21lc2VydmVyVXJsOiBoc1VybCxcbiAgICAgICAgaWRlbnRpdHlTZXJ2ZXJVcmw6IGlzVXJsLFxuICAgICAgICB1c2VySWQ6IGRhdGEudXNlcl9pZCxcbiAgICAgICAgZGV2aWNlSWQ6IGRhdGEuZGV2aWNlX2lkLFxuICAgICAgICBhY2Nlc3NUb2tlbjogZGF0YS5hY2Nlc3NfdG9rZW4sXG4gICAgfTtcblxuICAgIFNlY3VyaXR5Q3VzdG9taXNhdGlvbnMuZXhhbWluZUxvZ2luUmVzcG9uc2U/LihkYXRhLCBjcmVkcyk7XG5cbiAgICByZXR1cm4gY3JlZHM7XG59XG4iXX0=