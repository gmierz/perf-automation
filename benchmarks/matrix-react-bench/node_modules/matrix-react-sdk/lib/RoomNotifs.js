"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.RoomNotifState = exports.MENTION_BADGE_STATES = exports.BADGE_STATES = void 0;
exports.aggregateNotificationCount = aggregateNotificationCount;
exports.getRoomHasBadge = getRoomHasBadge;
exports.getRoomNotifsState = getRoomNotifsState;
exports.getUnreadNotificationCount = getUnreadNotificationCount;
exports.setRoomNotifsState = setRoomNotifsState;
exports.shouldShowMentionBadge = shouldShowMentionBadge;
exports.shouldShowNotifBadge = shouldShowNotifBadge;

var _MatrixClientPeg = require("./MatrixClientPeg");

var _pushprocessor = require("matrix-js-sdk/src/pushprocessor");

var _room = require("matrix-js-sdk/src/models/room");

var _PushRules = require("matrix-js-sdk/src/@types/PushRules");

/*
Copyright 2016 OpenMarket Ltd
Copyright 2019 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
let RoomNotifState;
exports.RoomNotifState = RoomNotifState;

(function (RoomNotifState) {
  RoomNotifState["AllMessagesLoud"] = "all_messages_loud";
  RoomNotifState["AllMessages"] = "all_messages";
  RoomNotifState["MentionsOnly"] = "mentions_only";
  RoomNotifState["Mute"] = "mute";
})(RoomNotifState || (exports.RoomNotifState = RoomNotifState = {}));

const BADGE_STATES = [RoomNotifState.AllMessages, RoomNotifState.AllMessagesLoud];
exports.BADGE_STATES = BADGE_STATES;
const MENTION_BADGE_STATES = [...BADGE_STATES, RoomNotifState.MentionsOnly];
exports.MENTION_BADGE_STATES = MENTION_BADGE_STATES;

function shouldShowNotifBadge(roomNotifState) {
  return BADGE_STATES.includes(roomNotifState);
}

function shouldShowMentionBadge(roomNotifState) {
  return MENTION_BADGE_STATES.includes(roomNotifState);
}

function aggregateNotificationCount(rooms) {
  return rooms.reduce((result, room) => {
    const roomNotifState = getRoomNotifsState(room.roomId);
    const highlight = room.getUnreadNotificationCount(_room.NotificationCountType.Highlight) > 0; // use helper method to include highlights in the previous version of the room

    const notificationCount = getUnreadNotificationCount(room);
    const notifBadges = notificationCount > 0 && shouldShowNotifBadge(roomNotifState);
    const mentionBadges = highlight && shouldShowMentionBadge(roomNotifState);
    const badges = notifBadges || mentionBadges;

    if (badges) {
      result.count += notificationCount;

      if (highlight) {
        result.highlight = true;
      }
    }

    return result;
  }, {
    count: 0,
    highlight: false
  });
}

function getRoomHasBadge(room) {
  const roomNotifState = getRoomNotifsState(room.roomId);
  const highlight = room.getUnreadNotificationCount(_room.NotificationCountType.Highlight) > 0;
  const notificationCount = room.getUnreadNotificationCount();
  const notifBadges = notificationCount > 0 && shouldShowNotifBadge(roomNotifState);
  const mentionBadges = highlight && shouldShowMentionBadge(roomNotifState);
  return notifBadges || mentionBadges;
}

function getRoomNotifsState(roomId) {
  if (_MatrixClientPeg.MatrixClientPeg.get().isGuest()) return RoomNotifState.AllMessages; // look through the override rules for a rule affecting this room:
  // if one exists, it will take precedence.

  const muteRule = findOverrideMuteRule(roomId);

  if (muteRule) {
    return RoomNotifState.Mute;
  } // for everything else, look at the room rule.


  let roomRule = null;

  try {
    roomRule = _MatrixClientPeg.MatrixClientPeg.get().getRoomPushRule('global', roomId);
  } catch (err) {
    // Possible that the client doesn't have pushRules yet. If so, it
    // hasn't started eiher, so indicate that this room is not notifying.
    return null;
  } // XXX: We have to assume the default is to notify for all messages
  // (in particular this will be 'wrong' for one to one rooms because
  // they will notify loudly for all messages)


  if (!roomRule || !roomRule.enabled) return RoomNotifState.AllMessages; // a mute at the room level will still allow mentions
  // to notify

  if (isMuteRule(roomRule)) return RoomNotifState.MentionsOnly;

  const actionsObject = _pushprocessor.PushProcessor.actionListToActionsObject(roomRule.actions);

  if (actionsObject.tweaks.sound) return RoomNotifState.AllMessagesLoud;
  return null;
}

function setRoomNotifsState(roomId, newState) {
  if (newState === RoomNotifState.Mute) {
    return setRoomNotifsStateMuted(roomId);
  } else {
    return setRoomNotifsStateUnmuted(roomId, newState);
  }
}

function getUnreadNotificationCount(room, type = null) {
  let notificationCount = room.getUnreadNotificationCount(type); // Check notification counts in the old room just in case there's some lost
  // there. We only go one level down to avoid performance issues, and theory
  // is that 1st generation rooms will have already been read by the 3rd generation.

  const createEvent = room.currentState.getStateEvents("m.room.create", "");

  if (createEvent && createEvent.getContent()['predecessor']) {
    const oldRoomId = createEvent.getContent()['predecessor']['room_id'];

    const oldRoom = _MatrixClientPeg.MatrixClientPeg.get().getRoom(oldRoomId);

    if (oldRoom) {
      // We only ever care if there's highlights in the old room. No point in
      // notifying the user for unread messages because they would have extreme
      // difficulty changing their notification preferences away from "All Messages"
      // and "Noisy".
      notificationCount += oldRoom.getUnreadNotificationCount(_room.NotificationCountType.Highlight);
    }
  }

  return notificationCount;
}

function setRoomNotifsStateMuted(roomId) {
  const cli = _MatrixClientPeg.MatrixClientPeg.get();

  const promises = []; // delete the room rule

  const roomRule = cli.getRoomPushRule('global', roomId);

  if (roomRule) {
    promises.push(cli.deletePushRule('global', _PushRules.PushRuleKind.RoomSpecific, roomRule.rule_id));
  } // add/replace an override rule to squelch everything in this room
  // NB. We use the room ID as the name of this rule too, although this
  // is an override rule, not a room rule: it still pertains to this room
  // though, so using the room ID as the rule ID is logical and prevents
  // duplicate copies of the rule.


  promises.push(cli.addPushRule('global', _PushRules.PushRuleKind.Override, roomId, {
    conditions: [{
      kind: 'event_match',
      key: 'room_id',
      pattern: roomId
    }],
    actions: ['dont_notify']
  }));
  return Promise.all(promises);
}

function setRoomNotifsStateUnmuted(roomId, newState) {
  const cli = _MatrixClientPeg.MatrixClientPeg.get();

  const promises = [];
  const overrideMuteRule = findOverrideMuteRule(roomId);

  if (overrideMuteRule) {
    promises.push(cli.deletePushRule('global', _PushRules.PushRuleKind.Override, overrideMuteRule.rule_id));
  }

  if (newState === RoomNotifState.AllMessages) {
    const roomRule = cli.getRoomPushRule('global', roomId);

    if (roomRule) {
      promises.push(cli.deletePushRule('global', _PushRules.PushRuleKind.RoomSpecific, roomRule.rule_id));
    }
  } else if (newState === RoomNotifState.MentionsOnly) {
    promises.push(cli.addPushRule('global', _PushRules.PushRuleKind.RoomSpecific, roomId, {
      actions: ['dont_notify']
    })); // https://matrix.org/jira/browse/SPEC-400

    promises.push(cli.setPushRuleEnabled('global', _PushRules.PushRuleKind.RoomSpecific, roomId, true));
  } else if (newState === RoomNotifState.AllMessagesLoud) {
    promises.push(cli.addPushRule('global', _PushRules.PushRuleKind.RoomSpecific, roomId, {
      actions: ['notify', {
        set_tweak: 'sound',
        value: 'default'
      }]
    })); // https://matrix.org/jira/browse/SPEC-400

    promises.push(cli.setPushRuleEnabled('global', _PushRules.PushRuleKind.RoomSpecific, roomId, true));
  }

  return Promise.all(promises);
}

function findOverrideMuteRule(roomId) {
  var _cli$pushRules, _cli$pushRules$global;

  const cli = _MatrixClientPeg.MatrixClientPeg.get();

  if (!(cli !== null && cli !== void 0 && (_cli$pushRules = cli.pushRules) !== null && _cli$pushRules !== void 0 && (_cli$pushRules$global = _cli$pushRules.global) !== null && _cli$pushRules$global !== void 0 && _cli$pushRules$global.override)) {
    return null;
  }

  for (const rule of cli.pushRules.global.override) {
    if (isRuleForRoom(roomId, rule)) {
      if (isMuteRule(rule) && rule.enabled) {
        return rule;
      }
    }
  }

  return null;
}

function isRuleForRoom(roomId, rule) {
  if (rule.conditions.length !== 1) {
    return false;
  }

  const cond = rule.conditions[0];
  return cond.kind === _PushRules.ConditionKind.EventMatch && cond.key === 'room_id' && cond.pattern === roomId;
}

function isMuteRule(rule) {
  return rule.actions.length === 1 && rule.actions[0] === _PushRules.PushRuleActionName.DontNotify;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Sb29tTm90aWZzLnRzIl0sIm5hbWVzIjpbIlJvb21Ob3RpZlN0YXRlIiwiQkFER0VfU1RBVEVTIiwiQWxsTWVzc2FnZXMiLCJBbGxNZXNzYWdlc0xvdWQiLCJNRU5USU9OX0JBREdFX1NUQVRFUyIsIk1lbnRpb25zT25seSIsInNob3VsZFNob3dOb3RpZkJhZGdlIiwicm9vbU5vdGlmU3RhdGUiLCJpbmNsdWRlcyIsInNob3VsZFNob3dNZW50aW9uQmFkZ2UiLCJhZ2dyZWdhdGVOb3RpZmljYXRpb25Db3VudCIsInJvb21zIiwicmVkdWNlIiwicmVzdWx0Iiwicm9vbSIsImdldFJvb21Ob3RpZnNTdGF0ZSIsInJvb21JZCIsImhpZ2hsaWdodCIsImdldFVucmVhZE5vdGlmaWNhdGlvbkNvdW50IiwiTm90aWZpY2F0aW9uQ291bnRUeXBlIiwiSGlnaGxpZ2h0Iiwibm90aWZpY2F0aW9uQ291bnQiLCJub3RpZkJhZGdlcyIsIm1lbnRpb25CYWRnZXMiLCJiYWRnZXMiLCJjb3VudCIsImdldFJvb21IYXNCYWRnZSIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsImlzR3Vlc3QiLCJtdXRlUnVsZSIsImZpbmRPdmVycmlkZU11dGVSdWxlIiwiTXV0ZSIsInJvb21SdWxlIiwiZ2V0Um9vbVB1c2hSdWxlIiwiZXJyIiwiZW5hYmxlZCIsImlzTXV0ZVJ1bGUiLCJhY3Rpb25zT2JqZWN0IiwiUHVzaFByb2Nlc3NvciIsImFjdGlvbkxpc3RUb0FjdGlvbnNPYmplY3QiLCJhY3Rpb25zIiwidHdlYWtzIiwic291bmQiLCJzZXRSb29tTm90aWZzU3RhdGUiLCJuZXdTdGF0ZSIsInNldFJvb21Ob3RpZnNTdGF0ZU11dGVkIiwic2V0Um9vbU5vdGlmc1N0YXRlVW5tdXRlZCIsInR5cGUiLCJjcmVhdGVFdmVudCIsImN1cnJlbnRTdGF0ZSIsImdldFN0YXRlRXZlbnRzIiwiZ2V0Q29udGVudCIsIm9sZFJvb21JZCIsIm9sZFJvb20iLCJnZXRSb29tIiwiY2xpIiwicHJvbWlzZXMiLCJwdXNoIiwiZGVsZXRlUHVzaFJ1bGUiLCJQdXNoUnVsZUtpbmQiLCJSb29tU3BlY2lmaWMiLCJydWxlX2lkIiwiYWRkUHVzaFJ1bGUiLCJPdmVycmlkZSIsImNvbmRpdGlvbnMiLCJraW5kIiwia2V5IiwicGF0dGVybiIsIlByb21pc2UiLCJhbGwiLCJvdmVycmlkZU11dGVSdWxlIiwic2V0UHVzaFJ1bGVFbmFibGVkIiwic2V0X3R3ZWFrIiwidmFsdWUiLCJwdXNoUnVsZXMiLCJnbG9iYWwiLCJvdmVycmlkZSIsInJ1bGUiLCJpc1J1bGVGb3JSb29tIiwibGVuZ3RoIiwiY29uZCIsIkNvbmRpdGlvbktpbmQiLCJFdmVudE1hdGNoIiwiUHVzaFJ1bGVBY3Rpb25OYW1lIiwiRG9udE5vdGlmeSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7QUFpQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBcEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0lBT1lBLGM7OztXQUFBQSxjO0FBQUFBLEVBQUFBLGM7QUFBQUEsRUFBQUEsYztBQUFBQSxFQUFBQSxjO0FBQUFBLEVBQUFBLGM7R0FBQUEsYyw4QkFBQUEsYzs7QUFPTCxNQUFNQyxZQUFZLEdBQUcsQ0FBQ0QsY0FBYyxDQUFDRSxXQUFoQixFQUE2QkYsY0FBYyxDQUFDRyxlQUE1QyxDQUFyQjs7QUFDQSxNQUFNQyxvQkFBb0IsR0FBRyxDQUFDLEdBQUdILFlBQUosRUFBa0JELGNBQWMsQ0FBQ0ssWUFBakMsQ0FBN0I7OztBQUVBLFNBQVNDLG9CQUFULENBQThCQyxjQUE5QixFQUF1RTtBQUMxRSxTQUFPTixZQUFZLENBQUNPLFFBQWIsQ0FBc0JELGNBQXRCLENBQVA7QUFDSDs7QUFFTSxTQUFTRSxzQkFBVCxDQUFnQ0YsY0FBaEMsRUFBeUU7QUFDNUUsU0FBT0gsb0JBQW9CLENBQUNJLFFBQXJCLENBQThCRCxjQUE5QixDQUFQO0FBQ0g7O0FBRU0sU0FBU0csMEJBQVQsQ0FBb0NDLEtBQXBDLEVBQXdGO0FBQzNGLFNBQU9BLEtBQUssQ0FBQ0MsTUFBTixDQUFrRCxDQUFDQyxNQUFELEVBQVNDLElBQVQsS0FBa0I7QUFDdkUsVUFBTVAsY0FBYyxHQUFHUSxrQkFBa0IsQ0FBQ0QsSUFBSSxDQUFDRSxNQUFOLENBQXpDO0FBQ0EsVUFBTUMsU0FBUyxHQUFHSCxJQUFJLENBQUNJLDBCQUFMLENBQWdDQyw0QkFBc0JDLFNBQXRELElBQW1FLENBQXJGLENBRnVFLENBR3ZFOztBQUNBLFVBQU1DLGlCQUFpQixHQUFHSCwwQkFBMEIsQ0FBQ0osSUFBRCxDQUFwRDtBQUVBLFVBQU1RLFdBQVcsR0FBR0QsaUJBQWlCLEdBQUcsQ0FBcEIsSUFBeUJmLG9CQUFvQixDQUFDQyxjQUFELENBQWpFO0FBQ0EsVUFBTWdCLGFBQWEsR0FBR04sU0FBUyxJQUFJUixzQkFBc0IsQ0FBQ0YsY0FBRCxDQUF6RDtBQUNBLFVBQU1pQixNQUFNLEdBQUdGLFdBQVcsSUFBSUMsYUFBOUI7O0FBRUEsUUFBSUMsTUFBSixFQUFZO0FBQ1JYLE1BQUFBLE1BQU0sQ0FBQ1ksS0FBUCxJQUFnQkosaUJBQWhCOztBQUNBLFVBQUlKLFNBQUosRUFBZTtBQUNYSixRQUFBQSxNQUFNLENBQUNJLFNBQVAsR0FBbUIsSUFBbkI7QUFDSDtBQUNKOztBQUNELFdBQU9KLE1BQVA7QUFDSCxHQWpCTSxFQWlCSjtBQUFFWSxJQUFBQSxLQUFLLEVBQUUsQ0FBVDtBQUFZUixJQUFBQSxTQUFTLEVBQUU7QUFBdkIsR0FqQkksQ0FBUDtBQWtCSDs7QUFFTSxTQUFTUyxlQUFULENBQXlCWixJQUF6QixFQUE4QztBQUNqRCxRQUFNUCxjQUFjLEdBQUdRLGtCQUFrQixDQUFDRCxJQUFJLENBQUNFLE1BQU4sQ0FBekM7QUFDQSxRQUFNQyxTQUFTLEdBQUdILElBQUksQ0FBQ0ksMEJBQUwsQ0FBZ0NDLDRCQUFzQkMsU0FBdEQsSUFBbUUsQ0FBckY7QUFDQSxRQUFNQyxpQkFBaUIsR0FBR1AsSUFBSSxDQUFDSSwwQkFBTCxFQUExQjtBQUVBLFFBQU1JLFdBQVcsR0FBR0QsaUJBQWlCLEdBQUcsQ0FBcEIsSUFBeUJmLG9CQUFvQixDQUFDQyxjQUFELENBQWpFO0FBQ0EsUUFBTWdCLGFBQWEsR0FBR04sU0FBUyxJQUFJUixzQkFBc0IsQ0FBQ0YsY0FBRCxDQUF6RDtBQUVBLFNBQU9lLFdBQVcsSUFBSUMsYUFBdEI7QUFDSDs7QUFFTSxTQUFTUixrQkFBVCxDQUE0QkMsTUFBNUIsRUFBNEQ7QUFDL0QsTUFBSVcsaUNBQWdCQyxHQUFoQixHQUFzQkMsT0FBdEIsRUFBSixFQUFxQyxPQUFPN0IsY0FBYyxDQUFDRSxXQUF0QixDQUQwQixDQUcvRDtBQUNBOztBQUNBLFFBQU00QixRQUFRLEdBQUdDLG9CQUFvQixDQUFDZixNQUFELENBQXJDOztBQUNBLE1BQUljLFFBQUosRUFBYztBQUNWLFdBQU85QixjQUFjLENBQUNnQyxJQUF0QjtBQUNILEdBUjhELENBVS9EOzs7QUFDQSxNQUFJQyxRQUFRLEdBQUcsSUFBZjs7QUFDQSxNQUFJO0FBQ0FBLElBQUFBLFFBQVEsR0FBR04saUNBQWdCQyxHQUFoQixHQUFzQk0sZUFBdEIsQ0FBc0MsUUFBdEMsRUFBZ0RsQixNQUFoRCxDQUFYO0FBQ0gsR0FGRCxDQUVFLE9BQU9tQixHQUFQLEVBQVk7QUFDVjtBQUNBO0FBQ0EsV0FBTyxJQUFQO0FBQ0gsR0FsQjhELENBb0IvRDtBQUNBO0FBQ0E7OztBQUNBLE1BQUksQ0FBQ0YsUUFBRCxJQUFhLENBQUNBLFFBQVEsQ0FBQ0csT0FBM0IsRUFBb0MsT0FBT3BDLGNBQWMsQ0FBQ0UsV0FBdEIsQ0F2QjJCLENBeUIvRDtBQUNBOztBQUNBLE1BQUltQyxVQUFVLENBQUNKLFFBQUQsQ0FBZCxFQUEwQixPQUFPakMsY0FBYyxDQUFDSyxZQUF0Qjs7QUFFMUIsUUFBTWlDLGFBQWEsR0FBR0MsNkJBQWNDLHlCQUFkLENBQXdDUCxRQUFRLENBQUNRLE9BQWpELENBQXRCOztBQUNBLE1BQUlILGFBQWEsQ0FBQ0ksTUFBZCxDQUFxQkMsS0FBekIsRUFBZ0MsT0FBTzNDLGNBQWMsQ0FBQ0csZUFBdEI7QUFFaEMsU0FBTyxJQUFQO0FBQ0g7O0FBRU0sU0FBU3lDLGtCQUFULENBQTRCNUIsTUFBNUIsRUFBNEM2QixRQUE1QyxFQUFxRjtBQUN4RixNQUFJQSxRQUFRLEtBQUs3QyxjQUFjLENBQUNnQyxJQUFoQyxFQUFzQztBQUNsQyxXQUFPYyx1QkFBdUIsQ0FBQzlCLE1BQUQsQ0FBOUI7QUFDSCxHQUZELE1BRU87QUFDSCxXQUFPK0IseUJBQXlCLENBQUMvQixNQUFELEVBQVM2QixRQUFULENBQWhDO0FBQ0g7QUFDSjs7QUFFTSxTQUFTM0IsMEJBQVQsQ0FBb0NKLElBQXBDLEVBQWdEa0MsSUFBMkIsR0FBRyxJQUE5RSxFQUE0RjtBQUMvRixNQUFJM0IsaUJBQWlCLEdBQUdQLElBQUksQ0FBQ0ksMEJBQUwsQ0FBZ0M4QixJQUFoQyxDQUF4QixDQUQrRixDQUcvRjtBQUNBO0FBQ0E7O0FBQ0EsUUFBTUMsV0FBVyxHQUFHbkMsSUFBSSxDQUFDb0MsWUFBTCxDQUFrQkMsY0FBbEIsQ0FBaUMsZUFBakMsRUFBa0QsRUFBbEQsQ0FBcEI7O0FBQ0EsTUFBSUYsV0FBVyxJQUFJQSxXQUFXLENBQUNHLFVBQVosR0FBeUIsYUFBekIsQ0FBbkIsRUFBNEQ7QUFDeEQsVUFBTUMsU0FBUyxHQUFHSixXQUFXLENBQUNHLFVBQVosR0FBeUIsYUFBekIsRUFBd0MsU0FBeEMsQ0FBbEI7O0FBQ0EsVUFBTUUsT0FBTyxHQUFHM0IsaUNBQWdCQyxHQUFoQixHQUFzQjJCLE9BQXRCLENBQThCRixTQUE5QixDQUFoQjs7QUFDQSxRQUFJQyxPQUFKLEVBQWE7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBakMsTUFBQUEsaUJBQWlCLElBQUlpQyxPQUFPLENBQUNwQywwQkFBUixDQUFtQ0MsNEJBQXNCQyxTQUF6RCxDQUFyQjtBQUNIO0FBQ0o7O0FBRUQsU0FBT0MsaUJBQVA7QUFDSDs7QUFFRCxTQUFTeUIsdUJBQVQsQ0FBaUM5QixNQUFqQyxFQUErRDtBQUMzRCxRQUFNd0MsR0FBRyxHQUFHN0IsaUNBQWdCQyxHQUFoQixFQUFaOztBQUNBLFFBQU02QixRQUFRLEdBQUcsRUFBakIsQ0FGMkQsQ0FJM0Q7O0FBQ0EsUUFBTXhCLFFBQVEsR0FBR3VCLEdBQUcsQ0FBQ3RCLGVBQUosQ0FBb0IsUUFBcEIsRUFBOEJsQixNQUE5QixDQUFqQjs7QUFDQSxNQUFJaUIsUUFBSixFQUFjO0FBQ1Z3QixJQUFBQSxRQUFRLENBQUNDLElBQVQsQ0FBY0YsR0FBRyxDQUFDRyxjQUFKLENBQW1CLFFBQW5CLEVBQTZCQyx3QkFBYUMsWUFBMUMsRUFBd0Q1QixRQUFRLENBQUM2QixPQUFqRSxDQUFkO0FBQ0gsR0FSMEQsQ0FVM0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FBQ0FMLEVBQUFBLFFBQVEsQ0FBQ0MsSUFBVCxDQUFjRixHQUFHLENBQUNPLFdBQUosQ0FBZ0IsUUFBaEIsRUFBMEJILHdCQUFhSSxRQUF2QyxFQUFpRGhELE1BQWpELEVBQXlEO0FBQ25FaUQsSUFBQUEsVUFBVSxFQUFFLENBQ1I7QUFDSUMsTUFBQUEsSUFBSSxFQUFFLGFBRFY7QUFFSUMsTUFBQUEsR0FBRyxFQUFFLFNBRlQ7QUFHSUMsTUFBQUEsT0FBTyxFQUFFcEQ7QUFIYixLQURRLENBRHVEO0FBUW5FeUIsSUFBQUEsT0FBTyxFQUFFLENBQ0wsYUFESztBQVIwRCxHQUF6RCxDQUFkO0FBYUEsU0FBTzRCLE9BQU8sQ0FBQ0MsR0FBUixDQUFZYixRQUFaLENBQVA7QUFDSDs7QUFFRCxTQUFTVix5QkFBVCxDQUFtQy9CLE1BQW5DLEVBQW1ENkIsUUFBbkQsRUFBMkY7QUFDdkYsUUFBTVcsR0FBRyxHQUFHN0IsaUNBQWdCQyxHQUFoQixFQUFaOztBQUNBLFFBQU02QixRQUFRLEdBQUcsRUFBakI7QUFFQSxRQUFNYyxnQkFBZ0IsR0FBR3hDLG9CQUFvQixDQUFDZixNQUFELENBQTdDOztBQUNBLE1BQUl1RCxnQkFBSixFQUFzQjtBQUNsQmQsSUFBQUEsUUFBUSxDQUFDQyxJQUFULENBQWNGLEdBQUcsQ0FBQ0csY0FBSixDQUFtQixRQUFuQixFQUE2QkMsd0JBQWFJLFFBQTFDLEVBQW9ETyxnQkFBZ0IsQ0FBQ1QsT0FBckUsQ0FBZDtBQUNIOztBQUVELE1BQUlqQixRQUFRLEtBQUs3QyxjQUFjLENBQUNFLFdBQWhDLEVBQTZDO0FBQ3pDLFVBQU0rQixRQUFRLEdBQUd1QixHQUFHLENBQUN0QixlQUFKLENBQW9CLFFBQXBCLEVBQThCbEIsTUFBOUIsQ0FBakI7O0FBQ0EsUUFBSWlCLFFBQUosRUFBYztBQUNWd0IsTUFBQUEsUUFBUSxDQUFDQyxJQUFULENBQWNGLEdBQUcsQ0FBQ0csY0FBSixDQUFtQixRQUFuQixFQUE2QkMsd0JBQWFDLFlBQTFDLEVBQXdENUIsUUFBUSxDQUFDNkIsT0FBakUsQ0FBZDtBQUNIO0FBQ0osR0FMRCxNQUtPLElBQUlqQixRQUFRLEtBQUs3QyxjQUFjLENBQUNLLFlBQWhDLEVBQThDO0FBQ2pEb0QsSUFBQUEsUUFBUSxDQUFDQyxJQUFULENBQWNGLEdBQUcsQ0FBQ08sV0FBSixDQUFnQixRQUFoQixFQUEwQkgsd0JBQWFDLFlBQXZDLEVBQXFEN0MsTUFBckQsRUFBNkQ7QUFDdkV5QixNQUFBQSxPQUFPLEVBQUUsQ0FDTCxhQURLO0FBRDhELEtBQTdELENBQWQsRUFEaUQsQ0FNakQ7O0FBQ0FnQixJQUFBQSxRQUFRLENBQUNDLElBQVQsQ0FBY0YsR0FBRyxDQUFDZ0Isa0JBQUosQ0FBdUIsUUFBdkIsRUFBaUNaLHdCQUFhQyxZQUE5QyxFQUE0RDdDLE1BQTVELEVBQW9FLElBQXBFLENBQWQ7QUFDSCxHQVJNLE1BUUEsSUFBSTZCLFFBQVEsS0FBSzdDLGNBQWMsQ0FBQ0csZUFBaEMsRUFBaUQ7QUFDcERzRCxJQUFBQSxRQUFRLENBQUNDLElBQVQsQ0FBY0YsR0FBRyxDQUFDTyxXQUFKLENBQWdCLFFBQWhCLEVBQTBCSCx3QkFBYUMsWUFBdkMsRUFBcUQ3QyxNQUFyRCxFQUE2RDtBQUN2RXlCLE1BQUFBLE9BQU8sRUFBRSxDQUNMLFFBREssRUFFTDtBQUNJZ0MsUUFBQUEsU0FBUyxFQUFFLE9BRGY7QUFFSUMsUUFBQUEsS0FBSyxFQUFFO0FBRlgsT0FGSztBQUQ4RCxLQUE3RCxDQUFkLEVBRG9ELENBVXBEOztBQUNBakIsSUFBQUEsUUFBUSxDQUFDQyxJQUFULENBQWNGLEdBQUcsQ0FBQ2dCLGtCQUFKLENBQXVCLFFBQXZCLEVBQWlDWix3QkFBYUMsWUFBOUMsRUFBNEQ3QyxNQUE1RCxFQUFvRSxJQUFwRSxDQUFkO0FBQ0g7O0FBRUQsU0FBT3FELE9BQU8sQ0FBQ0MsR0FBUixDQUFZYixRQUFaLENBQVA7QUFDSDs7QUFFRCxTQUFTMUIsb0JBQVQsQ0FBOEJmLE1BQTlCLEVBQXlEO0FBQUE7O0FBQ3JELFFBQU13QyxHQUFHLEdBQUc3QixpQ0FBZ0JDLEdBQWhCLEVBQVo7O0FBQ0EsTUFBSSxFQUFDNEIsR0FBRCxhQUFDQSxHQUFELGlDQUFDQSxHQUFHLENBQUVtQixTQUFOLG9FQUFDLGVBQWdCQyxNQUFqQixrREFBQyxzQkFBd0JDLFFBQXpCLENBQUosRUFBdUM7QUFDbkMsV0FBTyxJQUFQO0FBQ0g7O0FBQ0QsT0FBSyxNQUFNQyxJQUFYLElBQW1CdEIsR0FBRyxDQUFDbUIsU0FBSixDQUFjQyxNQUFkLENBQXFCQyxRQUF4QyxFQUFrRDtBQUM5QyxRQUFJRSxhQUFhLENBQUMvRCxNQUFELEVBQVM4RCxJQUFULENBQWpCLEVBQWlDO0FBQzdCLFVBQUl6QyxVQUFVLENBQUN5QyxJQUFELENBQVYsSUFBb0JBLElBQUksQ0FBQzFDLE9BQTdCLEVBQXNDO0FBQ2xDLGVBQU8wQyxJQUFQO0FBQ0g7QUFDSjtBQUNKOztBQUNELFNBQU8sSUFBUDtBQUNIOztBQUVELFNBQVNDLGFBQVQsQ0FBdUIvRCxNQUF2QixFQUF1QzhELElBQXZDLEVBQWlFO0FBQzdELE1BQUlBLElBQUksQ0FBQ2IsVUFBTCxDQUFnQmUsTUFBaEIsS0FBMkIsQ0FBL0IsRUFBa0M7QUFDOUIsV0FBTyxLQUFQO0FBQ0g7O0FBQ0QsUUFBTUMsSUFBSSxHQUFHSCxJQUFJLENBQUNiLFVBQUwsQ0FBZ0IsQ0FBaEIsQ0FBYjtBQUNBLFNBQVFnQixJQUFJLENBQUNmLElBQUwsS0FBY2dCLHlCQUFjQyxVQUE1QixJQUEwQ0YsSUFBSSxDQUFDZCxHQUFMLEtBQWEsU0FBdkQsSUFBb0VjLElBQUksQ0FBQ2IsT0FBTCxLQUFpQnBELE1BQTdGO0FBQ0g7O0FBRUQsU0FBU3FCLFVBQVQsQ0FBb0J5QyxJQUFwQixFQUE4QztBQUMxQyxTQUFRQSxJQUFJLENBQUNyQyxPQUFMLENBQWF1QyxNQUFiLEtBQXdCLENBQXhCLElBQTZCRixJQUFJLENBQUNyQyxPQUFMLENBQWEsQ0FBYixNQUFvQjJDLDhCQUFtQkMsVUFBNUU7QUFDSCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNiBPcGVuTWFya2V0IEx0ZFxuQ29weXJpZ2h0IDIwMTkgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tICcuL01hdHJpeENsaWVudFBlZyc7XG5pbXBvcnQgeyBQdXNoUHJvY2Vzc29yIH0gZnJvbSAnbWF0cml4LWpzLXNkay9zcmMvcHVzaHByb2Nlc3Nvcic7XG5pbXBvcnQgeyBOb3RpZmljYXRpb25Db3VudFR5cGUsIFJvb20gfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3Jvb21cIjtcbmltcG9ydCB7IENvbmRpdGlvbktpbmQsIElQdXNoUnVsZSwgUHVzaFJ1bGVBY3Rpb25OYW1lLCBQdXNoUnVsZUtpbmQgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvQHR5cGVzL1B1c2hSdWxlc1wiO1xuXG5leHBvcnQgZW51bSBSb29tTm90aWZTdGF0ZSB7XG4gICAgQWxsTWVzc2FnZXNMb3VkID0gJ2FsbF9tZXNzYWdlc19sb3VkJyxcbiAgICBBbGxNZXNzYWdlcyA9ICdhbGxfbWVzc2FnZXMnLFxuICAgIE1lbnRpb25zT25seSA9ICdtZW50aW9uc19vbmx5JyxcbiAgICBNdXRlID0gJ211dGUnLFxufVxuXG5leHBvcnQgY29uc3QgQkFER0VfU1RBVEVTID0gW1Jvb21Ob3RpZlN0YXRlLkFsbE1lc3NhZ2VzLCBSb29tTm90aWZTdGF0ZS5BbGxNZXNzYWdlc0xvdWRdO1xuZXhwb3J0IGNvbnN0IE1FTlRJT05fQkFER0VfU1RBVEVTID0gWy4uLkJBREdFX1NUQVRFUywgUm9vbU5vdGlmU3RhdGUuTWVudGlvbnNPbmx5XTtcblxuZXhwb3J0IGZ1bmN0aW9uIHNob3VsZFNob3dOb3RpZkJhZGdlKHJvb21Ob3RpZlN0YXRlOiBSb29tTm90aWZTdGF0ZSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBCQURHRV9TVEFURVMuaW5jbHVkZXMocm9vbU5vdGlmU3RhdGUpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2hvdWxkU2hvd01lbnRpb25CYWRnZShyb29tTm90aWZTdGF0ZTogUm9vbU5vdGlmU3RhdGUpOiBib29sZWFuIHtcbiAgICByZXR1cm4gTUVOVElPTl9CQURHRV9TVEFURVMuaW5jbHVkZXMocm9vbU5vdGlmU3RhdGUpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYWdncmVnYXRlTm90aWZpY2F0aW9uQ291bnQocm9vbXM6IFJvb21bXSk6IHtjb3VudDogbnVtYmVyLCBoaWdobGlnaHQ6IGJvb2xlYW59IHtcbiAgICByZXR1cm4gcm9vbXMucmVkdWNlPHtjb3VudDogbnVtYmVyLCBoaWdobGlnaHQ6IGJvb2xlYW59PigocmVzdWx0LCByb29tKSA9PiB7XG4gICAgICAgIGNvbnN0IHJvb21Ob3RpZlN0YXRlID0gZ2V0Um9vbU5vdGlmc1N0YXRlKHJvb20ucm9vbUlkKTtcbiAgICAgICAgY29uc3QgaGlnaGxpZ2h0ID0gcm9vbS5nZXRVbnJlYWROb3RpZmljYXRpb25Db3VudChOb3RpZmljYXRpb25Db3VudFR5cGUuSGlnaGxpZ2h0KSA+IDA7XG4gICAgICAgIC8vIHVzZSBoZWxwZXIgbWV0aG9kIHRvIGluY2x1ZGUgaGlnaGxpZ2h0cyBpbiB0aGUgcHJldmlvdXMgdmVyc2lvbiBvZiB0aGUgcm9vbVxuICAgICAgICBjb25zdCBub3RpZmljYXRpb25Db3VudCA9IGdldFVucmVhZE5vdGlmaWNhdGlvbkNvdW50KHJvb20pO1xuXG4gICAgICAgIGNvbnN0IG5vdGlmQmFkZ2VzID0gbm90aWZpY2F0aW9uQ291bnQgPiAwICYmIHNob3VsZFNob3dOb3RpZkJhZGdlKHJvb21Ob3RpZlN0YXRlKTtcbiAgICAgICAgY29uc3QgbWVudGlvbkJhZGdlcyA9IGhpZ2hsaWdodCAmJiBzaG91bGRTaG93TWVudGlvbkJhZGdlKHJvb21Ob3RpZlN0YXRlKTtcbiAgICAgICAgY29uc3QgYmFkZ2VzID0gbm90aWZCYWRnZXMgfHwgbWVudGlvbkJhZGdlcztcblxuICAgICAgICBpZiAoYmFkZ2VzKSB7XG4gICAgICAgICAgICByZXN1bHQuY291bnQgKz0gbm90aWZpY2F0aW9uQ291bnQ7XG4gICAgICAgICAgICBpZiAoaGlnaGxpZ2h0KSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LmhpZ2hsaWdodCA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9LCB7IGNvdW50OiAwLCBoaWdobGlnaHQ6IGZhbHNlIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Um9vbUhhc0JhZGdlKHJvb206IFJvb20pOiBib29sZWFuIHtcbiAgICBjb25zdCByb29tTm90aWZTdGF0ZSA9IGdldFJvb21Ob3RpZnNTdGF0ZShyb29tLnJvb21JZCk7XG4gICAgY29uc3QgaGlnaGxpZ2h0ID0gcm9vbS5nZXRVbnJlYWROb3RpZmljYXRpb25Db3VudChOb3RpZmljYXRpb25Db3VudFR5cGUuSGlnaGxpZ2h0KSA+IDA7XG4gICAgY29uc3Qgbm90aWZpY2F0aW9uQ291bnQgPSByb29tLmdldFVucmVhZE5vdGlmaWNhdGlvbkNvdW50KCk7XG5cbiAgICBjb25zdCBub3RpZkJhZGdlcyA9IG5vdGlmaWNhdGlvbkNvdW50ID4gMCAmJiBzaG91bGRTaG93Tm90aWZCYWRnZShyb29tTm90aWZTdGF0ZSk7XG4gICAgY29uc3QgbWVudGlvbkJhZGdlcyA9IGhpZ2hsaWdodCAmJiBzaG91bGRTaG93TWVudGlvbkJhZGdlKHJvb21Ob3RpZlN0YXRlKTtcblxuICAgIHJldHVybiBub3RpZkJhZGdlcyB8fCBtZW50aW9uQmFkZ2VzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Um9vbU5vdGlmc1N0YXRlKHJvb21JZDogc3RyaW5nKTogUm9vbU5vdGlmU3RhdGUge1xuICAgIGlmIChNYXRyaXhDbGllbnRQZWcuZ2V0KCkuaXNHdWVzdCgpKSByZXR1cm4gUm9vbU5vdGlmU3RhdGUuQWxsTWVzc2FnZXM7XG5cbiAgICAvLyBsb29rIHRocm91Z2ggdGhlIG92ZXJyaWRlIHJ1bGVzIGZvciBhIHJ1bGUgYWZmZWN0aW5nIHRoaXMgcm9vbTpcbiAgICAvLyBpZiBvbmUgZXhpc3RzLCBpdCB3aWxsIHRha2UgcHJlY2VkZW5jZS5cbiAgICBjb25zdCBtdXRlUnVsZSA9IGZpbmRPdmVycmlkZU11dGVSdWxlKHJvb21JZCk7XG4gICAgaWYgKG11dGVSdWxlKSB7XG4gICAgICAgIHJldHVybiBSb29tTm90aWZTdGF0ZS5NdXRlO1xuICAgIH1cblxuICAgIC8vIGZvciBldmVyeXRoaW5nIGVsc2UsIGxvb2sgYXQgdGhlIHJvb20gcnVsZS5cbiAgICBsZXQgcm9vbVJ1bGUgPSBudWxsO1xuICAgIHRyeSB7XG4gICAgICAgIHJvb21SdWxlID0gTWF0cml4Q2xpZW50UGVnLmdldCgpLmdldFJvb21QdXNoUnVsZSgnZ2xvYmFsJywgcm9vbUlkKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgLy8gUG9zc2libGUgdGhhdCB0aGUgY2xpZW50IGRvZXNuJ3QgaGF2ZSBwdXNoUnVsZXMgeWV0LiBJZiBzbywgaXRcbiAgICAgICAgLy8gaGFzbid0IHN0YXJ0ZWQgZWloZXIsIHNvIGluZGljYXRlIHRoYXQgdGhpcyByb29tIGlzIG5vdCBub3RpZnlpbmcuXG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIC8vIFhYWDogV2UgaGF2ZSB0byBhc3N1bWUgdGhlIGRlZmF1bHQgaXMgdG8gbm90aWZ5IGZvciBhbGwgbWVzc2FnZXNcbiAgICAvLyAoaW4gcGFydGljdWxhciB0aGlzIHdpbGwgYmUgJ3dyb25nJyBmb3Igb25lIHRvIG9uZSByb29tcyBiZWNhdXNlXG4gICAgLy8gdGhleSB3aWxsIG5vdGlmeSBsb3VkbHkgZm9yIGFsbCBtZXNzYWdlcylcbiAgICBpZiAoIXJvb21SdWxlIHx8ICFyb29tUnVsZS5lbmFibGVkKSByZXR1cm4gUm9vbU5vdGlmU3RhdGUuQWxsTWVzc2FnZXM7XG5cbiAgICAvLyBhIG11dGUgYXQgdGhlIHJvb20gbGV2ZWwgd2lsbCBzdGlsbCBhbGxvdyBtZW50aW9uc1xuICAgIC8vIHRvIG5vdGlmeVxuICAgIGlmIChpc011dGVSdWxlKHJvb21SdWxlKSkgcmV0dXJuIFJvb21Ob3RpZlN0YXRlLk1lbnRpb25zT25seTtcblxuICAgIGNvbnN0IGFjdGlvbnNPYmplY3QgPSBQdXNoUHJvY2Vzc29yLmFjdGlvbkxpc3RUb0FjdGlvbnNPYmplY3Qocm9vbVJ1bGUuYWN0aW9ucyk7XG4gICAgaWYgKGFjdGlvbnNPYmplY3QudHdlYWtzLnNvdW5kKSByZXR1cm4gUm9vbU5vdGlmU3RhdGUuQWxsTWVzc2FnZXNMb3VkO1xuXG4gICAgcmV0dXJuIG51bGw7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXRSb29tTm90aWZzU3RhdGUocm9vbUlkOiBzdHJpbmcsIG5ld1N0YXRlOiBSb29tTm90aWZTdGF0ZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmIChuZXdTdGF0ZSA9PT0gUm9vbU5vdGlmU3RhdGUuTXV0ZSkge1xuICAgICAgICByZXR1cm4gc2V0Um9vbU5vdGlmc1N0YXRlTXV0ZWQocm9vbUlkKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gc2V0Um9vbU5vdGlmc1N0YXRlVW5tdXRlZChyb29tSWQsIG5ld1N0YXRlKTtcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRVbnJlYWROb3RpZmljYXRpb25Db3VudChyb29tOiBSb29tLCB0eXBlOiBOb3RpZmljYXRpb25Db3VudFR5cGUgPSBudWxsKTogbnVtYmVyIHtcbiAgICBsZXQgbm90aWZpY2F0aW9uQ291bnQgPSByb29tLmdldFVucmVhZE5vdGlmaWNhdGlvbkNvdW50KHR5cGUpO1xuXG4gICAgLy8gQ2hlY2sgbm90aWZpY2F0aW9uIGNvdW50cyBpbiB0aGUgb2xkIHJvb20ganVzdCBpbiBjYXNlIHRoZXJlJ3Mgc29tZSBsb3N0XG4gICAgLy8gdGhlcmUuIFdlIG9ubHkgZ28gb25lIGxldmVsIGRvd24gdG8gYXZvaWQgcGVyZm9ybWFuY2UgaXNzdWVzLCBhbmQgdGhlb3J5XG4gICAgLy8gaXMgdGhhdCAxc3QgZ2VuZXJhdGlvbiByb29tcyB3aWxsIGhhdmUgYWxyZWFkeSBiZWVuIHJlYWQgYnkgdGhlIDNyZCBnZW5lcmF0aW9uLlxuICAgIGNvbnN0IGNyZWF0ZUV2ZW50ID0gcm9vbS5jdXJyZW50U3RhdGUuZ2V0U3RhdGVFdmVudHMoXCJtLnJvb20uY3JlYXRlXCIsIFwiXCIpO1xuICAgIGlmIChjcmVhdGVFdmVudCAmJiBjcmVhdGVFdmVudC5nZXRDb250ZW50KClbJ3ByZWRlY2Vzc29yJ10pIHtcbiAgICAgICAgY29uc3Qgb2xkUm9vbUlkID0gY3JlYXRlRXZlbnQuZ2V0Q29udGVudCgpWydwcmVkZWNlc3NvciddWydyb29tX2lkJ107XG4gICAgICAgIGNvbnN0IG9sZFJvb20gPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZ2V0Um9vbShvbGRSb29tSWQpO1xuICAgICAgICBpZiAob2xkUm9vbSkge1xuICAgICAgICAgICAgLy8gV2Ugb25seSBldmVyIGNhcmUgaWYgdGhlcmUncyBoaWdobGlnaHRzIGluIHRoZSBvbGQgcm9vbS4gTm8gcG9pbnQgaW5cbiAgICAgICAgICAgIC8vIG5vdGlmeWluZyB0aGUgdXNlciBmb3IgdW5yZWFkIG1lc3NhZ2VzIGJlY2F1c2UgdGhleSB3b3VsZCBoYXZlIGV4dHJlbWVcbiAgICAgICAgICAgIC8vIGRpZmZpY3VsdHkgY2hhbmdpbmcgdGhlaXIgbm90aWZpY2F0aW9uIHByZWZlcmVuY2VzIGF3YXkgZnJvbSBcIkFsbCBNZXNzYWdlc1wiXG4gICAgICAgICAgICAvLyBhbmQgXCJOb2lzeVwiLlxuICAgICAgICAgICAgbm90aWZpY2F0aW9uQ291bnQgKz0gb2xkUm9vbS5nZXRVbnJlYWROb3RpZmljYXRpb25Db3VudChOb3RpZmljYXRpb25Db3VudFR5cGUuSGlnaGxpZ2h0KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBub3RpZmljYXRpb25Db3VudDtcbn1cblxuZnVuY3Rpb24gc2V0Um9vbU5vdGlmc1N0YXRlTXV0ZWQocm9vbUlkOiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xuICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICBjb25zdCBwcm9taXNlcyA9IFtdO1xuXG4gICAgLy8gZGVsZXRlIHRoZSByb29tIHJ1bGVcbiAgICBjb25zdCByb29tUnVsZSA9IGNsaS5nZXRSb29tUHVzaFJ1bGUoJ2dsb2JhbCcsIHJvb21JZCk7XG4gICAgaWYgKHJvb21SdWxlKSB7XG4gICAgICAgIHByb21pc2VzLnB1c2goY2xpLmRlbGV0ZVB1c2hSdWxlKCdnbG9iYWwnLCBQdXNoUnVsZUtpbmQuUm9vbVNwZWNpZmljLCByb29tUnVsZS5ydWxlX2lkKSk7XG4gICAgfVxuXG4gICAgLy8gYWRkL3JlcGxhY2UgYW4gb3ZlcnJpZGUgcnVsZSB0byBzcXVlbGNoIGV2ZXJ5dGhpbmcgaW4gdGhpcyByb29tXG4gICAgLy8gTkIuIFdlIHVzZSB0aGUgcm9vbSBJRCBhcyB0aGUgbmFtZSBvZiB0aGlzIHJ1bGUgdG9vLCBhbHRob3VnaCB0aGlzXG4gICAgLy8gaXMgYW4gb3ZlcnJpZGUgcnVsZSwgbm90IGEgcm9vbSBydWxlOiBpdCBzdGlsbCBwZXJ0YWlucyB0byB0aGlzIHJvb21cbiAgICAvLyB0aG91Z2gsIHNvIHVzaW5nIHRoZSByb29tIElEIGFzIHRoZSBydWxlIElEIGlzIGxvZ2ljYWwgYW5kIHByZXZlbnRzXG4gICAgLy8gZHVwbGljYXRlIGNvcGllcyBvZiB0aGUgcnVsZS5cbiAgICBwcm9taXNlcy5wdXNoKGNsaS5hZGRQdXNoUnVsZSgnZ2xvYmFsJywgUHVzaFJ1bGVLaW5kLk92ZXJyaWRlLCByb29tSWQsIHtcbiAgICAgICAgY29uZGl0aW9uczogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGtpbmQ6ICdldmVudF9tYXRjaCcsXG4gICAgICAgICAgICAgICAga2V5OiAncm9vbV9pZCcsXG4gICAgICAgICAgICAgICAgcGF0dGVybjogcm9vbUlkLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgICAgJ2RvbnRfbm90aWZ5JyxcbiAgICAgICAgXSxcbiAgICB9KSk7XG5cbiAgICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xufVxuXG5mdW5jdGlvbiBzZXRSb29tTm90aWZzU3RhdGVVbm11dGVkKHJvb21JZDogc3RyaW5nLCBuZXdTdGF0ZTogUm9vbU5vdGlmU3RhdGUpOiBQcm9taXNlPGFueT4ge1xuICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICBjb25zdCBwcm9taXNlcyA9IFtdO1xuXG4gICAgY29uc3Qgb3ZlcnJpZGVNdXRlUnVsZSA9IGZpbmRPdmVycmlkZU11dGVSdWxlKHJvb21JZCk7XG4gICAgaWYgKG92ZXJyaWRlTXV0ZVJ1bGUpIHtcbiAgICAgICAgcHJvbWlzZXMucHVzaChjbGkuZGVsZXRlUHVzaFJ1bGUoJ2dsb2JhbCcsIFB1c2hSdWxlS2luZC5PdmVycmlkZSwgb3ZlcnJpZGVNdXRlUnVsZS5ydWxlX2lkKSk7XG4gICAgfVxuXG4gICAgaWYgKG5ld1N0YXRlID09PSBSb29tTm90aWZTdGF0ZS5BbGxNZXNzYWdlcykge1xuICAgICAgICBjb25zdCByb29tUnVsZSA9IGNsaS5nZXRSb29tUHVzaFJ1bGUoJ2dsb2JhbCcsIHJvb21JZCk7XG4gICAgICAgIGlmIChyb29tUnVsZSkge1xuICAgICAgICAgICAgcHJvbWlzZXMucHVzaChjbGkuZGVsZXRlUHVzaFJ1bGUoJ2dsb2JhbCcsIFB1c2hSdWxlS2luZC5Sb29tU3BlY2lmaWMsIHJvb21SdWxlLnJ1bGVfaWQpKTtcbiAgICAgICAgfVxuICAgIH0gZWxzZSBpZiAobmV3U3RhdGUgPT09IFJvb21Ob3RpZlN0YXRlLk1lbnRpb25zT25seSkge1xuICAgICAgICBwcm9taXNlcy5wdXNoKGNsaS5hZGRQdXNoUnVsZSgnZ2xvYmFsJywgUHVzaFJ1bGVLaW5kLlJvb21TcGVjaWZpYywgcm9vbUlkLCB7XG4gICAgICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgICAgICAgJ2RvbnRfbm90aWZ5JyxcbiAgICAgICAgICAgIF0sXG4gICAgICAgIH0pKTtcbiAgICAgICAgLy8gaHR0cHM6Ly9tYXRyaXgub3JnL2ppcmEvYnJvd3NlL1NQRUMtNDAwXG4gICAgICAgIHByb21pc2VzLnB1c2goY2xpLnNldFB1c2hSdWxlRW5hYmxlZCgnZ2xvYmFsJywgUHVzaFJ1bGVLaW5kLlJvb21TcGVjaWZpYywgcm9vbUlkLCB0cnVlKSk7XG4gICAgfSBlbHNlIGlmIChuZXdTdGF0ZSA9PT0gUm9vbU5vdGlmU3RhdGUuQWxsTWVzc2FnZXNMb3VkKSB7XG4gICAgICAgIHByb21pc2VzLnB1c2goY2xpLmFkZFB1c2hSdWxlKCdnbG9iYWwnLCBQdXNoUnVsZUtpbmQuUm9vbVNwZWNpZmljLCByb29tSWQsIHtcbiAgICAgICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICAgICAgICAnbm90aWZ5JyxcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIHNldF90d2VhazogJ3NvdW5kJyxcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICdkZWZhdWx0JyxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXSxcbiAgICAgICAgfSkpO1xuICAgICAgICAvLyBodHRwczovL21hdHJpeC5vcmcvamlyYS9icm93c2UvU1BFQy00MDBcbiAgICAgICAgcHJvbWlzZXMucHVzaChjbGkuc2V0UHVzaFJ1bGVFbmFibGVkKCdnbG9iYWwnLCBQdXNoUnVsZUtpbmQuUm9vbVNwZWNpZmljLCByb29tSWQsIHRydWUpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xufVxuXG5mdW5jdGlvbiBmaW5kT3ZlcnJpZGVNdXRlUnVsZShyb29tSWQ6IHN0cmluZyk6IElQdXNoUnVsZSB7XG4gICAgY29uc3QgY2xpID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuICAgIGlmICghY2xpPy5wdXNoUnVsZXM/Lmdsb2JhbD8ub3ZlcnJpZGUpIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIGZvciAoY29uc3QgcnVsZSBvZiBjbGkucHVzaFJ1bGVzLmdsb2JhbC5vdmVycmlkZSkge1xuICAgICAgICBpZiAoaXNSdWxlRm9yUm9vbShyb29tSWQsIHJ1bGUpKSB7XG4gICAgICAgICAgICBpZiAoaXNNdXRlUnVsZShydWxlKSAmJiBydWxlLmVuYWJsZWQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcnVsZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbn1cblxuZnVuY3Rpb24gaXNSdWxlRm9yUm9vbShyb29tSWQ6IHN0cmluZywgcnVsZTogSVB1c2hSdWxlKTogYm9vbGVhbiB7XG4gICAgaWYgKHJ1bGUuY29uZGl0aW9ucy5sZW5ndGggIT09IDEpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBjb25zdCBjb25kID0gcnVsZS5jb25kaXRpb25zWzBdO1xuICAgIHJldHVybiAoY29uZC5raW5kID09PSBDb25kaXRpb25LaW5kLkV2ZW50TWF0Y2ggJiYgY29uZC5rZXkgPT09ICdyb29tX2lkJyAmJiBjb25kLnBhdHRlcm4gPT09IHJvb21JZCk7XG59XG5cbmZ1bmN0aW9uIGlzTXV0ZVJ1bGUocnVsZTogSVB1c2hSdWxlKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIChydWxlLmFjdGlvbnMubGVuZ3RoID09PSAxICYmIHJ1bGUuYWN0aW9uc1swXSA9PT0gUHVzaFJ1bGVBY3Rpb25OYW1lLkRvbnROb3RpZnkpO1xufVxuIl19