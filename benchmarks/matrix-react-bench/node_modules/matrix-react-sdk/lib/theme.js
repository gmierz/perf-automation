"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.DEFAULT_THEME = void 0;
exports.enumerateThemes = enumerateThemes;
exports.findHighContrastTheme = findHighContrastTheme;
exports.findNonHighContrastTheme = findNonHighContrastTheme;
exports.getCustomTheme = getCustomTheme;
exports.getOrderedThemes = getOrderedThemes;
exports.isHighContrastTheme = isHighContrastTheme;
exports.setTheme = setTheme;

var _languageHandler = require("./languageHandler");

var _SettingsStore = _interopRequireDefault(require("./settings/SettingsStore"));

var _ThemeWatcher = _interopRequireDefault(require("./settings/watchers/ThemeWatcher"));

var _strings = require("./utils/strings");

/*
Copyright 2019 Michael Telatynski <7t3chguy@gmail.com>
Copyright 2019 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const DEFAULT_THEME = "light";
exports.DEFAULT_THEME = DEFAULT_THEME;
const HIGH_CONTRAST_THEMES = {
  "light": "light-high-contrast"
};

/**
 * Given a non-high-contrast theme, find the corresponding high-contrast one
 * if it exists, or return undefined if not.
 */
function findHighContrastTheme(theme) {
  return HIGH_CONTRAST_THEMES[theme];
}
/**
 * Given a high-contrast theme, find the corresponding non-high-contrast one
 * if it exists, or return undefined if not.
 */


function findNonHighContrastTheme(hcTheme) {
  for (const theme in HIGH_CONTRAST_THEMES) {
    if (HIGH_CONTRAST_THEMES[theme] === hcTheme) {
      return theme;
    }
  }
}
/**
 * Decide whether the supplied theme is high contrast.
 */


function isHighContrastTheme(theme) {
  return Object.values(HIGH_CONTRAST_THEMES).includes(theme);
}

function enumerateThemes() {
  const BUILTIN_THEMES = {
    "light": (0, _languageHandler._t)("Light"),
    "light-high-contrast": (0, _languageHandler._t)("Light high contrast"),
    "dark": (0, _languageHandler._t)("Dark")
  };

  const customThemes = _SettingsStore.default.getValue("custom_themes");

  const customThemeNames = {};

  for (const {
    name
  } of customThemes) {
    customThemeNames[`custom-${name}`] = name;
  }

  return Object.assign({}, customThemeNames, BUILTIN_THEMES);
}

function getOrderedThemes() {
  const themes = Object.entries(enumerateThemes()).map(p => ({
    id: p[0],
    name: p[1]
  })) // convert pairs to objects for code readability
  .filter(p => !isHighContrastTheme(p.id));
  const builtInThemes = themes.filter(p => !p.id.startsWith("custom-"));
  const customThemes = themes.filter(p => !builtInThemes.includes(p)).sort((a, b) => (0, _strings.compare)(a.name, b.name));
  return [...builtInThemes, ...customThemes];
}

function clearCustomTheme() {
  // remove all css variables, we assume these are there because of the custom theme
  const inlineStyleProps = Object.values(document.body.style);

  for (const prop of inlineStyleProps) {
    if (prop.startsWith("--")) {
      document.body.style.removeProperty(prop);
    }
  }

  const customFontFaceStyle = document.querySelector("head > style[title='custom-theme-font-faces']");

  if (customFontFaceStyle) {
    customFontFaceStyle.remove();
  }
}

const allowedFontFaceProps = ["font-display", "font-family", "font-stretch", "font-style", "font-weight", "font-variant", "font-feature-settings", "font-variation-settings", "src", "unicode-range"];

function generateCustomFontFaceCSS(faces) {
  return faces.map(face => {
    const src = face.src && face.src.map(srcElement => {
      let format;

      if (srcElement.format) {
        format = `format("${srcElement.format}")`;
      }

      if (srcElement.url) {
        return `url("${srcElement.url}") ${format}`;
      } else if (srcElement.local) {
        return `local("${srcElement.local}") ${format}`;
      }

      return "";
    }).join(", ");
    const props = Object.keys(face).filter(prop => allowedFontFaceProps.includes(prop));
    const body = props.map(prop => {
      let value;

      if (prop === "src") {
        value = src;
      } else if (prop === "font-family") {
        value = `"${face[prop]}"`;
      } else {
        value = face[prop];
      }

      return `${prop}: ${value}`;
    }).join(";");
    return `@font-face {${body}}`;
  }).join("\n");
}

function setCustomThemeVars(customTheme) {
  const {
    style
  } = document.body;

  function setCSSColorVariable(name, hexColor, doPct = true) {
    style.setProperty(`--${name}`, hexColor);

    if (doPct) {
      // uses #rrggbbaa to define the color with alpha values at 0%, 15% and 50%
      style.setProperty(`--${name}-0pct`, hexColor + "00");
      style.setProperty(`--${name}-15pct`, hexColor + "26");
      style.setProperty(`--${name}-50pct`, hexColor + "7F");
    }
  }

  if (customTheme.colors) {
    for (const [name, value] of Object.entries(customTheme.colors)) {
      if (Array.isArray(value)) {
        for (let i = 0; i < value.length; i += 1) {
          setCSSColorVariable(`${name}_${i}`, value[i], false);
        }
      } else {
        setCSSColorVariable(name, value);
      }
    }
  }

  if (customTheme.fonts) {
    const {
      fonts
    } = customTheme;

    if (fonts.faces) {
      const css = generateCustomFontFaceCSS(fonts.faces);
      const style = document.createElement("style");
      style.setAttribute("title", "custom-theme-font-faces");
      style.setAttribute("type", "text/css");
      style.appendChild(document.createTextNode(css));
      document.head.appendChild(style);
    }

    if (fonts.general) {
      style.setProperty("--font-family", fonts.general);
    }

    if (fonts.monospace) {
      style.setProperty("--font-family-monospace", fonts.monospace);
    }
  }
}

function getCustomTheme(themeName) {
  // set css variables
  const customThemes = _SettingsStore.default.getValue("custom_themes");

  if (!customThemes) {
    throw new Error(`No custom themes set, can't set custom theme "${themeName}"`);
  }

  const customTheme = customThemes.find(t => t.name === themeName);

  if (!customTheme) {
    const knownNames = customThemes.map(t => t.name).join(", ");
    throw new Error(`Can't find custom theme "${themeName}", only know ${knownNames}`);
  }

  return customTheme;
}
/**
 * Called whenever someone changes the theme
 * Async function that returns once the theme has been set
 * (ie. the CSS has been loaded)
 *
 * @param {string} theme new theme
 */


async function setTheme(theme) {
  if (!theme) {
    const themeWatcher = new _ThemeWatcher.default();
    theme = themeWatcher.getEffectiveTheme();
  }

  clearCustomTheme();
  let stylesheetName = theme;

  if (theme.startsWith("custom-")) {
    const customTheme = getCustomTheme(theme.substr(7));
    stylesheetName = customTheme.is_dark ? "dark-custom" : "light-custom";
    setCustomThemeVars(customTheme);
  } // look for the stylesheet elements.
  // styleElements is a map from style name to HTMLLinkElement.


  const styleElements = Object.create(null);
  const themes = Array.from(document.querySelectorAll('[data-mx-theme]'));
  themes.forEach(theme => {
    styleElements[theme.attributes['data-mx-theme'].value.toLowerCase()] = theme;
  });

  if (!(stylesheetName in styleElements)) {
    throw new Error("Unknown theme " + stylesheetName);
  } // disable all of them first, then enable the one we want. Chrome only
  // bothers to do an update on a true->false transition, so this ensures
  // that we get exactly one update, at the right time.
  //
  // ^ This comment was true when we used to use alternative stylesheets
  // for the CSS.  Nowadays we just set them all as disabled in index.html
  // and enable them as needed.  It might be cleaner to disable them all
  // at the same time to prevent loading two themes simultaneously and
  // having them interact badly... but this causes a flash of unstyled app
  // which is even uglier.  So we don't.


  styleElements[stylesheetName].disabled = false;
  return new Promise(resolve => {
    const switchTheme = function () {
      // we re-enable our theme here just in case we raced with another
      // theme set request as per https://github.com/vector-im/element-web/issues/5601.
      // We could alternatively lock or similar to stop the race, but
      // this is probably good enough for now.
      styleElements[stylesheetName].disabled = false;
      Object.values(styleElements).forEach(a => {
        if (a == styleElements[stylesheetName]) return;
        a.disabled = true;
      });
      const bodyStyles = global.getComputedStyle(document.body);

      if (bodyStyles.backgroundColor) {
        const metaElement = document.querySelector('meta[name="theme-color"]');
        metaElement.content = bodyStyles.backgroundColor;
      }

      resolve();
    }; // turns out that Firefox preloads the CSS for link elements with
    // the disabled attribute, but Chrome doesn't.


    let cssLoaded = false;

    styleElements[stylesheetName].onload = () => {
      switchTheme();
    };

    for (let i = 0; i < document.styleSheets.length; i++) {
      const ss = document.styleSheets[i];

      if (ss && ss.href === styleElements[stylesheetName].href) {
        cssLoaded = true;
        break;
      }
    }

    if (cssLoaded) {
      styleElements[stylesheetName].onload = undefined;
      switchTheme();
    }
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy90aGVtZS50cyJdLCJuYW1lcyI6WyJERUZBVUxUX1RIRU1FIiwiSElHSF9DT05UUkFTVF9USEVNRVMiLCJmaW5kSGlnaENvbnRyYXN0VGhlbWUiLCJ0aGVtZSIsImZpbmROb25IaWdoQ29udHJhc3RUaGVtZSIsImhjVGhlbWUiLCJpc0hpZ2hDb250cmFzdFRoZW1lIiwiT2JqZWN0IiwidmFsdWVzIiwiaW5jbHVkZXMiLCJlbnVtZXJhdGVUaGVtZXMiLCJCVUlMVElOX1RIRU1FUyIsImN1c3RvbVRoZW1lcyIsIlNldHRpbmdzU3RvcmUiLCJnZXRWYWx1ZSIsImN1c3RvbVRoZW1lTmFtZXMiLCJuYW1lIiwiYXNzaWduIiwiZ2V0T3JkZXJlZFRoZW1lcyIsInRoZW1lcyIsImVudHJpZXMiLCJtYXAiLCJwIiwiaWQiLCJmaWx0ZXIiLCJidWlsdEluVGhlbWVzIiwic3RhcnRzV2l0aCIsInNvcnQiLCJhIiwiYiIsImNsZWFyQ3VzdG9tVGhlbWUiLCJpbmxpbmVTdHlsZVByb3BzIiwiZG9jdW1lbnQiLCJib2R5Iiwic3R5bGUiLCJwcm9wIiwicmVtb3ZlUHJvcGVydHkiLCJjdXN0b21Gb250RmFjZVN0eWxlIiwicXVlcnlTZWxlY3RvciIsInJlbW92ZSIsImFsbG93ZWRGb250RmFjZVByb3BzIiwiZ2VuZXJhdGVDdXN0b21Gb250RmFjZUNTUyIsImZhY2VzIiwiZmFjZSIsInNyYyIsInNyY0VsZW1lbnQiLCJmb3JtYXQiLCJ1cmwiLCJsb2NhbCIsImpvaW4iLCJwcm9wcyIsImtleXMiLCJ2YWx1ZSIsInNldEN1c3RvbVRoZW1lVmFycyIsImN1c3RvbVRoZW1lIiwic2V0Q1NTQ29sb3JWYXJpYWJsZSIsImhleENvbG9yIiwiZG9QY3QiLCJzZXRQcm9wZXJ0eSIsImNvbG9ycyIsIkFycmF5IiwiaXNBcnJheSIsImkiLCJsZW5ndGgiLCJmb250cyIsImNzcyIsImNyZWF0ZUVsZW1lbnQiLCJzZXRBdHRyaWJ1dGUiLCJhcHBlbmRDaGlsZCIsImNyZWF0ZVRleHROb2RlIiwiaGVhZCIsImdlbmVyYWwiLCJtb25vc3BhY2UiLCJnZXRDdXN0b21UaGVtZSIsInRoZW1lTmFtZSIsIkVycm9yIiwiZmluZCIsInQiLCJrbm93bk5hbWVzIiwic2V0VGhlbWUiLCJ0aGVtZVdhdGNoZXIiLCJUaGVtZVdhdGNoZXIiLCJnZXRFZmZlY3RpdmVUaGVtZSIsInN0eWxlc2hlZXROYW1lIiwic3Vic3RyIiwiaXNfZGFyayIsInN0eWxlRWxlbWVudHMiLCJjcmVhdGUiLCJmcm9tIiwicXVlcnlTZWxlY3RvckFsbCIsImZvckVhY2giLCJhdHRyaWJ1dGVzIiwidG9Mb3dlckNhc2UiLCJkaXNhYmxlZCIsIlByb21pc2UiLCJyZXNvbHZlIiwic3dpdGNoVGhlbWUiLCJib2R5U3R5bGVzIiwiZ2xvYmFsIiwiZ2V0Q29tcHV0ZWRTdHlsZSIsImJhY2tncm91bmRDb2xvciIsIm1ldGFFbGVtZW50IiwiY29udGVudCIsImNzc0xvYWRlZCIsIm9ubG9hZCIsInN0eWxlU2hlZXRzIiwic3MiLCJocmVmIiwidW5kZWZpbmVkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7O0FBaUJBOztBQUVBOztBQUNBOztBQUNBOztBQXJCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQVFPLE1BQU1BLGFBQWEsR0FBRyxPQUF0Qjs7QUFDUCxNQUFNQyxvQkFBb0IsR0FBRztBQUN6QixXQUFTO0FBRGdCLENBQTdCOztBQXdCQTtBQUNBO0FBQ0E7QUFDQTtBQUNPLFNBQVNDLHFCQUFULENBQStCQyxLQUEvQixFQUE4QztBQUNqRCxTQUFPRixvQkFBb0IsQ0FBQ0UsS0FBRCxDQUEzQjtBQUNIO0FBRUQ7QUFDQTtBQUNBO0FBQ0E7OztBQUNPLFNBQVNDLHdCQUFULENBQWtDQyxPQUFsQyxFQUFtRDtBQUN0RCxPQUFLLE1BQU1GLEtBQVgsSUFBb0JGLG9CQUFwQixFQUEwQztBQUN0QyxRQUFJQSxvQkFBb0IsQ0FB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QUF1Q0ksU0FBdkM7QUFDQVosTUFBQUEsV0FBVztBQUNkO0FBQ0osR0F4Q00sQ0FBUDtBQXlDSCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxOSBNaWNoYWVsIFRlbGF0eW5za2kgPDd0M2NoZ3V5QGdtYWlsLmNvbT5cbkNvcHlyaWdodCAyMDE5IFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IHsgX3QgfSBmcm9tIFwiLi9sYW5ndWFnZUhhbmRsZXJcIjtcblxuaW1wb3J0IFNldHRpbmdzU3RvcmUgZnJvbSBcIi4vc2V0dGluZ3MvU2V0dGluZ3NTdG9yZVwiO1xuaW1wb3J0IFRoZW1lV2F0Y2hlciBmcm9tIFwiLi9zZXR0aW5ncy93YXRjaGVycy9UaGVtZVdhdGNoZXJcIjtcbmltcG9ydCB7IGNvbXBhcmUgfSBmcm9tIFwiLi91dGlscy9zdHJpbmdzXCI7XG5cbmV4cG9ydCBjb25zdCBERUZBVUxUX1RIRU1FID0gXCJsaWdodFwiO1xuY29uc3QgSElHSF9DT05UUkFTVF9USEVNRVMgPSB7XG4gICAgXCJsaWdodFwiOiBcImxpZ2h0LWhpZ2gtY29udHJhc3RcIixcbn07XG5cbmludGVyZmFjZSBJRm9udEZhY2VzIHtcbiAgICBzcmM6IHtcbiAgICAgICAgZm9ybWF0OiBzdHJpbmc7XG4gICAgICAgIHVybDogc3RyaW5nO1xuICAgICAgICBsb2NhbDogc3RyaW5nO1xuICAgIH1bXTtcbn1cblxuaW50ZXJmYWNlIElDdXN0b21UaGVtZSB7XG4gICAgY29sb3JzOiB7XG4gICAgICAgIFtrZXk6IHN0cmluZ106IHN0cmluZztcbiAgICB9O1xuICAgIGZvbnRzOiB7XG4gICAgICAgIGZhY2VzOiBJRm9udEZhY2VzW107XG4gICAgICAgIGdlbmVyYWw6IHN0cmluZztcbiAgICAgICAgbW9ub3NwYWNlOiBzdHJpbmc7XG4gICAgfTtcbiAgICBpc19kYXJrPzogYm9vbGVhbjsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjYW1lbGNhc2Vcbn1cblxuLyoqXG4gKiBHaXZlbiBhIG5vbi1oaWdoLWNvbnRyYXN0IHRoZW1lLCBmaW5kIHRoZSBjb3JyZXNwb25kaW5nIGhpZ2gtY29udHJhc3Qgb25lXG4gKiBpZiBpdCBleGlzdHMsIG9yIHJldHVybiB1bmRlZmluZWQgaWYgbm90LlxuICovXG5leHBvcnQgZnVuY3Rpb24gZmluZEhpZ2hDb250cmFzdFRoZW1lKHRoZW1lOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gSElHSF9DT05UUkFTVF9USEVNRVNbdGhlbWVdO1xufVxuXG4vKipcbiAqIEdpdmVuIGEgaGlnaC1jb250cmFzdCB0aGVtZSwgZmluZCB0aGUgY29ycmVzcG9uZGluZyBub24taGlnaC1jb250cmFzdCBvbmVcbiAqIGlmIGl0IGV4aXN0cywgb3IgcmV0dXJuIHVuZGVmaW5lZCBpZiBub3QuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBmaW5kTm9uSGlnaENvbnRyYXN0VGhlbWUoaGNUaGVtZTogc3RyaW5nKSB7XG4gICAgZm9yIChjb25zdCB0aGVtZSBpbiBISUdIX0NPTlRSQVNUX1RIRU1FUykge1xuICAgICAgICBpZiAoSElHSF9DT05UUkFTVF9USEVNRVNbdGhlbWVdID09PSBoY1RoZW1lKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhlbWU7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbi8qKlxuICogRGVjaWRlIHdoZXRoZXIgdGhlIHN1cHBsaWVkIHRoZW1lIGlzIGhpZ2ggY29udHJhc3QuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpc0hpZ2hDb250cmFzdFRoZW1lKHRoZW1lOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyhISUdIX0NPTlRSQVNUX1RIRU1FUykuaW5jbHVkZXModGhlbWUpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZW51bWVyYXRlVGhlbWVzKCk6IHtba2V5OiBzdHJpbmddOiBzdHJpbmd9IHtcbiAgICBjb25zdCBCVUlMVElOX1RIRU1FUyA9IHtcbiAgICAgICAgXCJsaWdodFwiOiBfdChcIkxpZ2h0XCIpLFxuICAgICAgICBcImxpZ2h0LWhpZ2gtY29udHJhc3RcIjogX3QoXCJMaWdodCBoaWdoIGNvbnRyYXN0XCIpLFxuICAgICAgICBcImRhcmtcIjogX3QoXCJEYXJrXCIpLFxuICAgIH07XG4gICAgY29uc3QgY3VzdG9tVGhlbWVzID0gU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcImN1c3RvbV90aGVtZXNcIik7XG4gICAgY29uc3QgY3VzdG9tVGhlbWVOYW1lcyA9IHt9O1xuICAgIGZvciAoY29uc3QgeyBuYW1lIH0gb2YgY3VzdG9tVGhlbWVzKSB7XG4gICAgICAgIGN1c3RvbVRoZW1lTmFtZXNbYGN1c3RvbS0ke25hbWV9YF0gPSBuYW1lO1xuICAgIH1cbiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgY3VzdG9tVGhlbWVOYW1lcywgQlVJTFRJTl9USEVNRVMpO1xufVxuXG5pbnRlcmZhY2UgSVRoZW1lIHtcbiAgICBpZDogc3RyaW5nO1xuICAgIG5hbWU6IHN0cmluZztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldE9yZGVyZWRUaGVtZXMoKTogSVRoZW1lW10ge1xuICAgIGNvbnN0IHRoZW1lcyA9IE9iamVjdC5lbnRyaWVzKGVudW1lcmF0ZVRoZW1lcygpKVxuICAgICAgICAubWFwKHAgPT4gKHsgaWQ6IHBbMF0sIG5hbWU6IHBbMV0gfSkpIC8vIGNvbnZlcnQgcGFpcnMgdG8gb2JqZWN0cyBmb3IgY29kZSByZWFkYWJpbGl0eVxuICAgICAgICAuZmlsdGVyKHAgPT4gIWlzSGlnaENvbnRyYXN0VGhlbWUocC5pZCkpO1xuICAgIGNvbnN0IGJ1aWx0SW5UaGVtZXMgPSB0aGVtZXMuZmlsdGVyKHAgPT4gIXAuaWQuc3RhcnRzV2l0aChcImN1c3RvbS1cIikpO1xuICAgIGNvbnN0IGN1c3RvbVRoZW1lcyA9IHRoZW1lcy5maWx0ZXIocCA9PiAhYnVpbHRJblRoZW1lcy5pbmNsdWRlcyhwKSlcbiAgICAgICAgLnNvcnQoKGEsIGIpID0+IGNvbXBhcmUoYS5uYW1lLCBiLm5hbWUpKTtcbiAgICByZXR1cm4gWy4uLmJ1aWx0SW5UaGVtZXMsIC4uLmN1c3RvbVRoZW1lc107XG59XG5cbmZ1bmN0aW9uIGNsZWFyQ3VzdG9tVGhlbWUoKTogdm9pZCB7XG4gICAgLy8gcmVtb3ZlIGFsbCBjc3MgdmFyaWFibGVzLCB3ZSBhc3N1bWUgdGhlc2UgYXJlIHRoZXJlIGJlY2F1c2Ugb2YgdGhlIGN1c3RvbSB0aGVtZVxuICAgIGNvbnN0IGlubGluZVN0eWxlUHJvcHMgPSBPYmplY3QudmFsdWVzKGRvY3VtZW50LmJvZHkuc3R5bGUpO1xuICAgIGZvciAoY29uc3QgcHJvcCBvZiBpbmxpbmVTdHlsZVByb3BzKSB7XG4gICAgICAgIGlmIChwcm9wLnN0YXJ0c1dpdGgoXCItLVwiKSkge1xuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5zdHlsZS5yZW1vdmVQcm9wZXJ0eShwcm9wKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBjb25zdCBjdXN0b21Gb250RmFjZVN0eWxlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcImhlYWQgPiBzdHlsZVt0aXRsZT0nY3VzdG9tLXRoZW1lLWZvbnQtZmFjZXMnXVwiKTtcbiAgICBpZiAoY3VzdG9tRm9udEZhY2VTdHlsZSkge1xuICAgICAgICBjdXN0b21Gb250RmFjZVN0eWxlLnJlbW92ZSgpO1xuICAgIH1cbn1cblxuY29uc3QgYWxsb3dlZEZvbnRGYWNlUHJvcHMgPSBbXG4gICAgXCJmb250LWRpc3BsYXlcIixcbiAgICBcImZvbnQtZmFtaWx5XCIsXG4gICAgXCJmb250LXN0cmV0Y2hcIixcbiAgICBcImZvbnQtc3R5bGVcIixcbiAgICBcImZvbnQtd2VpZ2h0XCIsXG4gICAgXCJmb250LXZhcmlhbnRcIixcbiAgICBcImZvbnQtZmVhdHVyZS1zZXR0aW5nc1wiLFxuICAgIFwiZm9udC12YXJpYXRpb24tc2V0dGluZ3NcIixcbiAgICBcInNyY1wiLFxuICAgIFwidW5pY29kZS1yYW5nZVwiLFxuXTtcblxuZnVuY3Rpb24gZ2VuZXJhdGVDdXN0b21Gb250RmFjZUNTUyhmYWNlczogSUZvbnRGYWNlc1tdKTogc3RyaW5nIHtcbiAgICByZXR1cm4gZmFjZXMubWFwKGZhY2UgPT4ge1xuICAgICAgICBjb25zdCBzcmMgPSBmYWNlLnNyYyAmJiBmYWNlLnNyYy5tYXAoc3JjRWxlbWVudCA9PiB7XG4gICAgICAgICAgICBsZXQgZm9ybWF0O1xuICAgICAgICAgICAgaWYgKHNyY0VsZW1lbnQuZm9ybWF0KSB7XG4gICAgICAgICAgICAgICAgZm9ybWF0ID0gYGZvcm1hdChcIiR7c3JjRWxlbWVudC5mb3JtYXR9XCIpYDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzcmNFbGVtZW50LnVybCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBgdXJsKFwiJHtzcmNFbGVtZW50LnVybH1cIikgJHtmb3JtYXR9YDtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3JjRWxlbWVudC5sb2NhbCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBgbG9jYWwoXCIke3NyY0VsZW1lbnQubG9jYWx9XCIpICR7Zm9ybWF0fWA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gXCJcIjtcbiAgICAgICAgfSkuam9pbihcIiwgXCIpO1xuICAgICAgICBjb25zdCBwcm9wcyA9IE9iamVjdC5rZXlzKGZhY2UpLmZpbHRlcihwcm9wID0+IGFsbG93ZWRGb250RmFjZVByb3BzLmluY2x1ZGVzKHByb3ApKTtcbiAgICAgICAgY29uc3QgYm9keSA9IHByb3BzLm1hcChwcm9wID0+IHtcbiAgICAgICAgICAgIGxldCB2YWx1ZTtcbiAgICAgICAgICAgIGlmIChwcm9wID09PSBcInNyY1wiKSB7XG4gICAgICAgICAgICAgICAgdmFsdWUgPSBzcmM7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHByb3AgPT09IFwiZm9udC1mYW1pbHlcIikge1xuICAgICAgICAgICAgICAgIHZhbHVlID0gYFwiJHtmYWNlW3Byb3BdfVwiYDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFsdWUgPSBmYWNlW3Byb3BdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGAke3Byb3B9OiAke3ZhbHVlfWA7XG4gICAgICAgIH0pLmpvaW4oXCI7XCIpO1xuICAgICAgICByZXR1cm4gYEBmb250LWZhY2UgeyR7Ym9keX19YDtcbiAgICB9KS5qb2luKFwiXFxuXCIpO1xufVxuXG5mdW5jdGlvbiBzZXRDdXN0b21UaGVtZVZhcnMoY3VzdG9tVGhlbWU6IElDdXN0b21UaGVtZSk6IHZvaWQge1xuICAgIGNvbnN0IHsgc3R5bGUgfSA9IGRvY3VtZW50LmJvZHk7XG5cbiAgICBmdW5jdGlvbiBzZXRDU1NDb2xvclZhcmlhYmxlKG5hbWUsIGhleENvbG9yLCBkb1BjdCA9IHRydWUpIHtcbiAgICAgICAgc3R5bGUuc2V0UHJvcGVydHkoYC0tJHtuYW1lfWAsIGhleENvbG9yKTtcbiAgICAgICAgaWYgKGRvUGN0KSB7XG4gICAgICAgICAgICAvLyB1c2VzICNycmdnYmJhYSB0byBkZWZpbmUgdGhlIGNvbG9yIHdpdGggYWxwaGEgdmFsdWVzIGF0IDAlLCAxNSUgYW5kIDUwJVxuICAgICAgICAgICAgc3R5bGUuc2V0UHJvcGVydHkoYC0tJHtuYW1lfS0wcGN0YCwgaGV4Q29sb3IgKyBcIjAwXCIpO1xuICAgICAgICAgICAgc3R5bGUuc2V0UHJvcGVydHkoYC0tJHtuYW1lfS0xNXBjdGAsIGhleENvbG9yICsgXCIyNlwiKTtcbiAgICAgICAgICAgIHN0eWxlLnNldFByb3BlcnR5KGAtLSR7bmFtZX0tNTBwY3RgLCBoZXhDb2xvciArIFwiN0ZcIik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoY3VzdG9tVGhlbWUuY29sb3JzKSB7XG4gICAgICAgIGZvciAoY29uc3QgW25hbWUsIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhjdXN0b21UaGVtZS5jb2xvcnMpKSB7XG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlLmxlbmd0aDsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHNldENTU0NvbG9yVmFyaWFibGUoYCR7bmFtZX1fJHtpfWAsIHZhbHVlW2ldLCBmYWxzZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzZXRDU1NDb2xvclZhcmlhYmxlKG5hbWUsIHZhbHVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoY3VzdG9tVGhlbWUuZm9udHMpIHtcbiAgICAgICAgY29uc3QgeyBmb250cyB9ID0gY3VzdG9tVGhlbWU7XG4gICAgICAgIGlmIChmb250cy5mYWNlcykge1xuICAgICAgICAgICAgY29uc3QgY3NzID0gZ2VuZXJhdGVDdXN0b21Gb250RmFjZUNTUyhmb250cy5mYWNlcyk7XG4gICAgICAgICAgICBjb25zdCBzdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJzdHlsZVwiKTtcbiAgICAgICAgICAgIHN0eWxlLnNldEF0dHJpYnV0ZShcInRpdGxlXCIsIFwiY3VzdG9tLXRoZW1lLWZvbnQtZmFjZXNcIik7XG4gICAgICAgICAgICBzdHlsZS5zZXRBdHRyaWJ1dGUoXCJ0eXBlXCIsIFwidGV4dC9jc3NcIik7XG4gICAgICAgICAgICBzdHlsZS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShjc3MpKTtcbiAgICAgICAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc3R5bGUpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChmb250cy5nZW5lcmFsKSB7XG4gICAgICAgICAgICBzdHlsZS5zZXRQcm9wZXJ0eShcIi0tZm9udC1mYW1pbHlcIiwgZm9udHMuZ2VuZXJhbCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGZvbnRzLm1vbm9zcGFjZSkge1xuICAgICAgICAgICAgc3R5bGUuc2V0UHJvcGVydHkoXCItLWZvbnQtZmFtaWx5LW1vbm9zcGFjZVwiLCBmb250cy5tb25vc3BhY2UpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q3VzdG9tVGhlbWUodGhlbWVOYW1lOiBzdHJpbmcpOiBJQ3VzdG9tVGhlbWUge1xuICAgIC8vIHNldCBjc3MgdmFyaWFibGVzXG4gICAgY29uc3QgY3VzdG9tVGhlbWVzID0gU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcImN1c3RvbV90aGVtZXNcIik7XG4gICAgaWYgKCFjdXN0b21UaGVtZXMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBjdXN0b20gdGhlbWVzIHNldCwgY2FuJ3Qgc2V0IGN1c3RvbSB0aGVtZSBcIiR7dGhlbWVOYW1lfVwiYCk7XG4gICAgfVxuICAgIGNvbnN0IGN1c3RvbVRoZW1lID0gY3VzdG9tVGhlbWVzLmZpbmQodCA9PiB0Lm5hbWUgPT09IHRoZW1lTmFtZSk7XG4gICAgaWYgKCFjdXN0b21UaGVtZSkge1xuICAgICAgICBjb25zdCBrbm93bk5hbWVzID0gY3VzdG9tVGhlbWVzLm1hcCh0ID0+IHQubmFtZSkuam9pbihcIiwgXCIpO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbid0IGZpbmQgY3VzdG9tIHRoZW1lIFwiJHt0aGVtZU5hbWV9XCIsIG9ubHkga25vdyAke2tub3duTmFtZXN9YCk7XG4gICAgfVxuICAgIHJldHVybiBjdXN0b21UaGVtZTtcbn1cblxuLyoqXG4gKiBDYWxsZWQgd2hlbmV2ZXIgc29tZW9uZSBjaGFuZ2VzIHRoZSB0aGVtZVxuICogQXN5bmMgZnVuY3Rpb24gdGhhdCByZXR1cm5zIG9uY2UgdGhlIHRoZW1lIGhhcyBiZWVuIHNldFxuICogKGllLiB0aGUgQ1NTIGhhcyBiZWVuIGxvYWRlZClcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gdGhlbWUgbmV3IHRoZW1lXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzZXRUaGVtZSh0aGVtZT86IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghdGhlbWUpIHtcbiAgICAgICAgY29uc3QgdGhlbWVXYXRjaGVyID0gbmV3IFRoZW1lV2F0Y2hlcigpO1xuICAgICAgICB0aGVtZSA9IHRoZW1lV2F0Y2hlci5nZXRFZmZlY3RpdmVUaGVtZSgpO1xuICAgIH1cbiAgICBjbGVhckN1c3RvbVRoZW1lKCk7XG4gICAgbGV0IHN0eWxlc2hlZXROYW1lID0gdGhlbWU7XG4gICAgaWYgKHRoZW1lLnN0YXJ0c1dpdGgoXCJjdXN0b20tXCIpKSB7XG4gICAgICAgIGNvbnN0IGN1c3RvbVRoZW1lID0gZ2V0Q3VzdG9tVGhlbWUodGhlbWUuc3Vic3RyKDcpKTtcbiAgICAgICAgc3R5bGVzaGVldE5hbWUgPSBjdXN0b21UaGVtZS5pc19kYXJrID8gXCJkYXJrLWN1c3RvbVwiIDogXCJsaWdodC1jdXN0b21cIjtcbiAgICAgICAgc2V0Q3VzdG9tVGhlbWVWYXJzKGN1c3RvbVRoZW1lKTtcbiAgICB9XG5cbiAgICAvLyBsb29rIGZvciB0aGUgc3R5bGVzaGVldCBlbGVtZW50cy5cbiAgICAvLyBzdHlsZUVsZW1lbnRzIGlzIGEgbWFwIGZyb20gc3R5bGUgbmFtZSB0byBIVE1MTGlua0VsZW1lbnQuXG4gICAgY29uc3Qgc3R5bGVFbGVtZW50cyA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG4gICAgY29uc3QgdGhlbWVzID0gQXJyYXkuZnJvbShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1teC10aGVtZV0nKSk7XG4gICAgdGhlbWVzLmZvckVhY2godGhlbWUgPT4ge1xuICAgICAgICBzdHlsZUVsZW1lbnRzW3RoZW1lLmF0dHJpYnV0ZXNbJ2RhdGEtbXgtdGhlbWUnXS52YWx1ZS50b0xvd2VyQ2FzZSgpXSA9IHRoZW1lO1xuICAgIH0pO1xuXG4gICAgaWYgKCEoc3R5bGVzaGVldE5hbWUgaW4gc3R5bGVFbGVtZW50cykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVW5rbm93biB0aGVtZSBcIiArIHN0eWxlc2hlZXROYW1lKTtcbiAgICB9XG5cbiAgICAvLyBkaXNhYmxlIGFsbCBvZiB0aGVtIGZpcnN0LCB0aGVuIGVuYWJsZSB0aGUgb25lIHdlIHdhbnQuIENocm9tZSBvbmx5XG4gICAgLy8gYm90aGVycyB0byBkbyBhbiB1cGRhdGUgb24gYSB0cnVlLT5mYWxzZSB0cmFuc2l0aW9uLCBzbyB0aGlzIGVuc3VyZXNcbiAgICAvLyB0aGF0IHdlIGdldCBleGFjdGx5IG9uZSB1cGRhdGUsIGF0IHRoZSByaWdodCB0aW1lLlxuICAgIC8vXG4gICAgLy8gXiBUaGlzIGNvbW1lbnQgd2FzIHRydWUgd2hlbiB3ZSB1c2VkIHRvIHVzZSBhbHRlcm5hdGl2ZSBzdHlsZXNoZWV0c1xuICAgIC8vIGZvciB0aGUgQ1NTLiAgTm93YWRheXMgd2UganVzdCBzZXQgdGhlbSBhbGwgYXMgZGlzYWJsZWQgaW4gaW5kZXguaHRtbFxuICAgIC8vIGFuZCBlbmFibGUgdGhlbSBhcyBuZWVkZWQuICBJdCBtaWdodCBiZSBjbGVhbmVyIHRvIGRpc2FibGUgdGhlbSBhbGxcbiAgICAvLyBhdCB0aGUgc2FtZSB0aW1lIHRvIHByZXZlbnQgbG9hZGluZyB0d28gdGhlbWVzIHNpbXVsdGFuZW91c2x5IGFuZFxuICAgIC8vIGhhdmluZyB0aGVtIGludGVyYWN0IGJhZGx5Li4uIGJ1dCB0aGlzIGNhdXNlcyBhIGZsYXNoIG9mIHVuc3R5bGVkIGFwcFxuICAgIC8vIHdoaWNoIGlzIGV2ZW4gdWdsaWVyLiAgU28gd2UgZG9uJ3QuXG5cbiAgICBzdHlsZUVsZW1lbnRzW3N0eWxlc2hlZXROYW1lXS5kaXNhYmxlZCA9IGZhbHNlO1xuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICAgIGNvbnN0IHN3aXRjaFRoZW1lID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAvLyB3ZSByZS1lbmFibGUgb3VyIHRoZW1lIGhlcmUganVzdCBpbiBjYXNlIHdlIHJhY2VkIHdpdGggYW5vdGhlclxuICAgICAgICAgICAgLy8gdGhlbWUgc2V0IHJlcXVlc3QgYXMgcGVyIGh0dHBzOi8vZ2l0aHViLmNvbS92ZWN0b3ItaW0vZWxlbWVudC13ZWIvaXNzdWVzLzU2MDEuXG4gICAgICAgICAgICAvLyBXZSBjb3VsZCBhbHRlcm5hdGl2ZWx5IGxvY2sgb3Igc2ltaWxhciB0byBzdG9wIHRoZSByYWNlLCBidXRcbiAgICAgICAgICAgIC8vIHRoaXMgaXMgcHJvYmFibHkgZ29vZCBlbm91Z2ggZm9yIG5vdy5cbiAgICAgICAgICAgIHN0eWxlRWxlbWVudHNbc3R5bGVzaGVldE5hbWVdLmRpc2FibGVkID0gZmFsc2U7XG4gICAgICAgICAgICBPYmplY3QudmFsdWVzKHN0eWxlRWxlbWVudHMpLmZvckVhY2goKGE6IEhUTUxTdHlsZUVsZW1lbnQpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoYSA9PSBzdHlsZUVsZW1lbnRzW3N0eWxlc2hlZXROYW1lXSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGEuZGlzYWJsZWQgPSB0cnVlO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBjb25zdCBib2R5U3R5bGVzID0gZ2xvYmFsLmdldENvbXB1dGVkU3R5bGUoZG9jdW1lbnQuYm9keSk7XG4gICAgICAgICAgICBpZiAoYm9keVN0eWxlcy5iYWNrZ3JvdW5kQ29sb3IpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBtZXRhRWxlbWVudDogSFRNTE1ldGFFbGVtZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignbWV0YVtuYW1lPVwidGhlbWUtY29sb3JcIl0nKTtcbiAgICAgICAgICAgICAgICBtZXRhRWxlbWVudC5jb250ZW50ID0gYm9keVN0eWxlcy5iYWNrZ3JvdW5kQ29sb3I7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gdHVybnMgb3V0IHRoYXQgRmlyZWZveCBwcmVsb2FkcyB0aGUgQ1NTIGZvciBsaW5rIGVsZW1lbnRzIHdpdGhcbiAgICAgICAgLy8gdGhlIGRpc2FibGVkIGF0dHJpYnV0ZSwgYnV0IENocm9tZSBkb2Vzbid0LlxuXG4gICAgICAgIGxldCBjc3NMb2FkZWQgPSBmYWxzZTtcblxuICAgICAgICBzdHlsZUVsZW1lbnRzW3N0eWxlc2hlZXROYW1lXS5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgICAgICBzd2l0Y2hUaGVtZSgpO1xuICAgICAgICB9O1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZG9jdW1lbnQuc3R5bGVTaGVldHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IHNzID0gZG9jdW1lbnQuc3R5bGVTaGVldHNbaV07XG4gICAgICAgICAgICBpZiAoc3MgJiYgc3MuaHJlZiA9PT0gc3R5bGVFbGVtZW50c1tzdHlsZXNoZWV0TmFtZV0uaHJlZikge1xuICAgICAgICAgICAgICAgIGNzc0xvYWRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY3NzTG9hZGVkKSB7XG4gICAgICAgICAgICBzdHlsZUVsZW1lbnRzW3N0eWxlc2hlZXROYW1lXS5vbmxvYWQgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICBzd2l0Y2hUaGVtZSgpO1xuICAgICAgICB9XG4gICAgfSk7XG59XG4iXX0=