"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.PosthogAnalytics = exports.Anonymity = void 0;
exports.getRedactedCurrentLocation = getRedactedCurrentLocation;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _posthogJs = _interopRequireDefault(require("posthog-js"));

var _PlatformPeg = _interopRequireDefault(require("./PlatformPeg"));

var _SdkConfig = _interopRequireDefault(require("./SdkConfig"));

var _SettingsStore = _interopRequireDefault(require("./settings/SettingsStore"));

var _MatrixClientPeg = require("./MatrixClientPeg");

var _logger = require("matrix-js-sdk/src/logger");

/*
Copyright 2021 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
let Anonymity; // If an event extends IPseudonymousEvent, the event contains pseudonymous data
// that won't be sent unless the user has explicitly consented to pseudonymous tracking.
// For example, it might contain hashed user IDs or room IDs.
// Such events will be automatically dropped if PosthogAnalytics.anonymity isn't set to Pseudonymous.

exports.Anonymity = Anonymity;

(function (Anonymity) {
  Anonymity[Anonymity["Disabled"] = 0] = "Disabled";
  Anonymity[Anonymity["Anonymous"] = 1] = "Anonymous";
  Anonymity[Anonymity["Pseudonymous"] = 2] = "Pseudonymous";
})(Anonymity || (exports.Anonymity = Anonymity = {}));

const whitelistedScreens = new Set(["register", "login", "forgot_password", "soft_logout", "new", "settings", "welcome", "home", "start", "directory", "start_sso", "start_cas", "groups", "complete_security", "post_registration", "room", "user", "group"]);

async function getRedactedCurrentLocation(origin, hash, pathname, anonymity) {
  // Redact PII from the current location.
  // For known screens, assumes a URL structure of /<screen name>/might/be/pii
  if (origin.startsWith('file://')) {
    pathname = "/<redacted_file_scheme_url>/";
  }

  let hashStr;

  if (hash == "") {
    hashStr = "";
  } else {
    let [beforeFirstSlash, screen] = hash.split("/");

    if (!whitelistedScreens.has(screen)) {
      screen = "<redacted_screen_name>";
    }

    hashStr = `${beforeFirstSlash}/${screen}/<redacted>`;
  }

  return origin + pathname + hashStr;
}

class PosthogAnalytics {
  /* Wrapper for Posthog analytics.
   * 3 modes of anonymity are supported, governed by this.anonymity
   * - Anonymity.Disabled means *no data* is passed to posthog
   * - Anonymity.Anonymous means no identifier is passed to posthog
   * - Anonymity.Pseudonymous means an analytics ID stored in account_data and shared between devices
   *   is passed to posthog.
   *
   * To update anonymity, call updateAnonymityFromSettings() or you can set it directly via setAnonymity().
   *
   * To pass an event to Posthog:
   *
   * 1. Declare a type for the event, extending IAnonymousEvent or IPseudonymousEvent.
   * 2. Call the appropriate track*() method. Pseudonymous events will be dropped when anonymity is
   *    Anonymous or Disabled; Anonymous events will be dropped when anonymity is Disabled.
   */
  // set true during the constructor if posthog config is present, otherwise false
  static get instance() {
    if (!this._instance) {
      this._instance = new PosthogAnalytics(_posthogJs.default);
    }

    return this._instance;
  }

  constructor(posthog) {
    this.posthog = posthog;
    (0, _defineProperty2.default)(this, "anonymity", Anonymity.Disabled);
    (0, _defineProperty2.default)(this, "enabled", false);
    (0, _defineProperty2.default)(this, "platformSuperProperties", {});
    (0, _defineProperty2.default)(this, "sanitizeProperties", properties => {
      // Callback from posthog to sanitize properties before sending them to the server.
      //
      // Here we sanitize posthog's built in properties which leak PII e.g. url reporting.
      // See utils.js _.info.properties in posthog-js.
      // Replace the $current_url with a redacted version.
      // $redacted_current_url is injected by this class earlier in capture(), as its generation
      // is async and can't be done in this non-async callback.
      if (!properties['$redacted_current_url']) {
        _logger.logger.log("$redacted_current_url not set in sanitizeProperties, will drop $current_url entirely");
      }

      properties['$current_url'] = properties['$redacted_current_url'];
      delete properties['$redacted_current_url'];

      if (this.anonymity == Anonymity.Anonymous) {
        // drop referrer information for anonymous users
        properties['$referrer'] = null;
        properties['$referring_domain'] = null;
        properties['$initial_referrer'] = null;
        properties['$initial_referring_domain'] = null; // drop device ID, which is a UUID persisted in local storage

        properties['$device_id'] = null;
      }

      return properties;
    });

    const posthogConfig = _SdkConfig.default.get()["posthog"];

    if (posthogConfig) {
      this.posthog.init(posthogConfig.projectApiKey, {
        api_host: posthogConfig.apiHost,
        autocapture: false,
        mask_all_text: true,
        mask_all_element_attributes: true,
        // This only triggers on page load, which for our SPA isn't particularly useful.
        // Plus, the .capture call originating from somewhere in posthog makes it hard
        // to redact URLs, which requires async code.
        //
        // To raise this manually, just call .capture("$pageview") or posthog.capture_pageview.
        capture_pageview: false,
        sanitize_properties: this.sanitizeProperties,
        respect_dnt: true,
        advanced_disable_decide: true
      });
      this.enabled = true;
    } else {
      this.enabled = false;
    }
  }

  static getAnonymityFromSettings() {
    // determine the current anonymity level based on current user settings
    // "Send anonymous usage data which helps us improve Element. This will use a cookie."
    const analyticsOptIn = _SettingsStore.default.getValue("analyticsOptIn", null, true); // (proposed wording) "Send pseudonymous usage data which helps us improve Element. This will use a cookie."
    //
    // TODO: Currently, this is only a labs flag, for testing purposes.


    const pseudonumousOptIn = _SettingsStore.default.getValue("feature_pseudonymous_analytics_opt_in", null, true);

    let anonymity;

    if (pseudonumousOptIn) {
      anonymity = Anonymity.Pseudonymous;
    } else if (analyticsOptIn) {
      anonymity = Anonymity.Anonymous;
    } else {
      anonymity = Anonymity.Disabled;
    }

    return anonymity;
  }

  registerSuperProperties(properties) {
    if (this.enabled) {
      this.posthog.register(properties);
    }
  }

  static async getPlatformProperties() {
    const platform = _PlatformPeg.default.get();

    let appVersion;

    try {
      appVersion = await platform.getAppVersion();
    } catch (e) {
      // this happens if no version is set i.e. in dev
      appVersion = "unknown";
    }

    return {
      appVersion,
      appPlatform: platform.getHumanReadableName()
    };
  }

  async capture(eventName, properties) {
    if (!this.enabled) {
      return;
    }

    const {
      origin,
      hash,
      pathname
    } = window.location;
    properties['$redacted_current_url'] = await getRedactedCurrentLocation(origin, hash, pathname, this.anonymity);
    this.posthog.capture(eventName, properties);
  }

  isEnabled() {
    return this.enabled;
  }

  setAnonymity(anonymity) {
    // Update this.anonymity.
    // This is public for testing purposes, typically you want to call updateAnonymityFromSettings
    // to ensure this value is in step with the user's settings.
    if (this.enabled && (anonymity == Anonymity.Disabled || anonymity == Anonymity.Anonymous)) {
      // when transitioning to Disabled or Anonymous ensure we clear out any prior state
      // set in posthog e.g. distinct ID
      this.posthog.reset(); // Restore any previously set platform super properties

      this.registerSuperProperties(this.platformSuperProperties);
    }

    this.anonymity = anonymity;
  }

  static getRandomAnalyticsId() {
    return [...crypto.getRandomValues(new Uint8Array(16))].map(c => c.toString(16)).join('');
  }

  async identifyUser(client, analyticsIdGenerator) {
    if (this.anonymity == Anonymity.Pseudonymous) {
      // Check the user's account_data for an analytics ID to use. Storing the ID in account_data allows
      // different devices to send the same ID.
      try {
        const accountData = await client.getAccountDataFromServer(PosthogAnalytics.ANALYTICS_ID_EVENT_TYPE);
        let analyticsID = accountData === null || accountData === void 0 ? void 0 : accountData.id;

        if (!analyticsID) {
          // Couldn't retrieve an analytics ID from user settings, so create one and set it on the server.
          // Note there's a race condition here - if two devices do these steps at the same time, last write
          // wins, and the first writer will send tracking with an ID that doesn't match the one on the server
          // until the next time account data is refreshed and this function is called (most likely on next
          // page load). This will happen pretty infrequently, so we can tolerate the possibility.
          analyticsID = analyticsIdGenerator();
          await client.setAccountData("im.vector.web.analytics_id", {
            id: analyticsID
          });
        }

        this.posthog.identify(analyticsID);
      } catch (e) {
        // The above could fail due to network requests, but not essential to starting the application,
        // so swallow it.
        _logger.logger.log("Unable to identify user for tracking" + e.toString());
      }
    }
  }

  getAnonymity() {
    return this.anonymity;
  }

  logout() {
    if (this.enabled) {
      this.posthog.reset();
    }

    this.setAnonymity(Anonymity.Anonymous);
  }

  async trackPseudonymousEvent(eventName, properties = {}) {
    if (this.anonymity == Anonymity.Anonymous || this.anonymity == Anonymity.Disabled) return;
    await this.capture(eventName, properties);
  }

  async trackAnonymousEvent(eventName, properties = {}) {
    if (this.anonymity == Anonymity.Disabled) return;
    await this.capture(eventName, properties);
  }

  async trackPageView(durationMs) {
    const hash = window.location.hash;
    let screen = null;
    const split = hash.split("/");

    if (split.length >= 2) {
      screen = split[1];
    }

    await this.trackAnonymousEvent("$pageview", {
      durationMs,
      screen
    });
  }

  async updatePlatformSuperProperties() {
    // Update super properties in posthog with our platform (app version, platform).
    // These properties will be subsequently passed in every event.
    //
    // This only needs to be done once per page lifetime. Note that getPlatformProperties
    // is async and can involve a network request if we are running in a browser.
    this.platformSuperProperties = await PosthogAnalytics.getPlatformProperties();
    this.registerSuperProperties(this.platformSuperProperties);
  }

  async updateAnonymityFromSettings(userId) {
    // Update this.anonymity based on the user's analytics opt-in settings
    // Identify the user (via hashed user ID) to posthog if anonymity is pseudonmyous
    this.setAnonymity(PosthogAnalytics.getAnonymityFromSettings());

    if (userId && this.getAnonymity() == Anonymity.Pseudonymous) {
      await this.identifyUser(_MatrixClientPeg.MatrixClientPeg.get(), PosthogAnalytics.getRandomAnalyticsId);
    }
  }

}

exports.PosthogAnalytics = PosthogAnalytics;
(0, _defineProperty2.default)(PosthogAnalytics, "_instance", null);
(0, _defineProperty2.default)(PosthogAnalytics, "ANALYTICS_ID_EVENT_TYPE", "im.vector.web.analytics_id");
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Qb3N0aG9nQW5hbHl0aWNzLnRzIl0sIm5hbWVzIjpbIkFub255bWl0eSIsIndoaXRlbGlzdGVkU2NyZWVucyIsIlNldCIsImdldFJlZGFjdGVkQ3VycmVudExvY2F0aW9uIiwib3JpZ2luIiwiaGFzaCIsInBhdGhuYW1lIiwiYW5vbnltaXR5Iiwic3RhcnRzV2l0aCIsImhhc2hTdHIiLCJiZWZvcmVGaXJzdFNsYXNoIiwic2NyZWVuIiwic3BsaXQiLCJoYXMiLCJQb3N0aG9nQW5hbHl0aWNzIiwiaW5zdGFuY2UiLCJfaW5zdGFuY2UiLCJwb3N0aG9nIiwiY29uc3RydWN0b3IiLCJEaXNhYmxlZCIsInByb3BlcnRpZXMiLCJsb2dnZXIiLCJsb2ciLCJBbm9ueW1vdXMiLCJwb3N0aG9nQ29uZmlnIiwiU2RrQ29uZmlnIiwiZ2V0IiwiaW5pdCIsInByb2plY3RBcGlLZXkiLCJhcGlfaG9zdCIsImFwaUhvc3QiLCJhdXRvY2FwdHVyZSIsIm1hc2tfYWxsX3RleHQiLCJtYXNrX2FsbF9lbGVtZW50X2F0dHJpYnV0ZXMiLCJjYXB0dXJlX3BhZ2V2aWV3Iiwic2FuaXRpemVfcHJvcGVydGllcyIsInNhbml0aXplUHJvcGVydGllcyIsInJlc3BlY3RfZG50IiwiYWR2YW5jZWRfZGlzYWJsZV9kZWNpZGUiLCJlbmFibGVkIiwiZ2V0QW5vbnltaXR5RnJvbVNldHRpbmdzIiwiYW5hbHl0aWNzT3B0SW4iLCJTZXR0aW5nc1N0b3JlIiwiZ2V0VmFsdWUiLCJwc2V1ZG9udW1vdXNPcHRJbiIsIlBzZXVkb255bW91cyIsInJlZ2lzdGVyU3VwZXJQcm9wZXJ0aWVzIiwicmVnaXN0ZXIiLCJnZXRQbGF0Zm9ybVByb3BlcnRpZXMiLCJwbGF0Zm9ybSIsIlBsYXRmb3JtUGVnIiwiYXBwVmVyc2lvbiIsImdldEFwcFZlcnNpb24iLCJlIiwiYXBwUGxhdGZvcm0iLCJnZXRIdW1hblJlYWRhYmxlTmFtZSIsImNhcHR1cmUiLCJldmVudE5hbWUiLCJ3aW5kb3ciLCJsb2NhdGlvbiIsImlzRW5hYmxlZCIsInNldEFub255bWl0eSIsInJlc2V0IiwicGxhdGZvcm1TdXBlclByb3BlcnRpZXMiLCJnZXRSYW5kb21BbmFseXRpY3NJZCIsImNyeXB0byIsImdldFJhbmRvbVZhbHVlcyIsIlVpbnQ4QXJyYXkiLCJtYXAiLCJjIiwidG9TdHJpbmciLCJqb2luIiwiaWRlbnRpZnlVc2VyIiwiY2xpZW50IiwiYW5hbHl0aWNzSWRHZW5lcmF0b3IiLCJhY2NvdW50RGF0YSIsImdldEFjY291bnREYXRhRnJvbVNlcnZlciIsIkFOQUxZVElDU19JRF9FVkVOVF9UWVBFIiwiYW5hbHl0aWNzSUQiLCJpZCIsInNldEFjY291bnREYXRhIiwiaWRlbnRpZnkiLCJnZXRBbm9ueW1pdHkiLCJsb2dvdXQiLCJ0cmFja1BzZXVkb255bW91c0V2ZW50IiwidHJhY2tBbm9ueW1vdXNFdmVudCIsInRyYWNrUGFnZVZpZXciLCJkdXJhdGlvbk1zIiwibGVuZ3RoIiwidXBkYXRlUGxhdGZvcm1TdXBlclByb3BlcnRpZXMiLCJ1cGRhdGVBbm9ueW1pdHlGcm9tU2V0dGluZ3MiLCJ1c2VySWQiLCJNYXRyaXhDbGllbnRQZWciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQWdCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQTs7QUF2QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0lBb0NZQSxTLEVBTVo7QUFDQTtBQUNBO0FBQ0E7Ozs7V0FUWUEsUztBQUFBQSxFQUFBQSxTLENBQUFBLFM7QUFBQUEsRUFBQUEsUyxDQUFBQSxTO0FBQUFBLEVBQUFBLFMsQ0FBQUEsUztHQUFBQSxTLHlCQUFBQSxTOztBQTRCWixNQUFNQyxrQkFBa0IsR0FBRyxJQUFJQyxHQUFKLENBQVEsQ0FDL0IsVUFEK0IsRUFDbkIsT0FEbUIsRUFDVixpQkFEVSxFQUNTLGFBRFQsRUFDd0IsS0FEeEIsRUFDK0IsVUFEL0IsRUFDMkMsU0FEM0Ms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QUFBLFVBRG1EO0FBRW5ENUUsTUFBQUE7QUFGbUQsS0FBakQsQ0FBTjtBQUlIOztBQUV5QyxRQUE3QjhFLDZCQUE2QixHQUFrQjtBQUN4RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBSzFCLHVCQUFMLEdBQStCLE1BQU1qRCxnQkFBZ0IsQ0FBQ2tDLHFCQUFqQixFQUFyQztBQUNBLFNBQUtGLHVCQUFMLENBQTZCLEtBQUtpQix1QkFBbEM7QUFDSDs7QUFFdUMsUUFBM0IyQiwyQkFBMkIsQ0FBQ0MsTUFBRCxFQUFpQztBQUNyRTtBQUNBO0FBQ0EsU0FBSzlCLFlBQUwsQ0FBa0IvQyxnQkFBZ0IsQ0FBQzBCLHdCQUFqQixFQUFsQjs7QUFDQSxRQUFJbUQsTUFBTSxJQUFJLEtBQUtULFlBQUwsTUFBdUJsRixTQUFTLENBQUM2QyxZQUEvQyxFQUE2RDtBQUN6RCxZQUFNLEtBQUsyQixZQUFMLENBQWtCb0IsaUNBQWdCbEUsR0FBaEIsRUFBbEIsRUFBeUNaLGdCQUFnQixDQUFDa0Qsb0JBQTFELENBQU47QUFDSDtBQUNKOztBQXJQeUI7Ozs4QkFBakJsRCxnQixlQW9Ca0IsSTs4QkFwQmxCQSxnQiw2QkFzQmdDLDRCIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDIxIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IHBvc3Rob2csIHsgUG9zdEhvZyB9IGZyb20gJ3Bvc3Rob2ctanMnO1xuaW1wb3J0IFBsYXRmb3JtUGVnIGZyb20gJy4vUGxhdGZvcm1QZWcnO1xuaW1wb3J0IFNka0NvbmZpZyBmcm9tICcuL1Nka0NvbmZpZyc7XG5pbXBvcnQgU2V0dGluZ3NTdG9yZSBmcm9tICcuL3NldHRpbmdzL1NldHRpbmdzU3RvcmUnO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSBcIi4vTWF0cml4Q2xpZW50UGVnXCI7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnQgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvY2xpZW50XCI7XG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcblxuLyogUG9zdGhvZyBhbmFseXRpY3MgdHJhY2tpbmcuXG4gKlxuICogQW5vbnltaXR5IGJlaGF2aW91ciBpcyBhcyBmb2xsb3dzOlxuICpcbiAqIC0gSWYgUG9zdGhvZyBpc24ndCBjb25maWd1cmVkIGluIGBjb25maWcuanNvbmAsIGV2ZW50cyBhcmUgbm90IHNlbnQuXG4gKiAtIElmIFtEbyBOb3QgVHJhY2tdKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9OYXZpZ2F0b3IvZG9Ob3RUcmFjaykgaXNcbiAqICAgZW5hYmxlZCwgZXZlbnRzIGFyZSBub3Qgc2VudCAodGhpcyBkZXRlY3Rpb24gaXMgYnVpbHQgaW50byBwb3N0aG9nIGFuZCB0dXJuZWQgb24gdmlhIHRoZVxuICogICBgcmVzcGVjdF9kbnRgIGZsYWcgYmVpbmcgcGFzc2VkIHRvIGBwb3N0aG9nLmluaXRgKS5cbiAqIC0gSWYgdGhlIGBmZWF0dXJlX3BzZXVkb255bW91c19hbmFseXRpY3Nfb3B0X2luYCBsYWJzIGZsYWcgaXMgYHRydWVgLCB0cmFjayBwc2V1ZG9ub21vdXNseSBieSBtYWludGFpbmluZ1xuICogICBhIHJhbmRvbWlzZWQgYW5hbHl0aWNzIElEIGluIGFjY291bnRfZGF0YSBmb3IgdGhhdCB1c2VyIChzaGFyZWQgYmV0d2VlbiBkZXZpY2VzKSBhbmQgc2VuZGluZyBpdCB0byBwb3N0aG9nIHRvXG4gICAgIGlkZW50aWZ5IHRoZSB1c2VyLlxuICogLSBPdGhlcndpc2UsIGlmIHRoZSBleGlzdGluZyBgYW5hbHl0aWNzT3B0SW5gIGZsYWcgaXMgYHRydWVgLCB0cmFjayBhbm9ueW1vdXNseSwgaS5lLiBkbyBub3QgaWRlbnRpZnkgdGhlIHVzZXJcbiAgICAgdXNpbmcgYW55IGlkZW50aWZpZXIgdGhhdCB3b3VsZCBiZSBjb25zaXN0ZW50IGFjcm9zcyBkZXZpY2VzLlxuICogLSBJZiBib3RoIGZsYWdzIGFyZSBmYWxzZSBvciBub3Qgc2V0LCBldmVudHMgYXJlIG5vdCBzZW50LlxuICovXG5cbmludGVyZmFjZSBJRXZlbnQge1xuICAgIC8vIFRoZSBldmVudCBuYW1lIHRoYXQgd2lsbCBiZSB1c2VkIGJ5IFBvc3RIb2cuIEV2ZW50IG5hbWVzIHNob3VsZCB1c2Ugc25ha2VfY2FzZS5cbiAgICBldmVudE5hbWU6IHN0cmluZztcblxuICAgIC8vIFRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBldmVudCB0aGF0IHdpbGwgYmUgc3RvcmVkIGluIFBvc3RIb2cuIFRoaXMgaXMganVzdCBhIHBsYWNlaG9sZGVyLFxuICAgIC8vIGV4dGVuZGluZyBpbnRlcmZhY2VzIG11c3Qgb3ZlcnJpZGUgdGhpcyB3aXRoIGEgY29uY3JldGUgZGVmaW5pdGlvbiB0byBkbyB0eXBlIHZhbGlkYXRpb24uXG4gICAgcHJvcGVydGllczoge307XG59XG5cbmV4cG9ydCBlbnVtIEFub255bWl0eSB7XG4gICAgRGlzYWJsZWQsXG4gICAgQW5vbnltb3VzLFxuICAgIFBzZXVkb255bW91c1xufVxuXG4vLyBJZiBhbiBldmVudCBleHRlbmRzIElQc2V1ZG9ueW1vdXNFdmVudCwgdGhlIGV2ZW50IGNvbnRhaW5zIHBzZXVkb255bW91cyBkYXRhXG4vLyB0aGF0IHdvbid0IGJlIHNlbnQgdW5sZXNzIHRoZSB1c2VyIGhhcyBleHBsaWNpdGx5IGNvbnNlbnRlZCB0byBwc2V1ZG9ueW1vdXMgdHJhY2tpbmcuXG4vLyBGb3IgZXhhbXBsZSwgaXQgbWlnaHQgY29udGFpbiBoYXNoZWQgdXNlciBJRHMgb3Igcm9vbSBJRHMuXG4vLyBTdWNoIGV2ZW50cyB3aWxsIGJlIGF1dG9tYXRpY2FsbHkgZHJvcHBlZCBpZiBQb3N0aG9nQW5hbHl0aWNzLmFub255bWl0eSBpc24ndCBzZXQgdG8gUHNldWRvbnltb3VzLlxuZXhwb3J0IGludGVyZmFjZSBJUHNldWRvbnltb3VzRXZlbnQgZXh0ZW5kcyBJRXZlbnQge31cblxuLy8gSWYgYW4gZXZlbnQgZXh0ZW5kcyBJQW5vbnltb3VzRXZlbnQsIHRoZSBldmVudCBzdHJpY3RseSBjb250YWlucyAqb25seSogYW5vbnltb3VzIGRhdGE7XG4vLyBpLmUuIG5vIGlkZW50aWZpZXJzIHRoYXQgY2FuIGJlIGFzc29jaWF0ZWQgd2l0aCB0aGUgdXNlci5cbmV4cG9ydCBpbnRlcmZhY2UgSUFub255bW91c0V2ZW50IGV4dGVuZHMgSUV2ZW50IHt9XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVJvb21FdmVudCBleHRlbmRzIElQc2V1ZG9ueW1vdXNFdmVudCB7XG4gICAgaGFzaGVkUm9vbUlkOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBJUGFnZVZpZXcgZXh0ZW5kcyBJQW5vbnltb3VzRXZlbnQge1xuICAgIGV2ZW50TmFtZTogXCIkcGFnZXZpZXdcIjtcbiAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgIGR1cmF0aW9uTXM/OiBudW1iZXI7XG4gICAgICAgIHNjcmVlbj86IHN0cmluZztcbiAgICB9O1xufVxuXG5jb25zdCB3aGl0ZWxpc3RlZFNjcmVlbnMgPSBuZXcgU2V0KFtcbiAgICBcInJlZ2lzdGVyXCIsIFwibG9naW5cIiwgXCJmb3Jnb3RfcGFzc3dvcmRcIiwgXCJzb2Z0X2xvZ291dFwiLCBcIm5ld1wiLCBcInNldHRpbmdzXCIsIFwid2VsY29tZVwiLCBcImhvbWVcIiwgXCJzdGFydFwiLCBcImRpcmVjdG9yeVwiLFxuICAgIFwic3RhcnRfc3NvXCIsIFwic3RhcnRfY2FzXCIsIFwiZ3JvdXBzXCIsIFwiY29tcGxldGVfc2VjdXJpdHlcIiwgXCJwb3N0X3JlZ2lzdHJhdGlvblwiLCBcInJvb21cIiwgXCJ1c2VyXCIsIFwiZ3JvdXBcIixcbl0pO1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0UmVkYWN0ZWRDdXJyZW50TG9jYXRpb24oXG4gICAgb3JpZ2luOiBzdHJpbmcsXG4gICAgaGFzaDogc3RyaW5nLFxuICAgIHBhdGhuYW1lOiBzdHJpbmcsXG4gICAgYW5vbnltaXR5OiBBbm9ueW1pdHksXG4pOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIC8vIFJlZGFjdCBQSUkgZnJvbSB0aGUgY3VycmVudCBsb2NhdGlvbi5cbiAgICAvLyBGb3Iga25vd24gc2NyZWVucywgYXNzdW1lcyBhIFVSTCBzdHJ1Y3R1cmUgb2YgLzxzY3JlZW4gbmFtZT4vbWlnaHQvYmUvcGlpXG4gICAgaWYgKG9yaWdpbi5zdGFydHNXaXRoKCdmaWxlOi8vJykpIHtcbiAgICAgICAgcGF0aG5hbWUgPSBcIi88cmVkYWN0ZWRfZmlsZV9zY2hlbWVfdXJsPi9cIjtcbiAgICB9XG5cbiAgICBsZXQgaGFzaFN0cjtcbiAgICBpZiAoaGFzaCA9PSBcIlwiKSB7XG4gICAgICAgIGhhc2hTdHIgPSBcIlwiO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGxldCBbYmVmb3JlRmlyc3RTbGFzaCwgc2NyZWVuXSA9IGhhc2guc3BsaXQoXCIvXCIpO1xuXG4gICAgICAgIGlmICghd2hpdGVsaXN0ZWRTY3JlZW5zLmhhcyhzY3JlZW4pKSB7XG4gICAgICAgICAgICBzY3JlZW4gPSBcIjxyZWRhY3RlZF9zY3JlZW5fbmFtZT5cIjtcbiAgICAgICAgfVxuXG4gICAgICAgIGhhc2hTdHIgPSBgJHtiZWZvcmVGaXJzdFNsYXNofS8ke3NjcmVlbn0vPHJlZGFjdGVkPmA7XG4gICAgfVxuICAgIHJldHVybiBvcmlnaW4gKyBwYXRobmFtZSArIGhhc2hTdHI7XG59XG5cbmludGVyZmFjZSBQbGF0Zm9ybVByb3BlcnRpZXMge1xuICAgIGFwcFZlcnNpb246IHN0cmluZztcbiAgICBhcHBQbGF0Zm9ybTogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgUG9zdGhvZ0FuYWx5dGljcyB7XG4gICAgLyogV3JhcHBlciBmb3IgUG9zdGhvZyBhbmFseXRpY3MuXG4gICAgICogMyBtb2RlcyBvZiBhbm9ueW1pdHkgYXJlIHN1cHBvcnRlZCwgZ292ZXJuZWQgYnkgdGhpcy5hbm9ueW1pdHlcbiAgICAgKiAtIEFub255bWl0eS5EaXNhYmxlZCBtZWFucyAqbm8gZGF0YSogaXMgcGFzc2VkIHRvIHBvc3Rob2dcbiAgICAgKiAtIEFub255bWl0eS5Bbm9ueW1vdXMgbWVhbnMgbm8gaWRlbnRpZmllciBpcyBwYXNzZWQgdG8gcG9zdGhvZ1xuICAgICAqIC0gQW5vbnltaXR5LlBzZXVkb255bW91cyBtZWFucyBhbiBhbmFseXRpY3MgSUQgc3RvcmVkIGluIGFjY291bnRfZGF0YSBhbmQgc2hhcmVkIGJldHdlZW4gZGV2aWNlc1xuICAgICAqICAgaXMgcGFzc2VkIHRvIHBvc3Rob2cuXG4gICAgICpcbiAgICAgKiBUbyB1cGRhdGUgYW5vbnltaXR5LCBjYWxsIHVwZGF0ZUFub255bWl0eUZyb21TZXR0aW5ncygpIG9yIHlvdSBjYW4gc2V0IGl0IGRpcmVjdGx5IHZpYSBzZXRBbm9ueW1pdHkoKS5cbiAgICAgKlxuICAgICAqIFRvIHBhc3MgYW4gZXZlbnQgdG8gUG9zdGhvZzpcbiAgICAgKlxuICAgICAqIDEuIERlY2xhcmUgYSB0eXBlIGZvciB0aGUgZXZlbnQsIGV4dGVuZGluZyBJQW5vbnltb3VzRXZlbnQgb3IgSVBzZXVkb255bW91c0V2ZW50LlxuICAgICAqIDIuIENhbGwgdGhlIGFwcHJvcHJpYXRlIHRyYWNrKigpIG1ldGhvZC4gUHNldWRvbnltb3VzIGV2ZW50cyB3aWxsIGJlIGRyb3BwZWQgd2hlbiBhbm9ueW1pdHkgaXNcbiAgICAgKiAgICBBbm9ueW1vdXMgb3IgRGlzYWJsZWQ7IEFub255bW91cyBldmVudHMgd2lsbCBiZSBkcm9wcGVkIHdoZW4gYW5vbnltaXR5IGlzIERpc2FibGVkLlxuICAgICAqL1xuXG4gICAgcHJpdmF0ZSBhbm9ueW1pdHkgPSBBbm9ueW1pdHkuRGlzYWJsZWQ7XG4gICAgLy8gc2V0IHRydWUgZHVyaW5nIHRoZSBjb25zdHJ1Y3RvciBpZiBwb3N0aG9nIGNvbmZpZyBpcyBwcmVzZW50LCBvdGhlcndpc2UgZmFsc2VcbiAgICBwcml2YXRlIGVuYWJsZWQgPSBmYWxzZTtcbiAgICBwcml2YXRlIHN0YXRpYyBfaW5zdGFuY2UgPSBudWxsO1xuICAgIHByaXZhdGUgcGxhdGZvcm1TdXBlclByb3BlcnRpZXMgPSB7fTtcbiAgICBwcml2YXRlIHN0YXRpYyBBTkFMWVRJQ1NfSURfRVZFTlRfVFlQRSA9IFwiaW0udmVjdG9yLndlYi5hbmFseXRpY3NfaWRcIjtcblxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0IGluc3RhbmNlKCk6IFBvc3Rob2dBbmFseXRpY3Mge1xuICAgICAgICBpZiAoIXRoaXMuX2luc3RhbmNlKSB7XG4gICAgICAgICAgICB0aGlzLl9pbnN0YW5jZSA9IG5ldyBQb3N0aG9nQW5hbHl0aWNzKHBvc3Rob2cpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLl9pbnN0YW5jZTtcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHBvc3Rob2c6IFBvc3RIb2cpIHtcbiAgICAgICAgY29uc3QgcG9zdGhvZ0NvbmZpZyA9IFNka0NvbmZpZy5nZXQoKVtcInBvc3Rob2dcIl07XG4gICAgICAgIGlmIChwb3N0aG9nQ29uZmlnKSB7XG4gICAgICAgICAgICB0aGlzLnBvc3Rob2cuaW5pdChwb3N0aG9nQ29uZmlnLnByb2plY3RBcGlLZXksIHtcbiAgICAgICAgICAgICAgICBhcGlfaG9zdDogcG9zdGhvZ0NvbmZpZy5hcGlIb3N0LFxuICAgICAgICAgICAgICAgIGF1dG9jYXB0dXJlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBtYXNrX2FsbF90ZXh0OiB0cnVlLFxuICAgICAgICAgICAgICAgIG1hc2tfYWxsX2VsZW1lbnRfYXR0cmlidXRlczogdHJ1ZSxcbiAgICAgICAgICAgICAgICAvLyBUaGlzIG9ubHkgdHJpZ2dlcnMgb24gcGFnZSBsb2FkLCB3aGljaCBmb3Igb3VyIFNQQSBpc24ndCBwYXJ0aWN1bGFybHkgdXNlZnVsLlxuICAgICAgICAgICAgICAgIC8vIFBsdXMsIHRoZSAuY2FwdHVyZSBjYWxsIG9yaWdpbmF0aW5nIGZyb20gc29tZXdoZXJlIGluIHBvc3Rob2cgbWFrZXMgaXQgaGFyZFxuICAgICAgICAgICAgICAgIC8vIHRvIHJlZGFjdCBVUkxzLCB3aGljaCByZXF1aXJlcyBhc3luYyBjb2RlLlxuICAgICAgICAgICAgICAgIC8vXG4gICAgICAgICAgICAgICAgLy8gVG8gcmFpc2UgdGhpcyBtYW51YWxseSwganVzdCBjYWxsIC5jYXB0dXJlKFwiJHBhZ2V2aWV3XCIpIG9yIHBvc3Rob2cuY2FwdHVyZV9wYWdldmlldy5cbiAgICAgICAgICAgICAgICBjYXB0dXJlX3BhZ2V2aWV3OiBmYWxzZSxcbiAgICAgICAgICAgICAgICBzYW5pdGl6ZV9wcm9wZXJ0aWVzOiB0aGlzLnNhbml0aXplUHJvcGVydGllcyxcbiAgICAgICAgICAgICAgICByZXNwZWN0X2RudDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBhZHZhbmNlZF9kaXNhYmxlX2RlY2lkZTogdHJ1ZSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdGhpcy5lbmFibGVkID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuZW5hYmxlZCA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzYW5pdGl6ZVByb3BlcnRpZXMgPSAocHJvcGVydGllczogcG9zdGhvZy5Qcm9wZXJ0aWVzKTogcG9zdGhvZy5Qcm9wZXJ0aWVzID0+IHtcbiAgICAgICAgLy8gQ2FsbGJhY2sgZnJvbSBwb3N0aG9nIHRvIHNhbml0aXplIHByb3BlcnRpZXMgYmVmb3JlIHNlbmRpbmcgdGhlbSB0byB0aGUgc2VydmVyLlxuICAgICAgICAvL1xuICAgICAgICAvLyBIZXJlIHdlIHNhbml0aXplIHBvc3Rob2cncyBidWlsdCBpbiBwcm9wZXJ0aWVzIHdoaWNoIGxlYWsgUElJIGUuZy4gdXJsIHJlcG9ydGluZy5cbiAgICAgICAgLy8gU2VlIHV0aWxzLmpzIF8uaW5mby5wcm9wZXJ0aWVzIGluIHBvc3Rob2ctanMuXG5cbiAgICAgICAgLy8gUmVwbGFjZSB0aGUgJGN1cnJlbnRfdXJsIHdpdGggYSByZWRhY3RlZCB2ZXJzaW9uLlxuICAgICAgICAvLyAkcmVkYWN0ZWRfY3VycmVudF91cmwgaXMgaW5qZWN0ZWQgYnkgdGhpcyBjbGFzcyBlYXJsaWVyIGluIGNhcHR1cmUoKSwgYXMgaXRzIGdlbmVyYXRpb25cbiAgICAgICAgLy8gaXMgYXN5bmMgYW5kIGNhbid0IGJlIGRvbmUgaW4gdGhpcyBub24tYXN5bmMgY2FsbGJhY2suXG4gICAgICAgIGlmICghcHJvcGVydGllc1snJHJlZGFjdGVkX2N1cnJlbnRfdXJsJ10pIHtcbiAgICAgICAgICAgIGxvZ2dlci5sb2coXCIkcmVkYWN0ZWRfY3VycmVudF91cmwgbm90IHNldCBpbiBzYW5pdGl6ZVByb3BlcnRpZXMsIHdpbGwgZHJvcCAkY3VycmVudF91cmwgZW50aXJlbHlcIik7XG4gICAgICAgIH1cbiAgICAgICAgcHJvcGVydGllc1snJGN1cnJlbnRfdXJsJ10gPSBwcm9wZXJ0aWVzWyckcmVkYWN0ZWRfY3VycmVudF91cmwnXTtcbiAgICAgICAgZGVsZXRlIHByb3BlcnRpZXNbJyRyZWRhY3RlZF9jdXJyZW50X3VybCddO1xuXG4gICAgICAgIGlmICh0aGlzLmFub255bWl0eSA9PSBBbm9ueW1pdHkuQW5vbnltb3VzKSB7XG4gICAgICAgICAgICAvLyBkcm9wIHJlZmVycmVyIGluZm9ybWF0aW9uIGZvciBhbm9ueW1vdXMgdXNlcnNcbiAgICAgICAgICAgIHByb3BlcnRpZXNbJyRyZWZlcnJlciddID0gbnVsbDtcbiAgICAgICAgICAgIHByb3BlcnRpZXNbJyRyZWZlcnJpbmdfZG9tYWluJ10gPSBudWxsO1xuICAgICAgICAgICAgcHJvcGVydGllc1snJGluaXRpYWxfcmVmZXJyZXInXSA9IG51bGw7XG4gICAgICAgICAgICBwcm9wZXJ0aWVzWyckaW5pdGlhbF9yZWZlcnJpbmdfZG9tYWluJ10gPSBudWxsO1xuXG4gICAgICAgICAgICAvLyBkcm9wIGRldmljZSBJRCwgd2hpY2ggaXMgYSBVVUlEIHBlcnNpc3RlZCBpbiBsb2NhbCBzdG9yYWdlXG4gICAgICAgICAgICBwcm9wZXJ0aWVzWyckZGV2aWNlX2lkJ10gPSBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHByb3BlcnRpZXM7XG4gICAgfTtcblxuICAgIHByaXZhdGUgc3RhdGljIGdldEFub255bWl0eUZyb21TZXR0aW5ncygpOiBBbm9ueW1pdHkge1xuICAgICAgICAvLyBkZXRlcm1pbmUgdGhlIGN1cnJlbnQgYW5vbnltaXR5IGxldmVsIGJhc2VkIG9uIGN1cnJlbnQgdXNlciBzZXR0aW5nc1xuXG4gICAgICAgIC8vIFwiU2VuZCBhbm9ueW1vdXMgdXNhZ2UgZGF0YSB3aGljaCBoZWxwcyB1cyBpbXByb3ZlIEVsZW1lbnQuIFRoaXMgd2lsbCB1c2UgYSBjb29raWUuXCJcbiAgICAgICAgY29uc3QgYW5hbHl0aWNzT3B0SW4gPSBTZXR0aW5nc1N0b3JlLmdldFZhbHVlKFwiYW5hbHl0aWNzT3B0SW5cIiwgbnVsbCwgdHJ1ZSk7XG5cbiAgICAgICAgLy8gKHByb3Bvc2VkIHdvcmRpbmcpIFwiU2VuZCBwc2V1ZG9ueW1vdXMgdXNhZ2UgZGF0YSB3aGljaCBoZWxwcyB1cyBpbXByb3ZlIEVsZW1lbnQuIFRoaXMgd2lsbCB1c2UgYSBjb29raWUuXCJcbiAgICAgICAgLy9cbiAgICAgICAgLy8gVE9ETzogQ3VycmVudGx5LCB0aGlzIGlzIG9ubHkgYSBsYWJzIGZsYWcsIGZvciB0ZXN0aW5nIHB1cnBvc2VzLlxuICAgICAgICBjb25zdCBwc2V1ZG9udW1vdXNPcHRJbiA9IFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJmZWF0dXJlX3BzZXVkb255bW91c19hbmFseXRpY3Nfb3B0X2luXCIsIG51bGwsIHRydWUpO1xuXG4gICAgICAgIGxldCBhbm9ueW1pdHk7XG4gICAgICAgIGlmIChwc2V1ZG9udW1vdXNPcHRJbikge1xuICAgICAgICAgICAgYW5vbnltaXR5ID0gQW5vbnltaXR5LlBzZXVkb255bW91cztcbiAgICAgICAgfSBlbHNlIGlmIChhbmFseXRpY3NPcHRJbikge1xuICAgICAgICAgICAgYW5vbnltaXR5ID0gQW5vbnltaXR5LkFub255bW91cztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFub255bWl0eSA9IEFub255bWl0eS5EaXNhYmxlZDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBhbm9ueW1pdHk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZWdpc3RlclN1cGVyUHJvcGVydGllcyhwcm9wZXJ0aWVzOiBwb3N0aG9nLlByb3BlcnRpZXMpIHtcbiAgICAgICAgaWYgKHRoaXMuZW5hYmxlZCkge1xuICAgICAgICAgICAgdGhpcy5wb3N0aG9nLnJlZ2lzdGVyKHByb3BlcnRpZXMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgYXN5bmMgZ2V0UGxhdGZvcm1Qcm9wZXJ0aWVzKCk6IFByb21pc2U8UGxhdGZvcm1Qcm9wZXJ0aWVzPiB7XG4gICAgICAgIGNvbnN0IHBsYXRmb3JtID0gUGxhdGZvcm1QZWcuZ2V0KCk7XG4gICAgICAgIGxldCBhcHBWZXJzaW9uO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXBwVmVyc2lvbiA9IGF3YWl0IHBsYXRmb3JtLmdldEFwcFZlcnNpb24oKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgLy8gdGhpcyBoYXBwZW5zIGlmIG5vIHZlcnNpb24gaXMgc2V0IGkuZS4gaW4gZGV2XG4gICAgICAgICAgICBhcHBWZXJzaW9uID0gXCJ1bmtub3duXCI7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgYXBwVmVyc2lvbixcbiAgICAgICAgICAgIGFwcFBsYXRmb3JtOiBwbGF0Zm9ybS5nZXRIdW1hblJlYWRhYmxlTmFtZSgpLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgY2FwdHVyZShldmVudE5hbWU6IHN0cmluZywgcHJvcGVydGllczogcG9zdGhvZy5Qcm9wZXJ0aWVzKSB7XG4gICAgICAgIGlmICghdGhpcy5lbmFibGVkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgeyBvcmlnaW4sIGhhc2gsIHBhdGhuYW1lIH0gPSB3aW5kb3cubG9jYXRpb247XG4gICAgICAgIHByb3BlcnRpZXNbJyRyZWRhY3RlZF9jdXJyZW50X3VybCddID0gYXdhaXQgZ2V0UmVkYWN0ZWRDdXJyZW50TG9jYXRpb24oXG4gICAgICAgICAgICBvcmlnaW4sIGhhc2gsIHBhdGhuYW1lLCB0aGlzLmFub255bWl0eSk7XG4gICAgICAgIHRoaXMucG9zdGhvZy5jYXB0dXJlKGV2ZW50TmFtZSwgcHJvcGVydGllcyk7XG4gICAgfVxuXG4gICAgcHVibGljIGlzRW5hYmxlZCgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZW5hYmxlZDtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0QW5vbnltaXR5KGFub255bWl0eTogQW5vbnltaXR5KTogdm9pZCB7XG4gICAgICAgIC8vIFVwZGF0ZSB0aGlzLmFub255bWl0eS5cbiAgICAgICAgLy8gVGhpcyBpcyBwdWJsaWMgZm9yIHRlc3RpbmcgcHVycG9zZXMsIHR5cGljYWxseSB5b3Ugd2FudCB0byBjYWxsIHVwZGF0ZUFub255bWl0eUZyb21TZXR0aW5nc1xuICAgICAgICAvLyB0byBlbnN1cmUgdGhpcyB2YWx1ZSBpcyBpbiBzdGVwIHdpdGggdGhlIHVzZXIncyBzZXR0aW5ncy5cbiAgICAgICAgaWYgKHRoaXMuZW5hYmxlZCAmJiAoYW5vbnltaXR5ID09IEFub255bWl0eS5EaXNhYmxlZCB8fCBhbm9ueW1pdHkgPT0gQW5vbnltaXR5LkFub255bW91cykpIHtcbiAgICAgICAgICAgIC8vIHdoZW4gdHJhbnNpdGlvbmluZyB0byBEaXNhYmxlZCBvciBBbm9ueW1vdXMgZW5zdXJlIHdlIGNsZWFyIG91dCBhbnkgcHJpb3Igc3RhdGVcbiAgICAgICAgICAgIC8vIHNldCBpbiBwb3N0aG9nIGUuZy4gZGlzdGluY3QgSURcbiAgICAgICAgICAgIHRoaXMucG9zdGhvZy5yZXNldCgpO1xuICAgICAgICAgICAgLy8gUmVzdG9yZSBhbnkgcHJldmlvdXNseSBzZXQgcGxhdGZvcm0gc3VwZXIgcHJvcGVydGllc1xuICAgICAgICAgICAgdGhpcy5yZWdpc3RlclN1cGVyUHJvcGVydGllcyh0aGlzLnBsYXRmb3JtU3VwZXJQcm9wZXJ0aWVzKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmFub255bWl0eSA9IGFub255bWl0eTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBnZXRSYW5kb21BbmFseXRpY3NJZCgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gWy4uLmNyeXB0by5nZXRSYW5kb21WYWx1ZXMobmV3IFVpbnQ4QXJyYXkoMTYpKV0ubWFwKChjKSA9PiBjLnRvU3RyaW5nKDE2KSkuam9pbignJyk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGlkZW50aWZ5VXNlcihjbGllbnQ6IE1hdHJpeENsaWVudCwgYW5hbHl0aWNzSWRHZW5lcmF0b3I6ICgpID0+IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBpZiAodGhpcy5hbm9ueW1pdHkgPT0gQW5vbnltaXR5LlBzZXVkb255bW91cykge1xuICAgICAgICAgICAgLy8gQ2hlY2sgdGhlIHVzZXIncyBhY2NvdW50X2RhdGEgZm9yIGFuIGFuYWx5dGljcyBJRCB0byB1c2UuIFN0b3JpbmcgdGhlIElEIGluIGFjY291bnRfZGF0YSBhbGxvd3NcbiAgICAgICAgICAgIC8vIGRpZmZlcmVudCBkZXZpY2VzIHRvIHNlbmQgdGhlIHNhbWUgSUQuXG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGFjY291bnREYXRhID0gYXdhaXQgY2xpZW50LmdldEFjY291bnREYXRhRnJvbVNlcnZlcihQb3N0aG9nQW5hbHl0aWNzLkFOQUxZVElDU19JRF9FVkVOVF9UWVBFKTtcbiAgICAgICAgICAgICAgICBsZXQgYW5hbHl0aWNzSUQgPSBhY2NvdW50RGF0YT8uaWQ7XG4gICAgICAgICAgICAgICAgaWYgKCFhbmFseXRpY3NJRCkge1xuICAgICAgICAgICAgICAgICAgICAvLyBDb3VsZG4ndCByZXRyaWV2ZSBhbiBhbmFseXRpY3MgSUQgZnJvbSB1c2VyIHNldHRpbmdzLCBzbyBjcmVhdGUgb25lIGFuZCBzZXQgaXQgb24gdGhlIHNlcnZlci5cbiAgICAgICAgICAgICAgICAgICAgLy8gTm90ZSB0aGVyZSdzIGEgcmFjZSBjb25kaXRpb24gaGVyZSAtIGlmIHR3byBkZXZpY2VzIGRvIHRoZXNlIHN0ZXBzIGF0IHRoZSBzYW1lIHRpbWUsIGxhc3Qgd3JpdGVcbiAgICAgICAgICAgICAgICAgICAgLy8gd2lucywgYW5kIHRoZSBmaXJzdCB3cml0ZXIgd2lsbCBzZW5kIHRyYWNraW5nIHdpdGggYW4gSUQgdGhhdCBkb2Vzbid0IG1hdGNoIHRoZSBvbmUgb24gdGhlIHNlcnZlclxuICAgICAgICAgICAgICAgICAgICAvLyB1bnRpbCB0aGUgbmV4dCB0aW1lIGFjY291bnQgZGF0YSBpcyByZWZyZXNoZWQgYW5kIHRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIChtb3N0IGxpa2VseSBvbiBuZXh0XG4gICAgICAgICAgICAgICAgICAgIC8vIHBhZ2UgbG9hZCkuIFRoaXMgd2lsbCBoYXBwZW4gcHJldHR5IGluZnJlcXVlbnRseSwgc28gd2UgY2FuIHRvbGVyYXRlIHRoZSBwb3NzaWJpbGl0eS5cbiAgICAgICAgICAgICAgICAgICAgYW5hbHl0aWNzSUQgPSBhbmFseXRpY3NJZEdlbmVyYXRvcigpO1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBjbGllbnQuc2V0QWNjb3VudERhdGEoXCJpbS52ZWN0b3Iud2ViLmFuYWx5dGljc19pZFwiLCB7IGlkOiBhbmFseXRpY3NJRCB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5wb3N0aG9nLmlkZW50aWZ5KGFuYWx5dGljc0lEKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAvLyBUaGUgYWJvdmUgY291bGQgZmFpbCBkdWUgdG8gbmV0d29yayByZXF1ZXN0cywgYnV0IG5vdCBlc3NlbnRpYWwgdG8gc3RhcnRpbmcgdGhlIGFwcGxpY2F0aW9uLFxuICAgICAgICAgICAgICAgIC8vIHNvIHN3YWxsb3cgaXQuXG4gICAgICAgICAgICAgICAgbG9nZ2VyLmxvZyhcIlVuYWJsZSB0byBpZGVudGlmeSB1c2VyIGZvciB0cmFja2luZ1wiICsgZS50b1N0cmluZygpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBnZXRBbm9ueW1pdHkoKTogQW5vbnltaXR5IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYW5vbnltaXR5O1xuICAgIH1cblxuICAgIHB1YmxpYyBsb2dvdXQoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmVuYWJsZWQpIHtcbiAgICAgICAgICAgIHRoaXMucG9zdGhvZy5yZXNldCgpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2V0QW5vbnltaXR5KEFub255bWl0eS5Bbm9ueW1vdXMpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyB0cmFja1BzZXVkb255bW91c0V2ZW50PEUgZXh0ZW5kcyBJUHNldWRvbnltb3VzRXZlbnQ+KFxuICAgICAgICBldmVudE5hbWU6IEVbXCJldmVudE5hbWVcIl0sXG4gICAgICAgIHByb3BlcnRpZXM6IEVbXCJwcm9wZXJ0aWVzXCJdID0ge30sXG4gICAgKSB7XG4gICAgICAgIGlmICh0aGlzLmFub255bWl0eSA9PSBBbm9ueW1pdHkuQW5vbnltb3VzIHx8IHRoaXMuYW5vbnltaXR5ID09IEFub255bWl0eS5EaXNhYmxlZCkgcmV0dXJuO1xuICAgICAgICBhd2FpdCB0aGlzLmNhcHR1cmUoZXZlbnROYW1lLCBwcm9wZXJ0aWVzKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgdHJhY2tBbm9ueW1vdXNFdmVudDxFIGV4dGVuZHMgSUFub255bW91c0V2ZW50PihcbiAgICAgICAgZXZlbnROYW1lOiBFW1wiZXZlbnROYW1lXCJdLFxuICAgICAgICBwcm9wZXJ0aWVzOiBFW1wicHJvcGVydGllc1wiXSA9IHt9LFxuICAgICk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBpZiAodGhpcy5hbm9ueW1pdHkgPT0gQW5vbnltaXR5LkRpc2FibGVkKSByZXR1cm47XG4gICAgICAgIGF3YWl0IHRoaXMuY2FwdHVyZShldmVudE5hbWUsIHByb3BlcnRpZXMpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyB0cmFja1BhZ2VWaWV3KGR1cmF0aW9uTXM6IG51bWJlcik6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBjb25zdCBoYXNoID0gd2luZG93LmxvY2F0aW9uLmhhc2g7XG5cbiAgICAgICAgbGV0IHNjcmVlbiA9IG51bGw7XG4gICAgICAgIGNvbnN0IHNwbGl0ID0gaGFzaC5zcGxpdChcIi9cIik7XG4gICAgICAgIGlmIChzcGxpdC5sZW5ndGggPj0gMikge1xuICAgICAgICAgICAgc2NyZWVuID0gc3BsaXRbMV07XG4gICAgICAgIH1cblxuICAgICAgICBhd2FpdCB0aGlzLnRyYWNrQW5vbnltb3VzRXZlbnQ8SVBhZ2VWaWV3PihcIiRwYWdldmlld1wiLCB7XG4gICAgICAgICAgICBkdXJhdGlvbk1zLFxuICAgICAgICAgICAgc2NyZWVuLFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgdXBkYXRlUGxhdGZvcm1TdXBlclByb3BlcnRpZXMoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIC8vIFVwZGF0ZSBzdXBlciBwcm9wZXJ0aWVzIGluIHBvc3Rob2cgd2l0aCBvdXIgcGxhdGZvcm0gKGFwcCB2ZXJzaW9uLCBwbGF0Zm9ybSkuXG4gICAgICAgIC8vIFRoZXNlIHByb3BlcnRpZXMgd2lsbCBiZSBzdWJzZXF1ZW50bHkgcGFzc2VkIGluIGV2ZXJ5IGV2ZW50LlxuICAgICAgICAvL1xuICAgICAgICAvLyBUaGlzIG9ubHkgbmVlZHMgdG8gYmUgZG9uZSBvbmNlIHBlciBwYWdlIGxpZmV0aW1lLiBOb3RlIHRoYXQgZ2V0UGxhdGZvcm1Qcm9wZXJ0aWVzXG4gICAgICAgIC8vIGlzIGFzeW5jIGFuZCBjYW4gaW52b2x2ZSBhIG5ldHdvcmsgcmVxdWVzdCBpZiB3ZSBhcmUgcnVubmluZyBpbiBhIGJyb3dzZXIuXG4gICAgICAgIHRoaXMucGxhdGZvcm1TdXBlclByb3BlcnRpZXMgPSBhd2FpdCBQb3N0aG9nQW5hbHl0aWNzLmdldFBsYXRmb3JtUHJvcGVydGllcygpO1xuICAgICAgICB0aGlzLnJlZ2lzdGVyU3VwZXJQcm9wZXJ0aWVzKHRoaXMucGxhdGZvcm1TdXBlclByb3BlcnRpZXMpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyB1cGRhdGVBbm9ueW1pdHlGcm9tU2V0dGluZ3ModXNlcklkPzogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIC8vIFVwZGF0ZSB0aGlzLmFub255bWl0eSBiYXNlZCBvbiB0aGUgdXNlcidzIGFuYWx5dGljcyBvcHQtaW4gc2V0dGluZ3NcbiAgICAgICAgLy8gSWRlbnRpZnkgdGhlIHVzZXIgKHZpYSBoYXNoZWQgdXNlciBJRCkgdG8gcG9zdGhvZyBpZiBhbm9ueW1pdHkgaXMgcHNldWRvbm15b3VzXG4gICAgICAgIHRoaXMuc2V0QW5vbnltaXR5KFBvc3Rob2dBbmFseXRpY3MuZ2V0QW5vbnltaXR5RnJvbVNldHRpbmdzKCkpO1xuICAgICAgICBpZiAodXNlcklkICYmIHRoaXMuZ2V0QW5vbnltaXR5KCkgPT0gQW5vbnltaXR5LlBzZXVkb255bW91cykge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5pZGVudGlmeVVzZXIoTWF0cml4Q2xpZW50UGVnLmdldCgpLCBQb3N0aG9nQW5hbHl0aWNzLmdldFJhbmRvbUFuYWx5dGljc0lkKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==