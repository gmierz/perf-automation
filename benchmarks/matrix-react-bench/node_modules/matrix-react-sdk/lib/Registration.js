"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SAFE_LOCALPART_REGEX = void 0;
exports.startAnyRegistrationFlow = startAnyRegistrationFlow;

var _react = _interopRequireDefault(require("react"));

var _dispatcher = _interopRequireDefault(require("./dispatcher/dispatcher"));

var _Modal = _interopRequireDefault(require("./Modal"));

var _languageHandler = require("./languageHandler");

var _QuestionDialog = _interopRequireDefault(require("./components/views/dialogs/QuestionDialog"));

/*
Copyright 2018 New Vector Ltd

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

/**
 * Utility code for registering with a homeserver
 * Note that this is currently *not* used by the actual
 * registration code.
 */
// Regex for what a "safe" or "Matrix-looking" localpart would be.
// TODO: Update as needed for https://github.com/matrix-org/matrix-doc/issues/1514
const SAFE_LOCALPART_REGEX = /^[a-z0-9=_\-./]+$/;
/**
 * Starts either the ILAG or full registration flow, depending
 * on what the HS supports
 *
 * @param {object} options
 * @param {bool} options.go_home_on_cancel
 *     If true, goes to the home page if the user cancels the action
 * @param {bool} options.go_welcome_on_cancel
 *     If true, goes to the welcome page if the user cancels the action
 * @param {bool} options.screen_after
 *     If present the screen to redirect to after a successful login or register.
 */

exports.SAFE_LOCALPART_REGEX = SAFE_LOCALPART_REGEX;

async function startAnyRegistrationFlow( // eslint-disable-next-line camelcase
options) {
  if (options === undefined) options = {};

  const modal = _Modal.default.createTrackedDialog('Registration required', '', _QuestionDialog.default, {
    hasCancelButton: true,
    quitOnly: true,
    title: (0, _languageHandler._t)("Sign In or Create Account"),
    description: (0, _languageHandler._t)("Use your account or create a new one to continue."),
    button: (0, _languageHandler._t)("Create Account"),
    extraButtons: [/*#__PURE__*/_react.default.createElement("button", {
      key: "start_login",
      onClick: () => {
        modal.close();

        _dispatcher.default.dispatch({
          action: 'start_login',
          screenAfterLogin: options.screen_after
        });
      }
    }, (0, _languageHandler._t)('Sign In'))],
    onFinished: proceed => {
      if (proceed) {
        _dispatcher.default.dispatch({
          action: 'start_registration',
          screenAfterLogin: options.screen_after
        });
      } else if (options.go_home_on_cancel) {
        _dispatcher.default.dispatch({
          action: 'view_home_page'
        });
      } else if (options.go_welcome_on_cancel) {
        _dispatcher.default.dispatch({
          action: 'view_welcome_page'
        });
      }
    }
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9SZWdpc3RyYXRpb24udHN4Il0sIm5hbWVzIjpbIlNBRkVfTE9DQUxQQVJUX1JFR0VYIiwic3RhcnRBbnlSZWdpc3RyYXRpb25GbG93Iiwib3B0aW9ucyIsInVuZGVmaW5lZCIsIm1vZGFsIiwiTW9kYWwiLCJjcmVhdGVUcmFja2VkRGlhbG9nIiwiUXVlc3Rpb25EaWFsb2ciLCJoYXNDYW5jZWxCdXR0b24iLCJxdWl0T25seSIsInRpdGxlIiwiZGVzY3JpcHRpb24iLCJidXR0b24iLCJleHRyYUJ1dHRvbnMiLCJjbG9zZSIsImRpcyIsImRpc3BhdGNoIiwiYWN0aW9uIiwic2NyZWVuQWZ0ZXJMb2dpbiIsInNjcmVlbl9hZnRlciIsIm9uRmluaXNoZWQiLCJwcm9jZWVkIiwiZ29faG9tZV9vbl9jYW5jZWwiLCJnb193ZWxjb21lX29uX2NhbmNlbCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQXNCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUExQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFRQTtBQUNBO0FBQ08sTUFBTUEsb0JBQW9CLEdBQUcsbUJBQTdCO0FBRVA7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7O0FBQ08sZUFBZUMsd0JBQWYsRUFDSDtBQUNBQyxPQUZHLEVBR1U7QUFDYixNQUFJQSxPQUFPLEtBQUtDLFNBQWhCLEVBQTJCRCxPQUFPLEdBQUcsRUFBVjs7QUFDM0IsUUFBTUUsS0FBSyxHQUFHQyxlQUFNQyxtQkFBTixDQUEwQix1QkFBMUIsRUFBbUQsRUFBbkQsRUFBdURDLHVCQUF2RCxFQUF1RTtBQUNqRkMsSUFBQUEsZUFBZSxFQUFFLElBRGdFO0FBRWpGQyxJQUFBQSxRQUFRLEVBQUUsSUFGdUU7QUFHakZDLElBQUFBLEtBQUssRUFBRSx5QkFBRywyQkFBSCxDQUgwRTtBQUlqRkMsSUFBQUEsV0FBVyxFQUFFLHlCQUFHLG1EQUFILENBSm9FO0FBS2pGQyxJQUFBQSxNQUFNLEVBQUUseUJBQUcsZ0JBQUgsQ0FMeUU7QUFNakZDLElBQUFBLFlBQVksRUFBRSxjQUNWO0FBQ0ksTUFBQSxHQUFHLEVBQUMsYUFEUjtBQUVJLE1BQUEsT0FBTyxFQUFFLE1BQU07QUFDWFQsUUFBQUEsS0FBSyxDQUFDVSxLQUFOOztBQUNBQyw0QkFBSUMsUUFBSixDQUFhO0FBQUVDLFVBQUFBLE1BQU0sRUFBRSxhQUFWO0FBQXlCQyxVQUFBQSxnQkFBZ0IsRUFBRWhCLE9BQU8sQ0FBQ2lCO0FBQW5ELFNBQWI7QUFDSDtBQUxMLE9BT00seUJBQUcsU0FBSCxDQVBOLENBRFUsQ0FObUU7QUFpQmpGQyxJQUFBQSxVQUFVLEVBQUdDLE9BQUQsSUFBYTtBQUNyQixVQUFJQSxPQUFKLEVBQWE7QUFDVE4sNEJBQUlDLFFBQUosQ0FBYTtBQUFFQyxVQUFBQSxNQUFNLEVBQUUsb0JBQVY7QUFBZ0NDLFVBQUFBLGdCQUFnQixFQUFFaEIsT0FBTyxDQUFDaUI7QUFBMUQsU0FBYjtBQUNILE9BRkQsTUFFTyxJQUFJakIsT0FBTyxDQUFDb0IsaUJBQVosRUFBK0I7QUFDbENQLDRCQUFJQyxRQUFKLENBQWE7QUFBRUMsVUFBQUEsTUFBTSxFQUFFO0FBQVYsU0FBYjtBQUNILE9BRk0sTUFFQSxJQUFJZixPQUFPLENBQUNxQixvQkFBWixFQUFrQztBQUNyQ1IsNEJBQUlDLFFBQUosQ0FBYTtBQUFFQyxVQUFBQSxNQUFNLEVBQUU7QUFBVixTQUFiO0FBQ0g7QUFDSjtBQXpCZ0YsR0FBdkUsQ0FBZDtBQTJCSCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxOCBOZXcgVmVjdG9yIEx0ZFxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbi8qKlxuICogVXRpbGl0eSBjb2RlIGZvciByZWdpc3RlcmluZyB3aXRoIGEgaG9tZXNlcnZlclxuICogTm90ZSB0aGF0IHRoaXMgaXMgY3VycmVudGx5ICpub3QqIHVzZWQgYnkgdGhlIGFjdHVhbFxuICogcmVnaXN0cmF0aW9uIGNvZGUuXG4gKi9cblxuaW1wb3J0IFJlYWN0IGZyb20gXCJyZWFjdFwiO1xuaW1wb3J0IGRpcyBmcm9tICcuL2Rpc3BhdGNoZXIvZGlzcGF0Y2hlcic7XG5pbXBvcnQgTW9kYWwgZnJvbSAnLi9Nb2RhbCc7XG5pbXBvcnQgeyBfdCB9IGZyb20gJy4vbGFuZ3VhZ2VIYW5kbGVyJztcbmltcG9ydCBRdWVzdGlvbkRpYWxvZyBmcm9tIFwiLi9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvUXVlc3Rpb25EaWFsb2dcIjtcblxuLy8gUmVnZXggZm9yIHdoYXQgYSBcInNhZmVcIiBvciBcIk1hdHJpeC1sb29raW5nXCIgbG9jYWxwYXJ0IHdvdWxkIGJlLlxuLy8gVE9ETzogVXBkYXRlIGFzIG5lZWRlZCBmb3IgaHR0cHM6Ly9naXRodWIuY29tL21hdHJpeC1vcmcvbWF0cml4LWRvYy9pc3N1ZXMvMTUxNFxuZXhwb3J0IGNvbnN0IFNBRkVfTE9DQUxQQVJUX1JFR0VYID0gL15bYS16MC05PV9cXC0uL10rJC87XG5cbi8qKlxuICogU3RhcnRzIGVpdGhlciB0aGUgSUxBRyBvciBmdWxsIHJlZ2lzdHJhdGlvbiBmbG93LCBkZXBlbmRpbmdcbiAqIG9uIHdoYXQgdGhlIEhTIHN1cHBvcnRzXG4gKlxuICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnNcbiAqIEBwYXJhbSB7Ym9vbH0gb3B0aW9ucy5nb19ob21lX29uX2NhbmNlbFxuICogICAgIElmIHRydWUsIGdvZXMgdG8gdGhlIGhvbWUgcGFnZSBpZiB0aGUgdXNlciBjYW5jZWxzIHRoZSBhY3Rpb25cbiAqIEBwYXJhbSB7Ym9vbH0gb3B0aW9ucy5nb193ZWxjb21lX29uX2NhbmNlbFxuICogICAgIElmIHRydWUsIGdvZXMgdG8gdGhlIHdlbGNvbWUgcGFnZSBpZiB0aGUgdXNlciBjYW5jZWxzIHRoZSBhY3Rpb25cbiAqIEBwYXJhbSB7Ym9vbH0gb3B0aW9ucy5zY3JlZW5fYWZ0ZXJcbiAqICAgICBJZiBwcmVzZW50IHRoZSBzY3JlZW4gdG8gcmVkaXJlY3QgdG8gYWZ0ZXIgYSBzdWNjZXNzZnVsIGxvZ2luIG9yIHJlZ2lzdGVyLlxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gc3RhcnRBbnlSZWdpc3RyYXRpb25GbG93KFxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBjYW1lbGNhc2VcbiAgICBvcHRpb25zOiB7IGdvX2hvbWVfb25fY2FuY2VsPzogYm9vbGVhbiwgZ29fd2VsY29tZV9vbl9jYW5jZWw/OiBib29sZWFuLCBzY3JlZW5fYWZ0ZXI/OiBib29sZWFufSxcbik6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmIChvcHRpb25zID09PSB1bmRlZmluZWQpIG9wdGlvbnMgPSB7fTtcbiAgICBjb25zdCBtb2RhbCA9IE1vZGFsLmNyZWF0ZVRyYWNrZWREaWFsb2coJ1JlZ2lzdHJhdGlvbiByZXF1aXJlZCcsICcnLCBRdWVzdGlvbkRpYWxvZywge1xuICAgICAgICBoYXNDYW5jZWxCdXR0b246IHRydWUsXG4gICAgICAgIHF1aXRPbmx5OiB0cnVlLFxuICAgICAgICB0aXRsZTogX3QoXCJTaWduIEluIG9yIENyZWF0ZSBBY2NvdW50XCIpLFxuICAgICAgICBkZXNjcmlwdGlvbjogX3QoXCJVc2UgeW91ciBhY2NvdW50IG9yIGNyZWF0ZSBhIG5ldyBvbmUgdG8gY29udGludWUuXCIpLFxuICAgICAgICBidXR0b246IF90KFwiQ3JlYXRlIEFjY291bnRcIiksXG4gICAgICAgIGV4dHJhQnV0dG9uczogW1xuICAgICAgICAgICAgPGJ1dHRvblxuICAgICAgICAgICAgICAgIGtleT1cInN0YXJ0X2xvZ2luXCJcbiAgICAgICAgICAgICAgICBvbkNsaWNrPXsoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIG1vZGFsLmNsb3NlKCk7XG4gICAgICAgICAgICAgICAgICAgIGRpcy5kaXNwYXRjaCh7IGFjdGlvbjogJ3N0YXJ0X2xvZ2luJywgc2NyZWVuQWZ0ZXJMb2dpbjogb3B0aW9ucy5zY3JlZW5fYWZ0ZXIgfSk7XG4gICAgICAgICAgICAgICAgfX1cbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICB7IF90KCdTaWduIEluJykgfVxuICAgICAgICAgICAgPC9idXR0b24+LFxuICAgICAgICBdLFxuICAgICAgICBvbkZpbmlzaGVkOiAocHJvY2VlZCkgPT4ge1xuICAgICAgICAgICAgaWYgKHByb2NlZWQpIHtcbiAgICAgICAgICAgICAgICBkaXMuZGlzcGF0Y2goeyBhY3Rpb246ICdzdGFydF9yZWdpc3RyYXRpb24nLCBzY3JlZW5BZnRlckxvZ2luOiBvcHRpb25zLnNjcmVlbl9hZnRlciB9KTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5nb19ob21lX29uX2NhbmNlbCkge1xuICAgICAgICAgICAgICAgIGRpcy5kaXNwYXRjaCh7IGFjdGlvbjogJ3ZpZXdfaG9tZV9wYWdlJyB9KTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5nb193ZWxjb21lX29uX2NhbmNlbCkge1xuICAgICAgICAgICAgICAgIGRpcy5kaXNwYXRjaCh7IGFjdGlvbjogJ3ZpZXdfd2VsY29tZV9wYWdlJyB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICB9KTtcbn1cbiJdfQ==