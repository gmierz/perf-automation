"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Media = void 0;
exports.mediaFromContent = mediaFromContent;
exports.mediaFromMxc = mediaFromMxc;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _MatrixClientPeg = require("../MatrixClientPeg");

var _IMediaEventContent = require("./models/IMediaEventContent");

/*
 * Copyright 2021 The Matrix.org Foundation C.I.C.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
// Populate this class with the details of your customisations when copying it.
// Implementation note: The Media class must complete the contract as shown here, though
// the constructor can be whatever is relevant to your implementation. The mediaForX
// functions below create an instance of the Media class and are used throughout the
// project.

/**
 * A media object is a representation of a "source media" and an optional
 * "thumbnail media", derived from event contents or external sources.
 */
class Media {
  // Per above, this constructor signature can be whatever is helpful for you.
  constructor(prepared, client) {
    this.prepared = prepared;
    (0, _defineProperty2.default)(this, "client", void 0);
    this.client = client ?? _MatrixClientPeg.MatrixClientPeg.get();

    if (!this.client) {
      throw new Error("No possible MatrixClient for media resolution. Please provide one or log in.");
    }
  }
  /**
   * True if the media appears to be encrypted. Actual file contents may vary.
   */


  get isEncrypted() {
    return !!this.prepared.file;
  }
  /**
   * The MXC URI of the source media.
   */


  get srcMxc() {
    return this.prepared.mxc;
  }
  /**
   * The MXC URI of the thumbnail media, if a thumbnail is recorded. Null/undefined
   * otherwise.
   */


  get thumbnailMxc() {
    var _this$prepared$thumbn;

    return (_this$prepared$thumbn = this.prepared.thumbnail) === null || _this$prepared$thumbn === void 0 ? void 0 : _this$prepared$thumbn.mxc;
  }
  /**
   * Whether or not a thumbnail is recorded for this media.
   */


  get hasThumbnail() {
    return !!this.thumbnailMxc;
  }
  /**
   * The HTTP URL for the source media.
   */


  get srcHttp() {
    // eslint-disable-next-line no-restricted-properties
    return this.client.mxcUrlToHttp(this.srcMxc);
  }
  /**
   * The HTTP URL for the thumbnail media (without any specified width, height, etc). Null/undefined
   * if no thumbnail media recorded.
   */


  get thumbnailHttp() {
    if (!this.hasThumbnail) return null; // eslint-disable-next-line no-restricted-properties

    return this.client.mxcUrlToHttp(this.thumbnailMxc);
  }
  /**
   * Gets the HTTP URL for the thumbnail media with the requested characteristics, if a thumbnail
   * is recorded for this media. Returns null/undefined otherwise.
   * @param {number} width The desired width of the thumbnail.
   * @param {number} height The desired height of the thumbnail.
   * @param {"scale"|"crop"} mode The desired thumbnailing mode. Defaults to scale.
   * @returns {string} The HTTP URL which points to the thumbnail.
   */


  getThumbnailHttp(width, height, mode = "scale") {
    if (!this.hasThumbnail) return null; // scale using the device pixel ratio to keep images clear

    width = Math.floor(width * window.devicePixelRatio);
    height = Math.floor(height * window.devicePixelRatio); // eslint-disable-next-line no-restricted-properties

    return this.client.mxcUrlToHttp(this.thumbnailMxc, width, height, mode);
  }
  /**
   * Gets the HTTP URL for a thumbnail of the source media with the requested characteristics.
   * @param {number} width The desired width of the thumbnail.
   * @param {number} height The desired height of the thumbnail.
   * @param {"scale"|"crop"} mode The desired thumbnailing mode. Defaults to scale.
   * @returns {string} The HTTP URL which points to the thumbnail.
   */


  getThumbnailOfSourceHttp(width, height, mode = "scale") {
    // scale using the device pixel ratio to keep images clear
    width = Math.floor(width * window.devicePixelRatio);
    height = Math.floor(height * window.devicePixelRatio); // eslint-disable-next-line no-restricted-properties

    return this.client.mxcUrlToHttp(this.srcMxc, width, height, mode);
  }
  /**
   * Creates a square thumbnail of the media. If the media has a thumbnail recorded, that MXC will
   * be used, otherwise the source media will be used.
   * @param {number} dim The desired width and height.
   * @returns {string} An HTTP URL for the thumbnail.
   */


  getSquareThumbnailHttp(dim) {
    dim = Math.floor(dim * window.devicePixelRatio); // scale using the device pixel ratio to keep images clear

    if (this.hasThumbnail) {
      return this.getThumbnailHttp(dim, dim, 'crop');
    }

    return this.getThumbnailOfSourceHttp(dim, dim, 'crop');
  }
  /**
   * Downloads the source media.
   * @returns {Promise<Response>} Resolves to the server's response for chaining.
   */


  downloadSource() {
    return fetch(this.srcHttp);
  }

}
/**
 * Creates a media object from event content.
 * @param {IMediaEventContent} content The event content.
 * @param {MatrixClient} client? Optional client to use.
 * @returns {Media} The media object.
 */


exports.Media = Media;

function mediaFromContent(content, client) {
  return new Media((0, _IMediaEventContent.prepEventContentAsMedia)(content), client);
}
/**
 * Creates a media object from an MXC URI.
 * @param {string} mxc The MXC URI.
 * @param {MatrixClient} client? Optional client to use.
 * @returns {Media} The media object.
 */


function mediaFromMxc(mxc, client) {
  return mediaFromContent({
    url: mxc
  }, client);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jdXN0b21pc2F0aW9ucy9NZWRpYS50cyJdLCJuYW1lcyI6WyJNZWRpYSIsImNvbnN0cnVjdG9yIiwicHJlcGFyZWQiLCJjbGllbnQiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJFcnJvciIsImlzRW5jcnlwdGVkIiwiZmlsZSIsInNyY014YyIsIm14YyIsInRodW1ibmFpbE14YyIsInRodW1ibmFpbCIsImhhc1RodW1ibmFpbCIsInNyY0h0dHAiLCJteGNVcmxUb0h0dHAiLCJ0aHVtYm5haWxIdHRwIiwiZ2V0VGh1bWJuYWlsSHR0cCIsIndpZHRoIiwiaGVpZ2h0IiwibW9kZSIsIk1hdGgiLCJmbG9vciIsIndpbmRvdyIsImRldmljZVBpeGVsUmF0aW8iLCJnZXRUaHVtYm5haWxPZlNvdXJjZUh0dHAiLCJnZXRTcXVhcmVUaHVtYm5haWxIdHRwIiwiZGltIiwiZG93bmxvYWRTb3VyY2UiLCJmZXRjaCIsIm1lZGlhRnJvbUNvbnRlbnQiLCJjb250ZW50IiwibWVkaWFGcm9tTXhjIiwidXJsIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBbUJBOztBQUNBOztBQXBCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFRQTtBQUVBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ08sTUFBTUEsS0FBTixDQUFZO0FBR2Y7QUFDQUMsRUFBQUEsV0FBVyxDQUFTQyxRQUFULEVBQW1DQyxNQUFuQyxFQUEwRDtBQUFBLFNBQWpERCxRQUFpRCxHQUFqREEsUUFBaUQ7QUFBQTtBQUNqRSxTQUFLQyxNQUFMLEdBQWNBLE1BQU0sSUFBSUMsaUNBQWdCQyxHQUFoQixFQUF4Qjs7QUFDQSxRQUFJLENBQUMsS0FBS0YsTUFBVixFQUFrQjtBQUNkLFlBQU0sSUFBSUcsS0FBSixDQUFVLDhFQUFWLENBQU47QUFDSDtBQUNKO0FBRUQ7QUFDSjtBQUNB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QWMsR0FBc0I7QUFDdkMsV0FBT0MsS0FBSyxDQUFDLEtBQUtmLE9BQU4sQ0FBWjtBQUNIOztBQTlHYztBQWlIbkI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7OztBQUNPLFNBQVNnQixnQkFBVCxDQUEwQkMsT0FBMUIsRUFBdUQ1QixNQUF2RCxFQUFxRjtBQUN4RixTQUFPLElBQUlILEtBQUosQ0FBVSxpREFBd0IrQixPQUF4QixDQUFWLEVBQTRDNUIsTUFBNUMsQ0FBUDtBQUNIO0FBRUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUFDTyxTQUFTNkIsWUFBVCxDQUFzQnRCLEdBQXRCLEVBQW1DUCxNQUFuQyxFQUFpRTtBQUNwRSxTQUFPMkIsZ0JBQWdCLENBQUM7QUFBRUcsSUFBQUEsR0FBRyxFQUFFdkI7QUFBUCxHQUFELEVBQWVQLE1BQWYsQ0FBdkI7QUFDSCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgMjAyMSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgTWF0cml4Q2xpZW50IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2NsaWVudFwiO1xuaW1wb3J0IHsgUmVzaXplTWV0aG9kIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL0B0eXBlcy9wYXJ0aWFsc1wiO1xuXG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tIFwiLi4vTWF0cml4Q2xpZW50UGVnXCI7XG5pbXBvcnQgeyBJTWVkaWFFdmVudENvbnRlbnQsIElQcmVwYXJlZE1lZGlhLCBwcmVwRXZlbnRDb250ZW50QXNNZWRpYSB9IGZyb20gXCIuL21vZGVscy9JTWVkaWFFdmVudENvbnRlbnRcIjtcblxuLy8gUG9wdWxhdGUgdGhpcyBjbGFzcyB3aXRoIHRoZSBkZXRhaWxzIG9mIHlvdXIgY3VzdG9taXNhdGlvbnMgd2hlbiBjb3B5aW5nIGl0LlxuXG4vLyBJbXBsZW1lbnRhdGlvbiBub3RlOiBUaGUgTWVkaWEgY2xhc3MgbXVzdCBjb21wbGV0ZSB0aGUgY29udHJhY3QgYXMgc2hvd24gaGVyZSwgdGhvdWdoXG4vLyB0aGUgY29uc3RydWN0b3IgY2FuIGJlIHdoYXRldmVyIGlzIHJlbGV2YW50IHRvIHlvdXIgaW1wbGVtZW50YXRpb24uIFRoZSBtZWRpYUZvclhcbi8vIGZ1bmN0aW9ucyBiZWxvdyBjcmVhdGUgYW4gaW5zdGFuY2Ugb2YgdGhlIE1lZGlhIGNsYXNzIGFuZCBhcmUgdXNlZCB0aHJvdWdob3V0IHRoZVxuLy8gcHJvamVjdC5cblxuLyoqXG4gKiBBIG1lZGlhIG9iamVjdCBpcyBhIHJlcHJlc2VudGF0aW9uIG9mIGEgXCJzb3VyY2UgbWVkaWFcIiBhbmQgYW4gb3B0aW9uYWxcbiAqIFwidGh1bWJuYWlsIG1lZGlhXCIsIGRlcml2ZWQgZnJvbSBldmVudCBjb250ZW50cyBvciBleHRlcm5hbCBzb3VyY2VzLlxuICovXG5leHBvcnQgY2xhc3MgTWVkaWEge1xuICAgIHByaXZhdGUgY2xpZW50OiBNYXRyaXhDbGllbnQ7XG5cbiAgICAvLyBQZXIgYWJvdmUsIHRoaXMgY29uc3RydWN0b3Igc2lnbmF0dXJlIGNhbiBiZSB3aGF0ZXZlciBpcyBoZWxwZnVsIGZvciB5b3UuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBwcmVwYXJlZDogSVByZXBhcmVkTWVkaWEsIGNsaWVudD86IE1hdHJpeENsaWVudCkge1xuICAgICAgICB0aGlzLmNsaWVudCA9IGNsaWVudCA/PyBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIGlmICghdGhpcy5jbGllbnQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIk5vIHBvc3NpYmxlIE1hdHJpeENsaWVudCBmb3IgbWVkaWEgcmVzb2x1dGlvbi4gUGxlYXNlIHByb3ZpZGUgb25lIG9yIGxvZyBpbi5cIik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUcnVlIGlmIHRoZSBtZWRpYSBhcHBlYXJzIHRvIGJlIGVuY3J5cHRlZC4gQWN0dWFsIGZpbGUgY29udGVudHMgbWF5IHZhcnkuXG4gICAgICovXG4gICAgcHVibGljIGdldCBpc0VuY3J5cHRlZCgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuICEhdGhpcy5wcmVwYXJlZC5maWxlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRoZSBNWEMgVVJJIG9mIHRoZSBzb3VyY2UgbWVkaWEuXG4gICAgICovXG4gICAgcHVibGljIGdldCBzcmNNeGMoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJlcGFyZWQubXhjO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRoZSBNWEMgVVJJIG9mIHRoZSB0aHVtYm5haWwgbWVkaWEsIGlmIGEgdGh1bWJuYWlsIGlzIHJlY29yZGVkLiBOdWxsL3VuZGVmaW5lZFxuICAgICAqIG90aGVyd2lzZS5cbiAgICAgKi9cbiAgICBwdWJsaWMgZ2V0IHRodW1ibmFpbE14YygpOiBzdHJpbmcgfCB1bmRlZmluZWQgfCBudWxsIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJlcGFyZWQudGh1bWJuYWlsPy5teGM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogV2hldGhlciBvciBub3QgYSB0aHVtYm5haWwgaXMgcmVjb3JkZWQgZm9yIHRoaXMgbWVkaWEuXG4gICAgICovXG4gICAgcHVibGljIGdldCBoYXNUaHVtYm5haWwoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAhIXRoaXMudGh1bWJuYWlsTXhjO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRoZSBIVFRQIFVSTCBmb3IgdGhlIHNvdXJjZSBtZWRpYS5cbiAgICAgKi9cbiAgICBwdWJsaWMgZ2V0IHNyY0h0dHAoKTogc3RyaW5nIHtcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXJlc3RyaWN0ZWQtcHJvcGVydGllc1xuICAgICAgICByZXR1cm4gdGhpcy5jbGllbnQubXhjVXJsVG9IdHRwKHRoaXMuc3JjTXhjKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGUgSFRUUCBVUkwgZm9yIHRoZSB0aHVtYm5haWwgbWVkaWEgKHdpdGhvdXQgYW55IHNwZWNpZmllZCB3aWR0aCwgaGVpZ2h0LCBldGMpLiBOdWxsL3VuZGVmaW5lZFxuICAgICAqIGlmIG5vIHRodW1ibmFpbCBtZWRpYSByZWNvcmRlZC5cbiAgICAgKi9cbiAgICBwdWJsaWMgZ2V0IHRodW1ibmFpbEh0dHAoKTogc3RyaW5nIHwgdW5kZWZpbmVkIHwgbnVsbCB7XG4gICAgICAgIGlmICghdGhpcy5oYXNUaHVtYm5haWwpIHJldHVybiBudWxsO1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tcmVzdHJpY3RlZC1wcm9wZXJ0aWVzXG4gICAgICAgIHJldHVybiB0aGlzLmNsaWVudC5teGNVcmxUb0h0dHAodGhpcy50aHVtYm5haWxNeGMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIEhUVFAgVVJMIGZvciB0aGUgdGh1bWJuYWlsIG1lZGlhIHdpdGggdGhlIHJlcXVlc3RlZCBjaGFyYWN0ZXJpc3RpY3MsIGlmIGEgdGh1bWJuYWlsXG4gICAgICogaXMgcmVjb3JkZWQgZm9yIHRoaXMgbWVkaWEuIFJldHVybnMgbnVsbC91bmRlZmluZWQgb3RoZXJ3aXNlLlxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCBUaGUgZGVzaXJlZCB3aWR0aCBvZiB0aGUgdGh1bWJuYWlsLlxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgVGhlIGRlc2lyZWQgaGVpZ2h0IG9mIHRoZSB0aHVtYm5haWwuXG4gICAgICogQHBhcmFtIHtcInNjYWxlXCJ8XCJjcm9wXCJ9IG1vZGUgVGhlIGRlc2lyZWQgdGh1bWJuYWlsaW5nIG1vZGUuIERlZmF1bHRzIHRvIHNjYWxlLlxuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSBIVFRQIFVSTCB3aGljaCBwb2ludHMgdG8gdGhlIHRodW1ibmFpbC5cbiAgICAgKi9cbiAgICBwdWJsaWMgZ2V0VGh1bWJuYWlsSHR0cCh3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlciwgbW9kZTogUmVzaXplTWV0aG9kID0gXCJzY2FsZVwiKTogc3RyaW5nIHwgbnVsbCB8IHVuZGVmaW5lZCB7XG4gICAgICAgIGlmICghdGhpcy5oYXNUaHVtYm5haWwpIHJldHVybiBudWxsO1xuICAgICAgICAvLyBzY2FsZSB1c2luZyB0aGUgZGV2aWNlIHBpeGVsIHJhdGlvIHRvIGtlZXAgaW1hZ2VzIGNsZWFyXG4gICAgICAgIHdpZHRoID0gTWF0aC5mbG9vcih3aWR0aCAqIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvKTtcbiAgICAgICAgaGVpZ2h0ID0gTWF0aC5mbG9vcihoZWlnaHQgKiB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbyk7XG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1yZXN0cmljdGVkLXByb3BlcnRpZXNcbiAgICAgICAgcmV0dXJuIHRoaXMuY2xpZW50Lm14Y1VybFRvSHR0cCh0aGlzLnRodW1ibmFpbE14Yywgd2lkdGgsIGhlaWdodCwgbW9kZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgSFRUUCBVUkwgZm9yIGEgdGh1bWJuYWlsIG9mIHRoZSBzb3VyY2UgbWVkaWEgd2l0aCB0aGUgcmVxdWVzdGVkIGNoYXJhY3RlcmlzdGljcy5cbiAgICAgKiBAcGFyYW0ge251bWJlcn0gd2lkdGggVGhlIGRlc2lyZWQgd2lkdGggb2YgdGhlIHRodW1ibmFpbC5cbiAgICAgKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IFRoZSBkZXNpcmVkIGhlaWdodCBvZiB0aGUgdGh1bWJuYWlsLlxuICAgICAqIEBwYXJhbSB7XCJzY2FsZVwifFwiY3JvcFwifSBtb2RlIFRoZSBkZXNpcmVkIHRodW1ibmFpbGluZyBtb2RlLiBEZWZhdWx0cyB0byBzY2FsZS5cbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgSFRUUCBVUkwgd2hpY2ggcG9pbnRzIHRvIHRoZSB0aHVtYm5haWwuXG4gICAgICovXG4gICAgcHVibGljIGdldFRodW1ibmFpbE9mU291cmNlSHR0cCh3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlciwgbW9kZTogUmVzaXplTWV0aG9kID0gXCJzY2FsZVwiKTogc3RyaW5nIHtcbiAgICAgICAgLy8gc2NhbGUgdXNpbmcgdGhlIGRldmljZSBwaXhlbCByYXRpbyB0byBrZWVwIGltYWdlcyBjbGVhclxuICAgICAgICB3aWR0aCA9IE1hdGguZmxvb3Iod2lkdGggKiB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbyk7XG4gICAgICAgIGhlaWdodCA9IE1hdGguZmxvb3IoaGVpZ2h0ICogd2luZG93LmRldmljZVBpeGVsUmF0aW8pO1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tcmVzdHJpY3RlZC1wcm9wZXJ0aWVzXG4gICAgICAgIHJldHVybiB0aGlzLmNsaWVudC5teGNVcmxUb0h0dHAodGhpcy5zcmNNeGMsIHdpZHRoLCBoZWlnaHQsIG1vZGUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgYSBzcXVhcmUgdGh1bWJuYWlsIG9mIHRoZSBtZWRpYS4gSWYgdGhlIG1lZGlhIGhhcyBhIHRodW1ibmFpbCByZWNvcmRlZCwgdGhhdCBNWEMgd2lsbFxuICAgICAqIGJlIHVzZWQsIG90aGVyd2lzZSB0aGUgc291cmNlIG1lZGlhIHdpbGwgYmUgdXNlZC5cbiAgICAgKiBAcGFyYW0ge251bWJlcn0gZGltIFRoZSBkZXNpcmVkIHdpZHRoIGFuZCBoZWlnaHQuXG4gICAgICogQHJldHVybnMge3N0cmluZ30gQW4gSFRUUCBVUkwgZm9yIHRoZSB0aHVtYm5haWwuXG4gICAgICovXG4gICAgcHVibGljIGdldFNxdWFyZVRodW1ibmFpbEh0dHAoZGltOiBudW1iZXIpOiBzdHJpbmcge1xuICAgICAgICBkaW0gPSBNYXRoLmZsb29yKGRpbSAqIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvKTsgLy8gc2NhbGUgdXNpbmcgdGhlIGRldmljZSBwaXhlbCByYXRpbyB0byBrZWVwIGltYWdlcyBjbGVhclxuICAgICAgICBpZiAodGhpcy5oYXNUaHVtYm5haWwpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFRodW1ibmFpbEh0dHAoZGltLCBkaW0sICdjcm9wJyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VGh1bWJuYWlsT2ZTb3VyY2VIdHRwKGRpbSwgZGltLCAnY3JvcCcpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERvd25sb2FkcyB0aGUgc291cmNlIG1lZGlhLlxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlPFJlc3BvbnNlPn0gUmVzb2x2ZXMgdG8gdGhlIHNlcnZlcidzIHJlc3BvbnNlIGZvciBjaGFpbmluZy5cbiAgICAgKi9cbiAgICBwdWJsaWMgZG93bmxvYWRTb3VyY2UoKTogUHJvbWlzZTxSZXNwb25zZT4ge1xuICAgICAgICByZXR1cm4gZmV0Y2godGhpcy5zcmNIdHRwKTtcbiAgICB9XG59XG5cbi8qKlxuICogQ3JlYXRlcyBhIG1lZGlhIG9iamVjdCBmcm9tIGV2ZW50IGNvbnRlbnQuXG4gKiBAcGFyYW0ge0lNZWRpYUV2ZW50Q29udGVudH0gY29udGVudCBUaGUgZXZlbnQgY29udGVudC5cbiAqIEBwYXJhbSB7TWF0cml4Q2xpZW50fSBjbGllbnQ/IE9wdGlvbmFsIGNsaWVudCB0byB1c2UuXG4gKiBAcmV0dXJucyB7TWVkaWF9IFRoZSBtZWRpYSBvYmplY3QuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBtZWRpYUZyb21Db250ZW50KGNvbnRlbnQ6IElNZWRpYUV2ZW50Q29udGVudCwgY2xpZW50PzogTWF0cml4Q2xpZW50KTogTWVkaWEge1xuICAgIHJldHVybiBuZXcgTWVkaWEocHJlcEV2ZW50Q29udGVudEFzTWVkaWEoY29udGVudCksIGNsaWVudCk7XG59XG5cbi8qKlxuICogQ3JlYXRlcyBhIG1lZGlhIG9iamVjdCBmcm9tIGFuIE1YQyBVUkkuXG4gKiBAcGFyYW0ge3N0cmluZ30gbXhjIFRoZSBNWEMgVVJJLlxuICogQHBhcmFtIHtNYXRyaXhDbGllbnR9IGNsaWVudD8gT3B0aW9uYWwgY2xpZW50IHRvIHVzZS5cbiAqIEByZXR1cm5zIHtNZWRpYX0gVGhlIG1lZGlhIG9iamVjdC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIG1lZGlhRnJvbU14YyhteGM6IHN0cmluZywgY2xpZW50PzogTWF0cml4Q2xpZW50KTogTWVkaWEge1xuICAgIHJldHVybiBtZWRpYUZyb21Db250ZW50KHsgdXJsOiBteGMgfSwgY2xpZW50KTtcbn1cbiJdfQ==