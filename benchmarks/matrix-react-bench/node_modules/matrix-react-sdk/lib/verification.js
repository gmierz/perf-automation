"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.legacyVerifyUser = legacyVerifyUser;
exports.pendingVerificationRequestForUser = pendingVerificationRequestForUser;
exports.verifyDevice = verifyDevice;
exports.verifyUser = verifyUser;

var _MatrixClientPeg = require("./MatrixClientPeg");

var _dispatcher = _interopRequireDefault(require("./dispatcher/dispatcher"));

var _Modal = _interopRequireDefault(require("./Modal"));

var _RightPanelStorePhases = require("./stores/RightPanelStorePhases");

var _createRoom = require("./createRoom");

var _SecurityManager = require("./SecurityManager");

var _crypto = require("matrix-js-sdk/src/crypto");

var _actions = require("./dispatcher/actions");

var _UntrustedDeviceDialog = _interopRequireDefault(require("./components/views/dialogs/UntrustedDeviceDialog"));

var _ManualDeviceKeyVerificationDialog = _interopRequireDefault(require("./components/views/dialogs/ManualDeviceKeyVerificationDialog"));

/*
Copyright 2019, 2020, 2021 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
async function enable4SIfNeeded() {
  const cli = _MatrixClientPeg.MatrixClientPeg.get();

  if (!cli.isCryptoEnabled()) {
    return false;
  }

  const usk = cli.getCrossSigningId("user_signing");

  if (!usk) {
    await (0, _SecurityManager.accessSecretStorage)();
    return false;
  }

  return true;
}

async function verifyDevice(user, device) {
  const cli = _MatrixClientPeg.MatrixClientPeg.get();

  if (cli.isGuest()) {
    _dispatcher.default.dispatch({
      action: 'require_registration'
    });

    return;
  } // if cross-signing is not explicitly disabled, check if it should be enabled first.


  if (cli.getCryptoTrustCrossSignedDevices()) {
    if (!(await enable4SIfNeeded())) {
      return;
    }
  }

  _Modal.default.createTrackedDialog("Verification warning", "unverified session", _UntrustedDeviceDialog.default, {
    user,
    device,
    onFinished: async action => {
      if (action === "sas") {
        const verificationRequestPromise = cli.legacyDeviceVerification(user.userId, device.deviceId, _crypto.verificationMethods.SAS);

        _dispatcher.default.dispatch({
          action: _actions.Action.SetRightPanelPhase,
          phase: _RightPanelStorePhases.RightPanelPhases.EncryptionPanel,
          refireParams: {
            member: user,
            verificationRequestPromise
          }
        });
      } else if (action === "legacy") {
        _Modal.default.createTrackedDialog("Legacy verify session", "legacy verify session", _ManualDeviceKeyVerificationDialog.default, {
          userId: user.userId,
          device
        });
      }
    }
  });
}

async function legacyVerifyUser(user) {
  const cli = _MatrixClientPeg.MatrixClientPeg.get();

  if (cli.isGuest()) {
    _dispatcher.default.dispatch({
      action: 'require_registration'
    });

    return;
  } // if cross-signing is not explicitly disabled, check if it should be enabled first.


  if (cli.getCryptoTrustCrossSignedDevices()) {
    if (!(await enable4SIfNeeded())) {
      return;
    }
  }

  const verificationRequestPromise = cli.requestVerification(user.userId);

  _dispatcher.default.dispatch({
    action: _actions.Action.SetRightPanelPhase,
    phase: _RightPanelStorePhases.RightPanelPhases.EncryptionPanel,
    refireParams: {
      member: user,
      verificationRequestPromise
    }
  });
}

async function verifyUser(user) {
  const cli = _MatrixClientPeg.MatrixClientPeg.get();

  if (cli.isGuest()) {
    _dispatcher.default.dispatch({
      action: 'require_registration'
    });

    return;
  }

  if (!(await enable4SIfNeeded())) {
    return;
  }

  const existingRequest = pendingVerificationRequestForUser(user);

  _dispatcher.default.dispatch({
    action: _actions.Action.SetRightPanelPhase,
    phase: _RightPanelStorePhases.RightPanelPhases.EncryptionPanel,
    refireParams: {
      member: user,
      verificationRequest: existingRequest
    }
  });
}

function pendingVerificationRequestForUser(user) {
  const cli = _MatrixClientPeg.MatrixClientPeg.get();

  const dmRoom = (0, _createRoom.findDMForUser)(cli, user.userId);

  if (dmRoom) {
    return cli.findVerificationRequestDMInProgress(dmRoom.roomId);
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy92ZXJpZmljYXRpb24udHMiXSwibmFtZXMiOlsiZW5hYmxlNFNJZk5lZWRlZCIsImNsaSIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsImlzQ3J5cHRvRW5hYmxlZCIsInVzayIsImdldENyb3NzU2lnbmluZ0lkIiwidmVyaWZ5RGV2aWNlIiwidXNlciIsImRldmljZSIsImlzR3Vlc3QiLCJkaXMiLCJkaXNwYXRjaCIsImFjdGlvbiIsImdldENyeXB0b1RydXN0Q3Jvc3NTaWduZWREZXZpY2VzIiwiTW9kYWwiLCJjcmVhdGVUcmFja2VkRGlhbG9nIiwiVW50cnVzdGVkRGV2aWNlRGlhbG9nIiwib25GaW5pc2hlZCIsInZlcmlmaWNhdGlvblJlcXVlc3RQcm9taXNlIiwibGVnYWN5RGV2aWNlVmVyaWZpY2F0aW9uIiwidXNlcklkIiwiZGV2aWNlSWQiLCJWZXJpZmljYXRpb25NZXRob2RzIiwiU0FTIiwiQWN0aW9uIiwiU2V0UmlnaHRQYW5lbFBoYXNlIiwicGhhc2UiLCJSaWdodFBhbmVsUGhhc2VzIiwiRW5jcnlwdGlvblBhbmVsIiwicmVmaXJlUGFyYW1zIiwibWVtYmVyIiwiTWFudWFsRGV2aWNlS2V5VmVyaWZpY2F0aW9uRGlhbG9nIiwibGVnYWN5VmVyaWZ5VXNlciIsInJlcXVlc3RWZXJpZmljYXRpb24iLCJ2ZXJpZnlVc2VyIiwiZXhpc3RpbmdSZXF1ZXN0IiwicGVuZGluZ1ZlcmlmaWNhdGlvblJlcXVlc3RGb3JVc2VyIiwidmVyaWZpY2F0aW9uUmVxdWVzdCIsImRtUm9vbSIsImZpbmRWZXJpZmljYXRpb25SZXF1ZXN0RE1JblByb2dyZXNzIiwicm9vbUlkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFrQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBNUJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FB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QjtBQUhMLEdBQWI7QUFLSDs7QUFFTSxlQUFlZ0IsVUFBZixDQUEwQjNCLElBQTFCLEVBQXNDO0FBQ3pDLFFBQU1QLEdBQUcsR0FBR0MsaUNBQWdCQyxHQUFoQixFQUFaOztBQUNBLE1BQUlGLEdBQUcsQ0FBQ1MsT0FBSixFQUFKLEVBQW1CO0FBQ2ZDLHdCQUFJQyxRQUFKLENBQWE7QUFBRUMsTUFBQUEsTUFBTSxFQUFFO0FBQVYsS0FBYjs7QUFDQTtBQUNIOztBQUNELE1BQUksRUFBRSxNQUFNYixnQkFBZ0IsRUFBeEIsQ0FBSixFQUFpQztBQUM3QjtBQUNIOztBQUNELFFBQU1vQyxlQUFlLEdBQUdDLGlDQUFpQyxDQUFDN0IsSUFBRCxDQUF6RDs7QUFDQUcsc0JBQUlDLFFBQUosQ0FBYTtBQUNUQyxJQUFBQSxNQUFNLEVBQUVZLGdCQUFPQyxrQkFETjtBQUVUQyxJQUFBQSxLQUFLLEVBQUVDLHdDQUFpQkMsZUFGZjtBQUdUQyxJQUFBQSxZQUFZLEVBQUU7QUFDVkMsTUFBQUEsTUFBTSxFQUFFdkIsSUFERTtBQUVWOEIsTUFBQUEsbUJBQW1CLEVBQUVGO0FBRlg7QUFITCxHQUFiO0FBUUg7O0FBRU0sU0FBU0MsaUNBQVQsQ0FBMkM3QixJQUEzQyxFQUF1RDtBQUMxRCxRQUFNUCxHQUFHLEdBQUdDLGlDQUFnQkMsR0FBaEIsRUFBWjs7QUFDQSxRQUFNb0MsTUFBTSxHQUFHLCtCQUFjdEMsR0FBZCxFQUFtQk8sSUFBSSxDQUFDYSxNQUF4QixDQUFmOztBQUNBLE1BQUlrQixNQUFKLEVBQVk7QUFDUixXQUFPdEMsR0FBRyxDQUFDdUMsbUNBQUosQ0FBd0NELE1BQU0sQ0FBQ0UsTUFBL0MsQ0FBUDtBQUNIO0FBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTksIDIwMjAsIDIwMjEgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgeyBVc2VyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy91c2VyXCI7XG5cbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gJy4vTWF0cml4Q2xpZW50UGVnJztcbmltcG9ydCBkaXMgZnJvbSBcIi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyXCI7XG5pbXBvcnQgTW9kYWwgZnJvbSAnLi9Nb2RhbCc7XG5pbXBvcnQgeyBSaWdodFBhbmVsUGhhc2VzIH0gZnJvbSBcIi4vc3RvcmVzL1JpZ2h0UGFuZWxTdG9yZVBoYXNlc1wiO1xuaW1wb3J0IHsgZmluZERNRm9yVXNlciB9IGZyb20gJy4vY3JlYXRlUm9vbSc7XG5pbXBvcnQgeyBhY2Nlc3NTZWNyZXRTdG9yYWdlIH0gZnJvbSAnLi9TZWN1cml0eU1hbmFnZXInO1xuaW1wb3J0IHsgdmVyaWZpY2F0aW9uTWV0aG9kcyBhcyBWZXJpZmljYXRpb25NZXRob2RzIH0gZnJvbSAnbWF0cml4LWpzLXNkay9zcmMvY3J5cHRvJztcbmltcG9ydCB7IEFjdGlvbiB9IGZyb20gJy4vZGlzcGF0Y2hlci9hY3Rpb25zJztcbmltcG9ydCBVbnRydXN0ZWREZXZpY2VEaWFsb2cgZnJvbSBcIi4vY29tcG9uZW50cy92aWV3cy9kaWFsb2dzL1VudHJ1c3RlZERldmljZURpYWxvZ1wiO1xuaW1wb3J0IHsgSURldmljZSB9IGZyb20gXCIuL2NvbXBvbmVudHMvdmlld3MvcmlnaHRfcGFuZWwvVXNlckluZm9cIjtcbmltcG9ydCBNYW51YWxEZXZpY2VLZXlWZXJpZmljYXRpb25EaWFsb2cgZnJvbSBcIi4vY29tcG9uZW50cy92aWV3cy9kaWFsb2dzL01hbnVhbERldmljZUtleVZlcmlmaWNhdGlvbkRpYWxvZ1wiO1xuXG5hc3luYyBmdW5jdGlvbiBlbmFibGU0U0lmTmVlZGVkKCkge1xuICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICBpZiAoIWNsaS5pc0NyeXB0b0VuYWJsZWQoKSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGNvbnN0IHVzayA9IGNsaS5nZXRDcm9zc1NpZ25pbmdJZChcInVzZXJfc2lnbmluZ1wiKTtcbiAgICBpZiAoIXVzaykge1xuICAgICAgICBhd2FpdCBhY2Nlc3NTZWNyZXRTdG9yYWdlKCk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHZlcmlmeURldmljZSh1c2VyOiBVc2VyLCBkZXZpY2U6IElEZXZpY2UpIHtcbiAgICBjb25zdCBjbGkgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgaWYgKGNsaS5pc0d1ZXN0KCkpIHtcbiAgICAgICAgZGlzLmRpc3BhdGNoKHsgYWN0aW9uOiAncmVxdWlyZV9yZWdpc3RyYXRpb24nIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIC8vIGlmIGNyb3NzLXNpZ25pbmcgaXMgbm90IGV4cGxpY2l0bHkgZGlzYWJsZWQsIGNoZWNrIGlmIGl0IHNob3VsZCBiZSBlbmFibGVkIGZpcnN0LlxuICAgIGlmIChjbGkuZ2V0Q3J5cHRvVHJ1c3RDcm9zc1NpZ25lZERldmljZXMoKSkge1xuICAgICAgICBpZiAoIShhd2FpdCBlbmFibGU0U0lmTmVlZGVkKCkpKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nKFwiVmVyaWZpY2F0aW9uIHdhcm5pbmdcIiwgXCJ1bnZlcmlmaWVkIHNlc3Npb25cIiwgVW50cnVzdGVkRGV2aWNlRGlhbG9nLCB7XG4gICAgICAgIHVzZXIsXG4gICAgICAgIGRldmljZSxcbiAgICAgICAgb25GaW5pc2hlZDogYXN5bmMgKGFjdGlvbikgPT4ge1xuICAgICAgICAgICAgaWYgKGFjdGlvbiA9PT0gXCJzYXNcIikge1xuICAgICAgICAgICAgICAgIGNvbnN0IHZlcmlmaWNhdGlvblJlcXVlc3RQcm9taXNlID0gY2xpLmxlZ2FjeURldmljZVZlcmlmaWNhdGlvbihcbiAgICAgICAgICAgICAgICAgICAgdXNlci51c2VySWQsXG4gICAgICAgICAgICAgICAgICAgIGRldmljZS5kZXZpY2VJZCxcbiAgICAgICAgICAgICAgICAgICAgVmVyaWZpY2F0aW9uTWV0aG9kcy5TQVMsXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICBkaXMuZGlzcGF0Y2goe1xuICAgICAgICAgICAgICAgICAgICBhY3Rpb246IEFjdGlvbi5TZXRSaWdodFBhbmVsUGhhc2UsXG4gICAgICAgICAgICAgICAgICAgIHBoYXNlOiBSaWdodFBhbmVsUGhhc2VzLkVuY3J5cHRpb25QYW5lbCxcbiAgICAgICAgICAgICAgICAgICAgcmVmaXJlUGFyYW1zOiB7IG1lbWJlcjogdXNlciwgdmVyaWZpY2F0aW9uUmVxdWVzdFByb21pc2UgfSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSBcImxlZ2FjeVwiKSB7XG4gICAgICAgICAgICAgICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZyhcIkxlZ2FjeSB2ZXJpZnkgc2Vzc2lvblwiLCBcImxlZ2FjeSB2ZXJpZnkgc2Vzc2lvblwiLFxuICAgICAgICAgICAgICAgICAgICBNYW51YWxEZXZpY2VLZXlWZXJpZmljYXRpb25EaWFsb2csXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJJZDogdXNlci51c2VySWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBkZXZpY2UsXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICB9KTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGxlZ2FjeVZlcmlmeVVzZXIodXNlcjogVXNlcikge1xuICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICBpZiAoY2xpLmlzR3Vlc3QoKSkge1xuICAgICAgICBkaXMuZGlzcGF0Y2goeyBhY3Rpb246ICdyZXF1aXJlX3JlZ2lzdHJhdGlvbicgfSk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgLy8gaWYgY3Jvc3Mtc2lnbmluZyBpcyBub3QgZXhwbGljaXRseSBkaXNhYmxlZCwgY2hlY2sgaWYgaXQgc2hvdWxkIGJlIGVuYWJsZWQgZmlyc3QuXG4gICAgaWYgKGNsaS5nZXRDcnlwdG9UcnVzdENyb3NzU2lnbmVkRGV2aWNlcygpKSB7XG4gICAgICAgIGlmICghKGF3YWl0IGVuYWJsZTRTSWZOZWVkZWQoKSkpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgIH1cbiAgICBjb25zdCB2ZXJpZmljYXRpb25SZXF1ZXN0UHJvbWlzZSA9IGNsaS5yZXF1ZXN0VmVyaWZpY2F0aW9uKHVzZXIudXNlcklkKTtcbiAgICBkaXMuZGlzcGF0Y2goe1xuICAgICAgICBhY3Rpb246IEFjdGlvbi5TZXRSaWdodFBhbmVsUGhhc2UsXG4gICAgICAgIHBoYXNlOiBSaWdodFBhbmVsUGhhc2VzLkVuY3J5cHRpb25QYW5lbCxcbiAgICAgICAgcmVmaXJlUGFyYW1zOiB7IG1lbWJlcjogdXNlciwgdmVyaWZpY2F0aW9uUmVxdWVzdFByb21pc2UgfSxcbiAgICB9KTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHZlcmlmeVVzZXIodXNlcjogVXNlcikge1xuICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICBpZiAoY2xpLmlzR3Vlc3QoKSkge1xuICAgICAgICBkaXMuZGlzcGF0Y2goeyBhY3Rpb246ICdyZXF1aXJlX3JlZ2lzdHJhdGlvbicgfSk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKCEoYXdhaXQgZW5hYmxlNFNJZk5lZWRlZCgpKSkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGV4aXN0aW5nUmVxdWVzdCA9IHBlbmRpbmdWZXJpZmljYXRpb25SZXF1ZXN0Rm9yVXNlcih1c2VyKTtcbiAgICBkaXMuZGlzcGF0Y2goe1xuICAgICAgICBhY3Rpb246IEFjdGlvbi5TZXRSaWdodFBhbmVsUGhhc2UsXG4gICAgICAgIHBoYXNlOiBSaWdodFBhbmVsUGhhc2VzLkVuY3J5cHRpb25QYW5lbCxcbiAgICAgICAgcmVmaXJlUGFyYW1zOiB7XG4gICAgICAgICAgICBtZW1iZXI6IHVzZXIsXG4gICAgICAgICAgICB2ZXJpZmljYXRpb25SZXF1ZXN0OiBleGlzdGluZ1JlcXVlc3QsXG4gICAgICAgIH0sXG4gICAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwZW5kaW5nVmVyaWZpY2F0aW9uUmVxdWVzdEZvclVzZXIodXNlcjogVXNlcikge1xuICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICBjb25zdCBkbVJvb20gPSBmaW5kRE1Gb3JVc2VyKGNsaSwgdXNlci51c2VySWQpO1xuICAgIGlmIChkbVJvb20pIHtcbiAgICAgICAgcmV0dXJuIGNsaS5maW5kVmVyaWZpY2F0aW9uUmVxdWVzdERNSW5Qcm9ncmVzcyhkbVJvb20ucm9vbUlkKTtcbiAgICB9XG59XG4iXX0=