"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Kind = exports.IntegrationManagerInstance = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _ScalarAuthClient = _interopRequireDefault(require("../ScalarAuthClient"));

var _Terms = require("../Terms");

var _Modal = _interopRequireDefault(require("../Modal"));

var _url = _interopRequireDefault(require("url"));

var _SettingsStore = _interopRequireDefault(require("../settings/SettingsStore"));

var _IntegrationManager = _interopRequireDefault(require("../components/views/settings/IntegrationManager"));

var _IntegrationManagers = require("./IntegrationManagers");

var _logger = require("matrix-js-sdk/src/logger");

/*
Copyright 2019 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
let Kind;
exports.Kind = Kind;

(function (Kind) {
  Kind["Account"] = "account";
  Kind["Config"] = "config";
  Kind["Homeserver"] = "homeserver";
})(Kind || (exports.Kind = Kind = {}));

class IntegrationManagerInstance {
  // only applicable in some cases
  // Per the spec: UI URL is optional.
  constructor(kind, apiUrl, uiUrl = apiUrl, id) {
    (0, _defineProperty2.default)(this, "apiUrl", void 0);
    (0, _defineProperty2.default)(this, "uiUrl", void 0);
    (0, _defineProperty2.default)(this, "kind", void 0);
    (0, _defineProperty2.default)(this, "id", void 0);
    this.kind = kind;
    this.apiUrl = apiUrl;
    this.uiUrl = uiUrl;
    this.id = id;
  }

  get name() {
    const parsed = _url.default.parse(this.uiUrl);

    return parsed.host;
  }

  get trimmedApiUrl() {
    const parsed = _url.default.parse(this.apiUrl);

    parsed.pathname = '';
    parsed.path = '';
    return _url.default.format(parsed);
  }

  getScalarClient() {
    return new _ScalarAuthClient.default(this.apiUrl, this.uiUrl);
  }

  async open(room = null, screen = null, integrationId = null) {
    if (!_SettingsStore.default.getValue("integrationProvisioning")) {
      return _IntegrationManagers.IntegrationManagers.sharedInstance().showDisabledDialog();
    }

    const dialog = _Modal.default.createTrackedDialog('Integration Manager', '', _IntegrationManager.default, {
      loading: true
    }, 'mx_IntegrationManager');

    const client = this.getScalarClient();
    client.setTermsInteractionCallback((policyInfo, agreedUrls) => {
      // To avoid visual glitching of two modals stacking briefly, we customise the
      // terms dialog sizing when it will appear for the integration manager so that
      // it gets the same basic size as the IM's own modal.
      return (0, _Terms.dialogTermsInteractionCallback)(policyInfo, agreedUrls, 'mx_TermsDialog_forIntegrationManager');
    });
    const newProps = {};

    try {
      await client.connect();

      if (!client.hasCredentials()) {
        newProps["connected"] = false;
      } else {
        newProps["url"] = client.getScalarInterfaceUrlForRoom(room, screen, integrationId);
      }
    } catch (e) {
      if (e instanceof _Terms.TermsNotSignedError) {
        dialog.close();
        return;
      }

      _logger.logger.error(e);

      newProps["connected"] = false;
    } // Close the old dialog and open a new one


    dialog.close();

    _Modal.default.createTrackedDialog('Integration Manager', '', _IntegrationManager.default, newProps, 'mx_IntegrationManager');
  }

}

exports.IntegrationManagerInstance = IntegrationManagerInstance;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9pbnRlZ3JhdGlvbnMvSW50ZWdyYXRpb25NYW5hZ2VySW5zdGFuY2UudHMiXSwibmFtZXMiOlsiS2luZCIsIkludGVncmF0aW9uTWFuYWdlckluc3RhbmNlIiwiY29uc3RydWN0b3IiLCJraW5kIiwiYXBpVXJsIiwidWlVcmwiLCJpZCIsIm5hbWUiLCJwYXJzZWQiLCJ1cmwiLCJwYXJzZSIsImhvc3QiLCJ0cmltbWVkQXBpVXJsIiwicGF0aG5hbWUiLCJwYXRoIiwiZm9ybWF0IiwiZ2V0U2NhbGFyQ2xpZW50IiwiU2NhbGFyQXV0aENsaWVudCIsIm9wZW4iLCJyb29tIiwic2NyZWVuIiwiaW50ZWdyYXRpb25JZCIsIlNldHRpbmdzU3RvcmUiLCJnZXRWYWx1ZSIsIkludGVncmF0aW9uTWFuYWdlcnMiLCJzaGFyZWRJbnN0YW5jZSIsInNob3dEaXNhYmxlZERpYWxvZyIsImRpYWxvZyIsIk1vZGFsIiwiY3JlYXRlVHJhY2tlZERpYWxvZyIsIkludGVncmF0aW9uTWFuYWdlciIsImxvYWRpbmciLCJjbGllbnQiLCJzZXRUZXJtc0ludGVyYWN0aW9uQ2FsbGJhY2siLCJwb2xpY3lJbmZvIiwiYWdyZWVkVXJscyIsIm5ld1Byb3BzIiwiY29ubmVjdCIsImhhc0NyZWRlbnRpYWxzIiwiZ2V0U2NhbGFySW50ZXJmYWNlVXJsRm9yUm9vbSIsImUiLCJUZXJtc05vdFNpZ25lZEVycm9yIiwiY2xvc2UiLCJsb2dnZXIiLCJlcnJvciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFrQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBMUJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtJQWNZQSxJOzs7V0FBQUEsSTtBQUFBQSxFQUFBQSxJO0FBQUFBLEVBQUFBLEk7QUFBQUEsRUFBQUEsSTtHQUFBQSxJLG9CQUFBQSxJOztBQU1MLE1B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b3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCB0eXBlIHsgUm9vbSB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvcm9vbVwiO1xuXG5pbXBvcnQgU2NhbGFyQXV0aENsaWVudCBmcm9tIFwiLi4vU2NhbGFyQXV0aENsaWVudFwiO1xuaW1wb3J0IHsgZGlhbG9nVGVybXNJbnRlcmFjdGlvbkNhbGxiYWNrLCBUZXJtc05vdFNpZ25lZEVycm9yIH0gZnJvbSBcIi4uL1Rlcm1zXCI7XG5pbXBvcnQgTW9kYWwgZnJvbSAnLi4vTW9kYWwnO1xuaW1wb3J0IHVybCBmcm9tICd1cmwnO1xuaW1wb3J0IFNldHRpbmdzU3RvcmUgZnJvbSBcIi4uL3NldHRpbmdzL1NldHRpbmdzU3RvcmVcIjtcbmltcG9ydCBJbnRlZ3JhdGlvbk1hbmFnZXIgZnJvbSBcIi4uL2NvbXBvbmVudHMvdmlld3Mvc2V0dGluZ3MvSW50ZWdyYXRpb25NYW5hZ2VyXCI7XG5pbXBvcnQgeyBJbnRlZ3JhdGlvbk1hbmFnZXJzIH0gZnJvbSBcIi4vSW50ZWdyYXRpb25NYW5hZ2Vyc1wiO1xuXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbG9nZ2VyXCI7XG5cbmV4cG9ydCBlbnVtIEtpbmQge1xuICAgIEFjY291bnQgPSBcImFjY291bnRcIixcbiAgICBDb25maWcgPSBcImNvbmZpZ1wiLFxuICAgIEhvbWVzZXJ2ZXIgPSBcImhvbWVzZXJ2ZXJcIixcbn1cblxuZXhwb3J0IGNsYXNzIEludGVncmF0aW9uTWFuYWdlckluc3RhbmNlIHtcbiAgICBwdWJsaWMgcmVhZG9ubHkgYXBpVXJsOiBzdHJpbmc7XG4gICAgcHVibGljIHJlYWRvbmx5IHVpVXJsOiBzdHJpbmc7XG4gICAgcHVibGljIHJlYWRvbmx5IGtpbmQ6IHN0cmluZztcbiAgICBwdWJsaWMgcmVhZG9ubHkgaWQ6IHN0cmluZzsgLy8gb25seSBhcHBsaWNhYmxlIGluIHNvbWUgY2FzZXNcblxuICAgIC8vIFBlciB0aGUgc3BlYzogVUkgVVJMIGlzIG9wdGlvbmFsLlxuICAgIGNvbnN0cnVjdG9yKGtpbmQ6IHN0cmluZywgYXBpVXJsOiBzdHJpbmcsIHVpVXJsOiBzdHJpbmcgPSBhcGlVcmwsIGlkPzogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMua2luZCA9IGtpbmQ7XG4gICAgICAgIHRoaXMuYXBpVXJsID0gYXBpVXJsO1xuICAgICAgICB0aGlzLnVpVXJsID0gdWlVcmw7XG4gICAgICAgIHRoaXMuaWQgPSBpZDtcbiAgICB9XG5cbiAgICBnZXQgbmFtZSgpOiBzdHJpbmcge1xuICAgICAgICBjb25zdCBwYXJzZWQgPSB1cmwucGFyc2UodGhpcy51aVVybCk7XG4gICAgICAgIHJldHVybiBwYXJzZWQuaG9zdDtcbiAgICB9XG5cbiAgICBnZXQgdHJpbW1lZEFwaVVybCgpOiBzdHJpbmcge1xuICAgICAgICBjb25zdCBwYXJzZWQgPSB1cmwucGFyc2UodGhpcy5hcGlVcmwpO1xuICAgICAgICBwYXJzZWQucGF0aG5hbWUgPSAnJztcbiAgICAgICAgcGFyc2VkLnBhdGggPSAnJztcbiAgICAgICAgcmV0dXJuIHVybC5mb3JtYXQocGFyc2VkKTtcbiAgICB9XG5cbiAgICBnZXRTY2FsYXJDbGllbnQoKTogU2NhbGFyQXV0aENsaWVudCB7XG4gICAgICAgIHJldHVybiBuZXcgU2NhbGFyQXV0aENsaWVudCh0aGlzLmFwaVVybCwgdGhpcy51aVVybCk7XG4gICAgfVxuXG4gICAgYXN5bmMgb3Blbihyb29tOiBSb29tID0gbnVsbCwgc2NyZWVuOiBzdHJpbmcgPSBudWxsLCBpbnRlZ3JhdGlvbklkOiBzdHJpbmcgPSBudWxsKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGlmICghU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcImludGVncmF0aW9uUHJvdmlzaW9uaW5nXCIpKSB7XG4gICAgICAgICAgICByZXR1cm4gSW50ZWdyYXRpb25NYW5hZ2Vycy5zaGFyZWRJbnN0YW5jZSgpLnNob3dEaXNhYmxlZERpYWxvZygpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZGlhbG9nID0gTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZyhcbiAgICAgICAgICAgICdJbnRlZ3JhdGlvbiBNYW5hZ2VyJywgJycsIEludGVncmF0aW9uTWFuYWdlcixcbiAgICAgICAgICAgIHsgbG9hZGluZzogdHJ1ZSB9LCAnbXhfSW50ZWdyYXRpb25NYW5hZ2VyJyxcbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCBjbGllbnQgPSB0aGlzLmdldFNjYWxhckNsaWVudCgpO1xuICAgICAgICBjbGllbnQuc2V0VGVybXNJbnRlcmFjdGlvbkNhbGxiYWNrKChwb2xpY3lJbmZvLCBhZ3JlZWRVcmxzKSA9PiB7XG4gICAgICAgICAgICAvLyBUbyBhdm9pZCB2aXN1YWwgZ2xpdGNoaW5nIG9mIHR3byBtb2RhbHMgc3RhY2tpbmcgYnJpZWZseSwgd2UgY3VzdG9taXNlIHRoZVxuICAgICAgICAgICAgLy8gdGVybXMgZGlhbG9nIHNpemluZyB3aGVuIGl0IHdpbGwgYXBwZWFyIGZvciB0aGUgaW50ZWdyYXRpb24gbWFuYWdlciBzbyB0aGF0XG4gICAgICAgICAgICAvLyBpdCBnZXRzIHRoZSBzYW1lIGJhc2ljIHNpemUgYXMgdGhlIElNJ3Mgb3duIG1vZGFsLlxuICAgICAgICAgICAgcmV0dXJuIGRpYWxvZ1Rlcm1zSW50ZXJhY3Rpb25DYWxsYmFjayhcbiAgICAgICAgICAgICAgICBwb2xpY3lJbmZvLCBhZ3JlZWRVcmxzLCAnbXhfVGVybXNEaWFsb2dfZm9ySW50ZWdyYXRpb25NYW5hZ2VyJyxcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IG5ld1Byb3BzID0ge307XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCBjbGllbnQuY29ubmVjdCgpO1xuICAgICAgICAgICAgaWYgKCFjbGllbnQuaGFzQ3JlZGVudGlhbHMoKSkge1xuICAgICAgICAgICAgICAgIG5ld1Byb3BzW1wiY29ubmVjdGVkXCJdID0gZmFsc2U7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG5ld1Byb3BzW1widXJsXCJdID0gY2xpZW50LmdldFNjYWxhckludGVyZmFjZVVybEZvclJvb20ocm9vbSwgc2NyZWVuLCBpbnRlZ3JhdGlvbklkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgaWYgKGUgaW5zdGFuY2VvZiBUZXJtc05vdFNpZ25lZEVycm9yKSB7XG4gICAgICAgICAgICAgICAgZGlhbG9nLmNsb3NlKCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoZSk7XG4gICAgICAgICAgICBuZXdQcm9wc1tcImNvbm5lY3RlZFwiXSA9IGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQ2xvc2UgdGhlIG9sZCBkaWFsb2cgYW5kIG9wZW4gYSBuZXcgb25lXG4gICAgICAgIGRpYWxvZy5jbG9zZSgpO1xuICAgICAgICBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nKFxuICAgICAgICAgICAgJ0ludGVncmF0aW9uIE1hbmFnZXInLCAnJywgSW50ZWdyYXRpb25NYW5hZ2VyLFxuICAgICAgICAgICAgbmV3UHJvcHMsICdteF9JbnRlZ3JhdGlvbk1hbmFnZXInLFxuICAgICAgICApO1xuICAgIH1cbn1cbiJdfQ==