"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.IntegrationManagers = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _SdkConfig = _interopRequireDefault(require("../SdkConfig"));

var _Modal = _interopRequireDefault(require("../Modal"));

var _IntegrationManagerInstance = require("./IntegrationManagerInstance");

var _IntegrationsImpossibleDialog = _interopRequireDefault(require("../components/views/dialogs/IntegrationsImpossibleDialog"));

var _TabbedIntegrationManagerDialog = _interopRequireDefault(require("../components/views/dialogs/TabbedIntegrationManagerDialog"));

var _IntegrationsDisabledDialog = _interopRequireDefault(require("../components/views/dialogs/IntegrationsDisabledDialog"));

var _WidgetUtils = _interopRequireDefault(require("../utils/WidgetUtils"));

var _MatrixClientPeg = require("../MatrixClientPeg");

var _SettingsStore = _interopRequireDefault(require("../settings/SettingsStore"));

var _url = _interopRequireDefault(require("url"));

var _strings = require("../utils/strings");

var _logger = require("matrix-js-sdk/src/logger");

/*
Copyright 2019 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const KIND_PREFERENCE = [// Ordered: first is most preferred, last is least preferred.
_IntegrationManagerInstance.Kind.Account, _IntegrationManagerInstance.Kind.Homeserver, _IntegrationManagerInstance.Kind.Config];

class IntegrationManagers {
  static sharedInstance() {
    if (!IntegrationManagers.instance) {
      IntegrationManagers.instance = new IntegrationManagers();
    }

    return IntegrationManagers.instance;
  }

  constructor() {
    (0, _defineProperty2.default)(this, "managers", []);
    (0, _defineProperty2.default)(this, "client", void 0);
    (0, _defineProperty2.default)(this, "primaryManager", void 0);
    (0, _defineProperty2.default)(this, "setupHomeserverManagers", async discoveryResponse => {
      _logger.logger.log("Updating homeserver-configured integration managers...");

      if (discoveryResponse && discoveryResponse['m.integrations']) {
        let managers = discoveryResponse['m.integrations']['managers'];
        if (!Array.isArray(managers)) managers = []; // make it an array so we can wipe the HS managers

        _logger.logger.log(`Homeserver has ${managers.length} integration managers`); // Clear out any known managers for the homeserver
        // TODO: Log out of the scalar clients


        this.managers = this.managers.filter(m => m.kind !== _IntegrationManagerInstance.Kind.Homeserver); // Now add all the managers the homeserver wants us to have

        for (const hsManager of managers) {
          if (!hsManager["api_url"]) continue;
          this.managers.push(new _IntegrationManagerInstance.IntegrationManagerInstance(_IntegrationManagerInstance.Kind.Homeserver, hsManager["api_url"], hsManager["ui_url"]));
        }

        this.primaryManager = null; // reset primary
      } else {
        _logger.logger.log("Homeserver has no integration managers");
      }
    });
    (0, _defineProperty2.default)(this, "onAccountData", ev => {
      if (ev.getType() === 'm.widgets') {
        this.compileManagers();
      }
    });
    this.compileManagers();
  }

  startWatching() {
    this.stopWatching();
    this.client = _MatrixClientPeg.MatrixClientPeg.get();
    this.client.on("accountData", this.onAccountData);
    this.client.on("WellKnown.client", this.setupHomeserverManagers);
    this.compileManagers();
  }

  stopWatching() {
    if (!this.client) return;
    this.client.removeListener("accountData", this.onAccountData);
    this.client.removeListener("WellKnown.client", this.setupHomeserverManagers);
  }

  compileManagers() {
    this.managers = [];
    this.setupConfiguredManager();
    this.setupAccountManagers();
  }

  setupConfiguredManager() {
    const apiUrl = _SdkConfig.default.get()['integrations_rest_url'];

    const uiUrl = _SdkConfig.default.get()['integrations_ui_url'];

    if (apiUrl && uiUrl) {
      this.managers.push(new _IntegrationManagerInstance.IntegrationManagerInstance(_IntegrationManagerInstance.Kind.Config, apiUrl, uiUrl));
      this.primaryManager = null; // reset primary
    }
  }

  setupAccountManagers() {
    if (!this.client || !this.client.getUserId()) return; // not logged in

    const widgets = _WidgetUtils.default.getIntegrationManagerWidgets();

    widgets.forEach(w => {
      const data = w.content['data'];
      if (!data) return;
      const uiUrl = w.content['url'];
      const apiUrl = data['api_url'];
      if (!apiUrl || !uiUrl) return;
      const manager = new _IntegrationManagerInstance.IntegrationManagerInstance(_IntegrationManagerInstance.Kind.Account, apiUrl, uiUrl, w['id'] || w['state_key'] || '');
      this.managers.push(manager);
    });
    this.primaryManager = null; // reset primary
  }

  hasManager() {
    return this.managers.length > 0;
  }

  getOrderedManagers() {
    const ordered = [];

    for (const kind of KIND_PREFERENCE) {
      const managers = this.managers.filter(m => m.kind === kind);
      if (!managers || !managers.length) continue;

      if (kind === _IntegrationManagerInstance.Kind.Account) {
        // Order by state_keys (IDs)
        managers.sort((a, b) => (0, _strings.compare)(a.id, b.id));
      }

      ordered.push(...managers);
    }

    return ordered;
  }

  getPrimaryManager() {
    if (this.hasManager()) {
      if (this.primaryManager) return this.primaryManager;
      this.primaryManager = this.getOrderedManagers()[0];
      return this.primaryManager;
    } else {
      return null;
    }
  }

  openNoManagerDialog() {
    _Modal.default.createTrackedDialog('Integrations impossible', '', _IntegrationsImpossibleDialog.default);
  }

  openAll(room = null, screen = null, integrationId = null) {
    if (!_SettingsStore.default.getValue("integrationProvisioning")) {
      return this.showDisabledDialog();
    }

    if (this.managers.length === 0) {
      return this.openNoManagerDialog();
    }

    _Modal.default.createTrackedDialog('Tabbed Integration Manager', '', _TabbedIntegrationManagerDialog.default, {
      room,
      screen,
      integrationId
    }, 'mx_TabbedIntegrationManagerDialog');
  }

  showDisabledDialog() {
    _Modal.default.createTrackedDialog('Integrations disabled', '', _IntegrationsDisabledDialog.default);
  }

  async overwriteManagerOnAccount(manager) {
    // TODO: TravisR - We should be logging out of scalar clients.
    await _WidgetUtils.default.removeIntegrationManagerWidgets(); // TODO: TravisR - We should actually be carrying over the discovery response verbatim.

    await _WidgetUtils.default.addIntegrationManagerWidget(manager.name, manager.uiUrl, manager.apiUrl);
  }
  /**
   * Attempts to discover an integration manager using only its name. This will not validate that
   * the integration manager is functional - that is the caller's responsibility.
   * @param {string} domainName The domain name to look up.
   * @returns {Promise<IntegrationManagerInstance>} Resolves to an integration manager instance,
   * or null if none was found.
   */


  async tryDiscoverManager(domainName) {
    _logger.logger.log("Looking up integration manager via .well-known");

    if (domainName.startsWith("http:") || domainName.startsWith("https:")) {
      // trim off the scheme and just use the domain
      domainName = _url.default.parse(domainName).host;
    }

    let wkConfig;

    try {
      const result = await fetch(`https://${domainName}/.well-known/matrix/integrations`);
      wkConfig = await result.json();
    } catch (e) {
      _logger.logger.error(e);

      _logger.logger.warn("Failed to locate integration manager");

      return null;
    }

    if (!wkConfig || !wkConfig["m.integrations_widget"]) {
      _logger.logger.warn("Missing integrations widget on .well-known response");

      return null;
    }

    const widget = wkConfig["m.integrations_widget"];

    if (!widget["url"] || !widget["data"] || !widget["data"]["api_url"]) {
      _logger.logger.warn("Malformed .well-known response for integrations widget");

      return null;
    } // All discovered managers are per-user managers


    const manager = new _IntegrationManagerInstance.IntegrationManagerInstance(_IntegrationManagerInstance.Kind.Account, widget["data"]["api_url"], widget["url"]);

    _logger.logger.log("Got an integration manager (untested)"); // We don't test the manager because the caller may need to do extra
    // checks or similar with it. For instance, they may need to deal with
    // terms of service or want to call something particular.


    return manager;
  }

} // For debugging


exports.IntegrationManagers = IntegrationManagers;
(0, _defineProperty2.default)(IntegrationManagers, "instance", void 0);
window.mxIntegrationManagers = IntegrationManagers;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9pbnRlZ3JhdGlvbnMvSW50ZWdyYXRpb25NYW5hZ2Vycy50cyJdLCJuYW1lcyI6WyJLSU5EX1BSRUZFUkVOQ0UiLCJLaW5kIiwiQWNjb3VudCIsIkhvbWVzZXJ2ZXIiLCJDb25maWciLCJJbnRlZ3JhdGlvbk1hbmFnZXJzIiwic2hhcmVkSW5zdGFuY2UiLCJpbnN0YW5jZSIsImNvbnN0cnVjdG9yIiwiZGlzY292ZXJ5UmVzcG9uc2UiLCJsb2dnZXIiLCJsb2ciLCJtYW5hZ2VycyIsIkFycmF5IiwiaXNBcnJheSIsImxlbmd0aCIsImZpbHRlciIsIm0iLCJraW5kIiwiaHNNYW5hZ2VyIiwicHVzaCIsIkludGVncmF0aW9uTWFuYWdlckluc3RhbmNlIiwicHJpbWFyeU1hbmFnZXIiLCJldiIsImdldFR5cGUiLCJjb21waWxlTWFuYWdlcnMiLCJzdGFydFdhdGNoaW5nIiwic3RvcFdhdGNoaW5nIiwiY2xpZW50IiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0Iiwib24iLCJvbkFjY291bnREYXRhIiwic2V0dXBIb21lc2VydmVyTWFuYWdlcnMiLCJyZW1vdmVMaXN0ZW5lciIsInNldHVwQ29uZmlndXJlZE1hbmFnZXIiLCJzZXR1cEFjY291bnRNYW5hZ2VycyIsImFwaVVybCIsIlNka0NvbmZpZyIsInVpVXJsIiwiZ2V0VXNlcklkIiwid2lkZ2V0cyIsIldpZGdldFV0aWxzIiwiZ2V0SW50ZWdyYXRpb25NYW5hZ2VyV2lkZ2V0cyIsImZvckVhY2giLCJ3IiwiZGF0YSIsImNvbnRlbnQiLCJtYW5hZ2VyIiwiaGFzTWFuYWdlciIsImdldE9yZGVyZWRNYW5hZ2VycyIsIm9yZGVyZWQiLCJzb3J0IiwiYSIsImIiLCJpZCIsImdldFByaW1hcnlNYW5hZ2VyIiwib3Blbk5vTWFuYWdlckRpYWxvZyIsIk1vZGFsIiwiY3JlYXRlVHJhY2tlZERpYWxvZyIsIkludGVncmF0aW9uc0ltcG9zc2libGVEaWFsb2ciLCJvcGVuQWxsIiwicm9vbSIsInNjcmVlbiIsImludGVncmF0aW9uSWQiLCJTZXR0aW5nc1N0b3JlIiwiZ2V0VmFsdWUiLCJzaG93RGlzYWJsZWREaWFsb2ciLCJUYWJiZWRJbnRlZ3JhdGlvbk1hbmFnZXJEaWFsb2ciLCJJbnRlZ3JhdGlvbnNEaXNhYmxlZERpYWxvZyIsIm92ZXJ3cml0ZU1hbmFnZXJPbkFjY291bnQiLCJyZW1vdmVJbnRlZ3JhdGlvbk1hbmFnZXJXaWRnZXRzIiwiYWRkSW50ZWdyYXRpb25NYW5hZ2VyV2lkZ2V0IiwibmFtZSIsInRyeURpc2NvdmVyTWFuYWdlciIsImRvbWFpbk5hbWUiLCJzdGFydHNXaXRoIiwidXJsIiwicGFyc2UiLCJob3N0Iiwid2tDb25maWciLCJyZXN1bHQiLCJmZXRjaCIsImpzb24iLCJlIiwiZXJyb3IiLCJ3YXJuIiwid2lkZ2V0Iiwid2luZG93IiwibXhJbnRlZ3JhdGlvbk1hbmFnZXJzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQW9CQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFoQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBb0JBLE1BQU1BLGVBQWUsR0FBRyxDQUNwQjtBQUNBQyxpQ0FBS0MsT0FGZSxFQUdwQkQsaUNBQUtFLFVBSGUsRUFJcEJGLGlDQUFLRyxNQUplLENBQXhCOztBQU9PLE1BQU1DLG1CQUFOLENBQTBCO0FBT0QsU0FBZEMsY0FBYyxHQUF3QjtBQUNoRCxRQUFJLENBQUNELG1CQUFtQixDQUFDRSxRQUF6QixFQUFtQztBQUMvQkYsTUFBQUEsbUJBQW1CLENBQUNFLFFBQXBCLEdBQStCLElBQUlGLG1CQUFKLEVBQS9CO0FBQ0g7O0FBQ0QsV0FBT0EsbUJBQW1CLENBQUNFLFFBQTNCO0FBQ0g7O0FBRURDLEVBQUFBLFdBQVcsR0FBRztBQUFBLG9EQVhtQyxFQVduQztBQUFBO0FBQUE7QUFBQSxtRUFrQ29C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QUNqRHRFLHFCQUFPNEUsSUFBUCxDQUFZLHFEQUFaOztBQUNBLGFBQU8sSUFBUDtBQUNIOztBQUVELFVBQU1DLE1BQU0sR0FBR1AsUUFBUSxDQUFDLHVCQUFELENBQXZCOztBQUNBLFFBQUksQ0FBQ08sTUFBTSxDQUFDLEtBQUQsQ0FBUCxJQUFrQixDQUFDQSxNQUFNLENBQUMsTUFBRCxDQUF6QixJQUFxQyxDQUFDQSxNQUFNLENBQUMsTUFBRCxDQUFOLENBQWUsU0FBZixDQUExQyxFQUFxRTtBQUNqRTdFLHFCQUFPNEUsSUFBUCxDQUFZLHdEQUFaOztBQUNBLGFBQU8sSUFBUDtBQUNILEtBMUI2RSxDQTRCOUU7OztBQUNBLFVBQU10QyxPQUFPLEdBQUcsSUFBSTNCLHNEQUFKLENBQStCcEIsaUNBQUtDLE9BQXBDLEVBQTZDcUYsTUFBTSxDQUFDLE1BQUQsQ0FBTixDQUFlLFNBQWYsQ0FBN0MsRUFBd0VBLE1BQU0sQ0FBQyxLQUFELENBQTlFLENBQWhCOztBQUNBN0UsbUJBQU9DLEdBQVAsQ0FBVyx1Q0FBWCxFQTlCOEUsQ0FnQzlFO0FBQ0E7QUFDQTs7O0FBRUEsV0FBT3FDLE9BQVA7QUFDSDs7QUFsTjRCLEMsQ0FxTmpDOzs7OzhCQXJOYTNDLG1CO0FBc05ibUYsTUFBTSxDQUFDQyxxQkFBUCxHQUErQnBGLG1CQUEvQiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxOSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCB0eXBlIHsgTWF0cml4Q2xpZW50IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2NsaWVudFwiO1xuaW1wb3J0IHR5cGUgeyBNYXRyaXhFdmVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvZXZlbnRcIjtcbmltcG9ydCB0eXBlIHsgUm9vbSB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvcm9vbVwiO1xuXG5pbXBvcnQgU2RrQ29uZmlnIGZyb20gJy4uL1Nka0NvbmZpZyc7XG5pbXBvcnQgTW9kYWwgZnJvbSAnLi4vTW9kYWwnO1xuaW1wb3J0IHsgSW50ZWdyYXRpb25NYW5hZ2VySW5zdGFuY2UsIEtpbmQgfSBmcm9tIFwiLi9JbnRlZ3JhdGlvbk1hbmFnZXJJbnN0YW5jZVwiO1xuaW1wb3J0IEludGVncmF0aW9uc0ltcG9zc2libGVEaWFsb2cgZnJvbSBcIi4uL2NvbXBvbmVudHMvdmlld3MvZGlhbG9ncy9JbnRlZ3JhdGlvbnNJbXBvc3NpYmxlRGlhbG9nXCI7XG5pbXBvcnQgVGFiYmVkSW50ZWdyYXRpb25NYW5hZ2VyRGlhbG9nIGZyb20gXCIuLi9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvVGFiYmVkSW50ZWdyYXRpb25NYW5hZ2VyRGlhbG9nXCI7XG5pbXBvcnQgSW50ZWdyYXRpb25zRGlzYWJsZWREaWFsb2cgZnJvbSBcIi4uL2NvbXBvbmVudHMvdmlld3MvZGlhbG9ncy9JbnRlZ3JhdGlvbnNEaXNhYmxlZERpYWxvZ1wiO1xuaW1wb3J0IFdpZGdldFV0aWxzIGZyb20gXCIuLi91dGlscy9XaWRnZXRVdGlsc1wiO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSBcIi4uL01hdHJpeENsaWVudFBlZ1wiO1xuaW1wb3J0IFNldHRpbmdzU3RvcmUgZnJvbSBcIi4uL3NldHRpbmdzL1NldHRpbmdzU3RvcmVcIjtcbmltcG9ydCB1cmwgZnJvbSAndXJsJztcbmltcG9ydCB7IGNvbXBhcmUgfSBmcm9tIFwiLi4vdXRpbHMvc3RyaW5nc1wiO1xuXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbG9nZ2VyXCI7XG5cbmNvbnN0IEtJTkRfUFJFRkVSRU5DRSA9IFtcbiAgICAvLyBPcmRlcmVkOiBmaXJzdCBpcyBtb3N0IHByZWZlcnJlZCwgbGFzdCBpcyBsZWFzdCBwcmVmZXJyZWQuXG4gICAgS2luZC5BY2NvdW50LFxuICAgIEtpbmQuSG9tZXNlcnZlcixcbiAgICBLaW5kLkNvbmZpZyxcbl07XG5cbmV4cG9ydCBjbGFzcyBJbnRlZ3JhdGlvbk1hbmFnZXJzIHtcbiAgICBwcml2YXRlIHN0YXRpYyBpbnN0YW5jZTtcblxuICAgIHByaXZhdGUgbWFuYWdlcnM6IEludGVncmF0aW9uTWFuYWdlckluc3RhbmNlW10gPSBbXTtcbiAgICBwcml2YXRlIGNsaWVudDogTWF0cml4Q2xpZW50O1xuICAgIHByaXZhdGUgcHJpbWFyeU1hbmFnZXI6IEludGVncmF0aW9uTWFuYWdlckluc3RhbmNlO1xuXG4gICAgcHVibGljIHN0YXRpYyBzaGFyZWRJbnN0YW5jZSgpOiBJbnRlZ3JhdGlvbk1hbmFnZXJzIHtcbiAgICAgICAgaWYgKCFJbnRlZ3JhdGlvbk1hbmFnZXJzLmluc3RhbmNlKSB7XG4gICAgICAgICAgICBJbnRlZ3JhdGlvbk1hbmFnZXJzLmluc3RhbmNlID0gbmV3IEludGVncmF0aW9uTWFuYWdlcnMoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gSW50ZWdyYXRpb25NYW5hZ2Vycy5pbnN0YW5jZTtcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy5jb21waWxlTWFuYWdlcnMoKTtcbiAgICB9XG5cbiAgICBzdGFydFdhdGNoaW5nKCk6IHZvaWQge1xuICAgICAgICB0aGlzLnN0b3BXYXRjaGluZygpO1xuICAgICAgICB0aGlzLmNsaWVudCA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICAgICAgdGhpcy5jbGllbnQub24oXCJhY2NvdW50RGF0YVwiLCB0aGlzLm9uQWNjb3VudERhdGEpO1xuICAgICAgICB0aGlzLmNsaWVudC5vbihcIldlbGxLbm93bi5jbGllbnRcIiwgdGhpcy5zZXR1cEhvbWVzZXJ2ZXJNYW5hZ2Vycyk7XG4gICAgICAgIHRoaXMuY29tcGlsZU1hbmFnZXJzKCk7XG4gICAgfVxuXG4gICAgc3RvcFdhdGNoaW5nKCk6IHZvaWQge1xuICAgICAgICBpZiAoIXRoaXMuY2xpZW50KSByZXR1cm47XG4gICAgICAgIHRoaXMuY2xpZW50LnJlbW92ZUxpc3RlbmVyKFwiYWNjb3VudERhdGFcIiwgdGhpcy5vbkFjY291bnREYXRhKTtcbiAgICAgICAgdGhpcy5jbGllbnQucmVtb3ZlTGlzdGVuZXIoXCJXZWxsS25vd24uY2xpZW50XCIsIHRoaXMuc2V0dXBIb21lc2VydmVyTWFuYWdlcnMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgY29tcGlsZU1hbmFnZXJzKCkge1xuICAgICAgICB0aGlzLm1hbmFnZXJzID0gW107XG4gICAgICAgIHRoaXMuc2V0dXBDb25maWd1cmVkTWFuYWdlcigpO1xuICAgICAgICB0aGlzLnNldHVwQWNjb3VudE1hbmFnZXJzKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzZXR1cENvbmZpZ3VyZWRNYW5hZ2VyKCkge1xuICAgICAgICBjb25zdCBhcGlVcmw6IHN0cmluZyA9IFNka0NvbmZpZy5nZXQoKVsnaW50ZWdyYXRpb25zX3Jlc3RfdXJsJ107XG4gICAgICAgIGNvbnN0IHVpVXJsOiBzdHJpbmcgPSBTZGtDb25maWcuZ2V0KClbJ2ludGVncmF0aW9uc191aV91cmwnXTtcblxuICAgICAgICBpZiAoYXBpVXJsICYmIHVpVXJsKSB7XG4gICAgICAgICAgICB0aGlzLm1hbmFnZXJzLnB1c2gobmV3IEludGVncmF0aW9uTWFuYWdlckluc3RhbmNlKEtpbmQuQ29uZmlnLCBhcGlVcmwsIHVpVXJsKSk7XG4gICAgICAgICAgICB0aGlzLnByaW1hcnlNYW5hZ2VyID0gbnVsbDsgLy8gcmVzZXQgcHJpbWFyeVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzZXR1cEhvbWVzZXJ2ZXJNYW5hZ2VycyA9IGFzeW5jIChkaXNjb3ZlcnlSZXNwb25zZSkgPT4ge1xuICAgICAgICBsb2dnZXIubG9nKFwiVXBkYXRpbmcgaG9tZXNlcnZlci1jb25maWd1cmVkIGludGVncmF0aW9uIG1hbmFnZXJzLi4uXCIpO1xuICAgICAgICBpZiAoZGlzY292ZXJ5UmVzcG9uc2UgJiYgZGlzY292ZXJ5UmVzcG9uc2VbJ20uaW50ZWdyYXRpb25zJ10pIHtcbiAgICAgICAgICAgIGxldCBtYW5hZ2VycyA9IGRpc2NvdmVyeVJlc3BvbnNlWydtLmludGVncmF0aW9ucyddWydtYW5hZ2VycyddO1xuICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG1hbmFnZXJzKSkgbWFuYWdlcnMgPSBbXTsgLy8gbWFrZSBpdCBhbiBhcnJheSBzbyB3ZSBjYW4gd2lwZSB0aGUgSFMgbWFuYWdlcnNcblxuICAgICAgICAgICAgbG9nZ2VyLmxvZyhgSG9tZXNlcnZlciBoYXMgJHttYW5hZ2Vycy5sZW5ndGh9IGludGVncmF0aW9uIG1hbmFnZXJzYCk7XG5cbiAgICAgICAgICAgIC8vIENsZWFyIG91dCBhbnkga25vd24gbWFuYWdlcnMgZm9yIHRoZSBob21lc2VydmVyXG4gICAgICAgICAgICAvLyBUT0RPOiBMb2cgb3V0IG9mIHRoZSBzY2FsYXIgY2xpZW50c1xuICAgICAgICAgICAgdGhpcy5tYW5hZ2VycyA9IHRoaXMubWFuYWdlcnMuZmlsdGVyKG0gPT4gbS5raW5kICE9PSBLaW5kLkhvbWVzZXJ2ZXIpO1xuXG4gICAgICAgICAgICAvLyBOb3cgYWRkIGFsbCB0aGUgbWFuYWdlcnMgdGhlIGhvbWVzZXJ2ZXIgd2FudHMgdXMgdG8gaGF2ZVxuICAgICAgICAgICAgZm9yIChjb25zdCBoc01hbmFnZXIgb2YgbWFuYWdlcnMpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWhzTWFuYWdlcltcImFwaV91cmxcIl0pIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIHRoaXMubWFuYWdlcnMucHVzaChuZXcgSW50ZWdyYXRpb25NYW5hZ2VySW5zdGFuY2UoXG4gICAgICAgICAgICAgICAgICAgIEtpbmQuSG9tZXNlcnZlcixcbiAgICAgICAgICAgICAgICAgICAgaHNNYW5hZ2VyW1wiYXBpX3VybFwiXSxcbiAgICAgICAgICAgICAgICAgICAgaHNNYW5hZ2VyW1widWlfdXJsXCJdLCAvLyBvcHRpb25hbFxuICAgICAgICAgICAgICAgICkpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLnByaW1hcnlNYW5hZ2VyID0gbnVsbDsgLy8gcmVzZXQgcHJpbWFyeVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbG9nZ2VyLmxvZyhcIkhvbWVzZXJ2ZXIgaGFzIG5vIGludGVncmF0aW9uIG1hbmFnZXJzXCIpO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIHByaXZhdGUgc2V0dXBBY2NvdW50TWFuYWdlcnMoKSB7XG4gICAgICAgIGlmICghdGhpcy5jbGllbnQgfHwgIXRoaXMuY2xpZW50LmdldFVzZXJJZCgpKSByZXR1cm47IC8vIG5vdCBsb2dnZWQgaW5cbiAgICAgICAgY29uc3Qgd2lkZ2V0cyA9IFdpZGdldFV0aWxzLmdldEludGVncmF0aW9uTWFuYWdlcldpZGdldHMoKTtcbiAgICAgICAgd2lkZ2V0cy5mb3JFYWNoKHcgPT4ge1xuICAgICAgICAgICAgY29uc3QgZGF0YSA9IHcuY29udGVudFsnZGF0YSddO1xuICAgICAgICAgICAgaWYgKCFkYXRhKSByZXR1cm47XG5cbiAgICAgICAgICAgIGNvbnN0IHVpVXJsID0gdy5jb250ZW50Wyd1cmwnXTtcbiAgICAgICAgICAgIGNvbnN0IGFwaVVybCA9IGRhdGFbJ2FwaV91cmwnXSBhcyBzdHJpbmc7XG4gICAgICAgICAgICBpZiAoIWFwaVVybCB8fCAhdWlVcmwpIHJldHVybjtcblxuICAgICAgICAgICAgY29uc3QgbWFuYWdlciA9IG5ldyBJbnRlZ3JhdGlvbk1hbmFnZXJJbnN0YW5jZShcbiAgICAgICAgICAgICAgICBLaW5kLkFjY291bnQsXG4gICAgICAgICAgICAgICAgYXBpVXJsLFxuICAgICAgICAgICAgICAgIHVpVXJsLFxuICAgICAgICAgICAgICAgIHdbJ2lkJ10gfHwgd1snc3RhdGVfa2V5J10gfHwgJycsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgdGhpcy5tYW5hZ2Vycy5wdXNoKG1hbmFnZXIpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5wcmltYXJ5TWFuYWdlciA9IG51bGw7IC8vIHJlc2V0IHByaW1hcnlcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uQWNjb3VudERhdGEgPSAoZXY6IE1hdHJpeEV2ZW50KTogdm9pZCA9PiB7XG4gICAgICAgIGlmIChldi5nZXRUeXBlKCkgPT09ICdtLndpZGdldHMnKSB7XG4gICAgICAgICAgICB0aGlzLmNvbXBpbGVNYW5hZ2VycygpO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIGhhc01hbmFnZXIoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLm1hbmFnZXJzLmxlbmd0aCA+IDA7XG4gICAgfVxuXG4gICAgZ2V0T3JkZXJlZE1hbmFnZXJzKCk6IEludGVncmF0aW9uTWFuYWdlckluc3RhbmNlW10ge1xuICAgICAgICBjb25zdCBvcmRlcmVkID0gW107XG4gICAgICAgIGZvciAoY29uc3Qga2luZCBvZiBLSU5EX1BSRUZFUkVOQ0UpIHtcbiAgICAgICAgICAgIGNvbnN0IG1hbmFnZXJzID0gdGhpcy5tYW5hZ2Vycy5maWx0ZXIobSA9PiBtLmtpbmQgPT09IGtpbmQpO1xuICAgICAgICAgICAgaWYgKCFtYW5hZ2VycyB8fCAhbWFuYWdlcnMubGVuZ3RoKSBjb250aW51ZTtcblxuICAgICAgICAgICAgaWYgKGtpbmQgPT09IEtpbmQuQWNjb3VudCkge1xuICAgICAgICAgICAgICAgIC8vIE9yZGVyIGJ5IHN0YXRlX2tleXMgKElEcylcbiAgICAgICAgICAgICAgICBtYW5hZ2Vycy5zb3J0KChhLCBiKSA9PiBjb21wYXJlKGEuaWQsIGIuaWQpKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgb3JkZXJlZC5wdXNoKC4uLm1hbmFnZXJzKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gb3JkZXJlZDtcbiAgICB9XG5cbiAgICBnZXRQcmltYXJ5TWFuYWdlcigpOiBJbnRlZ3JhdGlvbk1hbmFnZXJJbnN0YW5jZSB7XG4gICAgICAgIGlmICh0aGlzLmhhc01hbmFnZXIoKSkge1xuICAgICAgICAgICAgaWYgKHRoaXMucHJpbWFyeU1hbmFnZXIpIHJldHVybiB0aGlzLnByaW1hcnlNYW5hZ2VyO1xuXG4gICAgICAgICAgICB0aGlzLnByaW1hcnlNYW5hZ2VyID0gdGhpcy5nZXRPcmRlcmVkTWFuYWdlcnMoKVswXTtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnByaW1hcnlNYW5hZ2VyO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBvcGVuTm9NYW5hZ2VyRGlhbG9nKCk6IHZvaWQge1xuICAgICAgICBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nKCdJbnRlZ3JhdGlvbnMgaW1wb3NzaWJsZScsICcnLCBJbnRlZ3JhdGlvbnNJbXBvc3NpYmxlRGlhbG9nKTtcbiAgICB9XG5cbiAgICBvcGVuQWxsKHJvb206IFJvb20gPSBudWxsLCBzY3JlZW46IHN0cmluZyA9IG51bGwsIGludGVncmF0aW9uSWQ6IHN0cmluZyA9IG51bGwpOiB2b2lkIHtcbiAgICAgICAgaWYgKCFTZXR0aW5nc1N0b3JlLmdldFZhbHVlKFwiaW50ZWdyYXRpb25Qcm92aXNpb25pbmdcIikpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnNob3dEaXNhYmxlZERpYWxvZygpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMubWFuYWdlcnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5vcGVuTm9NYW5hZ2VyRGlhbG9nKCk7XG4gICAgICAgIH1cblxuICAgICAgICBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nKFxuICAgICAgICAgICAgJ1RhYmJlZCBJbnRlZ3JhdGlvbiBNYW5hZ2VyJywgJycsIFRhYmJlZEludGVncmF0aW9uTWFuYWdlckRpYWxvZyxcbiAgICAgICAgICAgIHsgcm9vbSwgc2NyZWVuLCBpbnRlZ3JhdGlvbklkIH0sICdteF9UYWJiZWRJbnRlZ3JhdGlvbk1hbmFnZXJEaWFsb2cnLFxuICAgICAgICApO1xuICAgIH1cblxuICAgIHNob3dEaXNhYmxlZERpYWxvZygpOiB2b2lkIHtcbiAgICAgICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZygnSW50ZWdyYXRpb25zIGRpc2FibGVkJywgJycsIEludGVncmF0aW9uc0Rpc2FibGVkRGlhbG9nKTtcbiAgICB9XG5cbiAgICBhc3luYyBvdmVyd3JpdGVNYW5hZ2VyT25BY2NvdW50KG1hbmFnZXI6IEludGVncmF0aW9uTWFuYWdlckluc3RhbmNlKSB7XG4gICAgICAgIC8vIFRPRE86IFRyYXZpc1IgLSBXZSBzaG91bGQgYmUgbG9nZ2luZyBvdXQgb2Ygc2NhbGFyIGNsaWVudHMuXG4gICAgICAgIGF3YWl0IFdpZGdldFV0aWxzLnJlbW92ZUludGVncmF0aW9uTWFuYWdlcldpZGdldHMoKTtcblxuICAgICAgICAvLyBUT0RPOiBUcmF2aXNSIC0gV2Ugc2hvdWxkIGFjdHVhbGx5IGJlIGNhcnJ5aW5nIG92ZXIgdGhlIGRpc2NvdmVyeSByZXNwb25zZSB2ZXJiYXRpbS5cbiAgICAgICAgYXdhaXQgV2lkZ2V0VXRpbHMuYWRkSW50ZWdyYXRpb25NYW5hZ2VyV2lkZ2V0KG1hbmFnZXIubmFtZSwgbWFuYWdlci51aVVybCwgbWFuYWdlci5hcGlVcmwpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEF0dGVtcHRzIHRvIGRpc2NvdmVyIGFuIGludGVncmF0aW9uIG1hbmFnZXIgdXNpbmcgb25seSBpdHMgbmFtZS4gVGhpcyB3aWxsIG5vdCB2YWxpZGF0ZSB0aGF0XG4gICAgICogdGhlIGludGVncmF0aW9uIG1hbmFnZXIgaXMgZnVuY3Rpb25hbCAtIHRoYXQgaXMgdGhlIGNhbGxlcidzIHJlc3BvbnNpYmlsaXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBkb21haW5OYW1lIFRoZSBkb21haW4gbmFtZSB0byBsb29rIHVwLlxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlPEludGVncmF0aW9uTWFuYWdlckluc3RhbmNlPn0gUmVzb2x2ZXMgdG8gYW4gaW50ZWdyYXRpb24gbWFuYWdlciBpbnN0YW5jZSxcbiAgICAgKiBvciBudWxsIGlmIG5vbmUgd2FzIGZvdW5kLlxuICAgICAqL1xuICAgIGFzeW5jIHRyeURpc2NvdmVyTWFuYWdlcihkb21haW5OYW1lOiBzdHJpbmcpOiBQcm9taXNlPEludGVncmF0aW9uTWFuYWdlckluc3RhbmNlPiB7XG4gICAgICAgIGxvZ2dlci5sb2coXCJMb29raW5nIHVwIGludGVncmF0aW9uIG1hbmFnZXIgdmlhIC53ZWxsLWtub3duXCIpO1xuICAgICAgICBpZiAoZG9tYWluTmFtZS5zdGFydHNXaXRoKFwiaHR0cDpcIikgfHwgZG9tYWluTmFtZS5zdGFydHNXaXRoKFwiaHR0cHM6XCIpKSB7XG4gICAgICAgICAgICAvLyB0cmltIG9mZiB0aGUgc2NoZW1lIGFuZCBqdXN0IHVzZSB0aGUgZG9tYWluXG4gICAgICAgICAgICBkb21haW5OYW1lID0gdXJsLnBhcnNlKGRvbWFpbk5hbWUpLmhvc3Q7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgd2tDb25maWc6IG9iamVjdDtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGZldGNoKGBodHRwczovLyR7ZG9tYWluTmFtZX0vLndlbGwta25vd24vbWF0cml4L2ludGVncmF0aW9uc2ApO1xuICAgICAgICAgICAgd2tDb25maWcgPSBhd2FpdCByZXN1bHQuanNvbigpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoZSk7XG4gICAgICAgICAgICBsb2dnZXIud2FybihcIkZhaWxlZCB0byBsb2NhdGUgaW50ZWdyYXRpb24gbWFuYWdlclwiKTtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF3a0NvbmZpZyB8fCAhd2tDb25maWdbXCJtLmludGVncmF0aW9uc193aWRnZXRcIl0pIHtcbiAgICAgICAgICAgIGxvZ2dlci53YXJuKFwiTWlzc2luZyBpbnRlZ3JhdGlvbnMgd2lkZ2V0IG9uIC53ZWxsLWtub3duIHJlc3BvbnNlXCIpO1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB3aWRnZXQgPSB3a0NvbmZpZ1tcIm0uaW50ZWdyYXRpb25zX3dpZGdldFwiXTtcbiAgICAgICAgaWYgKCF3aWRnZXRbXCJ1cmxcIl0gfHwgIXdpZGdldFtcImRhdGFcIl0gfHwgIXdpZGdldFtcImRhdGFcIl1bXCJhcGlfdXJsXCJdKSB7XG4gICAgICAgICAgICBsb2dnZXIud2FybihcIk1hbGZvcm1lZCAud2VsbC1rbm93biByZXNwb25zZSBmb3IgaW50ZWdyYXRpb25zIHdpZGdldFwiKTtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQWxsIGRpc2NvdmVyZWQgbWFuYWdlcnMgYXJlIHBlci11c2VyIG1hbmFnZXJzXG4gICAgICAgIGNvbnN0IG1hbmFnZXIgPSBuZXcgSW50ZWdyYXRpb25NYW5hZ2VySW5zdGFuY2UoS2luZC5BY2NvdW50LCB3aWRnZXRbXCJkYXRhXCJdW1wiYXBpX3VybFwiXSwgd2lkZ2V0W1widXJsXCJdKTtcbiAgICAgICAgbG9nZ2VyLmxvZyhcIkdvdCBhbiBpbnRlZ3JhdGlvbiBtYW5hZ2VyICh1bnRlc3RlZClcIik7XG5cbiAgICAgICAgLy8gV2UgZG9uJ3QgdGVzdCB0aGUgbWFuYWdlciBiZWNhdXNlIHRoZSBjYWxsZXIgbWF5IG5lZWQgdG8gZG8gZXh0cmFcbiAgICAgICAgLy8gY2hlY2tzIG9yIHNpbWlsYXIgd2l0aCBpdC4gRm9yIGluc3RhbmNlLCB0aGV5IG1heSBuZWVkIHRvIGRlYWwgd2l0aFxuICAgICAgICAvLyB0ZXJtcyBvZiBzZXJ2aWNlIG9yIHdhbnQgdG8gY2FsbCBzb21ldGhpbmcgcGFydGljdWxhci5cblxuICAgICAgICByZXR1cm4gbWFuYWdlcjtcbiAgICB9XG59XG5cbi8vIEZvciBkZWJ1Z2dpbmdcbndpbmRvdy5teEludGVncmF0aW9uTWFuYWdlcnMgPSBJbnRlZ3JhdGlvbk1hbmFnZXJzO1xuIl19