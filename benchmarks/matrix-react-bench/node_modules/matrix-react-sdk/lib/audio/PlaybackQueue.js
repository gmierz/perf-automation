"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.PlaybackQueue = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _Playback = require("./Playback");

var _AsyncStore = require("../stores/AsyncStore");

var _MatrixClientPeg = require("../MatrixClientPeg");

var _arrays = require("../utils/arrays");

var _PlaybackManager = require("./PlaybackManager");

var _EventUtils = require("../utils/EventUtils");

var _RoomViewStore = _interopRequireDefault(require("../stores/RoomViewStore"));

var _event = require("matrix-js-sdk/src/@types/event");

var _logger = require("matrix-js-sdk/src/logger");

/*
Copyright 2021 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

/**
 * Audio playback queue management for a given room. This keeps track of where the user
 * was at for each playback, what order the playbacks were played in, and triggers subsequent
 * playbacks.
 *
 * Currently this is only intended to be used by voice messages.
 *
 * The primary mechanics are:
 * * Persisted clock state for each playback instance (tied to Event ID).
 * * Limited memory of playback order (see code; not persisted).
 * * Autoplay of next eligible playback instance.
 */
class PlaybackQueue {
  // keyed by room ID
  // keyed by event ID
  // keyed by event ID
  // event IDs, last == current
  // event ID, broken out from above for ease of use
  // event IDs
  constructor(client, room) {
    this.client = client;
    this.room = room;
    (0, _defineProperty2.default)(this, "playbacks", new Map());
    (0, _defineProperty2.default)(this, "clockStates", new Map());
    (0, _defineProperty2.default)(this, "playbackIdOrder", []);
    (0, _defineProperty2.default)(this, "currentPlaybackId", void 0);
    (0, _defineProperty2.default)(this, "recentFullPlays", new Set());
    this.loadClocks();

    _RoomViewStore.default.addListener(() => {
      if (_RoomViewStore.default.getRoomId() === this.room.roomId) {
        // Reset the state of the playbacks before they start mounting and enqueuing updates.
        // We reset the entirety of the queue, including order, to ensure the user isn't left
        // confused with what order the messages are playing in.
        this.currentPlaybackId = null; // this in particular stops autoplay when the room is switched to

        this.recentFullPlays = new Set();
        this.playbackIdOrder = [];
      }
    });
  }

  static forRoom(roomId) {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    const room = cli.getRoom(roomId);
    if (!room) throw new Error("Unknown room");

    if (PlaybackQueue.queues.has(room.roomId)) {
      return PlaybackQueue.queues.get(room.roomId);
    }

    const queue = new PlaybackQueue(cli, room);
    PlaybackQueue.queues.set(room.roomId, queue);
    return queue;
  }

  persistClocks() {
    localStorage.setItem(`mx_voice_message_clocks_${this.room.roomId}`, JSON.stringify(Array.from(this.clockStates.entries())));
  }

  loadClocks() {
    const val = localStorage.getItem(`mx_voice_message_clocks_${this.room.roomId}`);

    if (!!val) {
      this.clockStates = new Map(JSON.parse(val));
    }
  }

  unsortedEnqueue(mxEvent, playback) {
    // We don't ever detach our listeners: we expect the Playback to clean up for us
    this.playbacks.set(mxEvent.getId(), playback);
    playback.on(_AsyncStore.UPDATE_EVENT, state => this.onPlaybackStateChange(playback, mxEvent, state));
    playback.clockInfo.liveData.onUpdate(clock => this.onPlaybackClock(playback, mxEvent, clock));
  }

  onPlaybackStateChange(playback, mxEvent, newState) {
    // Remember where the user got to in playback
    const wasLastPlaying = this.currentPlaybackId === mxEvent.getId();

    if (newState === _Playback.PlaybackState.Stopped && this.clockStates.has(mxEvent.getId()) && !wasLastPlaying) {
      // noinspection JSIgnoredPromiseFromCall
      playback.skipTo(this.clockStates.get(mxEvent.getId()));
    } else if (newState === _Playback.PlaybackState.Stopped) {
      // Remove the now-useless clock for some space savings
      this.clockStates.delete(mxEvent.getId());

      if (wasLastPlaying) {
        this.recentFullPlays.add(this.currentPlaybackId);
        const orderClone = (0, _arrays.arrayFastClone)(this.playbackIdOrder);
        const last = orderClone.pop();

        if (last === this.currentPlaybackId) {
          const next = orderClone.pop();

          if (next) {
            const instance = this.playbacks.get(next);

            if (!instance) {
              _logger.logger.warn("Voice message queue desync: Missing playback for next message: " + `Current=${this.currentPlaybackId} Last=${last} Next=${next}`);
            } else {
              this.playbackIdOrder = orderClone;

              _PlaybackManager.PlaybackManager.instance.pauseAllExcept(instance); // This should cause a Play event, which will re-populate our playback order
              // and update our current playback ID.
              // noinspection JSIgnoredPromiseFromCall


              instance.play();
            }
          } else {
            // else no explicit next event, so find an event we haven't played that comes next. The live
            // timeline is already most recent last, so we can iterate down that.
            const timeline = (0, _arrays.arrayFastClone)(this.room.getLiveTimeline().getEvents());
            let scanForVoiceMessage = false;
            let nextEv;

            for (const event of timeline) {
              if (event.getId() === mxEvent.getId()) {
                scanForVoiceMessage = true;
                continue;
              }

              if (!scanForVoiceMessage) continue;

              if (!(0, _EventUtils.isVoiceMessage)(event)) {
                const evType = event.getType();

                if (evType !== _event.EventType.RoomMessage && evType !== _event.EventType.Sticker) {
                  continue; // Event can be skipped for automatic playback consideration
                }

                break; // Stop automatic playback: next useful event is not a voice message
              }

              const havePlayback = this.playbacks.has(event.getId());
              const isRecentlyCompleted = this.recentFullPlays.has(event.getId());

              if (havePlayback && !isRecentlyCompleted) {
                nextEv = event;
                break;
              }
            }

            if (!nextEv) {
              // if we don't have anywhere to go, reset the recent playback queue so the user
              // can start a new chain of playbacks.
              this.recentFullPlays = new Set();
              this.playbackIdOrder = [];
            } else {
              this.playbackIdOrder = orderClone;
              const instance = this.playbacks.get(nextEv.getId());

              _PlaybackManager.PlaybackManager.instance.pauseAllExcept(instance); // This should cause a Play event, which will re-populate our playback order
              // and update our current playback ID.
              // noinspection JSIgnoredPromiseFromCall


              instance.play();
            }
          }
        } else {
          _logger.logger.warn("Voice message queue desync: Expected playback stop to be last in order. " + `Current=${this.currentPlaybackId} Last=${last} EventID=${mxEvent.getId()}`);
        }
      }
    }

    if (newState === _Playback.PlaybackState.Playing) {
      const order = this.playbackIdOrder;

      if (this.currentPlaybackId !== mxEvent.getId() && !!this.currentPlaybackId) {
        if (order.length === 0 || order[order.length - 1] !== this.currentPlaybackId) {
          const lastInstance = this.playbacks.get(this.currentPlaybackId);

          if (lastInstance.currentState === _Playback.PlaybackState.Playing || lastInstance.currentState === _Playback.PlaybackState.Paused) {
            order.push(this.currentPlaybackId);
          }
        }
      }

      this.currentPlaybackId = mxEvent.getId();

      if (order.length === 0 || order[order.length - 1] !== this.currentPlaybackId) {
        order.push(this.currentPlaybackId);
      }
    } // Only persist clock information on pause/stop (end) to avoid overwhelming the storage.
    // This should get triggered from normal voice message component unmount due to the playback
    // stopping itself for cleanup.


    if (newState === _Playback.PlaybackState.Paused || newState === _Playback.PlaybackState.Stopped) {
      this.persistClocks();
    }
  }

  onPlaybackClock(playback, mxEvent, clocks) {
    if (playback.currentState === _Playback.PlaybackState.Decoding) return; // ignore pre-ready values

    if (playback.currentState !== _Playback.PlaybackState.Stopped) {
      this.clockStates.set(mxEvent.getId(), clocks[0]); // [0] is the current seek position
    }
  }

}

exports.PlaybackQueue = PlaybackQueue;
(0, _defineProperty2.default)(PlaybackQueue, "queues", new Map());
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hdWRpby9QbGF5YmFja1F1ZXVlLnRzIl0sIm5hbWVzIjpbIlBsYXliYWNrUXVldWUiLCJjb25zdHJ1Y3RvciIsImNsaWVudCIsInJvb20iLCJNYXAiLCJTZXQiLCJsb2FkQ2xvY2tzIiwiUm9vbVZpZXdTdG9yZSIsImFkZExpc3RlbmVyIiwiZ2V0Um9vbUlkIiwicm9vbUlkIiwiY3VycmVudFBsYXliYWNrSWQiLCJyZWNlbnRGdWxsUGxheXMiLCJwbGF5YmFja0lkT3JkZXIiLCJmb3JSb29tIiwiY2xpIiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0IiwiZ2V0Um9vbSIsIkVycm9yIiwicXVldWVzIiwiaGFzIiwicXVldWUiLCJzZXQiLCJwZXJzaXN0Q2xvY2tzIiwibG9jYWxTdG9yYWdlIiwic2V0SXRlbSIsIkpTT04iLCJzdHJpbmdpZnkiLCJBcnJheSIsImZyb20iLCJjbG9ja1N0YXRlcyIsImVudHJpZXMiLCJ2YWwiLCJnZXRJdGVtIiwicGFyc2UiLCJ1bnNvcnRlZEVucXVldWUiLCJteEV2ZW50IiwicGxheWJhY2siLCJwbGF5YmFja3MiLCJnZXRJZCIsIm9uIiwiVVBEQVRFX0VWRU5UIiwic3RhdGUiLCJvblBsYXliYWNrU3RhdGVDaGFuZ2UiLCJjbG9ja0luZm8iLCJsaXZlRGF0YSIsIm9uVXBkYXRlIiwiY2xvY2siLCJvblBsYXliYWNrQ2xvY2siLCJuZXdTdGF0ZSIsIndhc0xhc3RQbGF5aW5nIiwiUGxheWJhY2tTdGF0ZSIsIlN0b3BwZWQiLCJza2lwVG8iLCJkZWxldGUiLCJhZGQiLCJvcmRlckNsb25lIiwibGFzdCIsInBvcCIsIm5leHQiLCJpbnN0YW5jZSIsImxvZ2dlciIsIndhcm4iLCJQbGF5YmFja01hbmFnZXIiLCJwYXVzZUFsbEV4Y2VwdCIsInBsYXkiLCJ0aW1lbGluZSIsImdldExpdmVUaW1lbGluZSIsImdldEV2ZW50cyIsInNjYW5Gb3JWb2ljZU1lc3NhZ2UiLCJuZXh0RXYiLCJldmVudCIsImV2VHlwZSIsImdldFR5cGUiLCJFdmVudFR5cGUiLCJSb29tTWVzc2FnZSIsIlN0aWNrZXIiLCJoYXZlUGxheWJhY2siLCJpc1JlY2VudGx5Q29tcGxldGVkIiwiUGxheWluZyIsIm9yZGVyIiwibGVuZ3RoIiwibGFzdEluc3RhbmNlIiwiY3VycmVudFN0YXRlIiwiUGF1c2VkIiwicHVzaCIsImNsb2NrcyIsIkRlY29kaW5nIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQW1CQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUE1QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQWdCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDTyxNQUFNQSxhQUFOLENBQW9CO0FBQ21DO0FBRVQ7QUFDQTtBQUNUO0FBQ0w7QUFDVTtBQUU3Q0MsRUFBQUEsV0FBVyxDQUFTQyxNQUFULEVBQXVDQyxJQUF2QyxFQUFtRDtBQUFBLFNBQTFDRCxNQUEwQyxHQUExQ0EsTUFBMEM7QUFBQSxTQUFaQyxJQUFZLEdBQVpBLElBQVk7QUFBQSxxREFOMUMsSUFBSUMsR0FBSixFQU0wQztBQUFBLHVEQUx4QyxJQUFJQSxHQUFKLEVBS3dDO0FBQUEsMkRBSjFCLEVBSTBCO0FBQUE7QUFBQSwyREFGcEMsSUFBSUMsR0FBSixFQUVvQztBQUMxRCxTQUFLQyxVQUFMOztBQUVBQywyQkFBY0MsV0FBZCxDQUEwQixNQUFNO0FBQzVCLFVBQUlELHVCQUFjRSxTQUFkLE9BQThCLEtBQUtOLElBQUwsQ0FBVU8sTUFBNUMsRUFBb0Q7QUFDaEQ7QUFDQTtBQUNBO0FBQ0EsYUFBS0MsaUJBQUwsR0FBeUIsSUFBekIsQ0FKZ0QsQ0FJakI7O0FBQy9CLGFBQUtDLGVBQUwsR0FBdUIsSUFBSVAsR0FBSixFQUF2QjtBQUNBLGFBQUtRLGVBQUwsR0FBdUIsRUFBdkI7QUFDSDtBQUNK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NkU7QUFDekUsV0FBSzdCLGFBQUw7QUFDSDtBQUNKOztBQUVPeUIsRUFBQUEsZUFBZSxDQUFDWCxRQUFELEVBQXFCRCxPQUFyQixFQUEyQ2tELE1BQTNDLEVBQTZEO0FBQ2hGLFFBQUlqRCxRQUFRLENBQUM4QyxZQUFULEtBQTBCaEMsd0JBQWNvQyxRQUE1QyxFQUFzRCxPQUQwQixDQUNsQjs7QUFFOUQsUUFBSWxELFFBQVEsQ0FBQzhDLFlBQVQsS0FBMEJoQyx3QkFBY0MsT0FBNUMsRUFBcUQ7QUFDakQsV0FBS3RCLFdBQUwsQ0FBaUJSLEdBQWpCLENBQXFCYyxPQUFPLENBQUNHLEtBQVIsRUFBckIsRUFBc0MrQyxNQUFNLENBQUMsQ0FBRCxDQUE1QyxFQURpRCxDQUNDO0FBQ3JEO0FBQ0o7O0FBakxzQjs7OzhCQUFkdkYsYSxZQUNlLElBQUlJLEdBQUosRSIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAyMSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCB7IE1hdHJpeENsaWVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9jbGllbnRcIjtcbmltcG9ydCB7IE1hdHJpeEV2ZW50IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9ldmVudFwiO1xuaW1wb3J0IHsgUm9vbSB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvcm9vbVwiO1xuaW1wb3J0IHsgUGxheWJhY2ssIFBsYXliYWNrU3RhdGUgfSBmcm9tIFwiLi9QbGF5YmFja1wiO1xuaW1wb3J0IHsgVVBEQVRFX0VWRU5UIH0gZnJvbSBcIi4uL3N0b3Jlcy9Bc3luY1N0b3JlXCI7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tIFwiLi4vTWF0cml4Q2xpZW50UGVnXCI7XG5pbXBvcnQgeyBhcnJheUZhc3RDbG9uZSB9IGZyb20gXCIuLi91dGlscy9hcnJheXNcIjtcbmltcG9ydCB7IFBsYXliYWNrTWFuYWdlciB9IGZyb20gXCIuL1BsYXliYWNrTWFuYWdlclwiO1xuaW1wb3J0IHsgaXNWb2ljZU1lc3NhZ2UgfSBmcm9tIFwiLi4vdXRpbHMvRXZlbnRVdGlsc1wiO1xuaW1wb3J0IFJvb21WaWV3U3RvcmUgZnJvbSBcIi4uL3N0b3Jlcy9Sb29tVmlld1N0b3JlXCI7XG5pbXBvcnQgeyBFdmVudFR5cGUgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvQHR5cGVzL2V2ZW50XCI7XG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcblxuLyoqXG4gKiBBdWRpbyBwbGF5YmFjayBxdWV1ZSBtYW5hZ2VtZW50IGZvciBhIGdpdmVuIHJvb20uIFRoaXMga2VlcHMgdHJhY2sgb2Ygd2hlcmUgdGhlIHVzZXJcbiAqIHdhcyBhdCBmb3IgZWFjaCBwbGF5YmFjaywgd2hhdCBvcmRlciB0aGUgcGxheWJhY2tzIHdlcmUgcGxheWVkIGluLCBhbmQgdHJpZ2dlcnMgc3Vic2VxdWVudFxuICogcGxheWJhY2tzLlxuICpcbiAqIEN1cnJlbnRseSB0aGlzIGlzIG9ubHkgaW50ZW5kZWQgdG8gYmUgdXNlZCBieSB2b2ljZSBtZXNzYWdlcy5cbiAqXG4gKiBUaGUgcHJpbWFyeSBtZWNoYW5pY3MgYXJlOlxuICogKiBQZXJzaXN0ZWQgY2xvY2sgc3RhdGUgZm9yIGVhY2ggcGxheWJhY2sgaW5zdGFuY2UgKHRpZWQgdG8gRXZlbnQgSUQpLlxuICogKiBMaW1pdGVkIG1lbW9yeSBvZiBwbGF5YmFjayBvcmRlciAoc2VlIGNvZGU7IG5vdCBwZXJzaXN0ZWQpLlxuICogKiBBdXRvcGxheSBvZiBuZXh0IGVsaWdpYmxlIHBsYXliYWNrIGluc3RhbmNlLlxuICovXG5leHBvcnQgY2xhc3MgUGxheWJhY2tRdWV1ZSB7XG4gICAgcHJpdmF0ZSBzdGF0aWMgcXVldWVzID0gbmV3IE1hcDxzdHJpbmcsIFBsYXliYWNrUXVldWU+KCk7IC8vIGtleWVkIGJ5IHJvb20gSURcblxuICAgIHByaXZhdGUgcGxheWJhY2tzID0gbmV3IE1hcDxzdHJpbmcsIFBsYXliYWNrPigpOyAvLyBrZXllZCBieSBldmVudCBJRFxuICAgIHByaXZhdGUgY2xvY2tTdGF0ZXMgPSBuZXcgTWFwPHN0cmluZywgbnVtYmVyPigpOyAvLyBrZXllZCBieSBldmVudCBJRFxuICAgIHByaXZhdGUgcGxheWJhY2tJZE9yZGVyOiBzdHJpbmdbXSA9IFtdOyAvLyBldmVudCBJRHMsIGxhc3QgPT0gY3VycmVudFxuICAgIHByaXZhdGUgY3VycmVudFBsYXliYWNrSWQ6IHN0cmluZzsgLy8gZXZlbnQgSUQsIGJyb2tlbiBvdXQgZnJvbSBhYm92ZSBmb3IgZWFzZSBvZiB1c2VcbiAgICBwcml2YXRlIHJlY2VudEZ1bGxQbGF5cyA9IG5ldyBTZXQ8c3RyaW5nPigpOyAvLyBldmVudCBJRHNcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgY2xpZW50OiBNYXRyaXhDbGllbnQsIHByaXZhdGUgcm9vbTogUm9vbSkge1xuICAgICAgICB0aGlzLmxvYWRDbG9ja3MoKTtcblxuICAgICAgICBSb29tVmlld1N0b3JlLmFkZExpc3RlbmVyKCgpID0+IHtcbiAgICAgICAgICAgIGlmIChSb29tVmlld1N0b3JlLmdldFJvb21JZCgpID09PSB0aGlzLnJvb20ucm9vbUlkKSB7XG4gICAgICAgICAgICAgICAgLy8gUmVzZXQgdGhlIHN0YXRlIG9mIHRoZSBwbGF5YmFja3MgYmVmb3JlIHRoZXkgc3RhcnQgbW91bnRpbmcgYW5kIGVucXVldWluZyB1cGRhdGVzLlxuICAgICAgICAgICAgICAgIC8vIFdlIHJlc2V0IHRoZSBlbnRpcmV0eSBvZiB0aGUgcXVldWUsIGluY2x1ZGluZyBvcmRlciwgdG8gZW5zdXJlIHRoZSB1c2VyIGlzbid0IGxlZnRcbiAgICAgICAgICAgICAgICAvLyBjb25mdXNlZCB3aXRoIHdoYXQgb3JkZXIgdGhlIG1lc3NhZ2VzIGFyZSBwbGF5aW5nIGluLlxuICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFBsYXliYWNrSWQgPSBudWxsOyAvLyB0aGlzIGluIHBhcnRpY3VsYXIgc3RvcHMgYXV0b3BsYXkgd2hlbiB0aGUgcm9vbSBpcyBzd2l0Y2hlZCB0b1xuICAgICAgICAgICAgICAgIHRoaXMucmVjZW50RnVsbFBsYXlzID0gbmV3IFNldDxzdHJpbmc+KCk7XG4gICAgICAgICAgICAgICAgdGhpcy5wbGF5YmFja0lkT3JkZXIgPSBbXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBmb3JSb29tKHJvb21JZDogc3RyaW5nKTogUGxheWJhY2tRdWV1ZSB7XG4gICAgICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICAgICAgY29uc3Qgcm9vbSA9IGNsaS5nZXRSb29tKHJvb21JZCk7XG4gICAgICAgIGlmICghcm9vbSkgdGhyb3cgbmV3IEVycm9yKFwiVW5rbm93biByb29tXCIpO1xuICAgICAgICBpZiAoUGxheWJhY2tRdWV1ZS5xdWV1ZXMuaGFzKHJvb20ucm9vbUlkKSkge1xuICAgICAgICAgICAgcmV0dXJuIFBsYXliYWNrUXVldWUucXVldWVzLmdldChyb29tLnJvb21JZCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcXVldWUgPSBuZXcgUGxheWJhY2tRdWV1ZShjbGksIHJvb20pO1xuICAgICAgICBQbGF5YmFja1F1ZXVlLnF1ZXVlcy5zZXQocm9vbS5yb29tSWQsIHF1ZXVlKTtcbiAgICAgICAgcmV0dXJuIHF1ZXVlO1xuICAgIH1cblxuICAgIHByaXZhdGUgcGVyc2lzdENsb2NrcygpIHtcbiAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oXG4gICAgICAgICAgICBgbXhfdm9pY2VfbWVzc2FnZV9jbG9ja3NfJHt0aGlzLnJvb20ucm9vbUlkfWAsXG4gICAgICAgICAgICBKU09OLnN0cmluZ2lmeShBcnJheS5mcm9tKHRoaXMuY2xvY2tTdGF0ZXMuZW50cmllcygpKSksXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBsb2FkQ2xvY2tzKCkge1xuICAgICAgICBjb25zdCB2YWwgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShgbXhfdm9pY2VfbWVzc2FnZV9jbG9ja3NfJHt0aGlzLnJvb20ucm9vbUlkfWApO1xuICAgICAgICBpZiAoISF2YWwpIHtcbiAgICAgICAgICAgIHRoaXMuY2xvY2tTdGF0ZXMgPSBuZXcgTWFwPHN0cmluZywgbnVtYmVyPihKU09OLnBhcnNlKHZhbCkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHVuc29ydGVkRW5xdWV1ZShteEV2ZW50OiBNYXRyaXhFdmVudCwgcGxheWJhY2s6IFBsYXliYWNrKSB7XG4gICAgICAgIC8vIFdlIGRvbid0IGV2ZXIgZGV0YWNoIG91ciBsaXN0ZW5lcnM6IHdlIGV4cGVjdCB0aGUgUGxheWJhY2sgdG8gY2xlYW4gdXAgZm9yIHVzXG4gICAgICAgIHRoaXMucGxheWJhY2tzLnNldChteEV2ZW50LmdldElkKCksIHBsYXliYWNrKTtcbiAgICAgICAgcGxheWJhY2sub24oVVBEQVRFX0VWRU5ULCAoc3RhdGUpID0+IHRoaXMub25QbGF5YmFja1N0YXRlQ2hhbmdlKHBsYXliYWNrLCBteEV2ZW50LCBzdGF0ZSkpO1xuICAgICAgICBwbGF5YmFjay5jbG9ja0luZm8ubGl2ZURhdGEub25VcGRhdGUoKGNsb2NrKSA9PiB0aGlzLm9uUGxheWJhY2tDbG9jayhwbGF5YmFjaywgbXhFdmVudCwgY2xvY2spKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uUGxheWJhY2tTdGF0ZUNoYW5nZShwbGF5YmFjazogUGxheWJhY2ssIG14RXZlbnQ6IE1hdHJpeEV2ZW50LCBuZXdTdGF0ZTogUGxheWJhY2tTdGF0ZSkge1xuICAgICAgICAvLyBSZW1lbWJlciB3aGVyZSB0aGUgdXNlciBnb3QgdG8gaW4gcGxheWJhY2tcbiAgICAgICAgY29uc3Qgd2FzTGFzdFBsYXlpbmcgPSB0aGlzLmN1cnJlbnRQbGF5YmFja0lkID09PSBteEV2ZW50LmdldElkKCk7XG4gICAgICAgIGlmIChuZXdTdGF0ZSA9PT0gUGxheWJhY2tTdGF0ZS5TdG9wcGVkICYmIHRoaXMuY2xvY2tTdGF0ZXMuaGFzKG14RXZlbnQuZ2V0SWQoKSkgJiYgIXdhc0xhc3RQbGF5aW5nKSB7XG4gICAgICAgICAgICAvLyBub2luc3BlY3Rpb24gSlNJZ25vcmVkUHJvbWlzZUZyb21DYWxsXG4gICAgICAgICAgICBwbGF5YmFjay5za2lwVG8odGhpcy5jbG9ja1N0YXRlcy5nZXQobXhFdmVudC5nZXRJZCgpKSk7XG4gICAgICAgIH0gZWxzZSBpZiAobmV3U3RhdGUgPT09IFBsYXliYWNrU3RhdGUuU3RvcHBlZCkge1xuICAgICAgICAgICAgLy8gUmVtb3ZlIHRoZSBub3ctdXNlbGVzcyBjbG9jayBmb3Igc29tZSBzcGFjZSBzYXZpbmdzXG4gICAgICAgICAgICB0aGlzLmNsb2NrU3RhdGVzLmRlbGV0ZShteEV2ZW50LmdldElkKCkpO1xuXG4gICAgICAgICAgICBpZiAod2FzTGFzdFBsYXlpbmcpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlY2VudEZ1bGxQbGF5cy5hZGQodGhpcy5jdXJyZW50UGxheWJhY2tJZCk7XG4gICAgICAgICAgICAgICAgY29uc3Qgb3JkZXJDbG9uZSA9IGFycmF5RmFzdENsb25lKHRoaXMucGxheWJhY2tJZE9yZGVyKTtcbiAgICAgICAgICAgICAgICBjb25zdCBsYXN0ID0gb3JkZXJDbG9uZS5wb3AoKTtcbiAgICAgICAgICAgICAgICBpZiAobGFzdCA9PT0gdGhpcy5jdXJyZW50UGxheWJhY2tJZCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXh0ID0gb3JkZXJDbG9uZS5wb3AoKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5leHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluc3RhbmNlID0gdGhpcy5wbGF5YmFja3MuZ2V0KG5leHQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpbnN0YW5jZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIlZvaWNlIG1lc3NhZ2UgcXVldWUgZGVzeW5jOiBNaXNzaW5nIHBsYXliYWNrIGZvciBuZXh0IG1lc3NhZ2U6IFwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgYEN1cnJlbnQ9JHt0aGlzLmN1cnJlbnRQbGF5YmFja0lkfSBMYXN0PSR7bGFzdH0gTmV4dD0ke25leHR9YCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYXliYWNrSWRPcmRlciA9IG9yZGVyQ2xvbmU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgUGxheWJhY2tNYW5hZ2VyLmluc3RhbmNlLnBhdXNlQWxsRXhjZXB0KGluc3RhbmNlKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgc2hvdWxkIGNhdXNlIGEgUGxheSBldmVudCwgd2hpY2ggd2lsbCByZS1wb3B1bGF0ZSBvdXIgcGxheWJhY2sgb3JkZXJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhbmQgdXBkYXRlIG91ciBjdXJyZW50IHBsYXliYWNrIElELlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5vaW5zcGVjdGlvbiBKU0lnbm9yZWRQcm9taXNlRnJvbUNhbGxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZS5wbGF5KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBlbHNlIG5vIGV4cGxpY2l0IG5leHQgZXZlbnQsIHNvIGZpbmQgYW4gZXZlbnQgd2UgaGF2ZW4ndCBwbGF5ZWQgdGhhdCBjb21lcyBuZXh0LiBUaGUgbGl2ZVxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGltZWxpbmUgaXMgYWxyZWFkeSBtb3N0IHJlY2VudCBsYXN0LCBzbyB3ZSBjYW4gaXRlcmF0ZSBkb3duIHRoYXQuXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0aW1lbGluZSA9IGFycmF5RmFzdENsb25lKHRoaXMucm9vbS5nZXRMaXZlVGltZWxpbmUoKS5nZXRFdmVudHMoKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgc2NhbkZvclZvaWNlTWVzc2FnZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG5leHRFdjogTWF0cml4RXZlbnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGV2ZW50IG9mIHRpbWVsaW5lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50LmdldElkKCkgPT09IG14RXZlbnQuZ2V0SWQoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FuRm9yVm9pY2VNZXNzYWdlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc2NhbkZvclZvaWNlTWVzc2FnZSkgY29udGludWU7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzVm9pY2VNZXNzYWdlKGV2ZW50KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBldlR5cGUgPSBldmVudC5nZXRUeXBlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldlR5cGUgIT09IEV2ZW50VHlwZS5Sb29tTWVzc2FnZSAmJiBldlR5cGUgIT09IEV2ZW50VHlwZS5TdGlja2VyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsgLy8gRXZlbnQgY2FuIGJlIHNraXBwZWQgZm9yIGF1dG9tYXRpYyBwbGF5YmFjayBjb25zaWRlcmF0aW9uXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7IC8vIFN0b3AgYXV0b21hdGljIHBsYXliYWNrOiBuZXh0IHVzZWZ1bCBldmVudCBpcyBub3QgYSB2b2ljZSBtZXNzYWdlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaGF2ZVBsYXliYWNrID0gdGhpcy5wbGF5YmFja3MuaGFzKGV2ZW50LmdldElkKCkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzUmVjZW50bHlDb21wbGV0ZWQgPSB0aGlzLnJlY2VudEZ1bGxQbGF5cy5oYXMoZXZlbnQuZ2V0SWQoKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhdmVQbGF5YmFjayAmJiAhaXNSZWNlbnRseUNvbXBsZXRlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0RXYgPSBldmVudDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFuZXh0RXYpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiB3ZSBkb24ndCBoYXZlIGFueXdoZXJlIHRvIGdvLCByZXNldCB0aGUgcmVjZW50IHBsYXliYWNrIHF1ZXVlIHNvIHRoZSB1c2VyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2FuIHN0YXJ0IGEgbmV3IGNoYWluIG9mIHBsYXliYWNrcy5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlY2VudEZ1bGxQbGF5cyA9IG5ldyBTZXQ8c3RyaW5nPigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGxheWJhY2tJZE9yZGVyID0gW107XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGxheWJhY2tJZE9yZGVyID0gb3JkZXJDbG9uZTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluc3RhbmNlID0gdGhpcy5wbGF5YmFja3MuZ2V0KG5leHRFdi5nZXRJZCgpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBQbGF5YmFja01hbmFnZXIuaW5zdGFuY2UucGF1c2VBbGxFeGNlcHQoaW5zdGFuY2UpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBzaG91bGQgY2F1c2UgYSBQbGF5IGV2ZW50LCB3aGljaCB3aWxsIHJlLXBvcHVsYXRlIG91ciBwbGF5YmFjayBvcmRlclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFuZCB1cGRhdGUgb3VyIGN1cnJlbnQgcGxheWJhY2sgSUQuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbm9pbnNwZWN0aW9uIEpTSWdub3JlZFByb21pc2VGcm9tQ2FsbFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLnBsYXkoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuKFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJWb2ljZSBtZXNzYWdlIHF1ZXVlIGRlc3luYzogRXhwZWN0ZWQgcGxheWJhY2sgc3RvcCB0byBiZSBsYXN0IGluIG9yZGVyLiBcIlxuICAgICAgICAgICAgICAgICAgICAgICAgKyBgQ3VycmVudD0ke3RoaXMuY3VycmVudFBsYXliYWNrSWR9IExhc3Q9JHtsYXN0fSBFdmVudElEPSR7bXhFdmVudC5nZXRJZCgpfWAsXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG5ld1N0YXRlID09PSBQbGF5YmFja1N0YXRlLlBsYXlpbmcpIHtcbiAgICAgICAgICAgIGNvbnN0IG9yZGVyID0gdGhpcy5wbGF5YmFja0lkT3JkZXI7XG4gICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50UGxheWJhY2tJZCAhPT0gbXhFdmVudC5nZXRJZCgpICYmICEhdGhpcy5jdXJyZW50UGxheWJhY2tJZCkge1xuICAgICAgICAgICAgICAgIGlmIChvcmRlci5sZW5ndGggPT09IDAgfHwgb3JkZXJbb3JkZXIubGVuZ3RoIC0gMV0gIT09IHRoaXMuY3VycmVudFBsYXliYWNrSWQpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGFzdEluc3RhbmNlID0gdGhpcy5wbGF5YmFja3MuZ2V0KHRoaXMuY3VycmVudFBsYXliYWNrSWQpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgICAgICAgICBsYXN0SW5zdGFuY2UuY3VycmVudFN0YXRlID09PSBQbGF5YmFja1N0YXRlLlBsYXlpbmdcbiAgICAgICAgICAgICAgICAgICAgICAgIHx8IGxhc3RJbnN0YW5jZS5jdXJyZW50U3RhdGUgPT09IFBsYXliYWNrU3RhdGUuUGF1c2VkXG4gICAgICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3JkZXIucHVzaCh0aGlzLmN1cnJlbnRQbGF5YmFja0lkKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5jdXJyZW50UGxheWJhY2tJZCA9IG14RXZlbnQuZ2V0SWQoKTtcbiAgICAgICAgICAgIGlmIChvcmRlci5sZW5ndGggPT09IDAgfHwgb3JkZXJbb3JkZXIubGVuZ3RoIC0gMV0gIT09IHRoaXMuY3VycmVudFBsYXliYWNrSWQpIHtcbiAgICAgICAgICAgICAgICBvcmRlci5wdXNoKHRoaXMuY3VycmVudFBsYXliYWNrSWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gT25seSBwZXJzaXN0IGNsb2NrIGluZm9ybWF0aW9uIG9uIHBhdXNlL3N0b3AgKGVuZCkgdG8gYXZvaWQgb3ZlcndoZWxtaW5nIHRoZSBzdG9yYWdlLlxuICAgICAgICAvLyBUaGlzIHNob3VsZCBnZXQgdHJpZ2dlcmVkIGZyb20gbm9ybWFsIHZvaWNlIG1lc3NhZ2UgY29tcG9uZW50IHVubW91bnQgZHVlIHRvIHRoZSBwbGF5YmFja1xuICAgICAgICAvLyBzdG9wcGluZyBpdHNlbGYgZm9yIGNsZWFudXAuXG4gICAgICAgIGlmIChuZXdTdGF0ZSA9PT0gUGxheWJhY2tTdGF0ZS5QYXVzZWQgfHwgbmV3U3RhdGUgPT09IFBsYXliYWNrU3RhdGUuU3RvcHBlZCkge1xuICAgICAgICAgICAgdGhpcy5wZXJzaXN0Q2xvY2tzKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIG9uUGxheWJhY2tDbG9jayhwbGF5YmFjazogUGxheWJhY2ssIG14RXZlbnQ6IE1hdHJpeEV2ZW50LCBjbG9ja3M6IG51bWJlcltdKSB7XG4gICAgICAgIGlmIChwbGF5YmFjay5jdXJyZW50U3RhdGUgPT09IFBsYXliYWNrU3RhdGUuRGVjb2RpbmcpIHJldHVybjsgLy8gaWdub3JlIHByZS1yZWFkeSB2YWx1ZXNcblxuICAgICAgICBpZiAocGxheWJhY2suY3VycmVudFN0YXRlICE9PSBQbGF5YmFja1N0YXRlLlN0b3BwZWQpIHtcbiAgICAgICAgICAgIHRoaXMuY2xvY2tTdGF0ZXMuc2V0KG14RXZlbnQuZ2V0SWQoKSwgY2xvY2tzWzBdKTsgLy8gWzBdIGlzIHRoZSBjdXJyZW50IHNlZWsgcG9zaXRpb25cbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==